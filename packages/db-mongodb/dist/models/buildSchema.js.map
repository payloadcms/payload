{"version":3,"sources":["../../src/models/buildSchema.ts"],"sourcesContent":["import type { IndexOptions, Schema, SchemaOptions, SchemaTypeOptions } from 'mongoose'\n\nimport mongoose from 'mongoose'\nimport {\n  type ArrayField,\n  type BlocksField,\n  type CheckboxField,\n  type CodeField,\n  type CollapsibleField,\n  type DateField,\n  type EmailField,\n  type Field,\n  type FieldAffectingData,\n  type FlattenedField,\n  type GroupField,\n  type JSONField,\n  type NonPresentationalField,\n  type NumberField,\n  type Payload,\n  type PointField,\n  type RadioField,\n  type RelationshipField,\n  type RichTextField,\n  type RowField,\n  type SanitizedCompoundIndex,\n  type SanitizedLocalizationConfig,\n  type SelectField,\n  type Tab,\n  type TabsField,\n  type TextareaField,\n  type TextField,\n  type UploadField,\n} from 'payload'\nimport {\n  fieldAffectsData,\n  fieldIsPresentationalOnly,\n  fieldIsVirtual,\n  fieldShouldBeLocalized,\n  tabHasName,\n} from 'payload/shared'\n\nexport type BuildSchemaOptions = {\n  allowIDField?: boolean\n  disableUnique?: boolean\n  draftsEnabled?: boolean\n  indexSortableFields?: boolean\n  options?: SchemaOptions\n}\n\ntype FieldSchemaGenerator<T extends Field = Field> = (\n  field: T,\n  schema: Schema,\n  config: Payload,\n  buildSchemaOptions: BuildSchemaOptions,\n  parentIsLocalized: boolean,\n) => void\n\n/**\n * get a field's defaultValue only if defined and not dynamic so that it can be set on the field schema\n * @param field\n */\nconst formatDefaultValue = (field: FieldAffectingData) =>\n  typeof field.defaultValue !== 'undefined' && typeof field.defaultValue !== 'function'\n    ? field.defaultValue\n    : undefined\n\nconst formatBaseSchema = ({\n  buildSchemaOptions,\n  field,\n  parentIsLocalized,\n}: {\n  buildSchemaOptions: BuildSchemaOptions\n  field: FieldAffectingData\n  parentIsLocalized: boolean\n}) => {\n  const { disableUnique, draftsEnabled, indexSortableFields } = buildSchemaOptions\n  const schema: SchemaTypeOptions<unknown> = {\n    default: formatDefaultValue(field),\n    index: field.index || (!disableUnique && field.unique) || indexSortableFields || false,\n    required: false,\n    unique: (!disableUnique && field.unique) || false,\n  }\n\n  if (\n    schema.unique &&\n    (fieldShouldBeLocalized({ field, parentIsLocalized }) ||\n      draftsEnabled ||\n      (fieldAffectsData(field) &&\n        field.type !== 'group' &&\n        field.type !== 'tab' &&\n        field.required !== true))\n  ) {\n    schema.sparse = true\n  }\n\n  if (field.hidden) {\n    schema.hidden = true\n  }\n\n  return schema\n}\n\nconst localizeSchema = (\n  entity: NonPresentationalField | Tab,\n  schema: SchemaTypeOptions<any>,\n  localization: false | SanitizedLocalizationConfig,\n  parentIsLocalized: boolean,\n) => {\n  if (\n    fieldShouldBeLocalized({ field: entity, parentIsLocalized }) &&\n    localization &&\n    Array.isArray(localization.locales)\n  ) {\n    return {\n      type: localization.localeCodes.reduce(\n        (localeSchema, locale) => ({\n          ...localeSchema,\n          [locale]: schema,\n        }),\n        {\n          _id: false,\n        },\n      ),\n      localized: true,\n    }\n  }\n  return schema\n}\n\nexport const buildSchema = (args: {\n  buildSchemaOptions: BuildSchemaOptions\n  compoundIndexes?: SanitizedCompoundIndex[]\n  configFields: Field[]\n  flattenedFields?: FlattenedField[]\n  parentIsLocalized?: boolean\n  payload: Payload\n}): Schema => {\n  const {\n    buildSchemaOptions = {},\n    configFields,\n    flattenedFields,\n    parentIsLocalized,\n    payload,\n  } = args\n  const { allowIDField, options } = buildSchemaOptions\n  let fields = {}\n\n  let schemaFields = configFields\n\n  if (!allowIDField) {\n    // Use flattenedFields if available to find custom id field regardless of nesting\n    const fieldsToSearch = flattenedFields || schemaFields\n    const idField = fieldsToSearch.find((field) => fieldAffectsData(field) && field.name === 'id')\n    if (idField) {\n      fields = {\n        _id:\n          idField.type === 'number'\n            ? payload.db.useBigIntForNumberIDs\n              ? mongoose.Schema.Types.BigInt\n              : Number\n            : String,\n      }\n      schemaFields = schemaFields.filter(\n        (field) => !(fieldAffectsData(field) && field.name === 'id'),\n      )\n    }\n  }\n\n  const schema = new mongoose.Schema(fields, options as any)\n\n  schemaFields.forEach((field) => {\n    if (fieldIsVirtual(field)) {\n      return\n    }\n\n    if (!fieldIsPresentationalOnly(field)) {\n      const addFieldSchema = getSchemaGenerator(field.type)\n\n      if (addFieldSchema) {\n        addFieldSchema(field, schema, payload, buildSchemaOptions, parentIsLocalized ?? false)\n      }\n    }\n  })\n\n  if (args.compoundIndexes) {\n    for (const index of args.compoundIndexes) {\n      const indexDefinition: Record<string, 1> = {}\n\n      for (const field of index.fields) {\n        if (field.pathHasLocalized && payload.config.localization) {\n          for (const locale of payload.config.localization.locales) {\n            indexDefinition[field.localizedPath.replace('<locale>', locale.code)] = 1\n          }\n        } else {\n          indexDefinition[field.path] = 1\n        }\n      }\n\n      schema.index(indexDefinition, {\n        unique: args.buildSchemaOptions.disableUnique ? false : index.unique,\n      })\n    }\n  }\n\n  return schema\n}\n\nconst array: FieldSchemaGenerator<ArrayField> = (\n  field: ArrayField,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n) => {\n  const baseSchema: SchemaTypeOptions<any> = {\n    ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n    type: [\n      buildSchema({\n        buildSchemaOptions: {\n          allowIDField: true,\n          disableUnique: buildSchemaOptions.disableUnique,\n          draftsEnabled: buildSchemaOptions.draftsEnabled,\n          options: {\n            _id: false,\n            id: false,\n            minimize: false,\n          },\n        },\n        configFields: field.fields,\n        parentIsLocalized: parentIsLocalized || field.localized,\n        payload,\n      }),\n    ],\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(field, baseSchema, payload.config.localization, parentIsLocalized),\n  })\n}\n\nconst blocks: FieldSchemaGenerator<BlocksField> = (\n  field: BlocksField,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const fieldSchema: SchemaTypeOptions<any> = {\n    ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n    type: [new mongoose.Schema({}, { _id: false, discriminatorKey: 'blockType' })],\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(\n      field,\n      fieldSchema,\n      payload.config.localization,\n      parentIsLocalized,\n    ),\n  })\n  ;(field.blockReferences ?? field.blocks).forEach((blockItem) => {\n    const blockSchema = new mongoose.Schema({}, { _id: false, id: false })\n\n    const block = typeof blockItem === 'string' ? payload.blocks[blockItem] : blockItem\n\n    if (!block) {\n      return\n    }\n\n    block.fields.forEach((blockField) => {\n      const addFieldSchema = getSchemaGenerator(blockField.type)\n\n      if (addFieldSchema) {\n        addFieldSchema(\n          blockField,\n          blockSchema,\n          payload,\n          buildSchemaOptions,\n          (parentIsLocalized || field.localized) ?? false,\n        )\n      }\n    })\n\n    if (fieldShouldBeLocalized({ field, parentIsLocalized }) && payload.config.localization) {\n      payload.config.localization.localeCodes.forEach((localeCode) => {\n        // @ts-expect-error Possible incorrect typing in mongoose types, this works\n        schema.path(`${field.name}.${localeCode}`).discriminator(block.slug, blockSchema)\n      })\n    } else {\n      // @ts-expect-error Possible incorrect typing in mongoose types, this works\n      schema.path(field.name).discriminator(block.slug, blockSchema)\n    }\n  })\n}\n\nconst checkbox: FieldSchemaGenerator<CheckboxField> = (\n  field: CheckboxField,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const baseSchema: SchemaTypeOptions<any> = {\n    ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n    type: Boolean,\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(field, baseSchema, payload.config.localization, parentIsLocalized),\n  })\n}\n\nconst code: FieldSchemaGenerator<CodeField> = (\n  field: CodeField,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const baseSchema: SchemaTypeOptions<any> = {\n    ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n    type: String,\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(field, baseSchema, payload.config.localization, parentIsLocalized),\n  })\n}\n\nconst collapsible: FieldSchemaGenerator<CollapsibleField> = (\n  field: CollapsibleField,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  field.fields.forEach((subField: Field) => {\n    if (fieldIsVirtual(subField)) {\n      return\n    }\n\n    const addFieldSchema = getSchemaGenerator(subField.type)\n\n    if (addFieldSchema) {\n      addFieldSchema(subField, schema, payload, buildSchemaOptions, parentIsLocalized)\n    }\n  })\n}\n\nconst date: FieldSchemaGenerator<DateField> = (\n  field: DateField,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const baseSchema: SchemaTypeOptions<any> = {\n    ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n    type: Date,\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(field, baseSchema, payload.config.localization, parentIsLocalized),\n  })\n}\n\nconst email: FieldSchemaGenerator<EmailField> = (\n  field,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const baseSchema: SchemaTypeOptions<any> = {\n    ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n    type: String,\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(field, baseSchema, payload.config.localization, parentIsLocalized),\n  })\n}\n\nconst group: FieldSchemaGenerator<GroupField> = (\n  field: GroupField,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  if (fieldAffectsData(field)) {\n    const formattedBaseSchema = formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized })\n\n    // carry indexSortableFields through to versions if drafts enabled\n    const indexSortableFields =\n      buildSchemaOptions.indexSortableFields &&\n      field.name === 'version' &&\n      buildSchemaOptions.draftsEnabled\n\n    const baseSchema: SchemaTypeOptions<any> = {\n      ...formattedBaseSchema,\n      type: buildSchema({\n        buildSchemaOptions: {\n          disableUnique: buildSchemaOptions.disableUnique,\n          draftsEnabled: buildSchemaOptions.draftsEnabled,\n          indexSortableFields,\n          options: {\n            _id: false,\n            id: false,\n            minimize: false,\n          },\n        },\n        configFields: field.fields,\n        parentIsLocalized: parentIsLocalized || field.localized,\n        payload,\n      }),\n    }\n\n    schema.add({\n      [field.name]: localizeSchema(\n        field,\n        baseSchema,\n        payload.config.localization,\n        parentIsLocalized,\n      ),\n    })\n  } else {\n    field.fields.forEach((subField) => {\n      if (fieldIsVirtual(subField)) {\n        return\n      }\n\n      const addFieldSchema = getSchemaGenerator(subField.type)\n\n      if (addFieldSchema) {\n        addFieldSchema(\n          subField,\n          schema,\n          payload,\n          buildSchemaOptions,\n          (parentIsLocalized || field.localized) ?? false,\n        )\n      }\n    })\n  }\n}\n\nconst json: FieldSchemaGenerator<JSONField> = (\n  field,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const baseSchema: SchemaTypeOptions<any> = {\n    ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n    type: mongoose.Schema.Types.Mixed,\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(field, baseSchema, payload.config.localization, parentIsLocalized),\n  })\n}\n\nconst number: FieldSchemaGenerator<NumberField> = (\n  field,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const baseSchema: SchemaTypeOptions<any> = {\n    ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n    type: field.hasMany ? [Number] : Number,\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(field, baseSchema, payload.config.localization, parentIsLocalized),\n  })\n}\n\nconst point: FieldSchemaGenerator<PointField> = (\n  field,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const baseSchema: SchemaTypeOptions<unknown> = {\n    type: {\n      type: String,\n      enum: ['Point'],\n      ...(typeof field.defaultValue !== 'undefined' && {\n        default: 'Point',\n      }),\n    },\n    coordinates: {\n      type: [Number],\n      default: formatDefaultValue(field),\n      required: false,\n    },\n  }\n\n  if (\n    buildSchemaOptions.disableUnique &&\n    field.unique &&\n    fieldShouldBeLocalized({ field, parentIsLocalized })\n  ) {\n    baseSchema.coordinates.sparse = true\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(field, baseSchema, payload.config.localization, parentIsLocalized),\n  })\n\n  if (field.index === true || field.index === undefined) {\n    const indexOptions: IndexOptions = {}\n    if (!buildSchemaOptions.disableUnique && field.unique) {\n      indexOptions.sparse = true\n      indexOptions.unique = true\n    }\n    if (fieldShouldBeLocalized({ field, parentIsLocalized }) && payload.config.localization) {\n      payload.config.localization.locales.forEach((locale) => {\n        schema.index({ [`${field.name}.${locale.code}`]: '2dsphere' }, indexOptions)\n      })\n    } else {\n      schema.index({ [field.name]: '2dsphere' }, indexOptions)\n    }\n  }\n}\n\nconst radio: FieldSchemaGenerator<RadioField> = (\n  field,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const baseSchema = {\n    ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n    type: String,\n    enum: field.options.map((option) => {\n      if (typeof option === 'object') {\n        return option.value\n      }\n      return option\n    }),\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(field, baseSchema, payload.config.localization, parentIsLocalized),\n  })\n}\n\nconst relationship: FieldSchemaGenerator<RelationshipField> = (\n  field,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n) => {\n  const hasManyRelations = Array.isArray(field.relationTo)\n  let schemaToReturn: { [key: string]: any } = {}\n\n  const valueType = getRelationshipValueType(field, payload)\n\n  if (fieldShouldBeLocalized({ field, parentIsLocalized }) && payload.config.localization) {\n    schemaToReturn = {\n      _id: false,\n      type: payload.config.localization.localeCodes.reduce((locales, locale) => {\n        let localeSchema: { [key: string]: any } = {}\n\n        if (hasManyRelations) {\n          localeSchema = {\n            ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n            _id: false,\n            type: mongoose.Schema.Types.Mixed,\n            relationTo: { type: String, enum: field.relationTo },\n            value: {\n              type: valueType,\n              refPath: `${field.name}.${locale}.relationTo`,\n            },\n          }\n        } else {\n          localeSchema = {\n            ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n            type: valueType,\n            ref: field.relationTo,\n          }\n        }\n\n        return {\n          ...locales,\n          [locale]: field.hasMany\n            ? { type: [localeSchema], default: formatDefaultValue(field) }\n            : localeSchema,\n        }\n      }, {}),\n      localized: true,\n    }\n  } else if (hasManyRelations) {\n    schemaToReturn = {\n      ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n      _id: false,\n      type: mongoose.Schema.Types.Mixed,\n      relationTo: { type: String, enum: field.relationTo },\n      value: {\n        type: valueType,\n        refPath: `${field.name}.relationTo`,\n      },\n    }\n\n    if (field.hasMany) {\n      schemaToReturn = {\n        type: [schemaToReturn],\n        default: formatDefaultValue(field),\n      }\n    }\n  } else {\n    schemaToReturn = {\n      ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n      type: valueType,\n      ref: field.relationTo,\n    }\n\n    if (field.hasMany) {\n      schemaToReturn = {\n        type: [schemaToReturn],\n        default: formatDefaultValue(field),\n      }\n    }\n  }\n\n  schema.add({\n    [field.name]: schemaToReturn,\n  })\n}\n\nconst richText: FieldSchemaGenerator<RichTextField> = (\n  field,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const baseSchema = {\n    ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n    type: mongoose.Schema.Types.Mixed,\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(field, baseSchema, payload.config.localization, parentIsLocalized),\n  })\n}\n\nconst row: FieldSchemaGenerator<RowField> = (\n  field,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  field.fields.forEach((subField: Field) => {\n    if (fieldIsVirtual(subField)) {\n      return\n    }\n\n    const addFieldSchema = getSchemaGenerator(subField.type)\n\n    if (addFieldSchema) {\n      addFieldSchema(subField, schema, payload, buildSchemaOptions, parentIsLocalized)\n    }\n  })\n}\n\nconst select: FieldSchemaGenerator<SelectField> = (\n  field,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const baseSchema: SchemaTypeOptions<any> = {\n    ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n    type: String,\n    enum: field.options.map((option) => {\n      if (typeof option === 'object') {\n        return option.value\n      }\n      return option\n    }),\n  }\n\n  if (buildSchemaOptions.draftsEnabled || !field.required) {\n    ;(baseSchema.enum as unknown[]).push(null)\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(\n      field,\n      field.hasMany ? [baseSchema] : baseSchema,\n      payload.config.localization,\n      parentIsLocalized,\n    ),\n  })\n}\n\nconst tabs: FieldSchemaGenerator<TabsField> = (\n  field,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  field.tabs.forEach((tab) => {\n    if (tabHasName(tab)) {\n      if (fieldIsVirtual(tab)) {\n        return\n      }\n      const baseSchema = {\n        type: buildSchema({\n          buildSchemaOptions: {\n            disableUnique: buildSchemaOptions.disableUnique,\n            draftsEnabled: buildSchemaOptions.draftsEnabled,\n            options: {\n              _id: false,\n              id: false,\n              minimize: false,\n            },\n          },\n          configFields: tab.fields,\n          parentIsLocalized: parentIsLocalized || tab.localized,\n          payload,\n        }),\n      }\n\n      schema.add({\n        [tab.name]: localizeSchema(tab, baseSchema, payload.config.localization, parentIsLocalized),\n      })\n    } else {\n      tab.fields.forEach((subField: Field) => {\n        if (fieldIsVirtual(subField)) {\n          return\n        }\n        const addFieldSchema = getSchemaGenerator(subField.type)\n\n        if (addFieldSchema) {\n          addFieldSchema(\n            subField,\n            schema,\n            payload,\n            buildSchemaOptions,\n            (parentIsLocalized || tab.localized) ?? false,\n          )\n        }\n      })\n    }\n  })\n}\n\nconst text: FieldSchemaGenerator<TextField> = (\n  field,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const baseSchema = {\n    ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n    type: field.hasMany ? [String] : String,\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(field, baseSchema, payload.config.localization, parentIsLocalized),\n  })\n}\n\nconst textarea: FieldSchemaGenerator<TextareaField> = (\n  field: TextareaField,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const baseSchema = {\n    ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n    type: String,\n  }\n\n  schema.add({\n    [field.name]: localizeSchema(field, baseSchema, payload.config.localization, parentIsLocalized),\n  })\n}\n\nconst upload: FieldSchemaGenerator<UploadField> = (\n  field,\n  schema,\n  payload,\n  buildSchemaOptions,\n  parentIsLocalized,\n): void => {\n  const hasManyRelations = Array.isArray(field.relationTo)\n  let schemaToReturn: { [key: string]: any } = {}\n\n  const valueType = getRelationshipValueType(field, payload)\n\n  if (fieldShouldBeLocalized({ field, parentIsLocalized }) && payload.config.localization) {\n    schemaToReturn = {\n      _id: false,\n      type: payload.config.localization.localeCodes.reduce((locales, locale) => {\n        let localeSchema: { [key: string]: any } = {}\n\n        if (hasManyRelations) {\n          localeSchema = {\n            ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n            _id: false,\n            type: mongoose.Schema.Types.Mixed,\n            relationTo: { type: String, enum: field.relationTo },\n            value: {\n              type: valueType,\n              refPath: `${field.name}.${locale}.relationTo`,\n            },\n          }\n        } else {\n          localeSchema = {\n            ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n            type: valueType,\n            ref: field.relationTo,\n          }\n        }\n\n        return {\n          ...locales,\n          [locale]: field.hasMany\n            ? { type: [localeSchema], default: formatDefaultValue(field) }\n            : localeSchema,\n        }\n      }, {}),\n      localized: true,\n    }\n  } else if (hasManyRelations) {\n    schemaToReturn = {\n      ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n      _id: false,\n      type: mongoose.Schema.Types.Mixed,\n      relationTo: { type: String, enum: field.relationTo },\n      value: {\n        type: valueType,\n        refPath: `${field.name}.relationTo`,\n      },\n    }\n\n    if (field.hasMany) {\n      schemaToReturn = {\n        type: [schemaToReturn],\n        default: formatDefaultValue(field),\n      }\n    }\n  } else {\n    schemaToReturn = {\n      ...formatBaseSchema({ buildSchemaOptions, field, parentIsLocalized }),\n      type: valueType,\n      ref: field.relationTo,\n    }\n\n    if (field.hasMany) {\n      schemaToReturn = {\n        type: [schemaToReturn],\n        default: formatDefaultValue(field),\n      }\n    }\n  }\n\n  schema.add({\n    [field.name]: schemaToReturn,\n  })\n}\n\nconst getSchemaGenerator = (fieldType: string): FieldSchemaGenerator | null => {\n  if (fieldType in fieldToSchemaMap) {\n    return fieldToSchemaMap[fieldType as keyof typeof fieldToSchemaMap] as FieldSchemaGenerator\n  }\n\n  return null\n}\n\nconst fieldToSchemaMap = {\n  array,\n  blocks,\n  checkbox,\n  code,\n  collapsible,\n  date,\n  email,\n  group,\n  json,\n  number,\n  point,\n  radio,\n  relationship,\n  richText,\n  row,\n  select,\n  tabs,\n  text,\n  textarea,\n  upload,\n}\n\nconst getRelationshipValueType = (field: RelationshipField | UploadField, payload: Payload) => {\n  if (typeof field.relationTo === 'string') {\n    const customIDType = payload.collections[field.relationTo]?.customIDType\n\n    if (!customIDType) {\n      return mongoose.Schema.Types.ObjectId\n    }\n\n    if (customIDType === 'number') {\n      if (payload.db.useBigIntForNumberIDs) {\n        return mongoose.Schema.Types.BigInt\n      } else {\n        return mongoose.Schema.Types.Number\n      }\n    }\n\n    return mongoose.Schema.Types.String\n  }\n\n  // has custom id relationTo\n  if (\n    field.relationTo.some((relationTo) => {\n      return !!payload.collections[relationTo]?.customIDType\n    })\n  ) {\n    return mongoose.Schema.Types.Mixed\n  }\n\n  return mongoose.Schema.Types.ObjectId\n}\n"],"names":["mongoose","fieldAffectsData","fieldIsPresentationalOnly","fieldIsVirtual","fieldShouldBeLocalized","tabHasName","formatDefaultValue","field","defaultValue","undefined","formatBaseSchema","buildSchemaOptions","parentIsLocalized","disableUnique","draftsEnabled","indexSortableFields","schema","default","index","unique","required","type","sparse","hidden","localizeSchema","entity","localization","Array","isArray","locales","localeCodes","reduce","localeSchema","locale","_id","localized","buildSchema","args","configFields","flattenedFields","payload","allowIDField","options","fields","schemaFields","fieldsToSearch","idField","find","name","db","useBigIntForNumberIDs","Schema","Types","BigInt","Number","String","filter","forEach","addFieldSchema","getSchemaGenerator","compoundIndexes","indexDefinition","pathHasLocalized","config","localizedPath","replace","code","path","array","baseSchema","id","minimize","add","blocks","fieldSchema","discriminatorKey","blockReferences","blockItem","blockSchema","block","blockField","localeCode","discriminator","slug","checkbox","Boolean","collapsible","subField","date","Date","email","group","formattedBaseSchema","json","Mixed","number","hasMany","point","enum","coordinates","indexOptions","radio","map","option","value","relationship","hasManyRelations","relationTo","schemaToReturn","valueType","getRelationshipValueType","refPath","ref","richText","row","select","push","tabs","tab","text","textarea","upload","fieldType","fieldToSchemaMap","customIDType","collections","ObjectId","some"],"mappings":"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"}