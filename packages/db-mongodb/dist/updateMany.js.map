{"version":3,"sources":["../src/updateMany.ts"],"sourcesContent":["import type { MongooseUpdateQueryOptions, UpdateQuery } from 'mongoose'\n\nimport { flattenWhereToOperators, type UpdateMany } from 'payload'\n\nimport type { MongooseAdapter } from './index.js'\n\nimport { buildQuery } from './queries/buildQuery.js'\nimport { buildSortParam } from './queries/buildSortParam.js'\nimport { buildProjectionFromSelect } from './utilities/buildProjectionFromSelect.js'\nimport { getCollection } from './utilities/getEntity.js'\nimport { getSession } from './utilities/getSession.js'\nimport { handleError } from './utilities/handleError.js'\nimport { transform } from './utilities/transform.js'\n\nexport const updateMany: UpdateMany = async function updateMany(\n  this: MongooseAdapter,\n  {\n    collection: collectionSlug,\n    data,\n    limit,\n    locale,\n    options: optionsArgs = {},\n    req,\n    returning,\n    select,\n    sort: sortArg,\n    where,\n  },\n) {\n  let hasNearConstraint = false\n\n  if (where) {\n    const constraints = flattenWhereToOperators(where)\n    hasNearConstraint = constraints.some((prop) => Object.keys(prop).some((key) => key === 'near'))\n  }\n\n  const { collectionConfig, Model } = getCollection({ adapter: this, collectionSlug })\n\n  let sort: Record<string, unknown> | undefined\n  if (!hasNearConstraint) {\n    sort = buildSortParam({\n      adapter: this,\n      config: this.payload.config,\n      fields: collectionConfig.flattenedFields,\n      locale,\n      sort: sortArg || collectionConfig.defaultSort,\n      timestamps: true,\n    })\n  }\n\n  let query = await buildQuery({\n    adapter: this,\n    collectionSlug,\n    fields: collectionConfig.flattenedFields,\n    locale,\n    where,\n  })\n\n  const $inc: Record<string, number> = {}\n  const $push: Record<string, { $each: any[] } | any> = {}\n  const $addToSet: Record<string, { $each: any[] } | any> = {}\n  const $pull: Record<string, { $in: any[] } | any> = {}\n\n  transform({\n    $addToSet,\n    $inc,\n    $pull,\n    $push,\n    adapter: this,\n    data,\n    fields: collectionConfig.fields,\n    operation: 'write',\n  })\n\n  const updateOps: UpdateQuery<any> = {}\n\n  if (Object.keys($inc).length) {\n    updateOps.$inc = $inc\n  }\n  if (Object.keys($push).length) {\n    updateOps.$push = $push\n  }\n  if (Object.keys($addToSet).length) {\n    updateOps.$addToSet = $addToSet\n  }\n  if (Object.keys($pull).length) {\n    updateOps.$pull = $pull\n  }\n  if (Object.keys(updateOps).length) {\n    updateOps.$set = data\n    data = updateOps\n  }\n\n  const options: MongooseUpdateQueryOptions = {\n    ...optionsArgs,\n    lean: true,\n    new: true,\n    projection: buildProjectionFromSelect({\n      adapter: this,\n      fields: collectionConfig.flattenedFields,\n      select,\n    }),\n    session: await getSession(this, req),\n    // Timestamps are manually added by the write transform\n    timestamps: false,\n  }\n\n  try {\n    if (typeof limit === 'number' && limit > 0) {\n      const documentsToUpdate = await Model.find(\n        query,\n        {},\n        { ...options, limit, projection: { _id: 1 }, sort },\n      )\n      if (documentsToUpdate.length === 0) {\n        return null\n      }\n\n      query = { _id: { $in: documentsToUpdate.map((doc) => doc._id) } }\n    }\n\n    await Model.updateMany(query, data, options)\n  } catch (error) {\n    handleError({ collection: collectionSlug, error, req })\n  }\n\n  if (returning === false) {\n    return null\n  }\n\n  const result = await Model.find(\n    query,\n    {},\n    {\n      ...options,\n      sort,\n    },\n  )\n\n  transform({\n    adapter: this,\n    data: result,\n    fields: collectionConfig.fields,\n    operation: 'read',\n  })\n\n  return result\n}\n"],"names":["flattenWhereToOperators","buildQuery","buildSortParam","buildProjectionFromSelect","getCollection","getSession","handleError","transform","updateMany","collection","collectionSlug","data","limit","locale","options","optionsArgs","req","returning","select","sort","sortArg","where","hasNearConstraint","constraints","some","prop","Object","keys","key","collectionConfig","Model","adapter","config","payload","fields","flattenedFields","defaultSort","timestamps","query","$inc","$push","$addToSet","$pull","operation","updateOps","length","$set","lean","new","projection","session","documentsToUpdate","find","_id","$in","map","doc","error","result"],"mappings":"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"}