{"version":3,"sources":["../src/staticHandler.ts"],"sourcesContent":["import type { StaticHandler } from '@payloadcms/plugin-cloud-storage/types'\nimport type { Where } from 'payload'\nimport type { UTApi } from 'uploadthing/server'\n\nimport { getRangeRequestInfo } from 'payload/internal'\n\nimport { getKeyFromFilename } from './utilities.js'\n\ntype Args = {\n  utApi: UTApi\n}\n\nexport const getHandler = ({ utApi }: Args): StaticHandler => {\n  return async (\n    req,\n    { doc, headers: incomingHeaders, params: { clientUploadContext, collection, filename } },\n  ) => {\n    try {\n      let key: string\n      const collectionConfig = req.payload.collections[collection]?.config\n\n      if (\n        clientUploadContext &&\n        typeof clientUploadContext === 'object' &&\n        'key' in clientUploadContext &&\n        typeof clientUploadContext.key === 'string'\n      ) {\n        key = clientUploadContext.key\n      } else {\n        let retrievedDoc = doc\n\n        if (!retrievedDoc) {\n          const or: Where[] = [\n            {\n              filename: {\n                equals: filename,\n              },\n            },\n          ]\n\n          if (collectionConfig?.upload.imageSizes) {\n            collectionConfig.upload.imageSizes.forEach(({ name }) => {\n              or.push({\n                [`sizes.${name}.filename`]: {\n                  equals: filename,\n                },\n              })\n            })\n          }\n\n          const result = await req.payload.db.findOne({\n            collection,\n            req,\n            where: { or },\n          })\n\n          if (result) {\n            retrievedDoc = result\n          }\n        }\n\n        if (!retrievedDoc) {\n          return new Response(null, { status: 404, statusText: 'Not Found' })\n        }\n\n        key = getKeyFromFilename(retrievedDoc, filename)!\n      }\n\n      if (!key) {\n        return new Response(null, { status: 404, statusText: 'Not Found' })\n      }\n\n      const { url: signedURL } = await utApi.getSignedURL(key)\n\n      if (!signedURL) {\n        return new Response(null, { status: 404, statusText: 'Not Found' })\n      }\n\n      // Get file metadata first for range validation\n      const headResponse = await fetch(signedURL, { method: 'HEAD' })\n      if (!headResponse.ok) {\n        return new Response(null, { status: 404, statusText: 'Not Found' })\n      }\n\n      const fileSize = Number(headResponse.headers.get('content-length'))\n\n      // Handle range request\n      const rangeHeader = req.headers.get('range')\n      const rangeResult = getRangeRequestInfo({ fileSize, rangeHeader })\n\n      if (rangeResult.type === 'invalid') {\n        return new Response(null, {\n          headers: new Headers(rangeResult.headers),\n          status: rangeResult.status,\n        })\n      }\n\n      const response = await fetch(signedURL, {\n        headers:\n          rangeResult.type === 'partial'\n            ? { Range: `bytes=${rangeResult.rangeStart}-${rangeResult.rangeEnd}` }\n            : undefined,\n      })\n\n      if (!response.ok || !response.body) {\n        return new Response(null, { status: 404, statusText: 'Not Found' })\n      }\n\n      const etagFromHeaders = req.headers.get('etag') || req.headers.get('if-none-match')\n      const objectEtag = response.headers.get('etag')\n\n      let headers = new Headers(incomingHeaders)\n\n      // Add range-related headers from the result\n      for (const [key, value] of Object.entries(rangeResult.headers)) {\n        headers.append(key, value)\n      }\n\n      const contentType = response.headers.get('content-type')\n      if (contentType) {\n        headers.append('Content-Type', contentType)\n      }\n\n      if (objectEtag) {\n        headers.append('ETag', objectEtag)\n      }\n\n      if (\n        collectionConfig?.upload &&\n        typeof collectionConfig.upload === 'object' &&\n        typeof collectionConfig.upload.modifyResponseHeaders === 'function'\n      ) {\n        headers = collectionConfig.upload.modifyResponseHeaders({ headers }) || headers\n      }\n\n      if (etagFromHeaders && etagFromHeaders === objectEtag) {\n        return new Response(null, {\n          headers,\n          status: 304,\n        })\n      }\n\n      return new Response(response.body, {\n        headers,\n        status: rangeResult.status,\n      })\n    } catch (err) {\n      req.payload.logger.error({ err, msg: 'Unexpected error in staticHandler' })\n      return new Response('Internal Server Error', { status: 500 })\n    }\n  }\n}\n"],"names":["getRangeRequestInfo","getKeyFromFilename","getHandler","utApi","req","doc","headers","incomingHeaders","params","clientUploadContext","collection","filename","key","collectionConfig","payload","collections","config","retrievedDoc","or","equals","upload","imageSizes","forEach","name","push","result","db","findOne","where","Response","status","statusText","url","signedURL","getSignedURL","headResponse","fetch","method","ok","fileSize","Number","get","rangeHeader","rangeResult","type","Headers","response","Range","rangeStart","rangeEnd","undefined","body","etagFromHeaders","objectEtag","value","Object","entries","append","contentType","modifyResponseHeaders","err","logger","error","msg"],"mappings":"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"}