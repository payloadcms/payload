{"version":3,"sources":["../../src/import/getCreateImportCollectionTask.ts"],"sourcesContent":["import type { Config, TaskConfig, TypedUser } from 'payload'\n\nimport type { Import } from './createImport.js'\n\nimport { createImport } from './createImport.js'\nimport { getFields } from './getFields.js'\n\nexport type ImportTaskInput = {\n  defaultVersionStatus?: 'draft' | 'published'\n  importId?: string\n  importsCollection?: string\n  user?: string\n} & Import\n\nexport const getCreateCollectionImportTask = (\n  config: Config,\n): TaskConfig<{\n  input: ImportTaskInput\n  output: object\n}> => {\n  const inputSchema = getFields(config).concat(\n    {\n      name: 'user',\n      type: 'text',\n    },\n    {\n      name: 'userCollection',\n      type: 'text',\n    },\n    {\n      name: 'importsCollection',\n      type: 'text',\n    },\n    {\n      name: 'file',\n      type: 'group',\n      fields: [\n        {\n          name: 'data',\n          type: 'text',\n        },\n        {\n          name: 'mimetype',\n          type: 'text',\n        },\n        {\n          name: 'name',\n          type: 'text',\n        },\n      ],\n    },\n    {\n      name: 'format',\n      type: 'select',\n      options: ['csv', 'json'],\n    },\n    {\n      name: 'debug',\n      type: 'checkbox',\n    },\n  )\n\n  return {\n    slug: 'createCollectionImport',\n    handler: async ({ input, req }) => {\n      // Convert file data back to Buffer if it was serialized\n      if (input.file && typeof input.file.data === 'string') {\n        input.file.data = Buffer.from(input.file.data, 'base64')\n      }\n\n      const result = await createImport({\n        ...input,\n        req,\n      })\n\n      // Update the import document with results if importId is provided\n      if (input.importId) {\n        await req.payload.update({\n          id: input.importId,\n          collection: input.importsCollection || 'imports',\n          data: {\n            status:\n              result.errors.length === 0\n                ? 'completed'\n                : result.imported + result.updated === 0\n                  ? 'failed'\n                  : 'partial',\n            summary: {\n              imported: result.imported,\n              issueDetails:\n                result.errors.length > 0\n                  ? result.errors.map((e) => ({\n                      data: e.doc,\n                      error: e.error,\n                      row: e.index + 1,\n                    }))\n                  : undefined,\n              issues: result.errors.length,\n              total: result.total,\n              updated: result.updated,\n            },\n          },\n        })\n      }\n\n      return {\n        output: result,\n      }\n    },\n    inputSchema,\n  }\n}\n"],"names":["createImport","getFields","getCreateCollectionImportTask","config","inputSchema","concat","name","type","fields","options","slug","handler","input","req","file","data","Buffer","from","result","importId","payload","update","id","collection","importsCollection","status","errors","length","imported","updated","summary","issueDetails","map","e","doc","error","row","index","undefined","issues","total","output"],"mappings":"AAIA,SAASA,YAAY,QAAQ,oBAAmB;AAChD,SAASC,SAAS,QAAQ,iBAAgB;AAS1C,OAAO,MAAMC,gCAAgC,CAC3CC;IAKA,MAAMC,cAAcH,UAAUE,QAAQE,MAAM,CAC1C;QACEC,MAAM;QACNC,MAAM;IACR,GACA;QACED,MAAM;QACNC,MAAM;IACR,GACA;QACED,MAAM;QACNC,MAAM;IACR,GACA;QACED,MAAM;QACNC,MAAM;QACNC,QAAQ;YACN;gBACEF,MAAM;gBACNC,MAAM;YACR;YACA;gBACED,MAAM;gBACNC,MAAM;YACR;YACA;gBACED,MAAM;gBACNC,MAAM;YACR;SACD;IACH,GACA;QACED,MAAM;QACNC,MAAM;QACNE,SAAS;YAAC;YAAO;SAAO;IAC1B,GACA;QACEH,MAAM;QACNC,MAAM;IACR;IAGF,OAAO;QACLG,MAAM;QACNC,SAAS,OAAO,EAAEC,KAAK,EAAEC,GAAG,EAAE;YAC5B,wDAAwD;YACxD,IAAID,MAAME,IAAI,IAAI,OAAOF,MAAME,IAAI,CAACC,IAAI,KAAK,UAAU;gBACrDH,MAAME,IAAI,CAACC,IAAI,GAAGC,OAAOC,IAAI,CAACL,MAAME,IAAI,CAACC,IAAI,EAAE;YACjD;YAEA,MAAMG,SAAS,MAAMlB,aAAa;gBAChC,GAAGY,KAAK;gBACRC;YACF;YAEA,kEAAkE;YAClE,IAAID,MAAMO,QAAQ,EAAE;gBAClB,MAAMN,IAAIO,OAAO,CAACC,MAAM,CAAC;oBACvBC,IAAIV,MAAMO,QAAQ;oBAClBI,YAAYX,MAAMY,iBAAiB,IAAI;oBACvCT,MAAM;wBACJU,QACEP,OAAOQ,MAAM,CAACC,MAAM,KAAK,IACrB,cACAT,OAAOU,QAAQ,GAAGV,OAAOW,OAAO,KAAK,IACnC,WACA;wBACRC,SAAS;4BACPF,UAAUV,OAAOU,QAAQ;4BACzBG,cACEb,OAAOQ,MAAM,CAACC,MAAM,GAAG,IACnBT,OAAOQ,MAAM,CAACM,GAAG,CAAC,CAACC,IAAO,CAAA;oCACxBlB,MAAMkB,EAAEC,GAAG;oCACXC,OAAOF,EAAEE,KAAK;oCACdC,KAAKH,EAAEI,KAAK,GAAG;gCACjB,CAAA,KACAC;4BACNC,QAAQrB,OAAOQ,MAAM,CAACC,MAAM;4BAC5Ba,OAAOtB,OAAOsB,KAAK;4BACnBX,SAASX,OAAOW,OAAO;wBACzB;oBACF;gBACF;YACF;YAEA,OAAO;gBACLY,QAAQvB;YACV;QACF;QACAd;IACF;AACF,EAAC"}