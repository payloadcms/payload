{"version":3,"sources":["../../src/import/handlePreview.ts"],"sourcesContent":["import type { PayloadRequest } from 'payload'\n\nimport { addDataAndFileToRequest } from 'payload'\n\nimport type { ImportPreviewResponse } from '../types.js'\n\nimport {\n  DEFAULT_PREVIEW_LIMIT,\n  MAX_PREVIEW_LIMIT,\n  MIN_PREVIEW_LIMIT,\n  MIN_PREVIEW_PAGE,\n} from '../constants.js'\nimport { getImportFieldFunctions } from '../utilities/getImportFieldFunctions.js'\nimport { parseCSV } from '../utilities/parseCSV.js'\nimport { parseJSON } from '../utilities/parseJSON.js'\nimport { removeDisabledFields } from '../utilities/removeDisabledFields.js'\nimport { unflattenObject } from '../utilities/unflattenObject.js'\n\nexport const handlePreview = async (req: PayloadRequest): Promise<Response> => {\n  await addDataAndFileToRequest(req)\n\n  const {\n    collectionSlug,\n    fileData,\n    format,\n    previewLimit: rawPreviewLimit = DEFAULT_PREVIEW_LIMIT,\n    previewPage: rawPreviewPage = 1,\n  } = req.data as {\n    collectionSlug: string\n    fileData?: string\n    format?: 'csv' | 'json'\n    previewLimit?: number\n    previewPage?: number\n  }\n\n  // Validate and clamp pagination values to safe bounds\n  const previewLimit = Math.max(MIN_PREVIEW_LIMIT, Math.min(rawPreviewLimit, MAX_PREVIEW_LIMIT))\n  const previewPage = Math.max(MIN_PREVIEW_PAGE, rawPreviewPage)\n\n  const targetCollection = req.payload.collections[collectionSlug]\n  if (!targetCollection) {\n    return Response.json(\n      { error: `Collection with slug ${collectionSlug} not found` },\n      { status: 400 },\n    )\n  }\n\n  if (!fileData) {\n    return Response.json({ error: 'No file data provided' }, { status: 400 })\n  }\n\n  try {\n    // Parse the file data\n    let parsedData: Record<string, unknown>[]\n    const buffer = Buffer.from(fileData, 'base64')\n\n    if (format === 'csv') {\n      const rawData = await parseCSV({ data: buffer, req })\n\n      // Get fromCSV functions for field transformations\n      const fromCSVFunctions = getImportFieldFunctions({\n        fields: targetCollection.config.flattenedFields || [],\n      })\n\n      // Unflatten CSV data\n      parsedData = rawData\n        .map((doc) => {\n          const unflattened = unflattenObject({\n            data: doc,\n            fields: targetCollection.config.flattenedFields ?? [],\n            fromCSVFunctions,\n            req,\n          })\n          return unflattened ?? {}\n        })\n        .filter((doc) => doc && Object.keys(doc).length > 0)\n    } else {\n      parsedData = parseJSON({ data: buffer, req })\n    }\n\n    // Remove disabled fields from the documents\n    const disabledFields =\n      targetCollection.config.admin?.custom?.['plugin-import-export']?.disabledFields ?? []\n\n    if (disabledFields.length > 0) {\n      parsedData = parsedData.map((doc) => removeDisabledFields(doc, disabledFields))\n    }\n\n    // Calculate pagination\n    const totalDocs = parsedData.length\n    const totalPages = totalDocs === 0 ? 0 : Math.ceil(totalDocs / previewLimit)\n    const startIndex = (previewPage - 1) * previewLimit\n    const endIndex = startIndex + previewLimit\n    const paginatedDocs = parsedData.slice(startIndex, endIndex)\n\n    const hasNextPage = previewPage < totalPages\n    const hasPrevPage = previewPage > 1\n\n    const response: ImportPreviewResponse = {\n      docs: paginatedDocs,\n      hasNextPage,\n      hasPrevPage,\n      limit: previewLimit,\n      page: previewPage,\n      totalDocs,\n      totalPages,\n    }\n\n    return Response.json(response)\n  } catch (error) {\n    req.payload.logger.error({ err: error, msg: 'Error parsing import preview data' })\n    return Response.json({ error: 'Failed to parse file data' }, { status: 500 })\n  }\n}\n"],"names":["addDataAndFileToRequest","DEFAULT_PREVIEW_LIMIT","MAX_PREVIEW_LIMIT","MIN_PREVIEW_LIMIT","MIN_PREVIEW_PAGE","getImportFieldFunctions","parseCSV","parseJSON","removeDisabledFields","unflattenObject","handlePreview","req","collectionSlug","fileData","format","previewLimit","rawPreviewLimit","previewPage","rawPreviewPage","data","Math","max","min","targetCollection","payload","collections","Response","json","error","status","parsedData","buffer","Buffer","from","rawData","fromCSVFunctions","fields","config","flattenedFields","map","doc","unflattened","filter","Object","keys","length","disabledFields","admin","custom","totalDocs","totalPages","ceil","startIndex","endIndex","paginatedDocs","slice","hasNextPage","hasPrevPage","response","docs","limit","page","logger","err","msg"],"mappings":"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"}