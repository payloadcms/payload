{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import type { Config } from 'payload'\n\nimport { deepMergeSimple } from 'payload'\n\nimport type { PluginDefaultTranslationsObject } from './translations/types.js'\nimport type {\n  FromCSVFunction,\n  ImportExportPluginConfig,\n  PluginCollectionConfig,\n  ToCSVFunction,\n} from './types.js'\n\nimport { getCreateCollectionExportTask } from './export/getCreateExportCollectionTask.js'\nimport { getCreateCollectionImportTask } from './import/getCreateImportCollectionTask.js'\nimport { translations } from './translations/index.js'\nimport { collectDisabledFieldPaths } from './utilities/collectDisabledFieldPaths.js'\nimport { getPluginCollections } from './utilities/getPluginCollections.js'\n\nexport const importExportPlugin =\n  (pluginConfig: ImportExportPluginConfig) =>\n  async (config: Config): Promise<Config> => {\n    // Get all export/import collections and the mappings from target collections to custom collections\n    const { customExportSlugMap, customImportSlugMap, exportCollections, importCollections } =\n      await getPluginCollections({\n        config,\n        pluginConfig,\n      })\n\n    // Base collections are at index 0 (always present)\n    const baseExportCollection = exportCollections[0]!\n    const baseImportCollection = importCollections[0]!\n\n    // Collect all export and import collection slugs for filtering\n    const allExportSlugs = new Set(exportCollections.map((c) => c.slug))\n    const allImportSlugs = new Set(importCollections.map((c) => c.slug))\n\n    // Initialize collections array if needed\n    if (!config.collections) {\n      config.collections = []\n    }\n\n    // Push all export/import collections if their slugs don't already exist\n    for (const collection of [...exportCollections, ...importCollections]) {\n      const slugExists = config.collections.some((c) => c.slug === collection.slug)\n      if (!slugExists) {\n        config.collections.push(collection)\n      }\n    }\n\n    // inject custom import export provider\n    config.admin = config.admin || {}\n    config.admin.components = config.admin.components || {}\n    config.admin.components.providers = config.admin.components.providers || []\n    config.admin.components.providers.push(\n      '@payloadcms/plugin-import-export/rsc#ImportExportProvider',\n    )\n\n    // inject the createExport and createImport jobs into the config\n    ;((config.jobs ??= {}).tasks ??= []).push(getCreateCollectionExportTask(config))\n    config.jobs.tasks.push(getCreateCollectionImportTask(config))\n\n    // Build a map of collection configs for quick lookup\n    const collectionConfigMap = new Map<string, PluginCollectionConfig>()\n    if (pluginConfig.collections) {\n      for (const collectionConfig of pluginConfig.collections) {\n        collectionConfigMap.set(collectionConfig.slug, collectionConfig)\n      }\n    }\n\n    // Determine which collections to add import/export menu items to\n    // Exclude all export and import collections\n    const collectionsToUpdate = config.collections.filter(\n      (c) => !allExportSlugs.has(c.slug) && !allImportSlugs.has(c.slug),\n    )\n\n    for (const collection of collectionsToUpdate) {\n      // Get the plugin config for this collection (if specified)\n      const collectionPluginConfig = collectionConfigMap.get(collection.slug)\n\n      // If collections array is specified but this collection is not in it, skip\n      if (\n        pluginConfig.collections &&\n        pluginConfig.collections.length > 0 &&\n        !collectionPluginConfig\n      ) {\n        continue\n      }\n\n      // Determine which export/import collection to use for this collection\n      const exportSlugForCollection =\n        customExportSlugMap.get(collection.slug) || baseExportCollection.slug\n      const importSlugForCollection =\n        customImportSlugMap.get(collection.slug) || baseImportCollection.slug\n\n      // Check if export/import are disabled for this collection\n      const exportDisabled = collectionPluginConfig?.export === false\n      const importDisabled = collectionPluginConfig?.import === false\n\n      if (!collection.admin) {\n        collection.admin = { components: { listMenuItems: [] } }\n      }\n      const components = collection.admin.components || {}\n      if (!components.listMenuItems) {\n        components.listMenuItems = []\n      }\n\n      // Add export menu item if not disabled\n      if (!exportDisabled) {\n        components.listMenuItems.push({\n          clientProps: {\n            exportCollectionSlug: exportSlugForCollection,\n          },\n          path: '@payloadcms/plugin-import-export/rsc#ExportListMenuItem',\n        })\n      }\n\n      // Add import menu item if not disabled\n      if (!importDisabled) {\n        components.listMenuItems.push({\n          clientProps: {\n            importCollectionSlug: importSlugForCollection,\n          },\n          path: '@payloadcms/plugin-import-export/rsc#ImportListMenuItem',\n        })\n      }\n\n      // Find fields explicitly marked as disabled for import/export\n      const disabledFieldAccessors = collectDisabledFieldPaths(collection.fields)\n\n      // Store disabled field accessors in the admin config for use in the UI\n      collection.admin.custom = {\n        ...(collection.admin.custom || {}),\n        'plugin-import-export': {\n          ...(collection.admin.custom?.['plugin-import-export'] || {}),\n          disabledFields: disabledFieldAccessors,\n        },\n      }\n\n      collection.admin.components = components\n    }\n\n    if (!config.i18n) {\n      config.i18n = {}\n    }\n\n    /**\n     * Merge plugin translations\n     */\n    const simplifiedTranslations = Object.entries(translations).reduce(\n      (acc, [key, value]) => {\n        acc[key] = value.translations\n        return acc\n      },\n      {} as Record<string, PluginDefaultTranslationsObject>,\n    )\n\n    config.i18n = {\n      ...config.i18n,\n      translations: deepMergeSimple(simplifiedTranslations, config.i18n?.translations ?? {}),\n    }\n\n    return config\n  }\n\ndeclare module 'payload' {\n  export interface FieldCustom {\n    'plugin-import-export'?: {\n      /**\n       * When `true` the field is **completely excluded** from the import-export plugin:\n       * - It will not appear in the \"Fields to export\" selector.\n       * - It is hidden from the preview list when no specific fields are chosen.\n       * - Its data is omitted from the final CSV / JSON export.\n       * @default false\n       */\n      disabled?: boolean\n      fromCSV?: FromCSVFunction\n      /**\n       * Custom function used to modify the outgoing csv data by manipulating the data, siblingData or by returning the desired value\n       */\n      toCSV?: ToCSVFunction\n    }\n  }\n\n  export interface CollectionAdminCustom {\n    'plugin-import-export'?: {\n      /**\n       * Array of field paths that are disabled for import/export.\n       * These paths are collected from fields marked with `custom['plugin-import-export'].disabled = true`.\n       */\n      disabledFields?: string[]\n    }\n  }\n}\n"],"names":["deepMergeSimple","getCreateCollectionExportTask","getCreateCollectionImportTask","translations","collectDisabledFieldPaths","getPluginCollections","importExportPlugin","pluginConfig","config","customExportSlugMap","customImportSlugMap","exportCollections","importCollections","baseExportCollection","baseImportCollection","allExportSlugs","Set","map","c","slug","allImportSlugs","collections","collection","slugExists","some","push","admin","components","providers","jobs","tasks","collectionConfigMap","Map","collectionConfig","set","collectionsToUpdate","filter","has","collectionPluginConfig","get","length","exportSlugForCollection","importSlugForCollection","exportDisabled","export","importDisabled","import","listMenuItems","clientProps","exportCollectionSlug","path","importCollectionSlug","disabledFieldAccessors","fields","custom","disabledFields","i18n","simplifiedTranslations","Object","entries","reduce","acc","key","value"],"mappings":"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"}