{"version":3,"sources":["../../src/export/handlePreview.ts"],"sourcesContent":["import type { FlattenedField, PayloadRequest, Where } from 'payload'\n\nimport { addDataAndFileToRequest } from 'payload'\n\nimport type { ExportPreviewResponse } from '../types.js'\n\nimport {\n  DEFAULT_PREVIEW_LIMIT,\n  MAX_PREVIEW_LIMIT,\n  MIN_PREVIEW_LIMIT,\n  MIN_PREVIEW_PAGE,\n} from '../constants.js'\nimport { flattenObject } from '../utilities/flattenObject.js'\nimport { getExportFieldFunctions } from '../utilities/getExportFieldFunctions.js'\nimport { getFlattenedFieldKeys } from '../utilities/getFlattenedFieldKeys.js'\nimport { getSchemaColumns } from '../utilities/getSchemaColumns.js'\nimport { getSelect } from '../utilities/getSelect.js'\nimport { getValueAtPath } from '../utilities/getvalueAtPath.js'\nimport { removeDisabledFields } from '../utilities/removeDisabledFields.js'\nimport { setNestedValue } from '../utilities/setNestedValue.js'\n\nexport const handlePreview = async (req: PayloadRequest): Promise<Response> => {\n  await addDataAndFileToRequest(req)\n\n  const {\n    collectionSlug,\n    draft: draftFromReq,\n    fields,\n    limit: exportLimit,\n    locale,\n    previewLimit: rawPreviewLimit = DEFAULT_PREVIEW_LIMIT,\n    previewPage: rawPreviewPage = 1,\n    sort,\n    where: whereFromReq = {},\n  } = req.data as {\n    collectionSlug: string\n    draft?: 'no' | 'yes'\n    fields?: string[]\n    format?: 'csv' | 'json'\n    limit?: number\n    locale?: string\n    previewLimit?: number\n    previewPage?: number\n    sort?: any\n    where?: any\n  }\n\n  // Validate and clamp pagination values to safe bounds\n  const previewLimit = Math.max(MIN_PREVIEW_LIMIT, Math.min(rawPreviewLimit, MAX_PREVIEW_LIMIT))\n  const previewPage = Math.max(MIN_PREVIEW_PAGE, rawPreviewPage)\n\n  const targetCollection = req.payload.collections[collectionSlug]\n  if (!targetCollection) {\n    return Response.json(\n      { error: `Collection with slug ${collectionSlug} not found` },\n      { status: 400 },\n    )\n  }\n\n  const select = Array.isArray(fields) && fields.length > 0 ? getSelect(fields) : undefined\n  const draft = draftFromReq === 'yes'\n  const collectionHasVersions = Boolean(targetCollection.config.versions)\n\n  // Only filter by _status for versioned collections\n  const publishedWhere: Where = collectionHasVersions ? { _status: { equals: 'published' } } : {}\n\n  const where: Where = {\n    and: [whereFromReq, draft ? {} : publishedWhere],\n  }\n\n  // Count total docs matching export criteria\n  const countResult = await req.payload.count({\n    collection: collectionSlug,\n    overrideAccess: false,\n    req,\n    where,\n  })\n\n  const totalMatchingDocs = countResult.totalDocs\n\n  // Calculate actual export count (respecting export limit)\n  const exportTotalDocs =\n    exportLimit && exportLimit > 0 ? Math.min(totalMatchingDocs, exportLimit) : totalMatchingDocs\n\n  // Calculate preview pagination that respects export limit\n  // Preview should only show docs that will actually be exported\n  const previewStartIndex = (previewPage - 1) * previewLimit\n\n  // Calculate pagination info based on export limit (not raw DB results)\n  const previewTotalPages = exportTotalDocs === 0 ? 0 : Math.ceil(exportTotalDocs / previewLimit)\n\n  const isCSV = req?.data?.format === 'csv'\n\n  // Get locale codes for locale expansion when locale='all'\n  const localeCodes =\n    locale === 'all' && req.payload.config.localization\n      ? req.payload.config.localization.localeCodes\n      : undefined\n\n  // Get disabled fields configuration\n  const disabledFields =\n    targetCollection.config.admin?.custom?.['plugin-import-export']?.disabledFields ?? []\n\n  // Always compute columns for CSV (even if no docs) for consistent schema\n  const columns = isCSV\n    ? getSchemaColumns({\n        collectionConfig: targetCollection.config,\n        disabledFields,\n        fields,\n        locale: locale ?? undefined,\n        localeCodes,\n      })\n    : undefined\n\n  // If we're beyond the export limit, return empty docs with columns\n  if (exportLimit && exportLimit > 0 && previewStartIndex >= exportLimit) {\n    const response: ExportPreviewResponse = {\n      columns,\n      docs: [],\n      exportTotalDocs,\n      hasNextPage: false,\n      hasPrevPage: previewPage > 1,\n      limit: previewLimit,\n      page: previewPage,\n      totalDocs: exportTotalDocs,\n      totalPages: previewTotalPages,\n    }\n    return Response.json(response)\n  }\n\n  // Fetch preview page with full previewLimit to maintain consistent pagination offsets\n  // We'll trim the results afterwards if needed to respect export limit\n  const result = await req.payload.find({\n    collection: collectionSlug,\n    depth: 1,\n    draft,\n    limit: previewLimit,\n    locale,\n    overrideAccess: false,\n    page: previewPage,\n    req,\n    select,\n    sort,\n    where,\n  })\n\n  // Trim docs to respect export limit boundary\n  let docs = result.docs\n  if (exportLimit && exportLimit > 0) {\n    const remainingInExport = exportLimit - previewStartIndex\n    if (remainingInExport < docs.length) {\n      docs = docs.slice(0, remainingInExport)\n    }\n  }\n\n  // Transform docs based on format\n  let transformed: Record<string, unknown>[]\n\n  if (isCSV) {\n    const toCSVFunctions = getExportFieldFunctions({\n      fields: targetCollection.config.fields as FlattenedField[],\n    })\n\n    const possibleKeys = getFlattenedFieldKeys(\n      targetCollection.config.fields as FlattenedField[],\n      '',\n      { localeCodes },\n    )\n\n    transformed = docs.map((doc) => {\n      const row = flattenObject({\n        doc,\n        fields,\n        toCSVFunctions,\n      })\n\n      for (const key of possibleKeys) {\n        if (!(key in row)) {\n          row[key] = null\n        }\n      }\n\n      return row\n    })\n  } else {\n    transformed = docs.map((doc) => {\n      let output: Record<string, unknown> = { ...doc }\n\n      // Remove disabled fields first\n      output = removeDisabledFields(output, disabledFields)\n\n      // Then trim to selected fields only (if fields are provided)\n      if (Array.isArray(fields) && fields.length > 0) {\n        const trimmed: Record<string, unknown> = {}\n\n        for (const key of fields) {\n          const value = getValueAtPath(output, key)\n          setNestedValue(trimmed, key, value ?? null)\n        }\n\n        output = trimmed\n      }\n\n      return output\n    })\n  }\n\n  const hasNextPage = previewPage < previewTotalPages\n  const hasPrevPage = previewPage > 1\n\n  const response: ExportPreviewResponse = {\n    columns,\n    docs: transformed,\n    exportTotalDocs,\n    hasNextPage,\n    hasPrevPage,\n    limit: previewLimit,\n    page: previewPage,\n    totalDocs: exportTotalDocs,\n    totalPages: previewTotalPages,\n  }\n\n  return Response.json(response)\n}\n"],"names":["addDataAndFileToRequest","DEFAULT_PREVIEW_LIMIT","MAX_PREVIEW_LIMIT","MIN_PREVIEW_LIMIT","MIN_PREVIEW_PAGE","flattenObject","getExportFieldFunctions","getFlattenedFieldKeys","getSchemaColumns","getSelect","getValueAtPath","removeDisabledFields","setNestedValue","handlePreview","req","collectionSlug","draft","draftFromReq","fields","limit","exportLimit","locale","previewLimit","rawPreviewLimit","previewPage","rawPreviewPage","sort","where","whereFromReq","data","Math","max","min","targetCollection","payload","collections","Response","json","error","status","select","Array","isArray","length","undefined","collectionHasVersions","Boolean","config","versions","publishedWhere","_status","equals","and","countResult","count","collection","overrideAccess","totalMatchingDocs","totalDocs","exportTotalDocs","previewStartIndex","previewTotalPages","ceil","isCSV","format","localeCodes","localization","disabledFields","admin","custom","columns","collectionConfig","response","docs","hasNextPage","hasPrevPage","page","totalPages","result","find","depth","remainingInExport","slice","transformed","toCSVFunctions","possibleKeys","map","doc","row","key","output","trimmed","value"],"mappings":"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"}