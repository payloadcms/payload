{"version":3,"sources":["../../src/export/handleDownload.ts"],"sourcesContent":["import type { PayloadRequest } from 'payload'\n\nimport { APIError } from 'payload'\n\nimport { createExport } from './createExport.js'\n\nexport const handleDownload = async (req: PayloadRequest, debug = false) => {\n  try {\n    let body\n\n    if (typeof req?.json === 'function') {\n      body = await req.json()\n    }\n\n    if (!body || !body.data) {\n      throw new APIError('Request data is required.')\n    }\n\n    const { collectionSlug } = body.data || {}\n\n    req.payload.logger.info(`Download request received ${collectionSlug}`)\n\n    const { user } = req\n\n    body.data.userID = user?.id || user?.user?.id\n    body.data.userCollection = user?.collection || user?.user?.collection\n\n    const res = await createExport({\n      ...body.data,\n      debug,\n      download: true,\n      req,\n      user: req.user,\n    })\n\n    return res as Response\n  } catch (err) {\n    // Return JSON for front-end toast\n    return new Response(\n      JSON.stringify({ errors: [{ message: (err as Error).message || 'Something went wrong' }] }),\n      { headers: { 'Content-Type': 'application/json' }, status: 400 },\n    )\n  }\n}\n"],"names":["APIError","createExport","handleDownload","req","debug","body","json","data","collectionSlug","payload","logger","info","user","userID","id","userCollection","collection","res","download","err","Response","JSON","stringify","errors","message","headers","status"],"mappings":"AAEA,SAASA,QAAQ,QAAQ,UAAS;AAElC,SAASC,YAAY,QAAQ,oBAAmB;AAEhD,OAAO,MAAMC,iBAAiB,OAAOC,KAAqBC,QAAQ,KAAK;IACrE,IAAI;QACF,IAAIC;QAEJ,IAAI,OAAOF,KAAKG,SAAS,YAAY;YACnCD,OAAO,MAAMF,IAAIG,IAAI;QACvB;QAEA,IAAI,CAACD,QAAQ,CAACA,KAAKE,IAAI,EAAE;YACvB,MAAM,IAAIP,SAAS;QACrB;QAEA,MAAM,EAAEQ,cAAc,EAAE,GAAGH,KAAKE,IAAI,IAAI,CAAC;QAEzCJ,IAAIM,OAAO,CAACC,MAAM,CAACC,IAAI,CAAC,CAAC,0BAA0B,EAAEH,gBAAgB;QAErE,MAAM,EAAEI,IAAI,EAAE,GAAGT;QAEjBE,KAAKE,IAAI,CAACM,MAAM,GAAGD,MAAME,MAAMF,MAAMA,MAAME;QAC3CT,KAAKE,IAAI,CAACQ,cAAc,GAAGH,MAAMI,cAAcJ,MAAMA,MAAMI;QAE3D,MAAMC,MAAM,MAAMhB,aAAa;YAC7B,GAAGI,KAAKE,IAAI;YACZH;YACAc,UAAU;YACVf;YACAS,MAAMT,IAAIS,IAAI;QAChB;QAEA,OAAOK;IACT,EAAE,OAAOE,KAAK;QACZ,kCAAkC;QAClC,OAAO,IAAIC,SACTC,KAAKC,SAAS,CAAC;YAAEC,QAAQ;gBAAC;oBAAEC,SAAS,AAACL,IAAcK,OAAO,IAAI;gBAAuB;aAAE;QAAC,IACzF;YAAEC,SAAS;gBAAE,gBAAgB;YAAmB;YAAGC,QAAQ;QAAI;IAEnE;AACF,EAAC"}