{"version":3,"sources":["../../src/export/getExportCollection.ts"],"sourcesContent":["import type {\n  CollectionAfterChangeHook,\n  CollectionBeforeOperationHook,\n  CollectionConfig,\n  Config,\n} from 'payload'\n\nimport type { ExportConfig, ImportExportPluginConfig } from '../types.js'\nimport type { Export } from './createExport.js'\n\nimport { createExport } from './createExport.js'\nimport { getFields } from './getFields.js'\nimport { handleDownload } from './handleDownload.js'\nimport { handlePreview } from './handlePreview.js'\n\nexport const getExportCollection = ({\n  config,\n  exportConfig,\n  pluginConfig,\n}: {\n  config: Config\n  exportConfig?: ExportConfig\n  pluginConfig: ImportExportPluginConfig\n}): CollectionConfig => {\n  const beforeOperation: CollectionBeforeOperationHook[] = []\n  const afterChange: CollectionAfterChangeHook[] = []\n\n  // Extract export-specific settings\n  const disableDownload = exportConfig?.disableDownload ?? false\n  const disableSave = exportConfig?.disableSave ?? false\n  const disableJobsQueue = exportConfig?.disableJobsQueue ?? false\n  const batchSize = exportConfig?.batchSize ?? 100\n  const format = exportConfig?.format\n\n  const collection: CollectionConfig = {\n    slug: 'exports',\n    access: {\n      update: () => false,\n    },\n    admin: {\n      components: {\n        edit: {\n          SaveButton: '@payloadcms/plugin-import-export/rsc#ExportSaveButton',\n        },\n      },\n      custom: {\n        disableDownload,\n        disableSave,\n        format,\n      },\n      disableCopyToLocale: true,\n      group: false,\n      useAsTitle: 'name',\n    },\n    disableDuplicate: true,\n    endpoints: [\n      {\n        handler: (req) => handleDownload(req, pluginConfig.debug),\n        method: 'post',\n        path: '/download',\n      },\n      {\n        handler: handlePreview,\n        method: 'post',\n        path: '/export-preview',\n      },\n    ],\n    fields: getFields(config, { format }),\n    hooks: {\n      afterChange,\n      beforeOperation,\n    },\n    lockDocuments: false,\n    upload: {\n      filesRequiredOnCreate: false,\n      hideFileInputOnCreate: true,\n      hideRemoveFile: true,\n    },\n  }\n\n  if (disableJobsQueue) {\n    beforeOperation.push(async ({ args, collection: collectionConfig, operation, req }) => {\n      if (operation !== 'create') {\n        return\n      }\n      const { user } = req\n      const debug = pluginConfig.debug\n\n      await createExport({\n        ...(args.data as Export),\n        batchSize,\n        debug,\n        exportsCollection: collectionConfig.slug,\n        req,\n        userCollection: user?.collection || user?.user?.collection,\n        userID: user?.id || user?.user?.id,\n      })\n    })\n  } else {\n    afterChange.push(async ({ collection: collectionConfig, doc, operation, req }) => {\n      if (operation !== 'create') {\n        return\n      }\n\n      const { user } = req\n\n      const input: Export = {\n        ...doc,\n        batchSize,\n        exportsCollection: collectionConfig.slug,\n        userCollection: user?.collection || user?.user?.collection,\n        userID: user?.id || user?.user?.id,\n      }\n\n      await req.payload.jobs.queue({\n        input,\n        task: 'createCollectionExport',\n      })\n    })\n  }\n\n  return collection\n}\n"],"names":["createExport","getFields","handleDownload","handlePreview","getExportCollection","config","exportConfig","pluginConfig","beforeOperation","afterChange","disableDownload","disableSave","disableJobsQueue","batchSize","format","collection","slug","access","update","admin","components","edit","SaveButton","custom","disableCopyToLocale","group","useAsTitle","disableDuplicate","endpoints","handler","req","debug","method","path","fields","hooks","lockDocuments","upload","filesRequiredOnCreate","hideFileInputOnCreate","hideRemoveFile","push","args","collectionConfig","operation","user","data","exportsCollection","userCollection","userID","id","doc","input","payload","jobs","queue","task"],"mappings":"AAUA,SAASA,YAAY,QAAQ,oBAAmB;AAChD,SAASC,SAAS,QAAQ,iBAAgB;AAC1C,SAASC,cAAc,QAAQ,sBAAqB;AACpD,SAASC,aAAa,QAAQ,qBAAoB;AAElD,OAAO,MAAMC,sBAAsB,CAAC,EAClCC,MAAM,EACNC,YAAY,EACZC,YAAY,EAKb;IACC,MAAMC,kBAAmD,EAAE;IAC3D,MAAMC,cAA2C,EAAE;IAEnD,mCAAmC;IACnC,MAAMC,kBAAkBJ,cAAcI,mBAAmB;IACzD,MAAMC,cAAcL,cAAcK,eAAe;IACjD,MAAMC,mBAAmBN,cAAcM,oBAAoB;IAC3D,MAAMC,YAAYP,cAAcO,aAAa;IAC7C,MAAMC,SAASR,cAAcQ;IAE7B,MAAMC,aAA+B;QACnCC,MAAM;QACNC,QAAQ;YACNC,QAAQ,IAAM;QAChB;QACAC,OAAO;YACLC,YAAY;gBACVC,MAAM;oBACJC,YAAY;gBACd;YACF;YACAC,QAAQ;gBACNb;gBACAC;gBACAG;YACF;YACAU,qBAAqB;YACrBC,OAAO;YACPC,YAAY;QACd;QACAC,kBAAkB;QAClBC,WAAW;YACT;gBACEC,SAAS,CAACC,MAAQ5B,eAAe4B,KAAKvB,aAAawB,KAAK;gBACxDC,QAAQ;gBACRC,MAAM;YACR;YACA;gBACEJ,SAAS1B;gBACT6B,QAAQ;gBACRC,MAAM;YACR;SACD;QACDC,QAAQjC,UAAUI,QAAQ;YAAES;QAAO;QACnCqB,OAAO;YACL1B;YACAD;QACF;QACA4B,eAAe;QACfC,QAAQ;YACNC,uBAAuB;YACvBC,uBAAuB;YACvBC,gBAAgB;QAClB;IACF;IAEA,IAAI5B,kBAAkB;QACpBJ,gBAAgBiC,IAAI,CAAC,OAAO,EAAEC,IAAI,EAAE3B,YAAY4B,gBAAgB,EAAEC,SAAS,EAAEd,GAAG,EAAE;YAChF,IAAIc,cAAc,UAAU;gBAC1B;YACF;YACA,MAAM,EAAEC,IAAI,EAAE,GAAGf;YACjB,MAAMC,QAAQxB,aAAawB,KAAK;YAEhC,MAAM/B,aAAa;gBACjB,GAAI0C,KAAKI,IAAI;gBACbjC;gBACAkB;gBACAgB,mBAAmBJ,iBAAiB3B,IAAI;gBACxCc;gBACAkB,gBAAgBH,MAAM9B,cAAc8B,MAAMA,MAAM9B;gBAChDkC,QAAQJ,MAAMK,MAAML,MAAMA,MAAMK;YAClC;QACF;IACF,OAAO;QACLzC,YAAYgC,IAAI,CAAC,OAAO,EAAE1B,YAAY4B,gBAAgB,EAAEQ,GAAG,EAAEP,SAAS,EAAEd,GAAG,EAAE;YAC3E,IAAIc,cAAc,UAAU;gBAC1B;YACF;YAEA,MAAM,EAAEC,IAAI,EAAE,GAAGf;YAEjB,MAAMsB,QAAgB;gBACpB,GAAGD,GAAG;gBACNtC;gBACAkC,mBAAmBJ,iBAAiB3B,IAAI;gBACxCgC,gBAAgBH,MAAM9B,cAAc8B,MAAMA,MAAM9B;gBAChDkC,QAAQJ,MAAMK,MAAML,MAAMA,MAAMK;YAClC;YAEA,MAAMpB,IAAIuB,OAAO,CAACC,IAAI,CAACC,KAAK,CAAC;gBAC3BH;gBACAI,MAAM;YACR;QACF;IACF;IAEA,OAAOzC;AACT,EAAC"}