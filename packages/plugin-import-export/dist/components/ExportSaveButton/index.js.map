{"version":3,"sources":["../../../src/components/ExportSaveButton/index.tsx"],"sourcesContent":["'use client'\n\nimport {\n  Button,\n  SaveButton,\n  toast,\n  Translation,\n  useConfig,\n  useForm,\n  useFormModified,\n  useTranslation,\n} from '@payloadcms/ui'\nimport { formatAdminURL } from 'payload/shared'\nimport React from 'react'\n\nimport type {\n  PluginImportExportTranslationKeys,\n  PluginImportExportTranslations,\n} from '../../translations/index.js'\n\nexport const ExportSaveButton: React.FC = () => {\n  const { t } = useTranslation<PluginImportExportTranslations, PluginImportExportTranslationKeys>()\n  const {\n    config: {\n      routes: { api },\n    },\n    getEntityConfig,\n  } = useConfig()\n\n  const { getData, setModified } = useForm()\n  const modified = useFormModified()\n\n  const exportsCollectionConfig = getEntityConfig({ collectionSlug: 'exports' })\n\n  const disableSave = exportsCollectionConfig?.admin?.custom?.disableSave === true\n\n  const disableDownload = exportsCollectionConfig?.admin?.custom?.disableDownload === true\n\n  const label = t('general:save')\n\n  const handleDownload = async () => {\n    let timeoutID: null | ReturnType<typeof setTimeout> = null\n    let toastID: null | number | string = null\n\n    try {\n      setModified(false) // Reset modified state\n      const data = getData()\n\n      // Set a timeout to show toast if the request takes longer than 200ms\n      timeoutID = setTimeout(() => {\n        toastID = toast.success('Your export is being processed...')\n      }, 200)\n\n      const response = await fetch(\n        formatAdminURL({\n          apiRoute: api,\n          path: '/exports/download',\n        }),\n        {\n          body: JSON.stringify({\n            data,\n          }),\n          credentials: 'include',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          method: 'POST',\n        },\n      )\n\n      // Clear the timeout if fetch completes quickly\n      if (timeoutID) {\n        clearTimeout(timeoutID)\n      }\n\n      // Dismiss the toast if it was shown\n      if (toastID) {\n        toast.dismiss(toastID)\n      }\n\n      if (!response.ok) {\n        // Try to parse the error message from the JSON response\n        let errorMsg = 'Failed to download file'\n        try {\n          const errorJson = await response.json()\n          if (errorJson?.errors?.[0]?.message) {\n            errorMsg = errorJson.errors[0].message\n          }\n        } catch {\n          // Ignore JSON parse errors, fallback to generic message\n        }\n        throw new Error(errorMsg)\n      }\n\n      const fileStream = response.body\n      const reader = fileStream?.getReader()\n      const decoder = new TextDecoder()\n      let result = ''\n\n      while (reader) {\n        const { done, value } = await reader.read()\n        if (done) {\n          break\n        }\n        result += decoder.decode(value, { stream: true })\n      }\n\n      const blob = new Blob([result], { type: 'text/plain' })\n      const url = URL.createObjectURL(blob)\n      const a = document.createElement('a')\n      a.href = url\n      a.download = `${data.name}.${data.format}`\n      document.body.appendChild(a)\n      a.click()\n      document.body.removeChild(a)\n      URL.revokeObjectURL(url)\n    } catch (error: any) {\n      toast.error(error.message || 'Error downloading file')\n    }\n  }\n\n  return (\n    <React.Fragment>\n      {!disableSave && <SaveButton label={label} />}\n      {!disableDownload && (\n        <Button disabled={!modified} onClick={handleDownload} size=\"medium\" type=\"button\">\n          <Translation i18nKey=\"upload:download\" t={t} />\n        </Button>\n      )}\n    </React.Fragment>\n  )\n}\n"],"names":["Button","SaveButton","toast","Translation","useConfig","useForm","useFormModified","useTranslation","formatAdminURL","React","ExportSaveButton","t","config","routes","api","getEntityConfig","getData","setModified","modified","exportsCollectionConfig","collectionSlug","disableSave","admin","custom","disableDownload","label","handleDownload","timeoutID","toastID","data","setTimeout","success","response","fetch","apiRoute","path","body","JSON","stringify","credentials","headers","method","clearTimeout","dismiss","ok","errorMsg","errorJson","json","errors","message","Error","fileStream","reader","getReader","decoder","TextDecoder","result","done","value","read","decode","stream","blob","Blob","type","url","URL","createObjectURL","a","document","createElement","href","download","name","format","appendChild","click","removeChild","revokeObjectURL","error","Fragment","disabled","onClick","size","i18nKey"],"mappings":"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"}