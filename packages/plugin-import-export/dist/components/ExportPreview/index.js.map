{"version":3,"sources":["../../../src/components/ExportPreview/index.tsx"],"sourcesContent":["'use client'\nimport type { Column } from '@payloadcms/ui'\nimport type { ClientField, PaginatedDocs, Where } from 'payload'\n\nimport { getTranslation } from '@payloadcms/translations'\nimport {\n  CodeEditorLazy,\n  Pagination,\n  PerPage,\n  Table,\n  Translation,\n  useConfig,\n  useDebouncedEffect,\n  useDocumentInfo,\n  useFormFields,\n  useTranslation,\n} from '@payloadcms/ui'\nimport React, { useEffect, useRef, useState, useTransition } from 'react'\n\nimport type {\n  PluginImportExportTranslationKeys,\n  PluginImportExportTranslations,\n} from '../../translations/index.js'\nimport type { ExportPreviewResponse } from '../../types.js'\n\nimport { DEFAULT_PREVIEW_LIMIT, PREVIEW_LIMIT_OPTIONS } from '../../constants.js'\nimport './index.scss'\nimport { useImportExport } from '../ImportExportProvider/index.js'\n\nconst baseClass = 'export-preview'\n\nexport const ExportPreview: React.FC = () => {\n  const [isPending, startTransition] = useTransition()\n  const { collection } = useImportExport()\n  const {\n    config,\n    config: { routes },\n  } = useConfig()\n  const { collectionSlug } = useDocumentInfo()\n  const { draft, fields, format, limit, locale, sort, where } = useFormFields(([fields]) => {\n    return {\n      draft: fields['drafts']?.value,\n      fields: fields['fields']?.value,\n      format: fields['format']?.value,\n      limit: fields['limit']?.value as number,\n      locale: fields['locale']?.value as string,\n      sort: fields['sort']?.value as string,\n      where: fields['where']?.value as Where,\n    }\n  })\n  const [dataToRender, setDataToRender] = useState<any[]>([])\n  const [exportTotalDocs, setExportTotalDocs] = useState<number>(0)\n  const [columns, setColumns] = useState<Column[]>([])\n  const { i18n, t } = useTranslation<\n    PluginImportExportTranslations,\n    PluginImportExportTranslationKeys\n  >()\n\n  // Preview pagination state (separate from export config)\n  const [previewPage, setPreviewPage] = useState(1)\n  const [previewLimit, setPreviewLimit] = useState(DEFAULT_PREVIEW_LIMIT)\n  const [paginationData, setPaginationData] = useState<null | Pick<\n    PaginatedDocs,\n    'hasNextPage' | 'hasPrevPage' | 'limit' | 'nextPage' | 'page' | 'prevPage' | 'totalPages'\n  >>(null)\n\n  // Track previous export config to reset preview page when it changes\n  const prevExportConfigRef = useRef({ draft, fields, format, limit, locale, sort, where })\n\n  // Reset preview page when export config changes\n  useEffect(() => {\n    const prevConfig = prevExportConfigRef.current\n    const configChanged =\n      prevConfig.draft !== draft ||\n      prevConfig.limit !== limit ||\n      prevConfig.locale !== locale ||\n      prevConfig.sort !== sort ||\n      JSON.stringify(prevConfig.fields) !== JSON.stringify(fields) ||\n      JSON.stringify(prevConfig.where) !== JSON.stringify(where)\n\n    if (configChanged) {\n      setPreviewPage(1)\n      prevExportConfigRef.current = { draft, fields, format, limit, locale, sort, where }\n    }\n  }, [draft, fields, format, limit, locale, sort, where])\n\n  const targetCollectionSlug = typeof collection === 'string' && collection\n\n  const isCSV = format === 'csv'\n\n  useDebouncedEffect(\n    () => {\n      if (!collectionSlug || !targetCollectionSlug) {\n        return\n      }\n\n      const abortController = new AbortController()\n\n      const fetchData = async () => {\n        try {\n          const res = await fetch(`${routes.api}/${collectionSlug}/export-preview`, {\n            body: JSON.stringify({\n              collectionSlug: targetCollectionSlug,\n              draft,\n              fields,\n              format,\n              limit,\n              locale,\n              previewLimit,\n              previewPage,\n              sort,\n              where,\n            }),\n            credentials: 'include',\n            headers: { 'Content-Type': 'application/json' },\n            method: 'POST',\n            signal: abortController.signal,\n          })\n\n          if (!res.ok) {\n            return\n          }\n\n          const {\n            columns: serverColumns,\n            docs,\n            exportTotalDocs: serverExportTotalDocs,\n            hasNextPage,\n            hasPrevPage,\n            limit: responseLimit,\n            page: responsePage,\n            totalPages,\n          }: ExportPreviewResponse = await res.json()\n\n          // For CSV: use server-provided columns (from getSchemaColumns) for consistent ordering\n          // For JSON: derive keys from docs\n          const allKeys = Array.from(new Set(docs.flatMap((doc) => Object.keys(doc))))\n\n          // Use server columns if available (CSV format), otherwise fall back to data-derived keys\n          const fieldKeys = serverColumns && serverColumns.length > 0 ? serverColumns : allKeys\n\n          // Build columns based on field keys\n          const newColumns: Column[] = fieldKeys.map((key) => ({\n            accessor: key,\n            active: true,\n            field: { name: key } as ClientField,\n            Heading: getTranslation(key, i18n),\n            renderedCells: docs.map((doc: Record<string, unknown>) => {\n              const val = doc[key]\n\n              if (val === undefined || val === null) {\n                return null\n              }\n\n              // Avoid ESLint warning by type-checking before calling String()\n              if (typeof val === 'string' || typeof val === 'number' || typeof val === 'boolean') {\n                return String(val)\n              }\n\n              if (Array.isArray(val)) {\n                return val.map(String).join(', ')\n              }\n\n              return JSON.stringify(val)\n            }),\n          }))\n\n          setExportTotalDocs(serverExportTotalDocs)\n          setPaginationData({\n            hasNextPage,\n            hasPrevPage,\n            limit: responseLimit,\n            nextPage: responsePage + 1,\n            page: responsePage,\n            prevPage: responsePage - 1,\n            totalPages,\n          })\n          setColumns(newColumns)\n          setDataToRender(docs)\n        } catch (error) {\n          console.error('Error fetching preview data:', error)\n        }\n      }\n\n      startTransition(async () => await fetchData())\n\n      return () => {\n        if (!abortController.signal.aborted) {\n          abortController.abort('Component unmounted')\n        }\n      }\n    },\n    [\n      collectionSlug,\n      draft,\n      fields,\n      format,\n      i18n,\n      limit,\n      locale,\n      previewLimit,\n      previewPage,\n      sort,\n      where,\n      routes.api,\n      targetCollectionSlug,\n    ],\n    500,\n  )\n\n  const handlePageChange = (page: number) => {\n    setPreviewPage(page)\n  }\n\n  const handlePerPageChange = (newLimit: number) => {\n    setPreviewLimit(newLimit)\n    setPreviewPage(1)\n  }\n\n  return (\n    <div className={baseClass}>\n      <div className={`${baseClass}__header`}>\n        <h3>\n          <Translation i18nKey=\"version:preview\" t={t} />\n        </h3>\n        {exportTotalDocs > 0 && !isPending && (\n          <span className={`${baseClass}__export-count`}>\n            <Translation\n              // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n              // @ts-expect-error\n              i18nKey=\"plugin-import-export:documentsToExport\"\n              t={t}\n              variables={{\n                count: exportTotalDocs,\n              }}\n            />\n          </span>\n        )}\n      </div>\n      {isPending && !dataToRender && (\n        <div className={`${baseClass}__loading`}>\n          <Translation i18nKey=\"general:loading\" t={t} />\n        </div>\n      )}\n      {dataToRender &&\n        (isCSV ? (\n          <Table columns={columns} data={dataToRender} />\n        ) : (\n          <CodeEditorLazy language=\"json\" readOnly value={JSON.stringify(dataToRender, null, 2)} />\n        ))}\n      {paginationData && exportTotalDocs > 0 && (\n        <div className={`${baseClass}__pagination`}>\n          {paginationData.totalPages > 1 && (\n            <Pagination\n              hasNextPage={paginationData.hasNextPage}\n              hasPrevPage={paginationData.hasPrevPage}\n              nextPage={paginationData.nextPage ?? undefined}\n              numberOfNeighbors={1}\n              onChange={handlePageChange}\n              page={paginationData.page}\n              prevPage={paginationData.prevPage ?? undefined}\n              totalPages={paginationData.totalPages}\n            />\n          )}\n          <span className={`${baseClass}__page-info`}>\n            <Translation\n              // @ts-expect-error - plugin translations not typed\n              i18nKey=\"plugin-import-export:previewPageInfo\"\n              t={t}\n              variables={{\n                end: Math.min((paginationData.page ?? 1) * previewLimit, exportTotalDocs),\n                start: ((paginationData.page ?? 1) - 1) * previewLimit + 1,\n                total: exportTotalDocs,\n              }}\n            />\n          </span>\n          <PerPage\n            handleChange={handlePerPageChange}\n            limit={previewLimit}\n            limits={PREVIEW_LIMIT_OPTIONS}\n          />\n        </div>\n      )}\n    </div>\n  )\n}\n"],"names":["getTranslation","CodeEditorLazy","Pagination","PerPage","Table","Translation","useConfig","useDebouncedEffect","useDocumentInfo","useFormFields","useTranslation","React","useEffect","useRef","useState","useTransition","DEFAULT_PREVIEW_LIMIT","PREVIEW_LIMIT_OPTIONS","useImportExport","baseClass","ExportPreview","isPending","startTransition","collection","config","routes","collectionSlug","draft","fields","format","limit","locale","sort","where","value","dataToRender","setDataToRender","exportTotalDocs","setExportTotalDocs","columns","setColumns","i18n","t","previewPage","setPreviewPage","previewLimit","setPreviewLimit","paginationData","setPaginationData","prevExportConfigRef","prevConfig","current","configChanged","JSON","stringify","targetCollectionSlug","isCSV","abortController","AbortController","fetchData","res","fetch","api","body","credentials","headers","method","signal","ok","serverColumns","docs","serverExportTotalDocs","hasNextPage","hasPrevPage","responseLimit","page","responsePage","totalPages","json","allKeys","Array","from","Set","flatMap","doc","Object","keys","fieldKeys","length","newColumns","map","key","accessor","active","field","name","Heading","renderedCells","val","undefined","String","isArray","join","nextPage","prevPage","error","console","aborted","abort","handlePageChange","handlePerPageChange","newLimit","div","className","h3","i18nKey","span","variables","count","data","language","readOnly","numberOfNeighbors","onChange","end","Math","min","start","total","handleChange","limits"],"mappings":"AAAA;;AAIA,SAASA,cAAc,QAAQ,2BAA0B;AACzD,SACEC,cAAc,EACdC,UAAU,EACVC,OAAO,EACPC,KAAK,EACLC,WAAW,EACXC,SAAS,EACTC,kBAAkB,EAClBC,eAAe,EACfC,aAAa,EACbC,cAAc,QACT,iBAAgB;AACvB,OAAOC,SAASC,SAAS,EAAEC,MAAM,EAAEC,QAAQ,EAAEC,aAAa,QAAQ,QAAO;AAQzE,SAASC,qBAAqB,EAAEC,qBAAqB,QAAQ,qBAAoB;AACjF,OAAO,eAAc;AACrB,SAASC,eAAe,QAAQ,mCAAkC;AAElE,MAAMC,YAAY;AAElB,OAAO,MAAMC,gBAA0B;IACrC,MAAM,CAACC,WAAWC,gBAAgB,GAAGP;IACrC,MAAM,EAAEQ,UAAU,EAAE,GAAGL;IACvB,MAAM,EACJM,MAAM,EACNA,QAAQ,EAAEC,MAAM,EAAE,EACnB,GAAGnB;IACJ,MAAM,EAAEoB,cAAc,EAAE,GAAGlB;IAC3B,MAAM,EAAEmB,KAAK,EAAEC,MAAM,EAAEC,MAAM,EAAEC,KAAK,EAAEC,MAAM,EAAEC,IAAI,EAAEC,KAAK,EAAE,GAAGxB,cAAc,CAAC,CAACmB,OAAO;QACnF,OAAO;YACLD,OAAOC,MAAM,CAAC,SAAS,EAAEM;YACzBN,QAAQA,MAAM,CAAC,SAAS,EAAEM;YAC1BL,QAAQD,MAAM,CAAC,SAAS,EAAEM;YAC1BJ,OAAOF,MAAM,CAAC,QAAQ,EAAEM;YACxBH,QAAQH,MAAM,CAAC,SAAS,EAAEM;YAC1BF,MAAMJ,MAAM,CAAC,OAAO,EAAEM;YACtBD,OAAOL,MAAM,CAAC,QAAQ,EAAEM;QAC1B;IACF;IACA,MAAM,CAACC,cAAcC,gBAAgB,GAAGtB,SAAgB,EAAE;IAC1D,MAAM,CAACuB,iBAAiBC,mBAAmB,GAAGxB,SAAiB;IAC/D,MAAM,CAACyB,SAASC,WAAW,GAAG1B,SAAmB,EAAE;IACnD,MAAM,EAAE2B,IAAI,EAAEC,CAAC,EAAE,GAAGhC;IAKpB,yDAAyD;IACzD,MAAM,CAACiC,aAAaC,eAAe,GAAG9B,SAAS;IAC/C,MAAM,CAAC+B,cAAcC,gBAAgB,GAAGhC,SAASE;IACjD,MAAM,CAAC+B,gBAAgBC,kBAAkB,GAAGlC,SAGzC;IAEH,qEAAqE;IACrE,MAAMmC,sBAAsBpC,OAAO;QAAEc;QAAOC;QAAQC;QAAQC;QAAOC;QAAQC;QAAMC;IAAM;IAEvF,gDAAgD;IAChDrB,UAAU;QACR,MAAMsC,aAAaD,oBAAoBE,OAAO;QAC9C,MAAMC,gBACJF,WAAWvB,KAAK,KAAKA,SACrBuB,WAAWpB,KAAK,KAAKA,SACrBoB,WAAWnB,MAAM,KAAKA,UACtBmB,WAAWlB,IAAI,KAAKA,QACpBqB,KAAKC,SAAS,CAACJ,WAAWtB,MAAM,MAAMyB,KAAKC,SAAS,CAAC1B,WACrDyB,KAAKC,SAAS,CAACJ,WAAWjB,KAAK,MAAMoB,KAAKC,SAAS,CAACrB;QAEtD,IAAImB,eAAe;YACjBR,eAAe;YACfK,oBAAoBE,OAAO,GAAG;gBAAExB;gBAAOC;gBAAQC;gBAAQC;gBAAOC;gBAAQC;gBAAMC;YAAM;QACpF;IACF,GAAG;QAACN;QAAOC;QAAQC;QAAQC;QAAOC;QAAQC;QAAMC;KAAM;IAEtD,MAAMsB,uBAAuB,OAAOhC,eAAe,YAAYA;IAE/D,MAAMiC,QAAQ3B,WAAW;IAEzBtB,mBACE;QACE,IAAI,CAACmB,kBAAkB,CAAC6B,sBAAsB;YAC5C;QACF;QAEA,MAAME,kBAAkB,IAAIC;QAE5B,MAAMC,YAAY;YAChB,IAAI;gBACF,MAAMC,MAAM,MAAMC,MAAM,GAAGpC,OAAOqC,GAAG,CAAC,CAAC,EAAEpC,eAAe,eAAe,CAAC,EAAE;oBACxEqC,MAAMV,KAAKC,SAAS,CAAC;wBACnB5B,gBAAgB6B;wBAChB5B;wBACAC;wBACAC;wBACAC;wBACAC;wBACAc;wBACAF;wBACAX;wBACAC;oBACF;oBACA+B,aAAa;oBACbC,SAAS;wBAAE,gBAAgB;oBAAmB;oBAC9CC,QAAQ;oBACRC,QAAQV,gBAAgBU,MAAM;gBAChC;gBAEA,IAAI,CAACP,IAAIQ,EAAE,EAAE;oBACX;gBACF;gBAEA,MAAM,EACJ7B,SAAS8B,aAAa,EACtBC,IAAI,EACJjC,iBAAiBkC,qBAAqB,EACtCC,WAAW,EACXC,WAAW,EACX3C,OAAO4C,aAAa,EACpBC,MAAMC,YAAY,EAClBC,UAAU,EACX,GAA0B,MAAMjB,IAAIkB,IAAI;gBAEzC,uFAAuF;gBACvF,kCAAkC;gBAClC,MAAMC,UAAUC,MAAMC,IAAI,CAAC,IAAIC,IAAIZ,KAAKa,OAAO,CAAC,CAACC,MAAQC,OAAOC,IAAI,CAACF;gBAErE,yFAAyF;gBACzF,MAAMG,YAAYlB,iBAAiBA,cAAcmB,MAAM,GAAG,IAAInB,gBAAgBU;gBAE9E,oCAAoC;gBACpC,MAAMU,aAAuBF,UAAUG,GAAG,CAAC,CAACC,MAAS,CAAA;wBACnDC,UAAUD;wBACVE,QAAQ;wBACRC,OAAO;4BAAEC,MAAMJ;wBAAI;wBACnBK,SAAShG,eAAe2F,KAAKlD;wBAC7BwD,eAAe3B,KAAKoB,GAAG,CAAC,CAACN;4BACvB,MAAMc,MAAMd,GAAG,CAACO,IAAI;4BAEpB,IAAIO,QAAQC,aAAaD,QAAQ,MAAM;gCACrC,OAAO;4BACT;4BAEA,gEAAgE;4BAChE,IAAI,OAAOA,QAAQ,YAAY,OAAOA,QAAQ,YAAY,OAAOA,QAAQ,WAAW;gCAClF,OAAOE,OAAOF;4BAChB;4BAEA,IAAIlB,MAAMqB,OAAO,CAACH,MAAM;gCACtB,OAAOA,IAAIR,GAAG,CAACU,QAAQE,IAAI,CAAC;4BAC9B;4BAEA,OAAOjD,KAAKC,SAAS,CAAC4C;wBACxB;oBACF,CAAA;gBAEA5D,mBAAmBiC;gBACnBvB,kBAAkB;oBAChBwB;oBACAC;oBACA3C,OAAO4C;oBACP6B,UAAU3B,eAAe;oBACzBD,MAAMC;oBACN4B,UAAU5B,eAAe;oBACzBC;gBACF;gBACArC,WAAWiD;gBACXrD,gBAAgBkC;YAClB,EAAE,OAAOmC,OAAO;gBACdC,QAAQD,KAAK,CAAC,gCAAgCA;YAChD;QACF;QAEAnF,gBAAgB,UAAY,MAAMqC;QAElC,OAAO;YACL,IAAI,CAACF,gBAAgBU,MAAM,CAACwC,OAAO,EAAE;gBACnClD,gBAAgBmD,KAAK,CAAC;YACxB;QACF;IACF,GACA;QACElF;QACAC;QACAC;QACAC;QACAY;QACAX;QACAC;QACAc;QACAF;QACAX;QACAC;QACAR,OAAOqC,GAAG;QACVP;KACD,EACD;IAGF,MAAMsD,mBAAmB,CAAClC;QACxB/B,eAAe+B;IACjB;IAEA,MAAMmC,sBAAsB,CAACC;QAC3BjE,gBAAgBiE;QAChBnE,eAAe;IACjB;IAEA,qBACE,MAACoE;QAAIC,WAAW9F;;0BACd,MAAC6F;gBAAIC,WAAW,GAAG9F,UAAU,QAAQ,CAAC;;kCACpC,KAAC+F;kCACC,cAAA,KAAC7G;4BAAY8G,SAAQ;4BAAkBzE,GAAGA;;;oBAE3CL,kBAAkB,KAAK,CAAChB,2BACvB,KAAC+F;wBAAKH,WAAW,GAAG9F,UAAU,cAAc,CAAC;kCAC3C,cAAA,KAACd;4BACC,6DAA6D;4BAC7D,mBAAmB;4BACnB8G,SAAQ;4BACRzE,GAAGA;4BACH2E,WAAW;gCACTC,OAAOjF;4BACT;;;;;YAKPhB,aAAa,CAACc,8BACb,KAAC6E;gBAAIC,WAAW,GAAG9F,UAAU,SAAS,CAAC;0BACrC,cAAA,KAACd;oBAAY8G,SAAQ;oBAAkBzE,GAAGA;;;YAG7CP,gBACEqB,CAAAA,sBACC,KAACpD;gBAAMmC,SAASA;gBAASgF,MAAMpF;+BAE/B,KAAClC;gBAAeuH,UAAS;gBAAOC,QAAQ;gBAACvF,OAAOmB,KAAKC,SAAS,CAACnB,cAAc,MAAM;cACrF;YACDY,kBAAkBV,kBAAkB,mBACnC,MAAC2E;gBAAIC,WAAW,GAAG9F,UAAU,YAAY,CAAC;;oBACvC4B,eAAe8B,UAAU,GAAG,mBAC3B,KAAC3E;wBACCsE,aAAazB,eAAeyB,WAAW;wBACvCC,aAAa1B,eAAe0B,WAAW;wBACvC8B,UAAUxD,eAAewD,QAAQ,IAAIJ;wBACrCuB,mBAAmB;wBACnBC,UAAUd;wBACVlC,MAAM5B,eAAe4B,IAAI;wBACzB6B,UAAUzD,eAAeyD,QAAQ,IAAIL;wBACrCtB,YAAY9B,eAAe8B,UAAU;;kCAGzC,KAACuC;wBAAKH,WAAW,GAAG9F,UAAU,WAAW,CAAC;kCACxC,cAAA,KAACd;4BACC,mDAAmD;4BACnD8G,SAAQ;4BACRzE,GAAGA;4BACH2E,WAAW;gCACTO,KAAKC,KAAKC,GAAG,CAAC,AAAC/E,CAAAA,eAAe4B,IAAI,IAAI,CAAA,IAAK9B,cAAcR;gCACzD0F,OAAO,AAAC,CAAA,AAAChF,CAAAA,eAAe4B,IAAI,IAAI,CAAA,IAAK,CAAA,IAAK9B,eAAe;gCACzDmF,OAAO3F;4BACT;;;kCAGJ,KAAClC;wBACC8H,cAAcnB;wBACdhF,OAAOe;wBACPqF,QAAQjH;;;;;;AAMpB,EAAC"}