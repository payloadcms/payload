{"version":3,"sources":["../../../src/components/SortBy/index.tsx"],"sourcesContent":["'use client'\n\nimport type { SelectFieldClientComponent } from 'payload'\nimport type { ReactNode } from 'react'\n\nimport {\n  FieldLabel,\n  ReactSelect,\n  useConfig,\n  useDocumentInfo,\n  useField,\n  useListQuery,\n} from '@payloadcms/ui'\nimport React, { useEffect, useMemo, useRef, useState } from 'react'\n\nimport { applySortOrder, normalizeQueryParam, stripSortDash } from '../../utilities/sortHelpers.js'\nimport { reduceFields } from '../FieldsToExport/reduceFields.js'\nimport { useImportExport } from '../ImportExportProvider/index.js'\nimport './index.scss'\n\nconst baseClass = 'sort-by-fields'\n\nexport const SortBy: SelectFieldClientComponent = (props) => {\n  const { id } = useDocumentInfo()\n\n  // The \"sort\" text field that stores 'title' or '-title'\n  const { setValue: setSort, value: sortRaw } = useField<string>()\n\n  // Sibling order field ('asc' | 'desc') used when writing sort on change\n  const { value: sortOrder = 'asc' } = useField<string>({ path: 'sortOrder' })\n  // Needed so we can initialize sortOrder when SortOrder component is hidden\n  const { setValue: setSortOrder } = useField<'asc' | 'desc'>({ path: 'sortOrder' })\n\n  const { value: collectionSlug } = useField<string>({ path: 'collectionSlug' })\n  const { query } = useListQuery()\n  const { getEntityConfig } = useConfig()\n  const { collection } = useImportExport()\n\n  // ReactSelect's displayed option\n  const [displayedValue, setDisplayedValue] = useState<{\n    id: string\n    label: ReactNode\n    value: string\n  } | null>(null)\n\n  const collectionConfig = getEntityConfig({ collectionSlug: collectionSlug ?? collection })\n  const fieldOptions = useMemo(\n    () => reduceFields({ fields: collectionConfig?.fields }),\n    [collectionConfig?.fields],\n  )\n\n  // Normalize the stored value for display (strip the '-') and pick the option\n  useEffect(() => {\n    const clean = stripSortDash(sortRaw)\n    if (!clean) {\n      setDisplayedValue(null)\n      return\n    }\n\n    const option = fieldOptions.find((f) => f.value === clean)\n    if (option && (!displayedValue || displayedValue.value !== clean)) {\n      setDisplayedValue(option)\n    }\n  }, [sortRaw, fieldOptions, displayedValue])\n\n  // One-time init guard so clearing `sort` doesn't rehydrate from query again\n  const didInitRef = useRef(false)\n\n  // Sync the visible select from list-view query sort (preferred) or groupBy (fallback)\n  // and initialize both `sort` and `sortOrder` here as SortOrder may be hidden by admin.condition.\n  useEffect(() => {\n    if (didInitRef.current) {\n      return\n    }\n    if (id) {\n      didInitRef.current = true\n      return\n    }\n    if (typeof sortRaw === 'string' && sortRaw.length > 0) {\n      // Already initialized elsewhere\n      didInitRef.current = true\n      return\n    }\n\n    const qsSort = normalizeQueryParam(query?.sort)\n    const qsGroupBy = normalizeQueryParam(query?.groupBy)\n\n    const source = qsSort ?? qsGroupBy\n    if (!source) {\n      didInitRef.current = true\n      return\n    }\n\n    const isDesc = !!qsSort && qsSort.startsWith('-')\n    const base = stripSortDash(source)\n    const order: 'asc' | 'desc' = isDesc ? 'desc' : 'asc'\n\n    // Write BOTH fields so preview/export have the right values even if SortOrder is hidden\n    setSort(applySortOrder(base, order))\n    setSortOrder(order)\n\n    const option = fieldOptions.find((f) => f.value === base)\n    if (option) {\n      setDisplayedValue(option)\n    }\n\n    didInitRef.current = true\n  }, [id, query?.groupBy, query?.sort, sortRaw, fieldOptions, setSort, setSortOrder])\n\n  // When user selects a different field, store it with the current order applied\n  const onChange = (option: { id: string; label: ReactNode; value: string } | null) => {\n    if (!option) {\n      setSort('')\n      setDisplayedValue(null)\n    } else {\n      setDisplayedValue(option)\n      const next = applySortOrder(option.value, String(sortOrder) as 'asc' | 'desc')\n      setSort(next)\n    }\n  }\n\n  return (\n    <div className={baseClass}>\n      <FieldLabel label={props.field.label} path={props.path} />\n      <ReactSelect\n        className={baseClass}\n        disabled={props.readOnly}\n        getOptionValue={(option) => String(option.value)}\n        inputId={`field-${props.path.replace(/\\./g, '__')}`}\n        isClearable={true}\n        isSortable={true}\n        // @ts-expect-error react select option\n        onChange={onChange}\n        options={fieldOptions}\n        // @ts-expect-error react select\n        value={displayedValue}\n      />\n    </div>\n  )\n}\n"],"names":["FieldLabel","ReactSelect","useConfig","useDocumentInfo","useField","useListQuery","React","useEffect","useMemo","useRef","useState","applySortOrder","normalizeQueryParam","stripSortDash","reduceFields","useImportExport","baseClass","SortBy","props","id","setValue","setSort","value","sortRaw","sortOrder","path","setSortOrder","collectionSlug","query","getEntityConfig","collection","displayedValue","setDisplayedValue","collectionConfig","fieldOptions","fields","clean","option","find","f","didInitRef","current","length","qsSort","sort","qsGroupBy","groupBy","source","isDesc","startsWith","base","order","onChange","next","String","div","className","label","field","disabled","readOnly","getOptionValue","inputId","replace","isClearable","isSortable","options"],"mappings":"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"}