{"version":3,"sources":["../../src/utilities/getImportFieldFunctions.ts"],"sourcesContent":["import { type FlattenedField, traverseFields, type TraverseFieldsCallback } from 'payload'\n\nimport type { FromCSVFunction } from '../types.js'\n\ntype Args = {\n  fields: FlattenedField[]\n}\n\n/**\n * Gets custom fromCSV field functions for import.\n * These functions transform field values when unflattening CSV data for import.\n */\nexport const getImportFieldFunctions = ({ fields }: Args): Record<string, FromCSVFunction> => {\n  const result: Record<string, FromCSVFunction> = {}\n\n  const buildCustomFunctions: TraverseFieldsCallback = ({ field, parentRef, ref }) => {\n    // @ts-expect-error ref is untyped\n    ref.prefix = parentRef.prefix || ''\n    if (field.type === 'group' || field.type === 'tab') {\n      // @ts-expect-error ref is untyped\n      const parentPrefix = parentRef?.prefix ? `${parentRef.prefix}_` : ''\n      // @ts-expect-error ref is untyped\n      ref.prefix = `${parentPrefix}${field.name}_`\n    }\n\n    if (typeof field.custom?.['plugin-import-export']?.fromCSV === 'function') {\n      // @ts-expect-error ref is untyped\n      result[`${ref.prefix}${field.name}`] = field.custom['plugin-import-export']?.fromCSV\n    } else if (field.type === 'relationship' || field.type === 'upload') {\n      if (field.hasMany !== true) {\n        if (!Array.isArray(field.relationTo)) {\n          // monomorphic single relationship - simple ID to value conversion\n          // @ts-expect-error ref is untyped\n          result[`${ref.prefix}${field.name}`] = ({ value }) => {\n            // If it's already an object (from JSON import), return as-is\n            if (typeof value === 'object' && value !== null) {\n              return value\n            }\n            // Convert string/number ID to relationship value\n            return value\n          }\n        } else {\n          // polymorphic single relationship - needs special handling\n          // The CSV has field_id and field_relationTo columns\n          // We need to combine them back into { relationTo, value } format\n          // This is handled in unflattenObject, so we don't need a fromCSV here\n        }\n      } else {\n        if (!Array.isArray(field.relationTo)) {\n          // @ts-expect-error ref is untyped\n          result[`${ref.prefix}${field.name}`] = ({ value }) => {\n            // If it's already an array (from JSON import), return as-is\n            if (Array.isArray(value)) {\n              return value\n            }\n            // For CSV, this is handled by array unflattening in unflattenObject\n            return value\n          }\n        } else {\n          // polymorphic many relationships\n          // Similar to polymorphic single, handled in unflattenObject\n        }\n      }\n    } else if (field.type === 'number') {\n      // For hasMany number fields, preserve comma-separated strings for later processing\n      if (field.hasMany) {\n        // Don't convert - let unflattenObject handle comma-separated values\n        // @ts-expect-error ref is untyped\n        result[`${ref.prefix}${field.name}`] = ({ value }) => value\n      } else {\n        // Ensure single numbers are parsed correctly from CSV strings\n        // @ts-expect-error ref is untyped\n        result[`${ref.prefix}${field.name}`] = ({ value }) => {\n          if (typeof value === 'number') {\n            return value\n          }\n          if (typeof value === 'string') {\n            const parsed = parseFloat(value)\n            return isNaN(parsed) ? 0 : parsed\n          }\n          return value\n        }\n      }\n    } else if (field.type === 'checkbox') {\n      // Convert string boolean values to actual booleans\n      // @ts-expect-error ref is untyped\n      result[`${ref.prefix}${field.name}`] = ({ value }) => {\n        if (typeof value === 'boolean') {\n          return value\n        }\n        if (typeof value === 'string') {\n          return value.toLowerCase() === 'true' || value === '1'\n        }\n        return Boolean(value)\n      }\n    } else if (field.type === 'date') {\n      // Ensure dates are in proper format\n      // @ts-expect-error ref is untyped\n      result[`${ref.prefix}${field.name}`] = ({ value }) => {\n        if (!value) {\n          return value\n        }\n        // If it's already a valid date string, return as-is\n        if (typeof value === 'string' && !isNaN(Date.parse(value))) {\n          return value\n        }\n        // Try to parse and format\n        try {\n          const date = new Date(value as string)\n          return isNaN(date.getTime()) ? value : date.toISOString()\n        } catch {\n          return value\n        }\n      }\n    } else if (field.type === 'json' || field.type === 'richText') {\n      // Parse JSON strings back to objects (both json and richText fields)\n      // @ts-expect-error ref is untyped\n      result[`${ref.prefix}${field.name}`] = ({ value }) => {\n        if (typeof value === 'object') {\n          return value\n        }\n        if (typeof value === 'string') {\n          try {\n            return JSON.parse(value)\n          } catch {\n            return value\n          }\n        }\n        return value\n      }\n    }\n  }\n\n  traverseFields({ callback: buildCustomFunctions, fields })\n\n  return result\n}\n"],"names":["traverseFields","getImportFieldFunctions","fields","result","buildCustomFunctions","field","parentRef","ref","prefix","type","parentPrefix","name","custom","fromCSV","hasMany","Array","isArray","relationTo","value","parsed","parseFloat","isNaN","toLowerCase","Boolean","Date","parse","date","getTime","toISOString","JSON","callback"],"mappings":"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"}