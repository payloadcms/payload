{"version":3,"sources":["../../src/utilities/getExportFieldFunctions.ts"],"sourcesContent":["import { type FlattenedField, traverseFields, type TraverseFieldsCallback } from 'payload'\n\nimport type { ToCSVFunction } from '../types.js'\n\ntype Args = {\n  fields: FlattenedField[]\n}\n\n/**\n * Gets custom toCSV field functions for export.\n * These functions transform field values when flattening documents for CSV export.\n */\nexport const getExportFieldFunctions = ({ fields }: Args): Record<string, ToCSVFunction> => {\n  const result: Record<string, ToCSVFunction> = {}\n\n  const buildCustomFunctions: TraverseFieldsCallback = ({ field, parentRef, ref }) => {\n    // @ts-expect-error ref is untyped\n    ref.prefix = parentRef.prefix || ''\n    if (field.type === 'group' || field.type === 'tab') {\n      // @ts-expect-error ref is untyped\n      const parentPrefix = parentRef?.prefix ? `${parentRef.prefix}_` : ''\n      // @ts-expect-error ref is untyped\n      ref.prefix = `${parentPrefix}${field.name}_`\n    }\n\n    if (typeof field.custom?.['plugin-import-export']?.toCSV === 'function') {\n      // @ts-expect-error ref is untyped\n      result[`${ref.prefix}${field.name}`] = field.custom['plugin-import-export']?.toCSV\n    } else if (field.type === 'json' || field.type === 'richText') {\n      // Serialize JSON and richText fields as JSON strings in a single column\n      // This prevents them from being flattened into multiple columns\n      // @ts-expect-error ref is untyped\n      result[`${ref.prefix}${field.name}`] = ({ value }) => {\n        if (value === null || value === undefined) {\n          return value\n        }\n        if (typeof value === 'object') {\n          return JSON.stringify(value)\n        }\n        return value\n      }\n    } else if (field.type === 'relationship' || field.type === 'upload') {\n      if (field.hasMany !== true) {\n        if (!Array.isArray(field.relationTo)) {\n          // monomorphic single\n          // @ts-expect-error ref is untyped\n          result[`${ref.prefix}${field.name}`] = ({ value }) =>\n            typeof value === 'object' && value && 'id' in value ? value.id : value\n        } else {\n          // polymorphic single\n          // @ts-expect-error ref is untyped\n          result[`${ref.prefix}${field.name}`] = ({ data, value }) => {\n            if (value && typeof value === 'object' && 'relationTo' in value && 'value' in value) {\n              const relationTo = (value as { relationTo: string; value: { id: number | string } })\n                .relationTo\n              const relatedDoc = (value as { relationTo: string; value: { id: number | string } })\n                .value\n              if (relatedDoc && typeof relatedDoc === 'object') {\n                // @ts-expect-error ref is untyped\n                data[`${ref.prefix}${field.name}_id`] = relatedDoc.id\n                // @ts-expect-error ref is untyped\n                data[`${ref.prefix}${field.name}_relationTo`] = relationTo\n              }\n            }\n            return undefined // prevents further flattening\n          }\n        }\n      } else {\n        if (!Array.isArray(field.relationTo)) {\n          // monomorphic many\n          // @ts-expect-error ref is untyped\n          result[`${ref.prefix}${field.name}`] = ({\n            data,\n            value,\n          }: {\n            data: Record<string, unknown>\n            value: Array<number | Record<string, any> | string> | undefined\n          }) => {\n            if (Array.isArray(value)) {\n              value.forEach((val, i) => {\n                const id = typeof val === 'object' && val ? val.id : val\n                // @ts-expect-error ref is untyped\n                data[`${ref.prefix}${field.name}_${i}_id`] = id\n              })\n            }\n            return undefined // prevents further flattening\n          }\n        } else {\n          // polymorphic many\n          // @ts-expect-error ref is untyped\n          result[`${ref.prefix}${field.name}`] = ({\n            data,\n            value,\n          }: {\n            data: Record<string, unknown>\n            value: Array<Record<string, any>> | undefined\n          }) => {\n            if (Array.isArray(value)) {\n              value.forEach((val, i) => {\n                if (val && typeof val === 'object') {\n                  const relationTo = val.relationTo\n                  const relatedDoc = val.value\n                  if (relationTo && relatedDoc && typeof relatedDoc === 'object') {\n                    // @ts-expect-error ref is untyped\n                    data[`${ref.prefix}${field.name}_${i}_id`] = relatedDoc.id\n                    // @ts-expect-error ref is untyped\n                    data[`${ref.prefix}${field.name}_${i}_relationTo`] = relationTo\n                  }\n                }\n              })\n            }\n            return undefined\n          }\n        }\n      }\n    }\n  }\n\n  traverseFields({ callback: buildCustomFunctions, fields })\n\n  return result\n}\n"],"names":["traverseFields","getExportFieldFunctions","fields","result","buildCustomFunctions","field","parentRef","ref","prefix","type","parentPrefix","name","custom","toCSV","value","undefined","JSON","stringify","hasMany","Array","isArray","relationTo","id","data","relatedDoc","forEach","val","i","callback"],"mappings":"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"}