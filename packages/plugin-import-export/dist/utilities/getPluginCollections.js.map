{"version":3,"sources":["../../src/utilities/getPluginCollections.ts"],"sourcesContent":["import type { CollectionConfig, Config } from 'payload'\n\nimport type { ExportConfig, ImportConfig, ImportExportPluginConfig } from '../types.js'\n\nimport { getExportCollection } from '../export/getExportCollection.js'\nimport { getImportCollection } from '../import/getImportCollection.js'\n\nexport type PluginCollectionsResult = {\n  /**\n   * Map from target collection slug to the export collection slug to use for it.\n   * Only contains entries for collections with custom export collection overrides.\n   */\n  customExportSlugMap: Map<string, string>\n  /**\n   * Map from target collection slug to the import collection slug to use for it.\n   * Only contains entries for collections with custom import collection overrides.\n   */\n  customImportSlugMap: Map<string, string>\n  /**\n   * All export collections (base + any per-collection overrides)\n   */\n  exportCollections: CollectionConfig[]\n  /**\n   * All import collections (base + any per-collection overrides)\n   */\n  importCollections: CollectionConfig[]\n}\n\n/**\n * Processes the plugin config and returns export/import collections.\n *\n * - Creates the base export and import collections\n * - Applies top-level overrideExportCollection/overrideImportCollection if provided\n * - For each collection in `pluginConfig.collections` that has a function override\n *   for `export` or `import`, applies the override to create customized collections\n *\n * @param config - The Payload config\n * @param pluginConfig - The import/export plugin config\n * @returns Object containing arrays of export and import collections\n */\nexport const getPluginCollections = async ({\n  config,\n  pluginConfig,\n}: {\n  config: Config\n  pluginConfig: ImportExportPluginConfig\n}): Promise<PluginCollectionsResult> => {\n  // Get the base export and import collections with default configs (no per-collection settings)\n  let baseExportCollection = getExportCollection({\n    config,\n    pluginConfig,\n  })\n  let baseImportCollection = getImportCollection({\n    config,\n    pluginConfig,\n  })\n\n  // Apply top-level collection overrides if provided\n  if (\n    pluginConfig.overrideExportCollection &&\n    typeof pluginConfig.overrideExportCollection === 'function'\n  ) {\n    baseExportCollection = await pluginConfig.overrideExportCollection({\n      collection: baseExportCollection,\n    })\n  }\n\n  if (\n    pluginConfig.overrideImportCollection &&\n    typeof pluginConfig.overrideImportCollection === 'function'\n  ) {\n    baseImportCollection = await pluginConfig.overrideImportCollection({\n      collection: baseImportCollection,\n    })\n  }\n\n  const exportCollections: CollectionConfig[] = []\n  const importCollections: CollectionConfig[] = []\n\n  // Maps from target collection slug to the export/import collection slug to use\n  const customExportSlugMap = new Map<string, string>()\n  const customImportSlugMap = new Map<string, string>()\n\n  // Process each collection config for custom collection overrides\n  if (pluginConfig.collections && pluginConfig.collections.length > 0) {\n    for (const collectionConfig of pluginConfig.collections) {\n      // Handle export config - only process if overrideCollection is provided\n      // Settings like disableJobsQueue require a custom slug to work properly\n      const exportConfig =\n        typeof collectionConfig.export === 'object' ? collectionConfig.export : undefined\n      if (exportConfig?.overrideCollection) {\n        // Generate a collection with this export config's settings (like disableJobsQueue)\n        const collectionWithSettings = getExportCollection({\n          config,\n          exportConfig,\n          pluginConfig,\n        })\n\n        const customExport = await exportConfig.overrideCollection({\n          collection: collectionWithSettings,\n        })\n\n        // If the slug changed, this is a separate collection; otherwise it modifies the base\n        if (customExport.slug !== baseExportCollection.slug) {\n          exportCollections.push(customExport)\n          // Map this target collection to its custom export collection\n          customExportSlugMap.set(collectionConfig.slug, customExport.slug)\n        } else {\n          // Full override - replace the base\n          baseExportCollection = customExport\n        }\n      }\n\n      // Handle import config - only process if overrideCollection is provided\n      // Settings like disableJobsQueue require a custom slug to work properly\n      const importConf =\n        typeof collectionConfig.import === 'object' ? collectionConfig.import : undefined\n      if (importConf?.overrideCollection) {\n        // Generate a collection with this import config's settings (like disableJobsQueue)\n        const collectionWithSettings = getImportCollection({\n          config,\n          importConfig: importConf,\n          pluginConfig,\n        })\n\n        const customImport = await importConf.overrideCollection({\n          collection: collectionWithSettings,\n        })\n\n        // If the slug changed, this is a separate collection; otherwise it modifies the base\n        if (customImport.slug !== baseImportCollection.slug) {\n          importCollections.push(customImport)\n          // Map this target collection to its custom import collection\n          customImportSlugMap.set(collectionConfig.slug, customImport.slug)\n        } else {\n          // Full override - replace the base\n          baseImportCollection = customImport\n        }\n      }\n    }\n  }\n\n  // Add base collections to the front of the arrays\n  exportCollections.unshift(baseExportCollection)\n  importCollections.unshift(baseImportCollection)\n\n  return {\n    customExportSlugMap,\n    customImportSlugMap,\n    exportCollections,\n    importCollections,\n  }\n}\n"],"names":["getExportCollection","getImportCollection","getPluginCollections","config","pluginConfig","baseExportCollection","baseImportCollection","overrideExportCollection","collection","overrideImportCollection","exportCollections","importCollections","customExportSlugMap","Map","customImportSlugMap","collections","length","collectionConfig","exportConfig","export","undefined","overrideCollection","collectionWithSettings","customExport","slug","push","set","importConf","import","importConfig","customImport","unshift"],"mappings":"AAIA,SAASA,mBAAmB,QAAQ,mCAAkC;AACtE,SAASC,mBAAmB,QAAQ,mCAAkC;AAuBtE;;;;;;;;;;;CAWC,GACD,OAAO,MAAMC,uBAAuB,OAAO,EACzCC,MAAM,EACNC,YAAY,EAIb;IACC,+FAA+F;IAC/F,IAAIC,uBAAuBL,oBAAoB;QAC7CG;QACAC;IACF;IACA,IAAIE,uBAAuBL,oBAAoB;QAC7CE;QACAC;IACF;IAEA,mDAAmD;IACnD,IACEA,aAAaG,wBAAwB,IACrC,OAAOH,aAAaG,wBAAwB,KAAK,YACjD;QACAF,uBAAuB,MAAMD,aAAaG,wBAAwB,CAAC;YACjEC,YAAYH;QACd;IACF;IAEA,IACED,aAAaK,wBAAwB,IACrC,OAAOL,aAAaK,wBAAwB,KAAK,YACjD;QACAH,uBAAuB,MAAMF,aAAaK,wBAAwB,CAAC;YACjED,YAAYF;QACd;IACF;IAEA,MAAMI,oBAAwC,EAAE;IAChD,MAAMC,oBAAwC,EAAE;IAEhD,+EAA+E;IAC/E,MAAMC,sBAAsB,IAAIC;IAChC,MAAMC,sBAAsB,IAAID;IAEhC,iEAAiE;IACjE,IAAIT,aAAaW,WAAW,IAAIX,aAAaW,WAAW,CAACC,MAAM,GAAG,GAAG;QACnE,KAAK,MAAMC,oBAAoBb,aAAaW,WAAW,CAAE;YACvD,wEAAwE;YACxE,wEAAwE;YACxE,MAAMG,eACJ,OAAOD,iBAAiBE,MAAM,KAAK,WAAWF,iBAAiBE,MAAM,GAAGC;YAC1E,IAAIF,cAAcG,oBAAoB;gBACpC,mFAAmF;gBACnF,MAAMC,yBAAyBtB,oBAAoB;oBACjDG;oBACAe;oBACAd;gBACF;gBAEA,MAAMmB,eAAe,MAAML,aAAaG,kBAAkB,CAAC;oBACzDb,YAAYc;gBACd;gBAEA,qFAAqF;gBACrF,IAAIC,aAAaC,IAAI,KAAKnB,qBAAqBmB,IAAI,EAAE;oBACnDd,kBAAkBe,IAAI,CAACF;oBACvB,6DAA6D;oBAC7DX,oBAAoBc,GAAG,CAACT,iBAAiBO,IAAI,EAAED,aAAaC,IAAI;gBAClE,OAAO;oBACL,mCAAmC;oBACnCnB,uBAAuBkB;gBACzB;YACF;YAEA,wEAAwE;YACxE,wEAAwE;YACxE,MAAMI,aACJ,OAAOV,iBAAiBW,MAAM,KAAK,WAAWX,iBAAiBW,MAAM,GAAGR;YAC1E,IAAIO,YAAYN,oBAAoB;gBAClC,mFAAmF;gBACnF,MAAMC,yBAAyBrB,oBAAoB;oBACjDE;oBACA0B,cAAcF;oBACdvB;gBACF;gBAEA,MAAM0B,eAAe,MAAMH,WAAWN,kBAAkB,CAAC;oBACvDb,YAAYc;gBACd;gBAEA,qFAAqF;gBACrF,IAAIQ,aAAaN,IAAI,KAAKlB,qBAAqBkB,IAAI,EAAE;oBACnDb,kBAAkBc,IAAI,CAACK;oBACvB,6DAA6D;oBAC7DhB,oBAAoBY,GAAG,CAACT,iBAAiBO,IAAI,EAAEM,aAAaN,IAAI;gBAClE,OAAO;oBACL,mCAAmC;oBACnClB,uBAAuBwB;gBACzB;YACF;QACF;IACF;IAEA,kDAAkD;IAClDpB,kBAAkBqB,OAAO,CAAC1B;IAC1BM,kBAAkBoB,OAAO,CAACzB;IAE1B,OAAO;QACLM;QACAE;QACAJ;QACAC;IACF;AACF,EAAC"}