{"version":3,"sources":["../../src/utilities/getFlattenedFieldKeys.ts"],"sourcesContent":["import { type FlattenedField } from 'payload'\n\ntype FieldWithPresentational =\n  | {\n      fields?: FlattenedField[]\n      name?: string\n      tabs?: {\n        fields: FlattenedField[]\n        name?: string\n      }[]\n      type: 'collapsible' | 'row' | 'tabs'\n    }\n  | FlattenedField\n\nexport type GetFlattenedFieldKeysOptions = {\n  /**\n   * When provided, localized fields will be expanded to include locale suffixes.\n   * e.g., 'title' (localized) -> ['title_en', 'title_es']\n   */\n  localeCodes?: string[]\n}\n\n/**\n * Recursively traverses fields and generates flattened CSV column keys.\n * This is schema-based - it derives columns from field definitions, not data.\n */\nexport const getFlattenedFieldKeys = (\n  fields: FieldWithPresentational[],\n  prefix = '',\n  options: GetFlattenedFieldKeysOptions = {},\n): string[] => {\n  const { localeCodes } = options\n  const keys: string[] = []\n\n  fields.forEach((field) => {\n    // Skip disabled fields\n    const isDisabled =\n      'custom' in field &&\n      typeof field.custom === 'object' &&\n      field.custom?.['plugin-import-export']?.disabled === true\n\n    if (isDisabled) {\n      return\n    }\n\n    const name = 'name' in field && typeof field.name === 'string' ? field.name : undefined\n    const fullKey = name && prefix ? `${prefix}_${name}` : (name ?? prefix)\n\n    // Check if field is localized\n    const isLocalized = 'localized' in field && field.localized === true\n\n    // Helper to add keys with locale expansion if needed\n    const addKey = (key: string, fieldIsLocalized: boolean) => {\n      if (fieldIsLocalized && localeCodes && localeCodes.length > 0) {\n        // Expand to locale-specific keys\n        for (const locale of localeCodes) {\n          keys.push(`${key}_${locale}`)\n        }\n      } else {\n        keys.push(key)\n      }\n    }\n\n    switch (field.type) {\n      case 'array': {\n        const subKeys = getFlattenedFieldKeys(\n          field.fields as FlattenedField[],\n          `${fullKey}_0`,\n          options,\n        )\n        keys.push(...subKeys)\n        break\n      }\n      case 'blocks': {\n        field.blocks.forEach((block) => {\n          if (typeof block === 'string') {\n            return // Skip block references\n          }\n          const blockPrefix = `${fullKey}_0_${block.slug}`\n          keys.push(`${blockPrefix}_blockType`)\n          keys.push(`${blockPrefix}_id`)\n          keys.push(\n            ...getFlattenedFieldKeys(block.flattenedFields ?? block.fields, blockPrefix, options),\n          )\n        })\n        break\n      }\n      case 'collapsible':\n      case 'group':\n      case 'row':\n        keys.push(...getFlattenedFieldKeys(field.fields as FlattenedField[], fullKey, options))\n        break\n      case 'relationship':\n      case 'upload':\n        if (field.hasMany) {\n          if (Array.isArray(field.relationTo)) {\n            // hasMany polymorphic\n            keys.push(`${fullKey}_0_relationTo`, `${fullKey}_0_id`)\n          } else {\n            // hasMany monomorphic\n            keys.push(`${fullKey}_0`)\n          }\n        } else {\n          if (Array.isArray(field.relationTo)) {\n            // hasOne polymorphic\n            keys.push(`${fullKey}_relationTo`, `${fullKey}_id`)\n          } else {\n            // hasOne monomorphic\n            addKey(fullKey, isLocalized)\n          }\n        }\n        break\n      case 'tabs':\n        field.tabs?.forEach((tab) => {\n          const tabPrefix = tab.name ? `${fullKey}_${tab.name}` : fullKey\n          keys.push(...getFlattenedFieldKeys(tab.fields || [], tabPrefix, options))\n        })\n        break\n      default:\n        if (!name) {\n          break\n        }\n        if ('hasMany' in field && field.hasMany) {\n          // Push placeholder for first index\n          keys.push(`${fullKey}_0`)\n        } else {\n          addKey(fullKey, isLocalized)\n        }\n        break\n    }\n  })\n\n  return keys\n}\n"],"names":["getFlattenedFieldKeys","fields","prefix","options","localeCodes","keys","forEach","field","isDisabled","custom","disabled","name","undefined","fullKey","isLocalized","localized","addKey","key","fieldIsLocalized","length","locale","push","type","subKeys","blocks","block","blockPrefix","slug","flattenedFields","hasMany","Array","isArray","relationTo","tabs","tab","tabPrefix"],"mappings":"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"}