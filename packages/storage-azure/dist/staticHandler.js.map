{"version":3,"sources":["../src/staticHandler.ts"],"sourcesContent":["import type { ContainerClient } from '@azure/storage-blob'\nimport type { StaticHandler } from '@payloadcms/plugin-cloud-storage/types'\nimport type { CollectionConfig } from 'payload'\n\nimport { RestError } from '@azure/storage-blob'\nimport { getFilePrefix } from '@payloadcms/plugin-cloud-storage/utilities'\nimport path from 'path'\nimport { getRangeRequestInfo } from 'payload/internal'\n\ninterface Args {\n  collection: CollectionConfig\n  getStorageClient: () => ContainerClient\n}\n\nexport const getHandler = ({ collection, getStorageClient }: Args): StaticHandler => {\n  return async (req, { headers: incomingHeaders, params: { clientUploadContext, filename } }) => {\n    try {\n      const prefix = await getFilePrefix({ clientUploadContext, collection, filename, req })\n      const blockBlobClient = getStorageClient().getBlockBlobClient(\n        path.posix.join(prefix, filename),\n      )\n\n      // Get file size for range validation\n      const properties = await blockBlobClient.getProperties()\n      const fileSize = properties.contentLength\n\n      if (!fileSize) {\n        return new Response('Internal Server Error', { status: 500 })\n      }\n\n      // Handle range request\n      const rangeHeader = req.headers.get('range')\n      const rangeResult = getRangeRequestInfo({ fileSize, rangeHeader })\n\n      if (rangeResult.type === 'invalid') {\n        return new Response(null, {\n          headers: new Headers(rangeResult.headers),\n          status: rangeResult.status,\n        })\n      }\n\n      // Download with range if partial\n      const blob =\n        rangeResult.type === 'partial'\n          ? await blockBlobClient.download(\n              rangeResult.rangeStart,\n              rangeResult.rangeEnd - rangeResult.rangeStart + 1,\n            )\n          : await blockBlobClient.download()\n\n      let headers = new Headers(incomingHeaders)\n\n      // Add range-related headers from the result\n      for (const [key, value] of Object.entries(rangeResult.headers)) {\n        headers.append(key, value)\n      }\n\n      // Add Azure-specific headers\n      headers.append('Content-Type', String(properties.contentType))\n      if (properties.etag) {\n        headers.append('ETag', String(properties.etag))\n      }\n\n      const etagFromHeaders = req.headers.get('etag') || req.headers.get('if-none-match')\n\n      if (\n        collection.upload &&\n        typeof collection.upload === 'object' &&\n        typeof collection.upload.modifyResponseHeaders === 'function'\n      ) {\n        headers = collection.upload.modifyResponseHeaders({ headers }) || headers\n      }\n\n      if (etagFromHeaders && etagFromHeaders === properties.etag) {\n        return new Response(null, {\n          headers,\n          status: 304,\n        })\n      }\n\n      // Manually create a ReadableStream for the web from a Node.js stream.\n      const readableStream = new ReadableStream({\n        start(controller) {\n          const nodeStream = blob.readableStreamBody\n          if (!nodeStream) {\n            throw new Error('No readable stream body')\n          }\n\n          nodeStream.on('data', (chunk) => {\n            controller.enqueue(new Uint8Array(chunk))\n          })\n          nodeStream.on('end', () => {\n            controller.close()\n          })\n          nodeStream.on('error', (err) => {\n            controller.error(err)\n          })\n        },\n      })\n\n      return new Response(readableStream, {\n        headers,\n        status: rangeResult.status,\n      })\n    } catch (err: unknown) {\n      if (err instanceof RestError && err.statusCode === 404) {\n        return new Response(null, { status: 404, statusText: 'Not Found' })\n      }\n      req.payload.logger.error(err)\n      return new Response('Internal Server Error', { status: 500 })\n    }\n  }\n}\n"],"names":["RestError","getFilePrefix","path","getRangeRequestInfo","getHandler","collection","getStorageClient","req","headers","incomingHeaders","params","clientUploadContext","filename","prefix","blockBlobClient","getBlockBlobClient","posix","join","properties","getProperties","fileSize","contentLength","Response","status","rangeHeader","get","rangeResult","type","Headers","blob","download","rangeStart","rangeEnd","key","value","Object","entries","append","String","contentType","etag","etagFromHeaders","upload","modifyResponseHeaders","readableStream","ReadableStream","start","controller","nodeStream","readableStreamBody","Error","on","chunk","enqueue","Uint8Array","close","err","error","statusCode","statusText","payload","logger"],"mappings":"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"}