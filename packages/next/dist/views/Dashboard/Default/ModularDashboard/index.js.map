{"version":3,"file":"index.js","names":["RenderServerComponent","React","getPreferences","ModularDashboardClient","ModularDashboard","props","defaultLayout","widgets","payload","config","admin","dashboard","importMap","user","req","initPageResult","i18n","layout","getItemsFromPreferences","getItemsFromConfig","serverLayout","map","layoutItem","widgetSlug","id","slice","lastIndexOf","component","Component","find","widget","slug","ComponentPath","serverProps","item","clientWidgets","_","label","rest","t","_jsx","clientLayout","savedPreferences","collection","value","layouts","widgetInstances","widgetInstance","index","maxWidth","minWidth","width"],"sources":["../../../../../src/views/Dashboard/Default/ModularDashboard/index.tsx"],"sourcesContent":["import type { TFunction } from '@payloadcms/translations'\nimport type {\n  BasePayload,\n  ClientWidget,\n  DashboardConfig,\n  PayloadRequest,\n  TypedUser,\n  Widget,\n  WidgetInstance,\n  WidgetServerProps,\n} from 'payload'\n\nimport { RenderServerComponent } from '@payloadcms/ui/elements/RenderServerComponent'\nimport React from 'react'\n\nimport type { DashboardViewServerProps } from '../index.js'\nimport type { WidgetInstanceClient, WidgetItem } from './index.client.js'\n\nimport { getPreferences } from '../../../../utilities/getPreferences.js'\nimport { ModularDashboardClient } from './index.client.js'\nimport './index.scss'\n\ntype ServerLayout = WidgetInstanceClient[]\n\nexport async function ModularDashboard(props: DashboardViewServerProps) {\n  const { defaultLayout = [], widgets = [] } = props.payload.config.admin.dashboard || {}\n  const { importMap } = props.payload\n  const { user } = props\n  const { req } = props.initPageResult\n  const { i18n } = req\n\n  const layout =\n    (await getItemsFromPreferences(props.payload, user)) ??\n    (await getItemsFromConfig(defaultLayout, req, widgets))\n\n  const serverLayout: ServerLayout = layout.map((layoutItem) => {\n    const widgetSlug = layoutItem.id.slice(0, layoutItem.id.lastIndexOf('-'))\n    return {\n      component: RenderServerComponent({\n        Component: widgets.find((widget) => widget.slug === widgetSlug)?.ComponentPath,\n        importMap,\n        serverProps: {\n          req,\n          widgetSlug,\n          // TODO: widgets will support state in the future\n          // widgetData: layoutItem.data,\n        } satisfies WidgetServerProps,\n      }),\n      item: layoutItem,\n    }\n  })\n\n  // Resolve function labels to static labels for client components\n  const clientWidgets: ClientWidget[] = widgets.map((widget) => {\n    const { ComponentPath: _, label, ...rest } = widget\n    return {\n      ...rest,\n      label: typeof label === 'function' ? label({ i18n, t: i18n.t as TFunction }) : label,\n    }\n  })\n\n  return (\n    <div>\n      <ModularDashboardClient clientLayout={serverLayout} widgets={clientWidgets} />\n    </div>\n  )\n}\n\nasync function getItemsFromPreferences(\n  payload: BasePayload,\n  user: TypedUser,\n): Promise<null | WidgetItem[]> {\n  const savedPreferences = await getPreferences(\n    'dashboard-layout',\n    payload,\n    user.id,\n    user.collection,\n  )\n  if (\n    !savedPreferences?.value ||\n    typeof savedPreferences.value !== 'object' ||\n    !('layouts' in savedPreferences.value)\n  ) {\n    return null\n  }\n  return savedPreferences.value.layouts as null | WidgetItem[]\n}\n\nasync function getItemsFromConfig(\n  defaultLayout: NonNullable<DashboardConfig['defaultLayout']>,\n  req: PayloadRequest,\n  widgets: Widget[],\n): Promise<WidgetItem[]> {\n  // Handle function format\n  let widgetInstances: WidgetInstance[]\n  if (typeof defaultLayout === 'function') {\n    widgetInstances = await defaultLayout({ req })\n  } else {\n    widgetInstances = defaultLayout\n  }\n\n  return widgetInstances.map((widgetInstance, index) => {\n    const widget = widgets.find((widget) => widget.slug === widgetInstance.widgetSlug)\n    return {\n      id: `${widgetInstance.widgetSlug}-${index}`,\n      maxWidth: widget?.maxWidth ?? 'full',\n      minWidth: widget?.minWidth ?? 'x-small',\n      width: widgetInstance.width || 'x-small',\n    }\n  })\n}\n"],"mappings":"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","ignoreList":[]}