{"version":3,"file":"useDashboardLayout.js","names":["arrayMove","ConfirmationModal","toast","useConfig","useModal","usePreferences","useServerFunctions","React","useCallback","useState","RenderWidget","useDashboardLayout","initialLayout","setLayoutPreference","useSetLayoutPreference","isEditing","setIsEditing","widgets","config","admin","dashboard","currentLayout","setCurrentLayout","openModal","cancelModalSlug","serverFunction","saveLayout","layoutData","map","item","error","resetLayout","result","name","args","layout","performCancel","cancel","hasChanges","length","some","widget","index","initialWidget","id","width","moveWidget","moveFromIndex","moveToIndex","prev","addWidget","widgetSlug","widgetId","Date","now","find","slug","newWidgetInstance","component","createElement","maxWidth","minWidth","setTimeout","element","document","getElementById","scrollIntoView","behavior","block","closest","classList","add","remove","deleteWidget","filter","resizeWidget","newWidth","cancelModal","body","confirmLabel","heading","modalSlug","onConfirm","setPreference","layouts"],"sources":["../../../../../src/views/Dashboard/Default/ModularDashboard/useDashboardLayout.ts"],"sourcesContent":["import type { WidgetWidth } from 'payload'\n\nimport { arrayMove } from '@dnd-kit/sortable'\nimport {\n  ConfirmationModal,\n  toast,\n  useConfig,\n  useModal,\n  usePreferences,\n  useServerFunctions,\n} from '@payloadcms/ui'\nimport React, { useCallback, useState } from 'react'\n\nimport type { WidgetInstanceClient, WidgetItem } from './index.client.js'\nimport type { GetDefaultLayoutServerFnReturnType } from './renderWidget/getDefaultLayoutServerFn.js'\n\nimport { RenderWidget } from './renderWidget/RenderWidget.js'\n\nexport function useDashboardLayout(initialLayout: WidgetInstanceClient[]) {\n  const setLayoutPreference = useSetLayoutPreference()\n  const [isEditing, setIsEditing] = useState(false)\n  const { widgets = [] } = useConfig().config.admin.dashboard ?? {}\n  const [currentLayout, setCurrentLayout] = useState<WidgetInstanceClient[]>(initialLayout)\n  const { openModal } = useModal()\n  const cancelModalSlug = 'cancel-dashboard-changes'\n  const { serverFunction } = useServerFunctions()\n\n  const saveLayout = useCallback(async () => {\n    try {\n      const layoutData: WidgetItem[] = currentLayout.map((item) => item.item)\n      setIsEditing(false)\n      await setLayoutPreference(layoutData)\n    } catch {\n      setIsEditing(true)\n      toast.error('Failed to save layout')\n    }\n  }, [setLayoutPreference, currentLayout])\n\n  const resetLayout = useCallback(async () => {\n    try {\n      await setLayoutPreference(null)\n\n      const result = (await serverFunction({\n        name: 'get-default-layout',\n        args: {},\n      })) as GetDefaultLayoutServerFnReturnType\n\n      setCurrentLayout(result.layout)\n      setIsEditing(false)\n    } catch {\n      toast.error('Failed to reset layout')\n    }\n  }, [setLayoutPreference, serverFunction])\n\n  const performCancel = useCallback(() => {\n    setCurrentLayout(initialLayout)\n    setIsEditing(false)\n  }, [initialLayout])\n\n  const cancel = useCallback(() => {\n    // Check if layout has changed\n    const hasChanges =\n      currentLayout.length !== initialLayout.length ||\n      currentLayout.some((widget, index) => {\n        const initialWidget = initialLayout[index]\n        return (\n          !initialWidget ||\n          widget.item.id !== initialWidget.item.id ||\n          widget.item.width !== initialWidget.item.width\n        )\n      })\n\n    // If there are changes, show confirmation modal\n    if (hasChanges) {\n      openModal(cancelModalSlug)\n    } else {\n      performCancel()\n    }\n  }, [currentLayout, initialLayout, openModal, cancelModalSlug, performCancel])\n\n  const moveWidget = useCallback(\n    ({ moveFromIndex, moveToIndex }: { moveFromIndex: number; moveToIndex: number }) => {\n      if (moveFromIndex === moveToIndex || moveFromIndex < 0 || moveToIndex < 0) {\n        return\n      }\n\n      setCurrentLayout((prev) => {\n        return arrayMove(prev, moveFromIndex, moveToIndex)\n      })\n    },\n    [],\n  )\n\n  const addWidget = useCallback(\n    (widgetSlug: string) => {\n      if (!isEditing) {\n        return\n      }\n\n      const widgetId = `${widgetSlug}-${Date.now()}`\n      const widget = widgets.find((widget) => widget.slug === widgetSlug)\n\n      // Create a new widget instance using RenderWidget\n      const newWidgetInstance: WidgetInstanceClient = {\n        component: React.createElement(RenderWidget, {\n          widgetId,\n          // TODO: widgetData can be added here for custom props\n        }),\n        item: {\n          id: widgetId,\n          maxWidth: widget?.maxWidth ?? 'full',\n          minWidth: widget?.minWidth ?? 'x-small',\n          width: widget?.minWidth ?? 'x-small',\n        },\n      }\n\n      setCurrentLayout((prev) => [...prev, newWidgetInstance])\n\n      // Scroll to the newly added widget after it's rendered and highlight it\n      setTimeout(() => {\n        const element = document.getElementById(widgetId)\n        if (element) {\n          element.scrollIntoView({\n            behavior: 'smooth',\n            block: 'center',\n          })\n\n          // Add highlight animation to the widget element\n          const widget = element.closest('.widget')\n          if (widget) {\n            widget.classList.add('widget--highlight')\n            // Remove the class after animation completes (1.5s fade out)\n            setTimeout(() => {\n              widget.classList.remove('widget--highlight')\n            }, 1500)\n          }\n        }\n      }, 100)\n    },\n    [isEditing, widgets],\n  )\n\n  const deleteWidget = useCallback(\n    (widgetId: string) => {\n      if (!isEditing) {\n        return\n      }\n      setCurrentLayout((prev) => prev.filter((item) => item.item.id !== widgetId))\n    },\n    [isEditing],\n  )\n\n  const resizeWidget = useCallback(\n    (widgetId: string, newWidth: WidgetWidth) => {\n      if (!isEditing) {\n        return\n      }\n      setCurrentLayout((prev) =>\n        prev.map((item) =>\n          item.item.id === widgetId\n            ? {\n                ...item,\n                item: {\n                  ...item.item,\n                  width: newWidth,\n                } satisfies WidgetItem,\n              }\n            : item,\n        ),\n      )\n    },\n    [isEditing],\n  )\n\n  const cancelModal = React.createElement(ConfirmationModal, {\n    body: 'You have unsaved changes to your dashboard layout. Are you sure you want to discard them?',\n    confirmLabel: 'Discard',\n    heading: 'Discard changes?',\n    modalSlug: cancelModalSlug,\n    onConfirm: performCancel,\n  })\n\n  return {\n    addWidget,\n    cancel,\n    cancelModal,\n    currentLayout,\n    deleteWidget,\n    isEditing,\n    moveWidget,\n    resetLayout,\n    resizeWidget,\n    saveLayout,\n    setIsEditing,\n  }\n}\n\nfunction useSetLayoutPreference() {\n  const { setPreference } = usePreferences()\n  return useCallback(\n    async (layout: null | WidgetItem[]) => {\n      await setPreference('dashboard-layout', { layouts: layout }, false)\n    },\n    [setPreference],\n  )\n}\n"],"mappings":"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","ignoreList":[]}