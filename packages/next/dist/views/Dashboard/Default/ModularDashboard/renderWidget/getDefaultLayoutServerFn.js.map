{"version":3,"file":"getDefaultLayoutServerFn.js","names":["RenderServerComponent","getDefaultLayoutHandler","req","user","Error","defaultLayout","widgets","payload","config","admin","dashboard","importMap","layoutItems","getItemsFromConfig","layout","map","layoutItem","widgetSlug","id","slice","lastIndexOf","component","Component","find","widget","slug","ComponentPath","serverProps","item","widgetInstances","widgetInstance","index","w","maxWidth","minWidth","width"],"sources":["../../../../../../src/views/Dashboard/Default/ModularDashboard/renderWidget/getDefaultLayoutServerFn.ts"],"sourcesContent":["import type {\n  DashboardConfig,\n  PayloadRequest,\n  ServerFunction,\n  Widget,\n  WidgetServerProps,\n} from 'payload'\n\nimport { RenderServerComponent } from '@payloadcms/ui/elements/RenderServerComponent'\n\nimport type { WidgetInstanceClient, WidgetItem } from '../index.client.js'\n\nexport type GetDefaultLayoutServerFnArgs = Record<string, never>\n\nexport type GetDefaultLayoutServerFnReturnType = {\n  layout: WidgetInstanceClient[]\n}\n\n/**\n * Server function to get the default dashboard layout on-demand.\n * Used when resetting the dashboard to its default configuration.\n */\nexport const getDefaultLayoutHandler: ServerFunction<\n  GetDefaultLayoutServerFnArgs,\n  Promise<GetDefaultLayoutServerFnReturnType>\n> = async ({ req }) => {\n  if (!req.user) {\n    throw new Error('Unauthorized')\n  }\n\n  const { defaultLayout = [], widgets = [] } = req.payload.config.admin.dashboard || {}\n  const { importMap } = req.payload\n\n  const layoutItems = await getItemsFromConfig(defaultLayout, req, widgets)\n\n  const layout: WidgetInstanceClient[] = layoutItems.map((layoutItem) => {\n    const widgetSlug = layoutItem.id.slice(0, layoutItem.id.lastIndexOf('-'))\n    return {\n      component: RenderServerComponent({\n        Component: widgets.find((widget) => widget.slug === widgetSlug)?.ComponentPath,\n        importMap,\n        serverProps: {\n          req,\n          widgetSlug,\n        } satisfies WidgetServerProps,\n      }),\n      item: layoutItem,\n    }\n  })\n\n  return { layout }\n}\n\nasync function getItemsFromConfig(\n  defaultLayout: NonNullable<DashboardConfig['defaultLayout']>,\n  req: PayloadRequest,\n  widgets: Widget[],\n): Promise<WidgetItem[]> {\n  // Handle function format\n  let widgetInstances\n  if (typeof defaultLayout === 'function') {\n    widgetInstances = await defaultLayout({ req })\n  } else {\n    widgetInstances = defaultLayout\n  }\n\n  return widgetInstances.map((widgetInstance, index) => {\n    const widget = widgets.find((w) => w.slug === widgetInstance.widgetSlug)\n    return {\n      id: `${widgetInstance.widgetSlug}-${index}`,\n      maxWidth: widget?.maxWidth ?? 'full',\n      minWidth: widget?.minWidth ?? 'x-small',\n      width: widgetInstance.width || 'x-small',\n    }\n  })\n}\n"],"mappings":"AAQA,SAASA,qBAAqB,QAAQ;AAUtC;;;;AAIA,OAAO,MAAMC,uBAAA,GAGT,MAAAA,CAAO;EAAEC;AAAG,CAAE;EAChB,IAAI,CAACA,GAAA,CAAIC,IAAI,EAAE;IACb,MAAM,IAAIC,KAAA,CAAM;EAClB;EAEA,MAAM;IAAEC,aAAA,GAAgB,EAAE;IAAEC,OAAA,GAAU;EAAE,CAAE,GAAGJ,GAAA,CAAIK,OAAO,CAACC,MAAM,CAACC,KAAK,CAACC,SAAS,IAAI,CAAC;EACpF,MAAM;IAAEC;EAAS,CAAE,GAAGT,GAAA,CAAIK,OAAO;EAEjC,MAAMK,WAAA,GAAc,MAAMC,kBAAA,CAAmBR,aAAA,EAAeH,GAAA,EAAKI,OAAA;EAEjE,MAAMQ,MAAA,GAAiCF,WAAA,CAAYG,GAAG,CAAEC,UAAA;IACtD,MAAMC,UAAA,GAAaD,UAAA,CAAWE,EAAE,CAACC,KAAK,CAAC,GAAGH,UAAA,CAAWE,EAAE,CAACE,WAAW,CAAC;IACpE,OAAO;MACLC,SAAA,EAAWrB,qBAAA,CAAsB;QAC/BsB,SAAA,EAAWhB,OAAA,CAAQiB,IAAI,CAAEC,MAAA,IAAWA,MAAA,CAAOC,IAAI,KAAKR,UAAA,GAAaS,aAAA;QACjEf,SAAA;QACAgB,WAAA,EAAa;UACXzB,GAAA;UACAe;QACF;MACF;MACAW,IAAA,EAAMZ;IACR;EACF;EAEA,OAAO;IAAEF;EAAO;AAClB;AAEA,eAAeD,mBACbR,aAA4D,EAC5DH,GAAmB,EACnBI,OAAiB;EAEjB;EACA,IAAIuB,eAAA;EACJ,IAAI,OAAOxB,aAAA,KAAkB,YAAY;IACvCwB,eAAA,GAAkB,MAAMxB,aAAA,CAAc;MAAEH;IAAI;EAC9C,OAAO;IACL2B,eAAA,GAAkBxB,aAAA;EACpB;EAEA,OAAOwB,eAAA,CAAgBd,GAAG,CAAC,CAACe,cAAA,EAAgBC,KAAA;IAC1C,MAAMP,MAAA,GAASlB,OAAA,CAAQiB,IAAI,CAAES,CAAA,IAAMA,CAAA,CAAEP,IAAI,KAAKK,cAAA,CAAeb,UAAU;IACvE,OAAO;MACLC,EAAA,EAAI,GAAGY,cAAA,CAAeb,UAAU,IAAIc,KAAA,EAAO;MAC3CE,QAAA,EAAUT,MAAA,EAAQS,QAAA,IAAY;MAC9BC,QAAA,EAAUV,MAAA,EAAQU,QAAA,IAAY;MAC9BC,KAAA,EAAOL,cAAA,CAAeK,KAAK,IAAI;IACjC;EACF;AACF","ignoreList":[]}