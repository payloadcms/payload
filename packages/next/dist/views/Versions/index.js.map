{"version":3,"file":"index.js","names":["Gutter","ListQueryProvider","SetDocumentStepNav","notFound","formatAdminURL","hasDraftsEnabled","isNumber","React","fetchLatestVersion","fetchVersions","VersionDrawerCreatedAtCell","buildVersionColumns","VersionsViewClient","baseClass","VersionsView","props","hasPublishedDoc","initPageResult","collectionConfig","docID","id","globalConfig","req","i18n","payload","config","t","user","routeSegments","segments","searchParams","limit","page","sort","versions","disableGutter","useVersionDrawerCreatedAtCell","draftsEnabled","collectionSlug","slug","globalSlug","isTrashed","localization","routes","api","apiRoute","serverURL","whereQuery","and","push","snapshot","not_equals","defaultLimit","admin","pagination","limitToUse","Number","versionsData","depth","overrideAccess","parseInt","toString","undefined","parentID","where","currentlyPublishedVersion","latestDraftVersion","Promise","all","select","updatedAt","status","resolve","fetchURL","path","columns","CreatedAtCellOverride","docs","pluralLabel","labels","plural","label","GutterComponent","Fragment","_jsxs","_jsx","useAsTitle","view","className","data","modifySearchParams","orderableFieldName","orderable","query","paginationLimits","limits"],"sources":["../../../src/views/Versions/index.tsx"],"sourcesContent":["import { Gutter, ListQueryProvider, SetDocumentStepNav } from '@payloadcms/ui'\nimport { notFound } from 'next/navigation.js'\nimport { type DocumentViewServerProps, type PaginatedDocs, type Where } from 'payload'\nimport { formatAdminURL, hasDraftsEnabled, isNumber } from 'payload/shared'\nimport React from 'react'\n\nimport { fetchLatestVersion, fetchVersions } from '../Version/fetchVersions.js'\nimport { VersionDrawerCreatedAtCell } from '../Version/SelectComparison/VersionDrawer/CreatedAtCell.js'\nimport { buildVersionColumns } from './buildColumns.js'\nimport { VersionsViewClient } from './index.client.js'\nimport './index.scss'\n\nconst baseClass = 'versions'\n\nexport async function VersionsView(props: DocumentViewServerProps) {\n  const {\n    hasPublishedDoc,\n    initPageResult: {\n      collectionConfig,\n      docID: id,\n      globalConfig,\n      req,\n      req: {\n        i18n,\n        payload: { config },\n        t,\n        user,\n      },\n    },\n    routeSegments: segments,\n    searchParams: { limit, page, sort },\n    versions: { disableGutter = false, useVersionDrawerCreatedAtCell = false } = {},\n  } = props\n\n  const draftsEnabled = hasDraftsEnabled(collectionConfig || globalConfig)\n\n  const collectionSlug = collectionConfig?.slug\n  const globalSlug = globalConfig?.slug\n\n  const isTrashed = segments[2] === 'trash'\n\n  const {\n    localization,\n    routes: { api: apiRoute },\n    serverURL,\n  } = config\n\n  const whereQuery: {\n    and: Array<{ parent?: { equals: number | string }; snapshot?: { not_equals: boolean } }>\n  } & Where = {\n    and: [],\n  }\n  if (localization && draftsEnabled) {\n    whereQuery.and.push({\n      snapshot: {\n        not_equals: true,\n      },\n    })\n  }\n\n  const defaultLimit = collectionSlug ? collectionConfig?.admin?.pagination?.defaultLimit : 10\n\n  const limitToUse = isNumber(limit) ? Number(limit) : defaultLimit\n\n  const versionsData: PaginatedDocs = await fetchVersions({\n    collectionSlug,\n    depth: 0,\n    globalSlug,\n    limit: limitToUse,\n    overrideAccess: false,\n    page: page ? parseInt(page.toString(), 10) : undefined,\n    parentID: id,\n    req,\n    sort: sort as string,\n    user,\n    where: whereQuery,\n  })\n\n  if (!versionsData) {\n    return notFound()\n  }\n\n  const [currentlyPublishedVersion, latestDraftVersion] = await Promise.all([\n    hasPublishedDoc\n      ? fetchLatestVersion({\n          collectionSlug,\n          depth: 0,\n          globalSlug,\n          overrideAccess: false,\n          parentID: id,\n          req,\n          select: {\n            id: true,\n            updatedAt: true,\n          },\n          status: 'published',\n          user,\n        })\n      : Promise.resolve(null),\n    draftsEnabled\n      ? fetchLatestVersion({\n          collectionSlug,\n          depth: 0,\n          globalSlug,\n          overrideAccess: false,\n          parentID: id,\n          req,\n          select: {\n            id: true,\n            updatedAt: true,\n          },\n          status: 'draft',\n          user,\n        })\n      : Promise.resolve(null),\n  ])\n\n  const fetchURL = formatAdminURL({\n    apiRoute,\n    path: collectionSlug ? `/${collectionSlug}/versions` : `/${globalSlug}/versions`,\n  })\n\n  const columns = buildVersionColumns({\n    collectionConfig,\n    CreatedAtCellOverride: useVersionDrawerCreatedAtCell ? VersionDrawerCreatedAtCell : undefined,\n    currentlyPublishedVersion,\n    docID: id,\n    docs: versionsData?.docs,\n    globalConfig,\n    i18n,\n    isTrashed,\n    latestDraftVersion,\n  })\n\n  const pluralLabel =\n    typeof collectionConfig?.labels?.plural === 'function'\n      ? collectionConfig.labels.plural({ i18n, t })\n      : (collectionConfig?.labels?.plural ?? globalConfig?.label)\n\n  const GutterComponent = disableGutter ? React.Fragment : Gutter\n\n  return (\n    <React.Fragment>\n      <SetDocumentStepNav\n        collectionSlug={collectionSlug}\n        globalSlug={globalSlug}\n        id={id}\n        isTrashed={isTrashed}\n        pluralLabel={pluralLabel}\n        useAsTitle={collectionConfig?.admin?.useAsTitle || globalSlug}\n        view={i18n.t('version:versions')}\n      />\n      <main className={baseClass}>\n        <GutterComponent className={`${baseClass}__wrap`}>\n          <ListQueryProvider\n            data={versionsData}\n            modifySearchParams\n            orderableFieldName={collectionConfig?.orderable === true ? '_order' : undefined}\n            query={{\n              limit: limitToUse,\n              sort: sort as string,\n            }}\n          >\n            <VersionsViewClient\n              baseClass={baseClass}\n              columns={columns}\n              fetchURL={fetchURL}\n              paginationLimits={collectionConfig?.admin?.pagination?.limits}\n            />\n          </ListQueryProvider>\n        </GutterComponent>\n      </main>\n    </React.Fragment>\n  )\n}\n"],"mappings":"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","ignoreList":[]}