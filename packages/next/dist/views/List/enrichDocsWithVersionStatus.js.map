{"version":3,"file":"enrichDocsWithVersionStatus.js","names":["enrichDocsWithVersionStatus","collectionConfig","data","req","draftsEnabled","versions","drafts","docs","length","draftDocs","filter","doc","_status","draftDocIds","map","id","Boolean","publishedVersions","payload","findVersions","collection","slug","depth","limit","pagination","select","parent","where","and","in","equals","hasPublishedVersionSet","Set","version","enrichedDocs","has","_displayStatus","error","logger","err","msg"],"sources":["../../../src/views/List/enrichDocsWithVersionStatus.ts"],"sourcesContent":["import type { PaginatedDocs, PayloadRequest, SanitizedCollectionConfig } from 'payload'\n\n/**\n * Enriches list view documents with correct draft status display.\n * When draft=true is used in the query, Payload returns the latest draft version if it exists.\n * This function checks if draft documents also have a published version to determine \"changed\" status.\n *\n * Performance: Uses a single query to find all documents with \"changed\" status instead of N queries.\n */\nexport async function enrichDocsWithVersionStatus({\n  collectionConfig,\n  data,\n  req,\n}: {\n  collectionConfig: SanitizedCollectionConfig\n  data: PaginatedDocs\n  req: PayloadRequest\n}): Promise<PaginatedDocs> {\n  const draftsEnabled = collectionConfig?.versions?.drafts\n\n  if (!draftsEnabled || !data?.docs?.length) {\n    return data\n  }\n\n  // Find all draft documents\n  // When querying with draft:true, we get the latest draft if it exists\n  // We need to check if these drafts have a published version\n  const draftDocs = data.docs.filter((doc) => doc._status === 'draft')\n\n  if (draftDocs.length === 0) {\n    return data\n  }\n\n  const draftDocIds = draftDocs.map((doc) => doc.id).filter(Boolean)\n\n  if (draftDocIds.length === 0) {\n    return data\n  }\n\n  // OPTIMIZATION: Single query to find all document IDs that have BOTH:\n  // 1. A draft version (latest=true, _status='draft')\n  // 2. A published version (_status='published')\n  // These are the documents with \"changed\" status\n  try {\n    // TODO: This could be more efficient with a findDistinctVersions() API:\n    // const { values } = await req.payload.findDistinctVersions({\n    //   collection: collectionConfig.slug,\n    //   field: 'parent',\n    //   where: {\n    //     and: [\n    //       { parent: { in: draftDocIds } },\n    //       { 'version._status': { equals: 'published' } },\n    //     ],\n    //   },\n    // })\n    // const hasPublishedVersionSet = new Set(values)\n    //\n    // For now, we query all published versions but only select the 'parent' field\n    // to minimize data transfer, then deduplicate with a Set\n    const publishedVersions = await req.payload.findVersions({\n      collection: collectionConfig.slug,\n      depth: 0,\n      limit: 0,\n      pagination: false,\n      select: {\n        parent: true,\n      },\n      where: {\n        and: [\n          {\n            parent: {\n              in: draftDocIds,\n            },\n          },\n          {\n            'version._status': {\n              equals: 'published',\n            },\n          },\n        ],\n      },\n    })\n\n    // Create a Set of document IDs that have published versions\n    const hasPublishedVersionSet = new Set(\n      publishedVersions.docs.map((version) => version.parent).filter(Boolean),\n    )\n\n    // Enrich documents with display status\n    const enrichedDocs = data.docs.map((doc) => {\n      // If it's a draft and has a published version, show \"changed\"\n      if (doc._status === 'draft' && hasPublishedVersionSet.has(doc.id)) {\n        return {\n          ...doc,\n          _displayStatus: 'changed' as const,\n        }\n      }\n\n      return {\n        ...doc,\n        _displayStatus: doc._status as 'draft' | 'published',\n      }\n    })\n\n    return {\n      ...data,\n      docs: enrichedDocs,\n    }\n  } catch (error) {\n    // If there's an error querying versions, just return the original data\n    req.payload.logger.error({\n      err: error,\n      msg: `Error checking version status for collection ${collectionConfig.slug}`,\n    })\n    return data\n  }\n}\n"],"mappings":"AAEA;;;;;;GAOA,OAAO,eAAeA,4BAA4B;EAChDC,gBAAgB;EAChBC,IAAI;EACJC;AAAG,CAKJ;EACC,MAAMC,aAAA,GAAgBH,gBAAA,EAAkBI,QAAA,EAAUC,MAAA;EAElD,IAAI,CAACF,aAAA,IAAiB,CAACF,IAAA,EAAMK,IAAA,EAAMC,MAAA,EAAQ;IACzC,OAAON,IAAA;EACT;EAEA;EACA;EACA;EACA,MAAMO,SAAA,GAAYP,IAAA,CAAKK,IAAI,CAACG,MAAM,CAAEC,GAAA,IAAQA,GAAA,CAAIC,OAAO,KAAK;EAE5D,IAAIH,SAAA,CAAUD,MAAM,KAAK,GAAG;IAC1B,OAAON,IAAA;EACT;EAEA,MAAMW,WAAA,GAAcJ,SAAA,CAAUK,GAAG,CAAEH,GAAA,IAAQA,GAAA,CAAII,EAAE,EAAEL,MAAM,CAACM,OAAA;EAE1D,IAAIH,WAAA,CAAYL,MAAM,KAAK,GAAG;IAC5B,OAAON,IAAA;EACT;EAEA;EACA;EACA;EACA;EACA,IAAI;IACF;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA,MAAMe,iBAAA,GAAoB,MAAMd,GAAA,CAAIe,OAAO,CAACC,YAAY,CAAC;MACvDC,UAAA,EAAYnB,gBAAA,CAAiBoB,IAAI;MACjCC,KAAA,EAAO;MACPC,KAAA,EAAO;MACPC,UAAA,EAAY;MACZC,MAAA,EAAQ;QACNC,MAAA,EAAQ;MACV;MACAC,KAAA,EAAO;QACLC,GAAA,EAAK,CACH;UACEF,MAAA,EAAQ;YACNG,EAAA,EAAIhB;UACN;QACF,GACA;UACE,mBAAmB;YACjBiB,MAAA,EAAQ;UACV;QACF;MAEJ;IACF;IAEA;IACA,MAAMC,sBAAA,GAAyB,IAAIC,GAAA,CACjCf,iBAAA,CAAkBV,IAAI,CAACO,GAAG,CAAEmB,OAAA,IAAYA,OAAA,CAAQP,MAAM,EAAEhB,MAAM,CAACM,OAAA;IAGjE;IACA,MAAMkB,YAAA,GAAehC,IAAA,CAAKK,IAAI,CAACO,GAAG,CAAEH,GAAA;MAClC;MACA,IAAIA,GAAA,CAAIC,OAAO,KAAK,WAAWmB,sBAAA,CAAuBI,GAAG,CAACxB,GAAA,CAAII,EAAE,GAAG;QACjE,OAAO;UACL,GAAGJ,GAAG;UACNyB,cAAA,EAAgB;QAClB;MACF;MAEA,OAAO;QACL,GAAGzB,GAAG;QACNyB,cAAA,EAAgBzB,GAAA,CAAIC;MACtB;IACF;IAEA,OAAO;MACL,GAAGV,IAAI;MACPK,IAAA,EAAM2B;IACR;EACF,EAAE,OAAOG,KAAA,EAAO;IACd;IACAlC,GAAA,CAAIe,OAAO,CAACoB,MAAM,CAACD,KAAK,CAAC;MACvBE,GAAA,EAAKF,KAAA;MACLG,GAAA,EAAK,gDAAgDvC,gBAAA,CAAiBoB,IAAI;IAC5E;IACA,OAAOnB,IAAA;EACT;AACF","ignoreList":[]}