{"version":3,"file":"getVersions.js","names":["sanitizeID","combineQueries","extractAccessFromPermission","hasAutosaveEnabled","hasDraftsEnabled","getVersions","id","idArg","collectionConfig","doc","docPermissions","globalConfig","locale","payload","user","publishedDoc","hasPublishedDoc","mostRecentVersionIsAutosaved","unpublishedVersionCount","versionCount","entityConfig","versionsConfig","versions","shouldFetchVersions","Boolean","readVersions","_status","find","collection","slug","depth","limit","undefined","pagination","select","updatedAt","where","and","or","equals","exists","docs","mostRecentVersion","findVersions","autosave","parent","totalDocs","countVersions","greater_than","findGlobal","findGlobalVersions","countGlobalVersions","global"],"sources":["../../../src/views/Document/getVersions.ts"],"sourcesContent":["import { sanitizeID } from '@payloadcms/ui/shared'\nimport {\n  combineQueries,\n  extractAccessFromPermission,\n  type Payload,\n  type SanitizedCollectionConfig,\n  type SanitizedDocumentPermissions,\n  type SanitizedGlobalConfig,\n  type TypedUser,\n} from 'payload'\nimport { hasAutosaveEnabled, hasDraftsEnabled } from 'payload/shared'\n\ntype Args = {\n  collectionConfig?: SanitizedCollectionConfig\n  /**\n   * Optional - performance optimization.\n   * If a document has been fetched before fetching versions, pass it here.\n   * If this document is set to published, we can skip the query to find out if a published document exists,\n   * as the passed in document is proof of its existence.\n   */\n  doc?: Record<string, any>\n  docPermissions: SanitizedDocumentPermissions\n  globalConfig?: SanitizedGlobalConfig\n  id?: number | string\n  locale?: string\n  payload: Payload\n  user: TypedUser\n}\n\ntype Result = Promise<{\n  hasPublishedDoc: boolean\n  mostRecentVersionIsAutosaved: boolean\n  unpublishedVersionCount: number\n  versionCount: number\n}>\n\n// TODO: in the future, we can parallelize some of these queries\n// this will speed up the API by ~30-100ms or so\n// Note from the future: I have attempted parallelizing these queries, but it made this function almost 2x slower.\nexport const getVersions = async ({\n  id: idArg,\n  collectionConfig,\n  doc,\n  docPermissions,\n  globalConfig,\n  locale,\n  payload,\n  user,\n}: Args): Result => {\n  const id = sanitizeID(idArg)\n  let publishedDoc\n  let hasPublishedDoc = false\n  let mostRecentVersionIsAutosaved = false\n  let unpublishedVersionCount = 0\n  let versionCount = 0\n\n  const entityConfig = collectionConfig || globalConfig\n  const versionsConfig = entityConfig?.versions\n\n  const shouldFetchVersions = Boolean(versionsConfig && docPermissions?.readVersions)\n\n  if (!shouldFetchVersions) {\n    // Without readVersions permission, determine published status from the _status field\n    const hasPublishedDoc = doc?._status !== 'draft'\n\n    return {\n      hasPublishedDoc,\n      mostRecentVersionIsAutosaved,\n      unpublishedVersionCount,\n      versionCount,\n    }\n  }\n\n  if (collectionConfig) {\n    if (!id) {\n      return {\n        hasPublishedDoc,\n        mostRecentVersionIsAutosaved,\n        unpublishedVersionCount,\n        versionCount,\n      }\n    }\n\n    if (hasDraftsEnabled(collectionConfig)) {\n      // Find out if a published document exists\n      if (doc?._status === 'published') {\n        publishedDoc = doc\n      } else {\n        publishedDoc = (\n          await payload.find({\n            collection: collectionConfig.slug,\n            depth: 0,\n            limit: 1,\n            locale: locale || undefined,\n            pagination: false,\n            select: {\n              updatedAt: true,\n            },\n            user,\n            where: {\n              and: [\n                {\n                  or: [\n                    {\n                      _status: {\n                        equals: 'published',\n                      },\n                    },\n                    {\n                      _status: {\n                        exists: false,\n                      },\n                    },\n                  ],\n                },\n                {\n                  id: {\n                    equals: id,\n                  },\n                },\n              ],\n            },\n          })\n        )?.docs?.[0]\n      }\n\n      if (publishedDoc) {\n        hasPublishedDoc = true\n      }\n\n      if (hasAutosaveEnabled(collectionConfig)) {\n        const mostRecentVersion = await payload.findVersions({\n          collection: collectionConfig.slug,\n          depth: 0,\n          limit: 1,\n          select: {\n            autosave: true,\n          },\n          user,\n          where: combineQueries(\n            {\n              and: [\n                {\n                  parent: {\n                    equals: id,\n                  },\n                },\n              ],\n            },\n            extractAccessFromPermission(docPermissions.readVersions),\n          ),\n        })\n\n        if (\n          mostRecentVersion.docs[0] &&\n          'autosave' in mostRecentVersion.docs[0] &&\n          mostRecentVersion.docs[0].autosave\n        ) {\n          mostRecentVersionIsAutosaved = true\n        }\n      }\n\n      if (publishedDoc?.updatedAt) {\n        ;({ totalDocs: unpublishedVersionCount } = await payload.countVersions({\n          collection: collectionConfig.slug,\n          user,\n          where: combineQueries(\n            {\n              and: [\n                {\n                  parent: {\n                    equals: id,\n                  },\n                },\n                {\n                  'version._status': {\n                    equals: 'draft',\n                  },\n                },\n                {\n                  updatedAt: {\n                    greater_than: publishedDoc.updatedAt,\n                  },\n                },\n              ],\n            },\n            extractAccessFromPermission(docPermissions.readVersions),\n          ),\n        }))\n      }\n    }\n\n    ;({ totalDocs: versionCount } = await payload.countVersions({\n      collection: collectionConfig.slug,\n      depth: 0,\n      user,\n      where: combineQueries(\n        {\n          and: [\n            {\n              parent: {\n                equals: id,\n              },\n            },\n          ],\n        },\n        extractAccessFromPermission(docPermissions.readVersions),\n      ),\n    }))\n  }\n\n  if (globalConfig) {\n    // Find out if a published document exists\n    if (hasDraftsEnabled(globalConfig)) {\n      if (doc?._status === 'published') {\n        publishedDoc = doc\n      } else {\n        publishedDoc = await payload.findGlobal({\n          slug: globalConfig.slug,\n          depth: 0,\n          locale,\n          select: {\n            updatedAt: true,\n          },\n          user,\n        })\n      }\n\n      if (publishedDoc?._status === 'published') {\n        hasPublishedDoc = true\n      }\n\n      if (hasAutosaveEnabled(globalConfig)) {\n        const mostRecentVersion = await payload.findGlobalVersions({\n          slug: globalConfig.slug,\n          limit: 1,\n          select: {\n            autosave: true,\n          },\n          user,\n        })\n\n        if (\n          mostRecentVersion.docs[0] &&\n          'autosave' in mostRecentVersion.docs[0] &&\n          mostRecentVersion.docs[0].autosave\n        ) {\n          mostRecentVersionIsAutosaved = true\n        }\n      }\n\n      if (publishedDoc?.updatedAt) {\n        ;({ totalDocs: unpublishedVersionCount } = await payload.countGlobalVersions({\n          depth: 0,\n          global: globalConfig.slug,\n          user,\n          where: combineQueries(\n            {\n              and: [\n                {\n                  'version._status': {\n                    equals: 'draft',\n                  },\n                },\n                {\n                  updatedAt: {\n                    greater_than: publishedDoc.updatedAt,\n                  },\n                },\n              ],\n            },\n            extractAccessFromPermission(docPermissions.readVersions),\n          ),\n        }))\n      }\n    }\n\n    ;({ totalDocs: versionCount } = await payload.countGlobalVersions({\n      depth: 0,\n      global: globalConfig.slug,\n      user,\n    }))\n  }\n\n  return {\n    hasPublishedDoc,\n    mostRecentVersionIsAutosaved,\n    unpublishedVersionCount,\n    versionCount,\n  }\n}\n"],"mappings":"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","ignoreList":[]}