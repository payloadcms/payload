{"version":3,"file":"handleServerFunction.js","names":["getClientConfig","headers","getHeaders","canAccessAdmin","getAccessResults","isEntityHidden","parseCookies","applyLocaleFiltering","renderDocument","renderDocumentHandler","args","collectionSlug","disableActions","docID","drawerSlug","initialData","locale","overrideEntityVisibility","paramsOverride","redirectAfterCreate","redirectAfterDelete","redirectAfterDuplicate","req","i18n","payload","config","user","searchParams","versions","cookies","clientConfig","importMap","preferences","preferencesKey","find","collection","depth","limit","where","and","key","equals","id","then","res","docs","value","visibleEntities","collections","map","slug","admin","hidden","filter","Boolean","globals","permissions","data","Document","documentSubViewType","initPageResult","collectionConfig","globalConfig","global","languageOptions","undefined","translations","params","segments","String","viewType"],"sources":["../../../src/views/Document/handleServerFunction.tsx"],"sourcesContent":["import type { RenderDocumentServerFunction } from '@payloadcms/ui'\nimport type { DocumentPreferences, VisibleEntities } from 'payload'\n\nimport { getClientConfig } from '@payloadcms/ui/utilities/getClientConfig'\nimport { headers as getHeaders } from 'next/headers.js'\nimport { canAccessAdmin, getAccessResults, isEntityHidden, parseCookies } from 'payload'\nimport { applyLocaleFiltering } from 'payload/shared'\n\nimport { renderDocument } from './index.js'\n\nexport const renderDocumentHandler: RenderDocumentServerFunction = async (args) => {\n  const {\n    collectionSlug,\n    disableActions,\n    docID,\n    drawerSlug,\n    initialData,\n    locale,\n    overrideEntityVisibility,\n    paramsOverride,\n    redirectAfterCreate,\n    redirectAfterDelete,\n    redirectAfterDuplicate,\n    req,\n    req: {\n      i18n,\n      payload,\n      payload: { config },\n      user,\n    },\n    searchParams = {},\n    versions,\n  } = args\n\n  const headers = await getHeaders()\n\n  const cookies = parseCookies(headers)\n\n  await canAccessAdmin({ req })\n\n  const clientConfig = getClientConfig({\n    config,\n    i18n,\n    importMap: req.payload.importMap,\n    user,\n  })\n  await applyLocaleFiltering({ clientConfig, config, req })\n\n  let preferences: DocumentPreferences\n\n  if (docID) {\n    const preferencesKey = `${collectionSlug}-edit-${docID}`\n\n    preferences = await payload\n      .find({\n        collection: 'payload-preferences',\n        depth: 0,\n        limit: 1,\n        where: {\n          and: [\n            {\n              key: {\n                equals: preferencesKey,\n              },\n            },\n            {\n              'user.relationTo': {\n                equals: user.collection,\n              },\n            },\n            {\n              'user.value': {\n                equals: user.id,\n              },\n            },\n          ],\n        },\n      })\n      .then((res) => res.docs[0]?.value as DocumentPreferences)\n  }\n\n  const visibleEntities: VisibleEntities = {\n    collections: payload.config.collections\n      .map(({ slug, admin: { hidden } }) => (!isEntityHidden({ hidden, user }) ? slug : null))\n      .filter(Boolean),\n    globals: payload.config.globals\n      .map(({ slug, admin: { hidden } }) => (!isEntityHidden({ hidden, user }) ? slug : null))\n      .filter(Boolean),\n  }\n\n  const permissions = await getAccessResults({\n    req,\n  })\n\n  const { data, Document } = await renderDocument({\n    clientConfig,\n    disableActions,\n    documentSubViewType: 'default',\n    drawerSlug,\n    i18n,\n    importMap: payload.importMap,\n    initialData,\n    initPageResult: {\n      collectionConfig: payload?.collections?.[collectionSlug]?.config,\n      cookies,\n      docID,\n      globalConfig: payload.config.globals.find((global) => global.slug === collectionSlug),\n      languageOptions: undefined, // TODO\n      locale,\n      permissions,\n      req,\n      translations: undefined, // TODO\n      visibleEntities,\n    },\n    overrideEntityVisibility,\n    params: paramsOverride ?? {\n      segments: ['collections', collectionSlug, String(docID)],\n    },\n    payload,\n    redirectAfterCreate,\n    redirectAfterDelete,\n    redirectAfterDuplicate,\n    searchParams,\n    versions,\n    viewType: 'document',\n  })\n\n  return {\n    data,\n    Document,\n    preferences,\n  }\n}\n"],"mappings":"AAGA,SAASA,eAAe,QAAQ;AAChC,SAASC,OAAA,IAAWC,UAAU,QAAQ;AACtC,SAASC,cAAc,EAAEC,gBAAgB,EAAEC,cAAc,EAAEC,YAAY,QAAQ;AAC/E,SAASC,oBAAoB,QAAQ;AAErC,SAASC,cAAc,QAAQ;AAE/B,OAAO,MAAMC,qBAAA,GAAsD,MAAOC,IAAA;EACxE,MAAM;IACJC,cAAc;IACdC,cAAc;IACdC,KAAK;IACLC,UAAU;IACVC,WAAW;IACXC,MAAM;IACNC,wBAAwB;IACxBC,cAAc;IACdC,mBAAmB;IACnBC,mBAAmB;IACnBC,sBAAsB;IACtBC,GAAG;IACHA,GAAA,EAAK;MACHC,IAAI;MACJC,OAAO;MACPA,OAAA,EAAS;QAAEC;MAAM,CAAE;MACnBC;IAAI,CACL;IACDC,YAAA,GAAe,CAAC,CAAC;IACjBC;EAAQ,CACT,GAAGlB,IAAA;EAEJ,MAAMT,OAAA,GAAU,MAAMC,UAAA;EAEtB,MAAM2B,OAAA,GAAUvB,YAAA,CAAaL,OAAA;EAE7B,MAAME,cAAA,CAAe;IAAEmB;EAAI;EAE3B,MAAMQ,YAAA,GAAe9B,eAAA,CAAgB;IACnCyB,MAAA;IACAF,IAAA;IACAQ,SAAA,EAAWT,GAAA,CAAIE,OAAO,CAACO,SAAS;IAChCL;EACF;EACA,MAAMnB,oBAAA,CAAqB;IAAEuB,YAAA;IAAcL,MAAA;IAAQH;EAAI;EAEvD,IAAIU,WAAA;EAEJ,IAAInB,KAAA,EAAO;IACT,MAAMoB,cAAA,GAAiB,GAAGtB,cAAA,SAAuBE,KAAA,EAAO;IAExDmB,WAAA,GAAc,MAAMR,OAAA,CACjBU,IAAI,CAAC;MACJC,UAAA,EAAY;MACZC,KAAA,EAAO;MACPC,KAAA,EAAO;MACPC,KAAA,EAAO;QACLC,GAAA,EAAK,CACH;UACEC,GAAA,EAAK;YACHC,MAAA,EAAQR;UACV;QACF,GACA;UACE,mBAAmB;YACjBQ,MAAA,EAAQf,IAAA,CAAKS;UACf;QACF,GACA;UACE,cAAc;YACZM,MAAA,EAAQf,IAAA,CAAKgB;UACf;QACF;MAEJ;IACF,GACCC,IAAI,CAAEC,GAAA,IAAQA,GAAA,CAAIC,IAAI,CAAC,EAAE,EAAEC,KAAA;EAChC;EAEA,MAAMC,eAAA,GAAmC;IACvCC,WAAA,EAAaxB,OAAA,CAAQC,MAAM,CAACuB,WAAW,CACpCC,GAAG,CAAC,CAAC;MAAEC,IAAI;MAAEC,KAAA,EAAO;QAAEC;MAAM;IAAE,CAAE,KAAM,CAAC/C,cAAA,CAAe;MAAE+C,MAAA;MAAQ1B;IAAK,KAAKwB,IAAA,GAAO,MACjFG,MAAM,CAACC,OAAA;IACVC,OAAA,EAAS/B,OAAA,CAAQC,MAAM,CAAC8B,OAAO,CAC5BN,GAAG,CAAC,CAAC;MAAEC,IAAI;MAAEC,KAAA,EAAO;QAAEC;MAAM;IAAE,CAAE,KAAM,CAAC/C,cAAA,CAAe;MAAE+C,MAAA;MAAQ1B;IAAK,KAAKwB,IAAA,GAAO,MACjFG,MAAM,CAACC,OAAA;EACZ;EAEA,MAAME,WAAA,GAAc,MAAMpD,gBAAA,CAAiB;IACzCkB;EACF;EAEA,MAAM;IAAEmC,IAAI;IAAEC;EAAQ,CAAE,GAAG,MAAMlD,cAAA,CAAe;IAC9CsB,YAAA;IACAlB,cAAA;IACA+C,mBAAA,EAAqB;IACrB7C,UAAA;IACAS,IAAA;IACAQ,SAAA,EAAWP,OAAA,CAAQO,SAAS;IAC5BhB,WAAA;IACA6C,cAAA,EAAgB;MACdC,gBAAA,EAAkBrC,OAAA,EAASwB,WAAA,GAAcrC,cAAA,CAAe,EAAEc,MAAA;MAC1DI,OAAA;MACAhB,KAAA;MACAiD,YAAA,EAActC,OAAA,CAAQC,MAAM,CAAC8B,OAAO,CAACrB,IAAI,CAAE6B,MAAA,IAAWA,MAAA,CAAOb,IAAI,KAAKvC,cAAA;MACtEqD,eAAA,EAAiBC,SAAA;MACjBjD,MAAA;MACAwC,WAAA;MACAlC,GAAA;MACA4C,YAAA,EAAcD,SAAA;MACdlB;IACF;IACA9B,wBAAA;IACAkD,MAAA,EAAQjD,cAAA,IAAkB;MACxBkD,QAAA,EAAU,CAAC,eAAezD,cAAA,EAAgB0D,MAAA,CAAOxD,KAAA;IACnD;IACAW,OAAA;IACAL,mBAAA;IACAC,mBAAA;IACAC,sBAAA;IACAM,YAAA;IACAC,QAAA;IACA0C,QAAA,EAAU;EACZ;EAEA,OAAO;IACLb,IAAA;IACAC,QAAA;IACA1B;EACF;AACF","ignoreList":[]}