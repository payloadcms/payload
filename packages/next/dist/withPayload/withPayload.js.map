{"version":3,"file":"withPayload.js","names":["getNextjsVersion","supportsTurbopackExternalizeTransitiveDependencies","withPayloadLegacy","poweredByHeader","key","value","withPayload","nextConfig","options","nextjsVersion","supportsTurbopackBuild","env","experimental","staleTimes","dynamic","console","warn","NEXT_PUBLIC_ENABLE_ROUTER_CACHE_REFRESH","baseConfig","outputFileTracingExcludes","outputFileTracingIncludes","turbopack","headers","headersFromConfig","source","serverExternalPackages","process","NODE_ENV","devBundleServerPackages","webpack","webpackConfig","webpackOptions","incomingWebpackConfig","externals","plugins","IgnorePlugin","resourceRegExp","resolve","alias","fallback","aws4","basePath","NEXT_BASE_PATH"],"sources":["../../src/withPayload/withPayload.js"],"sourcesContent":["/**\n * These files must remain as plain JavaScript (.js) rather than TypeScript (.ts) because they are\n * imported directly in next.config.mjs files. Since next.config files run before the build process,\n * TypeScript compilation is not available. This ensures compatibility with all templates and\n * user projects regardless of their TypeScript setup.\n */\nimport {\n  getNextjsVersion,\n  supportsTurbopackExternalizeTransitiveDependencies,\n} from './withPayload.utils.js'\nimport { withPayloadLegacy } from './withPayloadLegacy.js'\n\nconst poweredByHeader = {\n  key: 'X-Powered-By',\n  value: 'Next.js, Payload',\n}\n\n/**\n * @param {import('next').NextConfig} nextConfig\n * @param {Object} [options] - Optional configuration options\n * @param {boolean} [options.devBundleServerPackages] - Whether to bundle server packages in development mode. @default false\n * */\nexport const withPayload = (nextConfig = {}, options = {}) => {\n  const nextjsVersion = getNextjsVersion()\n\n  const supportsTurbopackBuild = supportsTurbopackExternalizeTransitiveDependencies(nextjsVersion)\n\n  const env = nextConfig.env || {}\n\n  if (nextConfig.experimental?.staleTimes?.dynamic) {\n    console.warn(\n      'Payload detected a non-zero value for the `staleTimes.dynamic` option in your Next.js config. This will slow down page transitions and may cause stale data to load within the Admin panel. To clear this warning, remove the `staleTimes.dynamic` option from your Next.js config or set it to 0. In the future, Next.js may support scoping this option to specific routes.',\n    )\n    env.NEXT_PUBLIC_ENABLE_ROUTER_CACHE_REFRESH = 'true'\n  }\n\n  /** @type {import('next').NextConfig} */\n  const baseConfig = {\n    ...nextConfig,\n    env,\n    outputFileTracingExcludes: {\n      ...(nextConfig.outputFileTracingExcludes || {}),\n      '**/*': [\n        ...(nextConfig.outputFileTracingExcludes?.['**/*'] || []),\n        'drizzle-kit',\n        'drizzle-kit/api',\n      ],\n    },\n    outputFileTracingIncludes: {\n      ...(nextConfig.outputFileTracingIncludes || {}),\n      '**/*': [...(nextConfig.outputFileTracingIncludes?.['**/*'] || []), '@libsql/client'],\n    },\n    turbopack: {\n      ...(nextConfig.turbopack || {}),\n    },\n    // We disable the poweredByHeader here because we add it manually in the headers function below\n    ...(nextConfig.poweredByHeader !== false ? { poweredByHeader: false } : {}),\n    headers: async () => {\n      const headersFromConfig = 'headers' in nextConfig ? await nextConfig.headers() : []\n\n      return [\n        ...(headersFromConfig || []),\n        {\n          headers: [\n            {\n              key: 'Accept-CH',\n              value: 'Sec-CH-Prefers-Color-Scheme',\n            },\n            {\n              key: 'Vary',\n              value: 'Sec-CH-Prefers-Color-Scheme',\n            },\n            {\n              key: 'Critical-CH',\n              value: 'Sec-CH-Prefers-Color-Scheme',\n            },\n            ...(nextConfig.poweredByHeader !== false ? [poweredByHeader] : []),\n          ],\n          source: '/:path*',\n        },\n      ]\n    },\n    serverExternalPackages: [\n      ...(nextConfig.serverExternalPackages || []),\n      // WHY: without externalizing graphql, a graphql version error will be thrown\n      // during runtime (\"Ensure that there is only one instance of \\\"graphql\\\" in the node_modules\\ndirectory.\")\n      'graphql',\n      ...(process.env.NODE_ENV === 'development' && options.devBundleServerPackages !== true\n        ? /**\n           * Unless explicitly disabled by the user, by passing `devBundleServerPackages: true` to withPayload, we\n           * do not bundle server-only packages during dev for two reasons:\n           *\n           * 1. Performance: Fewer files to compile means faster compilation speeds.\n           * 2. Turbopack support: Webpack's externals are not supported by Turbopack.\n           *\n           * Regarding Turbopack support: Unlike webpack.externals, we cannot use serverExternalPackages to\n           * externalized packages that are not resolvable from the project root. So including a package like\n           * \"drizzle-kit\" in here would do nothing - Next.js will ignore the rule and still bundle the package -\n           * because it detects that the package is not resolvable from the project root (= not directly installed\n           * by the user in their own package.json).\n           *\n           * Instead, we can use serverExternalPackages for the entry-point packages that *are* installed directly\n           * by the user (e.g. db-postgres, which then installs drizzle-kit as a dependency).\n           *\n           *\n           *\n           * We should only do this during development, not build, because externalizing these packages can hurt\n           * the bundle size. Not only does it disable tree-shaking, it also risks installing duplicate copies of the\n           * same package.\n           *\n           * Example:\n           * - @payloadcms/richtext-lexical (in bundle) -> installs qs-esm (bundled because of importer)\n           * - payload (not in bundle, external) -> installs qs-esm (external because of importer)\n           * Result: we have two copies of qs-esm installed - one in the bundle, and one in node_modules.\n           *\n           * During development, these bundle size difference do not matter much, and development speed /\n           * turbopack support are more important.\n           */\n          [\n            'payload',\n            '@payloadcms/db-mongodb',\n            '@payloadcms/db-postgres',\n            '@payloadcms/db-sqlite',\n            '@payloadcms/db-vercel-postgres',\n            '@payloadcms/db-d1-sqlite',\n            '@payloadcms/drizzle',\n            '@payloadcms/email-nodemailer',\n            '@payloadcms/email-resend',\n            '@payloadcms/graphql',\n            '@payloadcms/payload-cloud',\n            '@payloadcms/plugin-redirects',\n            // TODO: Add the following packages, excluding their /client subpath exports, once Next.js supports it\n            // see: https://github.com/vercel/next.js/discussions/76991\n            //'@payloadcms/plugin-cloud-storage',\n            //'@payloadcms/plugin-sentry',\n            //'@payloadcms/plugin-stripe',\n            // @payloadcms/richtext-lexical\n            //'@payloadcms/storage-azure',\n            //'@payloadcms/storage-gcs',\n            //'@payloadcms/storage-s3',\n            //'@payloadcms/storage-uploadthing',\n            //'@payloadcms/storage-vercel-blob',\n          ]\n        : []),\n    ],\n    webpack: (webpackConfig, webpackOptions) => {\n      const incomingWebpackConfig =\n        typeof nextConfig.webpack === 'function'\n          ? nextConfig.webpack(webpackConfig, webpackOptions)\n          : webpackConfig\n\n      return {\n        ...incomingWebpackConfig,\n        externals: [\n          ...(incomingWebpackConfig?.externals || []),\n          /**\n           * See the explanation in the serverExternalPackages section above.\n           * We need to force Webpack to emit require() calls for these packages, even though they are not\n           * resolvable from the project root. You would expect this to error during runtime, but Next.js seems to be able to require these just fine.\n           *\n           * This is the only way to get Webpack Build to work, without the bundle size caveats of externalizing the\n           * entry point packages, as explained in the serverExternalPackages section above.\n           */\n          'drizzle-kit',\n          'drizzle-kit/api',\n          'sharp',\n          'libsql',\n          'require-in-the-middle',\n        ],\n        plugins: [\n          ...(incomingWebpackConfig?.plugins || []),\n          // Fix cloudflare:sockets error: https://github.com/vercel/next.js/discussions/50177\n          new webpackOptions.webpack.IgnorePlugin({\n            resourceRegExp: /^pg-native$|^cloudflare:sockets$/,\n          }),\n        ],\n        resolve: {\n          ...(incomingWebpackConfig?.resolve || {}),\n          alias: {\n            ...(incomingWebpackConfig?.resolve?.alias || {}),\n          },\n          fallback: {\n            ...(incomingWebpackConfig?.resolve?.fallback || {}),\n            /*\n             * This fixes the following warning when running next build with webpack (tested on Next.js 16.0.3 with Payload 3.64.0):\n             *\n             * âš  Compiled with warnings in 8.7s\n             *\n             * ./node_modules/.pnpm/mongodb@6.16.0/node_modules/mongodb/lib/deps.js\n             * Module not found: Can't resolve 'aws4' in '/Users/alessio/Documents/temp/next16p/node_modules/.pnpm/mongodb@6.16.0/node_modules/mongodb/lib'\n             *\n             * Import trace for requested module:\n             * ./node_modules/.pnpm/mongodb@6.16.0/node_modules/mongodb/lib/deps.js\n             * ./node_modules/.pnpm/mongodb@6.16.0/node_modules/mongodb/lib/client-side-encryption/client_encryption.js\n             * ./node_modules/.pnpm/mongodb@6.16.0/node_modules/mongodb/lib/index.js\n             * ./node_modules/.pnpm/mongoose@8.15.1/node_modules/mongoose/lib/index.js\n             * ./node_modules/.pnpm/mongoose@8.15.1/node_modules/mongoose/index.js\n             * ./node_modules/.pnpm/@payloadcms+db-mongodb@3.64.0_payload@3.64.0_graphql@16.12.0_typescript@5.7.3_/node_modules/@payloadcms/db-mongodb/dist/index.js\n             * ./src/payload.config.ts\n             * ./src/app/my-route/route.ts\n             *\n             **/\n            aws4: false,\n          },\n        },\n      }\n    },\n  }\n\n  if (nextConfig.basePath) {\n    process.env.NEXT_BASE_PATH = nextConfig.basePath\n    baseConfig.env.NEXT_BASE_PATH = nextConfig.basePath\n  }\n\n  if (!supportsTurbopackBuild) {\n    return withPayloadLegacy(baseConfig)\n  } else {\n    return {\n      ...baseConfig,\n      serverExternalPackages: [\n        ...(baseConfig.serverExternalPackages || []),\n        'drizzle-kit',\n        'drizzle-kit/api',\n        'sharp',\n        'libsql',\n        'require-in-the-middle',\n        // Prevents turbopack build errors by the thread-stream package which is installed by pino\n        'pino',\n      ],\n    }\n  }\n}\n\nexport default withPayload\n"],"mappings":"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","ignoreList":[]}