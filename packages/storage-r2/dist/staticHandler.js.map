{"version":3,"sources":["../src/staticHandler.ts"],"sourcesContent":["import type { StaticHandler } from '@payloadcms/plugin-cloud-storage/types'\nimport type { CollectionConfig } from 'payload'\n\nimport path from 'path'\nimport { getRangeRequestInfo } from 'payload/internal'\n\nimport type { R2Bucket } from './types.js'\n\ninterface Args {\n  bucket: R2Bucket\n  collection: CollectionConfig\n  prefix?: string\n}\n\nconst isMiniflare = process.env.NODE_ENV === 'development'\n\nexport const getHandler = ({ bucket, collection, prefix = '' }: Args): StaticHandler => {\n  return async (req, { headers: incomingHeaders, params: { filename } }) => {\n    try {\n      const key = path.posix.join(prefix, filename)\n\n      // Get file size for range validation\n      const headObj = await bucket?.head(key)\n      if (!headObj) {\n        return new Response(null, { status: 404, statusText: 'Not Found' })\n      }\n\n      const fileSize = headObj.size\n\n      // Handle range request\n      const rangeHeader = req.headers.get('range')\n      const rangeResult = getRangeRequestInfo({ fileSize, rangeHeader })\n\n      if (rangeResult.type === 'invalid') {\n        return new Response(null, {\n          headers: new Headers(rangeResult.headers),\n          status: rangeResult.status,\n        })\n      }\n\n      // Get object with range if needed\n      // Due to https://github.com/cloudflare/workers-sdk/issues/6047\n      // We cannot send a Headers instance to Miniflare\n      const obj =\n        rangeResult.type === 'partial' && !isMiniflare\n          ? await bucket?.get(key, {\n              range: {\n                length: rangeResult.rangeEnd - rangeResult.rangeStart + 1,\n                offset: rangeResult.rangeStart,\n              },\n            })\n          : await bucket?.get(key)\n\n      if (obj?.body == undefined) {\n        return new Response(null, { status: 404, statusText: 'Not Found' })\n      }\n\n      let headers = new Headers(incomingHeaders)\n\n      // Add range-related headers from the result\n      for (const [key, value] of Object.entries(rangeResult.headers)) {\n        headers.append(key, value)\n      }\n\n      // Add R2-specific headers\n      if (!isMiniflare) {\n        obj.writeHttpMetadata(headers)\n      }\n\n      const etagFromHeaders = req.headers.get('etag') || req.headers.get('if-none-match')\n\n      if (\n        collection.upload &&\n        typeof collection.upload === 'object' &&\n        typeof collection.upload.modifyResponseHeaders === 'function'\n      ) {\n        headers = collection.upload.modifyResponseHeaders({ headers }) || headers\n      }\n\n      if (etagFromHeaders && etagFromHeaders === obj.etag) {\n        return new Response(null, {\n          headers,\n          status: 304,\n        })\n      }\n\n      return new Response(obj.body, {\n        headers,\n        status: rangeResult.status,\n      })\n    } catch (err: unknown) {\n      return new Response('Internal Server Error', { status: 500 })\n    }\n  }\n}\n"],"names":["path","getRangeRequestInfo","isMiniflare","process","env","NODE_ENV","getHandler","bucket","collection","prefix","req","headers","incomingHeaders","params","filename","key","posix","join","headObj","head","Response","status","statusText","fileSize","size","rangeHeader","get","rangeResult","type","Headers","obj","range","length","rangeEnd","rangeStart","offset","body","undefined","value","Object","entries","append","writeHttpMetadata","etagFromHeaders","upload","modifyResponseHeaders","etag","err"],"mappings":"AAGA,OAAOA,UAAU,OAAM;AACvB,SAASC,mBAAmB,QAAQ,mBAAkB;AAUtD,MAAMC,cAAcC,QAAQC,GAAG,CAACC,QAAQ,KAAK;AAE7C,OAAO,MAAMC,aAAa,CAAC,EAAEC,MAAM,EAAEC,UAAU,EAAEC,SAAS,EAAE,EAAQ;IAClE,OAAO,OAAOC,KAAK,EAAEC,SAASC,eAAe,EAAEC,QAAQ,EAAEC,QAAQ,EAAE,EAAE;QACnE,IAAI;YACF,MAAMC,MAAMf,KAAKgB,KAAK,CAACC,IAAI,CAACR,QAAQK;YAEpC,qCAAqC;YACrC,MAAMI,UAAU,MAAMX,QAAQY,KAAKJ;YACnC,IAAI,CAACG,SAAS;gBACZ,OAAO,IAAIE,SAAS,MAAM;oBAAEC,QAAQ;oBAAKC,YAAY;gBAAY;YACnE;YAEA,MAAMC,WAAWL,QAAQM,IAAI;YAE7B,uBAAuB;YACvB,MAAMC,cAAcf,IAAIC,OAAO,CAACe,GAAG,CAAC;YACpC,MAAMC,cAAc1B,oBAAoB;gBAAEsB;gBAAUE;YAAY;YAEhE,IAAIE,YAAYC,IAAI,KAAK,WAAW;gBAClC,OAAO,IAAIR,SAAS,MAAM;oBACxBT,SAAS,IAAIkB,QAAQF,YAAYhB,OAAO;oBACxCU,QAAQM,YAAYN,MAAM;gBAC5B;YACF;YAEA,kCAAkC;YAClC,+DAA+D;YAC/D,iDAAiD;YACjD,MAAMS,MACJH,YAAYC,IAAI,KAAK,aAAa,CAAC1B,cAC/B,MAAMK,QAAQmB,IAAIX,KAAK;gBACrBgB,OAAO;oBACLC,QAAQL,YAAYM,QAAQ,GAAGN,YAAYO,UAAU,GAAG;oBACxDC,QAAQR,YAAYO,UAAU;gBAChC;YACF,KACA,MAAM3B,QAAQmB,IAAIX;YAExB,IAAIe,KAAKM,QAAQC,WAAW;gBAC1B,OAAO,IAAIjB,SAAS,MAAM;oBAAEC,QAAQ;oBAAKC,YAAY;gBAAY;YACnE;YAEA,IAAIX,UAAU,IAAIkB,QAAQjB;YAE1B,4CAA4C;YAC5C,KAAK,MAAM,CAACG,KAAKuB,MAAM,IAAIC,OAAOC,OAAO,CAACb,YAAYhB,OAAO,EAAG;gBAC9DA,QAAQ8B,MAAM,CAAC1B,KAAKuB;YACtB;YAEA,0BAA0B;YAC1B,IAAI,CAACpC,aAAa;gBAChB4B,IAAIY,iBAAiB,CAAC/B;YACxB;YAEA,MAAMgC,kBAAkBjC,IAAIC,OAAO,CAACe,GAAG,CAAC,WAAWhB,IAAIC,OAAO,CAACe,GAAG,CAAC;YAEnE,IACElB,WAAWoC,MAAM,IACjB,OAAOpC,WAAWoC,MAAM,KAAK,YAC7B,OAAOpC,WAAWoC,MAAM,CAACC,qBAAqB,KAAK,YACnD;gBACAlC,UAAUH,WAAWoC,MAAM,CAACC,qBAAqB,CAAC;oBAAElC;gBAAQ,MAAMA;YACpE;YAEA,IAAIgC,mBAAmBA,oBAAoBb,IAAIgB,IAAI,EAAE;gBACnD,OAAO,IAAI1B,SAAS,MAAM;oBACxBT;oBACAU,QAAQ;gBACV;YACF;YAEA,OAAO,IAAID,SAASU,IAAIM,IAAI,EAAE;gBAC5BzB;gBACAU,QAAQM,YAAYN,MAAM;YAC5B;QACF,EAAE,OAAO0B,KAAc;YACrB,OAAO,IAAI3B,SAAS,yBAAyB;gBAAEC,QAAQ;YAAI;QAC7D;IACF;AACF,EAAC"}