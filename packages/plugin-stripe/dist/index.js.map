{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import type { Config, Endpoint } from 'payload'\n\nimport type { SanitizedStripePluginConfig, StripePluginConfig } from './types.js'\n\nimport { getFields } from './fields/getFields.js'\nimport { createNewInStripe } from './hooks/createNewInStripe.js'\nimport { deleteFromStripe } from './hooks/deleteFromStripe.js'\nimport { syncExistingWithStripe } from './hooks/syncExistingWithStripe.js'\nimport { stripeREST } from './routes/rest.js'\nimport { stripeWebhooks } from './routes/webhooks.js'\n\nexport { stripeProxy } from './utilities/stripeProxy.js'\n\nexport const stripePlugin =\n  (incomingStripeConfig: StripePluginConfig) =>\n  (config: Config): Config => {\n    const { collections } = config\n\n    // set config defaults here\n    const pluginConfig: SanitizedStripePluginConfig = {\n      ...incomingStripeConfig,\n      rest: incomingStripeConfig?.rest ?? false,\n      sync: incomingStripeConfig?.sync || [],\n    }\n\n    // NOTE: env variables are never passed to the client, but we need to know if `stripeSecretKey` is a test key\n    // unfortunately we must set the 'isTestKey' property on the config instead of using the following code:\n    // const isTestKey = stripeConfig.stripeSecretKey?.startsWith('sk_test_');\n\n    const endpoints: Endpoint[] = [\n      ...(config?.endpoints || []),\n      {\n        handler: async (req) => {\n          const res = await stripeWebhooks({\n            config,\n            pluginConfig,\n            req,\n          })\n\n          return res\n        },\n        method: 'post',\n        path: '/stripe/webhooks',\n      },\n    ]\n\n    if (incomingStripeConfig?.rest) {\n      endpoints.push({\n        handler: async (req) => {\n          const res = await stripeREST({\n            pluginConfig,\n            req,\n          })\n\n          return res\n        },\n        method: 'post' as Endpoint['method'],\n        path: '/stripe/rest',\n      })\n    }\n\n    for (const collection of collections!) {\n      const { hooks: existingHooks } = collection\n\n      const syncConfig = pluginConfig.sync?.find((sync) => sync.collection === collection.slug)\n\n      if (!syncConfig) {\n        continue\n      }\n      const fields = getFields({\n        collection,\n        pluginConfig,\n        syncConfig,\n      })\n      collection.fields = fields\n\n      if (!collection.hooks) {\n        collection.hooks = {}\n      }\n\n      collection.hooks.afterDelete = [\n        ...(existingHooks?.afterDelete || []),\n        (args) =>\n          deleteFromStripe({\n            ...args,\n            collection,\n            pluginConfig,\n          }),\n      ]\n      collection.hooks.beforeChange = [\n        ...(existingHooks?.beforeChange || []),\n        (args) =>\n          syncExistingWithStripe({\n            ...args,\n            collection,\n            pluginConfig,\n          }),\n      ]\n      collection.hooks.beforeValidate = [\n        ...(existingHooks?.beforeValidate || []),\n        (args) =>\n          createNewInStripe({\n            ...args,\n            collection,\n            pluginConfig,\n          }),\n      ]\n    }\n\n    config.endpoints = endpoints\n\n    return config\n  }\n"],"names":["getFields","createNewInStripe","deleteFromStripe","syncExistingWithStripe","stripeREST","stripeWebhooks","stripeProxy","stripePlugin","incomingStripeConfig","config","collections","pluginConfig","rest","sync","endpoints","handler","req","res","method","path","push","collection","hooks","existingHooks","syncConfig","find","slug","fields","afterDelete","args","beforeChange","beforeValidate"],"mappings":"AAIA,SAASA,SAAS,QAAQ,wBAAuB;AACjD,SAASC,iBAAiB,QAAQ,+BAA8B;AAChE,SAASC,gBAAgB,QAAQ,8BAA6B;AAC9D,SAASC,sBAAsB,QAAQ,oCAAmC;AAC1E,SAASC,UAAU,QAAQ,mBAAkB;AAC7C,SAASC,cAAc,QAAQ,uBAAsB;AAErD,SAASC,WAAW,QAAQ,6BAA4B;AAExD,OAAO,MAAMC,eACX,CAACC,uBACD,CAACC;QACC,MAAM,EAAEC,WAAW,EAAE,GAAGD;QAExB,2BAA2B;QAC3B,MAAME,eAA4C;YAChD,GAAGH,oBAAoB;YACvBI,MAAMJ,sBAAsBI,QAAQ;YACpCC,MAAML,sBAAsBK,QAAQ,EAAE;QACxC;QAEA,6GAA6G;QAC7G,wGAAwG;QACxG,0EAA0E;QAE1E,MAAMC,YAAwB;eACxBL,QAAQK,aAAa,EAAE;YAC3B;gBACEC,SAAS,OAAOC;oBACd,MAAMC,MAAM,MAAMZ,eAAe;wBAC/BI;wBACAE;wBACAK;oBACF;oBAEA,OAAOC;gBACT;gBACAC,QAAQ;gBACRC,MAAM;YACR;SACD;QAED,IAAIX,sBAAsBI,MAAM;YAC9BE,UAAUM,IAAI,CAAC;gBACbL,SAAS,OAAOC;oBACd,MAAMC,MAAM,MAAMb,WAAW;wBAC3BO;wBACAK;oBACF;oBAEA,OAAOC;gBACT;gBACAC,QAAQ;gBACRC,MAAM;YACR;QACF;QAEA,KAAK,MAAME,cAAcX,YAAc;YACrC,MAAM,EAAEY,OAAOC,aAAa,EAAE,GAAGF;YAEjC,MAAMG,aAAab,aAAaE,IAAI,EAAEY,KAAK,CAACZ,OAASA,KAAKQ,UAAU,KAAKA,WAAWK,IAAI;YAExF,IAAI,CAACF,YAAY;gBACf;YACF;YACA,MAAMG,SAAS3B,UAAU;gBACvBqB;gBACAV;gBACAa;YACF;YACAH,WAAWM,MAAM,GAAGA;YAEpB,IAAI,CAACN,WAAWC,KAAK,EAAE;gBACrBD,WAAWC,KAAK,GAAG,CAAC;YACtB;YAEAD,WAAWC,KAAK,CAACM,WAAW,GAAG;mBACzBL,eAAeK,eAAe,EAAE;gBACpC,CAACC,OACC3B,iBAAiB;wBACf,GAAG2B,IAAI;wBACPR;wBACAV;oBACF;aACH;YACDU,WAAWC,KAAK,CAACQ,YAAY,GAAG;mBAC1BP,eAAeO,gBAAgB,EAAE;gBACrC,CAACD,OACC1B,uBAAuB;wBACrB,GAAG0B,IAAI;wBACPR;wBACAV;oBACF;aACH;YACDU,WAAWC,KAAK,CAACS,cAAc,GAAG;mBAC5BR,eAAeQ,kBAAkB,EAAE;gBACvC,CAACF,OACC5B,kBAAkB;wBAChB,GAAG4B,IAAI;wBACPR;wBACAV;oBACF;aACH;QACH;QAEAF,OAAOK,SAAS,GAAGA;QAEnB,OAAOL;IACT,EAAC"}