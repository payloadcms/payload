{"version":3,"sources":["../../src/hooks/deleteFromStripe.ts"],"sourcesContent":["import type { CollectionAfterDeleteHook, CollectionConfig } from 'payload'\n\nimport { APIError } from 'payload'\nimport Stripe from 'stripe'\n\nimport type { StripePluginConfig } from '../types.js'\n\ntype HookArgsWithCustomCollection = {\n  collection: CollectionConfig\n} & Omit<Parameters<CollectionAfterDeleteHook>[0], 'collection'>\n\nexport type CollectionAfterDeleteHookWithArgs = (\n  args: {\n    collection?: CollectionConfig\n    pluginConfig?: StripePluginConfig\n  } & HookArgsWithCustomCollection,\n) => Promise<void>\n\nexport const deleteFromStripe: CollectionAfterDeleteHookWithArgs = async (args) => {\n  const { collection, doc, pluginConfig, req } = args\n\n  const { logs, sync } = pluginConfig || {}\n\n  const { payload } = req\n  const { slug: collectionSlug } = collection || {}\n\n  if (logs) {\n    payload.logger.info(\n      `Document with ID: '${doc?.id}' in collection: '${collectionSlug}' has been deleted, deleting from Stripe...`,\n    )\n  }\n\n  if (process.env.NODE_ENV !== 'test') {\n    if (logs) {\n      payload.logger.info(`- Deleting Stripe document with ID: '${doc.stripeID}'...`)\n    }\n\n    const syncConfig = sync?.find((conf) => conf.collection === collectionSlug)\n\n    if (syncConfig) {\n      try {\n        // api version can only be the latest, stripe recommends ts ignoring it\n        const stripe = new Stripe(pluginConfig?.stripeSecretKey || '', { apiVersion: '2022-08-01' })\n\n        const found = await stripe?.[syncConfig.stripeResourceType]?.retrieve(doc.stripeID)\n\n        if (found) {\n          await stripe?.[syncConfig.stripeResourceType]?.del(doc.stripeID)\n          if (logs) {\n            payload.logger.info(\n              `âœ… Successfully deleted Stripe document with ID: '${doc.stripeID}'.`,\n            )\n          }\n        } else {\n          if (logs) {\n            payload.logger.info(\n              `- Stripe document with ID: '${doc.stripeID}' not found, skipping...`,\n            )\n          }\n        }\n      } catch (error: unknown) {\n        const msg = error instanceof Error ? error.message : error\n        throw new APIError(`Failed to delete Stripe document with ID: '${doc.stripeID}': ${msg}`)\n      }\n    }\n  }\n}\n"],"names":["APIError","Stripe","deleteFromStripe","args","collection","doc","pluginConfig","req","logs","sync","payload","slug","collectionSlug","logger","info","id","process","env","NODE_ENV","stripeID","syncConfig","find","conf","stripe","stripeSecretKey","apiVersion","found","stripeResourceType","retrieve","del","error","msg","Error","message"],"mappings":"AAEA,SAASA,QAAQ,QAAQ,UAAS;AAClC,OAAOC,YAAY,SAAQ;AAe3B,OAAO,MAAMC,mBAAsD,OAAOC;IACxE,MAAM,EAAEC,UAAU,EAAEC,GAAG,EAAEC,YAAY,EAAEC,GAAG,EAAE,GAAGJ;IAE/C,MAAM,EAAEK,IAAI,EAAEC,IAAI,EAAE,GAAGH,gBAAgB,CAAC;IAExC,MAAM,EAAEI,OAAO,EAAE,GAAGH;IACpB,MAAM,EAAEI,MAAMC,cAAc,EAAE,GAAGR,cAAc,CAAC;IAEhD,IAAII,MAAM;QACRE,QAAQG,MAAM,CAACC,IAAI,CACjB,CAAC,mBAAmB,EAAET,KAAKU,GAAG,kBAAkB,EAAEH,eAAe,2CAA2C,CAAC;IAEjH;IAEA,IAAII,QAAQC,GAAG,CAACC,QAAQ,KAAK,QAAQ;QACnC,IAAIV,MAAM;YACRE,QAAQG,MAAM,CAACC,IAAI,CAAC,CAAC,qCAAqC,EAAET,IAAIc,QAAQ,CAAC,IAAI,CAAC;QAChF;QAEA,MAAMC,aAAaX,MAAMY,KAAK,CAACC,OAASA,KAAKlB,UAAU,KAAKQ;QAE5D,IAAIQ,YAAY;YACd,IAAI;gBACF,uEAAuE;gBACvE,MAAMG,SAAS,IAAItB,OAAOK,cAAckB,mBAAmB,IAAI;oBAAEC,YAAY;gBAAa;gBAE1F,MAAMC,QAAQ,MAAMH,QAAQ,CAACH,WAAWO,kBAAkB,CAAC,EAAEC,SAASvB,IAAIc,QAAQ;gBAElF,IAAIO,OAAO;oBACT,MAAMH,QAAQ,CAACH,WAAWO,kBAAkB,CAAC,EAAEE,IAAIxB,IAAIc,QAAQ;oBAC/D,IAAIX,MAAM;wBACRE,QAAQG,MAAM,CAACC,IAAI,CACjB,CAAC,iDAAiD,EAAET,IAAIc,QAAQ,CAAC,EAAE,CAAC;oBAExE;gBACF,OAAO;oBACL,IAAIX,MAAM;wBACRE,QAAQG,MAAM,CAACC,IAAI,CACjB,CAAC,4BAA4B,EAAET,IAAIc,QAAQ,CAAC,wBAAwB,CAAC;oBAEzE;gBACF;YACF,EAAE,OAAOW,OAAgB;gBACvB,MAAMC,MAAMD,iBAAiBE,QAAQF,MAAMG,OAAO,GAAGH;gBACrD,MAAM,IAAI9B,SAAS,CAAC,2CAA2C,EAAEK,IAAIc,QAAQ,CAAC,GAAG,EAAEY,KAAK;YAC1F;QACF;IACF;AACF,EAAC"}