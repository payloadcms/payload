{"version":3,"sources":["../../src/hooks/createNewInStripe.ts"],"sourcesContent":["import type { CollectionBeforeValidateHook, CollectionConfig } from 'payload'\n\nimport { APIError } from 'payload'\nimport Stripe from 'stripe'\n\nimport type { StripePluginConfig } from '../types.js'\n\nimport { deepen } from '../utilities/deepen.js'\n\ntype HookArgsWithCustomCollection = {\n  collection: CollectionConfig\n} & Omit<Parameters<CollectionBeforeValidateHook>[0], 'collection'>\n\nexport type CollectionBeforeValidateHookWithArgs = (\n  args: {\n    collection?: CollectionConfig\n    pluginConfig?: StripePluginConfig\n  } & HookArgsWithCustomCollection,\n) => Promise<Partial<any>>\n\nexport const createNewInStripe: CollectionBeforeValidateHookWithArgs = async (args) => {\n  const { collection, data, operation, pluginConfig, req } = args\n\n  const { logs, sync } = pluginConfig || {}\n\n  const payload = req?.payload\n\n  const dataRef = data || {}\n\n  if (process.env.NODE_ENV === 'test') {\n    dataRef.stripeID = 'test'\n    return dataRef\n  }\n\n  if (payload) {\n    if (data?.skipSync) {\n      if (logs) {\n        payload.logger.info(`Bypassing collection-level hooks.`)\n      }\n    } else {\n      // initialize as 'false' so that all Payload admin events sync to Stripe\n      // then conditionally set to 'true' to for events that originate from webhooks\n      // this will prevent webhook events from triggering an unnecessary sync / infinite loop\n      dataRef.skipSync = false\n\n      const { slug: collectionSlug } = collection || {}\n      const syncConfig = sync?.find((conf) => conf.collection === collectionSlug)\n\n      if (syncConfig) {\n        // combine all fields of this object and match their respective values within the document\n        let syncedFields = syncConfig.fields.reduce(\n          (acc, field) => {\n            const { fieldPath, stripeProperty } = field\n\n            acc[stripeProperty] = dataRef[fieldPath]\n            return acc\n          },\n          {} as Record<string, any>,\n        )\n\n        syncedFields = deepen(syncedFields)\n\n        // api version can only be the latest, stripe recommends ts ignoring it\n        const stripe = new Stripe(pluginConfig?.stripeSecretKey || '', { apiVersion: '2022-08-01' })\n\n        if (operation === 'update') {\n          if (logs) {\n            payload.logger.info(\n              `A '${collectionSlug}' document has changed in Payload with ID: '${data?.id}', syncing with Stripe...`,\n            )\n          }\n\n          // NOTE: the Stripe document will be created in the \"afterChange\" hook, so create a new stripe document here if no stripeID exists\n          if (!dataRef.stripeID) {\n            try {\n              // NOTE: Typed as \"any\" because the \"create\" method is not standard across all Stripe resources\n              const stripeResource = await stripe?.[syncConfig.stripeResourceType]?.create(\n                // @ts-expect-error\n                syncedFields,\n              )\n\n              if (logs) {\n                payload.logger.info(\n                  `✅ Successfully created new '${syncConfig.stripeResourceType}' resource in Stripe with ID: '${stripeResource.id}'.`,\n                )\n              }\n\n              dataRef.stripeID = stripeResource.id\n\n              // NOTE: this is to prevent sync in the \"afterChange\" hook\n              dataRef.skipSync = true\n            } catch (error: unknown) {\n              const msg = error instanceof Error ? error.message : error\n              if (logs) {\n                payload.logger.error(`- Error creating Stripe document: ${msg}`)\n              }\n            }\n          }\n        }\n\n        if (operation === 'create') {\n          if (logs) {\n            payload.logger.info(\n              `A new '${collectionSlug}' document was created in Payload with ID: '${data?.id}', syncing with Stripe...`,\n            )\n          }\n\n          try {\n            if (logs) {\n              payload.logger.info(\n                `- Creating new '${syncConfig.stripeResourceType}' resource in Stripe...`,\n              )\n            }\n\n            // NOTE: Typed as \"any\" because the \"create\" method is not standard across all Stripe resources\n            const stripeResource = await stripe?.[syncConfig.stripeResourceType]?.create(\n              // @ts-expect-error\n              syncedFields,\n            )\n\n            if (logs) {\n              payload.logger.info(\n                `✅ Successfully created new '${syncConfig.stripeResourceType}' resource in Stripe with ID: '${stripeResource.id}'.`,\n              )\n            }\n\n            dataRef.stripeID = stripeResource.id\n\n            // IMPORTANT: this is to prevent sync in the \"afterChange\" hook\n            dataRef.skipSync = true\n          } catch (error: unknown) {\n            const msg = error instanceof Error ? error.message : error\n            throw new APIError(\n              `Failed to create new '${syncConfig.stripeResourceType}' resource in Stripe: ${msg}`,\n            )\n          }\n        }\n      }\n    }\n  }\n\n  return dataRef\n}\n"],"names":["APIError","Stripe","deepen","createNewInStripe","args","collection","data","operation","pluginConfig","req","logs","sync","payload","dataRef","process","env","NODE_ENV","stripeID","skipSync","logger","info","slug","collectionSlug","syncConfig","find","conf","syncedFields","fields","reduce","acc","field","fieldPath","stripeProperty","stripe","stripeSecretKey","apiVersion","id","stripeResource","stripeResourceType","create","error","msg","Error","message"],"mappings":"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"}