{"version":3,"sources":["../../src/hooks/syncExistingWithStripe.ts"],"sourcesContent":["import type { CollectionBeforeChangeHook, CollectionConfig } from 'payload'\n\nimport { APIError } from 'payload'\nimport Stripe from 'stripe'\n\nimport type { StripePluginConfig } from '../types.js'\n\nimport { deepen } from '../utilities/deepen.js'\n\ntype HookArgsWithCustomCollection = {\n  collection: CollectionConfig\n} & Omit<Parameters<CollectionBeforeChangeHook>[0], 'collection'>\n\nexport type CollectionBeforeChangeHookWithArgs = (\n  args: {\n    collection?: CollectionConfig\n    pluginConfig?: StripePluginConfig\n  } & HookArgsWithCustomCollection,\n) => Promise<Partial<any>>\n\nexport const syncExistingWithStripe: CollectionBeforeChangeHookWithArgs = async (args) => {\n  const { collection, data, operation, originalDoc, pluginConfig, req } = args\n\n  const { logs, sync } = pluginConfig || {}\n\n  const { payload } = req\n\n  const { slug: collectionSlug } = collection || {}\n\n  if (process.env.NODE_ENV !== 'test' && !data.skipSync) {\n    const syncConfig = sync?.find((conf) => conf.collection === collectionSlug)\n\n    if (syncConfig) {\n      if (operation === 'update') {\n        // combine all fields of this object and match their respective values within the document\n        let syncedFields = syncConfig.fields.reduce(\n          (acc, field) => {\n            const { fieldPath, stripeProperty } = field\n\n            acc[stripeProperty] = data[fieldPath]\n            return acc\n          },\n          {} as Record<string, any>,\n        )\n\n        syncedFields = deepen(syncedFields)\n\n        if (logs) {\n          payload.logger.info(\n            `A '${collectionSlug}' document has changed in Payload with ID: '${originalDoc?._id}', syncing with Stripe...`,\n          )\n        }\n\n        if (!data.stripeID) {\n          // NOTE: the \"beforeValidate\" hook populates this\n          if (logs) {\n            payload.logger.error(`- There is no Stripe ID for this document, skipping.`)\n          }\n        } else {\n          if (logs) {\n            payload.logger.info(`- Syncing to Stripe resource with ID: '${data.stripeID}'...`)\n          }\n\n          try {\n            // api version can only be the latest, stripe recommends ts ignoring it\n            const stripe = new Stripe(pluginConfig?.stripeSecretKey || '', {\n              apiVersion: '2022-08-01',\n            })\n\n            const stripeResource = await stripe?.[syncConfig?.stripeResourceType]?.update(\n              data.stripeID,\n              syncedFields,\n            )\n\n            if (logs) {\n              payload.logger.info(\n                `âœ… Successfully synced Stripe resource with ID: '${stripeResource.id}'.`,\n              )\n            }\n          } catch (error: unknown) {\n            const msg = error instanceof Error ? error.message : error\n            throw new APIError(`Failed to sync document with ID: '${data.id}' to Stripe: ${msg}`)\n          }\n        }\n      }\n    }\n  }\n\n  // Set back to 'false' so that all changes continue to sync to Stripe, see note in './createNewInStripe.ts'\n  data.skipSync = false\n\n  return data\n}\n"],"names":["APIError","Stripe","deepen","syncExistingWithStripe","args","collection","data","operation","originalDoc","pluginConfig","req","logs","sync","payload","slug","collectionSlug","process","env","NODE_ENV","skipSync","syncConfig","find","conf","syncedFields","fields","reduce","acc","field","fieldPath","stripeProperty","logger","info","_id","stripeID","error","stripe","stripeSecretKey","apiVersion","stripeResource","stripeResourceType","update","id","msg","Error","message"],"mappings":"AAEA,SAASA,QAAQ,QAAQ,UAAS;AAClC,OAAOC,YAAY,SAAQ;AAI3B,SAASC,MAAM,QAAQ,yBAAwB;AAa/C,OAAO,MAAMC,yBAA6D,OAAOC;IAC/E,MAAM,EAAEC,UAAU,EAAEC,IAAI,EAAEC,SAAS,EAAEC,WAAW,EAAEC,YAAY,EAAEC,GAAG,EAAE,GAAGN;IAExE,MAAM,EAAEO,IAAI,EAAEC,IAAI,EAAE,GAAGH,gBAAgB,CAAC;IAExC,MAAM,EAAEI,OAAO,EAAE,GAAGH;IAEpB,MAAM,EAAEI,MAAMC,cAAc,EAAE,GAAGV,cAAc,CAAC;IAEhD,IAAIW,QAAQC,GAAG,CAACC,QAAQ,KAAK,UAAU,CAACZ,KAAKa,QAAQ,EAAE;QACrD,MAAMC,aAAaR,MAAMS,KAAK,CAACC,OAASA,KAAKjB,UAAU,KAAKU;QAE5D,IAAIK,YAAY;YACd,IAAIb,cAAc,UAAU;gBAC1B,0FAA0F;gBAC1F,IAAIgB,eAAeH,WAAWI,MAAM,CAACC,MAAM,CACzC,CAACC,KAAKC;oBACJ,MAAM,EAAEC,SAAS,EAAEC,cAAc,EAAE,GAAGF;oBAEtCD,GAAG,CAACG,eAAe,GAAGvB,IAAI,CAACsB,UAAU;oBACrC,OAAOF;gBACT,GACA,CAAC;gBAGHH,eAAerB,OAAOqB;gBAEtB,IAAIZ,MAAM;oBACRE,QAAQiB,MAAM,CAACC,IAAI,CACjB,CAAC,GAAG,EAAEhB,eAAe,4CAA4C,EAAEP,aAAawB,IAAI,yBAAyB,CAAC;gBAElH;gBAEA,IAAI,CAAC1B,KAAK2B,QAAQ,EAAE;oBAClB,iDAAiD;oBACjD,IAAItB,MAAM;wBACRE,QAAQiB,MAAM,CAACI,KAAK,CAAC,CAAC,oDAAoD,CAAC;oBAC7E;gBACF,OAAO;oBACL,IAAIvB,MAAM;wBACRE,QAAQiB,MAAM,CAACC,IAAI,CAAC,CAAC,uCAAuC,EAAEzB,KAAK2B,QAAQ,CAAC,IAAI,CAAC;oBACnF;oBAEA,IAAI;wBACF,uEAAuE;wBACvE,MAAME,SAAS,IAAIlC,OAAOQ,cAAc2B,mBAAmB,IAAI;4BAC7DC,YAAY;wBACd;wBAEA,MAAMC,iBAAiB,MAAMH,QAAQ,CAACf,YAAYmB,mBAAmB,EAAEC,OACrElC,KAAK2B,QAAQ,EACbV;wBAGF,IAAIZ,MAAM;4BACRE,QAAQiB,MAAM,CAACC,IAAI,CACjB,CAAC,gDAAgD,EAAEO,eAAeG,EAAE,CAAC,EAAE,CAAC;wBAE5E;oBACF,EAAE,OAAOP,OAAgB;wBACvB,MAAMQ,MAAMR,iBAAiBS,QAAQT,MAAMU,OAAO,GAAGV;wBACrD,MAAM,IAAIlC,SAAS,CAAC,kCAAkC,EAAEM,KAAKmC,EAAE,CAAC,aAAa,EAAEC,KAAK;oBACtF;gBACF;YACF;QACF;IACF;IAEA,2GAA2G;IAC3GpC,KAAKa,QAAQ,GAAG;IAEhB,OAAOb;AACT,EAAC"}