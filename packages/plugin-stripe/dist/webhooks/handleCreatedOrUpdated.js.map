{"version":3,"sources":["../../src/webhooks/handleCreatedOrUpdated.ts"],"sourcesContent":["import { v4 as uuid } from 'uuid'\n\nimport type { SanitizedStripePluginConfig, StripeWebhookHandler } from '../types.js'\n\nimport { deepen } from '../utilities/deepen.js'\n\ntype HandleCreatedOrUpdated = (\n  args: {\n    resourceType: string\n    syncConfig: SanitizedStripePluginConfig['sync'][0]\n  } & Parameters<StripeWebhookHandler>[0],\n) => Promise<void>\n\nexport const handleCreatedOrUpdated: HandleCreatedOrUpdated = async (args) => {\n  const { config: payloadConfig, event, payload, pluginConfig, resourceType, syncConfig } = args\n\n  const { logs } = pluginConfig || {}\n\n  const stripeDoc: any = event?.data?.object || {}\n\n  const { id: stripeID, object: eventObject } = stripeDoc\n\n  // NOTE: the Stripe API does not nest fields, everything is an object at the top level\n  // if the event object and resource type don't match, this change was not top-level\n  const isNestedChange = eventObject !== resourceType\n\n  // let stripeID = docID;\n  // if (isNestedChange) {\n  //   const parentResource = stripeDoc[resourceType];\n  //   stripeID = parentResource;\n  // }\n\n  if (isNestedChange) {\n    if (logs) {\n      payload.logger.info(\n        `- This change occurred on a nested field of ${resourceType}. Nested fields are not yet supported in auto-sync but can be manually setup.`,\n      )\n    }\n  }\n\n  if (!isNestedChange) {\n    if (logs) {\n      payload.logger.info(\n        `- A new document was created or updated in Stripe, now syncing to Payload...`,\n      )\n    }\n\n    const collectionSlug = syncConfig?.collection\n\n    const isAuthCollection = Boolean(\n      payloadConfig?.collections?.find((collection) => collection.slug === collectionSlug)?.auth,\n    )\n\n    // First, search for an existing document in Payload\n    const payloadQuery = await payload.find({\n      collection: collectionSlug,\n      limit: 1,\n      pagination: false,\n      where: {\n        stripeID: {\n          equals: stripeID,\n        },\n      },\n    })\n\n    const foundDoc = payloadQuery.docs[0] as any\n\n    // combine all properties of the Stripe doc and match their respective fields within the document\n    let syncedData = syncConfig.fields.reduce(\n      (acc, field) => {\n        const { fieldPath, stripeProperty } = field\n\n        acc[fieldPath] = stripeDoc[stripeProperty]\n        return acc\n      },\n      {} as Record<string, any>,\n    )\n\n    syncedData = deepen({\n      ...syncedData,\n      skipSync: true,\n      stripeID,\n    })\n\n    if (!foundDoc) {\n      if (logs) {\n        payload.logger.info(\n          `- No existing '${collectionSlug}' document found with Stripe ID: '${stripeID}', creating new...`,\n        )\n      }\n\n      // auth docs must use unique emails\n      let authDoc = null\n\n      if (isAuthCollection) {\n        try {\n          if (stripeDoc?.email) {\n            const authQuery = await payload.find({\n              collection: collectionSlug,\n              limit: 1,\n              pagination: false,\n              where: {\n                email: {\n                  equals: stripeDoc.email,\n                },\n              },\n            })\n\n            authDoc = authQuery.docs[0] as any\n\n            if (authDoc) {\n              if (logs) {\n                payload.logger.info(\n                  `- Account already exists with e-mail: ${stripeDoc.email}, updating now...`,\n                )\n              }\n\n              // account exists by email, so update it instead\n              try {\n                await payload.update({\n                  id: authDoc.id,\n                  collection: collectionSlug,\n                  data: syncedData,\n                })\n\n                if (logs) {\n                  payload.logger.info(\n                    `✅ Successfully updated '${collectionSlug}' document in Payload with ID: '${authDoc.id}.'`,\n                  )\n                }\n              } catch (err: unknown) {\n                const msg = err instanceof Error ? err.message : err\n                if (logs) {\n                  payload.logger.error(\n                    `- Error updating existing '${collectionSlug}' document: ${msg}`,\n                  )\n                }\n              }\n            }\n          } else {\n            if (logs) {\n              payload.logger.error(\n                `No email was provided from Stripe, cannot create new '${collectionSlug}' document.`,\n              )\n            }\n          }\n        } catch (error: unknown) {\n          const msg = error instanceof Error ? error.message : error\n          if (logs) {\n            payload.logger.error(`Error looking up '${collectionSlug}' document in Payload: ${msg}`)\n          }\n        }\n      }\n\n      if (!isAuthCollection || (isAuthCollection && !authDoc)) {\n        try {\n          if (logs) {\n            payload.logger.info(\n              `- Creating new '${collectionSlug}' document in Payload with Stripe ID: '${stripeID}'.`,\n            )\n          }\n\n          // generate a strong, unique password for the new user\n          const password: string = uuid()\n\n          await payload.create({\n            collection: collectionSlug,\n            data: {\n              ...syncedData,\n              password,\n              passwordConfirm: password,\n            },\n            disableVerificationEmail: isAuthCollection ? true : undefined,\n          })\n\n          if (logs) {\n            payload.logger.info(\n              `✅ Successfully created new '${collectionSlug}' document in Payload with Stripe ID: '${stripeID}'.`,\n            )\n          }\n        } catch (error: unknown) {\n          const msg = error instanceof Error ? error.message : error\n          if (logs) {\n            payload.logger.error(`Error creating new document in Payload: ${msg}`)\n          }\n        }\n      }\n    } else {\n      if (logs) {\n        payload.logger.info(\n          `- Existing '${collectionSlug}' document found in Payload with Stripe ID: '${stripeID}', updating now...`,\n        )\n      }\n\n      try {\n        await payload.update({\n          id: foundDoc.id,\n          collection: collectionSlug,\n          data: syncedData,\n        })\n\n        if (logs) {\n          payload.logger.info(\n            `✅ Successfully updated '${collectionSlug}' document in Payload from Stripe ID: '${stripeID}'.`,\n          )\n        }\n      } catch (error: unknown) {\n        const msg = error instanceof Error ? error.message : error\n        if (logs) {\n          payload.logger.error(`Error updating '${collectionSlug}' document in Payload: ${msg}`)\n        }\n      }\n    }\n  }\n}\n"],"names":["v4","uuid","deepen","handleCreatedOrUpdated","args","config","payloadConfig","event","payload","pluginConfig","resourceType","syncConfig","logs","stripeDoc","data","object","id","stripeID","eventObject","isNestedChange","logger","info","collectionSlug","collection","isAuthCollection","Boolean","collections","find","slug","auth","payloadQuery","limit","pagination","where","equals","foundDoc","docs","syncedData","fields","reduce","acc","field","fieldPath","stripeProperty","skipSync","authDoc","email","authQuery","update","err","msg","Error","message","error","password","create","passwordConfirm","disableVerificationEmail","undefined"],"mappings":"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"}