{"version":3,"sources":["../../../src/ui/PriceInput/FormattedInput.tsx"],"sourcesContent":["'use client'\n\nimport type { StaticDescription, StaticLabel } from 'payload'\n\nimport { FieldDescription, FieldLabel, useField, useFormFields } from '@payloadcms/ui'\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react'\n\nimport type { Currency } from '../../types/index.js'\n\nimport { USD } from '../../currencies/index.js'\nimport { convertFromBaseValue, convertToBaseValue } from '../utilities.js'\n\ninterface Props {\n  currency?: Currency\n  description?: StaticDescription\n  disabled?: boolean\n  error?: string\n  id?: string\n  label?: StaticLabel\n  path: string\n  placeholder?: string\n  readOnly?: boolean\n  supportedCurrencies: Currency[]\n}\n\nconst baseClass = 'formattedPrice'\n\nexport const FormattedInput: React.FC<Props> = ({\n  id: idFromProps,\n  currency: currencyFromProps,\n  description,\n  disabled = false,\n  label,\n  path,\n  placeholder = '0.00',\n  readOnly,\n  supportedCurrencies,\n}) => {\n  const { setValue, value } = useField<number>({ path })\n  const [displayValue, setDisplayValue] = useState<string>('')\n\n  const inputRef = useRef<HTMLInputElement>(null)\n  const isFirstRender = useRef(true)\n  const debounceTimer = useRef<NodeJS.Timeout | null>(null)\n\n  const parentPath = path.split('.').slice(0, -1).join('.')\n  const currencyPath = parentPath ? `${parentPath}.currency` : 'currency'\n\n  const currencyFromSelectField = useFormFields(([fields, _]) => fields[currencyPath])\n\n  const currencyCode = currencyFromProps?.code ?? (currencyFromSelectField?.value as string)\n  const id = idFromProps || path\n\n  const currency = useMemo<Currency>(() => {\n    if (currencyCode && supportedCurrencies) {\n      const foundCurrency = supportedCurrencies.find(\n        (supportedCurrency) => supportedCurrency.code === currencyCode,\n      )\n\n      return foundCurrency ?? supportedCurrencies[0] ?? USD\n    }\n\n    return supportedCurrencies[0] ?? USD\n  }, [currencyCode, supportedCurrencies])\n\n  useEffect(() => {\n    if (isFirstRender.current) {\n      isFirstRender.current = false\n\n      if (value === undefined || value === null) {\n        setDisplayValue('')\n      } else {\n        setDisplayValue(convertFromBaseValue({ baseValue: value, currency }))\n      }\n    }\n  }, [currency, value, currencyFromProps])\n\n  const updateValue = useCallback(\n    (inputValue: string) => {\n      if (inputValue === '') {\n        setValue(null)\n\n        return\n      }\n\n      const baseValue = convertToBaseValue({ currency, displayValue: inputValue })\n\n      setValue(baseValue)\n    },\n    [currency, setValue],\n  )\n\n  const handleInputChange = useCallback(\n    (e: React.ChangeEvent<HTMLInputElement>) => {\n      const inputValue = e.target.value\n\n      if (!/^\\d*(?:\\.\\d*)?$/.test(inputValue) && inputValue !== '') {\n        return\n      }\n\n      setDisplayValue(inputValue)\n\n      // Clear any existing timer\n      if (debounceTimer.current) {\n        clearTimeout(debounceTimer.current)\n      }\n\n      // Only update the base value after a delay to avoid formatting while typing\n      debounceTimer.current = setTimeout(() => {\n        updateValue(inputValue)\n      }, 500)\n    },\n    [updateValue, setDisplayValue],\n  )\n\n  const handleInputBlur = useCallback(() => {\n    if (displayValue === '') {\n      return\n    }\n\n    // Clear any pending debounce\n    if (debounceTimer.current) {\n      clearTimeout(debounceTimer.current)\n      debounceTimer.current = null\n    }\n\n    const baseValue = convertToBaseValue({ currency, displayValue })\n    const formattedValue = convertFromBaseValue({ baseValue, currency })\n\n    if (value != baseValue) {\n      setValue(baseValue)\n    }\n\n    setDisplayValue(formattedValue)\n  }, [currency, displayValue, setValue, value])\n\n  return (\n    <div className={`field-type number ${baseClass}`}>\n      {label && <FieldLabel as=\"label\" htmlFor={id} label={label} />}\n\n      <div className={`${baseClass}Container`}>\n        <div className={`${baseClass}CurrencySymbol`}>\n          <span>{currency.symbol}</span>\n        </div>\n\n        {/* eslint-disable-next-line jsx-a11y/control-has-associated-label */}\n        <input\n          className={`${baseClass}Input`}\n          disabled={disabled || readOnly}\n          id={id}\n          onBlur={handleInputBlur}\n          onChange={handleInputChange}\n          placeholder={placeholder}\n          ref={inputRef}\n          type=\"text\"\n          value={displayValue}\n        />\n      </div>\n      <FieldDescription\n        className={`${baseClass}Description`}\n        description={description}\n        path={path}\n      />\n    </div>\n  )\n}\n"],"names":["FieldDescription","FieldLabel","useField","useFormFields","useCallback","useEffect","useMemo","useRef","useState","USD","convertFromBaseValue","convertToBaseValue","baseClass","FormattedInput","id","idFromProps","currency","currencyFromProps","description","disabled","label","path","placeholder","readOnly","supportedCurrencies","setValue","value","displayValue","setDisplayValue","inputRef","isFirstRender","debounceTimer","parentPath","split","slice","join","currencyPath","currencyFromSelectField","fields","_","currencyCode","code","foundCurrency","find","supportedCurrency","current","undefined","baseValue","updateValue","inputValue","handleInputChange","e","target","test","clearTimeout","setTimeout","handleInputBlur","formattedValue","div","className","as","htmlFor","span","symbol","input","onBlur","onChange","ref","type"],"mappings":"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"}