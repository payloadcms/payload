{"version":3,"sources":["../../../../src/payments/adapters/stripe/initiatePayment.ts"],"sourcesContent":["import Stripe from 'stripe'\n\nimport type { PaymentAdapter } from '../../../types/index.js'\nimport type { InitiatePaymentReturnType, StripeAdapterArgs } from './index.js'\n\ntype Props = {\n  apiVersion?: Stripe.StripeConfig['apiVersion']\n  appInfo?: Stripe.StripeConfig['appInfo']\n  secretKey: StripeAdapterArgs['secretKey']\n}\n\nexport const initiatePayment: (props: Props) => NonNullable<PaymentAdapter>['initiatePayment'] =\n  (props) =>\n  async ({ data, req, transactionsSlug }) => {\n    const payload = req.payload\n    const { apiVersion, appInfo, secretKey } = props || {}\n\n    const customerEmail = data.customerEmail\n    const currency = data.currency\n    const cart = data.cart\n    const amount = cart.subtotal\n    const billingAddressFromData = data.billingAddress\n    const shippingAddressFromData = data.shippingAddress\n\n    if (!secretKey) {\n      throw new Error('Stripe secret key is required.')\n    }\n\n    if (!currency) {\n      throw new Error('Currency is required.')\n    }\n\n    if (!cart || !cart.items || cart.items.length === 0) {\n      throw new Error('Cart is empty or not provided.')\n    }\n\n    if (!customerEmail || typeof customerEmail !== 'string') {\n      throw new Error('A valid customer email is required to make a purchase.')\n    }\n\n    if (!amount || typeof amount !== 'number' || amount <= 0) {\n      throw new Error('A valid amount is required to initiate a payment.')\n    }\n\n    const stripe = new Stripe(secretKey, {\n      // API version can only be the latest, stripe recommends ts ignoring it\n      // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n      // @ts-ignore - ignoring since possible versions are not type safe, only the latest version is recognised\n      apiVersion: apiVersion || '2025-06-30.preview',\n      appInfo: appInfo || {\n        name: 'Stripe Payload Plugin',\n        url: 'https://payloadcms.com',\n      },\n    })\n\n    try {\n      let customer = (\n        await stripe.customers.list({\n          email: customerEmail,\n        })\n      ).data[0]\n\n      if (!customer?.id) {\n        customer = await stripe.customers.create({\n          email: customerEmail,\n        })\n      }\n\n      const flattenedCart = cart.items.map((item) => {\n        const productID = typeof item.product === 'object' ? item.product.id : item.product\n        const variantID = item.variant\n          ? typeof item.variant === 'object'\n            ? item.variant.id\n            : item.variant\n          : undefined\n\n        // Preserve any additional custom properties (e.g., deliveryOption, customizations)\n        // that may have been added via cartItemMatcher\n        const { product: _product, variant: _variant, ...customProperties } = item\n\n        return {\n          ...customProperties,\n          product: productID,\n          quantity: item.quantity,\n          ...(variantID ? { variant: variantID } : {}),\n        }\n      })\n\n      const shippingAddressAsString = JSON.stringify(shippingAddressFromData)\n\n      const paymentIntent = await stripe.paymentIntents.create({\n        amount,\n        automatic_payment_methods: {\n          enabled: true,\n        },\n        currency,\n        customer: customer.id,\n        metadata: {\n          cartID: cart.id,\n          cartItemsSnapshot: JSON.stringify(flattenedCart),\n          shippingAddress: shippingAddressAsString,\n        },\n      })\n\n      // Create a transaction for the payment intent in the database\n      const transaction = await payload.create({\n        collection: transactionsSlug,\n        data: {\n          ...(req.user ? { customer: req.user.id } : { customerEmail }),\n          amount: paymentIntent.amount,\n          billingAddress: billingAddressFromData,\n          cart: cart.id,\n          currency: paymentIntent.currency.toUpperCase(),\n          items: flattenedCart,\n          paymentMethod: 'stripe',\n          status: 'pending',\n          stripe: {\n            customerID: customer.id,\n            paymentIntentID: paymentIntent.id,\n          },\n        },\n      })\n\n      const returnData: InitiatePaymentReturnType = {\n        clientSecret: paymentIntent.client_secret || '',\n        message: 'Payment initiated successfully',\n        paymentIntentID: paymentIntent.id,\n      }\n\n      return returnData\n    } catch (error) {\n      payload.logger.error(error, 'Error initiating payment with Stripe')\n\n      throw new Error(error instanceof Error ? error.message : 'Unknown error initiating payment')\n    }\n  }\n"],"names":["Stripe","initiatePayment","props","data","req","transactionsSlug","payload","apiVersion","appInfo","secretKey","customerEmail","currency","cart","amount","subtotal","billingAddressFromData","billingAddress","shippingAddressFromData","shippingAddress","Error","items","length","stripe","name","url","customer","customers","list","email","id","create","flattenedCart","map","item","productID","product","variantID","variant","undefined","_product","_variant","customProperties","quantity","shippingAddressAsString","JSON","stringify","paymentIntent","paymentIntents","automatic_payment_methods","enabled","metadata","cartID","cartItemsSnapshot","transaction","collection","user","toUpperCase","paymentMethod","status","customerID","paymentIntentID","returnData","clientSecret","client_secret","message","error","logger"],"mappings":"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"}