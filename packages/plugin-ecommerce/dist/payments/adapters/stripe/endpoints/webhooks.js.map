{"version":3,"sources":["../../../../../src/payments/adapters/stripe/endpoints/webhooks.ts"],"sourcesContent":["import type { Endpoint } from 'payload'\n\nimport Stripe from 'stripe'\n\nimport type { StripeAdapterArgs } from '../index.js'\n\ntype Props = {\n  apiVersion?: Stripe.StripeConfig['apiVersion']\n  appInfo?: Stripe.StripeConfig['appInfo']\n  secretKey: StripeAdapterArgs['secretKey']\n  webhooks?: StripeAdapterArgs['webhooks']\n  webhookSecret: StripeAdapterArgs['webhookSecret']\n}\n\nexport const webhooksEndpoint: (props: Props) => Endpoint = (props) => {\n  const { apiVersion, appInfo, secretKey, webhooks, webhookSecret } = props || {}\n\n  const handler: Endpoint['handler'] = async (req) => {\n    let returnStatus = 200\n\n    if (webhookSecret && secretKey && req.text) {\n      const stripe = new Stripe(secretKey, {\n        // API version can only be the latest, stripe recommends ts ignoring it\n        // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n        // @ts-ignore - ignoring since possible versions are not type safe, only the latest version is recognised\n        apiVersion: apiVersion || '2025-03-31.basil',\n        appInfo: appInfo || {\n          name: 'Stripe Payload Plugin',\n          url: 'https://payloadcms.com',\n        },\n      })\n\n      const body = await req.text()\n      const stripeSignature = req.headers.get('stripe-signature')\n\n      if (stripeSignature) {\n        let event: Stripe.Event | undefined\n\n        try {\n          event = stripe.webhooks.constructEvent(body, stripeSignature, webhookSecret)\n        } catch (err: unknown) {\n          const msg: string = err instanceof Error ? err.message : JSON.stringify(err)\n          req.payload.logger.error(`Error constructing Stripe event: ${msg}`)\n          returnStatus = 400\n        }\n\n        if (typeof webhooks === 'object' && event) {\n          const webhookEventHandler = webhooks[event.type]\n\n          if (typeof webhookEventHandler === 'function') {\n            await webhookEventHandler({\n              event,\n              req,\n              stripe,\n            })\n          }\n        }\n      }\n    }\n\n    return Response.json({ received: true }, { status: returnStatus })\n  }\n\n  return {\n    handler,\n    method: 'post',\n    path: '/webhooks',\n  }\n}\n"],"names":["Stripe","webhooksEndpoint","props","apiVersion","appInfo","secretKey","webhooks","webhookSecret","handler","req","returnStatus","text","stripe","name","url","body","stripeSignature","headers","get","event","constructEvent","err","msg","Error","message","JSON","stringify","payload","logger","error","webhookEventHandler","type","Response","json","received","status","method","path"],"mappings":"AAEA,OAAOA,YAAY,SAAQ;AAY3B,OAAO,MAAMC,mBAA+C,CAACC;IAC3D,MAAM,EAAEC,UAAU,EAAEC,OAAO,EAAEC,SAAS,EAAEC,QAAQ,EAAEC,aAAa,EAAE,GAAGL,SAAS,CAAC;IAE9E,MAAMM,UAA+B,OAAOC;QAC1C,IAAIC,eAAe;QAEnB,IAAIH,iBAAiBF,aAAaI,IAAIE,IAAI,EAAE;YAC1C,MAAMC,SAAS,IAAIZ,OAAOK,WAAW;gBACnC,uEAAuE;gBACvE,6DAA6D;gBAC7D,yGAAyG;gBACzGF,YAAYA,cAAc;gBAC1BC,SAASA,WAAW;oBAClBS,MAAM;oBACNC,KAAK;gBACP;YACF;YAEA,MAAMC,OAAO,MAAMN,IAAIE,IAAI;YAC3B,MAAMK,kBAAkBP,IAAIQ,OAAO,CAACC,GAAG,CAAC;YAExC,IAAIF,iBAAiB;gBACnB,IAAIG;gBAEJ,IAAI;oBACFA,QAAQP,OAAON,QAAQ,CAACc,cAAc,CAACL,MAAMC,iBAAiBT;gBAChE,EAAE,OAAOc,KAAc;oBACrB,MAAMC,MAAcD,eAAeE,QAAQF,IAAIG,OAAO,GAAGC,KAAKC,SAAS,CAACL;oBACxEZ,IAAIkB,OAAO,CAACC,MAAM,CAACC,KAAK,CAAC,CAAC,iCAAiC,EAAEP,KAAK;oBAClEZ,eAAe;gBACjB;gBAEA,IAAI,OAAOJ,aAAa,YAAYa,OAAO;oBACzC,MAAMW,sBAAsBxB,QAAQ,CAACa,MAAMY,IAAI,CAAC;oBAEhD,IAAI,OAAOD,wBAAwB,YAAY;wBAC7C,MAAMA,oBAAoB;4BACxBX;4BACAV;4BACAG;wBACF;oBACF;gBACF;YACF;QACF;QAEA,OAAOoB,SAASC,IAAI,CAAC;YAAEC,UAAU;QAAK,GAAG;YAAEC,QAAQzB;QAAa;IAClE;IAEA,OAAO;QACLF;QACA4B,QAAQ;QACRC,MAAM;IACR;AACF,EAAC"}