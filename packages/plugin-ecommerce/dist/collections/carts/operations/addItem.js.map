{"version":3,"sources":["../../../../src/collections/carts/operations/addItem.ts"],"sourcesContent":["import type { AddItemArgs, CartItemData, CartOperationResult } from './types.js'\n\nimport { createRequestWithSecret } from './createRequestWithSecret.js'\nimport { defaultCartItemMatcher } from './defaultCartItemMatcher.js'\n\n/**\n * Adds an item to a cart. If an item matching the same criteria already exists,\n * its quantity is incremented instead of creating a duplicate entry.\n *\n * This handler is isolated and can be used from:\n * - Custom endpoints\n * - Local API operations\n * - Hooks\n *\n * @example\n * ```ts\n * // From an endpoint or hook\n * const result = await addItem({\n *   payload,\n *   cartsSlug: 'carts',\n *   cartID: '123',\n *   item: { product: 'prod-1', variant: 'var-1' },\n *   quantity: 2,\n * })\n * ```\n */\nexport const addItem = async (args: AddItemArgs): Promise<CartOperationResult> => {\n  const {\n    cartID,\n    cartItemMatcher = defaultCartItemMatcher,\n    cartsSlug,\n    item,\n    payload,\n    quantity = 1,\n    req,\n    secret,\n  } = args\n\n  // Inject secret into request context for access control\n  const reqWithSecret = createRequestWithSecret(req, secret)\n\n  const cart = await payload.findByID({\n    id: cartID,\n    collection: cartsSlug,\n    depth: 0,\n    overrideAccess: false,\n    req: reqWithSecret,\n  })\n\n  if (!cart) {\n    return {\n      cart: null,\n      message: `Cart with ID ${cartID} not found`,\n      success: false,\n    }\n  }\n\n  const existingItems: CartItemData[] = (cart.items as CartItemData[]) || []\n\n  // Find if item already exists using the matcher\n  const existingItemIndex = existingItems.findIndex((existingItem) =>\n    cartItemMatcher({ existingItem, newItem: item }),\n  )\n\n  let updatedItems: CartItemData[]\n\n  if (existingItemIndex !== -1) {\n    // Item exists - increment quantity\n    updatedItems = [...existingItems]\n    const existingItem = updatedItems[existingItemIndex]!\n    updatedItems[existingItemIndex] = {\n      ...existingItem,\n      quantity: existingItem.quantity + quantity,\n    }\n  } else {\n    // Item doesn't exist - add new item\n    const newItem: CartItemData = {\n      product: item.product,\n      quantity,\n      ...(item.variant ? { variant: item.variant } : {}),\n      // Spread any additional custom properties from the item\n      ...Object.fromEntries(\n        Object.entries(item).filter(([key]) => !['product', 'quantity', 'variant'].includes(key)),\n      ),\n    }\n    updatedItems = [...existingItems, newItem]\n  }\n\n  const updatedCart = await payload.update({\n    id: cartID,\n    collection: cartsSlug,\n    data: {\n      items: updatedItems,\n    },\n    depth: 0,\n    overrideAccess: false,\n    req: reqWithSecret,\n  })\n\n  return {\n    cart: updatedCart,\n    message: existingItemIndex !== -1 ? 'Item quantity updated' : 'Item added to cart',\n    success: true,\n  }\n}\n"],"names":["createRequestWithSecret","defaultCartItemMatcher","addItem","args","cartID","cartItemMatcher","cartsSlug","item","payload","quantity","req","secret","reqWithSecret","cart","findByID","id","collection","depth","overrideAccess","message","success","existingItems","items","existingItemIndex","findIndex","existingItem","newItem","updatedItems","product","variant","Object","fromEntries","entries","filter","key","includes","updatedCart","update","data"],"mappings":"AAEA,SAASA,uBAAuB,QAAQ,+BAA8B;AACtE,SAASC,sBAAsB,QAAQ,8BAA6B;AAEpE;;;;;;;;;;;;;;;;;;;;CAoBC,GACD,OAAO,MAAMC,UAAU,OAAOC;IAC5B,MAAM,EACJC,MAAM,EACNC,kBAAkBJ,sBAAsB,EACxCK,SAAS,EACTC,IAAI,EACJC,OAAO,EACPC,WAAW,CAAC,EACZC,GAAG,EACHC,MAAM,EACP,GAAGR;IAEJ,wDAAwD;IACxD,MAAMS,gBAAgBZ,wBAAwBU,KAAKC;IAEnD,MAAME,OAAO,MAAML,QAAQM,QAAQ,CAAC;QAClCC,IAAIX;QACJY,YAAYV;QACZW,OAAO;QACPC,gBAAgB;QAChBR,KAAKE;IACP;IAEA,IAAI,CAACC,MAAM;QACT,OAAO;YACLA,MAAM;YACNM,SAAS,CAAC,aAAa,EAAEf,OAAO,UAAU,CAAC;YAC3CgB,SAAS;QACX;IACF;IAEA,MAAMC,gBAAgC,AAACR,KAAKS,KAAK,IAAuB,EAAE;IAE1E,gDAAgD;IAChD,MAAMC,oBAAoBF,cAAcG,SAAS,CAAC,CAACC,eACjDpB,gBAAgB;YAAEoB;YAAcC,SAASnB;QAAK;IAGhD,IAAIoB;IAEJ,IAAIJ,sBAAsB,CAAC,GAAG;QAC5B,mCAAmC;QACnCI,eAAe;eAAIN;SAAc;QACjC,MAAMI,eAAeE,YAAY,CAACJ,kBAAkB;QACpDI,YAAY,CAACJ,kBAAkB,GAAG;YAChC,GAAGE,YAAY;YACfhB,UAAUgB,aAAahB,QAAQ,GAAGA;QACpC;IACF,OAAO;QACL,oCAAoC;QACpC,MAAMiB,UAAwB;YAC5BE,SAASrB,KAAKqB,OAAO;YACrBnB;YACA,GAAIF,KAAKsB,OAAO,GAAG;gBAAEA,SAAStB,KAAKsB,OAAO;YAAC,IAAI,CAAC,CAAC;YACjD,wDAAwD;YACxD,GAAGC,OAAOC,WAAW,CACnBD,OAAOE,OAAO,CAACzB,MAAM0B,MAAM,CAAC,CAAC,CAACC,IAAI,GAAK,CAAC;oBAAC;oBAAW;oBAAY;iBAAU,CAACC,QAAQ,CAACD,MACrF;QACH;QACAP,eAAe;eAAIN;YAAeK;SAAQ;IAC5C;IAEA,MAAMU,cAAc,MAAM5B,QAAQ6B,MAAM,CAAC;QACvCtB,IAAIX;QACJY,YAAYV;QACZgC,MAAM;YACJhB,OAAOK;QACT;QACAV,OAAO;QACPC,gBAAgB;QAChBR,KAAKE;IACP;IAEA,OAAO;QACLC,MAAMuB;QACNjB,SAASI,sBAAsB,CAAC,IAAI,0BAA0B;QAC9DH,SAAS;IACX;AACF,EAAC"}