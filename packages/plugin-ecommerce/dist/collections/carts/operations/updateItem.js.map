{"version":3,"sources":["../../../../src/collections/carts/operations/updateItem.ts"],"sourcesContent":["import type { CartItemData, CartOperationResult, UpdateItemArgs } from './types.js'\n\nimport { createRequestWithSecret } from './createRequestWithSecret.js'\nimport { isNumericOperator } from './types.js'\n\n/**\n * Updates an item in the cart using MongoDB-style operators.\n *\n * This handler is isolated and can be used from:\n * - Custom endpoints\n * - Local API operations\n * - Hooks\n *\n * @example\n * ```ts\n * // Set quantity to 5\n * const result = await updateItem({\n *   payload,\n *   cartsSlug: 'carts',\n *   cartID: '123',\n *   itemID: 'item-row-id',\n *   quantity: 5,\n * })\n *\n * // Increment by 1\n * const result = await updateItem({\n *   payload,\n *   cartsSlug: 'carts',\n *   cartID: '123',\n *   itemID: 'item-row-id',\n *   quantity: { $inc: 1 },\n * })\n *\n * // Decrement by 2\n * const result = await updateItem({\n *   payload,\n *   cartsSlug: 'carts',\n *   cartID: '123',\n *   itemID: 'item-row-id',\n *   quantity: { $inc: -2 },\n * })\n * ```\n */\nexport const updateItem = async (args: UpdateItemArgs): Promise<CartOperationResult> => {\n  const { cartID, cartsSlug, itemID, payload, quantity, removeOnZero = true, req, secret } = args\n\n  // Inject secret into request context for access control\n  const reqWithSecret = createRequestWithSecret(req, secret)\n\n  const cart = await payload.findByID({\n    id: cartID,\n    collection: cartsSlug,\n    depth: 0,\n    overrideAccess: false,\n    req: reqWithSecret,\n  })\n\n  if (!cart) {\n    return {\n      cart: null,\n      message: `Cart with ID ${cartID} not found`,\n      success: false,\n    }\n  }\n\n  const existingItems: CartItemData[] = (cart.items as CartItemData[]) || []\n\n  // Find the item by its row ID\n  const itemIndex = existingItems.findIndex((item) => item.id === itemID)\n\n  if (itemIndex === -1) {\n    return {\n      cart,\n      message: `Item with ID ${itemID} not found in cart`,\n      success: false,\n    }\n  }\n\n  const updatedItems = [...existingItems]\n  const existingItem = updatedItems[itemIndex]!\n  const currentQuantity = existingItem.quantity\n\n  // Calculate new quantity based on operator or direct value\n  let newQuantity: number\n  if (isNumericOperator(quantity)) {\n    // $inc operator: add to current value\n    newQuantity = currentQuantity + quantity.$inc\n  } else {\n    // Direct value: set to this value\n    newQuantity = quantity\n  }\n\n  if (newQuantity <= 0 && removeOnZero) {\n    // Remove the item if quantity reaches 0 or below\n    updatedItems.splice(itemIndex, 1)\n  } else {\n    // Update the quantity (minimum 1 if not removing on zero)\n    updatedItems[itemIndex] = {\n      ...existingItem,\n      quantity: removeOnZero ? newQuantity : Math.max(1, newQuantity),\n    }\n  }\n\n  const updatedCart = await payload.update({\n    id: cartID,\n    collection: cartsSlug,\n    data: {\n      items: updatedItems,\n    },\n    depth: 0,\n    overrideAccess: false,\n    req: reqWithSecret,\n  })\n\n  const wasRemoved = newQuantity <= 0 && removeOnZero\n\n  return {\n    cart: updatedCart,\n    message: wasRemoved ? 'Item removed from cart' : 'Item quantity updated',\n    success: true,\n  }\n}\n"],"names":["createRequestWithSecret","isNumericOperator","updateItem","args","cartID","cartsSlug","itemID","payload","quantity","removeOnZero","req","secret","reqWithSecret","cart","findByID","id","collection","depth","overrideAccess","message","success","existingItems","items","itemIndex","findIndex","item","updatedItems","existingItem","currentQuantity","newQuantity","$inc","splice","Math","max","updatedCart","update","data","wasRemoved"],"mappings":"AAEA,SAASA,uBAAuB,QAAQ,+BAA8B;AACtE,SAASC,iBAAiB,QAAQ,aAAY;AAE9C;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;CAqCC,GACD,OAAO,MAAMC,aAAa,OAAOC;IAC/B,MAAM,EAAEC,MAAM,EAAEC,SAAS,EAAEC,MAAM,EAAEC,OAAO,EAAEC,QAAQ,EAAEC,eAAe,IAAI,EAAEC,GAAG,EAAEC,MAAM,EAAE,GAAGR;IAE3F,wDAAwD;IACxD,MAAMS,gBAAgBZ,wBAAwBU,KAAKC;IAEnD,MAAME,OAAO,MAAMN,QAAQO,QAAQ,CAAC;QAClCC,IAAIX;QACJY,YAAYX;QACZY,OAAO;QACPC,gBAAgB;QAChBR,KAAKE;IACP;IAEA,IAAI,CAACC,MAAM;QACT,OAAO;YACLA,MAAM;YACNM,SAAS,CAAC,aAAa,EAAEf,OAAO,UAAU,CAAC;YAC3CgB,SAAS;QACX;IACF;IAEA,MAAMC,gBAAgC,AAACR,KAAKS,KAAK,IAAuB,EAAE;IAE1E,8BAA8B;IAC9B,MAAMC,YAAYF,cAAcG,SAAS,CAAC,CAACC,OAASA,KAAKV,EAAE,KAAKT;IAEhE,IAAIiB,cAAc,CAAC,GAAG;QACpB,OAAO;YACLV;YACAM,SAAS,CAAC,aAAa,EAAEb,OAAO,kBAAkB,CAAC;YACnDc,SAAS;QACX;IACF;IAEA,MAAMM,eAAe;WAAIL;KAAc;IACvC,MAAMM,eAAeD,YAAY,CAACH,UAAU;IAC5C,MAAMK,kBAAkBD,aAAanB,QAAQ;IAE7C,2DAA2D;IAC3D,IAAIqB;IACJ,IAAI5B,kBAAkBO,WAAW;QAC/B,sCAAsC;QACtCqB,cAAcD,kBAAkBpB,SAASsB,IAAI;IAC/C,OAAO;QACL,kCAAkC;QAClCD,cAAcrB;IAChB;IAEA,IAAIqB,eAAe,KAAKpB,cAAc;QACpC,iDAAiD;QACjDiB,aAAaK,MAAM,CAACR,WAAW;IACjC,OAAO;QACL,0DAA0D;QAC1DG,YAAY,CAACH,UAAU,GAAG;YACxB,GAAGI,YAAY;YACfnB,UAAUC,eAAeoB,cAAcG,KAAKC,GAAG,CAAC,GAAGJ;QACrD;IACF;IAEA,MAAMK,cAAc,MAAM3B,QAAQ4B,MAAM,CAAC;QACvCpB,IAAIX;QACJY,YAAYX;QACZ+B,MAAM;YACJd,OAAOI;QACT;QACAT,OAAO;QACPC,gBAAgB;QAChBR,KAAKE;IACP;IAEA,MAAMyB,aAAaR,eAAe,KAAKpB;IAEvC,OAAO;QACLI,MAAMqB;QACNf,SAASkB,aAAa,2BAA2B;QACjDjB,SAAS;IACX;AACF,EAAC"}