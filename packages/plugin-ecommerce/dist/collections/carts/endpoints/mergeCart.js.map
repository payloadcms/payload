{"version":3,"sources":["../../../../src/collections/carts/endpoints/mergeCart.ts"],"sourcesContent":["import type { CollectionSlug, Endpoint } from 'payload'\n\nimport { addDataAndFileToRequest } from 'payload'\n\nimport type { MergeCartArgs } from '../operations/mergeCart.js'\n\nimport { mergeCart } from '../operations/mergeCart.js'\n\ntype Args = {\n  cartItemMatcher?: MergeCartArgs['cartItemMatcher']\n  cartsSlug: CollectionSlug\n}\n\n/**\n * Creates an endpoint handler for merging a guest cart into the authenticated user's cart.\n * This is used when a guest with an existing cart logs in.\n *\n * Route: POST /api/{cartsSlug}/:id/merge\n *\n * Request body:\n * - sourceCartID: string - The ID of the guest cart to merge from\n * - sourceSecret: string - The secret of the guest cart for verification\n *\n * Requires authentication - the :id in the URL is the target cart which must belong to the user.\n */\nexport const mergeCartEndpoint = ({ cartItemMatcher, cartsSlug }: Args): Endpoint => ({\n  handler: async (req) => {\n    // This endpoint requires authentication\n    if (!req.user) {\n      return Response.json({ message: 'Authentication required', success: false }, { status: 401 })\n    }\n\n    await addDataAndFileToRequest(req)\n\n    const targetCartID = req.routeParams?.id as string | undefined\n    const data = req.data as {\n      sourceCartID?: string\n      sourceSecret?: string\n    }\n\n    if (!targetCartID) {\n      return Response.json(\n        { message: 'Target cart ID is required', success: false },\n        { status: 400 },\n      )\n    }\n\n    if (!data?.sourceCartID) {\n      return Response.json(\n        { message: 'Source cart ID is required', success: false },\n        { status: 400 },\n      )\n    }\n\n    if (!data?.sourceSecret) {\n      return Response.json(\n        { message: 'Source cart secret is required', success: false },\n        { status: 400 },\n      )\n    }\n\n    const result = await mergeCart({\n      cartItemMatcher,\n      cartsSlug,\n      payload: req.payload,\n      req,\n      sourceCartID: data.sourceCartID,\n      sourceSecret: data.sourceSecret,\n      targetCartID,\n    })\n\n    if (!result.success) {\n      return Response.json(result, { status: 404 })\n    }\n\n    return Response.json(result)\n  },\n  method: 'post',\n  path: '/:id/merge',\n})\n"],"names":["addDataAndFileToRequest","mergeCart","mergeCartEndpoint","cartItemMatcher","cartsSlug","handler","req","user","Response","json","message","success","status","targetCartID","routeParams","id","data","sourceCartID","sourceSecret","result","payload","method","path"],"mappings":"AAEA,SAASA,uBAAuB,QAAQ,UAAS;AAIjD,SAASC,SAAS,QAAQ,6BAA4B;AAOtD;;;;;;;;;;;CAWC,GACD,OAAO,MAAMC,oBAAoB,CAAC,EAAEC,eAAe,EAAEC,SAAS,EAAQ,GAAgB,CAAA;QACpFC,SAAS,OAAOC;YACd,wCAAwC;YACxC,IAAI,CAACA,IAAIC,IAAI,EAAE;gBACb,OAAOC,SAASC,IAAI,CAAC;oBAAEC,SAAS;oBAA2BC,SAAS;gBAAM,GAAG;oBAAEC,QAAQ;gBAAI;YAC7F;YAEA,MAAMZ,wBAAwBM;YAE9B,MAAMO,eAAeP,IAAIQ,WAAW,EAAEC;YACtC,MAAMC,OAAOV,IAAIU,IAAI;YAKrB,IAAI,CAACH,cAAc;gBACjB,OAAOL,SAASC,IAAI,CAClB;oBAAEC,SAAS;oBAA8BC,SAAS;gBAAM,GACxD;oBAAEC,QAAQ;gBAAI;YAElB;YAEA,IAAI,CAACI,MAAMC,cAAc;gBACvB,OAAOT,SAASC,IAAI,CAClB;oBAAEC,SAAS;oBAA8BC,SAAS;gBAAM,GACxD;oBAAEC,QAAQ;gBAAI;YAElB;YAEA,IAAI,CAACI,MAAME,cAAc;gBACvB,OAAOV,SAASC,IAAI,CAClB;oBAAEC,SAAS;oBAAkCC,SAAS;gBAAM,GAC5D;oBAAEC,QAAQ;gBAAI;YAElB;YAEA,MAAMO,SAAS,MAAMlB,UAAU;gBAC7BE;gBACAC;gBACAgB,SAASd,IAAIc,OAAO;gBACpBd;gBACAW,cAAcD,KAAKC,YAAY;gBAC/BC,cAAcF,KAAKE,YAAY;gBAC/BL;YACF;YAEA,IAAI,CAACM,OAAOR,OAAO,EAAE;gBACnB,OAAOH,SAASC,IAAI,CAACU,QAAQ;oBAAEP,QAAQ;gBAAI;YAC7C;YAEA,OAAOJ,SAASC,IAAI,CAACU;QACvB;QACAE,QAAQ;QACRC,MAAM;IACR,CAAA,EAAE"}