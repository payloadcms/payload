{"version":3,"sources":["../../src/schema/initGlobals.ts"],"sourcesContent":["import { GraphQLBoolean, GraphQLInt, GraphQLNonNull, GraphQLString } from 'graphql'\nimport pluralize from 'pluralize'\nconst { singular } = pluralize\n\nimport type { Field, GraphQLInfo, SanitizedConfig, SanitizedGlobalConfig } from 'payload'\n\nimport { buildVersionGlobalFields, toWords } from 'payload'\nimport { hasDraftsEnabled } from 'payload/shared'\n\nimport { docAccessResolver } from '../resolvers/globals/docAccess.js'\nimport { findOne } from '../resolvers/globals/findOne.js'\nimport { findVersionByID } from '../resolvers/globals/findVersionByID.js'\nimport { findVersions } from '../resolvers/globals/findVersions.js'\nimport { restoreVersion } from '../resolvers/globals/restoreVersion.js'\nimport { update } from '../resolvers/globals/update.js'\nimport { formatName } from '../utilities/formatName.js'\nimport { buildMutationInputType } from './buildMutationInputType.js'\nimport { buildObjectType } from './buildObjectType.js'\nimport { buildPaginatedListType } from './buildPaginatedListType.js'\nimport { buildPolicyType } from './buildPoliciesType.js'\nimport { buildWhereInputType } from './buildWhereInputType.js'\n\ntype InitGlobalsGraphQLArgs = {\n  config: SanitizedConfig\n  graphqlResult: GraphQLInfo\n}\nexport function initGlobals({ config, graphqlResult }: InitGlobalsGraphQLArgs): void {\n  Object.keys(graphqlResult.globals.config).forEach((slug) => {\n    const global: SanitizedGlobalConfig = graphqlResult.globals.config[slug]\n    const { fields, graphQL } = global\n\n    if (graphQL === false) {\n      return\n    }\n\n    const formattedName = graphQL?.name ? graphQL.name : singular(toWords(global.slug, true))\n\n    const forceNullableObjectType = hasDraftsEnabled(global)\n\n    if (!graphqlResult.globals.graphQL) {\n      graphqlResult.globals.graphQL = {}\n    }\n\n    const updateMutationInputType = buildMutationInputType({\n      name: formattedName,\n      config,\n      fields,\n      graphqlResult,\n      parentIsLocalized: false,\n      parentName: formattedName,\n    })\n    graphqlResult.globals.graphQL[slug] = {\n      type: buildObjectType({\n        name: formattedName,\n        config,\n        fields,\n        forceNullable: forceNullableObjectType,\n        graphqlResult,\n        parentName: formattedName,\n      }),\n      mutationInputType: updateMutationInputType\n        ? new GraphQLNonNull(updateMutationInputType)\n        : null,\n    }\n\n    const queriesEnabled = typeof global.graphQL !== 'object' || !global.graphQL.disableQueries\n    const mutationsEnabled = typeof global.graphQL !== 'object' || !global.graphQL.disableMutations\n\n    if (queriesEnabled) {\n      graphqlResult.Query.fields[formattedName] = {\n        type: graphqlResult.globals.graphQL[slug].type,\n        args: {\n          draft: { type: GraphQLBoolean },\n          ...(config.localization\n            ? {\n                fallbackLocale: { type: graphqlResult.types.fallbackLocaleInputType },\n                locale: { type: graphqlResult.types.localeInputType },\n              }\n            : {}),\n          select: { type: GraphQLBoolean },\n        },\n        resolve: findOne(global),\n      }\n\n      graphqlResult.Query.fields[`docAccess${formattedName}`] = {\n        type: buildPolicyType({\n          type: 'global',\n          entity: global,\n          scope: 'docAccess',\n          typeSuffix: 'DocAccess',\n        }),\n        resolve: docAccessResolver(global),\n      }\n    }\n\n    if (mutationsEnabled) {\n      graphqlResult.Mutation.fields[`update${formattedName}`] = {\n        type: graphqlResult.globals.graphQL[slug].type,\n        args: {\n          ...(updateMutationInputType\n            ? { data: { type: graphqlResult.globals.graphQL[slug].mutationInputType } }\n            : {}),\n          draft: { type: GraphQLBoolean },\n          ...(config.localization\n            ? {\n                locale: { type: graphqlResult.types.localeInputType },\n              }\n            : {}),\n        },\n        resolve: update(global),\n      }\n    }\n\n    if (global.versions) {\n      const idType = config.db.defaultIDType === 'number' ? GraphQLInt : GraphQLString\n\n      const versionGlobalFields: Field[] = [\n        ...buildVersionGlobalFields(config, global),\n        {\n          name: 'id',\n          type: config.db.defaultIDType as 'text',\n        },\n        {\n          name: 'createdAt',\n          type: 'date',\n          label: 'Created At',\n        },\n        {\n          name: 'updatedAt',\n          type: 'date',\n          label: 'Updated At',\n        },\n      ]\n\n      graphqlResult.globals.graphQL[slug].versionType = buildObjectType({\n        name: `${formattedName}Version`,\n        config,\n        fields: versionGlobalFields,\n        forceNullable: forceNullableObjectType,\n        graphqlResult,\n        parentName: `${formattedName}Version`,\n      })\n\n      if (queriesEnabled) {\n        graphqlResult.Query.fields[`version${formatName(formattedName)}`] = {\n          type: graphqlResult.globals.graphQL[slug].versionType,\n          args: {\n            id: { type: idType },\n            draft: { type: GraphQLBoolean },\n            ...(config.localization\n              ? {\n                  fallbackLocale: { type: graphqlResult.types.fallbackLocaleInputType },\n                  locale: { type: graphqlResult.types.localeInputType },\n                }\n              : {}),\n            select: { type: GraphQLBoolean },\n          },\n          resolve: findVersionByID(global),\n        }\n        graphqlResult.Query.fields[`versions${formattedName}`] = {\n          type: buildPaginatedListType(\n            `versions${formatName(formattedName)}`,\n            graphqlResult.globals.graphQL[slug].versionType,\n          ),\n          args: {\n            where: {\n              type: buildWhereInputType({\n                name: `versions${formattedName}`,\n                fields: versionGlobalFields,\n                parentName: `versions${formattedName}`,\n              }),\n            },\n            ...(config.localization\n              ? {\n                  fallbackLocale: { type: graphqlResult.types.fallbackLocaleInputType },\n                  locale: { type: graphqlResult.types.localeInputType },\n                }\n              : {}),\n            limit: { type: GraphQLInt },\n            page: { type: GraphQLInt },\n            pagination: { type: GraphQLBoolean },\n            select: { type: GraphQLBoolean },\n            sort: { type: GraphQLString },\n          },\n          resolve: findVersions(global),\n        }\n      }\n\n      if (mutationsEnabled) {\n        graphqlResult.Mutation.fields[`restoreVersion${formatName(formattedName)}`] = {\n          type: graphqlResult.globals.graphQL[slug].type,\n          args: {\n            id: { type: idType },\n            draft: { type: GraphQLBoolean },\n          },\n          resolve: restoreVersion(global),\n        }\n      }\n    }\n  })\n}\n"],"names":["GraphQLBoolean","GraphQLInt","GraphQLNonNull","GraphQLString","pluralize","singular","buildVersionGlobalFields","toWords","hasDraftsEnabled","docAccessResolver","findOne","findVersionByID","findVersions","restoreVersion","update","formatName","buildMutationInputType","buildObjectType","buildPaginatedListType","buildPolicyType","buildWhereInputType","initGlobals","config","graphqlResult","Object","keys","globals","forEach","slug","global","fields","graphQL","formattedName","name","forceNullableObjectType","updateMutationInputType","parentIsLocalized","parentName","type","forceNullable","mutationInputType","queriesEnabled","disableQueries","mutationsEnabled","disableMutations","Query","args","draft","localization","fallbackLocale","types","fallbackLocaleInputType","locale","localeInputType","select","resolve","entity","scope","typeSuffix","Mutation","data","versions","idType","db","defaultIDType","versionGlobalFields","label","versionType","id","where","limit","page","pagination","sort"],"mappings":"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"}