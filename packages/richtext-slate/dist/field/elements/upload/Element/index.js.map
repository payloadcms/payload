{"version":3,"sources":["../../../../../src/field/elements/upload/Element/index.tsx"],"sourcesContent":["'use client'\n\nimport type { ListDrawerProps } from '@payloadcms/ui'\nimport type { ClientCollectionConfig } from 'payload'\n\nimport { getTranslation } from '@payloadcms/translations'\nimport {\n  Button,\n  DrawerToggler,\n  File,\n  useConfig,\n  useDocumentDrawer,\n  useDrawerSlug,\n  useListDrawer,\n  usePayloadAPI,\n  useTranslation,\n} from '@payloadcms/ui'\nimport { formatAdminURL } from 'payload/shared'\nimport React, { useCallback, useReducer, useState } from 'react'\nimport { Transforms } from 'slate'\nimport { ReactEditor, useFocused, useSelected, useSlateStatic } from 'slate-react'\n\nimport type { UploadElementType } from '../types.js'\n\nimport { useElement } from '../../../providers/ElementProvider.js'\nimport { EnabledRelationshipsCondition } from '../../EnabledRelationshipsCondition.js'\nimport { uploadFieldsSchemaPath, uploadName } from '../shared.js'\nimport './index.scss'\nimport { UploadDrawer } from './UploadDrawer/index.js'\n\nconst baseClass = 'rich-text-upload'\n\nconst initialParams = {\n  depth: 0,\n}\n\nconst UploadElementComponent: React.FC<{ enabledCollectionSlugs?: string[] }> = ({\n  enabledCollectionSlugs,\n}) => {\n  const {\n    attributes,\n    children,\n    element: { relationTo, value },\n    element,\n    fieldProps,\n    schemaPath,\n  } = useElement<UploadElementType>()\n\n  const {\n    config: {\n      routes: { api },\n      serverURL,\n    },\n    getEntityConfig,\n  } = useConfig()\n  const { i18n, t } = useTranslation()\n  const [cacheBust, dispatchCacheBust] = useReducer((state) => state + 1, 0)\n  const [relatedCollection, setRelatedCollection] = useState<ClientCollectionConfig>(() =>\n    getEntityConfig({ collectionSlug: relationTo }),\n  )\n\n  const drawerSlug = useDrawerSlug('upload-drawer')\n\n  const [ListDrawer, ListDrawerToggler, { closeDrawer: closeListDrawer }] = useListDrawer({\n    collectionSlugs: enabledCollectionSlugs,\n    selectedCollection: relatedCollection.slug,\n  })\n\n  const [DocumentDrawer, DocumentDrawerToggler, { closeDrawer }] = useDocumentDrawer({\n    id: value?.id,\n    collectionSlug: relatedCollection.slug,\n  })\n\n  const editor = useSlateStatic()\n  const selected = useSelected()\n  const focused = useFocused()\n\n  // Get the referenced document\n  const [{ data }, { setParams }] = usePayloadAPI(\n    formatAdminURL({ apiRoute: api, path: `/${relatedCollection.slug}/${value?.id}`, serverURL }),\n    { initialParams },\n  )\n\n  const thumbnailSRC = data?.thumbnailURL || data?.url\n\n  const removeUpload = useCallback(() => {\n    const elementPath = ReactEditor.findPath(editor, element)\n\n    Transforms.removeNodes(editor, { at: elementPath })\n  }, [editor, element])\n\n  const updateUpload = useCallback(\n    (json) => {\n      const { doc } = json\n\n      const newNode = {\n        fields: doc,\n      }\n\n      const elementPath = ReactEditor.findPath(editor, element)\n\n      Transforms.setNodes(editor, newNode, { at: elementPath })\n\n      setParams({\n        ...initialParams,\n        cacheBust, // do this to get the usePayloadAPI to re-fetch the data even though the URL string hasn't changed\n      })\n\n      dispatchCacheBust()\n      closeDrawer()\n    },\n    [editor, element, setParams, cacheBust, closeDrawer],\n  )\n\n  const swapUpload = useCallback<NonNullable<ListDrawerProps['onSelect']>>(\n    ({ collectionSlug, doc }) => {\n      const newNode = {\n        type: uploadName,\n        children: [{ text: ' ' }],\n        relationTo: collectionSlug,\n        value: { id: doc.id },\n      }\n\n      const elementPath = ReactEditor.findPath(editor, element)\n\n      setRelatedCollection(getEntityConfig({ collectionSlug }))\n\n      Transforms.setNodes(editor, newNode, { at: elementPath })\n\n      dispatchCacheBust()\n      closeListDrawer()\n    },\n    [closeListDrawer, editor, element, getEntityConfig],\n  )\n\n  const relatedFieldSchemaPath = `${uploadFieldsSchemaPath}.${relatedCollection.slug}`\n  const customFieldsMap = fieldProps.componentMap[relatedFieldSchemaPath]\n\n  const alt = (data as { alt?: string })?.alt || data?.filename || ''\n\n  return (\n    <div\n      className={[baseClass, selected && focused && `${baseClass}--selected`]\n        .filter(Boolean)\n        .join(' ')}\n      contentEditable={false}\n      {...attributes}\n    >\n      <div className={`${baseClass}__card`}>\n        <div className={`${baseClass}__topRow`}>\n          {/* TODO: migrate to use Thumbnail component */}\n          <div className={`${baseClass}__thumbnail`}>\n            {thumbnailSRC ? <img alt={alt} src={thumbnailSRC} /> : <File />}\n          </div>\n          <div className={`${baseClass}__topRowRightPanel`}>\n            <div className={`${baseClass}__collectionLabel`}>\n              {getTranslation(relatedCollection.labels.singular, i18n)}\n            </div>\n            <div className={`${baseClass}__actions`}>\n              {Boolean(customFieldsMap) && (\n                <>\n                  <DrawerToggler\n                    className={`${baseClass}__upload-drawer-toggler`}\n                    disabled={fieldProps?.field?.admin?.readOnly}\n                    slug={drawerSlug}\n                  >\n                    <Button\n                      buttonStyle=\"icon-label\"\n                      el=\"div\"\n                      icon=\"edit\"\n                      onClick={(e) => {\n                        e.preventDefault()\n                      }}\n                      round\n                      tooltip={t('fields:editRelationship')}\n                    />\n                  </DrawerToggler>\n                  <UploadDrawer\n                    {...{ drawerSlug, element, fieldProps, relatedCollection, schemaPath }}\n                  />\n                </>\n              )}\n              <ListDrawerToggler\n                className={`${baseClass}__list-drawer-toggler`}\n                disabled={fieldProps?.field?.admin?.readOnly}\n              >\n                <Button\n                  buttonStyle=\"icon-label\"\n                  disabled={fieldProps?.field?.admin?.readOnly}\n                  el=\"div\"\n                  icon=\"swap\"\n                  onClick={() => {\n                    // do nothing\n                  }}\n                  round\n                  tooltip={t('fields:swapUpload')}\n                />\n              </ListDrawerToggler>\n              <Button\n                buttonStyle=\"icon-label\"\n                className={`${baseClass}__removeButton`}\n                disabled={fieldProps?.field?.admin?.readOnly}\n                icon=\"x\"\n                onClick={(e) => {\n                  e.preventDefault()\n                  removeUpload()\n                }}\n                round\n                tooltip={t('fields:removeUpload')}\n              />\n            </div>\n          </div>\n        </div>\n        <div className={`${baseClass}__bottomRow`}>\n          <DocumentDrawerToggler className={`${baseClass}__doc-drawer-toggler`}>\n            <strong>{data?.filename}</strong>\n          </DocumentDrawerToggler>\n        </div>\n      </div>\n      {children}\n      {value?.id && <DocumentDrawer onSave={updateUpload} />}\n      <ListDrawer onSelect={swapUpload} />\n    </div>\n  )\n}\n\nexport const UploadElement = (props: any): React.ReactNode => {\n  return (\n    <EnabledRelationshipsCondition {...props} uploads>\n      <UploadElementComponent {...props} />\n    </EnabledRelationshipsCondition>\n  )\n}\n"],"names":["getTranslation","Button","DrawerToggler","File","useConfig","useDocumentDrawer","useDrawerSlug","useListDrawer","usePayloadAPI","useTranslation","formatAdminURL","React","useCallback","useReducer","useState","Transforms","ReactEditor","useFocused","useSelected","useSlateStatic","useElement","EnabledRelationshipsCondition","uploadFieldsSchemaPath","uploadName","UploadDrawer","baseClass","initialParams","depth","UploadElementComponent","enabledCollectionSlugs","attributes","children","element","relationTo","value","fieldProps","schemaPath","config","routes","api","serverURL","getEntityConfig","i18n","t","cacheBust","dispatchCacheBust","state","relatedCollection","setRelatedCollection","collectionSlug","drawerSlug","ListDrawer","ListDrawerToggler","closeDrawer","closeListDrawer","collectionSlugs","selectedCollection","slug","DocumentDrawer","DocumentDrawerToggler","id","editor","selected","focused","data","setParams","apiRoute","path","thumbnailSRC","thumbnailURL","url","removeUpload","elementPath","findPath","removeNodes","at","updateUpload","json","doc","newNode","fields","setNodes","swapUpload","type","text","relatedFieldSchemaPath","customFieldsMap","componentMap","alt","filename","div","className","filter","Boolean","join","contentEditable","img","src","labels","singular","disabled","field","admin","readOnly","buttonStyle","el","icon","onClick","e","preventDefault","round","tooltip","strong","onSave","onSelect","UploadElement","props","uploads"],"mappings":"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"}