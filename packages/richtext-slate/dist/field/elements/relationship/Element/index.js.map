{"version":3,"sources":["../../../../../src/field/elements/relationship/Element/index.tsx"],"sourcesContent":["'use client'\n\nimport type { ListDrawerProps } from '@payloadcms/ui'\n\nimport { getTranslation } from '@payloadcms/translations'\nimport {\n  Button,\n  useConfig,\n  useDocumentDrawer,\n  useListDrawer,\n  usePayloadAPI,\n  useTranslation,\n} from '@payloadcms/ui'\nimport { formatAdminURL } from 'payload/shared'\nimport React, { useCallback, useReducer, useState } from 'react'\nimport { Transforms } from 'slate'\nimport { ReactEditor, useFocused, useSelected, useSlateStatic } from 'slate-react'\n\nimport type { RelationshipElementType } from '../types.js'\n\nimport { useElement } from '../../../providers/ElementProvider.js'\nimport './index.scss'\nimport { EnabledRelationshipsCondition } from '../../EnabledRelationshipsCondition.js'\n\nconst baseClass = 'rich-text-relationship'\n\nconst initialParams = {\n  depth: 0,\n}\n\nconst RelationshipElementComponent: React.FC = () => {\n  const {\n    attributes,\n    children,\n    element,\n    element: { relationTo, value },\n    fieldProps,\n  } = useElement<RelationshipElementType>()\n\n  const {\n    config: {\n      collections,\n      routes: { api },\n      serverURL,\n    },\n    getEntityConfig,\n  } = useConfig()\n  const [enabledCollectionSlugs] = useState(() =>\n    collections\n      .filter(({ admin: { enableRichTextRelationship } }) => enableRichTextRelationship)\n      .map(({ slug }) => slug),\n  )\n  const [relatedCollection, setRelatedCollection] = useState(() =>\n    getEntityConfig({ collectionSlug: relationTo }),\n  )\n\n  const selected = useSelected()\n  const focused = useFocused()\n  const { i18n, t } = useTranslation()\n  const editor = useSlateStatic()\n  const [cacheBust, dispatchCacheBust] = useReducer((state) => state + 1, 0)\n  const [{ data }, { setParams }] = usePayloadAPI(\n    formatAdminURL({ apiRoute: api, path: `/${relatedCollection.slug}/${value?.id}`, serverURL }),\n    { initialParams },\n  )\n\n  const [DocumentDrawer, DocumentDrawerToggler, { closeDrawer }] = useDocumentDrawer({\n    id: value?.id,\n    collectionSlug: relatedCollection.slug,\n  })\n\n  const [ListDrawer, ListDrawerToggler, { closeDrawer: closeListDrawer }] = useListDrawer({\n    collectionSlugs: enabledCollectionSlugs,\n    selectedCollection: relatedCollection.slug,\n  })\n\n  const removeRelationship = useCallback(() => {\n    const elementPath = ReactEditor.findPath(editor, element)\n\n    Transforms.removeNodes(editor, { at: elementPath })\n  }, [editor, element])\n\n  const updateRelationship = React.useCallback(\n    ({ doc }) => {\n      const elementPath = ReactEditor.findPath(editor, element)\n\n      Transforms.setNodes(\n        editor,\n        {\n          type: 'relationship',\n          children: [{ text: ' ' }],\n          relationTo: relatedCollection.slug,\n          value: { id: doc.id },\n        },\n        { at: elementPath },\n      )\n\n      setParams({\n        ...initialParams,\n        cacheBust, // do this to get the usePayloadAPI to re-fetch the data even though the URL string hasn't changed\n      })\n\n      closeDrawer()\n      dispatchCacheBust()\n    },\n    [editor, element, relatedCollection, cacheBust, setParams, closeDrawer],\n  )\n\n  const swapRelationship = useCallback<NonNullable<ListDrawerProps['onSelect']>>(\n    ({ collectionSlug, doc }) => {\n      const elementPath = ReactEditor.findPath(editor, element)\n\n      Transforms.setNodes(\n        editor,\n        {\n          type: 'relationship',\n          children: [{ text: ' ' }],\n          relationTo: collectionSlug,\n          value: { id: doc.id },\n        },\n        { at: elementPath },\n      )\n\n      setRelatedCollection(getEntityConfig({ collectionSlug }))\n\n      setParams({\n        ...initialParams,\n        cacheBust, // do this to get the usePayloadAPI to re-fetch the data even though the URL string hasn't changed\n      })\n\n      closeListDrawer()\n      dispatchCacheBust()\n    },\n    [closeListDrawer, editor, element, cacheBust, setParams, getEntityConfig],\n  )\n\n  return (\n    <div\n      className={[baseClass, selected && focused && `${baseClass}--selected`]\n        .filter(Boolean)\n        .join(' ')}\n      contentEditable={false}\n      {...attributes}\n    >\n      <div className={`${baseClass}__wrap`}>\n        <p className={`${baseClass}__label`}>\n          {t('fields:labelRelationship', {\n            label: getTranslation(relatedCollection.labels.singular, i18n),\n          })}\n        </p>\n        <DocumentDrawerToggler className={`${baseClass}__doc-drawer-toggler`}>\n          <p className={`${baseClass}__title`}>\n            {data[relatedCollection?.admin?.useAsTitle || 'id']}\n          </p>\n        </DocumentDrawerToggler>\n      </div>\n      <div className={`${baseClass}__actions`}>\n        <ListDrawerToggler\n          className={`${baseClass}__list-drawer-toggler`}\n          disabled={fieldProps?.field?.admin?.readOnly}\n        >\n          <Button\n            buttonStyle=\"icon-label\"\n            disabled={fieldProps?.field?.admin?.readOnly}\n            el=\"div\"\n            icon=\"swap\"\n            onClick={() => {\n              // do nothing\n            }}\n            round\n            tooltip={t('fields:swapRelationship')}\n          />\n        </ListDrawerToggler>\n        <Button\n          buttonStyle=\"icon-label\"\n          className={`${baseClass}__removeButton`}\n          disabled={fieldProps?.field?.admin?.readOnly}\n          icon=\"x\"\n          onClick={(e) => {\n            e.preventDefault()\n            removeRelationship()\n          }}\n          round\n          tooltip={t('fields:removeRelationship')}\n        />\n      </div>\n      {value?.id && <DocumentDrawer onSave={updateRelationship} />}\n      <ListDrawer onSelect={swapRelationship} />\n      {children}\n    </div>\n  )\n}\n\nexport const RelationshipElement = (props: any): React.ReactNode => {\n  return (\n    <EnabledRelationshipsCondition {...props}>\n      <RelationshipElementComponent {...props} />\n    </EnabledRelationshipsCondition>\n  )\n}\n"],"names":["getTranslation","Button","useConfig","useDocumentDrawer","useListDrawer","usePayloadAPI","useTranslation","formatAdminURL","React","useCallback","useReducer","useState","Transforms","ReactEditor","useFocused","useSelected","useSlateStatic","useElement","EnabledRelationshipsCondition","baseClass","initialParams","depth","RelationshipElementComponent","attributes","children","element","relationTo","value","fieldProps","config","collections","routes","api","serverURL","getEntityConfig","enabledCollectionSlugs","filter","admin","enableRichTextRelationship","map","slug","relatedCollection","setRelatedCollection","collectionSlug","selected","focused","i18n","t","editor","cacheBust","dispatchCacheBust","state","data","setParams","apiRoute","path","id","DocumentDrawer","DocumentDrawerToggler","closeDrawer","ListDrawer","ListDrawerToggler","closeListDrawer","collectionSlugs","selectedCollection","removeRelationship","elementPath","findPath","removeNodes","at","updateRelationship","doc","setNodes","type","text","swapRelationship","div","className","Boolean","join","contentEditable","p","label","labels","singular","useAsTitle","disabled","field","readOnly","buttonStyle","el","icon","onClick","round","tooltip","e","preventDefault","onSave","onSelect","RelationshipElement","props"],"mappings":"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"}