{"version":3,"sources":["../src/staticHandler.ts"],"sourcesContent":["import type { StaticHandler } from '@payloadcms/plugin-cloud-storage/types'\nimport type { CollectionConfig } from 'payload'\n\nimport { getFilePrefix } from '@payloadcms/plugin-cloud-storage/utilities'\nimport { BlobNotFoundError, head } from '@vercel/blob'\nimport path from 'path'\nimport { getRangeRequestInfo } from 'payload/internal'\n\ntype StaticHandlerArgs = {\n  baseUrl: string\n  cacheControlMaxAge?: number\n  token: string\n}\n\nexport const getStaticHandler = (\n  { baseUrl, cacheControlMaxAge = 0, token }: StaticHandlerArgs,\n  collection: CollectionConfig,\n): StaticHandler => {\n  return async (req, { headers: incomingHeaders, params: { clientUploadContext, filename } }) => {\n    try {\n      const prefix = await getFilePrefix({ clientUploadContext, collection, filename, req })\n      const fileKey = path.posix.join(prefix, encodeURIComponent(filename))\n      const fileUrl = `${baseUrl}/${fileKey}`\n      const etagFromHeaders = req.headers.get('etag') || req.headers.get('if-none-match')\n      const blobMetadata = await head(fileUrl, { token })\n      const { contentDisposition, contentType, size, uploadedAt } = blobMetadata\n      const uploadedAtString = uploadedAt.toISOString()\n      const ETag = `\"${fileKey}-${uploadedAtString}\"`\n\n      // Handle range request\n      const rangeHeader = req.headers.get('range')\n      const rangeResult = getRangeRequestInfo({ fileSize: size, rangeHeader })\n\n      if (rangeResult.type === 'invalid') {\n        return new Response(null, {\n          headers: new Headers(rangeResult.headers),\n          status: rangeResult.status,\n        })\n      }\n\n      let headers = new Headers(incomingHeaders)\n\n      // Add range-related headers from the result\n      for (const [key, value] of Object.entries(rangeResult.headers)) {\n        headers.append(key, value)\n      }\n\n      headers.append('Cache-Control', `public, max-age=${cacheControlMaxAge}`)\n      headers.append('Content-Disposition', contentDisposition)\n      headers.append('Content-Type', contentType)\n      headers.append('ETag', ETag)\n\n      if (\n        collection.upload &&\n        typeof collection.upload === 'object' &&\n        typeof collection.upload.modifyResponseHeaders === 'function'\n      ) {\n        headers = collection.upload.modifyResponseHeaders({ headers }) || headers\n      }\n\n      if (etagFromHeaders && etagFromHeaders === ETag) {\n        return new Response(null, {\n          headers,\n          status: 304,\n        })\n      }\n\n      const response = await fetch(`${fileUrl}?${uploadedAtString}`, {\n        headers: {\n          'Cache-Control': 'no-store, no-cache, must-revalidate',\n          Pragma: 'no-cache',\n          ...(rangeResult.type === 'partial' && {\n            Range: `bytes=${rangeResult.rangeStart}-${rangeResult.rangeEnd}`,\n          }),\n        },\n      })\n\n      if (!response.ok || !response.body) {\n        return new Response(null, { status: 204, statusText: 'No Content' })\n      }\n\n      headers.append('Last-Modified', uploadedAtString)\n\n      return new Response(response.body, {\n        headers,\n        status: rangeResult.status,\n      })\n    } catch (err: unknown) {\n      if (err instanceof BlobNotFoundError) {\n        return new Response(null, { status: 404, statusText: 'Not Found' })\n      }\n      req.payload.logger.error({ err, msg: 'Unexpected error in staticHandler' })\n      return new Response('Internal Server Error', { status: 500 })\n    }\n  }\n}\n"],"names":["getFilePrefix","BlobNotFoundError","head","path","getRangeRequestInfo","getStaticHandler","baseUrl","cacheControlMaxAge","token","collection","req","headers","incomingHeaders","params","clientUploadContext","filename","prefix","fileKey","posix","join","encodeURIComponent","fileUrl","etagFromHeaders","get","blobMetadata","contentDisposition","contentType","size","uploadedAt","uploadedAtString","toISOString","ETag","rangeHeader","rangeResult","fileSize","type","Response","Headers","status","key","value","Object","entries","append","upload","modifyResponseHeaders","response","fetch","Pragma","Range","rangeStart","rangeEnd","ok","body","statusText","err","payload","logger","error","msg"],"mappings":"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"}