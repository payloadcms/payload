{"version":3,"sources":["../src/staticHandler.ts"],"sourcesContent":["import type * as AWS from '@aws-sdk/client-s3'\nimport type { StaticHandler } from '@payloadcms/plugin-cloud-storage/types'\nimport type { CollectionConfig, PayloadRequest } from 'payload'\nimport type { Readable } from 'stream'\n\nimport { GetObjectCommand } from '@aws-sdk/client-s3'\nimport { getSignedUrl } from '@aws-sdk/s3-request-presigner'\nimport { getFilePrefix } from '@payloadcms/plugin-cloud-storage/utilities'\nimport path from 'path'\nimport { getRangeRequestInfo } from 'payload/internal'\n\nexport type SignedDownloadsConfig =\n  | {\n      /** @default 7200 */\n      expiresIn?: number\n      shouldUseSignedURL?(args: {\n        collection: CollectionConfig\n        filename: string\n        req: PayloadRequest\n      }): boolean | Promise<boolean>\n    }\n  | boolean\n\ninterface Args {\n  bucket: string\n  collection: CollectionConfig\n  getStorageClient: () => AWS.S3\n  signedDownloads?: SignedDownloadsConfig\n}\n\nconst isNodeReadableStream = (body: AWS.GetObjectOutput['Body']): body is Readable => {\n  return (\n    typeof body === 'object' &&\n    body !== null &&\n    'pipe' in body &&\n    typeof body.pipe === 'function' &&\n    'destroy' in body &&\n    typeof body.destroy === 'function'\n  )\n}\n\nconst abortRequestAndDestroyStream = ({\n  abortController,\n  object,\n}: {\n  abortController: AbortController\n  object?: AWS.GetObjectOutput\n}) => {\n  try {\n    abortController.abort()\n  } catch {\n    /* noop */\n  }\n  if (object?.Body && isNodeReadableStream(object.Body)) {\n    object.Body.destroy()\n  }\n}\n\nexport const getHandler = ({\n  bucket,\n  collection,\n  getStorageClient,\n  signedDownloads,\n}: Args): StaticHandler => {\n  return async (req, { headers: incomingHeaders, params: { clientUploadContext, filename } }) => {\n    let object: AWS.GetObjectOutput | undefined = undefined\n    let streamed = false\n\n    const abortController = new AbortController()\n    if (req.signal) {\n      req.signal.addEventListener('abort', () => {\n        abortRequestAndDestroyStream({ abortController, object })\n      })\n    }\n\n    try {\n      const prefix = await getFilePrefix({ clientUploadContext, collection, filename, req })\n\n      const key = path.posix.join(prefix, filename)\n\n      if (signedDownloads && !clientUploadContext) {\n        let useSignedURL = true\n        if (\n          typeof signedDownloads === 'object' &&\n          typeof signedDownloads.shouldUseSignedURL === 'function'\n        ) {\n          useSignedURL = await signedDownloads.shouldUseSignedURL({ collection, filename, req })\n        }\n\n        if (useSignedURL) {\n          const command = new GetObjectCommand({ Bucket: bucket, Key: key })\n          const signedUrl = await getSignedUrl(\n            getStorageClient(),\n            command,\n            typeof signedDownloads === 'object' ? signedDownloads : { expiresIn: 7200 },\n          )\n          return Response.redirect(signedUrl, 302)\n        }\n      }\n\n      // Get file size first for range validation\n      const headObject = await getStorageClient().headObject({\n        Bucket: bucket,\n        Key: key,\n      })\n      const fileSize = headObject.ContentLength\n\n      if (!fileSize) {\n        return new Response('Internal Server Error', { status: 500 })\n      }\n\n      // Handle range request\n      const rangeHeader = req.headers.get('range')\n      const rangeResult = getRangeRequestInfo({ fileSize, rangeHeader })\n\n      if (rangeResult.type === 'invalid') {\n        return new Response(null, {\n          headers: new Headers(rangeResult.headers),\n          status: rangeResult.status,\n        })\n      }\n\n      const rangeForS3 =\n        rangeResult.type === 'partial'\n          ? `bytes=${rangeResult.rangeStart}-${rangeResult.rangeEnd}`\n          : undefined\n\n      object = await getStorageClient().getObject(\n        {\n          Bucket: bucket,\n          Key: key,\n          Range: rangeForS3,\n        },\n        { abortSignal: abortController.signal },\n      )\n\n      if (!object.Body) {\n        return new Response(null, { status: 404, statusText: 'Not Found' })\n      }\n\n      let headers = new Headers(incomingHeaders)\n\n      // Add range-related headers from the result\n      for (const [key, value] of Object.entries(rangeResult.headers)) {\n        headers.append(key, value)\n      }\n\n      headers.append('Content-Type', String(object.ContentType))\n      headers.append('ETag', String(object.ETag))\n\n      const etagFromHeaders = req.headers.get('etag') || req.headers.get('if-none-match')\n      const objectEtag = object.ETag\n\n      if (\n        collection.upload &&\n        typeof collection.upload === 'object' &&\n        typeof collection.upload.modifyResponseHeaders === 'function'\n      ) {\n        headers = collection.upload.modifyResponseHeaders({ headers }) || headers\n      }\n\n      if (etagFromHeaders && etagFromHeaders === objectEtag) {\n        return new Response(null, {\n          headers,\n          status: 304,\n        })\n      }\n\n      if (!isNodeReadableStream(object.Body)) {\n        req.payload.logger.error({\n          key,\n          msg: 'S3 object body is not a readable stream',\n        })\n        return new Response('Internal Server Error', { status: 500 })\n      }\n\n      const stream = object.Body\n      stream.on('error', (err: Error) => {\n        req.payload.logger.error({\n          err,\n          key,\n          msg: 'Error while streaming S3 object (aborting)',\n        })\n        abortRequestAndDestroyStream({ abortController, object })\n      })\n\n      streamed = true\n      return new Response(stream, { headers, status: rangeResult.status })\n    } catch (err) {\n      if (\n        err &&\n        typeof err === 'object' &&\n        (('name' in err && (err.name === 'NoSuchKey' || err.name === 'NotFound')) ||\n          ('httpStatusCode' in err && err.httpStatusCode === 404))\n      ) {\n        return new Response(null, { status: 404, statusText: 'Not Found' })\n      }\n      req.payload.logger.error(err)\n      return new Response('Internal Server Error', { status: 500 })\n    } finally {\n      if (!streamed) {\n        abortRequestAndDestroyStream({ abortController, object })\n      }\n    }\n  }\n}\n"],"names":["GetObjectCommand","getSignedUrl","getFilePrefix","path","getRangeRequestInfo","isNodeReadableStream","body","pipe","destroy","abortRequestAndDestroyStream","abortController","object","abort","Body","getHandler","bucket","collection","getStorageClient","signedDownloads","req","headers","incomingHeaders","params","clientUploadContext","filename","undefined","streamed","AbortController","signal","addEventListener","prefix","key","posix","join","useSignedURL","shouldUseSignedURL","command","Bucket","Key","signedUrl","expiresIn","Response","redirect","headObject","fileSize","ContentLength","status","rangeHeader","get","rangeResult","type","Headers","rangeForS3","rangeStart","rangeEnd","getObject","Range","abortSignal","statusText","value","Object","entries","append","String","ContentType","ETag","etagFromHeaders","objectEtag","upload","modifyResponseHeaders","payload","logger","error","msg","stream","on","err","name","httpStatusCode"],"mappings":"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"}