{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import type {\n  Adapter,\n  ClientUploadsConfig,\n  PluginOptions as CloudStoragePluginOptions,\n  CollectionOptions,\n  GeneratedAdapter,\n} from '@payloadcms/plugin-cloud-storage/types'\nimport type { NodeHttpHandlerOptions } from '@smithy/node-http-handler'\nimport type { Config, Plugin, UploadCollectionSlug } from 'payload'\n\nimport * as AWS from '@aws-sdk/client-s3'\nimport { cloudStoragePlugin } from '@payloadcms/plugin-cloud-storage'\nimport { initClientUploads } from '@payloadcms/plugin-cloud-storage/utilities'\n\nimport type { SignedDownloadsConfig } from './staticHandler.js'\n\nimport { getGenerateSignedURLHandler } from './generateSignedURL.js'\nimport { getGenerateURL } from './generateURL.js'\nimport { getHandleDelete } from './handleDelete.js'\nimport { getHandleUpload } from './handleUpload.js'\nimport { getHandler } from './staticHandler.js'\n\nexport type S3StorageOptions = {\n  /**\n   * Access control list for uploaded files.\n   */\n  acl?: 'private' | 'public-read'\n\n  /**\n   * When enabled, fields (like the prefix field) will always be inserted into\n   * the collection schema regardless of whether the plugin is enabled. This\n   * ensures a consistent schema across all environments.\n   *\n   * This will be enabled by default in Payload v4.\n   *\n   * @default false\n   */\n  alwaysInsertFields?: boolean\n\n  /**\n   * Bucket name to upload files to.\n   *\n   * Must follow [AWS S3 bucket naming conventions](https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucketnamingrules.html).\n   */\n\n  bucket: string\n\n  /**\n   * Optional cache key to identify the S3 storage client instance.\n   * If not provided, a default key will be used.\n   *\n   * @default `s3:containerName`\n   */\n  clientCacheKey?: string\n\n  /**\n   * Do uploads directly on the client to bypass limits on Vercel. You must allow CORS PUT method for the bucket to your website.\n   */\n  clientUploads?: ClientUploadsConfig\n  /**\n   * Collection options to apply the S3 adapter to.\n   */\n  collections: Partial<\n    Record<\n      UploadCollectionSlug,\n      | ({\n          signedDownloads?: SignedDownloadsConfig\n        } & Omit<CollectionOptions, 'adapter'>)\n      | true\n    >\n  >\n  /**\n   * AWS S3 client configuration. Highly dependent on your AWS setup.\n   *\n   * [AWS.S3ClientConfig Docs](https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/clients/client-s3/interfaces/s3clientconfig.html)\n   */\n  config: AWS.S3ClientConfig\n\n  /**\n   * Whether or not to disable local storage\n   *\n   * @default true\n   */\n  disableLocalStorage?: boolean\n\n  /**\n   * Whether or not to enable the plugin\n   *\n   * Default: true\n   */\n  enabled?: boolean\n  /**\n   * Use pre-signed URLs for files downloading. Can be overriden per-collection.\n   */\n  signedDownloads?: SignedDownloadsConfig\n}\n\ntype S3StoragePlugin = (storageS3Args: S3StorageOptions) => Plugin\n\nconst s3Clients = new Map<string, AWS.S3>()\n\nconst defaultRequestHandlerOpts: NodeHttpHandlerOptions = {\n  httpAgent: {\n    keepAlive: true,\n    maxSockets: 100,\n  },\n  httpsAgent: {\n    keepAlive: true,\n    maxSockets: 100,\n  },\n}\n\nexport const s3Storage: S3StoragePlugin =\n  (s3StorageOptions: S3StorageOptions) =>\n  (incomingConfig: Config): Config => {\n    const cacheKey = s3StorageOptions.clientCacheKey || `s3:${s3StorageOptions.bucket}`\n\n    const getStorageClient: () => AWS.S3 = () => {\n      if (s3Clients.has(cacheKey)) {\n        return s3Clients.get(cacheKey)!\n      }\n\n      s3Clients.set(\n        cacheKey,\n        new AWS.S3({\n          requestHandler: defaultRequestHandlerOpts,\n          ...(s3StorageOptions.config ?? {}),\n        }),\n      )\n\n      return s3Clients.get(cacheKey)!\n    }\n\n    const isPluginDisabled = s3StorageOptions.enabled === false\n\n    initClientUploads({\n      clientHandler: '@payloadcms/storage-s3/client#S3ClientUploadHandler',\n      collections: s3StorageOptions.collections,\n      config: incomingConfig,\n      enabled: !isPluginDisabled && Boolean(s3StorageOptions.clientUploads),\n      serverHandler: getGenerateSignedURLHandler({\n        access:\n          typeof s3StorageOptions.clientUploads === 'object'\n            ? s3StorageOptions.clientUploads.access\n            : undefined,\n        acl: s3StorageOptions.acl,\n        bucket: s3StorageOptions.bucket,\n        collections: s3StorageOptions.collections,\n        getStorageClient,\n      }),\n      serverHandlerPath: '/storage-s3-generate-signed-url',\n    })\n\n    if (isPluginDisabled) {\n      // If alwaysInsertFields is true, still call cloudStoragePlugin to insert fields\n      if (s3StorageOptions.alwaysInsertFields) {\n        // Build collections with adapter: null since plugin is disabled\n        const collectionsWithoutAdapter: CloudStoragePluginOptions['collections'] = Object.entries(\n          s3StorageOptions.collections,\n        ).reduce(\n          (acc, [slug, collOptions]) => ({\n            ...acc,\n            [slug]: {\n              ...(collOptions === true ? {} : collOptions),\n              adapter: null,\n            },\n          }),\n          {} as Record<string, CollectionOptions>,\n        )\n\n        return cloudStoragePlugin({\n          alwaysInsertFields: true,\n          collections: collectionsWithoutAdapter,\n          enabled: false,\n        })(incomingConfig)\n      }\n\n      return incomingConfig\n    }\n\n    const adapter = s3StorageInternal(getStorageClient, s3StorageOptions)\n\n    // Add adapter to each collection option object\n    const collectionsWithAdapter: CloudStoragePluginOptions['collections'] = Object.entries(\n      s3StorageOptions.collections,\n    ).reduce(\n      (acc, [slug, collOptions]) => ({\n        ...acc,\n        [slug]: {\n          ...(collOptions === true ? {} : collOptions),\n          adapter,\n        },\n      }),\n      {} as Record<string, CollectionOptions>,\n    )\n\n    // Set disableLocalStorage: true for collections specified in the plugin options\n    const config = {\n      ...incomingConfig,\n      collections: (incomingConfig.collections || []).map((collection) => {\n        if (!collectionsWithAdapter[collection.slug]) {\n          return collection\n        }\n\n        return {\n          ...collection,\n          upload: {\n            ...(typeof collection.upload === 'object' ? collection.upload : {}),\n            disableLocalStorage: true,\n          },\n        }\n      }),\n    }\n\n    return cloudStoragePlugin({\n      alwaysInsertFields: s3StorageOptions.alwaysInsertFields,\n      collections: collectionsWithAdapter,\n    })(config)\n  }\n\nfunction s3StorageInternal(\n  getStorageClient: () => AWS.S3,\n  {\n    acl,\n    bucket,\n    clientUploads,\n    collections,\n    config = {},\n    signedDownloads: topLevelSignedDownloads,\n  }: S3StorageOptions,\n): Adapter {\n  return ({ collection, prefix }): GeneratedAdapter => {\n    const collectionStorageConfig = collections[collection.slug]\n\n    let signedDownloads: null | SignedDownloadsConfig =\n      typeof collectionStorageConfig === 'object'\n        ? (collectionStorageConfig.signedDownloads ?? false)\n        : null\n\n    if (signedDownloads === null) {\n      signedDownloads = topLevelSignedDownloads ?? null\n    }\n\n    return {\n      name: 's3',\n      clientUploads,\n      generateURL: getGenerateURL({ bucket, config }),\n      handleDelete: getHandleDelete({ bucket, getStorageClient }),\n      handleUpload: getHandleUpload({\n        acl,\n        bucket,\n        collection,\n        getStorageClient,\n        prefix,\n      }),\n      staticHandler: getHandler({\n        bucket,\n        collection,\n        getStorageClient,\n        signedDownloads: signedDownloads ?? false,\n      }),\n    }\n  }\n}\n"],"names":["AWS","cloudStoragePlugin","initClientUploads","getGenerateSignedURLHandler","getGenerateURL","getHandleDelete","getHandleUpload","getHandler","s3Clients","Map","defaultRequestHandlerOpts","httpAgent","keepAlive","maxSockets","httpsAgent","s3Storage","s3StorageOptions","incomingConfig","cacheKey","clientCacheKey","bucket","getStorageClient","has","get","set","S3","requestHandler","config","isPluginDisabled","enabled","clientHandler","collections","Boolean","clientUploads","serverHandler","access","undefined","acl","serverHandlerPath","alwaysInsertFields","collectionsWithoutAdapter","Object","entries","reduce","acc","slug","collOptions","adapter","s3StorageInternal","collectionsWithAdapter","map","collection","upload","disableLocalStorage","signedDownloads","topLevelSignedDownloads","prefix","collectionStorageConfig","name","generateURL","handleDelete","handleUpload","staticHandler"],"mappings":"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"}