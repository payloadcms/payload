{"version":3,"sources":["../src/generateSignedURL.ts"],"sourcesContent":["import type { ClientUploadsAccess } from '@payloadcms/plugin-cloud-storage/types'\nimport type { PayloadHandler } from 'payload'\n\nimport * as AWS from '@aws-sdk/client-s3'\nimport { getSignedUrl } from '@aws-sdk/s3-request-presigner'\nimport path from 'path'\nimport { APIError, Forbidden, ValidationError } from 'payload'\n\nimport type { S3StorageOptions } from './index.js'\n\nconst bytesToMB = (bytes: number) => {\n  return bytes / 1024 / 1024\n}\n\ninterface Args {\n  access?: ClientUploadsAccess\n  acl?: 'private' | 'public-read'\n  bucket: string\n  collections: S3StorageOptions['collections']\n  getStorageClient: () => AWS.S3\n}\n\nconst defaultAccess: Args['access'] = ({ req }) => !!req.user\n\nexport const getGenerateSignedURLHandler = ({\n  access = defaultAccess,\n  acl,\n  bucket,\n  collections,\n  getStorageClient,\n}: Args): PayloadHandler => {\n  return async (req) => {\n    if (!req.json) {\n      throw new APIError('Content-Type expected to be application/json', 400)\n    }\n\n    let filesizeLimit = req.payload.config.upload.limits?.fileSize\n\n    if (filesizeLimit === Infinity) {\n      filesizeLimit = undefined\n    }\n\n    const { collectionSlug, filename, filesize, mimeType } = (await req.json()) as {\n      collectionSlug: string\n      filename: string\n      filesize: number\n      mimeType: string\n    }\n\n    const collectionS3Config = collections[collectionSlug]\n    if (!collectionS3Config) {\n      throw new APIError(`Collection ${collectionSlug} was not found in S3 options`)\n    }\n\n    const prefix = (typeof collectionS3Config === 'object' && collectionS3Config.prefix) || ''\n\n    if (!(await access({ collectionSlug, req }))) {\n      throw new Forbidden()\n    }\n\n    const fileKey = path.posix.join(prefix, filename)\n\n    const signableHeaders = new Set<string>()\n\n    if (filesizeLimit) {\n      if (filesize > filesizeLimit) {\n        throw new APIError(\n          `Exceeded file size limit. Limit: ${bytesToMB(filesizeLimit).toFixed(2)}MB, got: ${bytesToMB(filesize).toFixed(2)}MB`,\n          400,\n        )\n      }\n\n      // Still force S3 to validate\n      signableHeaders.add('content-length')\n    }\n\n    const url = await getSignedUrl(\n      getStorageClient(),\n      new AWS.PutObjectCommand({\n        ACL: acl,\n        Bucket: bucket,\n        ContentLength: filesizeLimit ? Math.min(filesize, filesizeLimit) : undefined,\n        ContentType: mimeType,\n        Key: fileKey,\n      }),\n      {\n        expiresIn: 600,\n        signableHeaders,\n      },\n    )\n\n    return Response.json({ url })\n  }\n}\n"],"names":["AWS","getSignedUrl","path","APIError","Forbidden","bytesToMB","bytes","defaultAccess","req","user","getGenerateSignedURLHandler","access","acl","bucket","collections","getStorageClient","json","filesizeLimit","payload","config","upload","limits","fileSize","Infinity","undefined","collectionSlug","filename","filesize","mimeType","collectionS3Config","prefix","fileKey","posix","join","signableHeaders","Set","toFixed","add","url","PutObjectCommand","ACL","Bucket","ContentLength","Math","min","ContentType","Key","expiresIn","Response"],"mappings":"AAGA,YAAYA,SAAS,qBAAoB;AACzC,SAASC,YAAY,QAAQ,gCAA+B;AAC5D,OAAOC,UAAU,OAAM;AACvB,SAASC,QAAQ,EAAEC,SAAS,QAAyB,UAAS;AAI9D,MAAMC,YAAY,CAACC;IACjB,OAAOA,QAAQ,OAAO;AACxB;AAUA,MAAMC,gBAAgC,CAAC,EAAEC,GAAG,EAAE,GAAK,CAAC,CAACA,IAAIC,IAAI;AAE7D,OAAO,MAAMC,8BAA8B,CAAC,EAC1CC,SAASJ,aAAa,EACtBK,GAAG,EACHC,MAAM,EACNC,WAAW,EACXC,gBAAgB,EACX;IACL,OAAO,OAAOP;QACZ,IAAI,CAACA,IAAIQ,IAAI,EAAE;YACb,MAAM,IAAIb,SAAS,gDAAgD;QACrE;QAEA,IAAIc,gBAAgBT,IAAIU,OAAO,CAACC,MAAM,CAACC,MAAM,CAACC,MAAM,EAAEC;QAEtD,IAAIL,kBAAkBM,UAAU;YAC9BN,gBAAgBO;QAClB;QAEA,MAAM,EAAEC,cAAc,EAAEC,QAAQ,EAAEC,QAAQ,EAAEC,QAAQ,EAAE,GAAI,MAAMpB,IAAIQ,IAAI;QAOxE,MAAMa,qBAAqBf,WAAW,CAACW,eAAe;QACtD,IAAI,CAACI,oBAAoB;YACvB,MAAM,IAAI1B,SAAS,CAAC,WAAW,EAAEsB,eAAe,4BAA4B,CAAC;QAC/E;QAEA,MAAMK,SAAS,AAAC,OAAOD,uBAAuB,YAAYA,mBAAmBC,MAAM,IAAK;QAExF,IAAI,CAAE,MAAMnB,OAAO;YAAEc;YAAgBjB;QAAI,IAAK;YAC5C,MAAM,IAAIJ;QACZ;QAEA,MAAM2B,UAAU7B,KAAK8B,KAAK,CAACC,IAAI,CAACH,QAAQJ;QAExC,MAAMQ,kBAAkB,IAAIC;QAE5B,IAAIlB,eAAe;YACjB,IAAIU,WAAWV,eAAe;gBAC5B,MAAM,IAAId,SACR,CAAC,iCAAiC,EAAEE,UAAUY,eAAemB,OAAO,CAAC,GAAG,SAAS,EAAE/B,UAAUsB,UAAUS,OAAO,CAAC,GAAG,EAAE,CAAC,EACrH;YAEJ;YAEA,6BAA6B;YAC7BF,gBAAgBG,GAAG,CAAC;QACtB;QAEA,MAAMC,MAAM,MAAMrC,aAChBc,oBACA,IAAIf,IAAIuC,gBAAgB,CAAC;YACvBC,KAAK5B;YACL6B,QAAQ5B;YACR6B,eAAezB,gBAAgB0B,KAAKC,GAAG,CAACjB,UAAUV,iBAAiBO;YACnEqB,aAAajB;YACbkB,KAAKf;QACP,IACA;YACEgB,WAAW;YACXb;QACF;QAGF,OAAOc,SAAShC,IAAI,CAAC;YAAEsB;QAAI;IAC7B;AACF,EAAC"}