{"version":3,"sources":["../../../../src/collections/FormSubmissions/hooks/sendEmail.ts"],"sourcesContent":["import type { CollectionAfterChangeHook } from 'payload'\n\nimport type { Email, FormattedEmail, FormBuilderPluginConfig } from '../../../types.js'\n\nimport { serializeLexical } from '../../../utilities/lexical/serializeLexical.js'\nimport { replaceDoubleCurlys } from '../../../utilities/replaceDoubleCurlys.js'\nimport { serializeSlate } from '../../../utilities/slate/serializeSlate.js'\n\ntype AfterChangeParams = Parameters<CollectionAfterChangeHook>[0]\n\nexport const sendEmail = async (\n  afterChangeParameters: AfterChangeParams,\n  formConfig: FormBuilderPluginConfig,\n) => {\n  if (afterChangeParameters.operation === 'create') {\n    const {\n      data,\n      doc: { id: formSubmissionID },\n      req: { locale, payload },\n      req,\n    } = afterChangeParameters\n\n    const { form: formID, submissionData: submissionDataFromProps } = data || {}\n    const { beforeEmail, defaultToEmail, formOverrides } = formConfig || {}\n\n    try {\n      const form = await payload.findByID({\n        id: formID,\n        collection: formOverrides?.slug || 'forms',\n        locale,\n        req,\n      })\n\n      const emails = form.emails as Email[]\n\n      const submissionData = [\n        ...submissionDataFromProps,\n        {\n          field: 'formSubmissionID',\n          value: String(formSubmissionID),\n        },\n      ]\n\n      if (emails && emails.length) {\n        const formattedEmails: FormattedEmail[] = await Promise.all(\n          emails.map(async (email: Email): Promise<FormattedEmail> => {\n            const {\n              bcc: emailBCC,\n              cc: emailCC,\n              emailFrom,\n              emailTo: emailToFromConfig,\n              message,\n              replyTo: emailReplyTo,\n              subject,\n            } = email\n\n            const emailTo = emailToFromConfig || defaultToEmail || payload.email.defaultFromAddress\n\n            const to = replaceDoubleCurlys(emailTo, submissionData)\n            const cc = emailCC ? replaceDoubleCurlys(emailCC, submissionData) : ''\n            const bcc = emailBCC ? replaceDoubleCurlys(emailBCC, submissionData) : ''\n            const from = replaceDoubleCurlys(emailFrom, submissionData)\n            const replyTo = replaceDoubleCurlys(emailReplyTo || emailFrom, submissionData)\n\n            const isLexical = message && !Array.isArray(message) && 'root' in message\n\n            const serializedMessage = isLexical\n              ? await serializeLexical(message, submissionData)\n              : serializeSlate(message, submissionData)\n\n            return {\n              bcc,\n              cc,\n              from,\n              html: `<div>${serializedMessage}</div>`,\n              replyTo,\n              subject: replaceDoubleCurlys(subject, submissionData),\n              to,\n            }\n          }),\n        )\n\n        let emailsToSend = formattedEmails\n\n        if (typeof beforeEmail === 'function') {\n          emailsToSend = await beforeEmail(formattedEmails, afterChangeParameters)\n        }\n\n        await Promise.all(\n          emailsToSend.map(async (email) => {\n            const { to } = email\n            try {\n              const emailPromise = await payload.sendEmail(email)\n              return emailPromise\n            } catch (err: unknown) {\n              payload.logger.error({\n                err,\n                msg: `Error while sending email to address: ${to}. Email not sent.`,\n              })\n            }\n          }),\n        )\n      } else {\n        payload.logger.info({ msg: 'No emails to send.' })\n      }\n    } catch (err: unknown) {\n      const msg = `Error while sending one or more emails in form submission id: ${formSubmissionID}.`\n      payload.logger.error({ err, msg })\n    }\n  }\n}\n"],"names":["serializeLexical","replaceDoubleCurlys","serializeSlate","sendEmail","afterChangeParameters","formConfig","operation","data","doc","id","formSubmissionID","req","locale","payload","form","formID","submissionData","submissionDataFromProps","beforeEmail","defaultToEmail","formOverrides","findByID","collection","slug","emails","field","value","String","length","formattedEmails","Promise","all","map","email","bcc","emailBCC","cc","emailCC","emailFrom","emailTo","emailToFromConfig","message","replyTo","emailReplyTo","subject","defaultFromAddress","to","from","isLexical","Array","isArray","serializedMessage","html","emailsToSend","emailPromise","err","logger","error","msg","info"],"mappings":"AAIA,SAASA,gBAAgB,QAAQ,iDAAgD;AACjF,SAASC,mBAAmB,QAAQ,4CAA2C;AAC/E,SAASC,cAAc,QAAQ,6CAA4C;AAI3E,OAAO,MAAMC,YAAY,OACvBC,uBACAC;IAEA,IAAID,sBAAsBE,SAAS,KAAK,UAAU;QAChD,MAAM,EACJC,IAAI,EACJC,KAAK,EAAEC,IAAIC,gBAAgB,EAAE,EAC7BC,KAAK,EAAEC,MAAM,EAAEC,OAAO,EAAE,EACxBF,GAAG,EACJ,GAAGP;QAEJ,MAAM,EAAEU,MAAMC,MAAM,EAAEC,gBAAgBC,uBAAuB,EAAE,GAAGV,QAAQ,CAAC;QAC3E,MAAM,EAAEW,WAAW,EAAEC,cAAc,EAAEC,aAAa,EAAE,GAAGf,cAAc,CAAC;QAEtE,IAAI;YACF,MAAMS,OAAO,MAAMD,QAAQQ,QAAQ,CAAC;gBAClCZ,IAAIM;gBACJO,YAAYF,eAAeG,QAAQ;gBACnCX;gBACAD;YACF;YAEA,MAAMa,SAASV,KAAKU,MAAM;YAE1B,MAAMR,iBAAiB;mBAClBC;gBACH;oBACEQ,OAAO;oBACPC,OAAOC,OAAOjB;gBAChB;aACD;YAED,IAAIc,UAAUA,OAAOI,MAAM,EAAE;gBAC3B,MAAMC,kBAAoC,MAAMC,QAAQC,GAAG,CACzDP,OAAOQ,GAAG,CAAC,OAAOC;oBAChB,MAAM,EACJC,KAAKC,QAAQ,EACbC,IAAIC,OAAO,EACXC,SAAS,EACTC,SAASC,iBAAiB,EAC1BC,OAAO,EACPC,SAASC,YAAY,EACrBC,OAAO,EACR,GAAGX;oBAEJ,MAAMM,UAAUC,qBAAqBrB,kBAAkBN,QAAQoB,KAAK,CAACY,kBAAkB;oBAEvF,MAAMC,KAAK7C,oBAAoBsC,SAASvB;oBACxC,MAAMoB,KAAKC,UAAUpC,oBAAoBoC,SAASrB,kBAAkB;oBACpE,MAAMkB,MAAMC,WAAWlC,oBAAoBkC,UAAUnB,kBAAkB;oBACvE,MAAM+B,OAAO9C,oBAAoBqC,WAAWtB;oBAC5C,MAAM0B,UAAUzC,oBAAoB0C,gBAAgBL,WAAWtB;oBAE/D,MAAMgC,YAAYP,WAAW,CAACQ,MAAMC,OAAO,CAACT,YAAY,UAAUA;oBAElE,MAAMU,oBAAoBH,YACtB,MAAMhD,iBAAiByC,SAASzB,kBAChCd,eAAeuC,SAASzB;oBAE5B,OAAO;wBACLkB;wBACAE;wBACAW;wBACAK,MAAM,CAAC,KAAK,EAAED,kBAAkB,MAAM,CAAC;wBACvCT;wBACAE,SAAS3C,oBAAoB2C,SAAS5B;wBACtC8B;oBACF;gBACF;gBAGF,IAAIO,eAAexB;gBAEnB,IAAI,OAAOX,gBAAgB,YAAY;oBACrCmC,eAAe,MAAMnC,YAAYW,iBAAiBzB;gBACpD;gBAEA,MAAM0B,QAAQC,GAAG,CACfsB,aAAarB,GAAG,CAAC,OAAOC;oBACtB,MAAM,EAAEa,EAAE,EAAE,GAAGb;oBACf,IAAI;wBACF,MAAMqB,eAAe,MAAMzC,QAAQV,SAAS,CAAC8B;wBAC7C,OAAOqB;oBACT,EAAE,OAAOC,KAAc;wBACrB1C,QAAQ2C,MAAM,CAACC,KAAK,CAAC;4BACnBF;4BACAG,KAAK,CAAC,sCAAsC,EAAEZ,GAAG,iBAAiB,CAAC;wBACrE;oBACF;gBACF;YAEJ,OAAO;gBACLjC,QAAQ2C,MAAM,CAACG,IAAI,CAAC;oBAAED,KAAK;gBAAqB;YAClD;QACF,EAAE,OAAOH,KAAc;YACrB,MAAMG,MAAM,CAAC,8DAA8D,EAAEhD,iBAAiB,CAAC,CAAC;YAChGG,QAAQ2C,MAAM,CAACC,KAAK,CAAC;gBAAEF;gBAAKG;YAAI;QAClC;IACF;AACF,EAAC"}