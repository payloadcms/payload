{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import type { AcceptedLanguages } from '@payloadcms/translations'\nimport type { CollectionConfig, Config } from 'payload'\n\nimport chalk from 'chalk'\nimport { hasAutosaveEnabled } from 'payload/shared'\n\nimport type { PluginDefaultTranslationsObject } from './translations/types.js'\nimport type { MultiTenantPluginConfig } from './types.js'\n\nimport { defaults } from './defaults.js'\nimport { getTenantOptionsEndpoint } from './endpoints/getTenantOptionsEndpoint.js'\nimport { tenantField } from './fields/tenantField/index.js'\nimport { tenantsArrayField } from './fields/tenantsArrayField/index.js'\nimport { filterDocumentsByTenants } from './filters/filterDocumentsByTenants.js'\nimport { addTenantCleanup } from './hooks/afterTenantDelete.js'\nimport { translations } from './translations/index.js'\nimport { addCollectionAccess } from './utilities/addCollectionAccess.js'\nimport { addFilterOptionsToFields } from './utilities/addFilterOptionsToFields.js'\nimport { combineFilters } from './utilities/combineFilters.js'\nimport { miniChalk } from './utilities/miniChalk.js'\n\nexport const multiTenantPlugin =\n  <ConfigType>(pluginConfig: MultiTenantPluginConfig<ConfigType>) =>\n  (incomingConfig: Config): Config => {\n    if (pluginConfig.enabled === false) {\n      return incomingConfig\n    }\n\n    /**\n     * Set defaults\n     */\n    const userHasAccessToAllTenants: Required<\n      MultiTenantPluginConfig<ConfigType>\n    >['userHasAccessToAllTenants'] =\n      typeof pluginConfig.userHasAccessToAllTenants === 'function'\n        ? pluginConfig.userHasAccessToAllTenants\n        : () => false\n    const tenantsCollectionSlug = (pluginConfig.tenantsSlug =\n      pluginConfig.tenantsSlug || defaults.tenantCollectionSlug)\n    const tenantFieldName = pluginConfig?.tenantField?.name || defaults.tenantFieldName\n    const tenantsArrayFieldName =\n      pluginConfig?.tenantsArrayField?.arrayFieldName || defaults.tenantsArrayFieldName\n    const tenantsArrayTenantFieldName =\n      pluginConfig?.tenantsArrayField?.arrayTenantFieldName || defaults.tenantsArrayTenantFieldName\n    const basePath = pluginConfig.basePath || defaults.basePath\n\n    /**\n     * Add defaults for admin properties\n     */\n    if (!incomingConfig.admin) {\n      incomingConfig.admin = {}\n    }\n    if (!incomingConfig.admin?.components) {\n      incomingConfig.admin.components = {\n        actions: [],\n        beforeNavLinks: [],\n        providers: [],\n      }\n    }\n    if (!incomingConfig.admin.components?.providers) {\n      incomingConfig.admin.components.providers = []\n    }\n    if (!incomingConfig.admin.components?.actions) {\n      incomingConfig.admin.components.actions = []\n    }\n    if (!incomingConfig.admin.components?.beforeNavLinks) {\n      incomingConfig.admin.components.beforeNavLinks = []\n    }\n    if (!incomingConfig.collections) {\n      incomingConfig.collections = []\n    }\n\n    /**\n     * Add tenants array field to users collection\n     */\n    const adminUsersCollection = incomingConfig.collections.find(({ slug, auth }) => {\n      if (incomingConfig.admin?.user) {\n        return slug === incomingConfig.admin.user\n      } else if (auth) {\n        return true\n      }\n    })\n\n    if (!adminUsersCollection) {\n      throw Error('An auth enabled collection was not found')\n    }\n\n    /**\n     * Add tenants array field to users collection\n     */\n    if (pluginConfig?.tenantsArrayField?.includeDefaultField !== false) {\n      adminUsersCollection.fields.push(\n        tenantsArrayField({\n          ...(pluginConfig?.tenantsArrayField || {}),\n          tenantsArrayFieldName,\n          tenantsArrayTenantFieldName,\n          tenantsCollectionSlug,\n        }),\n      )\n    }\n\n    addCollectionAccess({\n      accessResultCallback: pluginConfig.usersAccessResultOverride,\n      adminUsersSlug: adminUsersCollection.slug,\n      collection: adminUsersCollection,\n      fieldName: `${tenantsArrayFieldName}.${tenantsArrayTenantFieldName}`,\n      tenantsArrayFieldName,\n      tenantsArrayTenantFieldName,\n      userHasAccessToAllTenants,\n    })\n\n    if (pluginConfig.useUsersTenantFilter !== false) {\n      if (!adminUsersCollection.admin) {\n        adminUsersCollection.admin = {}\n      }\n\n      const baseFilter =\n        adminUsersCollection.admin?.baseFilter ?? adminUsersCollection.admin?.baseListFilter\n      adminUsersCollection.admin.baseFilter = combineFilters({\n        baseFilter,\n        customFilter: (args) =>\n          filterDocumentsByTenants<ConfigType>({\n            filterFieldName: `${tenantsArrayFieldName}.${tenantsArrayTenantFieldName}`,\n            req: args.req,\n            tenantsArrayFieldName,\n            tenantsArrayTenantFieldName,\n            tenantsCollectionSlug,\n            userHasAccessToAllTenants,\n          }),\n      })\n    }\n\n    let tenantCollection: CollectionConfig | undefined\n\n    const [collectionSlugs, globalCollectionSlugs] = Object.keys(pluginConfig.collections).reduce<\n      [string[], string[]]\n    >(\n      (acc, slug) => {\n        if (pluginConfig?.collections?.[slug]?.isGlobal) {\n          acc[1].push(slug)\n        } else {\n          acc[0].push(slug)\n        }\n\n        return acc\n      },\n      [[], []],\n    )\n\n    // used to track and not duplicate filterOptions on referenced blocks\n    const blockReferencesWithFilters: string[] = []\n\n    // used to validate enabled collection slugs\n    const multiTenantCollectionsFound: string[] = []\n\n    /**\n     * The folders collection is added AFTER the plugin is initialized\n     * so if they added the folder slug to the plugin collections,\n     * we can assume that they have folders enabled\n     */\n    const foldersSlug = incomingConfig.folders\n      ? incomingConfig.folders.slug || 'payload-folders'\n      : 'payload-folders'\n\n    if (collectionSlugs.includes(foldersSlug)) {\n      multiTenantCollectionsFound.push(foldersSlug)\n      incomingConfig.folders = incomingConfig.folders || {}\n      incomingConfig.folders.collectionOverrides = incomingConfig.folders.collectionOverrides || []\n      incomingConfig.folders.collectionOverrides.push(({ collection }) => {\n        /**\n         * Add filter options to all relationship fields\n         */\n        collection.fields = addFilterOptionsToFields({\n          blockReferencesWithFilters,\n          config: incomingConfig,\n          fields: collection.fields,\n          tenantEnabledCollectionSlugs: collectionSlugs,\n          tenantEnabledGlobalSlugs: globalCollectionSlugs,\n          tenantFieldName,\n          tenantsArrayFieldName,\n          tenantsArrayTenantFieldName,\n          tenantsCollectionSlug,\n          userHasAccessToAllTenants,\n        })\n\n        if (pluginConfig.collections[foldersSlug]?.customTenantField !== true) {\n          /**\n           * Add tenant field to enabled collections\n           */\n          collection.fields.unshift(\n            tenantField({\n              name: tenantFieldName,\n              debug: pluginConfig.debug,\n              isAutosaveEnabled: hasAutosaveEnabled(collection),\n              overrides: pluginConfig.collections[collection.slug]?.tenantFieldOverrides\n                ? pluginConfig.collections[collection.slug]?.tenantFieldOverrides\n                : pluginConfig.tenantField || {},\n              tenantsArrayFieldName,\n              tenantsArrayTenantFieldName,\n              tenantsCollectionSlug,\n              unique: false,\n            }),\n          )\n        }\n\n        const { useBaseFilter, useBaseListFilter } = pluginConfig.collections[collection.slug] || {}\n        if (useBaseFilter ?? useBaseListFilter ?? true) {\n          /**\n           * Add list filter to enabled collections\n           * - filters results by selected tenant\n           */\n          collection.admin = collection.admin || {}\n          collection.admin.baseFilter = combineFilters({\n            baseFilter: collection.admin?.baseFilter ?? collection.admin?.baseListFilter,\n            customFilter: (args) =>\n              filterDocumentsByTenants<ConfigType>({\n                filterFieldName: tenantFieldName,\n                req: args.req,\n                tenantsArrayFieldName,\n                tenantsArrayTenantFieldName,\n                tenantsCollectionSlug,\n                userHasAccessToAllTenants,\n              }),\n          })\n        }\n\n        if (pluginConfig.collections[foldersSlug]?.useTenantAccess !== false) {\n          /**\n           * Add access control constraint to tenant enabled folders collection\n           */\n          addCollectionAccess({\n            accessResultCallback: pluginConfig.collections[foldersSlug]?.accessResultOverride,\n            adminUsersSlug: adminUsersCollection.slug,\n            collection,\n            fieldName: tenantFieldName,\n            tenantsArrayFieldName,\n            tenantsArrayTenantFieldName,\n            userHasAccessToAllTenants,\n          })\n        }\n\n        return collection\n      })\n    }\n\n    /**\n     * Modify collections\n     */\n    incomingConfig.collections.forEach((collection) => {\n      /**\n       * Modify tenants collection\n       */\n      if (collection.slug === tenantsCollectionSlug) {\n        tenantCollection = collection\n\n        if (pluginConfig.useTenantsCollectionAccess !== false) {\n          /**\n           * Add access control constraint to tenants collection\n           * - constrains access a users assigned tenants\n           */\n          addCollectionAccess({\n            adminUsersSlug: adminUsersCollection.slug,\n            collection,\n            fieldName: 'id',\n            tenantsArrayFieldName,\n            tenantsArrayTenantFieldName,\n            userHasAccessToAllTenants,\n          })\n        }\n\n        if (pluginConfig.useTenantsListFilter !== false) {\n          /**\n           * Add list filter to tenants collection\n           * - filter by selected tenant\n           */\n          if (!collection.admin) {\n            collection.admin = {}\n          }\n\n          const baseFilter = collection.admin?.baseFilter ?? collection.admin?.baseListFilter\n          collection.admin.baseFilter = combineFilters({\n            baseFilter,\n            customFilter: (args) =>\n              filterDocumentsByTenants({\n                filterFieldName: 'id',\n                req: args.req,\n                tenantsArrayFieldName,\n                tenantsArrayTenantFieldName,\n                tenantsCollectionSlug,\n                userHasAccessToAllTenants,\n              }),\n          })\n        }\n\n        if (pluginConfig.cleanupAfterTenantDelete !== false) {\n          /**\n           * Add cleanup logic when tenant is deleted\n           * - delete documents related to tenant\n           * - remove tenant from users\n           */\n          addTenantCleanup({\n            collection,\n            enabledSlugs: [...collectionSlugs, ...globalCollectionSlugs],\n            tenantFieldName,\n            tenantsCollectionSlug,\n            usersSlug: adminUsersCollection.slug,\n            usersTenantsArrayFieldName: tenantsArrayFieldName,\n            usersTenantsArrayTenantFieldName: tenantsArrayTenantFieldName,\n          })\n        }\n\n        /**\n         * Add custom tenant field that watches and dispatches updates to the selector\n         */\n        collection.fields.push({\n          name: '_watchTenant',\n          type: 'ui',\n          admin: {\n            components: {\n              Field: {\n                path: '@payloadcms/plugin-multi-tenant/client#WatchTenantCollection',\n              },\n            },\n            disableBulkEdit: true,\n            disableListColumn: true,\n          },\n        })\n\n        collection.endpoints = [\n          ...(collection.endpoints || []),\n          getTenantOptionsEndpoint({\n            tenantsArrayFieldName,\n            tenantsArrayTenantFieldName,\n            tenantsCollectionSlug,\n            useAsTitle: tenantCollection.admin?.useAsTitle || 'id',\n            userHasAccessToAllTenants,\n          }),\n        ]\n      } else if (pluginConfig.collections?.[collection.slug]) {\n        multiTenantCollectionsFound.push(collection.slug)\n        const isGlobal = Boolean(pluginConfig.collections[collection.slug]?.isGlobal)\n\n        if (isGlobal) {\n          collection.disableDuplicate = true\n        }\n\n        if (!pluginConfig.debug && !isGlobal) {\n          collection.admin ??= {}\n          collection.admin.components ??= {}\n          collection.admin.components.edit ??= {}\n          collection.admin.components.edit.editMenuItems ??= []\n          collection.admin.components.edit.editMenuItems.push({\n            path: '@payloadcms/plugin-multi-tenant/client#AssignTenantFieldTrigger',\n          })\n        }\n\n        /**\n         * Add filter options to all relationship fields\n         */\n        collection.fields = addFilterOptionsToFields({\n          blockReferencesWithFilters,\n          config: incomingConfig,\n          fields: collection.fields,\n          tenantEnabledCollectionSlugs: collectionSlugs,\n          tenantEnabledGlobalSlugs: globalCollectionSlugs,\n          tenantFieldName,\n          tenantsArrayFieldName,\n          tenantsArrayTenantFieldName,\n          tenantsCollectionSlug,\n          userHasAccessToAllTenants,\n        })\n\n        if (pluginConfig.collections[collection.slug]?.customTenantField !== true) {\n          /**\n           * Add tenant field to enabled collections\n           */\n          collection.fields.unshift(\n            tenantField({\n              name: tenantFieldName,\n              debug: pluginConfig.debug,\n              isAutosaveEnabled: hasAutosaveEnabled(collection),\n              overrides: pluginConfig.collections[collection.slug]?.tenantFieldOverrides\n                ? pluginConfig.collections[collection.slug]?.tenantFieldOverrides\n                : pluginConfig.tenantField || {},\n              tenantsArrayFieldName,\n              tenantsArrayTenantFieldName,\n              tenantsCollectionSlug,\n              unique: isGlobal,\n            }),\n          )\n        }\n\n        const { useBaseFilter, useBaseListFilter } = pluginConfig.collections[collection.slug] || {}\n        if (useBaseFilter ?? useBaseListFilter ?? true) {\n          /**\n           * Add list filter to enabled collections\n           * - filters results by selected tenant\n           */\n          collection.admin = collection.admin || {}\n          collection.admin.baseFilter = combineFilters({\n            baseFilter: collection.admin?.baseFilter ?? collection.admin?.baseListFilter,\n            customFilter: (args) =>\n              filterDocumentsByTenants({\n                filterFieldName: tenantFieldName,\n                req: args.req,\n                tenantsArrayFieldName,\n                tenantsArrayTenantFieldName,\n                tenantsCollectionSlug,\n                userHasAccessToAllTenants,\n              }),\n          })\n        }\n\n        if (pluginConfig.collections[collection.slug]?.useTenantAccess !== false) {\n          /**\n           * Add access control constraint to tenant enabled collection\n           */\n          addCollectionAccess({\n            accessResultCallback: pluginConfig.collections[collection.slug]?.accessResultOverride,\n            adminUsersSlug: adminUsersCollection.slug,\n            collection,\n            fieldName: tenantFieldName,\n            tenantsArrayFieldName,\n            tenantsArrayTenantFieldName,\n            userHasAccessToAllTenants,\n          })\n        }\n      }\n    })\n\n    if (!tenantCollection) {\n      throw new Error(`Tenants collection not found with slug: ${tenantsCollectionSlug}`)\n    }\n\n    if (\n      multiTenantCollectionsFound.length !==\n      collectionSlugs.length + globalCollectionSlugs.length\n    ) {\n      const missingSlugs = [...collectionSlugs, ...globalCollectionSlugs].filter(\n        (slug) => !multiTenantCollectionsFound.includes(slug),\n      )\n      // eslint-disable-next-line no-console\n      console.error(\n        miniChalk.yellowBold('WARNING (plugin-multi-tenant)'),\n        'missing collections',\n        missingSlugs,\n        'try placing the multi-tenant plugin after other plugins.',\n      )\n    }\n\n    /**\n     * Add TenantSelectionProvider to admin providers\n     */\n    incomingConfig.admin.components.providers.push({\n      clientProps: {\n        tenantsArrayFieldName,\n        tenantsArrayTenantFieldName,\n        tenantsCollectionSlug: tenantCollection.slug,\n        useAsTitle: tenantCollection.admin?.useAsTitle || 'id',\n        userHasAccessToAllTenants,\n      },\n      path: '@payloadcms/plugin-multi-tenant/rsc#TenantSelectionProvider',\n    })\n\n    /**\n     * Add global redirect action\n     */\n    if (globalCollectionSlugs.length) {\n      incomingConfig.admin.components.actions.push({\n        path: '@payloadcms/plugin-multi-tenant/rsc#GlobalViewRedirect',\n        serverProps: {\n          basePath,\n          globalSlugs: globalCollectionSlugs,\n          tenantFieldName,\n          tenantsArrayFieldName,\n          tenantsArrayTenantFieldName,\n          tenantsCollectionSlug,\n          useAsTitle: tenantCollection.admin?.useAsTitle || 'id',\n          userHasAccessToAllTenants,\n        },\n      })\n    }\n\n    /**\n     * Add tenant selector to admin UI\n     */\n    incomingConfig.admin.components.beforeNavLinks.push({\n      clientProps: {\n        enabledSlugs: [\n          ...collectionSlugs,\n          ...globalCollectionSlugs,\n          adminUsersCollection.slug,\n          tenantCollection.slug,\n        ],\n        label: pluginConfig.tenantSelectorLabel || undefined,\n      },\n      path: '@payloadcms/plugin-multi-tenant/rsc#TenantSelector',\n    })\n\n    /**\n     * Merge plugin translations\n     */\n    if (!incomingConfig.i18n) {\n      incomingConfig.i18n = {}\n    }\n    Object.entries(translations).forEach(([locale, pluginI18nObject]) => {\n      const typedLocale = locale as AcceptedLanguages\n      if (!incomingConfig.i18n!.translations) {\n        incomingConfig.i18n!.translations = {}\n      }\n      if (!(typedLocale in incomingConfig.i18n!.translations)) {\n        incomingConfig.i18n!.translations[typedLocale] = {}\n      }\n      if (!('plugin-multi-tenant' in incomingConfig.i18n!.translations[typedLocale]!)) {\n        ;(incomingConfig.i18n!.translations[typedLocale] as PluginDefaultTranslationsObject)[\n          'plugin-multi-tenant'\n        ] = {} as PluginDefaultTranslationsObject['plugin-multi-tenant']\n      }\n\n      ;(incomingConfig.i18n!.translations[typedLocale] as PluginDefaultTranslationsObject)[\n        'plugin-multi-tenant'\n      ] = {\n        ...pluginI18nObject.translations['plugin-multi-tenant'],\n        ...(pluginConfig.i18n?.translations?.[typedLocale] || {}),\n      }\n    })\n\n    return incomingConfig\n  }\n"],"names":["hasAutosaveEnabled","defaults","getTenantOptionsEndpoint","tenantField","tenantsArrayField","filterDocumentsByTenants","addTenantCleanup","translations","addCollectionAccess","addFilterOptionsToFields","combineFilters","miniChalk","multiTenantPlugin","pluginConfig","incomingConfig","enabled","userHasAccessToAllTenants","tenantsCollectionSlug","tenantsSlug","tenantCollectionSlug","tenantFieldName","name","tenantsArrayFieldName","arrayFieldName","tenantsArrayTenantFieldName","arrayTenantFieldName","basePath","admin","components","actions","beforeNavLinks","providers","collections","adminUsersCollection","find","slug","auth","user","Error","includeDefaultField","fields","push","accessResultCallback","usersAccessResultOverride","adminUsersSlug","collection","fieldName","useUsersTenantFilter","baseFilter","baseListFilter","customFilter","args","filterFieldName","req","tenantCollection","collectionSlugs","globalCollectionSlugs","Object","keys","reduce","acc","isGlobal","blockReferencesWithFilters","multiTenantCollectionsFound","foldersSlug","folders","includes","collectionOverrides","config","tenantEnabledCollectionSlugs","tenantEnabledGlobalSlugs","customTenantField","unshift","debug","isAutosaveEnabled","overrides","tenantFieldOverrides","unique","useBaseFilter","useBaseListFilter","useTenantAccess","accessResultOverride","forEach","useTenantsCollectionAccess","useTenantsListFilter","cleanupAfterTenantDelete","enabledSlugs","usersSlug","usersTenantsArrayFieldName","usersTenantsArrayTenantFieldName","type","Field","path","disableBulkEdit","disableListColumn","endpoints","useAsTitle","Boolean","disableDuplicate","edit","editMenuItems","length","missingSlugs","filter","console","error","yellowBold","clientProps","serverProps","globalSlugs","label","tenantSelectorLabel","undefined","i18n","entries","locale","pluginI18nObject","typedLocale"],"mappings":"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"}