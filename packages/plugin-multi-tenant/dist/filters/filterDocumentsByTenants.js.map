{"version":3,"sources":["../../src/filters/filterDocumentsByTenants.ts"],"sourcesContent":["import type { PayloadRequest, TypedUser, Where } from 'payload'\n\nimport type { MultiTenantPluginConfig } from '../types.js'\n\nimport { defaults } from '../defaults.js'\nimport { getCollectionIDType } from '../utilities/getCollectionIDType.js'\nimport { getTenantFromCookie } from '../utilities/getTenantFromCookie.js'\nimport { getUserTenantIDs } from '../utilities/getUserTenantIDs.js'\n\ntype Args<ConfigType = unknown> = {\n  /**\n   * If the document this filter is run belongs to a tenant, the tenant ID should be passed here.\n   * If set, this will be used instead of the tenant cookie\n   */\n  docTenantID?: number | string\n  filterFieldName: string\n  req: PayloadRequest\n  tenantsArrayFieldName?: string\n  tenantsArrayTenantFieldName?: string\n  tenantsCollectionSlug: string\n  userHasAccessToAllTenants: Required<\n    MultiTenantPluginConfig<ConfigType>\n  >['userHasAccessToAllTenants']\n}\nexport const filterDocumentsByTenants = <ConfigType = unknown>({\n  docTenantID,\n  filterFieldName,\n  req,\n  tenantsArrayFieldName = defaults.tenantsArrayFieldName,\n  tenantsArrayTenantFieldName = defaults.tenantsArrayTenantFieldName,\n  tenantsCollectionSlug,\n  userHasAccessToAllTenants,\n}: Args<ConfigType>): null | Where => {\n  const idType = getCollectionIDType({\n    collectionSlug: tenantsCollectionSlug,\n    payload: req.payload,\n  })\n\n  // scope results to selected tenant\n  const selectedTenant = docTenantID ?? getTenantFromCookie(req.headers, idType)\n  if (selectedTenant) {\n    return {\n      [filterFieldName]: {\n        in: [selectedTenant],\n      },\n    }\n  }\n\n  if (\n    req.user &&\n    userHasAccessToAllTenants(\n      req?.user as ConfigType extends { user: unknown } ? ConfigType['user'] : TypedUser,\n    )\n  ) {\n    return null\n  }\n\n  // scope to user assigned tenants\n  const userAssignedTenants = getUserTenantIDs(req.user, {\n    tenantsArrayFieldName,\n    tenantsArrayTenantFieldName,\n  })\n  if (userAssignedTenants.length > 0) {\n    return {\n      [filterFieldName]: {\n        in: userAssignedTenants,\n      },\n    }\n  }\n\n  // no tenant selected and no user tenants, return null to allow access control to handle it\n  return null\n}\n"],"names":["defaults","getCollectionIDType","getTenantFromCookie","getUserTenantIDs","filterDocumentsByTenants","docTenantID","filterFieldName","req","tenantsArrayFieldName","tenantsArrayTenantFieldName","tenantsCollectionSlug","userHasAccessToAllTenants","idType","collectionSlug","payload","selectedTenant","headers","in","user","userAssignedTenants","length"],"mappings":"AAIA,SAASA,QAAQ,QAAQ,iBAAgB;AACzC,SAASC,mBAAmB,QAAQ,sCAAqC;AACzE,SAASC,mBAAmB,QAAQ,sCAAqC;AACzE,SAASC,gBAAgB,QAAQ,mCAAkC;AAiBnE,OAAO,MAAMC,2BAA2B,CAAuB,EAC7DC,WAAW,EACXC,eAAe,EACfC,GAAG,EACHC,wBAAwBR,SAASQ,qBAAqB,EACtDC,8BAA8BT,SAASS,2BAA2B,EAClEC,qBAAqB,EACrBC,yBAAyB,EACR;IACjB,MAAMC,SAASX,oBAAoB;QACjCY,gBAAgBH;QAChBI,SAASP,IAAIO,OAAO;IACtB;IAEA,mCAAmC;IACnC,MAAMC,iBAAiBV,eAAeH,oBAAoBK,IAAIS,OAAO,EAAEJ;IACvE,IAAIG,gBAAgB;QAClB,OAAO;YACL,CAACT,gBAAgB,EAAE;gBACjBW,IAAI;oBAACF;iBAAe;YACtB;QACF;IACF;IAEA,IACER,IAAIW,IAAI,IACRP,0BACEJ,KAAKW,OAEP;QACA,OAAO;IACT;IAEA,iCAAiC;IACjC,MAAMC,sBAAsBhB,iBAAiBI,IAAIW,IAAI,EAAE;QACrDV;QACAC;IACF;IACA,IAAIU,oBAAoBC,MAAM,GAAG,GAAG;QAClC,OAAO;YACL,CAACd,gBAAgB,EAAE;gBACjBW,IAAIE;YACN;QACF;IACF;IAEA,2FAA2F;IAC3F,OAAO;AACT,EAAC"}