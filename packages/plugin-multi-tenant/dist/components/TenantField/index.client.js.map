{"version":3,"sources":["../../../src/components/TenantField/index.client.tsx"],"sourcesContent":["'use client'\n\nimport type { RelationshipFieldClientProps } from 'payload'\n\nimport {\n  Pill,\n  RelationshipField,\n  useDocumentInfo,\n  useField,\n  useForm,\n  useFormModified,\n  useModal,\n} from '@payloadcms/ui'\nimport React from 'react'\n\nimport { useTenantSelection } from '../../providers/TenantSelectionProvider/index.client.js'\nimport {\n  AssignTenantFieldModal,\n  assignTenantModalSlug,\n} from '../AssignTenantFieldModal/index.client.js'\nimport './index.scss'\n\nconst baseClass = 'tenantField'\n\ntype Props = {\n  debug?: boolean\n  unique?: boolean\n} & RelationshipFieldClientProps\n\nexport const TenantField = ({ debug, unique, ...fieldArgs }: Props) => {\n  const { entityType, options, selectedTenantID, setEntityType, setTenant } = useTenantSelection()\n  const { setValue, showError, value } = useField<(number | string)[] | (number | string)>()\n  const modified = useFormModified()\n  const { isValid: isFormValid, setModified } = useForm()\n  const { id: docID, collectionSlug } = useDocumentInfo()\n  const { isModalOpen, openModal } = useModal()\n  const isEditManyModalOpen = collectionSlug ? isModalOpen(`edit-${collectionSlug}`) : false\n  const isConfirmingRef = React.useRef<boolean>(false)\n  const prevModified = React.useRef(modified)\n  const prevValue = React.useRef<typeof value>(value)\n  const showField =\n    (options.length > 1 && !fieldArgs.field.admin?.hidden && !fieldArgs.field.hidden) || debug\n\n  const onConfirm = React.useCallback(() => {\n    isConfirmingRef.current = true\n  }, [])\n\n  const afterModalOpen = React.useCallback(() => {\n    prevModified.current = modified\n    prevValue.current = value\n  }, [modified, value])\n\n  const afterModalClose = React.useCallback(() => {\n    let didChange = true\n    if (isConfirmingRef.current) {\n      // did the values actually change?\n      if (fieldArgs.field.hasMany) {\n        const prev = (prevValue.current || []) as (number | string)[]\n        const newValue = (value || []) as (number | string)[]\n        if (prev.length !== newValue.length) {\n          didChange = true\n        } else {\n          const allMatch = newValue.every((val) => prev.includes(val))\n          if (allMatch) {\n            didChange = false\n          }\n        }\n      } else if (value === prevValue.current) {\n        didChange = false\n      }\n\n      if (didChange) {\n        prevModified.current = true\n        prevValue.current = value\n      }\n    }\n\n    setValue(prevValue.current, true)\n    setModified(prevModified.current)\n\n    isConfirmingRef.current = false\n  }, [setValue, setModified, value, fieldArgs.field.hasMany])\n\n  React.useEffect(() => {\n    if (!entityType) {\n      setEntityType(unique ? 'global' : 'document')\n    } else {\n      // unique documents are controlled from the global TenantSelector\n      if (!unique && value) {\n        if (Array.isArray(value)) {\n          if (value.length) {\n            if (!selectedTenantID) {\n              setTenant({ id: value[0], refresh: false })\n            } else if (!value.includes(selectedTenantID)) {\n              setTenant({ id: value[0], refresh: false })\n            }\n          }\n        } else if (selectedTenantID !== value) {\n          setTenant({ id: value, refresh: false })\n        }\n      }\n    }\n\n    return () => {\n      if (entityType) {\n        setEntityType(undefined)\n      }\n    }\n  }, [unique, options, selectedTenantID, setTenant, value, setEntityType, entityType])\n\n  React.useEffect(() => {\n    if (unique) {\n      return\n    }\n    if ((!isFormValid && showError && showField) || (!value && !selectedTenantID)) {\n      openModal(assignTenantModalSlug)\n    }\n  }, [isFormValid, showError, showField, openModal, value, docID, selectedTenantID, unique])\n\n  if (showField) {\n    if (debug || isEditManyModalOpen) {\n      return <TenantRelationshipField debug={debug} fieldArgs={fieldArgs} unique={unique} />\n    }\n\n    if (!unique) {\n      /** Editing a non-global tenant document */\n      return (\n        <AssignTenantFieldModal\n          afterModalClose={afterModalClose}\n          afterModalOpen={afterModalOpen}\n          onConfirm={onConfirm}\n        >\n          <TenantRelationshipField fieldArgs={fieldArgs} unique={unique} />\n        </AssignTenantFieldModal>\n      )\n    }\n\n    return <SyncFormModified />\n  }\n\n  return null\n}\n\nconst TenantRelationshipField: React.FC<{\n  debug?: boolean\n  fieldArgs: RelationshipFieldClientProps\n  unique?: boolean\n}> = ({ debug, fieldArgs, unique }) => {\n  return (\n    <div className={baseClass}>\n      <div className={`${baseClass}__wrapper`}>\n        {debug && (\n          <Pill className={`${baseClass}__debug-pill`} pillStyle=\"success\" size=\"small\">\n            Multi-Tenant Debug Enabled\n          </Pill>\n        )}\n        <RelationshipField\n          {...fieldArgs}\n          field={{\n            ...fieldArgs.field,\n            required: true,\n          }}\n          readOnly={fieldArgs.readOnly || fieldArgs.field.admin?.readOnly || unique}\n        />\n      </div>\n    </div>\n  )\n}\n\n/**\n * Tells the global selector when the form has been modified\n * so it can display the \"Leave without saving\" confirmation modal\n * if modified and attempting to change the tenant\n */\nconst SyncFormModified = () => {\n  const modified = useFormModified()\n  const { setModified } = useTenantSelection()\n\n  React.useEffect(() => {\n    setModified(modified)\n  }, [modified, setModified])\n\n  return null\n}\n"],"names":["Pill","RelationshipField","useDocumentInfo","useField","useForm","useFormModified","useModal","React","useTenantSelection","AssignTenantFieldModal","assignTenantModalSlug","baseClass","TenantField","debug","unique","fieldArgs","entityType","options","selectedTenantID","setEntityType","setTenant","setValue","showError","value","modified","isValid","isFormValid","setModified","id","docID","collectionSlug","isModalOpen","openModal","isEditManyModalOpen","isConfirmingRef","useRef","prevModified","prevValue","showField","length","field","admin","hidden","onConfirm","useCallback","current","afterModalOpen","afterModalClose","didChange","hasMany","prev","newValue","allMatch","every","val","includes","useEffect","Array","isArray","refresh","undefined","TenantRelationshipField","SyncFormModified","div","className","pillStyle","size","required","readOnly"],"mappings":"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"}