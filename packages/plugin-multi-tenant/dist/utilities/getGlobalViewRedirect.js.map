{"version":3,"sources":["../../src/utilities/getGlobalViewRedirect.ts"],"sourcesContent":["import type { Payload, TypedUser, ViewTypes } from 'payload'\n\nimport { unauthorized } from 'next/navigation.js'\nimport { formatAdminURL, hasAutosaveEnabled } from 'payload/shared'\n\nimport type { MultiTenantPluginConfig } from '../types.js'\n\nimport { getCollectionIDType } from './getCollectionIDType.js'\nimport { getTenantFromCookie } from './getTenantFromCookie.js'\nimport { getTenantOptions } from './getTenantOptions.js'\n\ntype Args = {\n  /**\n   * This is no longer needed and is handled internally.\n   *\n   * @deprecated\n   */\n  basePath?: string\n  docID?: number | string\n  headers: Headers\n  payload: Payload\n  slug: string\n  tenantFieldName: string\n  tenantsArrayFieldName: string\n  tenantsArrayTenantFieldName: string\n  tenantsCollectionSlug: string\n  useAsTitle: string\n  user?: TypedUser\n  userHasAccessToAllTenants: Required<MultiTenantPluginConfig<any>>['userHasAccessToAllTenants']\n  view: ViewTypes\n}\nexport async function getGlobalViewRedirect({\n  slug: collectionSlug,\n  docID,\n  headers,\n  payload,\n  tenantFieldName,\n  tenantsArrayFieldName,\n  tenantsArrayTenantFieldName,\n  tenantsCollectionSlug,\n  useAsTitle,\n  user,\n  userHasAccessToAllTenants,\n  view,\n}: Args): Promise<string | void> {\n  const idType = getCollectionIDType({\n    collectionSlug: tenantsCollectionSlug,\n    payload,\n  })\n  let tenant = getTenantFromCookie(headers, idType)\n  let redirectRoute: `/${string}` | void = undefined\n\n  if (!user) {\n    return unauthorized()\n  }\n\n  if (!tenant) {\n    const tenantOptions = await getTenantOptions({\n      payload,\n      tenantsArrayFieldName,\n      tenantsArrayTenantFieldName,\n      tenantsCollectionSlug,\n      useAsTitle,\n      user,\n      userHasAccessToAllTenants,\n    })\n\n    tenant = tenantOptions[0]?.value || null\n  }\n\n  if (tenant) {\n    try {\n      const globalTenantDocQuery = await payload.find({\n        collection: collectionSlug,\n        depth: 0,\n        limit: 1,\n        pagination: false,\n        select: {\n          id: true,\n        },\n        where: {\n          [tenantFieldName]: {\n            in: [tenant],\n          },\n        },\n      })\n\n      const globalTenantDocID = globalTenantDocQuery?.docs?.[0]?.id\n\n      if (view === 'document') {\n        // global tenant document edit view\n        if (globalTenantDocID && docID !== globalTenantDocID) {\n          // tenant document already exists but does not match current route docID\n          // redirect to matching tenant docID from query\n          redirectRoute = `/collections/${collectionSlug}/${globalTenantDocID}`\n        } else if (docID && !globalTenantDocID) {\n          // a docID was found in the route but no global document with this tenant exists\n          // so we need to generate a redirect to the create route\n          redirectRoute = await generateCreateRedirect({\n            collectionSlug,\n            payload,\n            tenantID: tenant,\n          })\n        }\n      } else if (view === 'list') {\n        // global tenant document list view\n        if (globalTenantDocID) {\n          // tenant document exists, redirect from list view to the document edit view\n          redirectRoute = `/collections/${collectionSlug}/${globalTenantDocID}`\n        } else {\n          // no matching document was found for the current tenant\n          // so we need to generate a redirect to the create route\n          redirectRoute = await generateCreateRedirect({\n            collectionSlug,\n            payload,\n            tenantID: tenant,\n          })\n        }\n      }\n    } catch (e: unknown) {\n      const prefix = `${e && typeof e === 'object' && 'message' in e && typeof e.message === 'string' ? `${e.message} - ` : ''}`\n      payload.logger.error(e, `${prefix}Multi Tenant Redirect Error`)\n    }\n  } else {\n    // no tenants were found, redirect to the admin view\n    return formatAdminURL({\n      adminRoute: payload.config.routes.admin,\n      path: '',\n      serverURL: payload.config.serverURL,\n    })\n  }\n\n  if (redirectRoute) {\n    return formatAdminURL({\n      adminRoute: payload.config.routes.admin,\n      path: redirectRoute,\n      serverURL: payload.config.serverURL,\n    })\n  }\n\n  // no redirect is needed\n  // the current route is valid\n  return undefined\n}\n\ntype GenerateCreateArgs = {\n  collectionSlug: string\n  payload: Payload\n  tenantID: number | string\n}\n/**\n * Generate a redirect URL for creating a new document in a multi-tenant collection.\n *\n * If autosave is enabled on the collection, we need to create the document and then redirect to it.\n * Otherwise we can redirect to the default create route.\n */\nasync function generateCreateRedirect({\n  collectionSlug,\n  payload,\n  tenantID,\n}: GenerateCreateArgs): Promise<`/${string}` | undefined> {\n  const collectionConfig = payload.collections[collectionSlug]?.config\n  if (hasAutosaveEnabled(collectionConfig!)) {\n    // Autosave is enabled, create a document first\n    try {\n      const doc = await payload.create({\n        collection: collectionSlug,\n        data: {\n          tenant: tenantID,\n        },\n        depth: 0,\n        draft: true,\n        select: {\n          id: true,\n        },\n      })\n      return `/collections/${collectionSlug}/${doc.id}`\n    } catch (error) {\n      payload.logger.error(\n        error,\n        `Error creating autosave global multi tenant document for ${collectionSlug}`,\n      )\n    }\n\n    return '/'\n  }\n\n  // Autosave is not enabled, redirect to default create route\n  return `/collections/${collectionSlug}/create`\n}\n"],"names":["unauthorized","formatAdminURL","hasAutosaveEnabled","getCollectionIDType","getTenantFromCookie","getTenantOptions","getGlobalViewRedirect","slug","collectionSlug","docID","headers","payload","tenantFieldName","tenantsArrayFieldName","tenantsArrayTenantFieldName","tenantsCollectionSlug","useAsTitle","user","userHasAccessToAllTenants","view","idType","tenant","redirectRoute","undefined","tenantOptions","value","globalTenantDocQuery","find","collection","depth","limit","pagination","select","id","where","in","globalTenantDocID","docs","generateCreateRedirect","tenantID","e","prefix","message","logger","error","adminRoute","config","routes","admin","path","serverURL","collectionConfig","collections","doc","create","data","draft"],"mappings":"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"}