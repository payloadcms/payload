{"version":3,"sources":["../../src/utilities/withTenantAccess.ts"],"sourcesContent":["import type { Access, AccessArgs, AccessResult, CollectionConfig, TypedUser, Where } from 'payload'\n\nimport type { AllAccessKeys, MultiTenantPluginConfig, UserWithTenantsField } from '../types.js'\n\nimport { combineWhereConstraints } from './combineWhereConstraints.js'\nimport { getTenantAccess } from './getTenantAccess.js'\n\ntype Args<ConfigType> = {\n  accessFunction?: Access\n  accessKey: AllAccessKeys[number]\n  accessResultCallback?: MultiTenantPluginConfig<ConfigType>['usersAccessResultOverride']\n  adminUsersSlug: string\n  collection: CollectionConfig\n  fieldName: string\n  tenantsArrayFieldName?: string\n  tenantsArrayTenantFieldName?: string\n  userHasAccessToAllTenants: Required<\n    MultiTenantPluginConfig<ConfigType>\n  >['userHasAccessToAllTenants']\n}\nexport const withTenantAccess =\n  <ConfigType>({\n    accessFunction,\n    accessKey,\n    accessResultCallback,\n    adminUsersSlug,\n    collection,\n    fieldName,\n    tenantsArrayFieldName,\n    tenantsArrayTenantFieldName,\n    userHasAccessToAllTenants,\n  }: Args<ConfigType>) =>\n  async (args: AccessArgs): Promise<AccessResult> => {\n    const constraints: Where[] = []\n    const accessFn =\n      typeof accessFunction === 'function'\n        ? accessFunction\n        : ({ req }: AccessArgs): AccessResult => Boolean(req.user)\n    const accessResult: AccessResult = await accessFn(args)\n\n    if (accessResult === false) {\n      if (accessResultCallback) {\n        return accessResultCallback({\n          accessKey,\n          accessResult: false,\n          ...args,\n        })\n      } else {\n        return false\n      }\n    } else if (accessResult && typeof accessResult === 'object') {\n      constraints.push(accessResult)\n    }\n\n    if (\n      args.req.user &&\n      args.req.user.collection === adminUsersSlug &&\n      !userHasAccessToAllTenants(\n        args.req.user as ConfigType extends { user: unknown } ? ConfigType['user'] : TypedUser,\n      )\n    ) {\n      const tenantConstraint = getTenantAccess({\n        fieldName,\n        tenantsArrayFieldName,\n        tenantsArrayTenantFieldName,\n        user: args.req.user as UserWithTenantsField,\n      })\n      if (collection.slug === args.req.user.collection) {\n        constraints.push({\n          or: [\n            {\n              id: {\n                equals: args.req.user.id,\n              },\n            },\n            tenantConstraint,\n          ],\n        })\n      } else {\n        constraints.push(tenantConstraint)\n      }\n\n      if (accessResultCallback) {\n        return accessResultCallback({\n          accessKey,\n          accessResult: combineWhereConstraints(constraints),\n          ...args,\n        })\n      } else {\n        return combineWhereConstraints(constraints)\n      }\n    }\n\n    if (accessResultCallback) {\n      return accessResultCallback({\n        accessKey,\n        accessResult,\n        ...args,\n      })\n    } else {\n      return accessResult\n    }\n  }\n"],"names":["combineWhereConstraints","getTenantAccess","withTenantAccess","accessFunction","accessKey","accessResultCallback","adminUsersSlug","collection","fieldName","tenantsArrayFieldName","tenantsArrayTenantFieldName","userHasAccessToAllTenants","args","constraints","accessFn","req","Boolean","user","accessResult","push","tenantConstraint","slug","or","id","equals"],"mappings":"AAIA,SAASA,uBAAuB,QAAQ,+BAA8B;AACtE,SAASC,eAAe,QAAQ,uBAAsB;AAetD,OAAO,MAAMC,mBACX,CAAa,EACXC,cAAc,EACdC,SAAS,EACTC,oBAAoB,EACpBC,cAAc,EACdC,UAAU,EACVC,SAAS,EACTC,qBAAqB,EACrBC,2BAA2B,EAC3BC,yBAAyB,EACR,GACnB,OAAOC;QACL,MAAMC,cAAuB,EAAE;QAC/B,MAAMC,WACJ,OAAOX,mBAAmB,aACtBA,iBACA,CAAC,EAAEY,GAAG,EAAc,GAAmBC,QAAQD,IAAIE,IAAI;QAC7D,MAAMC,eAA6B,MAAMJ,SAASF;QAElD,IAAIM,iBAAiB,OAAO;YAC1B,IAAIb,sBAAsB;gBACxB,OAAOA,qBAAqB;oBAC1BD;oBACAc,cAAc;oBACd,GAAGN,IAAI;gBACT;YACF,OAAO;gBACL,OAAO;YACT;QACF,OAAO,IAAIM,gBAAgB,OAAOA,iBAAiB,UAAU;YAC3DL,YAAYM,IAAI,CAACD;QACnB;QAEA,IACEN,KAAKG,GAAG,CAACE,IAAI,IACbL,KAAKG,GAAG,CAACE,IAAI,CAACV,UAAU,KAAKD,kBAC7B,CAACK,0BACCC,KAAKG,GAAG,CAACE,IAAI,GAEf;YACA,MAAMG,mBAAmBnB,gBAAgB;gBACvCO;gBACAC;gBACAC;gBACAO,MAAML,KAAKG,GAAG,CAACE,IAAI;YACrB;YACA,IAAIV,WAAWc,IAAI,KAAKT,KAAKG,GAAG,CAACE,IAAI,CAACV,UAAU,EAAE;gBAChDM,YAAYM,IAAI,CAAC;oBACfG,IAAI;wBACF;4BACEC,IAAI;gCACFC,QAAQZ,KAAKG,GAAG,CAACE,IAAI,CAACM,EAAE;4BAC1B;wBACF;wBACAH;qBACD;gBACH;YACF,OAAO;gBACLP,YAAYM,IAAI,CAACC;YACnB;YAEA,IAAIf,sBAAsB;gBACxB,OAAOA,qBAAqB;oBAC1BD;oBACAc,cAAclB,wBAAwBa;oBACtC,GAAGD,IAAI;gBACT;YACF,OAAO;gBACL,OAAOZ,wBAAwBa;YACjC;QACF;QAEA,IAAIR,sBAAsB;YACxB,OAAOA,qBAAqB;gBAC1BD;gBACAc;gBACA,GAAGN,IAAI;YACT;QACF,OAAO;YACL,OAAOM;QACT;IACF,EAAC"}