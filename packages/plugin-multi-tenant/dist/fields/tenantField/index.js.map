{"version":3,"sources":["../../../src/fields/tenantField/index.ts"],"sourcesContent":["import type { RelationshipFieldValidation, SingleRelationshipField } from 'payload'\n\nimport type { RootTenantFieldConfigOverrides } from '../../types.js'\n\nimport { defaults } from '../../defaults.js'\nimport { getCollectionIDType } from '../../utilities/getCollectionIDType.js'\nimport { getTenantFromCookie } from '../../utilities/getTenantFromCookie.js'\nimport { getUserTenantIDs } from '../../utilities/getUserTenantIDs.js'\n\nconst fieldValidation =\n  (validateFunction?: RelationshipFieldValidation): RelationshipFieldValidation =>\n  (value, options) => {\n    if (validateFunction) {\n      const result = validateFunction(value, options)\n      if (result !== true) {\n        return result\n      }\n    }\n\n    if (options.hasMany) {\n      if (!value || (Array.isArray(value) && value.length === 0)) {\n        return options.req.t('validation:required')\n      }\n    } else {\n      if (!value) {\n        return options.req.t('validation:required')\n      }\n    }\n\n    return true\n  }\n\ntype Args = {\n  debug?: boolean\n  isAutosaveEnabled?: boolean\n  name: string\n  overrides?: RootTenantFieldConfigOverrides\n  tenantsArrayFieldName: string\n  tenantsArrayTenantFieldName: string\n  tenantsCollectionSlug: string\n  unique: boolean\n}\nexport const tenantField = ({\n  name = defaults.tenantFieldName,\n  debug,\n  isAutosaveEnabled,\n  overrides: _overrides = {},\n  tenantsArrayFieldName = defaults.tenantsArrayFieldName,\n  tenantsArrayTenantFieldName = defaults.tenantsArrayTenantFieldName,\n  tenantsCollectionSlug = defaults.tenantCollectionSlug,\n  unique,\n}: Args): SingleRelationshipField => {\n  const { hasMany = false, validate, ...overrides } = _overrides || {}\n  return {\n    ...(overrides || {}),\n    name,\n    type: 'relationship',\n    access: overrides.access || {},\n    admin: {\n      allowCreate: false,\n      allowEdit: false,\n      disableGroupBy: true,\n      disableListColumn: true,\n      disableListFilter: true,\n      position: 'sidebar',\n      ...(overrides.admin || {}),\n      components: {\n        ...(overrides.admin?.components || {}),\n        Field: {\n          path: '@payloadcms/plugin-multi-tenant/client#TenantField',\n          ...(typeof overrides.admin?.components?.Field !== 'string'\n            ? overrides.admin?.components?.Field || {}\n            : {}),\n          clientProps: {\n            ...(typeof overrides.admin?.components?.Field !== 'string'\n              ? (overrides.admin?.components?.Field || {})?.clientProps\n              : {}),\n            debug,\n            unique,\n          },\n        },\n      },\n    },\n    defaultValue:\n      overrides.defaultValue ||\n      (async ({ req }) => {\n        const idType = getCollectionIDType({\n          collectionSlug: tenantsCollectionSlug,\n          payload: req.payload,\n        })\n        const tenantFromCookie = getTenantFromCookie(req.headers, idType)\n        if (tenantFromCookie) {\n          const isValidTenant = await req.payload.count({\n            collection: tenantsCollectionSlug,\n            depth: 0,\n            overrideAccess: false,\n            req,\n            user: req.user,\n            where: {\n              id: {\n                in: [tenantFromCookie],\n              },\n            },\n          })\n          return isValidTenant ? tenantFromCookie : null\n        }\n        if (req.user && isAutosaveEnabled) {\n          const userTenants = getUserTenantIDs(req.user, {\n            tenantsArrayFieldName,\n            tenantsArrayTenantFieldName,\n          })\n          if (userTenants.length > 0) {\n            return userTenants[0]\n          }\n        }\n        return null\n      }),\n    filterOptions:\n      overrides.filterOptions ||\n      (({ req }) => {\n        const userAssignedTenants = getUserTenantIDs(req.user, {\n          tenantsArrayFieldName,\n          tenantsArrayTenantFieldName,\n        })\n        if (userAssignedTenants.length > 0) {\n          return {\n            id: {\n              in: userAssignedTenants,\n            },\n          }\n        }\n\n        return true\n      }),\n    index: true,\n    relationTo: tenantsCollectionSlug,\n    unique,\n    ...(hasMany\n      ? {\n          hasMany: true,\n          // TODO: V4 - replace validation with required: true\n          validate: fieldValidation(validate as RelationshipFieldValidation),\n        }\n      : {\n          hasMany: false,\n          // TODO: V4 - replace validation with required: true\n          validate: fieldValidation(validate as RelationshipFieldValidation),\n        }),\n    // @ts-expect-error translations are not typed for this plugin\n    label: overrides.label || (({ t }) => t('plugin-multi-tenant:field-assignedTenant-label')),\n  }\n}\n"],"names":["defaults","getCollectionIDType","getTenantFromCookie","getUserTenantIDs","fieldValidation","validateFunction","value","options","result","hasMany","Array","isArray","length","req","t","tenantField","name","tenantFieldName","debug","isAutosaveEnabled","overrides","_overrides","tenantsArrayFieldName","tenantsArrayTenantFieldName","tenantsCollectionSlug","tenantCollectionSlug","unique","validate","type","access","admin","allowCreate","allowEdit","disableGroupBy","disableListColumn","disableListFilter","position","components","Field","path","clientProps","defaultValue","idType","collectionSlug","payload","tenantFromCookie","headers","isValidTenant","count","collection","depth","overrideAccess","user","where","id","in","userTenants","filterOptions","userAssignedTenants","index","relationTo","label"],"mappings":"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"}