{"version":3,"sources":["../../../src/providers/TenantSelectionProvider/index.client.tsx"],"sourcesContent":["'use client'\n\nimport type { OptionObject } from 'payload'\n\nimport { toast, useAuth, useConfig } from '@payloadcms/ui'\nimport { useRouter } from 'next/navigation.js'\nimport { formatAdminURL } from 'payload/shared'\nimport React, { createContext } from 'react'\n\nimport { generateCookie } from '../../utilities/generateCookie.js'\n\ntype ContextType = {\n  /**\n   * What is the context of the selector? It is either 'document' | 'global' | undefined.\n   *\n   * - 'document' means you are viewing a document in the context of a tenant\n   * - 'global' means you are viewing a \"global\" (globals are collection documents but prevent you from viewing the list view) document in the context of a tenant\n   * - undefined means you are not viewing a document at all\n   */\n  entityType?: 'document' | 'global'\n  /**\n   * Hoists the forms modified state\n   */\n  modified?: boolean\n  /**\n   * Array of options to select from\n   */\n  options: OptionObject[]\n  /**\n   * The currently selected tenant ID\n   */\n  selectedTenantID: number | string | undefined\n  /**\n   * Sets the entityType when a document is loaded and sets it to undefined when the document unmounts.\n   */\n  setEntityType: React.Dispatch<React.SetStateAction<'document' | 'global' | undefined>>\n  /**\n   * Sets the modified state\n   */\n  setModified: React.Dispatch<React.SetStateAction<boolean>>\n  /**\n   * Sets the selected tenant ID\n   *\n   * @param args.id - The ID of the tenant to select\n   * @param args.refresh - Whether to refresh the page after changing the tenant\n   */\n  setTenant: (args: { id: number | string | undefined; refresh?: boolean }) => void\n  /**\n   * Used to sync tenants displayed in the tenant selector when updates are made to the tenants collection.\n   */\n  syncTenants: () => Promise<void>\n  /**\n   *\n   */\n  updateTenants: (args: { id: number | string; label: string }) => void\n}\n\nconst Context = createContext<ContextType>({\n  entityType: undefined,\n  options: [],\n  selectedTenantID: undefined,\n  setEntityType: () => undefined,\n  setModified: () => undefined,\n  setTenant: () => null,\n  syncTenants: () => Promise.resolve(),\n  updateTenants: () => null,\n})\n\nconst DEFAULT_COOKIE_NAME = 'payload-tenant'\n\nconst setTenantCookie = (args: { cookieName?: string; value: string }) => {\n  const { cookieName = DEFAULT_COOKIE_NAME, value } = args\n  document.cookie = generateCookie<string>({\n    name: cookieName,\n    maxAge: 60 * 60 * 24 * 365, // 1 year in seconds\n    path: '/',\n    returnCookieAsObject: false,\n    value: value || '',\n  })\n}\n\nconst deleteTenantCookie = (args: { cookieName?: string } = {}) => {\n  const { cookieName = DEFAULT_COOKIE_NAME } = args\n  document.cookie = generateCookie<string>({\n    name: cookieName,\n    maxAge: -1,\n    path: '/',\n    returnCookieAsObject: false,\n    value: '',\n  })\n}\n\nconst getTenantCookie = (args: { cookieName?: string } = {}): string | undefined => {\n  const { cookieName = DEFAULT_COOKIE_NAME } = args\n  const value = `; ${document.cookie}`\n  const parts = value.split(`; ${cookieName}=`)\n  if (parts.length === 2) {\n    return parts.pop()?.split(';').shift()\n  }\n  return undefined\n}\n\nexport const TenantSelectionProviderClient = ({\n  children,\n  initialTenantOptions,\n  initialValue,\n  tenantsCollectionSlug,\n}: {\n  children: React.ReactNode\n  initialTenantOptions: OptionObject[]\n  initialValue?: number | string\n  tenantsCollectionSlug: string\n}) => {\n  const [selectedTenantID, setSelectedTenantID] = React.useState<number | string | undefined>(\n    initialValue,\n  )\n  const [modified, setModified] = React.useState<boolean>(false)\n  const [entityType, setEntityType] = React.useState<'document' | 'global' | undefined>(undefined)\n  const { user } = useAuth()\n  const { config } = useConfig()\n  const router = useRouter()\n  const userID = React.useMemo(() => user?.id, [user?.id])\n  const prevUserID = React.useRef(userID)\n  const userChanged = userID !== prevUserID.current\n  const [tenantOptions, setTenantOptions] = React.useState<OptionObject[]>(\n    () => initialTenantOptions,\n  )\n  const selectedTenantLabel = React.useMemo(\n    () => tenantOptions.find((option) => option.value === selectedTenantID)?.label,\n    [selectedTenantID, tenantOptions],\n  )\n\n  const setTenantAndCookie = React.useCallback(\n    ({ id, refresh }: { id: number | string | undefined; refresh?: boolean }) => {\n      setSelectedTenantID(id)\n      if (id !== undefined) {\n        setTenantCookie({ value: String(id) })\n      } else {\n        deleteTenantCookie()\n      }\n      if (refresh) {\n        router.refresh()\n      }\n    },\n    [router],\n  )\n\n  const setTenant = React.useCallback<ContextType['setTenant']>(\n    ({ id, refresh }) => {\n      if (id === undefined) {\n        if (tenantOptions.length > 1 || tenantOptions.length === 0) {\n          // users with multiple tenants can clear the tenant selection\n          setTenantAndCookie({ id: undefined, refresh })\n        } else if (tenantOptions[0]) {\n          // if there is only one tenant, auto-select that tenant\n          setTenantAndCookie({ id: tenantOptions[0].value, refresh: true })\n        }\n      } else if (!tenantOptions.find((option) => option.value === id)) {\n        // if the tenant is invalid, set the first tenant as selected\n        setTenantAndCookie({\n          id: tenantOptions[0]?.value,\n          refresh,\n        })\n      } else {\n        // if the tenant is in the options, set it as selected\n        setTenantAndCookie({ id, refresh })\n      }\n    },\n    [tenantOptions, setTenantAndCookie],\n  )\n\n  const syncTenants = React.useCallback(async () => {\n    try {\n      const req = await fetch(\n        formatAdminURL({\n          apiRoute: config.routes.api,\n          path: `/${tenantsCollectionSlug}/populate-tenant-options`,\n        }),\n        {\n          credentials: 'include',\n          method: 'GET',\n        },\n      )\n\n      const result = await req.json()\n\n      if (result.tenantOptions && userID) {\n        setTenantOptions(result.tenantOptions)\n\n        if (result.tenantOptions.length === 1) {\n          setSelectedTenantID(result.tenantOptions[0].value)\n          setTenantCookie({ value: String(result.tenantOptions[0].value) })\n        }\n      }\n    } catch (e) {\n      toast.error(`Error fetching tenants`)\n    }\n  }, [config.routes.api, tenantsCollectionSlug, userID])\n\n  const updateTenants = React.useCallback<ContextType['updateTenants']>(\n    ({ id, label }) => {\n      setTenantOptions((prev) => {\n        return prev.map((currentTenant) => {\n          if (id === currentTenant.value) {\n            return {\n              label,\n              value: id,\n            }\n          }\n          return currentTenant\n        })\n      })\n\n      void syncTenants()\n    },\n    [syncTenants],\n  )\n\n  React.useEffect(() => {\n    if (userChanged || (initialValue && String(initialValue) !== getTenantCookie())) {\n      if (userID) {\n        // user logging in\n        void syncTenants()\n      } else {\n        // user logging out\n        setSelectedTenantID(undefined)\n        deleteTenantCookie()\n        if (tenantOptions.length > 0) {\n          setTenantOptions([])\n        }\n        router.refresh()\n      }\n      prevUserID.current = userID\n    }\n  }, [userID, userChanged, syncTenants, tenantOptions, initialValue, router])\n\n  /**\n   * If there is no initial value, clear the tenant and refresh the router.\n   * Needed for stale tenantIDs set as a cookie.\n   */\n  React.useEffect(() => {\n    if (!initialValue) {\n      setTenant({ id: undefined, refresh: true })\n    }\n  }, [initialValue, setTenant])\n\n  /**\n   * If there is no selected tenant ID and the entity type is 'global', set the first tenant as selected.\n   * This ensures that the global tenant is always set when the component mounts.\n   */\n  React.useEffect(() => {\n    if (!selectedTenantID && tenantOptions.length > 0 && entityType === 'global') {\n      setTenant({\n        id: tenantOptions[0]?.value,\n        refresh: true,\n      })\n    }\n  }, [selectedTenantID, tenantOptions, entityType, setTenant])\n\n  return (\n    <span\n      data-selected-tenant-id={selectedTenantID}\n      data-selected-tenant-title={selectedTenantLabel}\n    >\n      <Context\n        value={{\n          entityType,\n          modified,\n          options: tenantOptions,\n          selectedTenantID,\n          setEntityType,\n          setModified,\n          setTenant,\n          syncTenants,\n          updateTenants,\n        }}\n      >\n        {children}\n      </Context>\n    </span>\n  )\n}\n\nexport const useTenantSelection = () => React.use(Context)\n"],"names":["toast","useAuth","useConfig","useRouter","formatAdminURL","React","createContext","generateCookie","Context","entityType","undefined","options","selectedTenantID","setEntityType","setModified","setTenant","syncTenants","Promise","resolve","updateTenants","DEFAULT_COOKIE_NAME","setTenantCookie","args","cookieName","value","document","cookie","name","maxAge","path","returnCookieAsObject","deleteTenantCookie","getTenantCookie","parts","split","length","pop","shift","TenantSelectionProviderClient","children","initialTenantOptions","initialValue","tenantsCollectionSlug","setSelectedTenantID","useState","modified","user","config","router","userID","useMemo","id","prevUserID","useRef","userChanged","current","tenantOptions","setTenantOptions","selectedTenantLabel","find","option","label","setTenantAndCookie","useCallback","refresh","String","req","fetch","apiRoute","routes","api","credentials","method","result","json","e","error","prev","map","currentTenant","useEffect","span","data-selected-tenant-id","data-selected-tenant-title","useTenantSelection","use"],"mappings":"AAAA;;AAIA,SAASA,KAAK,EAAEC,OAAO,EAAEC,SAAS,QAAQ,iBAAgB;AAC1D,SAASC,SAAS,QAAQ,qBAAoB;AAC9C,SAASC,cAAc,QAAQ,iBAAgB;AAC/C,OAAOC,SAASC,aAAa,QAAQ,QAAO;AAE5C,SAASC,cAAc,QAAQ,oCAAmC;AAgDlE,MAAMC,wBAAUF,cAA2B;IACzCG,YAAYC;IACZC,SAAS,EAAE;IACXC,kBAAkBF;IAClBG,eAAe,IAAMH;IACrBI,aAAa,IAAMJ;IACnBK,WAAW,IAAM;IACjBC,aAAa,IAAMC,QAAQC,OAAO;IAClCC,eAAe,IAAM;AACvB;AAEA,MAAMC,sBAAsB;AAE5B,MAAMC,kBAAkB,CAACC;IACvB,MAAM,EAAEC,aAAaH,mBAAmB,EAAEI,KAAK,EAAE,GAAGF;IACpDG,SAASC,MAAM,GAAGnB,eAAuB;QACvCoB,MAAMJ;QACNK,QAAQ,KAAK,KAAK,KAAK;QACvBC,MAAM;QACNC,sBAAsB;QACtBN,OAAOA,SAAS;IAClB;AACF;AAEA,MAAMO,qBAAqB,CAACT,OAAgC,CAAC,CAAC;IAC5D,MAAM,EAAEC,aAAaH,mBAAmB,EAAE,GAAGE;IAC7CG,SAASC,MAAM,GAAGnB,eAAuB;QACvCoB,MAAMJ;QACNK,QAAQ,CAAC;QACTC,MAAM;QACNC,sBAAsB;QACtBN,OAAO;IACT;AACF;AAEA,MAAMQ,kBAAkB,CAACV,OAAgC,CAAC,CAAC;IACzD,MAAM,EAAEC,aAAaH,mBAAmB,EAAE,GAAGE;IAC7C,MAAME,QAAQ,CAAC,EAAE,EAAEC,SAASC,MAAM,EAAE;IACpC,MAAMO,QAAQT,MAAMU,KAAK,CAAC,CAAC,EAAE,EAAEX,WAAW,CAAC,CAAC;IAC5C,IAAIU,MAAME,MAAM,KAAK,GAAG;QACtB,OAAOF,MAAMG,GAAG,IAAIF,MAAM,KAAKG;IACjC;IACA,OAAO3B;AACT;AAEA,OAAO,MAAM4B,gCAAgC,CAAC,EAC5CC,QAAQ,EACRC,oBAAoB,EACpBC,YAAY,EACZC,qBAAqB,EAMtB;IACC,MAAM,CAAC9B,kBAAkB+B,oBAAoB,GAAGtC,MAAMuC,QAAQ,CAC5DH;IAEF,MAAM,CAACI,UAAU/B,YAAY,GAAGT,MAAMuC,QAAQ,CAAU;IACxD,MAAM,CAACnC,YAAYI,cAAc,GAAGR,MAAMuC,QAAQ,CAAoClC;IACtF,MAAM,EAAEoC,IAAI,EAAE,GAAG7C;IACjB,MAAM,EAAE8C,MAAM,EAAE,GAAG7C;IACnB,MAAM8C,SAAS7C;IACf,MAAM8C,SAAS5C,MAAM6C,OAAO,CAAC,IAAMJ,MAAMK,IAAI;QAACL,MAAMK;KAAG;IACvD,MAAMC,aAAa/C,MAAMgD,MAAM,CAACJ;IAChC,MAAMK,cAAcL,WAAWG,WAAWG,OAAO;IACjD,MAAM,CAACC,eAAeC,iBAAiB,GAAGpD,MAAMuC,QAAQ,CACtD,IAAMJ;IAER,MAAMkB,sBAAsBrD,MAAM6C,OAAO,CACvC,IAAMM,cAAcG,IAAI,CAAC,CAACC,SAAWA,OAAOpC,KAAK,KAAKZ,mBAAmBiD,OACzE;QAACjD;QAAkB4C;KAAc;IAGnC,MAAMM,qBAAqBzD,MAAM0D,WAAW,CAC1C,CAAC,EAAEZ,EAAE,EAAEa,OAAO,EAA0D;QACtErB,oBAAoBQ;QACpB,IAAIA,OAAOzC,WAAW;YACpBW,gBAAgB;gBAAEG,OAAOyC,OAAOd;YAAI;QACtC,OAAO;YACLpB;QACF;QACA,IAAIiC,SAAS;YACXhB,OAAOgB,OAAO;QAChB;IACF,GACA;QAAChB;KAAO;IAGV,MAAMjC,YAAYV,MAAM0D,WAAW,CACjC,CAAC,EAAEZ,EAAE,EAAEa,OAAO,EAAE;QACd,IAAIb,OAAOzC,WAAW;YACpB,IAAI8C,cAAcrB,MAAM,GAAG,KAAKqB,cAAcrB,MAAM,KAAK,GAAG;gBAC1D,6DAA6D;gBAC7D2B,mBAAmB;oBAAEX,IAAIzC;oBAAWsD;gBAAQ;YAC9C,OAAO,IAAIR,aAAa,CAAC,EAAE,EAAE;gBAC3B,uDAAuD;gBACvDM,mBAAmB;oBAAEX,IAAIK,aAAa,CAAC,EAAE,CAAChC,KAAK;oBAAEwC,SAAS;gBAAK;YACjE;QACF,OAAO,IAAI,CAACR,cAAcG,IAAI,CAAC,CAACC,SAAWA,OAAOpC,KAAK,KAAK2B,KAAK;YAC/D,6DAA6D;YAC7DW,mBAAmB;gBACjBX,IAAIK,aAAa,CAAC,EAAE,EAAEhC;gBACtBwC;YACF;QACF,OAAO;YACL,sDAAsD;YACtDF,mBAAmB;gBAAEX;gBAAIa;YAAQ;QACnC;IACF,GACA;QAACR;QAAeM;KAAmB;IAGrC,MAAM9C,cAAcX,MAAM0D,WAAW,CAAC;QACpC,IAAI;YACF,MAAMG,MAAM,MAAMC,MAChB/D,eAAe;gBACbgE,UAAUrB,OAAOsB,MAAM,CAACC,GAAG;gBAC3BzC,MAAM,CAAC,CAAC,EAAEa,sBAAsB,wBAAwB,CAAC;YAC3D,IACA;gBACE6B,aAAa;gBACbC,QAAQ;YACV;YAGF,MAAMC,SAAS,MAAMP,IAAIQ,IAAI;YAE7B,IAAID,OAAOjB,aAAa,IAAIP,QAAQ;gBAClCQ,iBAAiBgB,OAAOjB,aAAa;gBAErC,IAAIiB,OAAOjB,aAAa,CAACrB,MAAM,KAAK,GAAG;oBACrCQ,oBAAoB8B,OAAOjB,aAAa,CAAC,EAAE,CAAChC,KAAK;oBACjDH,gBAAgB;wBAAEG,OAAOyC,OAAOQ,OAAOjB,aAAa,CAAC,EAAE,CAAChC,KAAK;oBAAE;gBACjE;YACF;QACF,EAAE,OAAOmD,GAAG;YACV3E,MAAM4E,KAAK,CAAC,CAAC,sBAAsB,CAAC;QACtC;IACF,GAAG;QAAC7B,OAAOsB,MAAM,CAACC,GAAG;QAAE5B;QAAuBO;KAAO;IAErD,MAAM9B,gBAAgBd,MAAM0D,WAAW,CACrC,CAAC,EAAEZ,EAAE,EAAEU,KAAK,EAAE;QACZJ,iBAAiB,CAACoB;YAChB,OAAOA,KAAKC,GAAG,CAAC,CAACC;gBACf,IAAI5B,OAAO4B,cAAcvD,KAAK,EAAE;oBAC9B,OAAO;wBACLqC;wBACArC,OAAO2B;oBACT;gBACF;gBACA,OAAO4B;YACT;QACF;QAEA,KAAK/D;IACP,GACA;QAACA;KAAY;IAGfX,MAAM2E,SAAS,CAAC;QACd,IAAI1B,eAAgBb,gBAAgBwB,OAAOxB,kBAAkBT,mBAAoB;YAC/E,IAAIiB,QAAQ;gBACV,kBAAkB;gBAClB,KAAKjC;YACP,OAAO;gBACL,mBAAmB;gBACnB2B,oBAAoBjC;gBACpBqB;gBACA,IAAIyB,cAAcrB,MAAM,GAAG,GAAG;oBAC5BsB,iBAAiB,EAAE;gBACrB;gBACAT,OAAOgB,OAAO;YAChB;YACAZ,WAAWG,OAAO,GAAGN;QACvB;IACF,GAAG;QAACA;QAAQK;QAAatC;QAAawC;QAAef;QAAcO;KAAO;IAE1E;;;GAGC,GACD3C,MAAM2E,SAAS,CAAC;QACd,IAAI,CAACvC,cAAc;YACjB1B,UAAU;gBAAEoC,IAAIzC;gBAAWsD,SAAS;YAAK;QAC3C;IACF,GAAG;QAACvB;QAAc1B;KAAU;IAE5B;;;GAGC,GACDV,MAAM2E,SAAS,CAAC;QACd,IAAI,CAACpE,oBAAoB4C,cAAcrB,MAAM,GAAG,KAAK1B,eAAe,UAAU;YAC5EM,UAAU;gBACRoC,IAAIK,aAAa,CAAC,EAAE,EAAEhC;gBACtBwC,SAAS;YACX;QACF;IACF,GAAG;QAACpD;QAAkB4C;QAAe/C;QAAYM;KAAU;IAE3D,qBACE,KAACkE;QACCC,2BAAyBtE;QACzBuE,8BAA4BzB;kBAE5B,cAAA,KAAClD;YACCgB,OAAO;gBACLf;gBACAoC;gBACAlC,SAAS6C;gBACT5C;gBACAC;gBACAC;gBACAC;gBACAC;gBACAG;YACF;sBAECoB;;;AAIT,EAAC;AAED,OAAO,MAAM6C,qBAAqB,IAAM/E,MAAMgF,GAAG,CAAC7E,SAAQ"}