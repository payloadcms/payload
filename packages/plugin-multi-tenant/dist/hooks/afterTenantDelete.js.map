{"version":3,"sources":["../../src/hooks/afterTenantDelete.ts"],"sourcesContent":["import type {\n  CollectionAfterDeleteHook,\n  CollectionConfig,\n  JsonObject,\n  PaginatedDocs,\n} from 'payload'\n\nimport { generateCookie, mergeHeaders } from 'payload'\n\nimport type { UserWithTenantsField } from '../types.js'\n\nimport { getCollectionIDType } from '../utilities/getCollectionIDType.js'\nimport { getTenantFromCookie } from '../utilities/getTenantFromCookie.js'\n\ntype Args = {\n  collection: CollectionConfig\n  enabledSlugs: string[]\n  tenantFieldName: string\n  tenantsCollectionSlug: string\n  usersSlug: string\n  usersTenantsArrayFieldName: string\n  usersTenantsArrayTenantFieldName: string\n}\n/**\n * Add cleanup logic when tenant is deleted\n * - delete documents related to tenant\n * - remove tenant from users\n */\nexport const addTenantCleanup = ({\n  collection,\n  enabledSlugs,\n  tenantFieldName,\n  tenantsCollectionSlug,\n  usersSlug,\n  usersTenantsArrayFieldName,\n  usersTenantsArrayTenantFieldName,\n}: Args) => {\n  if (!collection.hooks) {\n    collection.hooks = {}\n  }\n  if (!collection.hooks?.afterDelete) {\n    collection.hooks.afterDelete = []\n  }\n  collection.hooks.afterDelete.push(\n    afterTenantDelete({\n      enabledSlugs,\n      tenantFieldName,\n      tenantsCollectionSlug,\n      usersSlug,\n      usersTenantsArrayFieldName,\n      usersTenantsArrayTenantFieldName,\n    }),\n  )\n}\n\nexport const afterTenantDelete =\n  ({\n    enabledSlugs,\n    tenantFieldName,\n    tenantsCollectionSlug,\n    usersSlug,\n    usersTenantsArrayFieldName,\n    usersTenantsArrayTenantFieldName,\n  }: Omit<Args, 'collection'>): CollectionAfterDeleteHook =>\n  async ({ id, req }) => {\n    const idType = getCollectionIDType({\n      collectionSlug: tenantsCollectionSlug,\n      payload: req.payload,\n    })\n    const currentTenantCookieID = getTenantFromCookie(req.headers, idType)\n    if (currentTenantCookieID === id) {\n      const newHeaders = new Headers({\n        'Set-Cookie': generateCookie<string>({\n          name: 'payload-tenant',\n          expires: new Date(Date.now() - 1000),\n          path: '/',\n          returnCookieAsObject: false,\n          value: '',\n        }),\n      })\n\n      req.responseHeaders = req.responseHeaders\n        ? mergeHeaders(req.responseHeaders, newHeaders)\n        : newHeaders\n    }\n    const cleanupPromises: Promise<JsonObject>[] = []\n    enabledSlugs.forEach((slug) => {\n      cleanupPromises.push(\n        req.payload.delete({\n          collection: slug,\n          where: {\n            [tenantFieldName]: {\n              in: [id],\n            },\n          },\n        }),\n      )\n    })\n\n    try {\n      const usersWithTenant = (await req.payload.find({\n        collection: usersSlug,\n        depth: 0,\n        limit: 0,\n        where: {\n          [`${usersTenantsArrayFieldName}.${usersTenantsArrayTenantFieldName}`]: {\n            in: [id],\n          },\n        },\n      })) as PaginatedDocs<UserWithTenantsField>\n\n      usersWithTenant?.docs?.forEach((user) => {\n        cleanupPromises.push(\n          req.payload.update({\n            id: user.id,\n            collection: usersSlug,\n            data: {\n              [usersTenantsArrayFieldName]: (user[usersTenantsArrayFieldName] || []).filter(\n                (row: Record<string, string>) => {\n                  if (row[usersTenantsArrayTenantFieldName]) {\n                    return row[usersTenantsArrayTenantFieldName] !== id\n                  }\n                },\n              ),\n            },\n          }),\n        )\n      })\n    } catch (e) {\n      console.error('Error deleting tenants from users:', e)\n    }\n\n    await Promise.all(cleanupPromises)\n  }\n"],"names":["generateCookie","mergeHeaders","getCollectionIDType","getTenantFromCookie","addTenantCleanup","collection","enabledSlugs","tenantFieldName","tenantsCollectionSlug","usersSlug","usersTenantsArrayFieldName","usersTenantsArrayTenantFieldName","hooks","afterDelete","push","afterTenantDelete","id","req","idType","collectionSlug","payload","currentTenantCookieID","headers","newHeaders","Headers","name","expires","Date","now","path","returnCookieAsObject","value","responseHeaders","cleanupPromises","forEach","slug","delete","where","in","usersWithTenant","find","depth","limit","docs","user","update","data","filter","row","e","console","error","Promise","all"],"mappings":"AAOA,SAASA,cAAc,EAAEC,YAAY,QAAQ,UAAS;AAItD,SAASC,mBAAmB,QAAQ,sCAAqC;AACzE,SAASC,mBAAmB,QAAQ,sCAAqC;AAWzE;;;;CAIC,GACD,OAAO,MAAMC,mBAAmB,CAAC,EAC/BC,UAAU,EACVC,YAAY,EACZC,eAAe,EACfC,qBAAqB,EACrBC,SAAS,EACTC,0BAA0B,EAC1BC,gCAAgC,EAC3B;IACL,IAAI,CAACN,WAAWO,KAAK,EAAE;QACrBP,WAAWO,KAAK,GAAG,CAAC;IACtB;IACA,IAAI,CAACP,WAAWO,KAAK,EAAEC,aAAa;QAClCR,WAAWO,KAAK,CAACC,WAAW,GAAG,EAAE;IACnC;IACAR,WAAWO,KAAK,CAACC,WAAW,CAACC,IAAI,CAC/BC,kBAAkB;QAChBT;QACAC;QACAC;QACAC;QACAC;QACAC;IACF;AAEJ,EAAC;AAED,OAAO,MAAMI,oBACX,CAAC,EACCT,YAAY,EACZC,eAAe,EACfC,qBAAqB,EACrBC,SAAS,EACTC,0BAA0B,EAC1BC,gCAAgC,EACP,GAC3B,OAAO,EAAEK,EAAE,EAAEC,GAAG,EAAE;QAChB,MAAMC,SAAShB,oBAAoB;YACjCiB,gBAAgBX;YAChBY,SAASH,IAAIG,OAAO;QACtB;QACA,MAAMC,wBAAwBlB,oBAAoBc,IAAIK,OAAO,EAAEJ;QAC/D,IAAIG,0BAA0BL,IAAI;YAChC,MAAMO,aAAa,IAAIC,QAAQ;gBAC7B,cAAcxB,eAAuB;oBACnCyB,MAAM;oBACNC,SAAS,IAAIC,KAAKA,KAAKC,GAAG,KAAK;oBAC/BC,MAAM;oBACNC,sBAAsB;oBACtBC,OAAO;gBACT;YACF;YAEAd,IAAIe,eAAe,GAAGf,IAAIe,eAAe,GACrC/B,aAAagB,IAAIe,eAAe,EAAET,cAClCA;QACN;QACA,MAAMU,kBAAyC,EAAE;QACjD3B,aAAa4B,OAAO,CAAC,CAACC;YACpBF,gBAAgBnB,IAAI,CAClBG,IAAIG,OAAO,CAACgB,MAAM,CAAC;gBACjB/B,YAAY8B;gBACZE,OAAO;oBACL,CAAC9B,gBAAgB,EAAE;wBACjB+B,IAAI;4BAACtB;yBAAG;oBACV;gBACF;YACF;QAEJ;QAEA,IAAI;YACF,MAAMuB,kBAAmB,MAAMtB,IAAIG,OAAO,CAACoB,IAAI,CAAC;gBAC9CnC,YAAYI;gBACZgC,OAAO;gBACPC,OAAO;gBACPL,OAAO;oBACL,CAAC,GAAG3B,2BAA2B,CAAC,EAAEC,kCAAkC,CAAC,EAAE;wBACrE2B,IAAI;4BAACtB;yBAAG;oBACV;gBACF;YACF;YAEAuB,iBAAiBI,MAAMT,QAAQ,CAACU;gBAC9BX,gBAAgBnB,IAAI,CAClBG,IAAIG,OAAO,CAACyB,MAAM,CAAC;oBACjB7B,IAAI4B,KAAK5B,EAAE;oBACXX,YAAYI;oBACZqC,MAAM;wBACJ,CAACpC,2BAA2B,EAAE,AAACkC,CAAAA,IAAI,CAAClC,2BAA2B,IAAI,EAAE,AAAD,EAAGqC,MAAM,CAC3E,CAACC;4BACC,IAAIA,GAAG,CAACrC,iCAAiC,EAAE;gCACzC,OAAOqC,GAAG,CAACrC,iCAAiC,KAAKK;4BACnD;wBACF;oBAEJ;gBACF;YAEJ;QACF,EAAE,OAAOiC,GAAG;YACVC,QAAQC,KAAK,CAAC,sCAAsCF;QACtD;QAEA,MAAMG,QAAQC,GAAG,CAACpB;IACpB,EAAC"}