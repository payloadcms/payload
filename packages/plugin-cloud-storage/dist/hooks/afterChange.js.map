{"version":3,"sources":["../../src/hooks/afterChange.ts"],"sourcesContent":["import type { CollectionAfterChangeHook, CollectionConfig, FileData, TypeWithID } from 'payload'\n\nimport type { GeneratedAdapter } from '../types.js'\n\nimport { getIncomingFiles } from '../utilities/getIncomingFiles.js'\n\ninterface Args {\n  adapter: GeneratedAdapter\n  collection: CollectionConfig\n}\n\nexport const getAfterChangeHook =\n  ({ adapter, collection }: Args): CollectionAfterChangeHook<FileData & TypeWithID> =>\n  async ({ doc, operation, previousDoc, req }) => {\n    try {\n      const files = getIncomingFiles({ data: doc, req })\n\n      if (files.length > 0) {\n        // If there is a previous doc, files and the operation is update,\n        // delete the old files before uploading the new ones.\n        if (previousDoc && operation === 'update') {\n          let filesToDelete: string[] = []\n\n          if (typeof previousDoc?.filename === 'string') {\n            filesToDelete.push(previousDoc.filename)\n          }\n\n          if (typeof previousDoc.sizes === 'object') {\n            filesToDelete = filesToDelete.concat(\n              Object.values(previousDoc?.sizes || []).map(\n                (resizedFileData) => resizedFileData?.filename as string,\n              ),\n            )\n          }\n\n          const deletionPromises = filesToDelete.map(async (filename) => {\n            if (filename) {\n              await adapter.handleDelete({ collection, doc: previousDoc, filename, req })\n            }\n          })\n\n          await Promise.all(deletionPromises)\n        }\n\n        const uploadResults = await Promise.all(\n          files.map((file) =>\n            adapter.handleUpload({\n              clientUploadContext: file.clientUploadContext,\n              collection,\n              data: doc,\n              file,\n              req,\n            }),\n          ),\n        )\n\n        const uploadMetadata = uploadResults\n          .filter(\n            (result): result is Partial<FileData & TypeWithID> =>\n              result != null && typeof result === 'object',\n          )\n          .reduce(\n            (acc, metadata) => ({ ...acc, ...metadata }),\n            {} as Partial<FileData & TypeWithID>,\n          )\n\n        if (Object.keys(uploadMetadata).length > 0) {\n          try {\n            await req.payload.update({\n              id: doc.id,\n              collection: collection.slug,\n              data: uploadMetadata,\n              depth: 0,\n              req,\n            })\n            return { ...doc, ...uploadMetadata }\n          } catch (updateError: unknown) {\n            req.payload.logger.warn(\n              `Failed to persist upload data for collection ${collection.slug} document ${doc.id}: ${String(updateError)}`,\n            )\n          }\n        }\n      }\n    } catch (err: unknown) {\n      req.payload.logger.error(\n        `There was an error while uploading files corresponding to the collection ${collection.slug} with filename ${doc.filename}:`,\n      )\n      req.payload.logger.error({ err })\n      throw err\n    }\n    return doc\n  }\n"],"names":["getIncomingFiles","getAfterChangeHook","adapter","collection","doc","operation","previousDoc","req","files","data","length","filesToDelete","filename","push","sizes","concat","Object","values","map","resizedFileData","deletionPromises","handleDelete","Promise","all","uploadResults","file","handleUpload","clientUploadContext","uploadMetadata","filter","result","reduce","acc","metadata","keys","payload","update","id","slug","depth","updateError","logger","warn","String","err","error"],"mappings":"AAIA,SAASA,gBAAgB,QAAQ,mCAAkC;AAOnE,OAAO,MAAMC,qBACX,CAAC,EAAEC,OAAO,EAAEC,UAAU,EAAQ,GAC9B,OAAO,EAAEC,GAAG,EAAEC,SAAS,EAAEC,WAAW,EAAEC,GAAG,EAAE;QACzC,IAAI;YACF,MAAMC,QAAQR,iBAAiB;gBAAES,MAAML;gBAAKG;YAAI;YAEhD,IAAIC,MAAME,MAAM,GAAG,GAAG;gBACpB,iEAAiE;gBACjE,sDAAsD;gBACtD,IAAIJ,eAAeD,cAAc,UAAU;oBACzC,IAAIM,gBAA0B,EAAE;oBAEhC,IAAI,OAAOL,aAAaM,aAAa,UAAU;wBAC7CD,cAAcE,IAAI,CAACP,YAAYM,QAAQ;oBACzC;oBAEA,IAAI,OAAON,YAAYQ,KAAK,KAAK,UAAU;wBACzCH,gBAAgBA,cAAcI,MAAM,CAClCC,OAAOC,MAAM,CAACX,aAAaQ,SAAS,EAAE,EAAEI,GAAG,CACzC,CAACC,kBAAoBA,iBAAiBP;oBAG5C;oBAEA,MAAMQ,mBAAmBT,cAAcO,GAAG,CAAC,OAAON;wBAChD,IAAIA,UAAU;4BACZ,MAAMV,QAAQmB,YAAY,CAAC;gCAAElB;gCAAYC,KAAKE;gCAAaM;gCAAUL;4BAAI;wBAC3E;oBACF;oBAEA,MAAMe,QAAQC,GAAG,CAACH;gBACpB;gBAEA,MAAMI,gBAAgB,MAAMF,QAAQC,GAAG,CACrCf,MAAMU,GAAG,CAAC,CAACO,OACTvB,QAAQwB,YAAY,CAAC;wBACnBC,qBAAqBF,KAAKE,mBAAmB;wBAC7CxB;wBACAM,MAAML;wBACNqB;wBACAlB;oBACF;gBAIJ,MAAMqB,iBAAiBJ,cACpBK,MAAM,CACL,CAACC,SACCA,UAAU,QAAQ,OAAOA,WAAW,UAEvCC,MAAM,CACL,CAACC,KAAKC,WAAc,CAAA;wBAAE,GAAGD,GAAG;wBAAE,GAAGC,QAAQ;oBAAC,CAAA,GAC1C,CAAC;gBAGL,IAAIjB,OAAOkB,IAAI,CAACN,gBAAgBlB,MAAM,GAAG,GAAG;oBAC1C,IAAI;wBACF,MAAMH,IAAI4B,OAAO,CAACC,MAAM,CAAC;4BACvBC,IAAIjC,IAAIiC,EAAE;4BACVlC,YAAYA,WAAWmC,IAAI;4BAC3B7B,MAAMmB;4BACNW,OAAO;4BACPhC;wBACF;wBACA,OAAO;4BAAE,GAAGH,GAAG;4BAAE,GAAGwB,cAAc;wBAAC;oBACrC,EAAE,OAAOY,aAAsB;wBAC7BjC,IAAI4B,OAAO,CAACM,MAAM,CAACC,IAAI,CACrB,CAAC,6CAA6C,EAAEvC,WAAWmC,IAAI,CAAC,UAAU,EAAElC,IAAIiC,EAAE,CAAC,EAAE,EAAEM,OAAOH,cAAc;oBAEhH;gBACF;YACF;QACF,EAAE,OAAOI,KAAc;YACrBrC,IAAI4B,OAAO,CAACM,MAAM,CAACI,KAAK,CACtB,CAAC,yEAAyE,EAAE1C,WAAWmC,IAAI,CAAC,eAAe,EAAElC,IAAIQ,QAAQ,CAAC,CAAC,CAAC;YAE9HL,IAAI4B,OAAO,CAACM,MAAM,CAACI,KAAK,CAAC;gBAAED;YAAI;YAC/B,MAAMA;QACR;QACA,OAAOxC;IACT,EAAC"}