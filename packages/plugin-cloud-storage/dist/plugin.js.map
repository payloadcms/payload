{"version":3,"sources":["../src/plugin.ts"],"sourcesContent":["import type { Config } from 'payload'\n\nimport type { AllowList, PluginOptions } from './types.js'\n\nimport { getFields } from './fields/getFields.js'\nimport { getAfterChangeHook } from './hooks/afterChange.js'\nimport { getAfterDeleteHook } from './hooks/afterDelete.js'\n\n// This plugin extends all targeted collections by offloading uploaded files\n// to cloud storage instead of solely storing files locally.\n\n// It is based on an adapter approach, where adapters can be written for any cloud provider.\n// Adapters are responsible for providing four actions that this plugin will use:\n// 1. handleUpload, 2. handleDelete, 3. generateURL, 4. staticHandler\n\n// Optionally, the adapter can specify any Webpack config overrides if they are necessary.\n\nexport const cloudStoragePlugin =\n  (pluginOptions: PluginOptions) =>\n  (incomingConfig: Config): Config => {\n    const { alwaysInsertFields, collections: allCollectionOptions, enabled } = pluginOptions\n    const config = { ...incomingConfig }\n\n    // If disabled but alwaysInsertFields is true, only insert fields without full plugin functionality\n    if (enabled === false) {\n      if (alwaysInsertFields) {\n        return {\n          ...config,\n          collections: (config.collections || []).map((existingCollection) => {\n            const options = allCollectionOptions[existingCollection.slug]\n\n            if (options) {\n              // If adapter is provided, use it to get fields\n              const adapter = options.adapter\n                ? options.adapter({\n                    collection: existingCollection,\n                    prefix: options.prefix,\n                  })\n                : undefined\n\n              const fields = getFields({\n                adapter,\n                alwaysInsertFields: true,\n                collection: existingCollection,\n                disablePayloadAccessControl: options.disablePayloadAccessControl,\n                generateFileURL: options.generateFileURL,\n                prefix: options.prefix,\n              })\n\n              return {\n                ...existingCollection,\n                fields,\n              }\n            }\n\n            return existingCollection\n          }),\n        }\n      }\n\n      return config\n    }\n\n    const initFunctions: Array<() => void> = []\n\n    return {\n      ...config,\n      collections: (config.collections || []).map((existingCollection) => {\n        const options = allCollectionOptions[existingCollection.slug]\n\n        if (options?.adapter) {\n          const adapter = options.adapter({\n            collection: existingCollection,\n            prefix: options.prefix,\n          })\n\n          if (adapter.onInit) {\n            initFunctions.push(adapter.onInit)\n          }\n\n          const fields = getFields({\n            adapter,\n            collection: existingCollection,\n            disablePayloadAccessControl: options.disablePayloadAccessControl,\n            generateFileURL: options.generateFileURL,\n            prefix: options.prefix,\n          })\n\n          const handlers = [\n            ...(typeof existingCollection.upload === 'object' &&\n            Array.isArray(existingCollection.upload.handlers)\n              ? existingCollection.upload.handlers\n              : []),\n          ]\n\n          if (!options.disablePayloadAccessControl) {\n            handlers.push(adapter.staticHandler)\n            // Else if disablePayloadAccessControl: true and clientUploads is used\n            // Build the \"proxied\" handler that responses only when the file was requested by client upload in addDataAndFileToRequest\n          } else if (adapter.clientUploads) {\n            handlers.push((req, args) => {\n              if ('clientUploadContext' in args.params) {\n                return adapter.staticHandler(req, args)\n              }\n            })\n          }\n\n          const getSkipSafeFetchSetting = (): AllowList | boolean => {\n            if (options.disablePayloadAccessControl) {\n              return true\n            }\n            const isBooleanTrueSkipSafeFetch =\n              typeof existingCollection.upload === 'object' &&\n              existingCollection.upload.skipSafeFetch === true\n\n            const isAllowListSkipSafeFetch =\n              typeof existingCollection.upload === 'object' &&\n              Array.isArray(existingCollection.upload.skipSafeFetch)\n\n            if (isBooleanTrueSkipSafeFetch) {\n              return true\n            } else if (isAllowListSkipSafeFetch) {\n              const existingSkipSafeFetch =\n                typeof existingCollection.upload === 'object' &&\n                Array.isArray(existingCollection.upload.skipSafeFetch)\n                  ? existingCollection.upload.skipSafeFetch\n                  : []\n\n              const hasExactLocalhostMatch = existingSkipSafeFetch.some((entry) => {\n                const entryKeys = Object.keys(entry)\n                return entryKeys.length === 1 && entry.hostname === 'localhost'\n              })\n\n              const localhostEntry =\n                process.env.NODE_ENV !== 'production' && !hasExactLocalhostMatch\n                  ? [{ hostname: 'localhost' }]\n                  : []\n\n              return [...existingSkipSafeFetch, ...localhostEntry]\n            }\n\n            if (process.env.NODE_ENV !== 'production') {\n              return [{ hostname: 'localhost' }]\n            }\n\n            return false\n          }\n\n          return {\n            ...existingCollection,\n            fields,\n            hooks: {\n              ...(existingCollection.hooks || {}),\n              afterChange: [\n                ...(existingCollection.hooks?.afterChange || []),\n                getAfterChangeHook({ adapter, collection: existingCollection }),\n              ],\n              afterDelete: [\n                ...(existingCollection.hooks?.afterDelete || []),\n                getAfterDeleteHook({ adapter, collection: existingCollection }),\n              ],\n            },\n            upload: {\n              ...(typeof existingCollection.upload === 'object' ? existingCollection.upload : {}),\n              adapter: adapter.name,\n              disableLocalStorage:\n                typeof options.disableLocalStorage === 'boolean'\n                  ? options.disableLocalStorage\n                  : true,\n              handlers,\n              skipSafeFetch: getSkipSafeFetchSetting(),\n            },\n          }\n        }\n\n        return existingCollection\n      }),\n      onInit: async (payload) => {\n        initFunctions.forEach((fn) => fn())\n        if (config.onInit) {\n          await config.onInit(payload)\n        }\n      },\n    }\n  }\n"],"names":["getFields","getAfterChangeHook","getAfterDeleteHook","cloudStoragePlugin","pluginOptions","incomingConfig","alwaysInsertFields","collections","allCollectionOptions","enabled","config","map","existingCollection","options","slug","adapter","collection","prefix","undefined","fields","disablePayloadAccessControl","generateFileURL","initFunctions","onInit","push","handlers","upload","Array","isArray","staticHandler","clientUploads","req","args","params","getSkipSafeFetchSetting","isBooleanTrueSkipSafeFetch","skipSafeFetch","isAllowListSkipSafeFetch","existingSkipSafeFetch","hasExactLocalhostMatch","some","entry","entryKeys","Object","keys","length","hostname","localhostEntry","process","env","NODE_ENV","hooks","afterChange","afterDelete","name","disableLocalStorage","payload","forEach","fn"],"mappings":"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"}