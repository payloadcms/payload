{"version":3,"sources":["../src/staticHandler.ts"],"sourcesContent":["import type { StaticHandler } from '@payloadcms/plugin-cloud-storage/types'\nimport type { CollectionConfig } from 'payload'\n\nimport { ApiError, type Storage } from '@google-cloud/storage'\nimport { getFilePrefix } from '@payloadcms/plugin-cloud-storage/utilities'\nimport path from 'path'\nimport { getRangeRequestInfo } from 'payload/internal'\n\ninterface Args {\n  bucket: string\n  collection: CollectionConfig\n  getStorageClient: () => Storage\n}\n\nexport const getHandler = ({ bucket, collection, getStorageClient }: Args): StaticHandler => {\n  return async (req, { headers: incomingHeaders, params: { clientUploadContext, filename } }) => {\n    try {\n      const prefix = await getFilePrefix({ clientUploadContext, collection, filename, req })\n      const file = getStorageClient().bucket(bucket).file(path.posix.join(prefix, filename))\n\n      const [metadata] = await file.getMetadata()\n\n      // Handle range request\n      const rangeHeader = req.headers.get('range')\n      const fileSize = Number(metadata.size)\n      const rangeResult = getRangeRequestInfo({ fileSize, rangeHeader })\n\n      if (rangeResult.type === 'invalid') {\n        return new Response(null, {\n          headers: new Headers(rangeResult.headers),\n          status: rangeResult.status,\n        })\n      }\n\n      const etagFromHeaders = req.headers.get('etag') || req.headers.get('if-none-match')\n      const objectEtag = metadata.etag\n\n      let headers = new Headers(incomingHeaders)\n\n      // Add range-related headers from the result\n      for (const [key, value] of Object.entries(rangeResult.headers)) {\n        headers.append(key, value)\n      }\n\n      headers.append('Content-Type', String(metadata.contentType))\n      headers.append('ETag', String(metadata.etag))\n\n      if (\n        collection.upload &&\n        typeof collection.upload === 'object' &&\n        typeof collection.upload.modifyResponseHeaders === 'function'\n      ) {\n        headers = collection.upload.modifyResponseHeaders({ headers }) || headers\n      }\n\n      if (etagFromHeaders && etagFromHeaders === objectEtag) {\n        return new Response(null, {\n          headers,\n          status: 304,\n        })\n      }\n\n      // Manually create a ReadableStream for the web from a Node.js stream.\n      const readableStream = new ReadableStream({\n        start(controller) {\n          const streamOptions =\n            rangeResult.type === 'partial'\n              ? { end: rangeResult.rangeEnd, start: rangeResult.rangeStart }\n              : {}\n          const nodeStream = file.createReadStream(streamOptions)\n          nodeStream.on('data', (chunk) => {\n            controller.enqueue(new Uint8Array(chunk))\n          })\n          nodeStream.on('end', () => {\n            controller.close()\n          })\n          nodeStream.on('error', (err) => {\n            controller.error(err)\n          })\n        },\n      })\n\n      return new Response(readableStream, {\n        headers,\n        status: rangeResult.status,\n      })\n    } catch (err: unknown) {\n      if (err instanceof ApiError && err.code === 404) {\n        return new Response(null, { status: 404, statusText: 'Not Found' })\n      }\n      req.payload.logger.error(err)\n      return new Response('Internal Server Error', { status: 500 })\n    }\n  }\n}\n"],"names":["ApiError","getFilePrefix","path","getRangeRequestInfo","getHandler","bucket","collection","getStorageClient","req","headers","incomingHeaders","params","clientUploadContext","filename","prefix","file","posix","join","metadata","getMetadata","rangeHeader","get","fileSize","Number","size","rangeResult","type","Response","Headers","status","etagFromHeaders","objectEtag","etag","key","value","Object","entries","append","String","contentType","upload","modifyResponseHeaders","readableStream","ReadableStream","start","controller","streamOptions","end","rangeEnd","rangeStart","nodeStream","createReadStream","on","chunk","enqueue","Uint8Array","close","err","error","code","statusText","payload","logger"],"mappings":"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"}