{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import type { StorageOptions } from '@google-cloud/storage'\nimport type {\n  Adapter,\n  ClientUploadsConfig,\n  PluginOptions as CloudStoragePluginOptions,\n  CollectionOptions,\n  GeneratedAdapter,\n} from '@payloadcms/plugin-cloud-storage/types'\nimport type { Config, Plugin, UploadCollectionSlug } from 'payload'\n\nimport { Storage } from '@google-cloud/storage'\nimport { cloudStoragePlugin } from '@payloadcms/plugin-cloud-storage'\nimport { initClientUploads } from '@payloadcms/plugin-cloud-storage/utilities'\n\nimport { getGenerateSignedURLHandler } from './generateSignedURL.js'\nimport { getGenerateURL } from './generateURL.js'\nimport { getHandleDelete } from './handleDelete.js'\nimport { getHandleUpload } from './handleUpload.js'\nimport { getHandler } from './staticHandler.js'\n\nexport interface GcsStorageOptions {\n  acl?: 'Private' | 'Public'\n\n  /**\n   * When enabled, fields (like the prefix field) will always be inserted into\n   * the collection schema regardless of whether the plugin is enabled. This\n   * ensures a consistent schema across all environments.\n   *\n   * This will be enabled by default in Payload v4.\n   *\n   * @default false\n   */\n  alwaysInsertFields?: boolean\n\n  /**\n   * The name of the bucket to use.\n   */\n  bucket: string\n  /**\n   * Optional cache key to identify the GCS storage client instance.\n   * If not provided, a default key will be used.\n   *\n   * @default `gcs:containerName`\n   */\n  clientCacheKey?: string\n  /**\n   * Do uploads directly on the client to bypass limits on Vercel. You must allow CORS PUT method for the bucket to your website.\n   */\n  clientUploads?: ClientUploadsConfig\n  /**\n   * Collection options to apply the S3 adapter to.\n   */\n  collections: Partial<Record<UploadCollectionSlug, Omit<CollectionOptions, 'adapter'> | true>>\n  /**\n   * Whether or not to enable the plugin\n   *\n   * Default: true\n   */\n  enabled?: boolean\n\n  /**\n   * Google Cloud Storage client configuration.\n   *\n   * @see https://github.com/googleapis/nodejs-storage\n   */\n  options: StorageOptions\n}\n\ntype GcsStoragePlugin = (gcsStorageArgs: GcsStorageOptions) => Plugin\n\nconst gcsClients = new Map<string, Storage>()\n\nexport const gcsStorage: GcsStoragePlugin =\n  (gcsStorageOptions: GcsStorageOptions) =>\n  (incomingConfig: Config): Config => {\n    const cacheKey = gcsStorageOptions.clientCacheKey || `gcs:${gcsStorageOptions.bucket}`\n\n    const getStorageClient = (): Storage => {\n      if (gcsClients.has(cacheKey)) {\n        return gcsClients.get(cacheKey)!\n      }\n      gcsClients.set(cacheKey, new Storage(gcsStorageOptions.options))\n\n      return gcsClients.get(cacheKey)!\n    }\n\n    const adapter = gcsStorageInternal(getStorageClient, gcsStorageOptions)\n\n    const isPluginDisabled = gcsStorageOptions.enabled === false\n\n    initClientUploads({\n      clientHandler: '@payloadcms/storage-gcs/client#GcsClientUploadHandler',\n      collections: gcsStorageOptions.collections,\n      config: incomingConfig,\n      enabled: !isPluginDisabled && Boolean(gcsStorageOptions.clientUploads),\n      serverHandler: getGenerateSignedURLHandler({\n        access:\n          typeof gcsStorageOptions.clientUploads === 'object'\n            ? gcsStorageOptions.clientUploads.access\n            : undefined,\n        bucket: gcsStorageOptions.bucket,\n        collections: gcsStorageOptions.collections,\n        getStorageClient,\n      }),\n      serverHandlerPath: '/storage-gcs-generate-signed-url',\n    })\n\n    if (isPluginDisabled) {\n      return incomingConfig\n    }\n\n    // Add adapter to each collection option object\n    const collectionsWithAdapter: CloudStoragePluginOptions['collections'] = Object.entries(\n      gcsStorageOptions.collections,\n    ).reduce(\n      (acc, [slug, collOptions]) => ({\n        ...acc,\n        [slug]: {\n          ...(collOptions === true ? {} : collOptions),\n          adapter,\n        },\n      }),\n      {} as Record<string, CollectionOptions>,\n    )\n\n    // Set disableLocalStorage: true for collections specified in the plugin options\n    const config = {\n      ...incomingConfig,\n      collections: (incomingConfig.collections || []).map((collection) => {\n        if (!collectionsWithAdapter[collection.slug]) {\n          return collection\n        }\n\n        return {\n          ...collection,\n          upload: {\n            ...(typeof collection.upload === 'object' ? collection.upload : {}),\n            disableLocalStorage: true,\n          },\n        }\n      }),\n    }\n\n    return cloudStoragePlugin({\n      alwaysInsertFields: gcsStorageOptions.alwaysInsertFields,\n      collections: collectionsWithAdapter,\n    })(config)\n  }\n\nfunction gcsStorageInternal(\n  getStorageClient: () => Storage,\n  { acl, bucket, clientUploads }: GcsStorageOptions,\n): Adapter {\n  return ({ collection, prefix }): GeneratedAdapter => {\n    return {\n      name: 'gcs',\n      clientUploads,\n      generateURL: getGenerateURL({ bucket, getStorageClient }),\n      handleDelete: getHandleDelete({ bucket, getStorageClient }),\n      handleUpload: getHandleUpload({\n        acl,\n        bucket,\n        collection,\n        getStorageClient,\n        prefix,\n      }),\n      staticHandler: getHandler({ bucket, collection, getStorageClient }),\n    }\n  }\n}\n"],"names":["Storage","cloudStoragePlugin","initClientUploads","getGenerateSignedURLHandler","getGenerateURL","getHandleDelete","getHandleUpload","getHandler","gcsClients","Map","gcsStorage","gcsStorageOptions","incomingConfig","cacheKey","clientCacheKey","bucket","getStorageClient","has","get","set","options","adapter","gcsStorageInternal","isPluginDisabled","enabled","clientHandler","collections","config","Boolean","clientUploads","serverHandler","access","undefined","serverHandlerPath","collectionsWithAdapter","Object","entries","reduce","acc","slug","collOptions","map","collection","upload","disableLocalStorage","alwaysInsertFields","acl","prefix","name","generateURL","handleDelete","handleUpload","staticHandler"],"mappings":"AAUA,SAASA,OAAO,QAAQ,wBAAuB;AAC/C,SAASC,kBAAkB,QAAQ,mCAAkC;AACrE,SAASC,iBAAiB,QAAQ,6CAA4C;AAE9E,SAASC,2BAA2B,QAAQ,yBAAwB;AACpE,SAASC,cAAc,QAAQ,mBAAkB;AACjD,SAASC,eAAe,QAAQ,oBAAmB;AACnD,SAASC,eAAe,QAAQ,oBAAmB;AACnD,SAASC,UAAU,QAAQ,qBAAoB;AAoD/C,MAAMC,aAAa,IAAIC;AAEvB,OAAO,MAAMC,aACX,CAACC,oBACD,CAACC;QACC,MAAMC,WAAWF,kBAAkBG,cAAc,IAAI,CAAC,IAAI,EAAEH,kBAAkBI,MAAM,EAAE;QAEtF,MAAMC,mBAAmB;YACvB,IAAIR,WAAWS,GAAG,CAACJ,WAAW;gBAC5B,OAAOL,WAAWU,GAAG,CAACL;YACxB;YACAL,WAAWW,GAAG,CAACN,UAAU,IAAIb,QAAQW,kBAAkBS,OAAO;YAE9D,OAAOZ,WAAWU,GAAG,CAACL;QACxB;QAEA,MAAMQ,UAAUC,mBAAmBN,kBAAkBL;QAErD,MAAMY,mBAAmBZ,kBAAkBa,OAAO,KAAK;QAEvDtB,kBAAkB;YAChBuB,eAAe;YACfC,aAAaf,kBAAkBe,WAAW;YAC1CC,QAAQf;YACRY,SAAS,CAACD,oBAAoBK,QAAQjB,kBAAkBkB,aAAa;YACrEC,eAAe3B,4BAA4B;gBACzC4B,QACE,OAAOpB,kBAAkBkB,aAAa,KAAK,WACvClB,kBAAkBkB,aAAa,CAACE,MAAM,GACtCC;gBACNjB,QAAQJ,kBAAkBI,MAAM;gBAChCW,aAAaf,kBAAkBe,WAAW;gBAC1CV;YACF;YACAiB,mBAAmB;QACrB;QAEA,IAAIV,kBAAkB;YACpB,OAAOX;QACT;QAEA,+CAA+C;QAC/C,MAAMsB,yBAAmEC,OAAOC,OAAO,CACrFzB,kBAAkBe,WAAW,EAC7BW,MAAM,CACN,CAACC,KAAK,CAACC,MAAMC,YAAY,GAAM,CAAA;gBAC7B,GAAGF,GAAG;gBACN,CAACC,KAAK,EAAE;oBACN,GAAIC,gBAAgB,OAAO,CAAC,IAAIA,WAAW;oBAC3CnB;gBACF;YACF,CAAA,GACA,CAAC;QAGH,gFAAgF;QAChF,MAAMM,SAAS;YACb,GAAGf,cAAc;YACjBc,aAAa,AAACd,CAAAA,eAAec,WAAW,IAAI,EAAE,AAAD,EAAGe,GAAG,CAAC,CAACC;gBACnD,IAAI,CAACR,sBAAsB,CAACQ,WAAWH,IAAI,CAAC,EAAE;oBAC5C,OAAOG;gBACT;gBAEA,OAAO;oBACL,GAAGA,UAAU;oBACbC,QAAQ;wBACN,GAAI,OAAOD,WAAWC,MAAM,KAAK,WAAWD,WAAWC,MAAM,GAAG,CAAC,CAAC;wBAClEC,qBAAqB;oBACvB;gBACF;YACF;QACF;QAEA,OAAO3C,mBAAmB;YACxB4C,oBAAoBlC,kBAAkBkC,kBAAkB;YACxDnB,aAAaQ;QACf,GAAGP;IACL,EAAC;AAEH,SAASL,mBACPN,gBAA+B,EAC/B,EAAE8B,GAAG,EAAE/B,MAAM,EAAEc,aAAa,EAAqB;IAEjD,OAAO,CAAC,EAAEa,UAAU,EAAEK,MAAM,EAAE;QAC5B,OAAO;YACLC,MAAM;YACNnB;YACAoB,aAAa7C,eAAe;gBAAEW;gBAAQC;YAAiB;YACvDkC,cAAc7C,gBAAgB;gBAAEU;gBAAQC;YAAiB;YACzDmC,cAAc7C,gBAAgB;gBAC5BwC;gBACA/B;gBACA2B;gBACA1B;gBACA+B;YACF;YACAK,eAAe7C,WAAW;gBAAEQ;gBAAQ2B;gBAAY1B;YAAiB;QACnE;IACF;AACF"}