{"version":3,"sources":["../../src/find/findMany.ts"],"sourcesContent":["import type { FindArgs, FlattenedField, TypeWithID } from 'payload'\n\nimport { inArray } from 'drizzle-orm'\n\nimport type { DrizzleAdapter } from '../types.js'\n\nimport { buildQuery } from '../queries/buildQuery.js'\nimport { selectDistinct } from '../queries/selectDistinct.js'\nimport { transform } from '../transform/read/index.js'\nimport { getNameFromDrizzleTable } from '../utilities/getNameFromDrizzleTable.js'\nimport { getTransaction } from '../utilities/getTransaction.js'\nimport { buildFindManyArgs } from './buildFindManyArgs.js'\n\ntype Args = {\n  adapter: DrizzleAdapter\n  collectionSlug?: string\n  fields: FlattenedField[]\n  tableName: string\n  versions?: boolean\n} & Omit<FindArgs, 'collection'>\n\nexport const findMany = async function find({\n  adapter,\n  collectionSlug,\n  draftsEnabled,\n  fields,\n  joins: joinQuery,\n  limit: limitArg,\n  locale,\n  page = 1,\n  pagination,\n  req,\n  select,\n  sort,\n  tableName,\n  versions,\n  where: whereArg,\n}: Args) {\n  let limit = limitArg\n  let totalDocs: number\n  let totalPages: number\n  let hasPrevPage: boolean\n  let hasNextPage: boolean\n  let pagingCounter: number\n  const offset = (page - 1) * limit\n\n  if (limit === 0) {\n    pagination = false\n    limit = undefined\n  }\n\n  const { joins, orderBy, selectFields, where } = buildQuery({\n    adapter,\n    fields,\n    locale,\n    sort,\n    tableName,\n    where: whereArg,\n  })\n\n  const orderedIDMap: Record<number | string, number> = {}\n  let orderedIDs: (number | string)[]\n\n  const findManyArgs = buildFindManyArgs({\n    adapter,\n    collectionSlug,\n    depth: 0,\n    draftsEnabled,\n    fields,\n    joinQuery,\n    joins,\n    locale,\n    select,\n    tableName,\n    versions,\n  })\n\n  if (orderBy) {\n    for (const key in selectFields) {\n      const column = selectFields[key]\n      if (!column || column.primary) {\n        continue\n      }\n\n      if (\n        !orderBy.some(\n          (col) =>\n            col.column.name === column.name &&\n            getNameFromDrizzleTable(col.column.table) === getNameFromDrizzleTable(column.table),\n        )\n      ) {\n        delete selectFields[key]\n      }\n    }\n  }\n\n  const db = await getTransaction(adapter, req)\n\n  const selectDistinctResult = await selectDistinct({\n    adapter,\n    db,\n    joins,\n    query: ({ query }) => {\n      if (orderBy) {\n        query = query.orderBy(() => orderBy.map(({ column, order }) => order(column)))\n      }\n      return query.offset(offset).limit(limit)\n    },\n    selectFields,\n    tableName,\n    where,\n  })\n\n  if (selectDistinctResult) {\n    if (selectDistinctResult.length === 0) {\n      return {\n        docs: [],\n        hasNextPage: false,\n        hasPrevPage: false,\n        limit,\n        nextPage: null,\n        page: 1,\n        pagingCounter: 0,\n        prevPage: null,\n        totalDocs: 0,\n        totalPages: 0,\n      }\n    } else {\n      // set the id in an object for sorting later\n      selectDistinctResult.forEach(({ id }, i) => {\n        orderedIDMap[id] = i\n      })\n      orderedIDs = Object.keys(orderedIDMap)\n      findManyArgs.where = inArray(adapter.tables[tableName].id, orderedIDs)\n    }\n  } else {\n    findManyArgs.limit = limit\n    findManyArgs.offset = offset\n    findManyArgs.orderBy = () => orderBy.map(({ column, order }) => order(column))\n\n    if (where) {\n      findManyArgs.where = where\n    }\n  }\n\n  const findPromise = db.query[tableName].findMany(findManyArgs)\n\n  if (pagination !== false && (orderedIDs ? orderedIDs?.length <= limit : true)) {\n    totalDocs = await adapter.countDistinct({\n      db,\n      joins,\n      tableName,\n      where,\n    })\n\n    totalPages = typeof limit === 'number' && limit !== 0 ? Math.ceil(totalDocs / limit) : 1\n    hasPrevPage = page > 1\n    hasNextPage = totalPages > page\n    pagingCounter = (page - 1) * limit + 1\n  }\n\n  const rawDocs = await findPromise\n  // sort rawDocs from selectQuery\n  if (Object.keys(orderedIDMap).length > 0) {\n    rawDocs.sort((a, b) => orderedIDMap[a.id] - orderedIDMap[b.id])\n  }\n\n  if (pagination === false || !totalDocs) {\n    totalDocs = rawDocs.length\n    totalPages = 1\n    pagingCounter = 1\n    hasPrevPage = false\n    hasNextPage = false\n  }\n\n  const docs = rawDocs.map((data: TypeWithID) => {\n    return transform({\n      adapter,\n      config: adapter.payload.config,\n      data,\n      fields,\n      joinQuery,\n      tableName,\n    })\n  })\n\n  return {\n    docs,\n    hasNextPage,\n    hasPrevPage,\n    limit: limitArg,\n    nextPage: hasNextPage ? page + 1 : null,\n    page,\n    pagingCounter,\n    prevPage: hasPrevPage ? page - 1 : null,\n    totalDocs,\n    totalPages,\n  }\n}\n"],"names":["inArray","buildQuery","selectDistinct","transform","getNameFromDrizzleTable","getTransaction","buildFindManyArgs","findMany","find","adapter","collectionSlug","draftsEnabled","fields","joins","joinQuery","limit","limitArg","locale","page","pagination","req","select","sort","tableName","versions","where","whereArg","totalDocs","totalPages","hasPrevPage","hasNextPage","pagingCounter","offset","undefined","orderBy","selectFields","orderedIDMap","orderedIDs","findManyArgs","depth","key","column","primary","some","col","name","table","db","selectDistinctResult","query","map","order","length","docs","nextPage","prevPage","forEach","id","i","Object","keys","tables","findPromise","countDistinct","Math","ceil","rawDocs","a","b","data","config","payload"],"mappings":"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"}