{"version":3,"sources":["../src/updateOne.ts"],"sourcesContent":["import type { LibSQLDatabase } from 'drizzle-orm/libsql'\nimport type { UpdateOne } from 'payload'\n\nimport toSnakeCase from 'to-snake-case'\n\nimport type { DrizzleAdapter } from './types.js'\n\nimport { buildQuery } from './queries/buildQuery.js'\nimport { selectDistinct } from './queries/selectDistinct.js'\nimport { upsertRow } from './upsertRow/index.js'\nimport { getTransaction } from './utilities/getTransaction.js'\n\nexport const updateOne: UpdateOne = async function updateOne(\n  this: DrizzleAdapter,\n  {\n    id,\n    collection: collectionSlug,\n    data,\n    joins: joinQuery,\n    locale,\n    options = { upsert: false },\n    req,\n    returning,\n    select,\n    where: whereArg,\n  },\n) {\n  const collection = this.payload.collections[collectionSlug].config\n  const tableName = this.tableNameMap.get(toSnakeCase(collection.slug))\n  let idToUpdate = id\n\n  const db = await getTransaction(this, req)\n\n  if (!idToUpdate) {\n    const { joins, selectFields, where } = buildQuery({\n      adapter: this,\n      fields: collection.flattenedFields,\n      locale,\n      tableName,\n      where: whereArg,\n    })\n\n    // selectDistinct will only return if there are joins\n    const selectDistinctResult = await selectDistinct({\n      adapter: this,\n      db,\n      joins,\n      query: ({ query }) => query.limit(1),\n      selectFields,\n      tableName,\n      where,\n    })\n\n    if (selectDistinctResult?.[0]?.id) {\n      idToUpdate = selectDistinctResult?.[0]?.id\n      // If id wasn't passed but `where` without any joins, retrieve it with findFirst\n    } else if (whereArg && !joins.length) {\n      const table = this.tables[tableName]\n\n      const docsToUpdate = await (db as LibSQLDatabase)\n        .select({\n          id: table.id,\n        })\n        .from(table)\n        .where(where)\n        .limit(1)\n      idToUpdate = docsToUpdate?.[0]?.id\n    }\n  }\n\n  if (!idToUpdate && !options.upsert) {\n    // TODO: In 4.0, if returning === false, we should differentiate between:\n    // - No document found to update\n    // - Document found, but returning === false\n    return null\n  }\n\n  const result = await upsertRow({\n    id: idToUpdate,\n    adapter: this,\n    collectionSlug,\n    data,\n    db,\n    fields: collection.flattenedFields,\n    ignoreResult: returning === false,\n    joinQuery,\n    operation: 'update',\n    req,\n    select,\n    tableName,\n  })\n\n  if (returning === false) {\n    return null\n  }\n\n  return result\n}\n"],"names":["toSnakeCase","buildQuery","selectDistinct","upsertRow","getTransaction","updateOne","id","collection","collectionSlug","data","joins","joinQuery","locale","options","upsert","req","returning","select","where","whereArg","payload","collections","config","tableName","tableNameMap","get","slug","idToUpdate","db","selectFields","adapter","fields","flattenedFields","selectDistinctResult","query","limit","length","table","tables","docsToUpdate","from","result","ignoreResult","operation"],"mappings":"AAGA,OAAOA,iBAAiB,gBAAe;AAIvC,SAASC,UAAU,QAAQ,0BAAyB;AACpD,SAASC,cAAc,QAAQ,8BAA6B;AAC5D,SAASC,SAAS,QAAQ,uBAAsB;AAChD,SAASC,cAAc,QAAQ,gCAA+B;AAE9D,OAAO,MAAMC,YAAuB,eAAeA,UAEjD,EACEC,EAAE,EACFC,YAAYC,cAAc,EAC1BC,IAAI,EACJC,OAAOC,SAAS,EAChBC,MAAM,EACNC,UAAU;IAAEC,QAAQ;AAAM,CAAC,EAC3BC,GAAG,EACHC,SAAS,EACTC,MAAM,EACNC,OAAOC,QAAQ,EAChB;IAED,MAAMZ,aAAa,IAAI,CAACa,OAAO,CAACC,WAAW,CAACb,eAAe,CAACc,MAAM;IAClE,MAAMC,YAAY,IAAI,CAACC,YAAY,CAACC,GAAG,CAACzB,YAAYO,WAAWmB,IAAI;IACnE,IAAIC,aAAarB;IAEjB,MAAMsB,KAAK,MAAMxB,eAAe,IAAI,EAAEW;IAEtC,IAAI,CAACY,YAAY;QACf,MAAM,EAAEjB,KAAK,EAAEmB,YAAY,EAAEX,KAAK,EAAE,GAAGjB,WAAW;YAChD6B,SAAS,IAAI;YACbC,QAAQxB,WAAWyB,eAAe;YAClCpB;YACAW;YACAL,OAAOC;QACT;QAEA,qDAAqD;QACrD,MAAMc,uBAAuB,MAAM/B,eAAe;YAChD4B,SAAS,IAAI;YACbF;YACAlB;YACAwB,OAAO,CAAC,EAAEA,KAAK,EAAE,GAAKA,MAAMC,KAAK,CAAC;YAClCN;YACAN;YACAL;QACF;QAEA,IAAIe,sBAAsB,CAAC,EAAE,EAAE3B,IAAI;YACjCqB,aAAaM,sBAAsB,CAAC,EAAE,EAAE3B;QACxC,gFAAgF;QAClF,OAAO,IAAIa,YAAY,CAACT,MAAM0B,MAAM,EAAE;YACpC,MAAMC,QAAQ,IAAI,CAACC,MAAM,CAACf,UAAU;YAEpC,MAAMgB,eAAe,MAAM,AAACX,GACzBX,MAAM,CAAC;gBACNX,IAAI+B,MAAM/B,EAAE;YACd,GACCkC,IAAI,CAACH,OACLnB,KAAK,CAACA,OACNiB,KAAK,CAAC;YACTR,aAAaY,cAAc,CAAC,EAAE,EAAEjC;QAClC;IACF;IAEA,IAAI,CAACqB,cAAc,CAACd,QAAQC,MAAM,EAAE;QAClC,yEAAyE;QACzE,gCAAgC;QAChC,4CAA4C;QAC5C,OAAO;IACT;IAEA,MAAM2B,SAAS,MAAMtC,UAAU;QAC7BG,IAAIqB;QACJG,SAAS,IAAI;QACbtB;QACAC;QACAmB;QACAG,QAAQxB,WAAWyB,eAAe;QAClCU,cAAc1B,cAAc;QAC5BL;QACAgC,WAAW;QACX5B;QACAE;QACAM;IACF;IAEA,IAAIP,cAAc,OAAO;QACvB,OAAO;IACT;IAEA,OAAOyB;AACT,EAAC"}