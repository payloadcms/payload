{"version":3,"sources":["../src/deleteVersions.ts"],"sourcesContent":["import type { DeleteVersions, FlattenedField, SanitizedCollectionConfig } from 'payload'\n\nimport { inArray } from 'drizzle-orm'\nimport { APIError, buildVersionCollectionFields, buildVersionGlobalFields } from 'payload'\nimport toSnakeCase from 'to-snake-case'\n\nimport type { DrizzleAdapter } from './types.js'\n\nimport { findMany } from './find/findMany.js'\nimport { getTransaction } from './utilities/getTransaction.js'\n\nexport const deleteVersions: DeleteVersions = async function deleteVersion(\n  this: DrizzleAdapter,\n  { collection: collectionSlug, globalSlug, locale, req, where: where },\n) {\n  let tableName: string\n  let fields: FlattenedField[]\n\n  if (globalSlug) {\n    const globalConfig = this.payload.globals.config.find(({ slug }) => slug === globalSlug)\n    tableName = this.tableNameMap.get(`_${toSnakeCase(globalSlug)}${this.versionsSuffix}`)\n    fields = buildVersionGlobalFields(this.payload.config, globalConfig, true)\n  } else if (collectionSlug) {\n    const collectionConfig: SanitizedCollectionConfig =\n      this.payload.collections[collectionSlug].config\n    tableName = this.tableNameMap.get(\n      `_${toSnakeCase(collectionConfig.slug)}${this.versionsSuffix}`,\n    )\n    fields = buildVersionCollectionFields(this.payload.config, collectionConfig, true)\n  } else {\n    throw new APIError('Either collection or globalSlug must be passed.')\n  }\n\n  const { docs } = await findMany({\n    adapter: this,\n    fields,\n    joins: false,\n    limit: 0,\n    locale,\n    page: 1,\n    pagination: false,\n    req,\n    tableName,\n    where,\n  })\n\n  const ids = []\n\n  docs.forEach((doc) => {\n    ids.push(doc.id)\n  })\n\n  if (ids.length > 0) {\n    const db = await getTransaction(this, req)\n\n    await this.deleteWhere({\n      db,\n      tableName,\n      where: inArray(this.tables[tableName].id, ids),\n    })\n  }\n\n  return docs\n}\n"],"names":["inArray","APIError","buildVersionCollectionFields","buildVersionGlobalFields","toSnakeCase","findMany","getTransaction","deleteVersions","deleteVersion","collection","collectionSlug","globalSlug","locale","req","where","tableName","fields","globalConfig","payload","globals","config","find","slug","tableNameMap","get","versionsSuffix","collectionConfig","collections","docs","adapter","joins","limit","page","pagination","ids","forEach","doc","push","id","length","db","deleteWhere","tables"],"mappings":"AAEA,SAASA,OAAO,QAAQ,cAAa;AACrC,SAASC,QAAQ,EAAEC,4BAA4B,EAAEC,wBAAwB,QAAQ,UAAS;AAC1F,OAAOC,iBAAiB,gBAAe;AAIvC,SAASC,QAAQ,QAAQ,qBAAoB;AAC7C,SAASC,cAAc,QAAQ,gCAA+B;AAE9D,OAAO,MAAMC,iBAAiC,eAAeC,cAE3D,EAAEC,YAAYC,cAAc,EAAEC,UAAU,EAAEC,MAAM,EAAEC,GAAG,EAAEC,OAAOA,KAAK,EAAE;IAErE,IAAIC;IACJ,IAAIC;IAEJ,IAAIL,YAAY;QACd,MAAMM,eAAe,IAAI,CAACC,OAAO,CAACC,OAAO,CAACC,MAAM,CAACC,IAAI,CAAC,CAAC,EAAEC,IAAI,EAAE,GAAKA,SAASX;QAC7EI,YAAY,IAAI,CAACQ,YAAY,CAACC,GAAG,CAAC,CAAC,CAAC,EAAEpB,YAAYO,cAAc,IAAI,CAACc,cAAc,EAAE;QACrFT,SAASb,yBAAyB,IAAI,CAACe,OAAO,CAACE,MAAM,EAAEH,cAAc;IACvE,OAAO,IAAIP,gBAAgB;QACzB,MAAMgB,mBACJ,IAAI,CAACR,OAAO,CAACS,WAAW,CAACjB,eAAe,CAACU,MAAM;QACjDL,YAAY,IAAI,CAACQ,YAAY,CAACC,GAAG,CAC/B,CAAC,CAAC,EAAEpB,YAAYsB,iBAAiBJ,IAAI,IAAI,IAAI,CAACG,cAAc,EAAE;QAEhET,SAASd,6BAA6B,IAAI,CAACgB,OAAO,CAACE,MAAM,EAAEM,kBAAkB;IAC/E,OAAO;QACL,MAAM,IAAIzB,SAAS;IACrB;IAEA,MAAM,EAAE2B,IAAI,EAAE,GAAG,MAAMvB,SAAS;QAC9BwB,SAAS,IAAI;QACbb;QACAc,OAAO;QACPC,OAAO;QACPnB;QACAoB,MAAM;QACNC,YAAY;QACZpB;QACAE;QACAD;IACF;IAEA,MAAMoB,MAAM,EAAE;IAEdN,KAAKO,OAAO,CAAC,CAACC;QACZF,IAAIG,IAAI,CAACD,IAAIE,EAAE;IACjB;IAEA,IAAIJ,IAAIK,MAAM,GAAG,GAAG;QAClB,MAAMC,KAAK,MAAMlC,eAAe,IAAI,EAAEO;QAEtC,MAAM,IAAI,CAAC4B,WAAW,CAAC;YACrBD;YACAzB;YACAD,OAAOd,QAAQ,IAAI,CAAC0C,MAAM,CAAC3B,UAAU,CAACuB,EAAE,EAAEJ;QAC5C;IACF;IAEA,OAAON;AACT,EAAC"}