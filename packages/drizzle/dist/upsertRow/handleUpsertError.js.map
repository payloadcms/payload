{"version":3,"sources":["../../src/upsertRow/handleUpsertError.ts"],"sourcesContent":["import type { PayloadRequest } from 'payload'\n\nimport { ValidationError } from 'payload'\n\nimport type { DrizzleAdapter } from '../types.js'\n\ntype HandleUpsertErrorArgs = {\n  adapter: DrizzleAdapter\n  collectionSlug?: string\n  error: unknown\n  globalSlug?: string\n  id?: number | string\n  req?: Partial<PayloadRequest>\n  tableName: string\n}\n\n/**\n * Handles unique constraint violation errors from PostgreSQL and SQLite,\n * converting them to Payload ValidationErrors.\n * Re-throws non-constraint errors unchanged.\n */\nexport const handleUpsertError = ({\n  id,\n  adapter,\n  collectionSlug,\n  error: caughtError,\n  globalSlug,\n  req,\n  tableName,\n}: HandleUpsertErrorArgs): never => {\n  let error: any = caughtError\n  if (typeof caughtError === 'object' && caughtError !== null && 'cause' in caughtError) {\n    error = caughtError.cause\n  }\n\n  // PostgreSQL: 23505, SQLite: SQLITE_CONSTRAINT_UNIQUE\n  if (error?.code === '23505' || error?.code === 'SQLITE_CONSTRAINT_UNIQUE') {\n    let fieldName: null | string = null\n\n    if (error.code === '23505') {\n      // PostgreSQL - extract field name from constraint\n      if (adapter.fieldConstraints?.[tableName]?.[error.constraint]) {\n        fieldName = adapter.fieldConstraints[tableName][error.constraint]\n      } else {\n        const replacement = `${tableName}_`\n        if (error.constraint?.includes(replacement)) {\n          const replacedConstraint = error.constraint.replace(replacement, '')\n          if (replacedConstraint && adapter.fieldConstraints[tableName]?.[replacedConstraint]) {\n            fieldName = adapter.fieldConstraints[tableName][replacedConstraint]\n          }\n        }\n      }\n\n      if (!fieldName && error.detail) {\n        // Extract from detail: \"Key (field)=(value) already exists.\"\n        const regex = /Key \\(([^)]+)\\)=\\(([^)]+)\\)/\n        const match: string[] = error.detail.match(regex)\n        if (match && match[1]) {\n          fieldName = match[1]\n        }\n      }\n    } else if (error.code === 'SQLITE_CONSTRAINT_UNIQUE') {\n      // SQLite - extract from message: \"UNIQUE constraint failed: table.field\"\n      const regex = /UNIQUE constraint failed: ([^.]+)\\.([^.]+)/\n      const match: string[] = error.message?.match(regex)\n      if (match && match[2]) {\n        if (adapter.fieldConstraints[tableName]) {\n          fieldName = adapter.fieldConstraints[tableName][`${match[2]}_idx`]\n        }\n        if (!fieldName) {\n          fieldName = match[2]\n        }\n      }\n    }\n\n    throw new ValidationError(\n      {\n        id,\n        collection: collectionSlug,\n        errors: [\n          {\n            message: req?.t ? req.t('error:valueMustBeUnique') : 'Value must be unique',\n            path: fieldName,\n          },\n        ],\n        global: globalSlug,\n        req,\n      },\n      req?.t,\n    )\n  }\n\n  // Re-throw non-constraint errors\n  throw caughtError\n}\n"],"names":["ValidationError","handleUpsertError","id","adapter","collectionSlug","error","caughtError","globalSlug","req","tableName","cause","code","fieldName","fieldConstraints","constraint","replacement","includes","replacedConstraint","replace","detail","regex","match","message","collection","errors","t","path","global"],"mappings":"AAEA,SAASA,eAAe,QAAQ,UAAS;AAczC;;;;CAIC,GACD,OAAO,MAAMC,oBAAoB,CAAC,EAChCC,EAAE,EACFC,OAAO,EACPC,cAAc,EACdC,OAAOC,WAAW,EAClBC,UAAU,EACVC,GAAG,EACHC,SAAS,EACa;IACtB,IAAIJ,QAAaC;IACjB,IAAI,OAAOA,gBAAgB,YAAYA,gBAAgB,QAAQ,WAAWA,aAAa;QACrFD,QAAQC,YAAYI,KAAK;IAC3B;IAEA,sDAAsD;IACtD,IAAIL,OAAOM,SAAS,WAAWN,OAAOM,SAAS,4BAA4B;QACzE,IAAIC,YAA2B;QAE/B,IAAIP,MAAMM,IAAI,KAAK,SAAS;YAC1B,kDAAkD;YAClD,IAAIR,QAAQU,gBAAgB,EAAE,CAACJ,UAAU,EAAE,CAACJ,MAAMS,UAAU,CAAC,EAAE;gBAC7DF,YAAYT,QAAQU,gBAAgB,CAACJ,UAAU,CAACJ,MAAMS,UAAU,CAAC;YACnE,OAAO;gBACL,MAAMC,cAAc,GAAGN,UAAU,CAAC,CAAC;gBACnC,IAAIJ,MAAMS,UAAU,EAAEE,SAASD,cAAc;oBAC3C,MAAME,qBAAqBZ,MAAMS,UAAU,CAACI,OAAO,CAACH,aAAa;oBACjE,IAAIE,sBAAsBd,QAAQU,gBAAgB,CAACJ,UAAU,EAAE,CAACQ,mBAAmB,EAAE;wBACnFL,YAAYT,QAAQU,gBAAgB,CAACJ,UAAU,CAACQ,mBAAmB;oBACrE;gBACF;YACF;YAEA,IAAI,CAACL,aAAaP,MAAMc,MAAM,EAAE;gBAC9B,6DAA6D;gBAC7D,MAAMC,QAAQ;gBACd,MAAMC,QAAkBhB,MAAMc,MAAM,CAACE,KAAK,CAACD;gBAC3C,IAAIC,SAASA,KAAK,CAAC,EAAE,EAAE;oBACrBT,YAAYS,KAAK,CAAC,EAAE;gBACtB;YACF;QACF,OAAO,IAAIhB,MAAMM,IAAI,KAAK,4BAA4B;YACpD,yEAAyE;YACzE,MAAMS,QAAQ;YACd,MAAMC,QAAkBhB,MAAMiB,OAAO,EAAED,MAAMD;YAC7C,IAAIC,SAASA,KAAK,CAAC,EAAE,EAAE;gBACrB,IAAIlB,QAAQU,gBAAgB,CAACJ,UAAU,EAAE;oBACvCG,YAAYT,QAAQU,gBAAgB,CAACJ,UAAU,CAAC,GAAGY,KAAK,CAAC,EAAE,CAAC,IAAI,CAAC,CAAC;gBACpE;gBACA,IAAI,CAACT,WAAW;oBACdA,YAAYS,KAAK,CAAC,EAAE;gBACtB;YACF;QACF;QAEA,MAAM,IAAIrB,gBACR;YACEE;YACAqB,YAAYnB;YACZoB,QAAQ;gBACN;oBACEF,SAASd,KAAKiB,IAAIjB,IAAIiB,CAAC,CAAC,6BAA6B;oBACrDC,MAAMd;gBACR;aACD;YACDe,QAAQpB;YACRC;QACF,GACAA,KAAKiB;IAET;IAEA,iCAAiC;IACjC,MAAMnB;AACR,EAAC"}