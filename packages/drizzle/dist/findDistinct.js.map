{"version":3,"sources":["../src/findDistinct.ts"],"sourcesContent":["import { type FindDistinct, getFieldByPath, type SanitizedCollectionConfig } from 'payload'\nimport toSnakeCase from 'to-snake-case'\n\nimport type { DrizzleAdapter, GenericColumn } from './types.js'\n\nimport { buildQuery } from './queries/buildQuery.js'\nimport { selectDistinct } from './queries/selectDistinct.js'\nimport { getTransaction } from './utilities/getTransaction.js'\nimport { DistinctSymbol } from './utilities/rawConstraint.js'\n\nexport const findDistinct: FindDistinct = async function (this: DrizzleAdapter, args) {\n  const collectionConfig: SanitizedCollectionConfig =\n    this.payload.collections[args.collection].config\n  const page = args.page || 1\n  const offset = args.limit ? (page - 1) * args.limit : undefined\n  const tableName = this.tableNameMap.get(toSnakeCase(collectionConfig.slug))\n\n  const { joins, orderBy, selectFields, where } = buildQuery({\n    adapter: this,\n    fields: collectionConfig.flattenedFields,\n    locale: args.locale,\n    sort: args.sort ?? args.field,\n    tableName,\n    where: {\n      and: [\n        args.where ?? {},\n        {\n          [args.field]: {\n            equals: DistinctSymbol,\n          },\n        },\n      ],\n    },\n  })\n\n  orderBy.pop()\n\n  const db = await getTransaction(this, args.req)\n\n  const selectDistinctResult = await selectDistinct({\n    adapter: this,\n    db,\n    forceRun: true,\n    joins,\n    query: ({ query }) => {\n      query = query.orderBy(() => orderBy.map(({ column, order }) => order(column)))\n\n      if (args.limit) {\n        if (offset) {\n          query = query.offset(offset)\n        }\n\n        query = query.limit(args.limit)\n      }\n\n      return query\n    },\n    selectFields: {\n      _selected: selectFields['_selected'],\n      ...(orderBy.length &&\n        (orderBy[0].column === selectFields['_selected'] ? {} : { _order: orderBy[0]?.column })),\n    } as Record<string, GenericColumn>,\n    tableName,\n    where,\n  })\n\n  const field = getFieldByPath({\n    config: this.payload.config,\n    fields: collectionConfig.flattenedFields,\n    includeRelationships: true,\n    path: args.field,\n  })?.field\n\n  if (field && 'relationTo' in field && Array.isArray(field.relationTo)) {\n    for (const row of selectDistinctResult as any) {\n      const json = JSON.parse(row._selected)\n      const relationTo = Object.keys(json).find((each) => Boolean(json[each]))\n      const value = json[relationTo]\n\n      if (!value) {\n        row._selected = null\n      } else {\n        row._selected = { relationTo, value }\n      }\n    }\n  }\n\n  const values = selectDistinctResult.map((each) => ({\n    [args.field]: (each as Record<string, any>)._selected,\n  }))\n\n  if (args.limit) {\n    const totalDocs = await this.countDistinct({\n      column: selectFields['_selected'],\n      db,\n      joins,\n      tableName,\n      where,\n    })\n\n    const totalPages = Math.ceil(totalDocs / args.limit)\n    const hasPrevPage = page > 1\n    const hasNextPage = totalPages > page\n    const pagingCounter = (page - 1) * args.limit + 1\n\n    return {\n      hasNextPage,\n      hasPrevPage,\n      limit: args.limit,\n      nextPage: hasNextPage ? page + 1 : null,\n      page,\n      pagingCounter,\n      prevPage: hasPrevPage ? page - 1 : null,\n      totalDocs,\n      totalPages,\n      values,\n    }\n  }\n\n  return {\n    hasNextPage: false,\n    hasPrevPage: false,\n    limit: 0,\n    page: 1,\n    pagingCounter: 1,\n    totalDocs: values.length,\n    totalPages: 1,\n    values,\n  }\n}\n"],"names":["getFieldByPath","toSnakeCase","buildQuery","selectDistinct","getTransaction","DistinctSymbol","findDistinct","args","collectionConfig","payload","collections","collection","config","page","offset","limit","undefined","tableName","tableNameMap","get","slug","joins","orderBy","selectFields","where","adapter","fields","flattenedFields","locale","sort","field","and","equals","pop","db","req","selectDistinctResult","forceRun","query","map","column","order","_selected","length","_order","includeRelationships","path","Array","isArray","relationTo","row","json","JSON","parse","Object","keys","find","each","Boolean","value","values","totalDocs","countDistinct","totalPages","Math","ceil","hasPrevPage","hasNextPage","pagingCounter","nextPage","prevPage"],"mappings":"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"}