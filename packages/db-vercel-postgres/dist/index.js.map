{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import type { PgTableFn } from 'drizzle-orm/pg-core'\nimport type { DatabaseAdapterObj, Payload } from 'payload'\n\nimport {\n  beginTransaction,\n  buildCreateMigration,\n  commitTransaction,\n  count,\n  countGlobalVersions,\n  countVersions,\n  create,\n  createGlobal,\n  createGlobalVersion,\n  createSchemaGenerator,\n  createVersion,\n  deleteMany,\n  deleteOne,\n  deleteVersions,\n  destroy,\n  find,\n  findDistinct,\n  findGlobal,\n  findGlobalVersions,\n  findOne,\n  findVersions,\n  migrate,\n  migrateDown,\n  migrateFresh,\n  migrateRefresh,\n  migrateReset,\n  migrateStatus,\n  operatorMap,\n  queryDrafts,\n  rollbackTransaction,\n  updateGlobal,\n  updateGlobalVersion,\n  updateJobs,\n  updateMany,\n  updateOne,\n  updateVersion,\n  upsert,\n} from '@payloadcms/drizzle'\nimport {\n  columnToCodeConverter,\n  countDistinct,\n  createDatabase,\n  createExtensions,\n  createJSONQuery,\n  defaultDrizzleSnapshot,\n  deleteWhere,\n  dropDatabase,\n  execute,\n  init,\n  insert,\n  requireDrizzleKit,\n} from '@payloadcms/drizzle/postgres'\nimport { pgEnum, pgSchema, pgTable } from 'drizzle-orm/pg-core'\nimport { createDatabaseAdapter, defaultBeginTransaction, findMigrationDir } from 'payload'\nimport { fileURLToPath } from 'url'\n\nimport type { Args, VercelPostgresAdapter } from './types.js'\n\nimport { connect } from './connect.js'\n\nconst filename = fileURLToPath(import.meta.url)\n\nexport function vercelPostgresAdapter(args: Args = {}): DatabaseAdapterObj<VercelPostgresAdapter> {\n  const postgresIDType = args.idType || 'serial'\n  const payloadIDType = postgresIDType === 'serial' ? 'number' : 'text'\n  const allowIDOnCreate = args.allowIDOnCreate ?? false\n\n  function adapter({ payload }: { payload: Payload }) {\n    const migrationDir = findMigrationDir(args.migrationDir)\n    let resolveInitializing\n    let rejectInitializing\n    let adapterSchema: VercelPostgresAdapter['pgSchema']\n\n    const initializing = new Promise<void>((res, rej) => {\n      resolveInitializing = res\n      rejectInitializing = rej\n    })\n\n    if (args.schemaName) {\n      adapterSchema = pgSchema(args.schemaName)\n    } else {\n      adapterSchema = { enum: pgEnum, table: pgTable as unknown as PgTableFn<string> }\n    }\n\n    const extensions = (args.extensions ?? []).reduce<Record<string, boolean>>((acc, name) => {\n      acc[name] = true\n      return acc\n    }, {})\n\n    return createDatabaseAdapter<VercelPostgresAdapter>({\n      name: 'postgres',\n      afterSchemaInit: args.afterSchemaInit ?? [],\n      allowIDOnCreate,\n      beforeSchemaInit: args.beforeSchemaInit ?? [],\n      blocksAsJSON: args.blocksAsJSON ?? false,\n      createDatabase,\n      createExtensions,\n      defaultDrizzleSnapshot,\n      disableCreateDatabase: args.disableCreateDatabase ?? false,\n      // @ts-expect-error - vestiges of when tsconfig was not strict. Feel free to improve\n      drizzle: undefined,\n      enums: {},\n      extensions,\n      features: {\n        json: true,\n      },\n      fieldConstraints: {},\n      forceUseVercelPostgres: args.forceUseVercelPostgres ?? false,\n      foreignKeys: new Set(),\n      generateSchema: createSchemaGenerator({\n        columnToCodeConverter,\n        corePackageSuffix: 'pg-core',\n        defaultOutputFile: args.generateSchemaOutputFile,\n        enumImport: 'pgEnum',\n        schemaImport: 'pgSchema',\n        tableImport: 'pgTable',\n      }),\n      idType: postgresIDType,\n      indexes: new Set<string>(),\n      initializing,\n      localesSuffix: args.localesSuffix || '_locales',\n      logger: args.logger,\n      operators: operatorMap,\n      pgSchema: adapterSchema,\n      pool: undefined,\n      poolOptions: args.pool,\n      prodMigrations: args.prodMigrations,\n      // @ts-expect-error - vestiges of when tsconfig was not strict. Feel free to improve\n      push: args.push,\n      rawRelations: {},\n      rawTables: {},\n      relations: {},\n      relationshipsSuffix: args.relationshipsSuffix || '_rels',\n      schema: {},\n      schemaName: args.schemaName,\n      sessions: {},\n      tableNameMap: new Map<string, string>(),\n      tables: {},\n      tablesFilter: args.tablesFilter,\n      transactionOptions: args.transactionOptions || undefined,\n      updateJobs,\n      versionsSuffix: args.versionsSuffix || '_v',\n\n      // DatabaseAdapter\n      beginTransaction:\n        args.transactionOptions === false ? defaultBeginTransaction() : beginTransaction,\n      commitTransaction,\n      connect,\n      count,\n      countDistinct,\n      countGlobalVersions,\n      countVersions,\n      create,\n      createGlobal,\n      createGlobalVersion,\n      createJSONQuery,\n      createMigration: buildCreateMigration({\n        executeMethod: 'execute',\n        filename,\n        sanitizeStatements({ sqlExecute, statements }) {\n          return `${sqlExecute}\\n ${statements.join('\\n')}\\`)`\n        },\n      }),\n      createVersion,\n      defaultIDType: payloadIDType,\n      deleteMany,\n      deleteOne,\n      deleteVersions,\n      deleteWhere,\n      destroy,\n      dropDatabase,\n      execute,\n      find,\n      findDistinct,\n      findGlobal,\n      findGlobalVersions,\n      findOne,\n      findVersions,\n      init,\n      insert,\n      migrate,\n      migrateDown,\n      migrateFresh,\n      migrateRefresh,\n      migrateReset,\n      migrateStatus,\n      migrationDir,\n      packageName: '@payloadcms/db-vercel-postgres',\n      payload,\n      queryDrafts,\n      readReplicaOptions: args.readReplicas,\n      // @ts-expect-error - vestiges of when tsconfig was not strict. Feel free to improve\n      rejectInitializing,\n      requireDrizzleKit,\n      // @ts-expect-error - vestiges of when tsconfig was not strict. Feel free to improve\n      resolveInitializing,\n      rollbackTransaction,\n      updateGlobal,\n      updateGlobalVersion,\n      updateMany,\n      updateOne,\n      updateVersion,\n      upsert,\n    })\n  }\n\n  return {\n    name: 'postgres',\n    allowIDOnCreate,\n    defaultIDType: payloadIDType,\n    init: adapter,\n  }\n}\n\n/**\n * @todo deprecate /types subpath export in 4.0\n */\nexport type {\n  Args as VercelPostgresAdapterArgs,\n  GeneratedDatabaseSchema,\n  VercelPostgresAdapter,\n} from './types.js'\nexport type { MigrateDownArgs, MigrateUpArgs } from '@payloadcms/drizzle/postgres'\nexport { geometryColumn } from '@payloadcms/drizzle/postgres'\nexport { sql } from 'drizzle-orm'\n"],"names":["beginTransaction","buildCreateMigration","commitTransaction","count","countGlobalVersions","countVersions","create","createGlobal","createGlobalVersion","createSchemaGenerator","createVersion","deleteMany","deleteOne","deleteVersions","destroy","find","findDistinct","findGlobal","findGlobalVersions","findOne","findVersions","migrate","migrateDown","migrateFresh","migrateRefresh","migrateReset","migrateStatus","operatorMap","queryDrafts","rollbackTransaction","updateGlobal","updateGlobalVersion","updateJobs","updateMany","updateOne","updateVersion","upsert","columnToCodeConverter","countDistinct","createDatabase","createExtensions","createJSONQuery","defaultDrizzleSnapshot","deleteWhere","dropDatabase","execute","init","insert","requireDrizzleKit","pgEnum","pgSchema","pgTable","createDatabaseAdapter","defaultBeginTransaction","findMigrationDir","fileURLToPath","connect","filename","url","vercelPostgresAdapter","args","postgresIDType","idType","payloadIDType","allowIDOnCreate","adapter","payload","migrationDir","resolveInitializing","rejectInitializing","adapterSchema","initializing","Promise","res","rej","schemaName","enum","table","extensions","reduce","acc","name","afterSchemaInit","beforeSchemaInit","blocksAsJSON","disableCreateDatabase","drizzle","undefined","enums","features","json","fieldConstraints","forceUseVercelPostgres","foreignKeys","Set","generateSchema","corePackageSuffix","defaultOutputFile","generateSchemaOutputFile","enumImport","schemaImport","tableImport","indexes","localesSuffix","logger","operators","pool","poolOptions","prodMigrations","push","rawRelations","rawTables","relations","relationshipsSuffix","schema","sessions","tableNameMap","Map","tables","tablesFilter","transactionOptions","versionsSuffix","createMigration","executeMethod","sanitizeStatements","sqlExecute","statements","join","defaultIDType","packageName","readReplicaOptions","readReplicas","geometryColumn","sql"],"mappings":"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BACE4D,KAAK4D,kBAAkB,KAAK,QAAQnE,4BAA4BrD;YAClEE;YACAsD;YACArD;YACAmC;YACAlC;YACAC;YACAC;YACAC;YACAC;YACAiC;YACAiF,iBAAiBzH,qBAAqB;gBACpC0H,eAAe;gBACflE;gBACAmE,oBAAmB,EAAEC,UAAU,EAAEC,UAAU,EAAE;oBAC3C,OAAO,GAAGD,WAAW,GAAG,EAAEC,WAAWC,IAAI,CAAC,MAAM,GAAG,CAAC;gBACtD;YACF;YACArH;YACAsH,eAAejE;YACfpD;YACAC;YACAC;YACA8B;YACA7B;YACA8B;YACAC;YACA9B;YACAC;YACAC;YACAC;YACAC;YACAC;YACA0B;YACAC;YACA1B;YACAC;YACAC;YACAC;YACAC;YACAC;YACAyC;YACA8D,aAAa;YACb/D;YACAtC;YACAsG,oBAAoBtE,KAAKuE,YAAY;YACrC,oFAAoF;YACpF9D;YACArB;YACA,oFAAoF;YACpFoB;YACAvC;YACAC;YACAC;YACAE;YACAC;YACAC;YACAC;QACF;IACF;IAEA,OAAO;QACL6C,MAAM;QACNjB;QACAgE,eAAejE;QACfjB,MAAMmB;IACR;AACF;AAWA,SAASmE,cAAc,QAAQ,+BAA8B;AAC7D,SAASC,GAAG,QAAQ,cAAa"}