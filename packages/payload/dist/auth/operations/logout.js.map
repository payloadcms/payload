{"version":3,"sources":["../../../src/auth/operations/logout.ts"],"sourcesContent":["import { status as httpStatus } from 'http-status'\n\nimport type { Collection } from '../../collections/config/types.js'\nimport type { PayloadRequest } from '../../types/index.js'\n\nimport { APIError } from '../../errors/index.js'\nimport { appendNonTrashedFilter } from '../../utilities/appendNonTrashedFilter.js'\nimport { commitTransaction } from '../../utilities/commitTransaction.js'\nimport { initTransaction } from '../../utilities/initTransaction.js'\nimport { killTransaction } from '../../utilities/killTransaction.js'\n\nexport type Arguments = {\n  allSessions?: boolean\n  collection: Collection\n  req: PayloadRequest\n}\n\nexport const logoutOperation = async (incomingArgs: Arguments): Promise<boolean> => {\n  let args = incomingArgs\n  const {\n    allSessions,\n    collection: { config: collectionConfig },\n    req: { user },\n    req,\n  } = incomingArgs\n\n  if (!user) {\n    throw new APIError('No User', httpStatus.BAD_REQUEST)\n  }\n  if (user.collection !== collectionConfig.slug) {\n    throw new APIError('Incorrect collection', httpStatus.FORBIDDEN)\n  }\n\n  const shouldCommit = await initTransaction(req)\n\n  try {\n    if (collectionConfig.hooks?.afterLogout?.length) {\n      for (const hook of collectionConfig.hooks.afterLogout) {\n        args =\n          (await hook({\n            collection: args.collection?.config,\n            context: req.context,\n            req,\n          })) || args\n      }\n    }\n\n    if (collectionConfig.auth.disableLocalStrategy !== true && collectionConfig.auth.useSessions) {\n      const where = appendNonTrashedFilter({\n        enableTrash: Boolean(collectionConfig.trash),\n        trash: false,\n        where: {\n          id: {\n            equals: user.id,\n          },\n        },\n      })\n\n      const userWithSessions = await req.payload.db.findOne<{\n        id: number | string\n        sessions: { id: string }[]\n      }>({\n        collection: collectionConfig.slug,\n        req,\n        where,\n      })\n\n      if (!userWithSessions) {\n        throw new APIError('No User', httpStatus.BAD_REQUEST)\n      }\n\n      if (allSessions) {\n        userWithSessions.sessions = []\n      } else {\n        const sessionsAfterLogout = (userWithSessions?.sessions || []).filter(\n          (s) => s.id !== req?.user?._sid,\n        )\n\n        userWithSessions.sessions = sessionsAfterLogout\n      }\n\n      // Prevent updatedAt from being updated when only removing a session\n      ;(userWithSessions as any).updatedAt = null\n\n      await req.payload.db.updateOne({\n        id: user.id,\n        collection: collectionConfig.slug,\n        data: userWithSessions,\n        req,\n        returning: false,\n      })\n    }\n\n    if (shouldCommit) {\n      await commitTransaction(req)\n    }\n\n    return true\n  } catch (error: unknown) {\n    await killTransaction(req)\n    throw error\n  }\n}\n"],"names":["status","httpStatus","APIError","appendNonTrashedFilter","commitTransaction","initTransaction","killTransaction","logoutOperation","incomingArgs","args","allSessions","collection","config","collectionConfig","req","user","BAD_REQUEST","slug","FORBIDDEN","shouldCommit","hooks","afterLogout","length","hook","context","auth","disableLocalStrategy","useSessions","where","enableTrash","Boolean","trash","id","equals","userWithSessions","payload","db","findOne","sessions","sessionsAfterLogout","filter","s","_sid","updatedAt","updateOne","data","returning","error"],"mappings":"AAAA,SAASA,UAAUC,UAAU,QAAQ,cAAa;AAKlD,SAASC,QAAQ,QAAQ,wBAAuB;AAChD,SAASC,sBAAsB,QAAQ,4CAA2C;AAClF,SAASC,iBAAiB,QAAQ,uCAAsC;AACxE,SAASC,eAAe,QAAQ,qCAAoC;AACpE,SAASC,eAAe,QAAQ,qCAAoC;AAQpE,OAAO,MAAMC,kBAAkB,OAAOC;IACpC,IAAIC,OAAOD;IACX,MAAM,EACJE,WAAW,EACXC,YAAY,EAAEC,QAAQC,gBAAgB,EAAE,EACxCC,KAAK,EAAEC,IAAI,EAAE,EACbD,GAAG,EACJ,GAAGN;IAEJ,IAAI,CAACO,MAAM;QACT,MAAM,IAAIb,SAAS,WAAWD,WAAWe,WAAW;IACtD;IACA,IAAID,KAAKJ,UAAU,KAAKE,iBAAiBI,IAAI,EAAE;QAC7C,MAAM,IAAIf,SAAS,wBAAwBD,WAAWiB,SAAS;IACjE;IAEA,MAAMC,eAAe,MAAMd,gBAAgBS;IAE3C,IAAI;QACF,IAAID,iBAAiBO,KAAK,EAAEC,aAAaC,QAAQ;YAC/C,KAAK,MAAMC,QAAQV,iBAAiBO,KAAK,CAACC,WAAW,CAAE;gBACrDZ,OACE,AAAC,MAAMc,KAAK;oBACVZ,YAAYF,KAAKE,UAAU,EAAEC;oBAC7BY,SAASV,IAAIU,OAAO;oBACpBV;gBACF,MAAOL;YACX;QACF;QAEA,IAAII,iBAAiBY,IAAI,CAACC,oBAAoB,KAAK,QAAQb,iBAAiBY,IAAI,CAACE,WAAW,EAAE;YAC5F,MAAMC,QAAQzB,uBAAuB;gBACnC0B,aAAaC,QAAQjB,iBAAiBkB,KAAK;gBAC3CA,OAAO;gBACPH,OAAO;oBACLI,IAAI;wBACFC,QAAQlB,KAAKiB,EAAE;oBACjB;gBACF;YACF;YAEA,MAAME,mBAAmB,MAAMpB,IAAIqB,OAAO,CAACC,EAAE,CAACC,OAAO,CAGlD;gBACD1B,YAAYE,iBAAiBI,IAAI;gBACjCH;gBACAc;YACF;YAEA,IAAI,CAACM,kBAAkB;gBACrB,MAAM,IAAIhC,SAAS,WAAWD,WAAWe,WAAW;YACtD;YAEA,IAAIN,aAAa;gBACfwB,iBAAiBI,QAAQ,GAAG,EAAE;YAChC,OAAO;gBACL,MAAMC,sBAAsB,AAACL,CAAAA,kBAAkBI,YAAY,EAAE,AAAD,EAAGE,MAAM,CACnE,CAACC,IAAMA,EAAET,EAAE,KAAKlB,KAAKC,MAAM2B;gBAG7BR,iBAAiBI,QAAQ,GAAGC;YAC9B;YAEA,oEAAoE;;YAClEL,iBAAyBS,SAAS,GAAG;YAEvC,MAAM7B,IAAIqB,OAAO,CAACC,EAAE,CAACQ,SAAS,CAAC;gBAC7BZ,IAAIjB,KAAKiB,EAAE;gBACXrB,YAAYE,iBAAiBI,IAAI;gBACjC4B,MAAMX;gBACNpB;gBACAgC,WAAW;YACb;QACF;QAEA,IAAI3B,cAAc;YAChB,MAAMf,kBAAkBU;QAC1B;QAEA,OAAO;IACT,EAAE,OAAOiC,OAAgB;QACvB,MAAMzC,gBAAgBQ;QACtB,MAAMiC;IACR;AACF,EAAC"}