{"version":3,"sources":["../../../src/globals/operations/findOne.ts"],"sourcesContent":["import { ar } from '@payloadcms/translations/languages/ar'\n\nimport type { AccessResult } from '../../config/types.js'\nimport type {\n  JsonObject,\n  PayloadRequest,\n  PopulateType,\n  SelectType,\n  Where,\n} from '../../types/index.js'\nimport type { SanitizedGlobalConfig } from '../config/types.js'\n\nimport { executeAccess } from '../../auth/executeAccess.js'\nimport { NotFound } from '../../errors/NotFound.js'\nimport { afterRead, type AfterReadArgs } from '../../fields/hooks/afterRead/index.js'\nimport { lockedDocumentsCollectionSlug } from '../../locked-documents/config.js'\nimport { getSelectMode } from '../../utilities/getSelectMode.js'\nimport { hasDraftsEnabled } from '../../utilities/getVersionsConfig.js'\nimport { killTransaction } from '../../utilities/killTransaction.js'\nimport { sanitizeSelect } from '../../utilities/sanitizeSelect.js'\nimport { replaceWithDraftIfAvailable } from '../../versions/drafts/replaceWithDraftIfAvailable.js'\n\nexport type GlobalFindOneArgs = {\n  /**\n   * You may pass the document data directly which will skip the `db.findOne` database query.\n   * This is useful if you want to use this endpoint solely for running hooks and populating data.\n   */\n  data?: Record<string, unknown>\n  depth?: number\n  draft?: boolean\n  globalConfig: SanitizedGlobalConfig\n  includeLockStatus?: boolean\n  overrideAccess?: boolean\n  populate?: PopulateType\n  req: PayloadRequest\n  select?: SelectType\n  showHiddenFields?: boolean\n  slug: string\n} & Pick<AfterReadArgs<JsonObject>, 'flattenLocales'>\n\nexport const findOneOperation = async <T extends Record<string, unknown>>(\n  args: GlobalFindOneArgs,\n): Promise<T> => {\n  const {\n    slug,\n    depth,\n    draft: replaceWithVersion = false,\n    flattenLocales,\n    globalConfig,\n    includeLockStatus: includeLockStatusFromArgs,\n    overrideAccess = false,\n    populate,\n    req: { fallbackLocale, locale },\n    req,\n    select: incomingSelect,\n    showHiddenFields,\n  } = args\n\n  const includeLockStatus =\n    includeLockStatusFromArgs && req.payload.collections?.[lockedDocumentsCollectionSlug]\n\n  try {\n    // /////////////////////////////////////\n    // beforeOperation - Global\n    // /////////////////////////////////////\n\n    if (globalConfig.hooks?.beforeOperation?.length) {\n      for (const hook of globalConfig.hooks.beforeOperation) {\n        args =\n          (await hook({\n            args,\n            context: args.req.context,\n            global: globalConfig,\n            operation: 'read',\n            req: args.req,\n          })) || args\n      }\n    }\n\n    // /////////////////////////////////////\n    // Retrieve and execute access\n    // /////////////////////////////////////\n\n    let accessResult!: AccessResult\n\n    if (!overrideAccess) {\n      accessResult = await executeAccess({ req }, globalConfig.access.read)\n    }\n\n    if (accessResult === false) {\n      throw new NotFound(req.t)\n    }\n\n    const select = sanitizeSelect({\n      fields: globalConfig.flattenedFields,\n      forceSelect: globalConfig.forceSelect,\n      select: incomingSelect,\n    })\n\n    // /////////////////////////////////////\n    // Perform database operation\n    // /////////////////////////////////////\n\n    const docFromDB = await req.payload.db.findGlobal({\n      slug,\n      locale: locale!,\n      req,\n      select,\n      where: overrideAccess ? undefined : (accessResult as Where),\n    })\n\n    // Check if no document was returned (Postgres returns {} instead of null)\n    const hasDoc = docFromDB && Object.keys(docFromDB).length > 0\n\n    if (!hasDoc && !args.data && !overrideAccess && accessResult !== true) {\n      return {} as any\n    }\n\n    let doc = (args.data as any) ?? (hasDoc ? docFromDB : null) ?? {}\n\n    // /////////////////////////////////////\n    // Include Lock Status if required\n    // /////////////////////////////////////\n    if (includeLockStatus && slug) {\n      let lockStatus: JsonObject | null = null\n\n      try {\n        const lockDocumentsProp = globalConfig?.lockDocuments\n\n        const lockDurationDefault = 300 // Default 5 minutes in seconds\n        const lockDuration =\n          typeof lockDocumentsProp === 'object' ? lockDocumentsProp.duration : lockDurationDefault\n        const lockDurationInMilliseconds = lockDuration * 1000\n\n        const lockedDocument = await req.payload.find({\n          collection: lockedDocumentsCollectionSlug,\n          depth: 1,\n          limit: 1,\n          overrideAccess: false,\n          pagination: false,\n          req,\n          where: {\n            and: [\n              {\n                globalSlug: {\n                  equals: slug,\n                },\n              },\n              {\n                updatedAt: {\n                  greater_than: new Date(new Date().getTime() - lockDurationInMilliseconds),\n                },\n              },\n            ],\n          },\n        })\n\n        if (lockedDocument && lockedDocument.docs.length > 0) {\n          lockStatus = lockedDocument.docs[0]!\n        }\n      } catch {\n        // swallow error\n      }\n\n      doc._isLocked = !!lockStatus\n      doc._userEditing = lockStatus?.user?.value ?? null\n    }\n\n    // /////////////////////////////////////\n    // Replace document with draft if available\n    // /////////////////////////////////////\n\n    if (replaceWithVersion && hasDraftsEnabled(globalConfig)) {\n      doc = await replaceWithDraftIfAvailable({\n        accessResult,\n        doc,\n        entity: globalConfig,\n        entityType: 'global',\n        overrideAccess,\n        req,\n        select,\n      })\n    }\n\n    // /////////////////////////////////////\n    // Execute before global hook\n    // /////////////////////////////////////\n\n    if (globalConfig.hooks?.beforeRead?.length) {\n      for (const hook of globalConfig.hooks.beforeRead) {\n        doc =\n          (await hook({\n            context: req.context,\n            doc,\n            global: globalConfig,\n            req,\n          })) || doc\n      }\n    }\n\n    // /////////////////////////////////////\n    // Execute globalType field if not selected\n    // /////////////////////////////////////\n    if (select && doc.globalType) {\n      const selectMode = getSelectMode(select)\n      if (\n        (selectMode === 'include' && !select['globalType']) ||\n        (selectMode === 'exclude' && select['globalType'] === false)\n      ) {\n        delete doc['globalType']\n      }\n    }\n\n    // /////////////////////////////////////\n    // Execute field-level hooks and access\n    // /////////////////////////////////////\n\n    doc = await afterRead({\n      collection: null,\n      context: req.context,\n      depth: depth!,\n      doc,\n      draft: replaceWithVersion,\n      fallbackLocale: fallbackLocale!,\n      flattenLocales,\n      global: globalConfig,\n      locale: locale!,\n      overrideAccess,\n      populate,\n      req,\n      select,\n      showHiddenFields: showHiddenFields!,\n    })\n\n    // /////////////////////////////////////\n    // Execute after global hook\n    // /////////////////////////////////////\n\n    if (globalConfig.hooks?.afterRead?.length) {\n      for (const hook of globalConfig.hooks.afterRead) {\n        doc =\n          (await hook({\n            context: req.context,\n            doc,\n            global: globalConfig,\n            req,\n          })) || doc\n      }\n    }\n\n    // /////////////////////////////////////\n    // Return results\n    // /////////////////////////////////////\n\n    return doc\n  } catch (error: unknown) {\n    await killTransaction(req)\n    throw error\n  }\n}\n"],"names":["executeAccess","NotFound","afterRead","lockedDocumentsCollectionSlug","getSelectMode","hasDraftsEnabled","killTransaction","sanitizeSelect","replaceWithDraftIfAvailable","findOneOperation","args","slug","depth","draft","replaceWithVersion","flattenLocales","globalConfig","includeLockStatus","includeLockStatusFromArgs","overrideAccess","populate","req","fallbackLocale","locale","select","incomingSelect","showHiddenFields","payload","collections","hooks","beforeOperation","length","hook","context","global","operation","accessResult","access","read","t","fields","flattenedFields","forceSelect","docFromDB","db","findGlobal","where","undefined","hasDoc","Object","keys","data","doc","lockStatus","lockDocumentsProp","lockDocuments","lockDurationDefault","lockDuration","duration","lockDurationInMilliseconds","lockedDocument","find","collection","limit","pagination","and","globalSlug","equals","updatedAt","greater_than","Date","getTime","docs","_isLocked","_userEditing","user","value","entity","entityType","beforeRead","globalType","selectMode","error"],"mappings":"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"}