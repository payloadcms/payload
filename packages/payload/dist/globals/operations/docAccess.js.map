{"version":3,"sources":["../../../src/globals/operations/docAccess.ts"],"sourcesContent":["import type { SanitizedGlobalPermission } from '../../auth/index.js'\nimport type { AllOperations, JsonObject, PayloadRequest } from '../../types/index.js'\nimport type { SanitizedGlobalConfig } from '../config/types.js'\n\nimport { commitTransaction } from '../../utilities/commitTransaction.js'\nimport { getEntityPermissions } from '../../utilities/getEntityPermissions/getEntityPermissions.js'\nimport { initTransaction } from '../../utilities/initTransaction.js'\nimport { killTransaction } from '../../utilities/killTransaction.js'\nimport { sanitizePermissions } from '../../utilities/sanitizePermissions.js'\n\ntype Arguments = {\n  /**\n   * If the document data is passed, it will be used to check access instead of fetching the document from the database.\n   */\n  data?: JsonObject\n  globalConfig: SanitizedGlobalConfig\n  req: PayloadRequest\n}\n\nexport const docAccessOperation = async (args: Arguments): Promise<SanitizedGlobalPermission> => {\n  const { data, globalConfig, req } = args\n\n  const globalOperations: AllOperations[] = ['read', 'update']\n\n  if (globalConfig.versions) {\n    globalOperations.push('readVersions')\n  }\n\n  try {\n    const result = await getEntityPermissions({\n      id: undefined,\n      blockReferencesPermissions: {},\n      data,\n      entity: globalConfig,\n      entityType: 'global',\n      fetchData: true,\n      operations: globalOperations,\n      req,\n    })\n\n    const sanitizedPermissions = sanitizePermissions({\n      globals: {\n        [globalConfig.slug]: result,\n      },\n    })\n\n    const globalPermissions = sanitizedPermissions?.globals?.[globalConfig.slug]\n    return globalPermissions ?? { fields: {} }\n  } catch (e: unknown) {\n    await killTransaction(req)\n    throw e\n  }\n}\n"],"names":["getEntityPermissions","killTransaction","sanitizePermissions","docAccessOperation","args","data","globalConfig","req","globalOperations","versions","push","result","id","undefined","blockReferencesPermissions","entity","entityType","fetchData","operations","sanitizedPermissions","globals","slug","globalPermissions","fields","e"],"mappings":"AAKA,SAASA,oBAAoB,QAAQ,+DAA8D;AAEnG,SAASC,eAAe,QAAQ,qCAAoC;AACpE,SAASC,mBAAmB,QAAQ,yCAAwC;AAW5E,OAAO,MAAMC,qBAAqB,OAAOC;IACvC,MAAM,EAAEC,IAAI,EAAEC,YAAY,EAAEC,GAAG,EAAE,GAAGH;IAEpC,MAAMI,mBAAoC;QAAC;QAAQ;KAAS;IAE5D,IAAIF,aAAaG,QAAQ,EAAE;QACzBD,iBAAiBE,IAAI,CAAC;IACxB;IAEA,IAAI;QACF,MAAMC,SAAS,MAAMX,qBAAqB;YACxCY,IAAIC;YACJC,4BAA4B,CAAC;YAC7BT;YACAU,QAAQT;YACRU,YAAY;YACZC,WAAW;YACXC,YAAYV;YACZD;QACF;QAEA,MAAMY,uBAAuBjB,oBAAoB;YAC/CkB,SAAS;gBACP,CAACd,aAAae,IAAI,CAAC,EAAEV;YACvB;QACF;QAEA,MAAMW,oBAAoBH,sBAAsBC,SAAS,CAACd,aAAae,IAAI,CAAC;QAC5E,OAAOC,qBAAqB;YAAEC,QAAQ,CAAC;QAAE;IAC3C,EAAE,OAAOC,GAAY;QACnB,MAAMvB,gBAAgBM;QACtB,MAAMiB;IACR;AACF,EAAC"}