{"version":3,"sources":["../../src/versions/saveVersion.ts"],"sourcesContent":["import type { SanitizedCollectionConfig } from '../collections/config/types.js'\nimport type { SanitizedGlobalConfig } from '../globals/config/types.js'\nimport type { CreateGlobalVersionArgs, CreateVersionArgs, Payload } from '../index.js'\nimport type { JsonObject, PayloadRequest, SelectType } from '../types/index.js'\n\nimport { deepCopyObjectSimple } from '../index.js'\nimport { getVersionsMax } from '../utilities/getVersionsConfig.js'\nimport { sanitizeInternalFields } from '../utilities/sanitizeInternalFields.js'\nimport { getQueryDraftsSelect } from './drafts/getQueryDraftsSelect.js'\nimport { enforceMaxVersions } from './enforceMaxVersions.js'\nimport { saveSnapshot } from './saveSnapshot.js'\n\ntype Args<T extends JsonObject = JsonObject> = {\n  autosave?: boolean\n  collection?: SanitizedCollectionConfig\n  docWithLocales: T\n  draft?: boolean\n  global?: SanitizedGlobalConfig\n  id?: number | string\n  operation?: 'create' | 'restoreVersion' | 'update'\n  payload: Payload\n  publishSpecificLocale?: string\n  req?: PayloadRequest\n  returning?: boolean\n  select?: SelectType\n  snapshot?: any\n}\n\nexport async function saveVersion<TData extends JsonObject = JsonObject>(\n  args: { returning: false } & Args<TData>,\n): Promise<null>\nexport async function saveVersion<TData extends JsonObject = JsonObject>(\n  args: { returning: true } & Args<TData>,\n): Promise<JsonObject>\nexport async function saveVersion<TData extends JsonObject = JsonObject>(\n  args: Omit<Args<TData>, 'returning'>,\n): Promise<JsonObject>\nexport async function saveVersion<TData extends JsonObject = JsonObject>({\n  id,\n  autosave,\n  collection,\n  docWithLocales,\n  draft,\n  global,\n  operation,\n  payload,\n  publishSpecificLocale,\n  req,\n  returning,\n  select,\n  snapshot,\n}: Args<TData>): Promise<JsonObject | null> {\n  let result: JsonObject | undefined\n  let createNewVersion = true\n  const now = new Date().toISOString()\n  const versionData: {\n    _status?: 'draft'\n    updatedAt?: string\n  } & TData = deepCopyObjectSimple(docWithLocales)\n\n  if (draft) {\n    versionData._status = 'draft'\n  }\n\n  if (collection?.timestamps && draft) {\n    versionData.updatedAt = now\n  }\n\n  if (versionData._id) {\n    delete versionData._id\n  }\n\n  try {\n    if (autosave) {\n      let docs\n      const findVersionArgs = {\n        limit: 1,\n        pagination: false,\n        req,\n        sort: '-updatedAt',\n      }\n\n      if (collection) {\n        ;({ docs } = await payload.db.findVersions<TData>({\n          ...findVersionArgs,\n          collection: collection.slug,\n          limit: 1,\n          pagination: false,\n          req,\n          where: {\n            parent: {\n              equals: id,\n            },\n          },\n        }))\n      } else {\n        ;({ docs } = await payload.db.findGlobalVersions<TData>({\n          ...findVersionArgs,\n          global: global!.slug,\n          limit: 1,\n          pagination: false,\n          req,\n        }))\n      }\n      const [latestVersion] = docs\n\n      // overwrite the latest version if it's set to autosave\n      if (latestVersion && 'autosave' in latestVersion && latestVersion.autosave === true) {\n        createNewVersion = false\n\n        const updateVersionArgs = {\n          id: latestVersion.id,\n          req,\n          versionData: {\n            createdAt: new Date(latestVersion.createdAt).toISOString(),\n            latest: true,\n            parent: id,\n            updatedAt: now,\n            version: {\n              ...versionData,\n            },\n          },\n        }\n\n        if (collection) {\n          result = await payload.db.updateVersion<TData>({\n            ...updateVersionArgs,\n            collection: collection.slug,\n            req,\n          })\n        } else {\n          result = await payload.db.updateGlobalVersion<TData>({\n            ...updateVersionArgs,\n            global: global!.slug,\n            req,\n          })\n        }\n      }\n    }\n\n    if (createNewVersion) {\n      const createVersionArgs = {\n        autosave: Boolean(autosave),\n        collectionSlug: undefined as string | undefined,\n        createdAt: operation === 'restoreVersion' ? versionData.createdAt : now,\n        globalSlug: undefined as string | undefined,\n        parent: collection ? id : undefined,\n        publishedLocale: publishSpecificLocale || undefined,\n        req,\n        returning,\n        select: getQueryDraftsSelect({ select }),\n        updatedAt: now,\n        versionData,\n      }\n\n      if (collection) {\n        createVersionArgs.collectionSlug = collection.slug\n        result = await payload.db.createVersion(createVersionArgs as CreateVersionArgs)\n      }\n\n      if (global) {\n        createVersionArgs.globalSlug = global.slug\n        result = await payload.db.createGlobalVersion(createVersionArgs as CreateGlobalVersionArgs)\n      }\n\n      if (snapshot) {\n        await saveSnapshot<TData>({\n          id,\n          autosave,\n          collection,\n          data: snapshot,\n          global,\n          payload,\n          publishSpecificLocale,\n          req,\n          select,\n        })\n      }\n    }\n  } catch (err) {\n    let errorMessage: string | undefined\n\n    if (collection) {\n      errorMessage = `There was an error while saving a version for the ${typeof collection.labels.singular === 'string' ? collection.labels.singular : collection.slug} with ID ${id}.`\n    }\n    if (global) {\n      errorMessage = `There was an error while saving a version for the global ${typeof global.label === 'string' ? global.label : global.slug}.`\n    }\n    payload.logger.error({ err, msg: errorMessage })\n    return undefined!\n  }\n\n  const max = getVersionsMax(collection || global!)\n\n  if (createNewVersion && max > 0) {\n    await enforceMaxVersions({\n      id,\n      collection,\n      global,\n      max,\n      payload,\n      req,\n    })\n  }\n  if (returning === false) {\n    return null\n  }\n\n  let createdVersion = (result as any).version\n\n  createdVersion = sanitizeInternalFields(createdVersion)\n  createdVersion.id = (result as any).parent\n\n  return createdVersion\n}\n"],"names":["deepCopyObjectSimple","getVersionsMax","sanitizeInternalFields","getQueryDraftsSelect","enforceMaxVersions","saveSnapshot","saveVersion","id","autosave","collection","docWithLocales","draft","global","operation","payload","publishSpecificLocale","req","returning","select","snapshot","result","createNewVersion","now","Date","toISOString","versionData","_status","timestamps","updatedAt","_id","docs","findVersionArgs","limit","pagination","sort","db","findVersions","slug","where","parent","equals","findGlobalVersions","latestVersion","updateVersionArgs","createdAt","latest","version","updateVersion","updateGlobalVersion","createVersionArgs","Boolean","collectionSlug","undefined","globalSlug","publishedLocale","createVersion","createGlobalVersion","data","err","errorMessage","labels","singular","label","logger","error","msg","max","createdVersion"],"mappings":"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"}