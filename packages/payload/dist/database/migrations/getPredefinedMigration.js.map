{"version":3,"sources":["../../../src/database/migrations/getPredefinedMigration.ts"],"sourcesContent":["import fs from 'fs'\nimport path from 'path'\n\nimport type { Payload } from '../../index.js'\nimport type { MigrationTemplateArgs } from '../types.js'\n\nimport { dynamicImport } from '../../utilities/dynamicImport.js'\n\n/**\n * Get predefined migration 'up', 'down' and 'imports'.\n *\n * Supports two import methods:\n * 1. @payloadcms/db-* packages: Loads from adapter's predefinedMigrations folder directly (no package.json export needed)\n *    Example: `--file @payloadcms/db-mongodb/relationships-v2-v3`\n * 2. Any other package/path: Uses dynamic import via package.json exports or absolute file paths\n *    Example: `--file @payloadcms/plugin-seo/someMigration` or `--file /absolute/path/to/migration.ts`\n */\nexport const getPredefinedMigration = async ({\n  dirname,\n  file,\n  migrationName: migrationNameArg,\n  payload,\n}: {\n  dirname: string\n  file?: string\n  migrationName?: string\n  payload: Payload\n}): Promise<MigrationTemplateArgs> => {\n  const importPath = file ?? migrationNameArg\n\n  // Path 1: @payloadcms/db-* adapters - load directly from predefinedMigrations folder\n  // These don't need package.json exports; files are resolved relative to adapter's dirname\n  if (importPath?.startsWith('@payloadcms/db-')) {\n    const migrationName = importPath.split('/').slice(2).join('/')\n    let cleanPath = path.join(dirname, `./predefinedMigrations/${migrationName}`)\n    if (fs.existsSync(`${cleanPath}.mjs`)) {\n      cleanPath = `${cleanPath}.mjs`\n    } else if (fs.existsSync(`${cleanPath}.js`)) {\n      cleanPath = `${cleanPath}.js`\n    } else if (fs.existsSync(`${cleanPath}.ts`)) {\n      // Support .ts in development when running from source\n      cleanPath = `${cleanPath}.ts`\n    } else {\n      payload.logger.error({\n        msg: `Canned migration ${migrationName} not found.`,\n      })\n      process.exit(1)\n    }\n    cleanPath = cleanPath.replaceAll('\\\\', '/')\n    try {\n      const { downSQL, imports, upSQL } = await dynamicImport<MigrationTemplateArgs>(cleanPath)\n      return {\n        downSQL,\n        imports,\n        upSQL,\n      }\n    } catch (err) {\n      payload.logger.error({\n        err,\n        msg: `Error loading predefined migration ${migrationName}`,\n      })\n      process.exit(1)\n    }\n  } else if (importPath) {\n    // Path 2: Any other package or file path - use dynamic import\n    // Supports: package.json exports (e.g. @payloadcms/plugin-seo/migration) or absolute file paths\n    try {\n      const { downSQL, imports, upSQL } = await dynamicImport<MigrationTemplateArgs>(importPath)\n      return {\n        downSQL,\n        imports,\n        upSQL,\n      }\n    } catch (_err) {\n      if (importPath?.includes('/')) {\n        // We can assume that the intent was to import a file, thus we throw an error.\n        throw new Error(`Error importing migration file from ${importPath}`)\n      }\n      // Silently fail. If the migration cannot be imported, it will be created as a blank migration and the import path will be used as the migration name.\n      return {}\n    }\n  }\n  return {}\n}\n"],"names":["fs","path","dynamicImport","getPredefinedMigration","dirname","file","migrationName","migrationNameArg","payload","importPath","startsWith","split","slice","join","cleanPath","existsSync","logger","error","msg","process","exit","replaceAll","downSQL","imports","upSQL","err","_err","includes","Error"],"mappings":"AAAA,OAAOA,QAAQ,KAAI;AACnB,OAAOC,UAAU,OAAM;AAKvB,SAASC,aAAa,QAAQ,mCAAkC;AAEhE;;;;;;;;CAQC,GACD,OAAO,MAAMC,yBAAyB,OAAO,EAC3CC,OAAO,EACPC,IAAI,EACJC,eAAeC,gBAAgB,EAC/BC,OAAO,EAMR;IACC,MAAMC,aAAaJ,QAAQE;IAE3B,qFAAqF;IACrF,0FAA0F;IAC1F,IAAIE,YAAYC,WAAW,oBAAoB;QAC7C,MAAMJ,gBAAgBG,WAAWE,KAAK,CAAC,KAAKC,KAAK,CAAC,GAAGC,IAAI,CAAC;QAC1D,IAAIC,YAAYb,KAAKY,IAAI,CAACT,SAAS,CAAC,uBAAuB,EAAEE,eAAe;QAC5E,IAAIN,GAAGe,UAAU,CAAC,GAAGD,UAAU,IAAI,CAAC,GAAG;YACrCA,YAAY,GAAGA,UAAU,IAAI,CAAC;QAChC,OAAO,IAAId,GAAGe,UAAU,CAAC,GAAGD,UAAU,GAAG,CAAC,GAAG;YAC3CA,YAAY,GAAGA,UAAU,GAAG,CAAC;QAC/B,OAAO,IAAId,GAAGe,UAAU,CAAC,GAAGD,UAAU,GAAG,CAAC,GAAG;YAC3C,sDAAsD;YACtDA,YAAY,GAAGA,UAAU,GAAG,CAAC;QAC/B,OAAO;YACLN,QAAQQ,MAAM,CAACC,KAAK,CAAC;gBACnBC,KAAK,CAAC,iBAAiB,EAAEZ,cAAc,WAAW,CAAC;YACrD;YACAa,QAAQC,IAAI,CAAC;QACf;QACAN,YAAYA,UAAUO,UAAU,CAAC,MAAM;QACvC,IAAI;YACF,MAAM,EAAEC,OAAO,EAAEC,OAAO,EAAEC,KAAK,EAAE,GAAG,MAAMtB,cAAqCY;YAC/E,OAAO;gBACLQ;gBACAC;gBACAC;YACF;QACF,EAAE,OAAOC,KAAK;YACZjB,QAAQQ,MAAM,CAACC,KAAK,CAAC;gBACnBQ;gBACAP,KAAK,CAAC,mCAAmC,EAAEZ,eAAe;YAC5D;YACAa,QAAQC,IAAI,CAAC;QACf;IACF,OAAO,IAAIX,YAAY;QACrB,8DAA8D;QAC9D,gGAAgG;QAChG,IAAI;YACF,MAAM,EAAEa,OAAO,EAAEC,OAAO,EAAEC,KAAK,EAAE,GAAG,MAAMtB,cAAqCO;YAC/E,OAAO;gBACLa;gBACAC;gBACAC;YACF;QACF,EAAE,OAAOE,MAAM;YACb,IAAIjB,YAAYkB,SAAS,MAAM;gBAC7B,8EAA8E;gBAC9E,MAAM,IAAIC,MAAM,CAAC,oCAAoC,EAAEnB,YAAY;YACrE;YACA,sJAAsJ;YACtJ,OAAO,CAAC;QACV;IACF;IACA,OAAO,CAAC;AACV,EAAC"}