{"version":3,"sources":["../../../src/database/migrations/readMigrationFiles.ts"],"sourcesContent":["import fs from 'fs'\nimport path from 'path'\n\nimport type { Payload } from '../../index.js'\nimport type { Migration } from '../types.js'\n\nimport { dynamicImport } from '../../utilities/dynamicImport.js'\n\n/**\n * Read the migration files from disk\n */\nexport const readMigrationFiles = async ({\n  payload,\n}: {\n  payload: Payload\n}): Promise<Migration[]> => {\n  if (!fs.existsSync(payload.db.migrationDir)) {\n    payload.logger.error({\n      msg: `No migration directory found at ${payload.db.migrationDir}`,\n    })\n    return []\n  }\n\n  payload.logger.info({\n    msg: `Reading migration files from ${payload.db.migrationDir}`,\n  })\n\n  const files = fs\n    .readdirSync(payload.db.migrationDir)\n    .sort()\n    .filter((f) => {\n      return (f.endsWith('.ts') || f.endsWith('.js')) && f !== 'index.js' && f !== 'index.ts'\n    })\n    .map((file) => {\n      return path.resolve(payload.db.migrationDir, file)\n    })\n\n  return Promise.all(\n    files.map(async (filePath) => {\n      const migrationModule = await dynamicImport<\n        | {\n            default: Migration\n          }\n        | Migration\n      >(filePath)\n      const migration = 'default' in migrationModule ? migrationModule.default : migrationModule\n\n      const result: Migration = {\n        name: path.basename(filePath).split('.')[0]!,\n        down: migration.down,\n        up: migration.up,\n      }\n\n      return result\n    }),\n  )\n}\n"],"names":["fs","path","dynamicImport","readMigrationFiles","payload","existsSync","db","migrationDir","logger","error","msg","info","files","readdirSync","sort","filter","f","endsWith","map","file","resolve","Promise","all","filePath","migrationModule","migration","default","result","name","basename","split","down","up"],"mappings":"AAAA,OAAOA,QAAQ,KAAI;AACnB,OAAOC,UAAU,OAAM;AAKvB,SAASC,aAAa,QAAQ,mCAAkC;AAEhE;;CAEC,GACD,OAAO,MAAMC,qBAAqB,OAAO,EACvCC,OAAO,EAGR;IACC,IAAI,CAACJ,GAAGK,UAAU,CAACD,QAAQE,EAAE,CAACC,YAAY,GAAG;QAC3CH,QAAQI,MAAM,CAACC,KAAK,CAAC;YACnBC,KAAK,CAAC,gCAAgC,EAAEN,QAAQE,EAAE,CAACC,YAAY,EAAE;QACnE;QACA,OAAO,EAAE;IACX;IAEAH,QAAQI,MAAM,CAACG,IAAI,CAAC;QAClBD,KAAK,CAAC,6BAA6B,EAAEN,QAAQE,EAAE,CAACC,YAAY,EAAE;IAChE;IAEA,MAAMK,QAAQZ,GACXa,WAAW,CAACT,QAAQE,EAAE,CAACC,YAAY,EACnCO,IAAI,GACJC,MAAM,CAAC,CAACC;QACP,OAAO,AAACA,CAAAA,EAAEC,QAAQ,CAAC,UAAUD,EAAEC,QAAQ,CAAC,MAAK,KAAMD,MAAM,cAAcA,MAAM;IAC/E,GACCE,GAAG,CAAC,CAACC;QACJ,OAAOlB,KAAKmB,OAAO,CAAChB,QAAQE,EAAE,CAACC,YAAY,EAAEY;IAC/C;IAEF,OAAOE,QAAQC,GAAG,CAChBV,MAAMM,GAAG,CAAC,OAAOK;QACf,MAAMC,kBAAkB,MAAMtB,cAK5BqB;QACF,MAAME,YAAY,aAAaD,kBAAkBA,gBAAgBE,OAAO,GAAGF;QAE3E,MAAMG,SAAoB;YACxBC,MAAM3B,KAAK4B,QAAQ,CAACN,UAAUO,KAAK,CAAC,IAAI,CAAC,EAAE;YAC3CC,MAAMN,UAAUM,IAAI;YACpBC,IAAIP,UAAUO,EAAE;QAClB;QAEA,OAAOL;IACT;AAEJ,EAAC"}