{"version":3,"sources":["../../src/utilities/filterDataToSelectedLocales.ts"],"sourcesContent":["import type { Block, Field, FlattenedBlock } from '../fields/config/types.js'\nimport type { SanitizedConfig } from '../index.js'\nimport type { JsonObject } from '../types/index.js'\n\nimport { fieldAffectsData, fieldShouldBeLocalized, tabHasName } from '../fields/config/types.js'\n\ntype FilterDataToSelectedLocalesArgs = {\n  configBlockReferences: SanitizedConfig['blocks']\n  docWithLocales: JsonObject\n  fields: Field[]\n  parentIsLocalized?: boolean\n  selectedLocales: string[]\n}\n\n/**\n * Filters localized field data to only include specified locales.\n * For non-localized fields, returns all data as-is.\n * For localized fields, if selectedLocales is provided, returns only those locales.\n * If selectedLocales is not provided and field is localized, returns all locales.\n */\nexport function filterDataToSelectedLocales({\n  configBlockReferences,\n  docWithLocales,\n  fields,\n  parentIsLocalized = false,\n  selectedLocales,\n}: FilterDataToSelectedLocalesArgs): JsonObject {\n  if (!docWithLocales || typeof docWithLocales !== 'object') {\n    return docWithLocales\n  }\n\n  const result: JsonObject = {}\n\n  for (const field of fields) {\n    if (fieldAffectsData(field)) {\n      const fieldIsLocalized = fieldShouldBeLocalized({ field, parentIsLocalized })\n\n      switch (field.type) {\n        case 'array': {\n          if (Array.isArray(docWithLocales[field.name])) {\n            result[field.name] = docWithLocales[field.name].map((item: JsonObject) =>\n              filterDataToSelectedLocales({\n                configBlockReferences,\n                docWithLocales: item,\n                fields: field.fields,\n                parentIsLocalized: fieldIsLocalized,\n                selectedLocales,\n              }),\n            )\n          }\n          break\n        }\n\n        case 'blocks': {\n          if (field.name in docWithLocales && Array.isArray(docWithLocales[field.name])) {\n            result[field.name] = docWithLocales[field.name].map((blockData: JsonObject) => {\n              let block: Block | FlattenedBlock | undefined\n              if (configBlockReferences && field.blockReferences) {\n                for (const blockOrReference of field.blockReferences) {\n                  if (typeof blockOrReference === 'string') {\n                    block = configBlockReferences.find((b) => b.slug === blockData.blockType)\n                  } else {\n                    block = blockOrReference\n                  }\n                }\n              } else if (field.blocks) {\n                block = field.blocks.find((b) => b.slug === blockData.blockType)\n              }\n\n              if (block) {\n                return filterDataToSelectedLocales({\n                  configBlockReferences,\n                  docWithLocales: blockData,\n                  fields: block?.fields || [],\n                  parentIsLocalized: fieldIsLocalized,\n                  selectedLocales,\n                })\n              }\n\n              return blockData\n            })\n          }\n          break\n        }\n\n        case 'group': {\n          // Named groups create a nested data structure\n          if (\n            fieldAffectsData(field) &&\n            field.name in docWithLocales &&\n            typeof docWithLocales[field.name] === 'object'\n          ) {\n            result[field.name] = filterDataToSelectedLocales({\n              configBlockReferences,\n              docWithLocales: docWithLocales[field.name] as JsonObject,\n              fields: field.fields,\n              parentIsLocalized: fieldIsLocalized,\n              selectedLocales,\n            })\n          } else {\n            // Unnamed groups pass through the same data level\n            const nestedResult = filterDataToSelectedLocales({\n              configBlockReferences,\n              docWithLocales,\n              fields: field.fields,\n              parentIsLocalized,\n              selectedLocales,\n            })\n            Object.assign(result, nestedResult)\n          }\n          break\n        }\n\n        default: {\n          // For all other data-affecting fields (text, number, select, etc.)\n          if (field.name in docWithLocales) {\n            const value = docWithLocales[field.name]\n\n            // If the field is localized and has locale data\n            if (fieldIsLocalized && value && typeof value === 'object' && !Array.isArray(value)) {\n              // If selectedLocales is provided, filter to only those locales\n              if (selectedLocales && selectedLocales.length > 0) {\n                const filtered: Record<string, unknown> = {}\n                for (const locale of selectedLocales) {\n                  if (locale in value) {\n                    filtered[locale] = value[locale]\n                  }\n                }\n                if (Object.keys(filtered).length > 0) {\n                  result[field.name] = filtered\n                }\n              } else {\n                // If no selectedLocales, include all locales\n                result[field.name] = value\n              }\n            } else {\n              // Non-localized field or non-object value\n              result[field.name] = value\n            }\n          }\n          break\n        }\n      }\n    } else {\n      // Layout-only fields that don't affect data structure\n      switch (field.type) {\n        case 'collapsible':\n        case 'row': {\n          // These pass through the same data level\n          const nestedResult = filterDataToSelectedLocales({\n            configBlockReferences,\n            docWithLocales,\n            fields: field.fields,\n            parentIsLocalized,\n            selectedLocales,\n          })\n          Object.assign(result, nestedResult)\n          break\n        }\n\n        case 'tabs': {\n          for (const tab of field.tabs) {\n            if (tabHasName(tab)) {\n              // Named tabs create a nested data structure\n              if (tab.name in docWithLocales && typeof docWithLocales[tab.name] === 'object') {\n                result[tab.name] = filterDataToSelectedLocales({\n                  configBlockReferences,\n                  docWithLocales: docWithLocales[tab.name],\n                  fields: tab.fields,\n                  parentIsLocalized,\n                  selectedLocales,\n                })\n              }\n            } else {\n              // Unnamed tabs pass through the same data level\n              const nestedResult = filterDataToSelectedLocales({\n                configBlockReferences,\n                docWithLocales,\n                fields: tab.fields,\n                parentIsLocalized,\n                selectedLocales,\n              })\n              Object.assign(result, nestedResult)\n            }\n          }\n          break\n        }\n      }\n    }\n  }\n\n  return result\n}\n"],"names":["fieldAffectsData","fieldShouldBeLocalized","tabHasName","filterDataToSelectedLocales","configBlockReferences","docWithLocales","fields","parentIsLocalized","selectedLocales","result","field","fieldIsLocalized","type","Array","isArray","name","map","item","blockData","block","blockReferences","blockOrReference","find","b","slug","blockType","blocks","nestedResult","Object","assign","value","length","filtered","locale","keys","tab","tabs"],"mappings":"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"}