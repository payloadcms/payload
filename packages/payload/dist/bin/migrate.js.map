{"version":3,"sources":["../../src/bin/migrate.ts"],"sourcesContent":["import type { ParsedArgs } from 'minimist'\n\nimport type { SanitizedConfig } from '../config/types.js'\n\nimport payload from '../index.js'\nimport { prettySyncLoggerDestination } from '../utilities/logger.js'\n\n/**\n * The default logger's options did not allow for forcing sync logging\n * Using these options, to force both pretty print and sync logging\n */\nconst prettySyncLogger = {\n  loggerDestination: prettySyncLoggerDestination,\n  loggerOptions: {},\n}\n\nexport const availableCommands = [\n  'migrate',\n  'migrate:create',\n  'migrate:down',\n  'migrate:refresh',\n  'migrate:reset',\n  'migrate:status',\n  'migrate:fresh',\n]\n\nconst availableCommandsMsg = `Available commands: ${availableCommands.join(', ')}`\n\ntype Args = {\n  config: SanitizedConfig\n  /**\n   * Override the migration directory. Useful for testing when the CWD differs\n   * from where the test config expects migrations to be stored.\n   */\n  migrationDir?: string\n  parsedArgs: ParsedArgs\n}\n\nexport const migrate = async ({ config, migrationDir, parsedArgs }: Args): Promise<void> => {\n  const { _: args, file, forceAcceptWarning: forceAcceptFromProps, help } = parsedArgs\n\n  const formattedArgs = Object.keys(parsedArgs)\n    .map((key) => {\n      const formattedKey = key.replace(/^[-_]+/, '')\n      if (!formattedKey) {\n        return null\n      }\n\n      return formattedKey\n        .split('-')\n        .map((word, index) =>\n          index === 0 ? word.toLowerCase() : word.charAt(0).toUpperCase() + word.slice(1),\n        )\n        .join('')\n    })\n    .filter(Boolean)\n\n  const forceAcceptWarning = forceAcceptFromProps || formattedArgs.includes('forceAcceptWarning')\n  const skipEmpty = formattedArgs.includes('skipEmpty')\n\n  if (help) {\n    // eslint-disable-next-line no-console\n    console.log(`\\n\\n${availableCommandsMsg}\\n`) // Avoid having to init payload to get the logger\n    process.exit(0)\n  }\n\n  process.env.PAYLOAD_MIGRATING = 'true'\n\n  // Barebones instance to access database adapter\n  await payload.init({\n    config,\n    disableDBConnect: args[0] === 'migrate:create',\n    disableOnInit: true,\n    ...prettySyncLogger,\n  })\n\n  const adapter = payload.db\n\n  if (!adapter) {\n    throw new Error('No database adapter found')\n  }\n\n  // Override migrationDir if provided (useful for testing)\n  if (migrationDir) {\n    adapter.migrationDir = migrationDir\n  }\n\n  if (!args.length) {\n    payload.logger.error({\n      msg: `No migration command provided. ${availableCommandsMsg}`,\n    })\n    process.exit(1)\n  }\n\n  switch (args[0]) {\n    case 'migrate':\n      await adapter.migrate()\n      break\n    case 'migrate:create':\n      try {\n        await adapter.createMigration({\n          file,\n          forceAcceptWarning,\n          migrationName: args[1],\n          payload,\n          skipEmpty,\n        })\n      } catch (err) {\n        const error = err instanceof Error ? err.message : 'Unknown error'\n        throw new Error(`Error creating migration: ${error}`)\n      }\n      break\n    case 'migrate:down':\n      await adapter.migrateDown()\n      break\n    case 'migrate:fresh':\n      await adapter.migrateFresh({ forceAcceptWarning })\n      break\n    case 'migrate:refresh':\n      await adapter.migrateRefresh()\n      break\n    case 'migrate:reset':\n      await adapter.migrateReset()\n      break\n    case 'migrate:status':\n      await adapter.migrateStatus()\n      break\n\n    default:\n      payload.logger.error({\n        msg: `Unknown migration command: ${args[0]}. ${availableCommandsMsg}`,\n      })\n      process.exit(1)\n  }\n\n  payload.logger.info('Done.')\n}\n"],"names":["payload","prettySyncLoggerDestination","prettySyncLogger","loggerDestination","loggerOptions","availableCommands","availableCommandsMsg","join","migrate","config","migrationDir","parsedArgs","_","args","file","forceAcceptWarning","forceAcceptFromProps","help","formattedArgs","Object","keys","map","key","formattedKey","replace","split","word","index","toLowerCase","charAt","toUpperCase","slice","filter","Boolean","includes","skipEmpty","console","log","process","exit","env","PAYLOAD_MIGRATING","init","disableDBConnect","disableOnInit","adapter","db","Error","length","logger","error","msg","createMigration","migrationName","err","message","migrateDown","migrateFresh","migrateRefresh","migrateReset","migrateStatus","info"],"mappings":"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"}