{"version":3,"sources":["../../../../src/collections/operations/utilities/update.ts"],"sourcesContent":["import type { DeepPartial } from 'ts-essentials'\n\nimport type { Args } from '../../../fields/hooks/beforeChange/index.js'\nimport type {\n  AccessResult,\n  CollectionSlug,\n  FileToSave,\n  SanitizedConfig,\n  TypedFallbackLocale,\n} from '../../../index.js'\nimport type {\n  JsonObject,\n  Payload,\n  PayloadRequest,\n  PopulateType,\n  SelectType,\n  TransformCollectionWithSelect,\n} from '../../../types/index.js'\nimport type {\n  DataFromCollectionSlug,\n  SanitizedCollectionConfig,\n  SelectFromCollectionSlug,\n  TypeWithID,\n} from '../../config/types.js'\n\nimport { ensureUsernameOrEmail } from '../../../auth/ensureUsernameOrEmail.js'\nimport { generatePasswordSaltHash } from '../../../auth/strategies/local/generatePasswordSaltHash.js'\nimport { combineQueries } from '../../../database/combineQueries.js'\nimport { afterChange } from '../../../fields/hooks/afterChange/index.js'\nimport { afterRead } from '../../../fields/hooks/afterRead/index.js'\nimport { beforeChange } from '../../../fields/hooks/beforeChange/index.js'\nimport { beforeValidate } from '../../../fields/hooks/beforeValidate/index.js'\nimport { deepCopyObjectSimple, saveVersion } from '../../../index.js'\nimport { deleteAssociatedFiles } from '../../../uploads/deleteAssociatedFiles.js'\nimport { uploadFiles } from '../../../uploads/uploadFiles.js'\nimport { checkDocumentLockStatus } from '../../../utilities/checkDocumentLockStatus.js'\nimport {\n  hasDraftsEnabled,\n  hasDraftValidationEnabled,\n} from '../../../utilities/getVersionsConfig.js'\nimport { getLatestCollectionVersion } from '../../../versions/getLatestCollectionVersion.js'\n\nexport type SharedUpdateDocumentArgs<TSlug extends CollectionSlug> = {\n  accessResults: AccessResult\n  autosave: boolean\n  collectionConfig: SanitizedCollectionConfig\n  config: SanitizedConfig\n  data: DeepPartial<DataFromCollectionSlug<TSlug>>\n  depth: number\n  docWithLocales: JsonObject & TypeWithID\n  draftArg: boolean\n  fallbackLocale: TypedFallbackLocale\n  filesToUpload: FileToSave[]\n  id: number | string\n  locale: string\n  overrideAccess: boolean\n  overrideLock: boolean\n  payload: Payload\n  populate?: PopulateType\n  publishSpecificLocale?: string\n  req: PayloadRequest\n  select: SelectType\n  showHiddenFields: boolean\n}\n\n/**\n * This function is used to update a document in the DB and return the result.\n *\n * It runs the following hooks in order:\n * - beforeValidate - Fields\n * - beforeValidate - Collection\n * - beforeChange - Collection\n * - beforeChange - Fields\n * - afterRead - Fields\n * - afterRead - Collection\n * - afterChange - Fields\n * - afterChange - Collection\n */\nexport const updateDocument = async <\n  TSlug extends CollectionSlug,\n  TSelect extends SelectFromCollectionSlug<TSlug> = SelectType,\n>({\n  id,\n  accessResults,\n  autosave,\n  collectionConfig,\n  config,\n  data,\n  depth,\n  docWithLocales,\n  draftArg,\n  fallbackLocale,\n  filesToUpload,\n  locale,\n  overrideAccess,\n  overrideLock,\n  payload,\n  populate,\n  publishSpecificLocale,\n  req,\n  select,\n  showHiddenFields,\n}: SharedUpdateDocumentArgs<TSlug>): Promise<TransformCollectionWithSelect<TSlug, TSelect>> => {\n  const password = data?.password\n  const isSavingDraft =\n    Boolean(draftArg && hasDraftsEnabled(collectionConfig)) && data._status !== 'published'\n  const shouldSavePassword = Boolean(\n    password &&\n      collectionConfig.auth &&\n      (!collectionConfig.auth.disableLocalStrategy ||\n        (typeof collectionConfig.auth.disableLocalStrategy === 'object' &&\n          collectionConfig.auth.disableLocalStrategy.enableFields)) &&\n      !isSavingDraft,\n  )\n\n  // /////////////////////////////////////\n  // Handle potentially locked documents\n  // /////////////////////////////////////\n\n  await checkDocumentLockStatus({\n    id,\n    collectionSlug: collectionConfig.slug,\n    lockErrorMessage: `Document with ID ${id} is currently locked by another user and cannot be updated.`,\n    overrideLock,\n    req,\n  })\n\n  const originalDoc = await afterRead({\n    collection: collectionConfig,\n    context: req.context,\n    depth: 0,\n    doc: deepCopyObjectSimple(docWithLocales),\n    draft: draftArg,\n    fallbackLocale: id ? null : fallbackLocale,\n    global: null,\n    locale,\n    overrideAccess: true,\n    req,\n    showHiddenFields: true,\n  })\n\n  const isRestoringDraftFromTrash = Boolean(originalDoc?.deletedAt) && data?._status !== 'published'\n\n  if (collectionConfig.auth) {\n    ensureUsernameOrEmail<TSlug>({\n      authOptions: collectionConfig.auth,\n      collectionSlug: collectionConfig.slug,\n      data,\n      operation: 'update',\n      originalDoc,\n      req,\n    })\n  }\n\n  // /////////////////////////////////////\n  // Delete any associated files\n  // /////////////////////////////////////\n\n  await deleteAssociatedFiles({\n    collectionConfig,\n    config,\n    doc: docWithLocales,\n    files: filesToUpload,\n    overrideDelete: false,\n    req,\n  })\n\n  // /////////////////////////////////////\n  // beforeValidate - Fields\n  // /////////////////////////////////////\n\n  data = await beforeValidate<DeepPartial<DataFromCollectionSlug<TSlug>>>({\n    id,\n    collection: collectionConfig,\n    context: req.context,\n    data,\n    doc: originalDoc,\n    global: null,\n    operation: 'update',\n    overrideAccess,\n    req,\n  })\n\n  // /////////////////////////////////////\n  // beforeValidate - Collection\n  // /////////////////////////////////////\n\n  if (collectionConfig.hooks?.beforeValidate?.length) {\n    for (const hook of collectionConfig.hooks.beforeValidate) {\n      data =\n        (await hook({\n          collection: collectionConfig,\n          context: req.context,\n          data,\n          operation: 'update',\n          originalDoc,\n          req,\n        })) || data\n    }\n  }\n\n  // /////////////////////////////////////\n  // Write files to local storage\n  // /////////////////////////////////////\n\n  if (!collectionConfig.upload.disableLocalStorage) {\n    await uploadFiles(payload, filesToUpload, req)\n  }\n\n  // /////////////////////////////////////\n  // beforeChange - Collection\n  // /////////////////////////////////////\n\n  if (collectionConfig.hooks?.beforeChange?.length) {\n    for (const hook of collectionConfig.hooks.beforeChange) {\n      data =\n        (await hook({\n          collection: collectionConfig,\n          context: req.context,\n          data,\n          operation: 'update',\n          originalDoc,\n          req,\n        })) || data\n    }\n  }\n\n  // /////////////////////////////////////\n  // beforeChange - Fields\n  // /////////////////////////////////////\n\n  const beforeChangeArgs: Args<DataFromCollectionSlug<TSlug>> = {\n    id,\n    collection: collectionConfig,\n    context: req.context,\n    data: { ...data, id },\n    doc: originalDoc,\n    docWithLocales,\n    global: null,\n    operation: 'update',\n    overrideAccess,\n    req,\n    skipValidation:\n      // only skip validation for drafts when draft validation is false\n      (isSavingDraft && !hasDraftValidationEnabled(collectionConfig)) ||\n      // Skip validation for trash operations since they're just metadata updates\n      (collectionConfig.trash && (Boolean(data?.deletedAt) || isRestoringDraftFromTrash)),\n  }\n\n  let result: JsonObject = await beforeChange(beforeChangeArgs)\n  let snapshotToSave: JsonObject | undefined\n\n  if (config.localization && collectionConfig.versions) {\n    if (publishSpecificLocale) {\n      snapshotToSave = deepCopyObjectSimple(result)\n\n      // the published data to save to the main document\n      result = await beforeChange({\n        ...beforeChangeArgs,\n        docWithLocales:\n          (await getLatestCollectionVersion({\n            id,\n            config: collectionConfig,\n            payload,\n            published: true,\n            query: {\n              collection: collectionConfig.slug,\n              locale,\n              req,\n              where: combineQueries({ id: { equals: id } }, accessResults),\n            },\n            req,\n          })) || {},\n      })\n    }\n  }\n\n  // /////////////////////////////////////\n  // Handle potential password update\n  // /////////////////////////////////////\n\n  const dataToUpdate: JsonObject = { ...result }\n\n  if (shouldSavePassword && typeof password === 'string') {\n    const { hash, salt } = await generatePasswordSaltHash({\n      collection: collectionConfig,\n      password,\n      req,\n    })\n    dataToUpdate.salt = salt\n    dataToUpdate.hash = hash\n    delete dataToUpdate.password\n    delete data.password\n  }\n\n  // /////////////////////////////////////\n  // Update\n  // /////////////////////////////////////\n\n  if (!isSavingDraft) {\n    // Ensure updatedAt date is always updated\n    dataToUpdate.updatedAt = new Date().toISOString()\n    result = await req.payload.db.updateOne({\n      id,\n      collection: collectionConfig.slug,\n      data: dataToUpdate,\n      locale,\n      req,\n    })\n  }\n\n  // /////////////////////////////////////\n  // Create version\n  // /////////////////////////////////////\n\n  if (collectionConfig.versions) {\n    result = await saveVersion({\n      id,\n      autosave,\n      collection: collectionConfig,\n      docWithLocales: result,\n      draft: isSavingDraft,\n      operation: 'update',\n      payload,\n      publishSpecificLocale,\n      req,\n      snapshot: snapshotToSave,\n    })\n  }\n\n  // /////////////////////////////////////\n  // afterRead - Fields\n  // /////////////////////////////////////\n\n  result = await afterRead({\n    collection: collectionConfig,\n    context: req.context,\n    depth,\n    doc: result,\n    draft: draftArg,\n    fallbackLocale,\n    global: null,\n    locale,\n    overrideAccess,\n    populate,\n    req,\n    select,\n    showHiddenFields,\n  })\n\n  // /////////////////////////////////////\n  // afterRead - Collection\n  // /////////////////////////////////////\n\n  if (collectionConfig.hooks?.afterRead?.length) {\n    for (const hook of collectionConfig.hooks.afterRead) {\n      result =\n        (await hook({\n          collection: collectionConfig,\n          context: req.context,\n          doc: result,\n          req,\n        })) || result\n    }\n  }\n\n  // /////////////////////////////////////\n  // afterChange - Fields\n  // /////////////////////////////////////\n\n  result = await afterChange({\n    collection: collectionConfig,\n    context: req.context,\n    data,\n    doc: result,\n    global: null,\n    operation: 'update',\n    previousDoc: originalDoc,\n    req,\n  })\n\n  // /////////////////////////////////////\n  // afterChange - Collection\n  // /////////////////////////////////////\n\n  if (collectionConfig.hooks?.afterChange?.length) {\n    for (const hook of collectionConfig.hooks.afterChange) {\n      result =\n        (await hook({\n          collection: collectionConfig,\n          context: req.context,\n          data,\n          doc: result,\n          operation: 'update',\n          previousDoc: originalDoc,\n          req,\n        })) || result\n    }\n  }\n\n  return result as TransformCollectionWithSelect<TSlug, TSelect>\n}\n"],"names":["ensureUsernameOrEmail","generatePasswordSaltHash","combineQueries","afterChange","afterRead","beforeChange","beforeValidate","deepCopyObjectSimple","saveVersion","deleteAssociatedFiles","uploadFiles","checkDocumentLockStatus","hasDraftsEnabled","hasDraftValidationEnabled","getLatestCollectionVersion","updateDocument","id","accessResults","autosave","collectionConfig","config","data","depth","docWithLocales","draftArg","fallbackLocale","filesToUpload","locale","overrideAccess","overrideLock","payload","populate","publishSpecificLocale","req","select","showHiddenFields","password","isSavingDraft","Boolean","_status","shouldSavePassword","auth","disableLocalStrategy","enableFields","collectionSlug","slug","lockErrorMessage","originalDoc","collection","context","doc","draft","global","isRestoringDraftFromTrash","deletedAt","authOptions","operation","files","overrideDelete","hooks","length","hook","upload","disableLocalStorage","beforeChangeArgs","skipValidation","trash","result","snapshotToSave","localization","versions","published","query","where","equals","dataToUpdate","hash","salt","updatedAt","Date","toISOString","db","updateOne","snapshot","previousDoc"],"mappings":"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"}