{"version":3,"sources":["../../../src/collections/operations/findByID.ts"],"sourcesContent":["import type { FindOneArgs } from '../../database/types.js'\nimport type { CollectionSlug, JoinQuery } from '../../index.js'\nimport type {\n  ApplyDisableErrors,\n  JsonObject,\n  PayloadRequest,\n  PopulateType,\n  SelectType,\n  TransformCollectionWithSelect,\n} from '../../types/index.js'\nimport type {\n  Collection,\n  DataFromCollectionSlug,\n  SelectFromCollectionSlug,\n  TypeWithID,\n} from '../config/types.js'\n\nimport { executeAccess } from '../../auth/executeAccess.js'\nimport { combineQueries } from '../../database/combineQueries.js'\nimport { sanitizeJoinQuery } from '../../database/sanitizeJoinQuery.js'\nimport { sanitizeWhereQuery } from '../../database/sanitizeWhereQuery.js'\nimport { NotFound } from '../../errors/index.js'\nimport { afterRead, type AfterReadArgs } from '../../fields/hooks/afterRead/index.js'\nimport { validateQueryPaths } from '../../index.js'\nimport { lockedDocumentsCollectionSlug } from '../../locked-documents/config.js'\nimport { appendNonTrashedFilter } from '../../utilities/appendNonTrashedFilter.js'\nimport { hasDraftsEnabled } from '../../utilities/getVersionsConfig.js'\nimport { killTransaction } from '../../utilities/killTransaction.js'\nimport { sanitizeSelect } from '../../utilities/sanitizeSelect.js'\nimport { replaceWithDraftIfAvailable } from '../../versions/drafts/replaceWithDraftIfAvailable.js'\nimport { buildAfterOperation } from './utilities/buildAfterOperation.js'\nimport { buildBeforeOperation } from './utilities/buildBeforeOperation.js'\n\nexport type FindByIDArgs = {\n  collection: Collection\n  currentDepth?: number\n  /**\n   * You may pass the document data directly which will skip the `db.findOne` database query.\n   * This is useful if you want to use this endpoint solely for running hooks and populating data.\n   */\n  data?: Record<string, unknown>\n  depth?: number\n  disableErrors?: boolean\n  draft?: boolean\n  id: number | string\n  includeLockStatus?: boolean\n  joins?: JoinQuery\n  overrideAccess?: boolean\n  populate?: PopulateType\n  req: PayloadRequest\n  select?: SelectType\n  showHiddenFields?: boolean\n  trash?: boolean\n} & Pick<AfterReadArgs<JsonObject>, 'flattenLocales'>\n\nexport const findByIDOperation = async <\n  TSlug extends CollectionSlug,\n  TDisableErrors extends boolean,\n  TSelect extends SelectFromCollectionSlug<TSlug>,\n>(\n  incomingArgs: FindByIDArgs,\n): Promise<ApplyDisableErrors<TransformCollectionWithSelect<TSlug, TSelect>, TDisableErrors>> => {\n  let args = incomingArgs\n\n  try {\n    // /////////////////////////////////////\n    // beforeOperation - Collection\n    // /////////////////////////////////////\n\n    args = await buildBeforeOperation({\n      args,\n      collection: args.collection.config,\n      operation: 'read',\n    })\n\n    const {\n      id,\n      collection: { config: collectionConfig },\n      currentDepth,\n      depth,\n      disableErrors,\n      draft: replaceWithVersion = false,\n      flattenLocales,\n      includeLockStatus: includeLockStatusFromArgs,\n      joins,\n      overrideAccess = false,\n      populate,\n      req: { fallbackLocale, locale, t },\n      req,\n      select: incomingSelect,\n      showHiddenFields,\n      trash = false,\n    } = args\n\n    const includeLockStatus =\n      includeLockStatusFromArgs && req.payload.collections?.[lockedDocumentsCollectionSlug]\n\n    const select = sanitizeSelect({\n      fields: collectionConfig.flattenedFields,\n      forceSelect: collectionConfig.forceSelect,\n      select: incomingSelect,\n    })\n\n    // /////////////////////////////////////\n    // Access\n    // /////////////////////////////////////\n\n    const accessResult = !overrideAccess\n      ? await executeAccess({ id, disableErrors, req }, collectionConfig.access.read)\n      : true\n\n    // If errors are disabled, and access returns false, return null\n    if (accessResult === false) {\n      return null!\n    }\n\n    const where = { id: { equals: id } }\n\n    let fullWhere = combineQueries(where, accessResult)\n\n    // Exclude trashed documents when trash: false\n    fullWhere = appendNonTrashedFilter({\n      enableTrash: collectionConfig.trash,\n      trash,\n      where: fullWhere,\n    })\n\n    sanitizeWhereQuery({\n      fields: collectionConfig.flattenedFields,\n      payload: args.req.payload,\n      where: fullWhere,\n    })\n\n    const sanitizedJoins = await sanitizeJoinQuery({\n      collectionConfig,\n      joins,\n      overrideAccess,\n      req,\n    })\n\n    // execute only if there's a custom ID and potentially overwriten access on id\n    if (req.payload.collections[collectionConfig.slug]!.customIDType) {\n      await validateQueryPaths({\n        collectionConfig,\n        overrideAccess,\n        req,\n        where,\n      })\n    }\n\n    // /////////////////////////////////////\n    // Find by ID\n    // /////////////////////////////////////\n\n    const findOneArgs: FindOneArgs = {\n      collection: collectionConfig.slug,\n      draftsEnabled: replaceWithVersion,\n      joins: req.payloadAPI === 'GraphQL' ? false : sanitizedJoins,\n      locale: locale!,\n      req: {\n        transactionID: req.transactionID,\n      } as PayloadRequest,\n      select,\n      where: fullWhere,\n    }\n\n    if (!findOneArgs.where?.and?.[0]?.id) {\n      throw new NotFound(t)\n    }\n\n    const docFromDB = await req.payload.db.findOne(findOneArgs)\n\n    if (!docFromDB && !args.data) {\n      if (!disableErrors) {\n        throw new NotFound(req.t)\n      }\n      return null!\n    }\n\n    let result: DataFromCollectionSlug<TSlug> =\n      (args.data as DataFromCollectionSlug<TSlug>) ?? docFromDB!\n\n    // /////////////////////////////////////\n    // Include Lock Status if required\n    // /////////////////////////////////////\n\n    if (includeLockStatus && id) {\n      let lockStatus: (JsonObject & TypeWithID) | null = null\n\n      try {\n        const lockDocumentsProp = collectionConfig?.lockDocuments\n\n        const lockDurationDefault = 300 // Default 5 minutes in seconds\n        const lockDuration =\n          typeof lockDocumentsProp === 'object' ? lockDocumentsProp.duration : lockDurationDefault\n        const lockDurationInMilliseconds = lockDuration * 1000\n\n        const lockedDocument = await req.payload.find({\n          collection: lockedDocumentsCollectionSlug,\n          depth: 1,\n          limit: 1,\n          overrideAccess: false,\n          pagination: false,\n          req,\n          where: {\n            and: [\n              {\n                'document.relationTo': {\n                  equals: collectionConfig.slug,\n                },\n              },\n              {\n                'document.value': {\n                  equals: id,\n                },\n              },\n              // Query where the lock is newer than the current time minus lock time\n              {\n                updatedAt: {\n                  greater_than: new Date(new Date().getTime() - lockDurationInMilliseconds),\n                },\n              },\n            ],\n          },\n        })\n\n        if (lockedDocument && lockedDocument.docs.length > 0) {\n          lockStatus = lockedDocument.docs[0]!\n        }\n      } catch {\n        // swallow error\n      }\n\n      result._isLocked = !!lockStatus\n      result._userEditing = lockStatus?.user?.value ?? null\n    }\n\n    // /////////////////////////////////////\n    // Replace document with draft if available\n    // /////////////////////////////////////\n\n    if (replaceWithVersion && hasDraftsEnabled(collectionConfig)) {\n      result = await replaceWithDraftIfAvailable({\n        accessResult,\n        doc: result,\n        entity: collectionConfig,\n        entityType: 'collection',\n        overrideAccess,\n        req,\n        select,\n      })\n    }\n\n    // /////////////////////////////////////\n    // beforeRead - Collection\n    // /////////////////////////////////////\n\n    if (collectionConfig.hooks?.beforeRead?.length) {\n      for (const hook of collectionConfig.hooks.beforeRead) {\n        result =\n          (await hook({\n            collection: collectionConfig,\n            context: req.context,\n            doc: result,\n            query: findOneArgs.where,\n            req,\n          })) || result\n      }\n    }\n\n    // /////////////////////////////////////\n    // afterRead - Fields\n    // /////////////////////////////////////\n\n    result = await afterRead({\n      collection: collectionConfig,\n      context: req.context,\n      currentDepth,\n      depth: depth!,\n      doc: result,\n      draft: replaceWithVersion,\n      fallbackLocale: fallbackLocale!,\n      flattenLocales,\n      global: null,\n      locale: locale!,\n      overrideAccess,\n      populate,\n      req,\n      select,\n      showHiddenFields: showHiddenFields!,\n    })\n\n    // /////////////////////////////////////\n    // afterRead - Collection\n    // /////////////////////////////////////\n\n    if (collectionConfig.hooks?.afterRead?.length) {\n      for (const hook of collectionConfig.hooks.afterRead) {\n        result =\n          (await hook({\n            collection: collectionConfig,\n            context: req.context,\n            doc: result,\n            query: findOneArgs.where,\n            req,\n          })) || result\n      }\n    }\n\n    // /////////////////////////////////////\n    // afterOperation - Collection\n    // /////////////////////////////////////\n\n    result = await buildAfterOperation({\n      args,\n      collection: collectionConfig,\n      operation: 'findByID',\n      result,\n    })\n\n    // /////////////////////////////////////\n    // Return results\n    // /////////////////////////////////////\n\n    return result as ApplyDisableErrors<\n      TransformCollectionWithSelect<TSlug, TSelect>,\n      TDisableErrors\n    >\n  } catch (error: unknown) {\n    await killTransaction(args.req)\n    throw error\n  }\n}\n"],"names":["executeAccess","combineQueries","sanitizeJoinQuery","sanitizeWhereQuery","NotFound","afterRead","validateQueryPaths","lockedDocumentsCollectionSlug","appendNonTrashedFilter","hasDraftsEnabled","killTransaction","sanitizeSelect","replaceWithDraftIfAvailable","buildAfterOperation","buildBeforeOperation","findByIDOperation","incomingArgs","args","collection","config","operation","id","collectionConfig","currentDepth","depth","disableErrors","draft","replaceWithVersion","flattenLocales","includeLockStatus","includeLockStatusFromArgs","joins","overrideAccess","populate","req","fallbackLocale","locale","t","select","incomingSelect","showHiddenFields","trash","payload","collections","fields","flattenedFields","forceSelect","accessResult","access","read","where","equals","fullWhere","enableTrash","sanitizedJoins","slug","customIDType","findOneArgs","draftsEnabled","payloadAPI","transactionID","and","docFromDB","db","findOne","data","result","lockStatus","lockDocumentsProp","lockDocuments","lockDurationDefault","lockDuration","duration","lockDurationInMilliseconds","lockedDocument","find","limit","pagination","updatedAt","greater_than","Date","getTime","docs","length","_isLocked","_userEditing","user","value","doc","entity","entityType","hooks","beforeRead","hook","context","query","global","error"],"mappings":"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"}