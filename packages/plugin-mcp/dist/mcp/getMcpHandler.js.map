{"version":3,"sources":["../../src/mcp/getMcpHandler.ts"],"sourcesContent":["import type { JSONSchema4 } from 'json-schema'\n\nimport { createMcpHandler } from '@vercel/mcp-adapter'\nimport { join } from 'path'\nimport { APIError, configToJSONSchema, type PayloadRequest, type TypedUser } from 'payload'\n\nimport type { MCPAccessSettings, PluginMCPServerConfig } from '../types.js'\n\nimport { toCamelCase } from '../utils/camelCase.js'\nimport { getEnabledSlugs } from '../utils/getEnabledSlugs.js'\nimport { registerTool } from './registerTool.js'\n\n// Tools\nimport { findGlobalTool } from './tools/global/find.js'\nimport { updateGlobalTool } from './tools/global/update.js'\nimport { createResourceTool } from './tools/resource/create.js'\nimport { deleteResourceTool } from './tools/resource/delete.js'\nimport { findResourceTool } from './tools/resource/find.js'\nimport { updateResourceTool } from './tools/resource/update.js'\n\n// Experimental Tools\n/**\n * @experimental This tools are experimental and may change or be removed in the future.\n */\nimport { authTool } from './tools/auth/auth.js'\nimport { forgotPasswordTool } from './tools/auth/forgotPassword.js'\nimport { loginTool } from './tools/auth/login.js'\nimport { resetPasswordTool } from './tools/auth/resetPassword.js'\nimport { unlockTool } from './tools/auth/unlock.js'\nimport { verifyTool } from './tools/auth/verify.js'\nimport { createCollectionTool } from './tools/collection/create.js'\nimport { deleteCollectionTool } from './tools/collection/delete.js'\nimport { findCollectionTool } from './tools/collection/find.js'\nimport { updateCollectionTool } from './tools/collection/update.js'\nimport { findConfigTool } from './tools/config/find.js'\nimport { updateConfigTool } from './tools/config/update.js'\nimport { createJobTool } from './tools/job/create.js'\nimport { runJobTool } from './tools/job/run.js'\nimport { updateJobTool } from './tools/job/update.js'\n\nexport const getMCPHandler = (\n  pluginOptions: PluginMCPServerConfig,\n  mcpAccessSettings: MCPAccessSettings,\n  req: PayloadRequest,\n) => {\n  const { payload } = req\n  const configSchema = configToJSONSchema(payload.config, payload.db.defaultIDType, req.i18n)\n\n  // Handler wrapper that injects req before the _extra argument\n  const wrapHandler = (handler: (...args: any[]) => any) => {\n    return async (...args: any[]) => {\n      const _extra = args[args.length - 1]\n      const handlerArgs = args.slice(0, -1)\n      return await handler(...handlerArgs, req, _extra)\n    }\n  }\n\n  const payloadToolHandler = (\n    handler: NonNullable<NonNullable<PluginMCPServerConfig['mcp']>['tools']>[number]['handler'],\n  ) => wrapHandler(handler)\n\n  const payloadPromptHandler = (\n    handler: NonNullable<NonNullable<PluginMCPServerConfig['mcp']>['prompts']>[number]['handler'],\n  ) => wrapHandler(handler)\n\n  const payloadResourceHandler = (\n    handler: NonNullable<NonNullable<PluginMCPServerConfig['mcp']>['resources']>[number]['handler'],\n  ) => wrapHandler(handler)\n\n  // User\n  const user = mcpAccessSettings.user\n\n  // MCP Server and Handler Options\n  const MCPOptions = pluginOptions.mcp || {}\n  const customMCPTools = MCPOptions.tools || []\n  const customMCPPrompts = MCPOptions.prompts || []\n  const customMCPResources = MCPOptions.resources || []\n  const MCPHandlerOptions = MCPOptions.handlerOptions || {}\n  const serverOptions = MCPOptions.serverOptions || {}\n  const useVerboseLogs = MCPHandlerOptions.verboseLogs ?? false\n\n  // Experimental MCP Tool Requirements\n  const isDevelopment = process.env.NODE_ENV === 'development'\n  const experimentalTools: NonNullable<PluginMCPServerConfig['experimental']>['tools'] =\n    pluginOptions?.experimental?.tools || {}\n  const collectionsPluginConfig = pluginOptions.collections || {}\n  const globalsPluginConfig = pluginOptions.globals || {}\n  const collectionsDirPath =\n    experimentalTools && experimentalTools.collections?.collectionsDirPath\n      ? experimentalTools.collections.collectionsDirPath\n      : join(process.cwd(), 'src/collections')\n  const configFilePath =\n    experimentalTools && experimentalTools.config?.configFilePath\n      ? experimentalTools.config.configFilePath\n      : join(process.cwd(), 'src/payload.config.ts')\n  const jobsDirPath =\n    experimentalTools && experimentalTools.jobs?.jobsDirPath\n      ? experimentalTools.jobs.jobsDirPath\n      : join(process.cwd(), 'src/jobs')\n\n  try {\n    return createMcpHandler(\n      (server) => {\n        // Get enabled collections\n        const enabledCollectionSlugs = getEnabledSlugs(collectionsPluginConfig, 'collection')\n\n        // Collection Operation Tools\n        enabledCollectionSlugs.forEach((enabledCollectionSlug) => {\n          try {\n            const schema = configSchema.definitions?.[enabledCollectionSlug] as JSONSchema4\n\n            const toolCapabilities = mcpAccessSettings?.[\n              `${toCamelCase(enabledCollectionSlug)}`\n            ] as Record<string, unknown>\n            const allowCreate: boolean | undefined = toolCapabilities?.create as boolean\n            const allowUpdate: boolean | undefined = toolCapabilities?.update as boolean\n            const allowFind: boolean | undefined = toolCapabilities?.find as boolean\n            const allowDelete: boolean | undefined = toolCapabilities?.delete as boolean\n\n            if (allowCreate) {\n              registerTool(\n                allowCreate,\n                `Create ${enabledCollectionSlug}`,\n                () =>\n                  createResourceTool(\n                    server,\n                    req,\n                    user,\n                    useVerboseLogs,\n                    enabledCollectionSlug,\n                    collectionsPluginConfig,\n                    schema,\n                  ),\n                payload,\n                useVerboseLogs,\n              )\n            }\n            if (allowUpdate) {\n              registerTool(\n                allowUpdate,\n                `Update ${enabledCollectionSlug}`,\n                () =>\n                  updateResourceTool(\n                    server,\n                    req,\n                    user,\n                    useVerboseLogs,\n                    enabledCollectionSlug,\n                    collectionsPluginConfig,\n                    schema,\n                  ),\n                payload,\n                useVerboseLogs,\n              )\n            }\n            if (allowFind) {\n              registerTool(\n                allowFind,\n                `Find ${enabledCollectionSlug}`,\n                () =>\n                  findResourceTool(\n                    server,\n                    req,\n                    user,\n                    useVerboseLogs,\n                    enabledCollectionSlug,\n                    collectionsPluginConfig,\n                  ),\n                payload,\n                useVerboseLogs,\n              )\n            }\n            if (allowDelete) {\n              registerTool(\n                allowDelete,\n                `Delete ${enabledCollectionSlug}`,\n                () =>\n                  deleteResourceTool(\n                    server,\n                    req,\n                    user,\n                    useVerboseLogs,\n                    enabledCollectionSlug,\n                    collectionsPluginConfig,\n                  ),\n                payload,\n                useVerboseLogs,\n              )\n            }\n          } catch (error) {\n            throw new APIError(\n              `Error registering tools for collection ${enabledCollectionSlug}: ${String(error)}`,\n              500,\n            )\n          }\n        })\n\n        // Global Operation Tools\n        const enabledGlobalSlugs = getEnabledSlugs(globalsPluginConfig, 'global')\n\n        enabledGlobalSlugs.forEach((enabledGlobalSlug) => {\n          try {\n            const schema = configSchema.definitions?.[enabledGlobalSlug] as JSONSchema4\n\n            const toolCapabilities = mcpAccessSettings?.[\n              `${toCamelCase(enabledGlobalSlug)}`\n            ] as Record<string, unknown>\n            const allowFind: boolean | undefined = toolCapabilities?.['find'] as boolean\n            const allowUpdate: boolean | undefined = toolCapabilities?.['update'] as boolean\n\n            if (allowFind) {\n              registerTool(\n                allowFind,\n                `Find ${enabledGlobalSlug}`,\n                () =>\n                  findGlobalTool(\n                    server,\n                    req,\n                    user,\n                    useVerboseLogs,\n                    enabledGlobalSlug,\n                    globalsPluginConfig,\n                  ),\n                payload,\n                useVerboseLogs,\n              )\n            }\n            if (allowUpdate) {\n              registerTool(\n                allowUpdate,\n                `Update ${enabledGlobalSlug}`,\n                () =>\n                  updateGlobalTool(\n                    server,\n                    req,\n                    user,\n                    useVerboseLogs,\n                    enabledGlobalSlug,\n                    globalsPluginConfig,\n                    schema,\n                  ),\n                payload,\n                useVerboseLogs,\n              )\n            }\n          } catch (error) {\n            throw new APIError(\n              `Error registering tools for global ${enabledGlobalSlug}: ${String(error)}`,\n              500,\n            )\n          }\n        })\n\n        // Custom tools\n        customMCPTools.forEach((tool) => {\n          const camelCasedToolName = toCamelCase(tool.name)\n          const isToolEnabled = mcpAccessSettings['payload-mcp-tool']?.[camelCasedToolName] ?? false\n\n          registerTool(\n            isToolEnabled,\n            tool.name,\n            () =>\n              server.tool(\n                tool.name,\n                tool.description,\n                tool.parameters,\n                payloadToolHandler(tool.handler),\n              ),\n            payload,\n            useVerboseLogs,\n          )\n        })\n\n        // Custom prompts\n        customMCPPrompts.forEach((prompt) => {\n          const camelCasedPromptName = toCamelCase(prompt.name)\n          const isPromptEnabled =\n            mcpAccessSettings['payload-mcp-prompt']?.[camelCasedPromptName] ?? false\n\n          if (isPromptEnabled) {\n            server.registerPrompt(\n              prompt.name,\n              {\n                argsSchema: prompt.argsSchema,\n                description: prompt.description,\n                title: prompt.title,\n              },\n              payloadPromptHandler(prompt.handler),\n            )\n            if (useVerboseLogs) {\n              payload.logger.info(`[payload-mcp] âœ… Prompt: ${prompt.title} Registered.`)\n            }\n          } else if (useVerboseLogs) {\n            payload.logger.info(`[payload-mcp] â­ï¸ Prompt: ${prompt.title} Skipped.`)\n          }\n        })\n\n        // Custom resources\n        customMCPResources.forEach((resource) => {\n          const camelCasedResourceName = toCamelCase(resource.name)\n          const isResourceEnabled =\n            mcpAccessSettings['payload-mcp-resource']?.[camelCasedResourceName] ?? false\n\n          if (isResourceEnabled) {\n            server.registerResource(\n              resource.name,\n              // @ts-expect-error - Overload type is not working however -- ResourceTemplate OR String is a valid type\n              resource.uri,\n              {\n                description: resource.description,\n                mimeType: resource.mimeType,\n                title: resource.title,\n              },\n              payloadResourceHandler(resource.handler),\n            )\n\n            if (useVerboseLogs) {\n              payload.logger.info(`[payload-mcp] âœ… Resource: ${resource.title} Registered.`)\n            }\n          } else if (useVerboseLogs) {\n            payload.logger.info(`[payload-mcp] â­ï¸ Resource: ${resource.title} Skipped.`)\n          }\n        })\n\n        // Experimental - Collection Schema Modfication Tools\n        if (\n          mcpAccessSettings.collections?.create &&\n          experimentalTools.collections?.enabled &&\n          isDevelopment\n        ) {\n          registerTool(\n            mcpAccessSettings.collections.create,\n            'Create Collection',\n            () =>\n              createCollectionTool(server, req, useVerboseLogs, collectionsDirPath, configFilePath),\n            payload,\n            useVerboseLogs,\n          )\n        }\n        if (\n          mcpAccessSettings.collections?.delete &&\n          experimentalTools.collections?.enabled &&\n          isDevelopment\n        ) {\n          registerTool(\n            mcpAccessSettings.collections.delete,\n            'Delete Collection',\n            () =>\n              deleteCollectionTool(server, req, useVerboseLogs, collectionsDirPath, configFilePath),\n            payload,\n            useVerboseLogs,\n          )\n        }\n\n        if (\n          mcpAccessSettings.collections?.find &&\n          experimentalTools.collections?.enabled &&\n          isDevelopment\n        ) {\n          registerTool(\n            mcpAccessSettings.collections.find,\n            'Find Collection',\n            () => findCollectionTool(server, req, useVerboseLogs, collectionsDirPath),\n            payload,\n            useVerboseLogs,\n          )\n        }\n\n        if (\n          mcpAccessSettings.collections?.update &&\n          experimentalTools.collections?.enabled &&\n          isDevelopment\n        ) {\n          registerTool(\n            mcpAccessSettings.collections.update,\n            'Update Collection',\n            () =>\n              updateCollectionTool(server, req, useVerboseLogs, collectionsDirPath, configFilePath),\n            payload,\n            useVerboseLogs,\n          )\n        }\n\n        // Experimental - Payload Config Modification Tools\n        if (mcpAccessSettings.config?.find && experimentalTools.config?.enabled && isDevelopment) {\n          registerTool(\n            mcpAccessSettings.config.find,\n            'Find Config',\n            () => findConfigTool(server, req, useVerboseLogs, configFilePath),\n            payload,\n            useVerboseLogs,\n          )\n        }\n\n        if (\n          mcpAccessSettings.config?.update &&\n          experimentalTools.config?.enabled &&\n          isDevelopment\n        ) {\n          registerTool(\n            mcpAccessSettings.config.update,\n            'Update Config',\n            () => updateConfigTool(server, req, useVerboseLogs, configFilePath),\n            payload,\n            useVerboseLogs,\n          )\n        }\n\n        // Experimental - Job Modification Tools\n        if (mcpAccessSettings.jobs?.create && experimentalTools.jobs?.enabled && isDevelopment) {\n          registerTool(\n            mcpAccessSettings.jobs.create,\n            'Create Job',\n            () => createJobTool(server, req, useVerboseLogs, jobsDirPath),\n            payload,\n            useVerboseLogs,\n          )\n        }\n\n        if (mcpAccessSettings.jobs?.update && experimentalTools.jobs?.enabled && isDevelopment) {\n          registerTool(\n            mcpAccessSettings.jobs.update,\n            'Update Job',\n            () => updateJobTool(server, req, useVerboseLogs, jobsDirPath),\n            payload,\n            useVerboseLogs,\n          )\n        }\n\n        if (mcpAccessSettings.jobs?.run && experimentalTools.jobs?.enabled && isDevelopment) {\n          registerTool(\n            mcpAccessSettings.jobs.run,\n            'Run Job',\n            () => runJobTool(server, req, useVerboseLogs),\n            payload,\n            useVerboseLogs,\n          )\n        }\n\n        // Experimental - Auth Modification Tools\n        if (mcpAccessSettings.auth?.auth && experimentalTools.auth?.enabled && isDevelopment) {\n          registerTool(\n            mcpAccessSettings.auth.auth,\n            'Auth',\n            () => authTool(server, req, useVerboseLogs),\n            payload,\n            useVerboseLogs,\n          )\n        }\n\n        if (mcpAccessSettings.auth?.login && experimentalTools.auth?.enabled && isDevelopment) {\n          registerTool(\n            mcpAccessSettings.auth.login,\n            'Login',\n            () => loginTool(server, req, useVerboseLogs),\n            payload,\n            useVerboseLogs,\n          )\n        }\n\n        if (mcpAccessSettings.auth?.verify && experimentalTools.auth?.enabled && isDevelopment) {\n          registerTool(\n            mcpAccessSettings.auth.verify,\n            'Verify',\n            () => verifyTool(server, req, useVerboseLogs),\n            payload,\n            useVerboseLogs,\n          )\n        }\n\n        if (mcpAccessSettings.auth?.resetPassword && experimentalTools.auth?.enabled) {\n          registerTool(\n            mcpAccessSettings.auth.resetPassword,\n            'Reset Password',\n            () => resetPasswordTool(server, req, useVerboseLogs),\n            payload,\n            useVerboseLogs,\n          )\n        }\n\n        if (mcpAccessSettings.auth?.forgotPassword && experimentalTools.auth?.enabled) {\n          registerTool(\n            mcpAccessSettings.auth.forgotPassword,\n            'Forgot Password',\n            () => forgotPasswordTool(server, req, useVerboseLogs),\n            payload,\n            useVerboseLogs,\n          )\n        }\n\n        if (mcpAccessSettings.auth?.unlock && experimentalTools.auth?.enabled) {\n          registerTool(\n            mcpAccessSettings.auth.unlock,\n            'Unlock',\n            () => unlockTool(server, req, useVerboseLogs),\n            payload,\n            useVerboseLogs,\n          )\n        }\n\n        if (useVerboseLogs) {\n          payload.logger.info('[payload-mcp] ðŸš€ MCP Server Ready.')\n        }\n      },\n      {\n        serverInfo: serverOptions.serverInfo,\n      },\n      {\n        basePath: MCPHandlerOptions.basePath || '/api',\n        maxDuration: MCPHandlerOptions.maxDuration || 60,\n        // INFO: Disabled until developer clarity is reached for server side streaming and we have an auth pattern for all SSE patterns\n        // redisUrl: MCPHandlerOptions.redisUrl || process.env.REDIS_URL,\n        verboseLogs: useVerboseLogs,\n      },\n    )\n  } catch (error) {\n    throw new APIError(`Error initializing MCP handler: ${String(error)}`, 500)\n  }\n}\n"],"names":["createMcpHandler","join","APIError","configToJSONSchema","toCamelCase","getEnabledSlugs","registerTool","findGlobalTool","updateGlobalTool","createResourceTool","deleteResourceTool","findResourceTool","updateResourceTool","authTool","forgotPasswordTool","loginTool","resetPasswordTool","unlockTool","verifyTool","createCollectionTool","deleteCollectionTool","findCollectionTool","updateCollectionTool","findConfigTool","updateConfigTool","createJobTool","runJobTool","updateJobTool","getMCPHandler","pluginOptions","mcpAccessSettings","req","payload","configSchema","config","db","defaultIDType","i18n","wrapHandler","handler","args","_extra","length","handlerArgs","slice","payloadToolHandler","payloadPromptHandler","payloadResourceHandler","user","MCPOptions","mcp","customMCPTools","tools","customMCPPrompts","prompts","customMCPResources","resources","MCPHandlerOptions","handlerOptions","serverOptions","useVerboseLogs","verboseLogs","isDevelopment","process","env","NODE_ENV","experimentalTools","experimental","collectionsPluginConfig","collections","globalsPluginConfig","globals","collectionsDirPath","cwd","configFilePath","jobsDirPath","jobs","server","enabledCollectionSlugs","forEach","enabledCollectionSlug","schema","definitions","toolCapabilities","allowCreate","create","allowUpdate","update","allowFind","find","allowDelete","delete","error","String","enabledGlobalSlugs","enabledGlobalSlug","tool","camelCasedToolName","name","isToolEnabled","description","parameters","prompt","camelCasedPromptName","isPromptEnabled","registerPrompt","argsSchema","title","logger","info","resource","camelCasedResourceName","isResourceEnabled","registerResource","uri","mimeType","enabled","run","auth","login","verify","resetPassword","forgotPassword","unlock","serverInfo","basePath","maxDuration"],"mappings":"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"}