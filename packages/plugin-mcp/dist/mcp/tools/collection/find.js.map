{"version":3,"sources":["../../../../src/mcp/tools/collection/find.ts"],"sourcesContent":["import type { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js'\nimport type { PayloadRequest } from 'payload'\n\nimport { readdirSync, readFileSync, statSync } from 'fs'\nimport { extname, join } from 'path'\n\nimport { toolSchemas } from '../schemas.js'\n\nexport const readCollections = (\n  req: PayloadRequest,\n  verboseLogs: boolean,\n  collectionsDirPath: string,\n  collectionName?: string,\n  includeContent: boolean = false,\n  includeCount: boolean = false,\n) => {\n  const payload = req.payload\n\n  if (verboseLogs) {\n    payload.logger.info(\n      `[payload-mcp] Reading collections${collectionName ? ` for: ${collectionName}` : ''}, includeContent: ${includeContent}, includeCount: ${includeCount}`,\n    )\n  }\n\n  try {\n    // Read specific Collection (optional)\n    if (collectionName) {\n      const fileName = `${collectionName.charAt(0).toUpperCase() + collectionName.slice(1)}.ts`\n      const filePath = join(collectionsDirPath, fileName)\n\n      if (!filePath.startsWith(collectionsDirPath)) {\n        payload.logger.error(`[payload-mcp] Invalid collection name attempted: ${collectionName}`)\n        return {\n          content: [{ type: 'text' as const, text: 'Error: Invalid collection name' }],\n        }\n      }\n\n      try {\n        const content = readFileSync(filePath, 'utf8')\n        if (verboseLogs) {\n          payload.logger.info(`[payload-mcp] Successfully read collection: ${collectionName}`)\n        }\n\n        return {\n          content: [\n            {\n              type: 'text' as const,\n              text: `Collection: ${collectionName}\nFile: ${fileName}\n---\n${content}`,\n            },\n          ],\n        }\n      } catch (_error) {\n        payload.logger.warn(`[payload-mcp] Collection not found: ${collectionName}`)\n        return {\n          content: [\n            {\n              type: 'text' as const,\n              text: `Error: Collection '${collectionName}' not found`,\n            },\n          ],\n        }\n      }\n    }\n\n    // Read all Collections\n    const files = readdirSync(collectionsDirPath)\n      .filter((file) => extname(file) === '.ts')\n      .sort()\n\n    if (verboseLogs) {\n      payload.logger.info(`[payload-mcp] Found ${files.length} collection files in directory`)\n    }\n\n    if (files.length === 0) {\n      payload.logger.warn('[payload-mcp] No collection files found in src/collections directory')\n      return {\n        content: [\n          {\n            type: 'text' as const,\n            text: 'No collection files found in src/collections directory',\n          },\n        ],\n      }\n    }\n\n    const results = []\n\n    // Build complete table as a single markdown string\n    let tableContent = `Found ${files.length} collection file(s):\\n\\n`\n\n    // Build table header\n    let tableHeader = '| Collection | File | Size | Modified'\n    let tableSeparator = '|------------|------|------|----------'\n\n    if (includeCount) {\n      tableHeader += ' | Documents'\n      tableSeparator += ' |----------'\n    }\n    tableHeader += ' |'\n    tableSeparator += ' |'\n\n    tableContent += tableHeader + '\\n'\n    tableContent += tableSeparator + '\\n'\n\n    for (const file of files) {\n      const filePath = join(collectionsDirPath, file)\n      const stats = statSync(filePath)\n      const fileSize = stats.size\n      const lastModified = stats.mtime\n\n      const collectionName = file.replace('.ts', '')\n\n      // Build table row\n      let tableRow = `| **${collectionName}** | ${file} | ${fileSize.toLocaleString()} bytes | ${lastModified.toISOString()}`\n\n      // Add document count if requested\n      if (includeCount) {\n        try {\n          // For now, we'll skip document counting since we don't have access to payload instance\n          tableRow += ' | -'\n        } catch (error) {\n          tableRow += ` | Error: ${(error as Error).message}`\n        }\n      }\n      tableRow += ' |'\n\n      tableContent += tableRow + '\\n'\n\n      if (includeContent) {\n        try {\n          const content = readFileSync(filePath, 'utf8')\n          tableContent += `\\n**${collectionName} Content:**\\n\\`\\`\\`typescript\\n${content}\\n\\`\\`\\`\\n\\n`\n        } catch (error) {\n          tableContent += `\\nError reading content: ${(error as Error).message}\\n\\n`\n        }\n      }\n    }\n\n    results.push({\n      type: 'text' as const,\n      text: tableContent,\n    })\n\n    return {\n      content: results,\n    }\n  } catch (error) {\n    const errorMessage = (error as Error).message\n    payload.logger.error(`[payload-mcp] Error reading collections: ${errorMessage}`)\n    return {\n      content: [\n        {\n          type: 'text' as const,\n          text: `âŒ **Error reading collections**: ${errorMessage}`,\n        },\n      ],\n    }\n  }\n}\n\n// MCP Server tool registration\nexport const findCollectionTool = (\n  server: McpServer,\n  req: PayloadRequest,\n  verboseLogs: boolean,\n  collectionsDirPath: string,\n) => {\n  const tool = (\n    collectionName?: string,\n    includeContent: boolean = false,\n    includeCount: boolean = false,\n  ) => {\n    const payload = req.payload\n\n    if (verboseLogs) {\n      payload.logger.info(\n        `[payload-mcp] Finding collections${collectionName ? ` for: ${collectionName}` : ''}, includeContent: ${includeContent}, includeCount: ${includeCount}`,\n      )\n    }\n\n    try {\n      const result = readCollections(\n        req,\n        verboseLogs,\n        collectionsDirPath,\n        collectionName,\n        includeContent,\n        includeCount,\n      )\n\n      if (verboseLogs) {\n        payload.logger.info(`[payload-mcp] Collection search completed`)\n      }\n\n      return result\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error'\n      payload.logger.error(`[payload-mcp] Error finding collections: ${errorMessage}`)\n\n      return {\n        content: [\n          {\n            type: 'text' as const,\n            text: `Error finding collections: ${errorMessage}`,\n          },\n        ],\n      }\n    }\n  }\n\n  server.tool(\n    'findCollections',\n    toolSchemas.findCollections.description,\n    toolSchemas.findCollections.parameters.shape,\n    ({ collectionName, includeContent, includeCount }) => {\n      return tool(collectionName, includeContent, includeCount)\n    },\n  )\n}\n"],"names":["readdirSync","readFileSync","statSync","extname","join","toolSchemas","readCollections","req","verboseLogs","collectionsDirPath","collectionName","includeContent","includeCount","payload","logger","info","fileName","charAt","toUpperCase","slice","filePath","startsWith","error","content","type","text","_error","warn","files","filter","file","sort","length","results","tableContent","tableHeader","tableSeparator","stats","fileSize","size","lastModified","mtime","replace","tableRow","toLocaleString","toISOString","message","push","errorMessage","findCollectionTool","server","tool","result","Error","findCollections","description","parameters","shape"],"mappings":"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"}