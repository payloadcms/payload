{"version":3,"sources":["../../../../src/mcp/tools/collection/delete.ts"],"sourcesContent":["import type { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js'\nimport type { PayloadRequest } from 'payload'\n\nimport { readFileSync, unlinkSync, writeFileSync } from 'fs'\nimport { join } from 'path'\n\nimport { toolSchemas } from '../schemas.js'\n\n// Helper function for removing collection from config\nconst removeCollectionFromConfig = (configContent: string, collectionName: string): string => {\n  // Simple implementation - find and remove the collection import and reference\n  let updatedContent = configContent\n\n  // Remove import statement\n  const importRegex = new RegExp(\n    `import\\\\s*{\\\\s*${collectionName}\\\\s*}\\\\s*from\\\\s*['\"]\\\\./collections/${collectionName}['\"];?\\\\s*\\\\n?`,\n    'g',\n  )\n  updatedContent = updatedContent.replace(importRegex, '')\n\n  // Remove from collections array\n  const collectionsRegex = new RegExp(`\\\\s*${collectionName},?\\\\s*`, 'g')\n  updatedContent = updatedContent.replace(collectionsRegex, '')\n\n  return updatedContent\n}\n\nexport const deleteCollection = (\n  req: PayloadRequest,\n  verboseLogs: boolean,\n  collectionsDirPath: string,\n  configFilePath: string,\n  collectionName: string,\n  confirmDeletion: boolean,\n  updateConfig: boolean,\n) => {\n  const payload = req.payload\n\n  if (verboseLogs) {\n    payload.logger.info(`[payload-mcp] Attempting to delete collection: ${collectionName}`)\n  }\n\n  if (!confirmDeletion) {\n    payload.logger.warn(`[payload-mcp] Deletion cancelled for collection: ${collectionName}`)\n    return {\n      content: [\n        {\n          type: 'text' as const,\n          text: `❌ **Deletion cancelled**. Set confirmDeletion to true to proceed with deleting collection \"${collectionName}\".`,\n        },\n      ],\n    }\n  }\n\n  const capitalizedName = collectionName.charAt(0).toUpperCase() + collectionName.slice(1)\n  const collectionFilePath = join(collectionsDirPath, `${capitalizedName}.ts`)\n\n  // Security check: ensure we're working with the collections directory\n  if (!collectionFilePath.startsWith(collectionsDirPath)) {\n    payload.logger.error(`[payload-mcp] Invalid collection path attempted: ${collectionFilePath}`)\n    return {\n      content: [\n        {\n          type: 'text' as const,\n          text: '❌ **Error**: Invalid collection path',\n        },\n      ],\n    }\n  }\n\n  try {\n    // Check if collection file exists\n    let fileExists = false\n    try {\n      readFileSync(collectionFilePath, 'utf8')\n      fileExists = true\n    } catch {\n      payload.logger.warn(`[payload-mcp] Collection file does not exist: ${collectionFilePath}`)\n    }\n\n    // Read current config if we need to update it\n    let configContent = ''\n    let configExists = false\n    if (updateConfig) {\n      try {\n        configContent = readFileSync(configFilePath, 'utf8')\n        configExists = true\n      } catch {\n        payload.logger.warn(`[payload-mcp] Config file does not exist: ${configFilePath}`)\n      }\n    }\n\n    let responseText = ''\n    let operationsPerformed = 0\n\n    // Delete the collection file\n    if (fileExists) {\n      try {\n        unlinkSync(collectionFilePath)\n        if (verboseLogs) {\n          payload.logger.info(\n            `[payload-mcp] Successfully deleted collection file: ${collectionFilePath}`,\n          )\n        }\n        responseText += `✅ Deleted collection file: \\`${capitalizedName}.ts\\`\\n`\n        operationsPerformed++\n      } catch (error) {\n        const errorMessage = (error as Error).message\n        payload.logger.error(`[payload-mcp] Error deleting collection file: ${errorMessage}`)\n        responseText += `❌ Error deleting collection file: ${errorMessage}\\n`\n      }\n    } else {\n      responseText += `⚠️ Collection file not found: \\`${capitalizedName}.ts\\`\\n`\n    }\n\n    // Update the config file if requested and it exists\n    if (updateConfig && configExists) {\n      try {\n        const updatedConfigContent = removeCollectionFromConfig(configContent, capitalizedName)\n        writeFileSync(configFilePath, updatedConfigContent, 'utf8')\n        if (verboseLogs) {\n          payload.logger.info(`[payload-mcp] Successfully updated config file: ${configFilePath}`)\n        }\n        responseText += `✅ Updated payload.config.ts to remove collection reference\\n`\n        operationsPerformed++\n      } catch (error) {\n        const errorMessage = (error as Error).message\n        payload.logger.error(`[payload-mcp] Error updating config file: ${errorMessage}`)\n        responseText += `❌ Error updating config file: ${errorMessage}\\n`\n      }\n    } else if (updateConfig && !configExists) {\n      responseText += `⚠️ Config file not found: payload.config.ts\\n`\n    }\n\n    // Summary\n    if (operationsPerformed > 0) {\n      responseText += `\\n✅ **Collection deletion completed!**`\n    } else {\n      responseText += `\\n⚠️ **No operations performed**\n\nThe collection file may not have existed or there were errors during deletion.`\n    }\n\n    return {\n      content: [\n        {\n          type: 'text' as const,\n          text: responseText,\n        },\n      ],\n    }\n  } catch (error) {\n    const errorMessage = (error as Error).message\n    payload.logger.error(`[payload-mcp] Error during collection deletion: ${errorMessage}`)\n    return {\n      content: [\n        {\n          type: 'text' as const,\n          text: `❌ **Error during collection deletion**: ${errorMessage}`,\n        },\n      ],\n    }\n  }\n}\n\nexport const deleteCollectionTool = (\n  server: McpServer,\n  req: PayloadRequest,\n  verboseLogs: boolean,\n  collectionsDirPath: string,\n  configFilePath: string,\n) => {\n  const tool = (\n    collectionName: string,\n    confirmDeletion: boolean,\n    updateConfig: boolean = false,\n  ) => {\n    const payload = req.payload\n\n    if (verboseLogs) {\n      payload.logger.info(\n        `[payload-mcp] Deleting collection: ${collectionName}, confirmDeletion: ${confirmDeletion}, updateConfig: ${updateConfig}`,\n      )\n    }\n\n    try {\n      const result = deleteCollection(\n        req,\n        verboseLogs,\n        collectionsDirPath,\n        configFilePath,\n        collectionName,\n        confirmDeletion,\n        updateConfig,\n      )\n\n      if (verboseLogs) {\n        payload.logger.info(`[payload-mcp] Collection deletion completed for: ${collectionName}`)\n      }\n\n      return result\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error'\n      payload.logger.error(\n        `[payload-mcp] Error deleting collection ${collectionName}: ${errorMessage}`,\n      )\n\n      return {\n        content: [\n          {\n            type: 'text' as const,\n            text: `Error deleting collection \"${collectionName}\": ${errorMessage}`,\n          },\n        ],\n      }\n    }\n  }\n\n  server.tool(\n    'deleteCollection',\n    toolSchemas.deleteCollection.description,\n    toolSchemas.deleteCollection.parameters.shape,\n    ({ collectionName, confirmDeletion, updateConfig }) => {\n      return tool(collectionName, confirmDeletion, updateConfig)\n    },\n  )\n}\n"],"names":["readFileSync","unlinkSync","writeFileSync","join","toolSchemas","removeCollectionFromConfig","configContent","collectionName","updatedContent","importRegex","RegExp","replace","collectionsRegex","deleteCollection","req","verboseLogs","collectionsDirPath","configFilePath","confirmDeletion","updateConfig","payload","logger","info","warn","content","type","text","capitalizedName","charAt","toUpperCase","slice","collectionFilePath","startsWith","error","fileExists","configExists","responseText","operationsPerformed","errorMessage","message","updatedConfigContent","deleteCollectionTool","server","tool","result","Error","description","parameters","shape"],"mappings":"AAGA,SAASA,YAAY,EAAEC,UAAU,EAAEC,aAAa,QAAQ,KAAI;AAC5D,SAASC,IAAI,QAAQ,OAAM;AAE3B,SAASC,WAAW,QAAQ,gBAAe;AAE3C,sDAAsD;AACtD,MAAMC,6BAA6B,CAACC,eAAuBC;IACzD,8EAA8E;IAC9E,IAAIC,iBAAiBF;IAErB,0BAA0B;IAC1B,MAAMG,cAAc,IAAIC,OACtB,CAAC,eAAe,EAAEH,eAAe,qCAAqC,EAAEA,eAAe,cAAc,CAAC,EACtG;IAEFC,iBAAiBA,eAAeG,OAAO,CAACF,aAAa;IAErD,gCAAgC;IAChC,MAAMG,mBAAmB,IAAIF,OAAO,CAAC,IAAI,EAAEH,eAAe,MAAM,CAAC,EAAE;IACnEC,iBAAiBA,eAAeG,OAAO,CAACC,kBAAkB;IAE1D,OAAOJ;AACT;AAEA,OAAO,MAAMK,mBAAmB,CAC9BC,KACAC,aACAC,oBACAC,gBACAV,gBACAW,iBACAC;IAEA,MAAMC,UAAUN,IAAIM,OAAO;IAE3B,IAAIL,aAAa;QACfK,QAAQC,MAAM,CAACC,IAAI,CAAC,CAAC,+CAA+C,EAAEf,gBAAgB;IACxF;IAEA,IAAI,CAACW,iBAAiB;QACpBE,QAAQC,MAAM,CAACE,IAAI,CAAC,CAAC,iDAAiD,EAAEhB,gBAAgB;QACxF,OAAO;YACLiB,SAAS;gBACP;oBACEC,MAAM;oBACNC,MAAM,CAAC,2FAA2F,EAAEnB,eAAe,EAAE,CAAC;gBACxH;aACD;QACH;IACF;IAEA,MAAMoB,kBAAkBpB,eAAeqB,MAAM,CAAC,GAAGC,WAAW,KAAKtB,eAAeuB,KAAK,CAAC;IACtF,MAAMC,qBAAqB5B,KAAKa,oBAAoB,GAAGW,gBAAgB,GAAG,CAAC;IAE3E,sEAAsE;IACtE,IAAI,CAACI,mBAAmBC,UAAU,CAAChB,qBAAqB;QACtDI,QAAQC,MAAM,CAACY,KAAK,CAAC,CAAC,iDAAiD,EAAEF,oBAAoB;QAC7F,OAAO;YACLP,SAAS;gBACP;oBACEC,MAAM;oBACNC,MAAM;gBACR;aACD;QACH;IACF;IAEA,IAAI;QACF,kCAAkC;QAClC,IAAIQ,aAAa;QACjB,IAAI;YACFlC,aAAa+B,oBAAoB;YACjCG,aAAa;QACf,EAAE,OAAM;YACNd,QAAQC,MAAM,CAACE,IAAI,CAAC,CAAC,8CAA8C,EAAEQ,oBAAoB;QAC3F;QAEA,8CAA8C;QAC9C,IAAIzB,gBAAgB;QACpB,IAAI6B,eAAe;QACnB,IAAIhB,cAAc;YAChB,IAAI;gBACFb,gBAAgBN,aAAaiB,gBAAgB;gBAC7CkB,eAAe;YACjB,EAAE,OAAM;gBACNf,QAAQC,MAAM,CAACE,IAAI,CAAC,CAAC,0CAA0C,EAAEN,gBAAgB;YACnF;QACF;QAEA,IAAImB,eAAe;QACnB,IAAIC,sBAAsB;QAE1B,6BAA6B;QAC7B,IAAIH,YAAY;YACd,IAAI;gBACFjC,WAAW8B;gBACX,IAAIhB,aAAa;oBACfK,QAAQC,MAAM,CAACC,IAAI,CACjB,CAAC,oDAAoD,EAAES,oBAAoB;gBAE/E;gBACAK,gBAAgB,CAAC,6BAA6B,EAAET,gBAAgB,OAAO,CAAC;gBACxEU;YACF,EAAE,OAAOJ,OAAO;gBACd,MAAMK,eAAe,AAACL,MAAgBM,OAAO;gBAC7CnB,QAAQC,MAAM,CAACY,KAAK,CAAC,CAAC,8CAA8C,EAAEK,cAAc;gBACpFF,gBAAgB,CAAC,kCAAkC,EAAEE,aAAa,EAAE,CAAC;YACvE;QACF,OAAO;YACLF,gBAAgB,CAAC,gCAAgC,EAAET,gBAAgB,OAAO,CAAC;QAC7E;QAEA,oDAAoD;QACpD,IAAIR,gBAAgBgB,cAAc;YAChC,IAAI;gBACF,MAAMK,uBAAuBnC,2BAA2BC,eAAeqB;gBACvEzB,cAAce,gBAAgBuB,sBAAsB;gBACpD,IAAIzB,aAAa;oBACfK,QAAQC,MAAM,CAACC,IAAI,CAAC,CAAC,gDAAgD,EAAEL,gBAAgB;gBACzF;gBACAmB,gBAAgB,CAAC,4DAA4D,CAAC;gBAC9EC;YACF,EAAE,OAAOJ,OAAO;gBACd,MAAMK,eAAe,AAACL,MAAgBM,OAAO;gBAC7CnB,QAAQC,MAAM,CAACY,KAAK,CAAC,CAAC,0CAA0C,EAAEK,cAAc;gBAChFF,gBAAgB,CAAC,8BAA8B,EAAEE,aAAa,EAAE,CAAC;YACnE;QACF,OAAO,IAAInB,gBAAgB,CAACgB,cAAc;YACxCC,gBAAgB,CAAC,6CAA6C,CAAC;QACjE;QAEA,UAAU;QACV,IAAIC,sBAAsB,GAAG;YAC3BD,gBAAgB,CAAC,sCAAsC,CAAC;QAC1D,OAAO;YACLA,gBAAgB,CAAC;;8EAEuD,CAAC;QAC3E;QAEA,OAAO;YACLZ,SAAS;gBACP;oBACEC,MAAM;oBACNC,MAAMU;gBACR;aACD;QACH;IACF,EAAE,OAAOH,OAAO;QACd,MAAMK,eAAe,AAACL,MAAgBM,OAAO;QAC7CnB,QAAQC,MAAM,CAACY,KAAK,CAAC,CAAC,gDAAgD,EAAEK,cAAc;QACtF,OAAO;YACLd,SAAS;gBACP;oBACEC,MAAM;oBACNC,MAAM,CAAC,wCAAwC,EAAEY,cAAc;gBACjE;aACD;QACH;IACF;AACF,EAAC;AAED,OAAO,MAAMG,uBAAuB,CAClCC,QACA5B,KACAC,aACAC,oBACAC;IAEA,MAAM0B,OAAO,CACXpC,gBACAW,iBACAC,eAAwB,KAAK;QAE7B,MAAMC,UAAUN,IAAIM,OAAO;QAE3B,IAAIL,aAAa;YACfK,QAAQC,MAAM,CAACC,IAAI,CACjB,CAAC,mCAAmC,EAAEf,eAAe,mBAAmB,EAAEW,gBAAgB,gBAAgB,EAAEC,cAAc;QAE9H;QAEA,IAAI;YACF,MAAMyB,SAAS/B,iBACbC,KACAC,aACAC,oBACAC,gBACAV,gBACAW,iBACAC;YAGF,IAAIJ,aAAa;gBACfK,QAAQC,MAAM,CAACC,IAAI,CAAC,CAAC,iDAAiD,EAAEf,gBAAgB;YAC1F;YAEA,OAAOqC;QACT,EAAE,OAAOX,OAAO;YACd,MAAMK,eAAeL,iBAAiBY,QAAQZ,MAAMM,OAAO,GAAG;YAC9DnB,QAAQC,MAAM,CAACY,KAAK,CAClB,CAAC,wCAAwC,EAAE1B,eAAe,EAAE,EAAE+B,cAAc;YAG9E,OAAO;gBACLd,SAAS;oBACP;wBACEC,MAAM;wBACNC,MAAM,CAAC,2BAA2B,EAAEnB,eAAe,GAAG,EAAE+B,cAAc;oBACxE;iBACD;YACH;QACF;IACF;IAEAI,OAAOC,IAAI,CACT,oBACAvC,YAAYS,gBAAgB,CAACiC,WAAW,EACxC1C,YAAYS,gBAAgB,CAACkC,UAAU,CAACC,KAAK,EAC7C,CAAC,EAAEzC,cAAc,EAAEW,eAAe,EAAEC,YAAY,EAAE;QAChD,OAAOwB,KAAKpC,gBAAgBW,iBAAiBC;IAC/C;AAEJ,EAAC"}