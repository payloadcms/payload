{"version":3,"sources":["../../../../src/mcp/tools/collection/create.ts"],"sourcesContent":["import type { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js'\nimport type { PayloadRequest } from 'payload'\n\nimport { writeFileSync } from 'fs'\nimport { join } from 'path'\n\nimport { validateCollectionFile } from '../../helpers/fileValidation.js'\nimport { toolSchemas } from '../schemas.js'\n\nexport const createCollection = async (\n  req: PayloadRequest,\n  verboseLogs: boolean,\n  collectionsDirPath: string,\n  configFilePath: string,\n  collectionName: string,\n  collectionDescription: string | undefined,\n  fields: any[],\n  hasUpload: boolean | undefined,\n) => {\n  const payload = req.payload\n  if (verboseLogs) {\n    payload.logger.info(\n      `[payload-mcp] Creating collection: ${collectionName} with ${fields.length} fields`,\n    )\n  }\n\n  const capitalizedName = collectionName.charAt(0).toUpperCase() + collectionName.slice(1)\n  const slug = collectionName\n    .replace(/([A-Z])/g, '-$1')\n    .toLowerCase()\n    .replace(/^-/, '')\n\n  if (verboseLogs) {\n    payload.logger.info(`[payload-mcp] Generated slug: ${slug} for collection: ${collectionName}`)\n  }\n\n  // Generate TypeScript field definitions more systematically\n  const generateFieldDefinition = (field: any) => {\n    const fieldConfig = []\n    fieldConfig.push(`    {`)\n    fieldConfig.push(`      name: '${field.name}',`)\n    fieldConfig.push(`      type: '${field.type}',`)\n\n    if (field.required) {\n      fieldConfig.push(`      required: true,`)\n    }\n\n    if (field.description) {\n      fieldConfig.push(`      admin: {`)\n      fieldConfig.push(`        description: '${field.description}',`)\n      fieldConfig.push(`      },`)\n    }\n\n    if (field.options && field.type === 'select') {\n      fieldConfig.push(`      options: [`)\n      field.options.forEach((option: { label: string; value: string }) => {\n        fieldConfig.push(`        { label: '${option.label}', value: '${option.value}' },`)\n      })\n      fieldConfig.push(`      ],`)\n    }\n\n    fieldConfig.push(`    },`)\n    return fieldConfig.join('\\n')\n  }\n\n  const fieldDefinitions = fields.map(generateFieldDefinition).join('\\n')\n\n  // Generate collection file content\n  const collectionContent = `import type { CollectionConfig } from 'payload'\n\nexport const ${capitalizedName}: CollectionConfig = {\n  slug: '${slug}',${\n    collectionDescription\n      ? `\n  admin: {\n    description: '${collectionDescription}',\n  },`\n      : ''\n  }${\n    hasUpload\n      ? `\n  upload: true,`\n      : ''\n  }\n  fields: [\n${fieldDefinitions}\n  ],\n}\n`\n\n  try {\n    // Validate the collection name and path\n    const fileName = `${capitalizedName}.ts`\n    const filePath = join(collectionsDirPath, fileName)\n\n    // Security check: ensure we're working with the collections directory\n    if (!filePath.startsWith(collectionsDirPath)) {\n      payload.logger.error(`[payload-mcp] Invalid collection path attempted: ${filePath}`)\n      return {\n        content: [\n          {\n            type: 'text' as const,\n            text: '❌ **Error**: Invalid collection path',\n          },\n        ],\n      }\n    }\n\n    // Check if file already exists\n    try {\n      const fs = await import('fs')\n      if (fs.existsSync(filePath)) {\n        return {\n          content: [\n            {\n              type: 'text' as const,\n              text: `❌ **Error**: Collection file already exists: ${fileName}`,\n            },\n          ],\n        }\n      }\n    } catch (_ignore) {\n      // File doesn't exist, which is what we want\n    }\n\n    // Write the collection file\n    writeFileSync(filePath, collectionContent, 'utf8')\n    if (verboseLogs) {\n      payload.logger.info(`[payload-mcp] Successfully created collection file: ${filePath}`)\n    }\n\n    // Validate the generated file\n    const validationResult = await validateCollectionFile(fileName)\n    if (validationResult.error) {\n      return {\n        content: [\n          {\n            type: 'text' as const,\n            text: `❌ **Error**: Generated collection has validation issues:\\n\\n${validationResult.error}`,\n          },\n        ],\n      }\n    }\n\n    return {\n      content: [\n        {\n          type: 'text' as const,\n          text: `✅ **Collection created successfully!**\n**File**: \\`${fileName}\\`\n**Collection Config:**\n\\`\\`\\`typescript\n${collectionContent}\n\\`\\`\\``,\n        },\n      ],\n    }\n  } catch (error) {\n    const errorMessage = (error as Error).message\n    payload.logger.error(`[payload-mcp] Error creating collection: ${errorMessage}`)\n\n    return {\n      content: [\n        {\n          type: 'text' as const,\n          text: `❌ **Error creating collection**: ${errorMessage}`,\n        },\n      ],\n    }\n  }\n}\n\nexport const createCollectionTool = (\n  server: McpServer,\n  req: PayloadRequest,\n  verboseLogs: boolean,\n  collectionsDirPath: string,\n  configFilePath: string,\n) => {\n  const tool = async (\n    collectionName: string,\n    collectionDescription?: string,\n    fields: any[] = [],\n    hasUpload?: boolean,\n  ) => {\n    const payload = req.payload\n\n    if (verboseLogs) {\n      payload.logger.info(\n        `[payload-mcp] Creating collection: ${collectionName}, fields: ${fields.length}, upload: ${hasUpload}`,\n      )\n    }\n\n    try {\n      const result = await createCollection(\n        req,\n        verboseLogs,\n        collectionsDirPath,\n        configFilePath,\n        collectionName,\n        collectionDescription,\n        fields,\n        hasUpload,\n      )\n\n      if (verboseLogs) {\n        payload.logger.info(`[payload-mcp] Collection creation completed for: ${collectionName}`)\n      }\n\n      return result\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error'\n      payload.logger.error(\n        `[payload-mcp] Error creating collection ${collectionName}: ${errorMessage}`,\n      )\n\n      return {\n        content: [\n          {\n            type: 'text' as const,\n            text: `Error creating collection \"${collectionName}\": ${errorMessage}`,\n          },\n        ],\n      }\n    }\n  }\n\n  server.tool(\n    'createCollection',\n    toolSchemas.createCollection.description,\n    toolSchemas.createCollection.parameters.shape,\n    async ({ collectionDescription, collectionName, fields, hasUpload }) => {\n      return await tool(collectionName, collectionDescription, fields, hasUpload)\n    },\n  )\n}\n"],"names":["writeFileSync","join","validateCollectionFile","toolSchemas","createCollection","req","verboseLogs","collectionsDirPath","configFilePath","collectionName","collectionDescription","fields","hasUpload","payload","logger","info","length","capitalizedName","charAt","toUpperCase","slice","slug","replace","toLowerCase","generateFieldDefinition","field","fieldConfig","push","name","type","required","description","options","forEach","option","label","value","fieldDefinitions","map","collectionContent","fileName","filePath","startsWith","error","content","text","fs","existsSync","_ignore","validationResult","errorMessage","message","createCollectionTool","server","tool","result","Error","parameters","shape"],"mappings":"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"}