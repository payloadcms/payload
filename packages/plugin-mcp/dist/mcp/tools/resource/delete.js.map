{"version":3,"sources":["../../../../src/mcp/tools/resource/delete.ts"],"sourcesContent":["import type { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js'\nimport type { PayloadRequest, TypedUser } from 'payload'\n\nimport type { PluginMCPServerConfig } from '../../../types.js'\n\nimport { toCamelCase } from '../../../utils/camelCase.js'\nimport { toolSchemas } from '../schemas.js'\n\nexport const deleteResourceTool = (\n  server: McpServer,\n  req: PayloadRequest,\n  user: TypedUser,\n  verboseLogs: boolean,\n  collectionSlug: string,\n  collections: PluginMCPServerConfig['collections'],\n) => {\n  const tool = async (\n    id?: number | string,\n    where?: string,\n    depth: number = 0,\n    locale?: string,\n    fallbackLocale?: string,\n  ): Promise<{\n    content: Array<{\n      text: string\n      type: 'text'\n    }>\n  }> => {\n    const payload = req.payload\n\n    if (verboseLogs) {\n      payload.logger.info(\n        `[payload-mcp] Deleting resource from collection: ${collectionSlug}${id ? ` with ID: ${id}` : ' with where clause'}${locale ? `, locale: ${locale}` : ''}`,\n      )\n    }\n\n    try {\n      // Validate that either id or where is provided\n      if (!id && !where) {\n        payload.logger.error('[payload-mcp] Either id or where clause must be provided')\n        const response = {\n          content: [\n            { type: 'text' as const, text: 'Error: Either id or where clause must be provided' },\n          ],\n        }\n        return (collections?.[collectionSlug]?.overrideResponse?.(response, {}, req) ||\n          response) as {\n          content: Array<{\n            text: string\n            type: 'text'\n          }>\n        }\n      }\n\n      // Parse where clause if provided\n      let whereClause = {}\n      if (where) {\n        try {\n          whereClause = JSON.parse(where)\n          if (verboseLogs) {\n            payload.logger.info(`[payload-mcp] Using where clause: ${where}`)\n          }\n        } catch (_parseError) {\n          payload.logger.warn(`[payload-mcp] Invalid where clause JSON: ${where}`)\n          const response = {\n            content: [{ type: 'text' as const, text: 'Error: Invalid JSON in where clause' }],\n          }\n          return (collections?.[collectionSlug]?.overrideResponse?.(response, {}, req) ||\n            response) as {\n            content: Array<{\n              text: string\n              type: 'text'\n            }>\n          }\n        }\n      }\n\n      // Build delete options\n      const deleteOptions: Record<string, unknown> = {\n        collection: collectionSlug,\n        depth,\n        overrideAccess: false,\n        req,\n        user,\n        ...(locale && { locale }),\n        ...(fallbackLocale && { fallbackLocale }),\n      }\n\n      // Delete by ID or where clause\n      if (id) {\n        deleteOptions.id = id\n        if (verboseLogs) {\n          payload.logger.info(`[payload-mcp] Deleting single document with ID: ${id}`)\n        }\n      } else {\n        deleteOptions.where = whereClause\n        if (verboseLogs) {\n          payload.logger.info(`[payload-mcp] Deleting multiple documents with where clause`)\n        }\n      }\n\n      const result = await payload.delete(deleteOptions as Parameters<typeof payload.delete>[0])\n\n      // Handle different result types\n      if (id) {\n        // Single document deletion\n        if (verboseLogs) {\n          payload.logger.info(`[payload-mcp] Successfully deleted document with ID: ${id}`)\n        }\n\n        const response = {\n          content: [\n            {\n              type: 'text' as const,\n              text: `Document deleted successfully from collection \"${collectionSlug}\"!\nDeleted document:\n\\`\\`\\`json\n${JSON.stringify(result, null, 2)}\n\\`\\`\\``,\n            },\n          ],\n        }\n\n        return (collections?.[collectionSlug]?.overrideResponse?.(response, result, req) ||\n          response) as {\n          content: Array<{\n            text: string\n            type: 'text'\n          }>\n        }\n      } else {\n        // Multiple documents deletion\n        const bulkResult = result as { docs?: unknown[]; errors?: unknown[] }\n        const docs = bulkResult.docs || []\n        const errors = bulkResult.errors || []\n\n        if (verboseLogs) {\n          payload.logger.info(\n            `[payload-mcp] Successfully deleted ${docs.length} documents, ${errors.length} errors`,\n          )\n        }\n\n        let responseText = `Document deleted successfully from collection \"${collectionSlug}\"!\nDeleted: ${docs.length} documents\nErrors: ${errors.length}\n---`\n\n        if (docs.length > 0) {\n          responseText += `\\n\\nDeleted documents:\n\\`\\`\\`json\n${JSON.stringify(docs, null, 2)}\n\\`\\`\\``\n        }\n\n        if (errors.length > 0) {\n          responseText += `\\n\\nErrors:\n\\`\\`\\`json\n${JSON.stringify(errors, null, 2)}\n\\`\\`\\``\n        }\n\n        const response = {\n          content: [\n            {\n              type: 'text' as const,\n              text: responseText,\n            },\n          ],\n        }\n\n        return (collections?.[collectionSlug]?.overrideResponse?.(\n          response,\n          { docs, errors },\n          req,\n        ) || response) as {\n          content: Array<{\n            text: string\n            type: 'text'\n          }>\n        }\n      }\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error'\n      payload.logger.error(\n        `[payload-mcp] Error deleting resource from ${collectionSlug}: ${errorMessage}`,\n      )\n\n      const response = {\n        content: [\n          {\n            type: 'text' as const,\n            text: `Error deleting resource from collection \"${collectionSlug}\": ${errorMessage}`,\n          },\n        ],\n      }\n\n      return (collections?.[collectionSlug]?.overrideResponse?.(response, {}, req) || response) as {\n        content: Array<{\n          text: string\n          type: 'text'\n        }>\n      }\n    }\n  }\n\n  if (collections?.[collectionSlug]?.enabled) {\n    server.tool(\n      `delete${collectionSlug.charAt(0).toUpperCase() + toCamelCase(collectionSlug).slice(1)}`,\n      `${collections?.[collectionSlug]?.description || toolSchemas.deleteResource.description.trim()}`,\n      toolSchemas.deleteResource.parameters.shape,\n      async ({ id, depth, fallbackLocale, locale, where }) => {\n        return await tool(id, where, depth, locale, fallbackLocale)\n      },\n    )\n  }\n}\n"],"names":["toCamelCase","toolSchemas","deleteResourceTool","server","req","user","verboseLogs","collectionSlug","collections","tool","id","where","depth","locale","fallbackLocale","payload","logger","info","error","response","content","type","text","overrideResponse","whereClause","JSON","parse","_parseError","warn","deleteOptions","collection","overrideAccess","result","delete","stringify","bulkResult","docs","errors","length","responseText","errorMessage","Error","message","enabled","charAt","toUpperCase","slice","description","deleteResource","trim","parameters","shape"],"mappings":"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"}