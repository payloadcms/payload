{"version":3,"sources":["../../../../src/mcp/tools/resource/find.ts"],"sourcesContent":["import type { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js'\nimport type { PayloadRequest, TypedUser } from 'payload'\n\nimport type { PluginMCPServerConfig } from '../../../types.js'\n\nimport { toCamelCase } from '../../../utils/camelCase.js'\nimport { toolSchemas } from '../schemas.js'\n\nexport const findResourceTool = (\n  server: McpServer,\n  req: PayloadRequest,\n  user: TypedUser,\n  verboseLogs: boolean,\n  collectionSlug: string,\n  collections: PluginMCPServerConfig['collections'],\n) => {\n  const tool = async (\n    id?: number | string,\n    limit: number = 10,\n    page: number = 1,\n    sort?: string,\n    where?: string,\n    depth: number = 0,\n    locale?: string,\n    fallbackLocale?: string,\n    draft?: boolean,\n  ): Promise<{\n    content: Array<{\n      text: string\n      type: 'text'\n    }>\n  }> => {\n    const payload = req.payload\n\n    if (verboseLogs) {\n      payload.logger.info(\n        `[payload-mcp] Reading resource from collection: ${collectionSlug}${id ? ` with ID: ${id}` : ''}, limit: ${limit}, page: ${page}${locale ? `, locale: ${locale}` : ''}`,\n      )\n    }\n\n    try {\n      // Parse where clause if provided\n      let whereClause = {}\n      if (where) {\n        try {\n          whereClause = JSON.parse(where)\n          if (verboseLogs) {\n            payload.logger.info(`[payload-mcp] Using where clause: ${where}`)\n          }\n        } catch (_parseError) {\n          payload.logger.warn(`[payload-mcp] Invalid where clause JSON: ${where}`)\n          const response = {\n            content: [{ type: 'text' as const, text: 'Error: Invalid JSON in where clause' }],\n          }\n          return (collections?.[collectionSlug]?.overrideResponse?.(response, {}, req) ||\n            response) as {\n            content: Array<{\n              text: string\n              type: 'text'\n            }>\n          }\n        }\n      }\n\n      // If ID is provided, use findByID\n      if (id) {\n        try {\n          const doc = await payload.findByID({\n            id,\n            collection: collectionSlug,\n            depth,\n            overrideAccess: false,\n            req,\n            user,\n            ...(locale && { locale }),\n            ...(fallbackLocale && { fallbackLocale }),\n            ...(draft !== undefined && { draft }),\n          })\n\n          if (verboseLogs) {\n            payload.logger.info(`[payload-mcp] Found document with ID: ${id}`)\n          }\n\n          const response = {\n            content: [\n              {\n                type: 'text' as const,\n                text: `Resource from collection \"${collectionSlug}\":\n${JSON.stringify(doc, null, 2)}`,\n              },\n            ],\n          }\n\n          return (collections?.[collectionSlug]?.overrideResponse?.(response, doc, req) ||\n            response) as {\n            content: Array<{\n              text: string\n              type: 'text'\n            }>\n          }\n        } catch (_findError) {\n          payload.logger.warn(\n            `[payload-mcp] Document not found with ID: ${id} in collection: ${collectionSlug}`,\n          )\n          const response = {\n            content: [\n              {\n                type: 'text' as const,\n                text: `Error: Document with ID \"${id}\" not found in collection \"${collectionSlug}\"`,\n              },\n            ],\n          }\n          return (collections?.[collectionSlug]?.overrideResponse?.(response, {}, req) ||\n            response) as {\n            content: Array<{\n              text: string\n              type: 'text'\n            }>\n          }\n        }\n      }\n\n      // Otherwise, use find to get multiple documents\n      const findOptions: Parameters<typeof payload.find>[0] = {\n        collection: collectionSlug,\n        depth,\n        limit,\n        overrideAccess: false,\n        page,\n        req,\n        user,\n        ...(locale && { locale }),\n        ...(fallbackLocale && { fallbackLocale }),\n        ...(draft !== undefined && { draft }),\n      }\n\n      if (sort) {\n        findOptions.sort = sort\n      }\n\n      if (Object.keys(whereClause).length > 0) {\n        findOptions.where = whereClause\n      }\n\n      const result = await payload.find(findOptions)\n\n      if (verboseLogs) {\n        payload.logger.info(\n          `[payload-mcp] Found ${result.docs.length} documents in collection: ${collectionSlug}`,\n        )\n      }\n\n      let responseText = `Collection: \"${collectionSlug}\"\nTotal: ${result.totalDocs} documents\nPage: ${result.page} of ${result.totalPages}\n`\n\n      for (const doc of result.docs) {\n        responseText += `\\n\\`\\`\\`json\\n${JSON.stringify(doc, null, 2)}\\n\\`\\`\\``\n      }\n\n      const response = {\n        content: [\n          {\n            type: 'text' as const,\n            text: responseText,\n          },\n        ],\n      }\n\n      return (collections?.[collectionSlug]?.overrideResponse?.(response, result, req) ||\n        response) as {\n        content: Array<{\n          text: string\n          type: 'text'\n        }>\n      }\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error'\n      payload.logger.error(\n        `[payload-mcp] Error reading resources from collection ${collectionSlug}: ${errorMessage}`,\n      )\n      const response = {\n        content: [\n          {\n            type: 'text' as const,\n            text: `‚ùå **Error reading resources from collection \"${collectionSlug}\":** ${errorMessage}`,\n          },\n        ],\n      }\n      return (collections?.[collectionSlug]?.overrideResponse?.(response, {}, req) || response) as {\n        content: Array<{\n          text: string\n          type: 'text'\n        }>\n      }\n    }\n  }\n\n  if (collections?.[collectionSlug]?.enabled) {\n    server.tool(\n      `find${collectionSlug.charAt(0).toUpperCase() + toCamelCase(collectionSlug).slice(1)}`,\n      `${collections?.[collectionSlug]?.description || toolSchemas.findResources.description.trim()}`,\n      toolSchemas.findResources.parameters.shape,\n      async ({ id, depth, draft, fallbackLocale, limit, locale, page, sort, where }) => {\n        return await tool(id, limit, page, sort, where, depth, locale, fallbackLocale, draft)\n      },\n    )\n  }\n}\n"],"names":["toCamelCase","toolSchemas","findResourceTool","server","req","user","verboseLogs","collectionSlug","collections","tool","id","limit","page","sort","where","depth","locale","fallbackLocale","draft","payload","logger","info","whereClause","JSON","parse","_parseError","warn","response","content","type","text","overrideResponse","doc","findByID","collection","overrideAccess","undefined","stringify","_findError","findOptions","Object","keys","length","result","find","docs","responseText","totalDocs","totalPages","error","errorMessage","Error","message","enabled","charAt","toUpperCase","slice","description","findResources","trim","parameters","shape"],"mappings":"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"}