{"version":3,"sources":["../../../../src/mcp/tools/resource/create.ts"],"sourcesContent":["import type { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js'\nimport type { JSONSchema4 } from 'json-schema'\nimport type { PayloadRequest, TypedUser } from 'payload'\n\nimport { z } from 'zod'\n\nimport type { PluginMCPServerConfig } from '../../../types.js'\n\nimport { toCamelCase } from '../../../utils/camelCase.js'\nimport { convertCollectionSchemaToZod } from '../../../utils/convertCollectionSchemaToZod.js'\nimport { toolSchemas } from '../schemas.js'\nexport const createResourceTool = (\n  server: McpServer,\n  req: PayloadRequest,\n  user: TypedUser,\n  verboseLogs: boolean,\n  collectionSlug: string,\n  collections: PluginMCPServerConfig['collections'],\n  schema: JSONSchema4,\n) => {\n  const tool = async (\n    data: string,\n    depth: number = 0,\n    draft: boolean,\n    locale?: string,\n    fallbackLocale?: string,\n  ): Promise<{\n    content: Array<{\n      text: string\n      type: 'text'\n    }>\n  }> => {\n    const payload = req.payload\n\n    if (verboseLogs) {\n      payload.logger.info(\n        `[payload-mcp] Creating resource in collection: ${collectionSlug}${locale ? ` with locale: ${locale}` : ''}`,\n      )\n    }\n\n    try {\n      // Parse the data JSON\n      let parsedData: Record<string, unknown>\n      try {\n        parsedData = JSON.parse(data)\n        if (verboseLogs) {\n          payload.logger.info(\n            `[payload-mcp] Parsed data for ${collectionSlug}: ${JSON.stringify(parsedData)}`,\n          )\n        }\n      } catch (_parseError) {\n        payload.logger.error(`[payload-mcp] Invalid JSON data provided: ${data}`)\n        return {\n          content: [{ type: 'text' as const, text: 'Error: Invalid JSON data provided' }],\n        }\n      }\n\n      // Create the resource\n      const result = await payload.create({\n        collection: collectionSlug,\n        data: parsedData,\n        depth,\n        draft,\n        overrideAccess: false,\n        req,\n        user,\n        ...(locale && { locale }),\n        ...(fallbackLocale && { fallbackLocale }),\n      })\n\n      if (verboseLogs) {\n        payload.logger.info(\n          `[payload-mcp] Successfully created resource in ${collectionSlug} with ID: ${result.id}`,\n        )\n      }\n\n      const response = {\n        content: [\n          {\n            type: 'text' as const,\n            text: `Resource created successfully in collection \"${collectionSlug}\"!\nCreated resource:\n\\`\\`\\`json\n${JSON.stringify(result, null, 2)}\n\\`\\`\\``,\n          },\n        ],\n      }\n\n      return (collections?.[collectionSlug]?.overrideResponse?.(response, result, req) ||\n        response) as {\n        content: Array<{\n          text: string\n          type: 'text'\n        }>\n      }\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error'\n      payload.logger.error(\n        `[payload-mcp] Error creating resource in ${collectionSlug}: ${errorMessage}`,\n      )\n\n      const response = {\n        content: [\n          {\n            type: 'text' as const,\n            text: `Error creating resource in collection \"${collectionSlug}\": ${errorMessage}`,\n          },\n        ],\n      }\n\n      return (collections?.[collectionSlug]?.overrideResponse?.(response, {}, req) || response) as {\n        content: Array<{\n          text: string\n          type: 'text'\n        }>\n      }\n    }\n  }\n\n  if (collections?.[collectionSlug]?.enabled) {\n    const convertedFields = convertCollectionSchemaToZod(schema)\n\n    // Create a new schema that combines the converted fields with create-specific parameters\n    const createResourceSchema = z.object({\n      ...convertedFields.shape,\n      depth: z\n        .number()\n        .int()\n        .min(0)\n        .max(10)\n        .optional()\n        .default(0)\n        .describe('How many levels deep to populate relationships in response'),\n      draft: z\n        .boolean()\n        .optional()\n        .default(false)\n        .describe('Whether to create the document as a draft'),\n      fallbackLocale: z\n        .string()\n        .optional()\n        .describe('Optional: fallback locale code to use when requested locale is not available'),\n      locale: z\n        .string()\n        .optional()\n        .describe(\n          'Optional: locale code to create the document in (e.g., \"en\", \"es\"). Defaults to the default locale',\n        ),\n    })\n\n    server.tool(\n      `create${collectionSlug.charAt(0).toUpperCase() + toCamelCase(collectionSlug).slice(1)}`,\n      `${collections?.[collectionSlug]?.description || toolSchemas.createResource.description.trim()}`,\n      createResourceSchema.shape,\n      async (params: Record<string, unknown>) => {\n        const { depth, draft, fallbackLocale, locale, ...fieldData } = params\n        const data = JSON.stringify(fieldData)\n        return await tool(\n          data,\n          depth as number,\n          draft as boolean,\n          locale as string | undefined,\n          fallbackLocale as string | undefined,\n        )\n      },\n    )\n  }\n}\n"],"names":["z","toCamelCase","convertCollectionSchemaToZod","toolSchemas","createResourceTool","server","req","user","verboseLogs","collectionSlug","collections","schema","tool","data","depth","draft","locale","fallbackLocale","payload","logger","info","parsedData","JSON","parse","stringify","_parseError","error","content","type","text","result","create","collection","overrideAccess","id","response","overrideResponse","errorMessage","Error","message","enabled","convertedFields","createResourceSchema","object","shape","number","int","min","max","optional","default","describe","boolean","string","charAt","toUpperCase","slice","description","createResource","trim","params","fieldData"],"mappings":"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"}