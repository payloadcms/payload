{"version":3,"sources":["../../../../src/mcp/tools/global/update.ts"],"sourcesContent":["import type { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js'\nimport type { JSONSchema4 } from 'json-schema'\nimport type { PayloadRequest, TypedUser } from 'payload'\n\nimport { z } from 'zod'\n\nimport type { PluginMCPServerConfig } from '../../../types.js'\n\nimport { toCamelCase } from '../../../utils/camelCase.js'\nimport { convertCollectionSchemaToZod } from '../../../utils/convertCollectionSchemaToZod.js'\nimport { toolSchemas } from '../schemas.js'\n\nexport const updateGlobalTool = (\n  server: McpServer,\n  req: PayloadRequest,\n  user: TypedUser,\n  verboseLogs: boolean,\n  globalSlug: string,\n  globals: PluginMCPServerConfig['globals'],\n  schema: JSONSchema4,\n) => {\n  const tool = async (\n    data: string,\n    draft: boolean = false,\n    depth: number = 0,\n    locale?: string,\n    fallbackLocale?: string,\n  ): Promise<{\n    content: Array<{\n      text: string\n      type: 'text'\n    }>\n  }> => {\n    const payload = req.payload\n\n    if (verboseLogs) {\n      payload.logger.info(\n        `[payload-mcp] Updating global: ${globalSlug}, draft: ${draft}${locale ? `, locale: ${locale}` : ''}`,\n      )\n    }\n\n    try {\n      // Parse the data JSON\n      let parsedData: Record<string, unknown>\n      try {\n        parsedData = JSON.parse(data)\n        if (verboseLogs) {\n          payload.logger.info(\n            `[payload-mcp] Parsed data for ${globalSlug}: ${JSON.stringify(parsedData)}`,\n          )\n        }\n      } catch (_parseError) {\n        payload.logger.error(`[payload-mcp] Invalid JSON data provided: ${data}`)\n        const response = {\n          content: [{ type: 'text' as const, text: 'Error: Invalid JSON data provided' }],\n        }\n        return (globals?.[globalSlug]?.overrideResponse?.(response, {}, req) || response) as {\n          content: Array<{\n            text: string\n            type: 'text'\n          }>\n        }\n      }\n\n      const updateOptions: Parameters<typeof payload.updateGlobal>[0] = {\n        slug: globalSlug,\n        data: parsedData,\n        depth,\n        draft,\n        user,\n      }\n\n      // Add locale parameters if provided\n      if (locale) {\n        updateOptions.locale = locale\n      }\n      if (fallbackLocale) {\n        updateOptions.fallbackLocale = fallbackLocale\n      }\n\n      const result = await payload.updateGlobal(updateOptions)\n\n      if (verboseLogs) {\n        payload.logger.info(`[payload-mcp] Successfully updated global: ${globalSlug}`)\n      }\n\n      const response = {\n        content: [\n          {\n            type: 'text' as const,\n            text: `Global \"${globalSlug}\" updated successfully!\n\\`\\`\\`json\n${JSON.stringify(result, null, 2)}\n\\`\\`\\``,\n          },\n        ],\n      }\n\n      return (globals?.[globalSlug]?.overrideResponse?.(response, result, req) || response) as {\n        content: Array<{\n          text: string\n          type: 'text'\n        }>\n      }\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error'\n      payload.logger.error(`[payload-mcp] Error updating global ${globalSlug}: ${errorMessage}`)\n\n      const response = {\n        content: [\n          {\n            type: 'text' as const,\n            text: `Error updating global \"${globalSlug}\": ${errorMessage}`,\n          },\n        ],\n      }\n\n      return (globals?.[globalSlug]?.overrideResponse?.(response, {}, req) || response) as {\n        content: Array<{\n          text: string\n          type: 'text'\n        }>\n      }\n    }\n  }\n\n  if (globals?.[globalSlug]?.enabled) {\n    const convertedFields = convertCollectionSchemaToZod(schema)\n\n    // Make all fields optional for partial updates (PATCH-style)\n    const optionalFields = Object.fromEntries(\n      Object.entries(convertedFields.shape).map(([key, value]) => [key, (value as any).optional()]),\n    )\n\n    const updateGlobalSchema = z.object({\n      ...optionalFields,\n      depth: z.number().optional().describe('Optional: Depth of relationships to populate'),\n      draft: z.boolean().optional().describe('Optional: Whether to save as draft (default: false)'),\n      fallbackLocale: z\n        .string()\n        .optional()\n        .describe('Optional: fallback locale code to use when requested locale is not available'),\n      locale: z\n        .string()\n        .optional()\n        .describe(\n          'Optional: locale code to update data in (e.g., \"en\", \"es\"). Use \"all\" to update all locales for localized fields',\n        ),\n    })\n\n    server.tool(\n      `update${globalSlug.charAt(0).toUpperCase() + toCamelCase(globalSlug).slice(1)}`,\n      `${toolSchemas.updateGlobal.description.trim()}\\n\\n${globals?.[globalSlug]?.description || ''}`,\n      updateGlobalSchema.shape,\n      async (params: Record<string, unknown>) => {\n        const { depth, draft, fallbackLocale, locale, ...rest } = params\n        const data = JSON.stringify(rest)\n        return await tool(\n          data,\n          draft as boolean,\n          depth as number,\n          locale as string,\n          fallbackLocale as string,\n        )\n      },\n    )\n  }\n}\n"],"names":["z","toCamelCase","convertCollectionSchemaToZod","toolSchemas","updateGlobalTool","server","req","user","verboseLogs","globalSlug","globals","schema","tool","data","draft","depth","locale","fallbackLocale","payload","logger","info","parsedData","JSON","parse","stringify","_parseError","error","response","content","type","text","overrideResponse","updateOptions","slug","result","updateGlobal","errorMessage","Error","message","enabled","convertedFields","optionalFields","Object","fromEntries","entries","shape","map","key","value","optional","updateGlobalSchema","object","number","describe","boolean","string","charAt","toUpperCase","slice","description","trim","params","rest"],"mappings":"AAIA,SAASA,CAAC,QAAQ,MAAK;AAIvB,SAASC,WAAW,QAAQ,8BAA6B;AACzD,SAASC,4BAA4B,QAAQ,iDAAgD;AAC7F,SAASC,WAAW,QAAQ,gBAAe;AAE3C,OAAO,MAAMC,mBAAmB,CAC9BC,QACAC,KACAC,MACAC,aACAC,YACAC,SACAC;IAEA,MAAMC,OAAO,OACXC,MACAC,QAAiB,KAAK,EACtBC,QAAgB,CAAC,EACjBC,QACAC;QAOA,MAAMC,UAAUZ,IAAIY,OAAO;QAE3B,IAAIV,aAAa;YACfU,QAAQC,MAAM,CAACC,IAAI,CACjB,CAAC,+BAA+B,EAAEX,WAAW,SAAS,EAAEK,QAAQE,SAAS,CAAC,UAAU,EAAEA,QAAQ,GAAG,IAAI;QAEzG;QAEA,IAAI;YACF,sBAAsB;YACtB,IAAIK;YACJ,IAAI;gBACFA,aAAaC,KAAKC,KAAK,CAACV;gBACxB,IAAIL,aAAa;oBACfU,QAAQC,MAAM,CAACC,IAAI,CACjB,CAAC,8BAA8B,EAAEX,WAAW,EAAE,EAAEa,KAAKE,SAAS,CAACH,aAAa;gBAEhF;YACF,EAAE,OAAOI,aAAa;gBACpBP,QAAQC,MAAM,CAACO,KAAK,CAAC,CAAC,0CAA0C,EAAEb,MAAM;gBACxE,MAAMc,WAAW;oBACfC,SAAS;wBAAC;4BAAEC,MAAM;4BAAiBC,MAAM;wBAAoC;qBAAE;gBACjF;gBACA,OAAQpB,SAAS,CAACD,WAAW,EAAEsB,mBAAmBJ,UAAU,CAAC,GAAGrB,QAAQqB;YAM1E;YAEA,MAAMK,gBAA4D;gBAChEC,MAAMxB;gBACNI,MAAMQ;gBACNN;gBACAD;gBACAP;YACF;YAEA,oCAAoC;YACpC,IAAIS,QAAQ;gBACVgB,cAAchB,MAAM,GAAGA;YACzB;YACA,IAAIC,gBAAgB;gBAClBe,cAAcf,cAAc,GAAGA;YACjC;YAEA,MAAMiB,SAAS,MAAMhB,QAAQiB,YAAY,CAACH;YAE1C,IAAIxB,aAAa;gBACfU,QAAQC,MAAM,CAACC,IAAI,CAAC,CAAC,2CAA2C,EAAEX,YAAY;YAChF;YAEA,MAAMkB,WAAW;gBACfC,SAAS;oBACP;wBACEC,MAAM;wBACNC,MAAM,CAAC,QAAQ,EAAErB,WAAW;;AAExC,EAAEa,KAAKE,SAAS,CAACU,QAAQ,MAAM,GAAG;MAC5B,CAAC;oBACG;iBACD;YACH;YAEA,OAAQxB,SAAS,CAACD,WAAW,EAAEsB,mBAAmBJ,UAAUO,QAAQ5B,QAAQqB;QAM9E,EAAE,OAAOD,OAAO;YACd,MAAMU,eAAeV,iBAAiBW,QAAQX,MAAMY,OAAO,GAAG;YAC9DpB,QAAQC,MAAM,CAACO,KAAK,CAAC,CAAC,oCAAoC,EAAEjB,WAAW,EAAE,EAAE2B,cAAc;YAEzF,MAAMT,WAAW;gBACfC,SAAS;oBACP;wBACEC,MAAM;wBACNC,MAAM,CAAC,uBAAuB,EAAErB,WAAW,GAAG,EAAE2B,cAAc;oBAChE;iBACD;YACH;YAEA,OAAQ1B,SAAS,CAACD,WAAW,EAAEsB,mBAAmBJ,UAAU,CAAC,GAAGrB,QAAQqB;QAM1E;IACF;IAEA,IAAIjB,SAAS,CAACD,WAAW,EAAE8B,SAAS;QAClC,MAAMC,kBAAkBtC,6BAA6BS;QAErD,6DAA6D;QAC7D,MAAM8B,iBAAiBC,OAAOC,WAAW,CACvCD,OAAOE,OAAO,CAACJ,gBAAgBK,KAAK,EAAEC,GAAG,CAAC,CAAC,CAACC,KAAKC,MAAM,GAAK;gBAACD;gBAAMC,MAAcC,QAAQ;aAAG;QAG9F,MAAMC,qBAAqBlD,EAAEmD,MAAM,CAAC;YAClC,GAAGV,cAAc;YACjB1B,OAAOf,EAAEoD,MAAM,GAAGH,QAAQ,GAAGI,QAAQ,CAAC;YACtCvC,OAAOd,EAAEsD,OAAO,GAAGL,QAAQ,GAAGI,QAAQ,CAAC;YACvCpC,gBAAgBjB,EACbuD,MAAM,GACNN,QAAQ,GACRI,QAAQ,CAAC;YACZrC,QAAQhB,EACLuD,MAAM,GACNN,QAAQ,GACRI,QAAQ,CACP;QAEN;QAEAhD,OAAOO,IAAI,CACT,CAAC,MAAM,EAAEH,WAAW+C,MAAM,CAAC,GAAGC,WAAW,KAAKxD,YAAYQ,YAAYiD,KAAK,CAAC,IAAI,EAChF,GAAGvD,YAAYgC,YAAY,CAACwB,WAAW,CAACC,IAAI,GAAG,IAAI,EAAElD,SAAS,CAACD,WAAW,EAAEkD,eAAe,IAAI,EAC/FT,mBAAmBL,KAAK,EACxB,OAAOgB;YACL,MAAM,EAAE9C,KAAK,EAAED,KAAK,EAAEG,cAAc,EAAED,MAAM,EAAE,GAAG8C,MAAM,GAAGD;YAC1D,MAAMhD,OAAOS,KAAKE,SAAS,CAACsC;YAC5B,OAAO,MAAMlD,KACXC,MACAC,OACAC,OACAC,QACAC;QAEJ;IAEJ;AACF,EAAC"}