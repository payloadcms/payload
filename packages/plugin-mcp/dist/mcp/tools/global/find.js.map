{"version":3,"sources":["../../../../src/mcp/tools/global/find.ts"],"sourcesContent":["import type { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js'\nimport type { PayloadRequest, TypedUser } from 'payload'\n\nimport type { PluginMCPServerConfig } from '../../../types.js'\n\nimport { toCamelCase } from '../../../utils/camelCase.js'\nimport { toolSchemas } from '../schemas.js'\n\nexport const findGlobalTool = (\n  server: McpServer,\n  req: PayloadRequest,\n  user: TypedUser,\n  verboseLogs: boolean,\n  globalSlug: string,\n  globals: PluginMCPServerConfig['globals'],\n) => {\n  const tool = async (\n    depth: number = 0,\n    locale?: string,\n    fallbackLocale?: string,\n  ): Promise<{\n    content: Array<{\n      text: string\n      type: 'text'\n    }>\n  }> => {\n    const payload = req.payload\n\n    if (verboseLogs) {\n      payload.logger.info(\n        `[payload-mcp] Reading global: ${globalSlug}, depth: ${depth}${locale ? `, locale: ${locale}` : ''}`,\n      )\n    }\n\n    try {\n      const findOptions: Parameters<typeof payload.findGlobal>[0] = {\n        slug: globalSlug,\n        depth,\n        user,\n      }\n\n      // Add locale parameters if provided\n      if (locale) {\n        findOptions.locale = locale\n      }\n      if (fallbackLocale) {\n        findOptions.fallbackLocale = fallbackLocale\n      }\n\n      const result = await payload.findGlobal(findOptions)\n\n      if (verboseLogs) {\n        payload.logger.info(`[payload-mcp] Found global: ${globalSlug}`)\n      }\n\n      const response = {\n        content: [\n          {\n            type: 'text' as const,\n            text: `Global \"${globalSlug}\":\n\\`\\`\\`json\n${JSON.stringify(result, null, 2)}\n\\`\\`\\``,\n          },\n        ],\n      }\n\n      return (globals?.[globalSlug]?.overrideResponse?.(response, result, req) || response) as {\n        content: Array<{\n          text: string\n          type: 'text'\n        }>\n      }\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error'\n      payload.logger.error(`[payload-mcp] Error reading global ${globalSlug}: ${errorMessage}`)\n      const response = {\n        content: [\n          {\n            type: 'text' as const,\n            text: `‚ùå **Error reading global \"${globalSlug}\":** ${errorMessage}`,\n          },\n        ],\n      }\n      return (globals?.[globalSlug]?.overrideResponse?.(response, {}, req) || response) as {\n        content: Array<{\n          text: string\n          type: 'text'\n        }>\n      }\n    }\n  }\n\n  if (globals?.[globalSlug]?.enabled) {\n    server.tool(\n      `find${globalSlug.charAt(0).toUpperCase() + toCamelCase(globalSlug).slice(1)}`,\n      `${toolSchemas.findGlobal.description.trim()}\\n\\n${globals?.[globalSlug]?.description || ''}`,\n      toolSchemas.findGlobal.parameters.shape,\n      async ({ depth, fallbackLocale, locale }) => {\n        return await tool(depth, locale, fallbackLocale)\n      },\n    )\n  }\n}\n"],"names":["toCamelCase","toolSchemas","findGlobalTool","server","req","user","verboseLogs","globalSlug","globals","tool","depth","locale","fallbackLocale","payload","logger","info","findOptions","slug","result","findGlobal","response","content","type","text","JSON","stringify","overrideResponse","error","errorMessage","Error","message","enabled","charAt","toUpperCase","slice","description","trim","parameters","shape"],"mappings":"AAKA,SAASA,WAAW,QAAQ,8BAA6B;AACzD,SAASC,WAAW,QAAQ,gBAAe;AAE3C,OAAO,MAAMC,iBAAiB,CAC5BC,QACAC,KACAC,MACAC,aACAC,YACAC;IAEA,MAAMC,OAAO,OACXC,QAAgB,CAAC,EACjBC,QACAC;QAOA,MAAMC,UAAUT,IAAIS,OAAO;QAE3B,IAAIP,aAAa;YACfO,QAAQC,MAAM,CAACC,IAAI,CACjB,CAAC,8BAA8B,EAAER,WAAW,SAAS,EAAEG,QAAQC,SAAS,CAAC,UAAU,EAAEA,QAAQ,GAAG,IAAI;QAExG;QAEA,IAAI;YACF,MAAMK,cAAwD;gBAC5DC,MAAMV;gBACNG;gBACAL;YACF;YAEA,oCAAoC;YACpC,IAAIM,QAAQ;gBACVK,YAAYL,MAAM,GAAGA;YACvB;YACA,IAAIC,gBAAgB;gBAClBI,YAAYJ,cAAc,GAAGA;YAC/B;YAEA,MAAMM,SAAS,MAAML,QAAQM,UAAU,CAACH;YAExC,IAAIV,aAAa;gBACfO,QAAQC,MAAM,CAACC,IAAI,CAAC,CAAC,4BAA4B,EAAER,YAAY;YACjE;YAEA,MAAMa,WAAW;gBACfC,SAAS;oBACP;wBACEC,MAAM;wBACNC,MAAM,CAAC,QAAQ,EAAEhB,WAAW;;AAExC,EAAEiB,KAAKC,SAAS,CAACP,QAAQ,MAAM,GAAG;MAC5B,CAAC;oBACG;iBACD;YACH;YAEA,OAAQV,SAAS,CAACD,WAAW,EAAEmB,mBAAmBN,UAAUF,QAAQd,QAAQgB;QAM9E,EAAE,OAAOO,OAAO;YACd,MAAMC,eAAeD,iBAAiBE,QAAQF,MAAMG,OAAO,GAAG;YAC9DjB,QAAQC,MAAM,CAACa,KAAK,CAAC,CAAC,mCAAmC,EAAEpB,WAAW,EAAE,EAAEqB,cAAc;YACxF,MAAMR,WAAW;gBACfC,SAAS;oBACP;wBACEC,MAAM;wBACNC,MAAM,CAAC,0BAA0B,EAAEhB,WAAW,KAAK,EAAEqB,cAAc;oBACrE;iBACD;YACH;YACA,OAAQpB,SAAS,CAACD,WAAW,EAAEmB,mBAAmBN,UAAU,CAAC,GAAGhB,QAAQgB;QAM1E;IACF;IAEA,IAAIZ,SAAS,CAACD,WAAW,EAAEwB,SAAS;QAClC5B,OAAOM,IAAI,CACT,CAAC,IAAI,EAAEF,WAAWyB,MAAM,CAAC,GAAGC,WAAW,KAAKjC,YAAYO,YAAY2B,KAAK,CAAC,IAAI,EAC9E,GAAGjC,YAAYkB,UAAU,CAACgB,WAAW,CAACC,IAAI,GAAG,IAAI,EAAE5B,SAAS,CAACD,WAAW,EAAE4B,eAAe,IAAI,EAC7FlC,YAAYkB,UAAU,CAACkB,UAAU,CAACC,KAAK,EACvC,OAAO,EAAE5B,KAAK,EAAEE,cAAc,EAAED,MAAM,EAAE;YACtC,OAAO,MAAMF,KAAKC,OAAOC,QAAQC;QACnC;IAEJ;AACF,EAAC"}