{"version":3,"sources":["../../../../src/mcp/tools/job/run.ts"],"sourcesContent":["import type { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js'\nimport type { PayloadRequest } from 'payload'\n\nimport { toolSchemas } from '../schemas.js'\n\n// Reusable function for running jobs\nexport const runJob = async (\n  req: PayloadRequest,\n  verboseLogs: boolean,\n  jobSlug: string,\n  input: Record<string, any>,\n  queue?: string,\n  priority?: number,\n  delay?: number,\n) => {\n  const payload = req.payload\n\n  if (verboseLogs) {\n    payload.logger.info(`[payload-mcp] Running job: ${jobSlug}`)\n  }\n\n  try {\n    // Actually run the job using Payload's job queue\n    const jobQueueOptions: Record<string, unknown> = {\n      input,\n      task: jobSlug,\n    }\n\n    if (queue && queue !== 'default') {\n      jobQueueOptions.queue = queue\n      if (verboseLogs) {\n        payload.logger.info(`[payload-mcp] Using custom queue: ${queue}`)\n      }\n    }\n\n    if (priority && priority > 0) {\n      jobQueueOptions.priority = priority\n      if (verboseLogs) {\n        payload.logger.info(`[payload-mcp] Setting job priority: ${priority}`)\n      }\n    }\n\n    if (delay && delay > 0) {\n      jobQueueOptions.waitUntil = new Date(Date.now() + delay)\n      if (verboseLogs) {\n        payload.logger.info(`[payload-mcp] Setting job delay: ${delay}ms`)\n      }\n    }\n\n    if (verboseLogs) {\n      payload.logger.info(\n        `[payload-mcp] Queuing job with options: ${JSON.stringify(jobQueueOptions)}`,\n      )\n    }\n\n    const job = await payload.jobs.queue(\n      jobQueueOptions as Parameters<typeof payload.jobs.queue>[0],\n    )\n\n    const jobId = (job as { id?: string })?.id || 'unknown'\n\n    if (verboseLogs) {\n      payload.logger.info(`[payload-mcp] Job created successfully: ${jobId}`)\n    }\n\n    return {\n      content: [\n        {\n          type: 'text' as const,\n          text: `# Job Queued Successfully: ${jobSlug}\n\n## Job Details\n- **Job ID**: ${jobId}\n- **Job Slug**: ${jobSlug}\n- **Queue**: ${queue || 'default'}\n- **Priority**: ${priority || 'default'}\n- **Delay**: ${delay ? `${delay}ms` : 'none'}\n- **Status**: Queued and Running\n\n## Input Data\n\\`\\`\\`json\n${JSON.stringify(input, null, 2)}\n\\`\\`\\`\n\n## Job Status\nThe job has been successfully queued and will be processed according to the queue settings.\n\n## Monitoring the Job\nYou can monitor the job status using:\n\n\\`\\`\\`typescript\n// Check job status\nconst jobStatus = await payload.jobs.status('${jobId}')\nconsole.log('Job status:', jobStatus)\n\n// Wait for completion\nconst result = await payload.jobs.wait('${jobId}')\nconsole.log('Job result:', result)\n\\`\\`\\`\n\n✅ Job successfully queued with ID: ${jobId}`,\n        },\n      ],\n    }\n  } catch (error) {\n    const errorMsg = (error as Error).message\n    payload.logger.error(`[payload-mcp] Error running job \"${jobSlug}\": ${errorMsg}`)\n\n    return {\n      content: [\n        {\n          type: 'text' as const,\n          text: `❌ Error running job \"${jobSlug}\": ${errorMsg}\n\n## Common Issues:\n1. **Job not found**: The job \"${jobSlug}\" may not be registered in your Payload configuration\n2. **Invalid input format**: Ensure the input matches the job's input schema\n3. **Queue not configured**: The queue \"${queue || 'default'}\" may not be properly set up\n4. **Permission issues**: Ensure proper access rights for job execution\n5. **Job handler error**: The job implementation may have errors\n\n## Input Data Provided:\n\\`\\`\\`json\n${JSON.stringify(input, null, 2)}\n\\`\\`\\`\n\n## Next Steps:\n1. **Verify job exists**: Check that the job \"${jobSlug}\" is properly registered\n2. **Check input format**: Ensure the input data matches the expected schema\n3. **Review job configuration**: Verify the job is properly configured in your Payload setup\n4. **Check permissions**: Ensure you have the necessary permissions to run jobs\n5. **Review error logs**: Check the server logs for more detailed error information\n\n## Troubleshooting:\n- **Job not found**: Verify the job slug and check your jobs configuration\n- **Schema mismatch**: Ensure input data matches the job's input schema\n- **Queue issues**: Check that the specified queue is properly configured\n- **Permission errors**: Verify user permissions for job execution`,\n        },\n      ],\n    }\n  }\n}\n\nexport const runJobTool = (server: McpServer, req: PayloadRequest, verboseLogs: boolean) => {\n  const tool = async (\n    jobSlug: string,\n    input: Record<string, any>,\n    queue?: string,\n    priority?: number,\n    delay?: number,\n  ) => {\n    if (verboseLogs) {\n      req.payload.logger.info(`[payload-mcp] Run Job Tool called with: ${jobSlug}`)\n    }\n\n    try {\n      const result = await runJob(req, verboseLogs, jobSlug, input, queue, priority, delay)\n\n      if (verboseLogs) {\n        req.payload.logger.info(`[payload-mcp] Run Job Tool completed successfully`)\n      }\n\n      return result\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error'\n      req.payload.logger.error(`[payload-mcp] Error in Run Job Tool: ${errorMessage}`)\n\n      return {\n        content: [\n          {\n            type: 'text' as const,\n            text: `❌ **Error in Run Job Tool**: ${errorMessage}`,\n          },\n        ],\n      }\n    }\n  }\n\n  server.tool(\n    'runJob',\n    'Runs a Payload job with specified input data and queue options',\n    toolSchemas.runJob.parameters.shape,\n    async (args) => {\n      const { delay, input, jobSlug, priority, queue } = args\n      return await tool(jobSlug, input, queue, priority, delay)\n    },\n  )\n}\n"],"names":["toolSchemas","runJob","req","verboseLogs","jobSlug","input","queue","priority","delay","payload","logger","info","jobQueueOptions","task","waitUntil","Date","now","JSON","stringify","job","jobs","jobId","id","content","type","text","error","errorMsg","message","runJobTool","server","tool","result","errorMessage","Error","parameters","shape","args"],"mappings":"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"}