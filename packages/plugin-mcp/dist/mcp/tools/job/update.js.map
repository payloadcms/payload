{"version":3,"sources":["../../../../src/mcp/tools/job/update.ts"],"sourcesContent":["import type { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js'\nimport type { PayloadRequest } from 'payload'\n\nimport { existsSync, readFileSync, writeFileSync } from 'fs'\nimport { join } from 'path'\n\nimport type { JobConfigUpdate, SchemaField, TaskSequenceItem } from '../../../types.js'\n\nimport { validatePayloadFile } from '../../helpers/fileValidation.js'\nimport { toolSchemas } from '../schemas.js'\n\n// Reusable function for updating jobs\nexport const updateJob = async (\n  req: PayloadRequest,\n  verboseLogs: boolean,\n  jobsDir: string,\n  jobSlug: string,\n  updateType: string,\n  inputSchema?: SchemaField[],\n  outputSchema?: SchemaField[],\n  taskSequence?: TaskSequenceItem[],\n  configUpdate?: JobConfigUpdate,\n  handlerCode?: string,\n) => {\n  const payload = req.payload\n\n  if (verboseLogs) {\n    payload.logger.info(`[payload-mcp] Updating job: ${jobSlug} (${updateType})`)\n  }\n\n  try {\n    const camelCaseJobSlug = toCamelCase(jobSlug)\n\n    // Find the job file - check both tasks and workflows\n    let filePath: null | string = null\n    let jobType: 'task' | 'workflow' | null = null\n\n    const taskPath = join(jobsDir, 'tasks', `${camelCaseJobSlug}.ts`)\n    const workflowPath = join(jobsDir, 'workflows', `${camelCaseJobSlug}.ts`)\n\n    if (existsSync(taskPath)) {\n      filePath = taskPath\n      jobType = 'task'\n      if (verboseLogs) {\n        payload.logger.info(`[payload-mcp] Found task file: ${taskPath}`)\n      }\n    } else if (existsSync(workflowPath)) {\n      filePath = workflowPath\n      jobType = 'workflow'\n      if (verboseLogs) {\n        payload.logger.info(`[payload-mcp] Found workflow file: ${workflowPath}`)\n      }\n    } else {\n      throw new Error(`No task or workflow file found for job slug: ${jobSlug}`)\n    }\n\n    // Read the current file content\n    let content = readFileSync(filePath, 'utf8')\n    const originalContent = content\n\n    if (verboseLogs) {\n      payload.logger.info(`[payload-mcp] Applying update type: ${updateType}`)\n    }\n\n    // Apply updates based on type\n    switch (updateType) {\n      case 'change_config':\n        if (!configUpdate) {\n          throw new Error('config must be provided for change_config')\n        }\n\n        content = updateConfig(content, jobSlug, configUpdate)\n        if (verboseLogs) {\n          payload.logger.info(`[payload-mcp] Configuration updated successfully`)\n        }\n        break\n\n      case 'modify_schema':\n        if (!inputSchema && !outputSchema) {\n          throw new Error('Either inputSchema or outputSchema must be provided for modify_schema')\n        }\n\n        content = updateSchema(content, camelCaseJobSlug, inputSchema, outputSchema)\n        if (verboseLogs) {\n          payload.logger.info(`[payload-mcp] Schema updated successfully`)\n        }\n        break\n\n      case 'replace_handler':\n        if (!handlerCode) {\n          throw new Error('handlerCode must be provided for replace_handler')\n        }\n\n        content = updateHandler(content, handlerCode, jobType)\n        if (verboseLogs) {\n          payload.logger.info(`[payload-mcp] Handler code replaced successfully`)\n        }\n        break\n\n      case 'update_tasks':\n        if (!taskSequence) {\n          throw new Error('taskSequence must be provided for update_tasks')\n        }\n\n        if (jobType !== 'workflow') {\n          throw new Error('update_tasks is only supported for workflow jobs')\n        }\n\n        content = updateWorkflowTasks(content, taskSequence)\n        if (verboseLogs) {\n          payload.logger.info(`[payload-mcp] Workflow tasks updated successfully`)\n        }\n        break\n    }\n\n    // Only write if content changed\n    if (content !== originalContent) {\n      if (verboseLogs) {\n        payload.logger.info(`[payload-mcp] Writing updated content to file`)\n      }\n\n      // Write the updated content\n      writeFileSync(filePath, content)\n\n      // Validate the updated file\n      const fileName = `${camelCaseJobSlug}.ts`\n      const validationType = jobType === 'task' ? 'task' : 'workflow'\n\n      try {\n        const validationResult = await validatePayloadFile(fileName, validationType)\n\n        if (!validationResult.success) {\n          if (verboseLogs) {\n            payload.logger.warn(`[payload-mcp] Validation warning: ${validationResult.error}`)\n          }\n\n          return {\n            content: [\n              {\n                type: 'text' as const,\n                text: `⚠️ **Warning**: Job updated but validation failed:\\n\\n${validationResult.error}\\n\\nPlease review the generated code for any syntax errors.`,\n              },\n            ],\n          }\n        }\n\n        if (verboseLogs) {\n          payload.logger.info(`[payload-mcp] File validation successful`)\n        }\n      } catch (validationError) {\n        if (verboseLogs) {\n          payload.logger.warn(`[payload-mcp] Validation error: ${validationError}`)\n        }\n\n        return {\n          content: [\n            {\n              type: 'text' as const,\n              text: `⚠️ **Warning**: Job updated but validation could not be completed:\\n\\n${validationError}\\n\\nPlease review the generated code manually.`,\n            },\n          ],\n        }\n      }\n\n      return {\n        content: [\n          {\n            type: 'text' as const,\n            text: `✅ **Job updated successfully!**\\n\\n**Job**: \\`${jobSlug}\\`\\n**Type**: \\`${jobType}\\`\\n**Update**: \\`${updateType}\\`\\n**File**: \\`${fileName}\\`\\n\\n**Next steps**:\\n1. Restart your development server to load the updated job\\n2. Test the updated functionality\\n3. Verify the changes meet your requirements`,\n          },\n        ],\n      }\n    } else {\n      if (verboseLogs) {\n        payload.logger.info(`[payload-mcp] No changes detected, file not modified`)\n      }\n\n      return {\n        content: [\n          {\n            type: 'text' as const,\n            text: `ℹ️ **No changes made**: The job file was not modified as no changes were detected.\\n\\n**Job**: \\`${jobSlug}\\`\\n**Type**: \\`${jobType}\\`\\n**Update**: \\`${updateType}\\``,\n          },\n        ],\n      }\n    }\n  } catch (error) {\n    const errorMessage = (error as Error).message\n    payload.logger.error(`[payload-mcp] Error updating job: ${errorMessage}`)\n\n    return {\n      content: [\n        {\n          type: 'text' as const,\n          text: `❌ **Error updating job**: ${errorMessage}`,\n        },\n      ],\n    }\n  }\n}\n\n// Helper function to convert to camel case\nfunction toCamelCase(str: string): string {\n  return str\n    .replace(/[-_\\s]+(.)?/g, (_, chr) => (chr ? chr.toUpperCase() : ''))\n    .replace(/^(.)/, (_, chr) => chr.toLowerCase())\n}\n\n// Helper functions for different update types\nfunction updateSchema(\n  content: string,\n  camelCaseJobSlug: string,\n  inputSchema?: SchemaField[],\n  outputSchema?: SchemaField[],\n): string {\n  // TODO: Implementation for schema updates\n  // This would modify the inputSchema and outputSchema in the job file\n  return content\n}\n\nfunction updateWorkflowTasks(content: string, taskSequence: TaskSequenceItem[]): string {\n  // TODO: Implementation for updating workflow tasks\n  // This would modify the steps array in the workflow\n  return content\n}\n\nfunction updateConfig(content: string, jobSlug: string, configUpdate: JobConfigUpdate): string {\n  // TODO: Implementation for updating job configuration\n  // This would modify various config properties\n  return content\n}\n\nfunction updateHandler(content: string, handlerCode: string, jobType: 'task' | 'workflow'): string {\n  // TODO: Implementation for replacing handler code\n  // This would replace the handler function in the job file\n  return content\n}\n\nexport const updateJobTool = (\n  server: McpServer,\n  req: PayloadRequest,\n  verboseLogs: boolean,\n  jobsDir: string,\n) => {\n  const tool = async (\n    jobSlug: string,\n    updateType: string,\n    inputSchema?: SchemaField[],\n    outputSchema?: SchemaField[],\n    taskSequence?: TaskSequenceItem[],\n    configUpdate?: JobConfigUpdate,\n    handlerCode?: string,\n  ) => {\n    if (verboseLogs) {\n      req.payload.logger.info(\n        `[payload-mcp] Update Job Tool called with: ${jobSlug}, ${updateType}`,\n      )\n    }\n\n    try {\n      const result = await updateJob(\n        req,\n        verboseLogs,\n        jobsDir,\n        jobSlug,\n        updateType,\n        inputSchema,\n        outputSchema,\n        taskSequence,\n        configUpdate,\n        handlerCode,\n      )\n\n      if (verboseLogs) {\n        req.payload.logger.info(`[payload-mcp] Update Job Tool completed successfully`)\n      }\n\n      return result\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error'\n      req.payload.logger.error(`[payload-mcp] Error in Update Job Tool: ${errorMessage}`)\n\n      return {\n        content: [\n          {\n            type: 'text' as const,\n            text: `❌ **Error in Update Job Tool**: ${errorMessage}`,\n          },\n        ],\n      }\n    }\n  }\n\n  server.tool(\n    'updateJob',\n    'Updates an existing Payload job with new configuration, schema, or handler code',\n    toolSchemas.updateJob.parameters.shape,\n    async (args) => {\n      const {\n        configUpdate,\n        handlerCode,\n        inputSchema,\n        jobSlug,\n        outputSchema,\n        taskSequence,\n        updateType,\n      } = args\n      return await tool(\n        jobSlug,\n        updateType,\n        inputSchema as unknown as SchemaField[],\n        outputSchema as unknown as SchemaField[],\n        taskSequence,\n        configUpdate,\n        handlerCode,\n      )\n    },\n  )\n}\n"],"names":["existsSync","readFileSync","writeFileSync","join","validatePayloadFile","toolSchemas","updateJob","req","verboseLogs","jobsDir","jobSlug","updateType","inputSchema","outputSchema","taskSequence","configUpdate","handlerCode","payload","logger","info","camelCaseJobSlug","toCamelCase","filePath","jobType","taskPath","workflowPath","Error","content","originalContent","updateConfig","updateSchema","updateHandler","updateWorkflowTasks","fileName","validationType","validationResult","success","warn","error","type","text","validationError","errorMessage","message","str","replace","_","chr","toUpperCase","toLowerCase","updateJobTool","server","tool","result","parameters","shape","args"],"mappings":"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"}