{"version":3,"sources":["../../../../src/mcp/tools/config/update.ts"],"sourcesContent":["import type { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js'\nimport type { PayloadRequest } from 'payload'\n\nimport { readFileSync, writeFileSync } from 'fs'\n\nimport {\n  addCollectionToConfig,\n  removeCollectionFromConfig,\n  updateAdminConfig,\n  updateDatabaseConfig,\n  updatePluginsConfig,\n} from '../../helpers/config.js'\nimport { toolSchemas } from '../schemas.js'\n\nexport const updateConfig = (\n  req: PayloadRequest,\n  verboseLogs: boolean,\n  configFilePath: string,\n  updateType: string,\n  collectionName?: string,\n  adminConfig?: any,\n  databaseConfig?: any,\n  pluginUpdates?: any,\n  generalConfig?: any,\n  newContent?: string,\n) => {\n  const payload = req.payload\n  if (verboseLogs) {\n    payload.logger.info(`[payload-mcp] Updating config with update type: ${updateType}`)\n  }\n\n  // Security check: ensure we're working with the specified config file\n  if (!configFilePath.startsWith(process.cwd()) && !configFilePath.startsWith('/')) {\n    payload.logger.error(`[payload-mcp] Invalid config path attempted: ${configFilePath}`)\n    return {\n      content: [\n        {\n          type: 'text' as const,\n          text: '❌ **Error**: Invalid config path',\n        },\n      ],\n    }\n  }\n\n  try {\n    // Read current config\n    let currentContent: string\n    try {\n      currentContent = readFileSync(configFilePath, 'utf8')\n    } catch (_ignore) {\n      return {\n        content: [\n          {\n            type: 'text' as const,\n            text: `❌ **Error**: Config file not found: ${configFilePath}`,\n          },\n        ],\n      }\n    }\n\n    let updatedContent: string\n    let updateSummary: string[] = []\n\n    switch (updateType) {\n      case 'add_collection':\n        if (!collectionName) {\n          return {\n            content: [\n              {\n                type: 'text' as const,\n                text: '❌ **Error**: No collection name provided for add_collection update type',\n              },\n            ],\n          }\n        }\n        updatedContent = addCollectionToConfig(currentContent, collectionName)\n        updateSummary = [`Added collection: ${collectionName}`]\n        break\n\n      case 'remove_collection':\n        if (!collectionName) {\n          return {\n            content: [\n              {\n                type: 'text' as const,\n                text: '❌ **Error**: No collection name provided for remove_collection update type',\n              },\n            ],\n          }\n        }\n        updatedContent = removeCollectionFromConfig(currentContent, collectionName)\n        updateSummary = [`Removed collection: ${collectionName}`]\n        break\n\n      case 'replace_content':\n        if (!newContent) {\n          return {\n            content: [\n              {\n                type: 'text' as const,\n                text: '❌ **Error**: No new content provided for replace_content update type',\n              },\n            ],\n          }\n        }\n        updatedContent = newContent\n        updateSummary = ['Replaced entire config content']\n        break\n\n      case 'update_admin':\n        if (!adminConfig) {\n          return {\n            content: [\n              {\n                type: 'text' as const,\n                text: '❌ **Error**: No admin config provided for update_admin update type',\n              },\n            ],\n          }\n        }\n        updatedContent = updateAdminConfig(currentContent, adminConfig)\n        updateSummary = Object.keys(adminConfig).map((key) => `Updated admin config: ${key}`)\n        break\n\n      case 'update_database':\n        if (!databaseConfig) {\n          return {\n            content: [\n              {\n                type: 'text' as const,\n                text: '❌ **Error**: No database config provided for update_database update type',\n              },\n            ],\n          }\n        }\n        updatedContent = updateDatabaseConfig(currentContent, databaseConfig)\n        updateSummary = Object.keys(databaseConfig).map((key) => `Updated database config: ${key}`)\n        break\n\n      case 'update_plugins':\n        if (!pluginUpdates) {\n          return {\n            content: [\n              {\n                type: 'text' as const,\n                text: '❌ **Error**: No plugin updates provided for update_plugins update type',\n              },\n            ],\n          }\n        }\n        updatedContent = updatePluginsConfig(currentContent, pluginUpdates)\n        updateSummary = []\n        if (pluginUpdates.add) {\n          updateSummary.push(`Added plugins: ${pluginUpdates.add.join(', ')}`)\n        }\n        if (pluginUpdates.remove) {\n          updateSummary.push(`Removed plugins: ${pluginUpdates.remove.join(', ')}`)\n        }\n        break\n\n      default:\n        return {\n          content: [\n            {\n              type: 'text' as const,\n              text: `❌ **Error**: Unknown update type: ${updateType}`,\n            },\n          ],\n        }\n    }\n\n    // Write the updated content back to the file\n    writeFileSync(configFilePath, updatedContent, 'utf8')\n    if (verboseLogs) {\n      payload.logger.info(`[payload-mcp] Successfully updated config file: ${configFilePath}`)\n    }\n\n    return {\n      content: [\n        {\n          type: 'text' as const,\n          text: `✅ **Config updated successfully!**\n\n**File**: \\`${configFilePath}\\`\n**Update Type**: ${updateType}\n\n**Changes Made**:\n${updateSummary.map((summary) => `- ${summary}`).join('\\n')}\n\n**Updated Config Content:**\n\\`\\`\\`typescript\n${updatedContent}\n\\`\\`\\``,\n        },\n      ],\n    }\n  } catch (error) {\n    const errorMessage = (error as Error).message\n    payload.logger.error(`[payload-mcp] Error updating config: ${errorMessage}`)\n    return {\n      content: [\n        {\n          type: 'text' as const,\n          text: `❌ **Error updating config**: ${errorMessage}`,\n        },\n      ],\n    }\n  }\n}\n\nexport const updateConfigTool = (\n  server: McpServer,\n  req: PayloadRequest,\n  verboseLogs: boolean,\n  configFilePath: string,\n) => {\n  const tool = ({\n    adminConfig,\n    collectionName,\n    databaseConfig,\n    generalConfig,\n    newContent,\n    pluginUpdates,\n    updateType,\n  }: {\n    adminConfig?: any\n    collectionName?: string\n    databaseConfig?: any\n    generalConfig?: any\n    newContent?: string\n    pluginUpdates?: any\n    updateType: string\n  }) => {\n    const payload = req.payload\n\n    if (verboseLogs) {\n      payload.logger.info(`[payload-mcp] Updating config: ${updateType}`)\n    }\n\n    try {\n      const result = updateConfig(\n        req,\n        verboseLogs,\n        configFilePath,\n        updateType,\n        collectionName,\n        adminConfig,\n        databaseConfig,\n        pluginUpdates,\n        generalConfig,\n        newContent,\n      )\n\n      if (verboseLogs) {\n        payload.logger.info(`[payload-mcp] Config update completed for: ${updateType}`)\n      }\n\n      return result\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error'\n      payload.logger.error(`[payload-mcp] Error updating config: ${errorMessage}`)\n\n      return {\n        content: [\n          {\n            type: 'text' as const,\n            text: `Error updating config: ${errorMessage}`,\n          },\n        ],\n      }\n    }\n  }\n\n  server.tool(\n    'updateConfig',\n    toolSchemas.updateConfig.description,\n    toolSchemas.updateConfig.parameters.shape,\n    (args) => {\n      return tool(args)\n    },\n  )\n}\n"],"names":["readFileSync","writeFileSync","addCollectionToConfig","removeCollectionFromConfig","updateAdminConfig","updateDatabaseConfig","updatePluginsConfig","toolSchemas","updateConfig","req","verboseLogs","configFilePath","updateType","collectionName","adminConfig","databaseConfig","pluginUpdates","generalConfig","newContent","payload","logger","info","startsWith","process","cwd","error","content","type","text","currentContent","_ignore","updatedContent","updateSummary","Object","keys","map","key","add","push","join","remove","summary","errorMessage","message","updateConfigTool","server","tool","result","Error","description","parameters","shape","args"],"mappings":"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"}