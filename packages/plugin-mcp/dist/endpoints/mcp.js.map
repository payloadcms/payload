{"version":3,"sources":["../../src/endpoints/mcp.ts"],"sourcesContent":["import crypto from 'crypto'\nimport { type PayloadHandler, type TypedUser, UnauthorizedError, type Where } from 'payload'\n\nimport type { MCPAccessSettings, PluginMCPServerConfig } from '../types.js'\n\nimport { createRequestFromPayloadRequest } from '../mcp/createRequest.js'\nimport { getMCPHandler } from '../mcp/getMcpHandler.js'\n\nexport const initializeMCPHandler = (pluginOptions: PluginMCPServerConfig) => {\n  const mcpHandler: PayloadHandler = async (req) => {\n    const { payload } = req\n    const MCPOptions = pluginOptions.mcp || {}\n    const MCPHandlerOptions = MCPOptions.handlerOptions || {}\n    const useVerboseLogs = MCPHandlerOptions.verboseLogs ?? false\n\n    req.payloadAPI = 'MCP' as const\n\n    const getDefaultMcpAccessSettings = async (overrideApiKey?: null | string) => {\n      const apiKey =\n        (overrideApiKey ?? req.headers.get('Authorization')?.startsWith('Bearer '))\n          ? req.headers.get('Authorization')?.replace('Bearer ', '').trim()\n          : null\n\n      if (apiKey === null) {\n        throw new UnauthorizedError()\n      }\n\n      const sha256APIKeyIndex = crypto\n        .createHmac('sha256', payload.secret)\n        .update(apiKey || '')\n        .digest('hex')\n\n      const where: Where = {\n        apiKeyIndex: {\n          equals: sha256APIKeyIndex,\n        },\n      }\n\n      const { docs } = await payload.find({\n        collection: 'payload-mcp-api-keys',\n        depth: 1,\n        limit: 1,\n        pagination: false,\n        where,\n      })\n\n      if (docs.length === 0) {\n        throw new UnauthorizedError()\n      }\n\n      if (useVerboseLogs) {\n        payload.logger.info('[payload-mcp] API Key is valid')\n      }\n\n      const user = docs[0]?.user as TypedUser\n      user.collection = pluginOptions.userCollection as string\n      user._strategy = 'mcp-api-key' as const\n\n      return docs[0] as unknown as MCPAccessSettings\n    }\n\n    const mcpAccessSettings = pluginOptions.overrideAuth\n      ? await pluginOptions.overrideAuth(req, getDefaultMcpAccessSettings)\n      : await getDefaultMcpAccessSettings()\n\n    const handler = getMCPHandler(pluginOptions, mcpAccessSettings, req)\n    const request = createRequestFromPayloadRequest(req)\n    return await handler(request)\n  }\n  return mcpHandler\n}\n"],"names":["crypto","UnauthorizedError","createRequestFromPayloadRequest","getMCPHandler","initializeMCPHandler","pluginOptions","mcpHandler","req","payload","MCPOptions","mcp","MCPHandlerOptions","handlerOptions","useVerboseLogs","verboseLogs","payloadAPI","getDefaultMcpAccessSettings","overrideApiKey","apiKey","headers","get","startsWith","replace","trim","sha256APIKeyIndex","createHmac","secret","update","digest","where","apiKeyIndex","equals","docs","find","collection","depth","limit","pagination","length","logger","info","user","userCollection","_strategy","mcpAccessSettings","overrideAuth","handler","request"],"mappings":"AAAA,OAAOA,YAAY,SAAQ;AAC3B,SAA8CC,iBAAiB,QAAoB,UAAS;AAI5F,SAASC,+BAA+B,QAAQ,0BAAyB;AACzE,SAASC,aAAa,QAAQ,0BAAyB;AAEvD,OAAO,MAAMC,uBAAuB,CAACC;IACnC,MAAMC,aAA6B,OAAOC;QACxC,MAAM,EAAEC,OAAO,EAAE,GAAGD;QACpB,MAAME,aAAaJ,cAAcK,GAAG,IAAI,CAAC;QACzC,MAAMC,oBAAoBF,WAAWG,cAAc,IAAI,CAAC;QACxD,MAAMC,iBAAiBF,kBAAkBG,WAAW,IAAI;QAExDP,IAAIQ,UAAU,GAAG;QAEjB,MAAMC,8BAA8B,OAAOC;YACzC,MAAMC,SACJ,AAACD,kBAAkBV,IAAIY,OAAO,CAACC,GAAG,CAAC,kBAAkBC,WAAW,aAC5Dd,IAAIY,OAAO,CAACC,GAAG,CAAC,kBAAkBE,QAAQ,WAAW,IAAIC,SACzD;YAEN,IAAIL,WAAW,MAAM;gBACnB,MAAM,IAAIjB;YACZ;YAEA,MAAMuB,oBAAoBxB,OACvByB,UAAU,CAAC,UAAUjB,QAAQkB,MAAM,EACnCC,MAAM,CAACT,UAAU,IACjBU,MAAM,CAAC;YAEV,MAAMC,QAAe;gBACnBC,aAAa;oBACXC,QAAQP;gBACV;YACF;YAEA,MAAM,EAAEQ,IAAI,EAAE,GAAG,MAAMxB,QAAQyB,IAAI,CAAC;gBAClCC,YAAY;gBACZC,OAAO;gBACPC,OAAO;gBACPC,YAAY;gBACZR;YACF;YAEA,IAAIG,KAAKM,MAAM,KAAK,GAAG;gBACrB,MAAM,IAAIrC;YACZ;YAEA,IAAIY,gBAAgB;gBAClBL,QAAQ+B,MAAM,CAACC,IAAI,CAAC;YACtB;YAEA,MAAMC,OAAOT,IAAI,CAAC,EAAE,EAAES;YACtBA,KAAKP,UAAU,GAAG7B,cAAcqC,cAAc;YAC9CD,KAAKE,SAAS,GAAG;YAEjB,OAAOX,IAAI,CAAC,EAAE;QAChB;QAEA,MAAMY,oBAAoBvC,cAAcwC,YAAY,GAChD,MAAMxC,cAAcwC,YAAY,CAACtC,KAAKS,+BACtC,MAAMA;QAEV,MAAM8B,UAAU3C,cAAcE,eAAeuC,mBAAmBrC;QAChE,MAAMwC,UAAU7C,gCAAgCK;QAChD,OAAO,MAAMuC,QAAQC;IACvB;IACA,OAAOzC;AACT,EAAC"}