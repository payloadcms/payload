{"version":3,"sources":["../src/main.ts"],"sourcesContent":["import * as p from '@clack/prompts'\nimport slugify from '@sindresorhus/slugify'\nimport arg from 'arg'\nimport chalk from 'chalk'\nimport figures from 'figures'\nimport path from 'path'\n\nimport type { CliArgs } from './types.js'\n\nimport { configurePayloadConfig } from './lib/configure-payload-config.js'\nimport { createProject } from './lib/create-project.js'\nimport { parseExample } from './lib/examples.js'\nimport { generateSecret } from './lib/generate-secret.js'\nimport { getPackageManager } from './lib/get-package-manager.js'\nimport { getNextAppDetails, initNext } from './lib/init-next.js'\nimport { manageEnvFiles } from './lib/manage-env-files.js'\nimport { parseProjectName } from './lib/parse-project-name.js'\nimport { parseTemplate } from './lib/parse-template.js'\nimport { selectDb } from './lib/select-db.js'\nimport { getValidTemplates, validateTemplate } from './lib/templates.js'\nimport { updatePayloadInProject } from './lib/update-payload-in-project.js'\nimport { getLatestPackageVersion } from './utils/getLatestPackageVersion.js'\nimport { debug, error, info } from './utils/log.js'\nimport {\n  feedbackOutro,\n  helpMessage,\n  moveMessage,\n  successfulNextInit,\n  successMessage,\n} from './utils/messages.js'\n\nexport class Main {\n  args: CliArgs\n\n  constructor() {\n    // @ts-expect-error bad typings\n    this.args = arg(\n      {\n        '--branch': String,\n        '--db': String,\n        '--db-accept-recommended': Boolean,\n        '--db-connection-string': String,\n        '--example': String,\n        '--help': Boolean,\n        '--local-template': String,\n        '--name': String,\n        '--secret': String,\n        '--template': String,\n        '--version': String, // Allows overriding the installed Payload version instead of installing the latest\n\n        // Next.js\n        '--init-next': Boolean, // TODO: Is this needed if we detect if inside Next.js project?\n\n        // Package manager\n        '--no-deps': Boolean,\n        '--use-bun': Boolean,\n        '--use-npm': Boolean,\n        '--use-pnpm': Boolean,\n        '--use-yarn': Boolean,\n\n        // Other\n        '--no-git': Boolean,\n\n        // Flags\n        '--beta': Boolean,\n        '--debug': Boolean,\n        '--dry-run': Boolean,\n\n        // Aliases\n        '-d': '--db',\n        '-e': '--example',\n        '-h': '--help',\n        '-n': '--name',\n        '-t': '--template',\n      },\n      { permissive: true },\n    )\n  }\n\n  async init(): Promise<void> {\n    try {\n      const debugFlag = this.args['--debug']\n\n      // Set DEBUG env var for logger utility\n      if (debugFlag) {\n        process.env.DEBUG = 'true'\n      }\n\n      const LATEST_VERSION = await getLatestPackageVersion({\n        debug: debugFlag,\n        packageName: 'payload',\n      })\n\n      if (this.args['--help']) {\n        helpMessage()\n        process.exit(0)\n      }\n\n      // eslint-disable-next-line no-console\n      console.log('\\n')\n      p.intro(chalk.bgCyan(chalk.black(' create-payload-app ')))\n      p.note(\"Welcome to Payload. Let's create a project!\")\n\n      // Detect if inside Next.js project\n      const nextAppDetails = await getNextAppDetails(process.cwd())\n      const {\n        hasTopLevelLayout,\n        isPayloadInstalled,\n        isSupportedNextVersion,\n        nextAppDir,\n        nextConfigPath,\n        nextVersion,\n      } = nextAppDetails\n\n      if (nextConfigPath && !isSupportedNextVersion) {\n        p.log.warn(\n          `Next.js v${nextVersion} is unsupported. Next.js >= 15 is required to use Payload.`,\n        )\n        p.outro(feedbackOutro())\n        process.exit(0)\n      }\n\n      // Upgrade Payload in existing project\n      if (isPayloadInstalled && nextConfigPath) {\n        p.log.warn(`Payload installation detected in current project.`)\n        const shouldUpdate = await p.confirm({\n          initialValue: false,\n          message: chalk.bold(`Upgrade Payload in this project?`),\n        })\n\n        if (!p.isCancel(shouldUpdate) && shouldUpdate) {\n          const { message, success: updateSuccess } = await updatePayloadInProject(nextAppDetails)\n          if (updateSuccess) {\n            info(message)\n          } else {\n            error(message)\n          }\n        }\n\n        p.outro(feedbackOutro())\n        process.exit(0)\n      }\n\n      if (nextConfigPath) {\n        this.args['--name'] = slugify(path.basename(path.dirname(nextConfigPath)))\n      }\n\n      const projectName = await parseProjectName(this.args)\n      const projectDir = nextConfigPath\n        ? path.dirname(nextConfigPath)\n        : path.resolve(process.cwd(), slugify(projectName))\n\n      const packageManager = await getPackageManager({ cliArgs: this.args, projectDir })\n\n      if (nextConfigPath) {\n        p.log.step(\n          chalk.bold(`${chalk.bgBlack(` ${figures.triangleUp} Next.js `)} project detected!`),\n        )\n\n        const proceed = await p.confirm({\n          initialValue: true,\n          message: chalk.bold(`Install ${chalk.green('Payload')} in this project?`),\n        })\n        if (p.isCancel(proceed) || !proceed) {\n          p.outro(feedbackOutro())\n          process.exit(0)\n        }\n\n        // Check for top-level layout.tsx\n        if (nextAppDir && hasTopLevelLayout) {\n          p.log.warn(moveMessage({ nextAppDir, projectDir }))\n          p.outro(feedbackOutro())\n          process.exit(0)\n        }\n\n        const dbDetails = await selectDb(this.args, projectName)\n\n        const result = await initNext({\n          ...this.args,\n          dbType: dbDetails.type,\n          nextAppDetails,\n          packageManager,\n          projectDir,\n        })\n\n        if (result.success === false) {\n          p.outro(feedbackOutro())\n          process.exit(1)\n        }\n\n        await configurePayloadConfig({\n          dbType: dbDetails?.type,\n          projectDirOrConfigPath: {\n            payloadConfigPath: result.payloadConfigPath,\n          },\n        })\n\n        await manageEnvFiles({\n          cliArgs: this.args,\n          databaseType: dbDetails.type,\n          databaseUri: dbDetails.dbUri,\n          payloadSecret: generateSecret(),\n          projectDir,\n        })\n\n        info('Payload project successfully initialized!')\n        p.note(successfulNextInit(), chalk.bgGreen(chalk.black(' Documentation ')))\n        p.outro(feedbackOutro())\n        return\n      }\n\n      const templateArg = this.args['--template']\n      if (templateArg) {\n        const valid = validateTemplate({ templateName: templateArg })\n        if (!valid) {\n          helpMessage()\n          process.exit(1)\n        }\n      }\n\n      const exampleArg = this.args['--example']\n\n      if (exampleArg) {\n        const example = await parseExample({\n          name: exampleArg,\n          branch: this.args['--branch'] ?? 'main',\n        })\n\n        if (!example) {\n          helpMessage()\n          process.exit(1)\n        }\n\n        await createProject({\n          cliArgs: this.args,\n          example,\n          packageManager,\n          projectDir,\n          projectName,\n        })\n      }\n\n      if (debugFlag) {\n        debug(`Using ${exampleArg ? 'examples' : 'templates'} from git tag: v${LATEST_VERSION}`)\n      }\n\n      if (!exampleArg) {\n        const validTemplates = getValidTemplates()\n        const template = await parseTemplate(this.args, validTemplates)\n        if (!template) {\n          p.log.error('Invalid template given')\n          p.outro(feedbackOutro())\n          process.exit(1)\n        }\n\n        switch (template.type) {\n          case 'plugin': {\n            await createProject({\n              cliArgs: this.args,\n              packageManager,\n              projectDir,\n              projectName,\n              template,\n            })\n            break\n          }\n          case 'starter': {\n            const dbDetails = await selectDb(this.args, projectName, template)\n\n            await createProject({\n              cliArgs: this.args,\n              dbDetails,\n              packageManager,\n              projectDir,\n              projectName,\n              template,\n            })\n\n            break\n          }\n        }\n      }\n\n      info('Payload project successfully created!')\n      p.log.step(chalk.bgGreen(chalk.black(' Next Steps ')))\n      p.log.message(successMessage(projectDir, packageManager))\n      p.outro(feedbackOutro())\n    } catch (err: unknown) {\n      error(err instanceof Error ? err.message : 'An error occurred')\n    }\n  }\n}\n"],"names":["p","slugify","arg","chalk","figures","path","configurePayloadConfig","createProject","parseExample","generateSecret","getPackageManager","getNextAppDetails","initNext","manageEnvFiles","parseProjectName","parseTemplate","selectDb","getValidTemplates","validateTemplate","updatePayloadInProject","getLatestPackageVersion","debug","error","info","feedbackOutro","helpMessage","moveMessage","successfulNextInit","successMessage","Main","args","String","Boolean","permissive","init","debugFlag","process","env","DEBUG","LATEST_VERSION","packageName","exit","console","log","intro","bgCyan","black","note","nextAppDetails","cwd","hasTopLevelLayout","isPayloadInstalled","isSupportedNextVersion","nextAppDir","nextConfigPath","nextVersion","warn","outro","shouldUpdate","confirm","initialValue","message","bold","isCancel","success","updateSuccess","basename","dirname","projectName","projectDir","resolve","packageManager","cliArgs","step","bgBlack","triangleUp","proceed","green","dbDetails","result","dbType","type","projectDirOrConfigPath","payloadConfigPath","databaseType","databaseUri","dbUri","payloadSecret","bgGreen","templateArg","valid","templateName","exampleArg","example","name","branch","validTemplates","template","err","Error"],"mappings":"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"}