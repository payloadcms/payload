{"version":3,"sources":["../../src/lib/manage-env-files.ts"],"sourcesContent":["import fs from 'fs-extra'\nimport path from 'path'\n\nimport type { CliArgs, DbType, ProjectTemplate } from '../types.js'\n\nimport { debug, error } from '../utils/log.js'\nimport { dbChoiceRecord } from './select-db.js'\n\nconst sanitizeEnv = ({\n  contents,\n  databaseType,\n  databaseUri,\n  payloadSecret,\n}: {\n  contents: string\n  databaseType: DbType | undefined\n  databaseUri?: string\n  payloadSecret?: string\n}): string => {\n  const seenKeys = new Set<string>()\n\n  // add defaults\n  let withDefaults = contents\n\n  if (\n    !contents.includes('DATABASE_URL') &&\n    !contents.includes('POSTGRES_URL') &&\n    !contents.includes('MONGODB_URL') &&\n    databaseType !== 'd1-sqlite'\n  ) {\n    withDefaults += '\\nDATABASE_URL=your-connection-string-here'\n  }\n\n  if (!contents.includes('PAYLOAD_SECRET')) {\n    withDefaults += '\\nPAYLOAD_SECRET=YOUR_SECRET_HERE'\n  }\n\n  let updatedEnv = withDefaults\n    .split('\\n')\n    .map((line) => {\n      if (line.startsWith('#') || !line.includes('=')) {\n        return line\n      }\n\n      const [key, value] = line.split('=')\n\n      if (!key) {\n        return\n      }\n\n      if (key === 'DATABASE_URL' || key === 'POSTGRES_URL' || key === 'MONGODB_URL') {\n        const dbChoice = databaseType ? dbChoiceRecord[databaseType] : null\n\n        if (dbChoice) {\n          const placeholderUri = databaseUri\n            ? databaseUri\n            : `${dbChoice.dbConnectionPrefix}your-database-name${dbChoice.dbConnectionSuffix || ''}`\n          line =\n            databaseType === 'vercel-postgres'\n              ? `POSTGRES_URL=${placeholderUri}`\n              : `DATABASE_URL=${placeholderUri}`\n        } else {\n          line = `${key}=${value}`\n        }\n      }\n\n      if (key === 'PAYLOAD_SECRET' || key === 'PAYLOAD_SECRET_KEY') {\n        line = `PAYLOAD_SECRET=${payloadSecret || 'YOUR_SECRET_HERE'}`\n      }\n\n      // handles dupes\n      if (seenKeys.has(key)) {\n        return null\n      }\n\n      seenKeys.add(key)\n\n      return line\n    })\n    .filter(Boolean)\n    .reverse()\n    .join('\\n')\n\n  if (!updatedEnv.includes('# Added by Payload')) {\n    updatedEnv = `# Added by Payload\\n${updatedEnv}`\n  }\n\n  return updatedEnv\n}\n\n/** Parse and swap .env.example values and write .env */\nexport async function manageEnvFiles(args: {\n  cliArgs: CliArgs\n  databaseType?: DbType\n  databaseUri?: string\n  payloadSecret: string\n  projectDir: string\n  template?: ProjectTemplate\n}): Promise<void> {\n  const { cliArgs, databaseType, databaseUri, payloadSecret, projectDir, template } = args\n\n  const debugFlag = cliArgs['--debug']\n\n  if (cliArgs['--dry-run']) {\n    debug(`DRY RUN: Environment files managed`)\n    return\n  }\n\n  const pathToEnvExample = path.join(projectDir, '.env.example')\n  const envPath = path.join(projectDir, '.env')\n\n  let exampleEnv: null | string = ''\n\n  try {\n    if (template?.type === 'plugin') {\n      if (debugFlag) {\n        debug(`plugin template detected - no .env added .env.example added`)\n      }\n\n      return\n    }\n\n    // If there's a .env.example file, use it to create or update the .env file\n    if (fs.existsSync(pathToEnvExample)) {\n      const envExampleContents = await fs.readFile(pathToEnvExample, 'utf8')\n\n      exampleEnv = sanitizeEnv({\n        contents: envExampleContents,\n        databaseType,\n        databaseUri,\n        payloadSecret,\n      })\n\n      if (debugFlag) {\n        debug(`.env.example file successfully read`)\n      }\n    }\n\n    // If there's no .env file, create it using the .env.example content (if it exists)\n    if (!fs.existsSync(envPath)) {\n      const envContent = sanitizeEnv({\n        contents: exampleEnv,\n        databaseType,\n        databaseUri,\n        payloadSecret,\n      })\n\n      await fs.writeFile(envPath, envContent)\n\n      if (debugFlag) {\n        debug(`.env file successfully created`)\n      }\n    } else {\n      // If the .env file already exists, sanitize it as-is\n      const envContents = await fs.readFile(envPath, 'utf8')\n\n      const updatedEnvContents = sanitizeEnv({\n        contents: envContents,\n        databaseType,\n        databaseUri,\n        payloadSecret,\n      })\n\n      await fs.writeFile(envPath, updatedEnvContents)\n\n      if (debugFlag) {\n        debug(`.env file successfully updated`)\n      }\n    }\n  } catch (err: unknown) {\n    error('Unable to manage environment files')\n    if (err instanceof Error) {\n      error(err.message)\n    }\n    process.exit(1)\n  }\n}\n"],"names":["fs","path","debug","error","dbChoiceRecord","sanitizeEnv","contents","databaseType","databaseUri","payloadSecret","seenKeys","Set","withDefaults","includes","updatedEnv","split","map","line","startsWith","key","value","dbChoice","placeholderUri","dbConnectionPrefix","dbConnectionSuffix","has","add","filter","Boolean","reverse","join","manageEnvFiles","args","cliArgs","projectDir","template","debugFlag","pathToEnvExample","envPath","exampleEnv","type","existsSync","envExampleContents","readFile","envContent","writeFile","envContents","updatedEnvContents","err","Error","message","process","exit"],"mappings":"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"}