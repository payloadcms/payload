{"version":3,"sources":["../../src/lib/update-payload-in-project.ts"],"sourcesContent":["import fse from 'fs-extra'\nimport { fileURLToPath } from 'node:url'\nimport path from 'path'\n\nconst filename = fileURLToPath(import.meta.url)\nconst dirname = path.dirname(filename)\n\nimport type { NextAppDetails } from '../types.js'\n\nimport { copyRecursiveSync } from '../utils/copy-recursive-sync.js'\nimport { getLatestPackageVersion } from '../utils/getLatestPackageVersion.js'\nimport { info } from '../utils/log.js'\nimport { getPackageManager } from './get-package-manager.js'\nimport { installPackages } from './install-packages.js'\n\nexport async function updatePayloadInProject(\n  appDetails: NextAppDetails,\n): Promise<{ message: string; success: boolean }> {\n  if (!appDetails.nextConfigPath) {\n    return { message: 'No Next.js config found', success: false }\n  }\n\n  const projectDir = path.dirname(appDetails.nextConfigPath)\n\n  const packageObj = (await fse.readJson(path.resolve(projectDir, 'package.json'))) as {\n    dependencies?: Record<string, string>\n  }\n  if (!packageObj?.dependencies) {\n    throw new Error('No package.json found in this project')\n  }\n\n  const payloadVersion = packageObj.dependencies?.payload\n  if (!payloadVersion) {\n    throw new Error('Payload is not installed in this project')\n  }\n\n  const packageManager = await getPackageManager({ projectDir })\n\n  // Fetch latest Payload version\n  const latestPayloadVersion = await getLatestPackageVersion({ packageName: 'payload' })\n\n  if (payloadVersion === latestPayloadVersion) {\n    return { message: `Payload v${payloadVersion} is already up to date.`, success: true }\n  }\n\n  // Update all existing Payload packages\n  const payloadPackages = Object.keys(packageObj.dependencies).filter((dep) =>\n    dep.startsWith('@payloadcms/'),\n  )\n\n  const packageNames = ['payload', ...payloadPackages]\n\n  const packagesToUpdate = packageNames.map((pkg) => `${pkg}@${latestPayloadVersion}`)\n\n  info(`Using ${packageManager}.\\n`)\n  info(\n    `Updating ${packagesToUpdate.length} Payload packages to v${latestPayloadVersion}...\\n\\n${packageNames.map((p) => `  - ${p}`).join('\\n')}`,\n  )\n\n  const { success: updateSuccess } = await installPackages({\n    packageManager,\n    packagesToInstall: packagesToUpdate,\n    projectDir,\n  })\n\n  if (!updateSuccess) {\n    throw new Error('Failed to update Payload packages')\n  }\n  info('Payload packages updated successfully.')\n\n  info(`Updating Payload Next.js files...`)\n\n  const templateFilesPath =\n    process.env.JEST_WORKER_ID !== undefined\n      ? path.resolve(dirname, '../../../../templates/blank')\n      : path.resolve(dirname, '../..', 'dist/template')\n\n  const templateSrcDir = path.resolve(templateFilesPath, 'src/app/(payload)')\n\n  copyRecursiveSync(\n    templateSrcDir,\n    path.resolve(projectDir, appDetails.isSrcDir ? 'src/app' : 'app', '(payload)'),\n    ['custom.scss$'], // Do not overwrite user's custom.scss\n  )\n\n  return { message: 'Payload updated successfully.', success: true }\n}\n"],"names":["fse","fileURLToPath","path","filename","url","dirname","copyRecursiveSync","getLatestPackageVersion","info","getPackageManager","installPackages","updatePayloadInProject","appDetails","nextConfigPath","message","success","projectDir","packageObj","readJson","resolve","dependencies","Error","payloadVersion","payload","packageManager","latestPayloadVersion","packageName","payloadPackages","Object","keys","filter","dep","startsWith","packageNames","packagesToUpdate","map","pkg","length","p","join","updateSuccess","packagesToInstall","templateFilesPath","process","env","JEST_WORKER_ID","undefined","templateSrcDir","isSrcDir"],"mappings":"AAAA,OAAOA,SAAS,WAAU;AAC1B,SAASC,aAAa,QAAQ,WAAU;AACxC,OAAOC,UAAU,OAAM;AAEvB,MAAMC,WAAWF,cAAc,YAAYG,GAAG;AAC9C,MAAMC,UAAUH,KAAKG,OAAO,CAACF;AAI7B,SAASG,iBAAiB,QAAQ,kCAAiC;AACnE,SAASC,uBAAuB,QAAQ,sCAAqC;AAC7E,SAASC,IAAI,QAAQ,kBAAiB;AACtC,SAASC,iBAAiB,QAAQ,2BAA0B;AAC5D,SAASC,eAAe,QAAQ,wBAAuB;AAEvD,OAAO,eAAeC,uBACpBC,UAA0B;IAE1B,IAAI,CAACA,WAAWC,cAAc,EAAE;QAC9B,OAAO;YAAEC,SAAS;YAA2BC,SAAS;QAAM;IAC9D;IAEA,MAAMC,aAAad,KAAKG,OAAO,CAACO,WAAWC,cAAc;IAEzD,MAAMI,aAAc,MAAMjB,IAAIkB,QAAQ,CAAChB,KAAKiB,OAAO,CAACH,YAAY;IAGhE,IAAI,CAACC,YAAYG,cAAc;QAC7B,MAAM,IAAIC,MAAM;IAClB;IAEA,MAAMC,iBAAiBL,WAAWG,YAAY,EAAEG;IAChD,IAAI,CAACD,gBAAgB;QACnB,MAAM,IAAID,MAAM;IAClB;IAEA,MAAMG,iBAAiB,MAAMf,kBAAkB;QAAEO;IAAW;IAE5D,+BAA+B;IAC/B,MAAMS,uBAAuB,MAAMlB,wBAAwB;QAAEmB,aAAa;IAAU;IAEpF,IAAIJ,mBAAmBG,sBAAsB;QAC3C,OAAO;YAAEX,SAAS,CAAC,SAAS,EAAEQ,eAAe,uBAAuB,CAAC;YAAEP,SAAS;QAAK;IACvF;IAEA,uCAAuC;IACvC,MAAMY,kBAAkBC,OAAOC,IAAI,CAACZ,WAAWG,YAAY,EAAEU,MAAM,CAAC,CAACC,MACnEA,IAAIC,UAAU,CAAC;IAGjB,MAAMC,eAAe;QAAC;WAAcN;KAAgB;IAEpD,MAAMO,mBAAmBD,aAAaE,GAAG,CAAC,CAACC,MAAQ,GAAGA,IAAI,CAAC,EAAEX,sBAAsB;IAEnFjB,KAAK,CAAC,MAAM,EAAEgB,eAAe,GAAG,CAAC;IACjChB,KACE,CAAC,SAAS,EAAE0B,iBAAiBG,MAAM,CAAC,sBAAsB,EAAEZ,qBAAqB,OAAO,EAAEQ,aAAaE,GAAG,CAAC,CAACG,IAAM,CAAC,IAAI,EAAEA,GAAG,EAAEC,IAAI,CAAC,OAAO;IAG5I,MAAM,EAAExB,SAASyB,aAAa,EAAE,GAAG,MAAM9B,gBAAgB;QACvDc;QACAiB,mBAAmBP;QACnBlB;IACF;IAEA,IAAI,CAACwB,eAAe;QAClB,MAAM,IAAInB,MAAM;IAClB;IACAb,KAAK;IAELA,KAAK,CAAC,iCAAiC,CAAC;IAExC,MAAMkC,oBACJC,QAAQC,GAAG,CAACC,cAAc,KAAKC,YAC3B5C,KAAKiB,OAAO,CAACd,SAAS,iCACtBH,KAAKiB,OAAO,CAACd,SAAS,SAAS;IAErC,MAAM0C,iBAAiB7C,KAAKiB,OAAO,CAACuB,mBAAmB;IAEvDpC,kBACEyC,gBACA7C,KAAKiB,OAAO,CAACH,YAAYJ,WAAWoC,QAAQ,GAAG,YAAY,OAAO,cAClE;QAAC;KAAe;IAGlB,OAAO;QAAElC,SAAS;QAAiCC,SAAS;IAAK;AACnE"}