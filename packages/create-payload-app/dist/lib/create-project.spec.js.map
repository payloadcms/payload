{"version":3,"sources":["../../src/lib/create-project.spec.ts"],"sourcesContent":["import fs from 'fs'\nimport fse from 'fs-extra'\nimport globby from 'globby'\nimport * as os from 'node:os'\nimport path from 'path'\nimport { afterEach, beforeAll, beforeEach, describe, expect, it, vitest } from 'vitest'\nimport type { CliArgs, DbType, ProjectExample, ProjectTemplate } from '../types.js'\n\nimport { createProject, updatePackageJSONDependencies } from './create-project.js'\nimport { getValidTemplates } from './templates.js'\n\ndescribe('createProject', () => {\n  let projectDir: string\n\n  beforeAll(() => {\n    // eslint-disable-next-line no-console\n    console.log = vitest.fn()\n  })\n\n  beforeEach(() => {\n    const tempDirectory = fs.realpathSync(os.tmpdir())\n    projectDir = `${tempDirectory}/${Math.random().toString(36).substring(7)}`\n  })\n\n  afterEach(() => {\n    if (fse.existsSync(projectDir)) {\n      fse.rmSync(projectDir, { recursive: true })\n    }\n  })\n\n  describe('#createProject', () => {\n    const args = {\n      _: ['project-name'],\n      '--db': 'mongodb',\n      '--local-template': 'blank',\n      '--no-deps': true,\n    } as CliArgs\n    const packageManager = 'yarn'\n\n    it('creates plugin template', async () => {\n      const projectName = 'plugin'\n      const template: ProjectTemplate = {\n        name: 'plugin',\n        type: 'plugin',\n        description: 'Template for creating a Payload plugin',\n        url: 'https://github.com/payloadcms/payload/templates/plugin',\n      }\n\n      await createProject({\n        cliArgs: { ...args, '--local-template': 'plugin' } as CliArgs,\n        packageManager,\n        projectDir,\n        projectName,\n        template,\n      })\n\n      const packageJsonPath = path.resolve(projectDir, 'package.json')\n      const packageJson = fse.readJsonSync(packageJsonPath)\n\n      // Check package name and description\n      expect(packageJson.name).toStrictEqual(projectName)\n    })\n\n    it('updates project name in plugin template importMap file', async () => {\n      const projectName = 'my-custom-plugin'\n      const template: ProjectTemplate = {\n        name: 'plugin',\n        type: 'plugin',\n        description: 'Template for creating a Payload plugin',\n        url: 'https://github.com/payloadcms/payload/templates/plugin',\n      }\n\n      await createProject({\n        cliArgs: { ...args, '--local-template': 'plugin' } as CliArgs,\n        packageManager,\n        projectDir,\n        projectName,\n        template,\n      })\n\n      const importMapPath = path.resolve(projectDir, './dev/app/(payload)/admin/importMap.js')\n      const importMapFile = fse.readFileSync(importMapPath, 'utf-8')\n\n      expect(importMapFile).not.toContain('plugin-package-name-placeholder')\n      expect(importMapFile).toContain('my-custom-plugin')\n    })\n\n    it('creates example', async () => {\n      const projectName = 'custom-server-example'\n      const example: ProjectExample = {\n        name: 'custom-server',\n        url: 'https://github.com/payloadcms/payload/examples/custom-server#main',\n      }\n\n      await createProject({\n        cliArgs: {\n          ...args,\n          '--local-template': undefined,\n          '--local-example': 'custom-server',\n        } as CliArgs,\n        packageManager,\n        projectDir,\n        projectName,\n        example,\n      })\n\n      const packageJsonPath = path.resolve(projectDir, 'package.json')\n      const packageJson = fse.readJsonSync(packageJsonPath)\n\n      // Check package name and description\n      expect(packageJson.name).toStrictEqual(projectName)\n    }, 90_000)\n\n    describe('creates project from template', () => {\n      const templates = getValidTemplates()\n\n      it.each([\n        ['blank', 'mongodb'],\n        ['blank', 'postgres'],\n\n        // TODO: Re-enable these once 3.0 is stable and templates updated\n        // ['website', 'mongodb'],\n        // ['website', 'postgres'],\n        // ['ecommerce', 'mongodb'],\n        // ['ecommerce', 'postgres'],\n      ])('update config and deps: %s, %s', async (templateName, db) => {\n        const projectName = 'starter-project'\n\n        const template = templates.find((t) => t.name === templateName)\n\n        const cliArgs = {\n          ...args,\n          '--db': db,\n          '--local-template': templateName,\n        } as CliArgs\n\n        await createProject({\n          cliArgs,\n          dbDetails: {\n            type: db as DbType,\n            dbUri: `${db}://localhost:27017/create-project-test`,\n          },\n          packageManager,\n          projectDir,\n          projectName,\n          template: template as ProjectTemplate,\n        })\n\n        const packageJsonPath = path.resolve(projectDir, 'package.json')\n        const packageJson = fse.readJsonSync(packageJsonPath)\n\n        // Verify git was initialized\n        expect(fse.existsSync(path.resolve(projectDir, '.git'))).toBe(true)\n\n        // Should only have one db adapter\n        expect(\n          Object.keys(packageJson.dependencies).filter((n) => n.startsWith('@payloadcms/db-')),\n        ).toHaveLength(1)\n\n        const payloadConfigPath = (\n          await globby('**/payload.config.ts', {\n            absolute: true,\n            cwd: projectDir,\n          })\n        )?.[0]\n\n        const content = fse.readFileSync(payloadConfigPath, 'utf-8')\n\n        // Check payload.config.ts doesn't have placeholder comments\n        expect(content).not.toContain('// database-adapter-import')\n        expect(content).not.toContain('// database-adapter-config-start')\n        expect(content).not.toContain('// database-adapter-config-end')\n\n        // Verify correct adapter import and usage based on db type\n        if (db === 'mongodb') {\n          expect(content).toContain(\"import { mongooseAdapter } from '@payloadcms/db-mongodb'\")\n          expect(content).toContain('mongooseAdapter')\n        } else if (db === 'postgres') {\n          expect(content).toContain(\"import { postgresAdapter } from '@payloadcms/db-postgres'\")\n          expect(content).toContain('postgresAdapter')\n        }\n      })\n    })\n\n    describe('updates package.json', () => {\n      it('updates package name and bumps workspace versions', async () => {\n        const latestVersion = '3.0.0'\n        const initialJSON = {\n          name: 'test-project',\n          version: '1.0.0',\n          dependencies: {\n            '@payloadcms/db-mongodb': 'workspace:*',\n            payload: 'workspace:*',\n            '@payloadcms/ui': 'workspace:*',\n          },\n        }\n\n        const correctlyModifiedJSON = {\n          name: 'test-project',\n          version: '1.0.0',\n          dependencies: {\n            '@payloadcms/db-mongodb': `${latestVersion}`,\n            payload: `${latestVersion}`,\n            '@payloadcms/ui': `${latestVersion}`,\n          },\n        }\n\n        updatePackageJSONDependencies({\n          latestVersion,\n          packageJson: initialJSON,\n        })\n\n        expect(initialJSON).toEqual(correctlyModifiedJSON)\n      })\n    })\n  })\n})\n"],"names":["fs","fse","globby","os","path","afterEach","beforeAll","beforeEach","describe","expect","it","vitest","createProject","updatePackageJSONDependencies","getValidTemplates","projectDir","console","log","fn","tempDirectory","realpathSync","tmpdir","Math","random","toString","substring","existsSync","rmSync","recursive","args","_","packageManager","projectName","template","name","type","description","url","cliArgs","packageJsonPath","resolve","packageJson","readJsonSync","toStrictEqual","importMapPath","importMapFile","readFileSync","not","toContain","example","undefined","templates","each","templateName","db","find","t","dbDetails","dbUri","toBe","Object","keys","dependencies","filter","n","startsWith","toHaveLength","payloadConfigPath","absolute","cwd","content","latestVersion","initialJSON","version","payload","correctlyModifiedJSON","toEqual"],"mappings":"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"}