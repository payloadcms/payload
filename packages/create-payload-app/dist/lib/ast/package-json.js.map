{"version":3,"sources":["../../../src/lib/ast/package-json.ts"],"sourcesContent":["import * as fs from 'fs'\n\nimport type { DatabaseAdapter, StorageAdapter } from './types.js'\n\nimport { debug } from '../../utils/log.js'\nimport { getDbPackageName, getStoragePackageName } from './adapter-config.js'\nimport { ALL_DATABASE_ADAPTERS, ALL_STORAGE_ADAPTERS } from './types.js'\n\ntype PackageJsonTransformOptions = {\n  databaseAdapter?: DatabaseAdapter\n  packageName?: string\n  removeSharp?: boolean\n  storageAdapter?: StorageAdapter\n}\n\ntype PackageJsonStructure = {\n  [key: string]: unknown\n  dependencies?: Record<string, string>\n  devDependencies?: Record<string, string>\n  name?: string\n}\n\n/**\n * Main orchestration function\n */\nexport function updatePackageJson(filePath: string, options: PackageJsonTransformOptions): void {\n  debug(`[AST] Updating package.json: ${filePath}`)\n\n  // Phase 1: Detection\n  const pkg = parsePackageJson(filePath)\n\n  // Phase 2: Transformation\n  const transformed = transformPackageJson(pkg, options)\n\n  // Phase 3: Modification\n  writePackageJson(filePath, transformed)\n\n  debug('[AST] âœ“ package.json updated successfully')\n}\n\n// Helper functions\n\nfunction parsePackageJson(filePath: string): PackageJsonStructure {\n  const content = fs.readFileSync(filePath, 'utf-8')\n  return JSON.parse(content)\n}\n\n/**\n *  Transforms the package.json based upon provided options\n */\nfunction transformPackageJson(\n  pkg: PackageJsonStructure,\n  options: PackageJsonTransformOptions,\n): PackageJsonStructure {\n  const transformed = { ...pkg }\n\n  // Update database adapter\n  if (options.databaseAdapter) {\n    debug(`[AST] Updating package.json database adapter to: ${options.databaseAdapter}`)\n\n    transformed.dependencies = { ...transformed.dependencies }\n\n    const removedAdapters: string[] = []\n    ALL_DATABASE_ADAPTERS.forEach((adapter) => {\n      const pkgName = getDbPackageName(adapter)\n      if (transformed.dependencies![pkgName]) {\n        removedAdapters.push(pkgName)\n      }\n      delete transformed.dependencies![pkgName]\n    })\n\n    if (removedAdapters.length > 0) {\n      debug(`[AST] Removed old adapter packages: ${removedAdapters.join(', ')}`)\n    }\n\n    // Add new adapter\n    const dbAdapterPackageName = getDbPackageName(options.databaseAdapter)\n    const payloadVersion = transformed.dependencies?.payload || '^3.0.0'\n    transformed.dependencies[dbAdapterPackageName] = payloadVersion\n\n    debug(`[AST] Added adapter package: ${dbAdapterPackageName}`)\n  }\n\n  // Update storage adapter\n  if (options.storageAdapter) {\n    debug(`[AST] Updating package.json storage adapter to: ${options.storageAdapter}`)\n\n    transformed.dependencies = { ...transformed.dependencies }\n\n    const removedAdapters: string[] = []\n    ALL_STORAGE_ADAPTERS.forEach((adapter) => {\n      const pkgName = getStoragePackageName(adapter)\n      if (pkgName && transformed.dependencies![pkgName]) {\n        removedAdapters.push(pkgName)\n      }\n      if (pkgName) {\n        delete transformed.dependencies![pkgName]\n      }\n    })\n\n    if (removedAdapters.length > 0) {\n      debug(`[AST] Removed old storage adapter packages: ${removedAdapters.join(', ')}`)\n    }\n\n    // Add new storage adapter (if not localDisk)\n    const storagePackageName = getStoragePackageName(options.storageAdapter)\n    if (storagePackageName) {\n      const payloadVersion = transformed.dependencies?.payload || '^3.0.0'\n      transformed.dependencies[storagePackageName] = payloadVersion\n      debug(`[AST] Added storage adapter package: ${storagePackageName}`)\n    } else {\n      debug(`[AST] Storage adapter is localDisk, no package needed`)\n    }\n  }\n\n  // Remove sharp\n  if (options.removeSharp && transformed.dependencies) {\n    transformed.dependencies = { ...transformed.dependencies }\n    if (transformed.dependencies.sharp) {\n      delete transformed.dependencies.sharp\n      debug('[AST] Removed sharp dependency')\n    } else {\n      debug('[AST] Sharp dependency not found (already absent)')\n    }\n  }\n\n  // Update package name\n  if (options.packageName) {\n    debug(`[AST] Updated package name to: ${options.packageName}`)\n    transformed.name = options.packageName\n  }\n\n  return transformed\n}\n\nfunction writePackageJson(filePath: string, pkg: PackageJsonStructure): void {\n  fs.writeFileSync(filePath, JSON.stringify(pkg, null, 2) + '\\n')\n}\n"],"names":["fs","debug","getDbPackageName","getStoragePackageName","ALL_DATABASE_ADAPTERS","ALL_STORAGE_ADAPTERS","updatePackageJson","filePath","options","pkg","parsePackageJson","transformed","transformPackageJson","writePackageJson","content","readFileSync","JSON","parse","databaseAdapter","dependencies","removedAdapters","forEach","adapter","pkgName","push","length","join","dbAdapterPackageName","payloadVersion","payload","storageAdapter","storagePackageName","removeSharp","sharp","packageName","name","writeFileSync","stringify"],"mappings":"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"}