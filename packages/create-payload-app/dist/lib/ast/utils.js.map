{"version":3,"sources":["../../../src/lib/ast/utils.ts"],"sourcesContent":["import type { ImportDeclaration, SourceFile } from 'ts-morph'\n\nimport { existsSync } from 'fs'\nimport path from 'path'\n\nimport type {\n  DetectionError,\n  ImportCleanupResult,\n  ImportRemovalResult,\n  NamedImportRemovalResult,\n} from './types.js'\n\nimport { debug } from '../../utils/log.js'\n\nexport function findImportDeclaration({\n  moduleSpecifier,\n  sourceFile,\n}: {\n  moduleSpecifier: string\n  sourceFile: SourceFile\n}): ImportDeclaration | undefined {\n  return sourceFile\n    .getImportDeclarations()\n    .find((imp) => imp.getModuleSpecifierValue() === moduleSpecifier)\n}\n\ntype FormatErrorOptions = {\n  actual: string\n  context: string\n  debugInfo?: Record<string, unknown>\n  expected: string\n  technicalDetails: string\n}\n\nexport function formatError(options: FormatErrorOptions): DetectionError {\n  const { actual, context, debugInfo, expected, technicalDetails } = options\n\n  const userMessage = `Your config file doesn't match the expected structure for ${context}.\n\nExpected: ${expected}\nActual: ${actual}\n\nPlease ensure your config file follows the expected structure.`\n\n  return {\n    technicalDetails,\n    userMessage,\n    ...(debugInfo && { debugInfo }),\n  }\n}\n\nexport function addImportDeclaration({\n  defaultImport,\n  insertIndex,\n  moduleSpecifier,\n  namedImports,\n  sourceFile,\n}: {\n  defaultImport?: string\n  insertIndex?: number\n  moduleSpecifier: string\n  namedImports?: string[]\n  sourceFile: SourceFile\n}): SourceFile {\n  const existingImport = findImportDeclaration({ moduleSpecifier, sourceFile })\n\n  if (existingImport) {\n    // Add named imports to existing import if they don't exist\n    if (namedImports) {\n      const existingNamedImports = existingImport.getNamedImports().map((ni) => ni.getName())\n      const newNamedImports = namedImports.filter((ni) => !existingNamedImports.includes(ni))\n\n      if (newNamedImports.length > 0) {\n        existingImport.addNamedImports(newNamedImports)\n        debug(\n          `[AST] Added named imports to existing import from '${moduleSpecifier}': ${newNamedImports.join(', ')}`,\n        )\n      } else {\n        debug(`[AST] Import from '${moduleSpecifier}' already has all required named imports`)\n      }\n    }\n  } else {\n    // Create new import at specified index or at default position\n    const importDeclaration = {\n      moduleSpecifier,\n      ...(namedImports && { namedImports }),\n      ...(defaultImport && { defaultImport }),\n    }\n\n    if (insertIndex !== undefined) {\n      sourceFile.insertImportDeclaration(insertIndex, importDeclaration)\n      debug(`[AST] Inserted import from '${moduleSpecifier}' at index ${insertIndex}`)\n    } else {\n      sourceFile.addImportDeclaration(importDeclaration)\n      debug(`[AST] Added import from '${moduleSpecifier}' at default position`)\n    }\n\n    const parts = []\n    if (defaultImport) {\n      parts.push(`default: ${defaultImport}`)\n    }\n    if (namedImports) {\n      parts.push(`named: ${namedImports.join(', ')}`)\n    }\n    debug(`[AST] Import contents: ${parts.join(', ')}`)\n  }\n\n  return sourceFile\n}\n\nexport function removeImportDeclaration({\n  moduleSpecifier,\n  sourceFile,\n}: {\n  moduleSpecifier: string\n  sourceFile: SourceFile\n}): ImportRemovalResult {\n  const importDecl = findImportDeclaration({ moduleSpecifier, sourceFile })\n  if (importDecl) {\n    // Get index before removing\n    const allImports = sourceFile.getImportDeclarations()\n    const index = allImports.indexOf(importDecl)\n    importDecl.remove()\n    debug(`[AST] Removed import from '${moduleSpecifier}' at index ${index}`)\n    return { removedIndex: index, sourceFile }\n  } else {\n    debug(`[AST] Import from '${moduleSpecifier}' not found (already absent)`)\n    return { removedIndex: undefined, sourceFile }\n  }\n}\n\n/**\n * Remove specific named imports from an import declaration\n * If all named imports are removed, removes the entire declaration\n */\nexport function removeNamedImports({\n  importDeclaration,\n  namedImportsToRemove,\n  sourceFile,\n}: {\n  importDeclaration: ImportDeclaration\n  namedImportsToRemove: string[]\n  sourceFile: SourceFile\n}): NamedImportRemovalResult {\n  const namedImports = importDeclaration.getNamedImports()\n  const remainingImports = namedImports.filter((ni) => !namedImportsToRemove.includes(ni.getName()))\n\n  const moduleSpecifier = importDeclaration.getModuleSpecifierValue()\n\n  debug(\n    `[AST] Removing named imports [${namedImportsToRemove.join(', ')}] from '${moduleSpecifier}'`,\n  )\n  debug(`[AST] Remaining imports: ${remainingImports.length}`)\n\n  if (remainingImports.length === 0 && !importDeclaration.getDefaultImport()) {\n    // No imports left, remove entire declaration\n    const allImports = sourceFile.getImportDeclarations()\n    const index = allImports.indexOf(importDeclaration)\n    importDeclaration.remove()\n    debug(`[AST] ✓ Removed entire import from '${moduleSpecifier}' (no remaining imports)`)\n    return { fullyRemoved: true, index, sourceFile }\n  } else {\n    // Remove specific named imports\n    namedImports.forEach((ni) => {\n      if (namedImportsToRemove.includes(ni.getName())) {\n        ni.remove()\n      }\n    })\n    debug(\n      `[AST] ✓ Removed named imports, kept ${remainingImports.length} import(s) from '${moduleSpecifier}'`,\n    )\n    return { fullyRemoved: false, sourceFile }\n  }\n}\n\n/**\n * Check if a named import is used in the source file\n */\nexport function isNamedImportUsed(\n  sourceFile: SourceFile,\n  importName: string,\n  excludeImports = true,\n): boolean {\n  const fullText = sourceFile.getFullText()\n\n  if (excludeImports) {\n    // Remove import declarations from consideration\n    const imports = sourceFile.getImportDeclarations()\n    let textWithoutImports = fullText\n\n    imports.forEach((imp) => {\n      const importText = imp.getFullText()\n      textWithoutImports = textWithoutImports.replace(importText, '')\n    })\n\n    // Check if import name appears in code (not in imports)\n    // Use word boundary to avoid partial matches\n    const regex = new RegExp(`\\\\b${importName}\\\\b`)\n    return regex.test(textWithoutImports)\n  }\n\n  // Simple check including imports\n  const regex = new RegExp(`\\\\b${importName}\\\\b`)\n  return regex.test(fullText)\n}\n\n/**\n * Clean up orphaned imports - remove imports that are no longer used\n */\nexport function cleanupOrphanedImports({\n  importNames,\n  moduleSpecifier,\n  sourceFile: inputSourceFile,\n}: {\n  importNames: string[]\n  moduleSpecifier: string\n  sourceFile: SourceFile\n}): ImportCleanupResult {\n  let sourceFile = inputSourceFile\n  const importDecl = findImportDeclaration({ moduleSpecifier, sourceFile })\n\n  if (!importDecl) {\n    debug(`[AST] No import found from '${moduleSpecifier}' to clean up`)\n    return { kept: [], removed: [], sourceFile }\n  }\n\n  const removed: string[] = []\n  const kept: string[] = []\n\n  for (const importName of importNames) {\n    const isUsed = isNamedImportUsed(sourceFile, importName)\n\n    if (!isUsed) {\n      removed.push(importName)\n      debug(`[AST] Import '${importName}' from '${moduleSpecifier}' is orphaned (not used)`)\n    } else {\n      kept.push(importName)\n      debug(`[AST] Import '${importName}' from '${moduleSpecifier}' is still used`)\n    }\n  }\n\n  if (removed.length > 0) {\n    ;({ sourceFile } = removeNamedImports({\n      importDeclaration: importDecl,\n      namedImportsToRemove: removed,\n      sourceFile,\n    }))\n    debug(`[AST] ✓ Cleaned up ${removed.length} orphaned import(s) from '${moduleSpecifier}'`)\n  }\n\n  return { kept, removed, sourceFile }\n}\n"],"names":["debug","findImportDeclaration","moduleSpecifier","sourceFile","getImportDeclarations","find","imp","getModuleSpecifierValue","formatError","options","actual","context","debugInfo","expected","technicalDetails","userMessage","addImportDeclaration","defaultImport","insertIndex","namedImports","existingImport","existingNamedImports","getNamedImports","map","ni","getName","newNamedImports","filter","includes","length","addNamedImports","join","importDeclaration","undefined","insertImportDeclaration","parts","push","removeImportDeclaration","importDecl","allImports","index","indexOf","remove","removedIndex","removeNamedImports","namedImportsToRemove","remainingImports","getDefaultImport","fullyRemoved","forEach","isNamedImportUsed","importName","excludeImports","fullText","getFullText","imports","textWithoutImports","importText","replace","regex","RegExp","test","cleanupOrphanedImports","importNames","inputSourceFile","kept","removed","isUsed"],"mappings":"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"}