{"version":3,"sources":["../../../src/lib/ast/utils.spec.ts"],"sourcesContent":["import { describe, it, expect } from 'vitest'\nimport { Project } from 'ts-morph'\nimport {\n  addImportDeclaration,\n  cleanupOrphanedImports,\n  findImportDeclaration,\n  isNamedImportUsed,\n  removeImportDeclaration,\n  removeNamedImports,\n} from './utils'\n\ndescribe('findImportDeclaration', () => {\n  it('finds import by module specifier', () => {\n    const project = new Project({ useInMemoryFileSystem: true })\n    const sourceFile = project.createSourceFile(\n      'test.ts',\n      `import { buildConfig } from 'payload'\nimport { mongooseAdapter } from '@payloadcms/db-mongodb'`,\n    )\n\n    const result = findImportDeclaration({ sourceFile, moduleSpecifier: '@payloadcms/db-mongodb' })\n\n    expect(result).toBeDefined()\n    expect(result?.getModuleSpecifierValue()).toBe('@payloadcms/db-mongodb')\n  })\n})\n\ndescribe('addImportDeclaration', () => {\n  it('adds new import when not present', () => {\n    const project = new Project({ useInMemoryFileSystem: true })\n    const sourceFile = project.createSourceFile('test.ts', `import { buildConfig } from 'payload'`)\n\n    const result = addImportDeclaration({\n      sourceFile,\n      moduleSpecifier: '@payloadcms/db-postgres',\n      namedImports: ['postgresAdapter'],\n    })\n\n    const imports = result.getImportDeclarations()\n    expect(imports).toHaveLength(2)\n    expect(imports[1].getModuleSpecifierValue()).toBe('@payloadcms/db-postgres')\n    expect(imports[1].getNamedImports()[0].getName()).toBe('postgresAdapter')\n  })\n\n  it('does not duplicate existing import', () => {\n    const project = new Project({ useInMemoryFileSystem: true })\n    const sourceFile = project.createSourceFile(\n      'test.ts',\n      `import { mongooseAdapter } from '@payloadcms/db-mongodb'`,\n    )\n\n    const result = addImportDeclaration({\n      sourceFile,\n      moduleSpecifier: '@payloadcms/db-mongodb',\n      namedImports: ['mongooseAdapter'],\n    })\n\n    const imports = result.getImportDeclarations()\n    expect(imports).toHaveLength(1)\n  })\n\n  it('adds named import to existing module import', () => {\n    const project = new Project({ useInMemoryFileSystem: true })\n    const sourceFile = project.createSourceFile('test.ts', `import { buildConfig } from 'payload'`)\n\n    const result = addImportDeclaration({\n      sourceFile,\n      moduleSpecifier: 'payload',\n      namedImports: ['Field'],\n    })\n\n    const imports = result.getImportDeclarations()\n    expect(imports).toHaveLength(1)\n    const namedImports = imports[0].getNamedImports().map((ni) => ni.getName())\n    expect(namedImports).toContain('buildConfig')\n    expect(namedImports).toContain('Field')\n  })\n})\n\ndescribe('removeImportDeclaration', () => {\n  it('removes import by module specifier', () => {\n    const project = new Project({ useInMemoryFileSystem: true })\n    const sourceFile = project.createSourceFile(\n      'test.ts',\n      `import { buildConfig } from 'payload'\nimport sharp from 'sharp'`,\n    )\n\n    const result = removeImportDeclaration({ sourceFile, moduleSpecifier: 'sharp' })\n\n    expect(result.removedIndex).toBe(1)\n    const imports = result.sourceFile.getImportDeclarations()\n    expect(imports).toHaveLength(1)\n    expect(imports[0].getModuleSpecifierValue()).toBe('payload')\n  })\n\n  it('returns undefined removedIndex when import not found', () => {\n    const project = new Project({ useInMemoryFileSystem: true })\n    const sourceFile = project.createSourceFile('test.ts', `import { buildConfig } from 'payload'`)\n\n    const result = removeImportDeclaration({ sourceFile, moduleSpecifier: 'sharp' })\n\n    expect(result.removedIndex).toBeUndefined()\n  })\n})\n\ndescribe('removeNamedImports', () => {\n  it('removes specific named imports', () => {\n    const project = new Project({ useInMemoryFileSystem: true })\n    const sourceFile = project.createSourceFile(\n      'test.ts',\n      `import { mongooseAdapter, SomeOtherType } from '@payloadcms/db-mongodb'`,\n    )\n\n    const importDecl = findImportDeclaration({\n      sourceFile,\n      moduleSpecifier: '@payloadcms/db-mongodb',\n    })!\n\n    const result = removeNamedImports({\n      sourceFile,\n      importDeclaration: importDecl,\n      namedImportsToRemove: ['mongooseAdapter'],\n    })\n\n    expect(result.fullyRemoved).toBe(false)\n    const imports = result.sourceFile.getImportDeclarations()\n    expect(imports).toHaveLength(1)\n    const namedImports = imports[0].getNamedImports().map((ni) => ni.getName())\n    expect(namedImports).toEqual(['SomeOtherType'])\n  })\n\n  it('removes entire import when no named imports remain', () => {\n    const project = new Project({ useInMemoryFileSystem: true })\n    const sourceFile = project.createSourceFile(\n      'test.ts',\n      `import { buildConfig } from 'payload'\nimport { mongooseAdapter } from '@payloadcms/db-mongodb'`,\n    )\n\n    const importDecl = findImportDeclaration({\n      sourceFile,\n      moduleSpecifier: '@payloadcms/db-mongodb',\n    })!\n\n    const result = removeNamedImports({\n      sourceFile,\n      importDeclaration: importDecl,\n      namedImportsToRemove: ['mongooseAdapter'],\n    })\n\n    expect(result.fullyRemoved).toBe(true)\n    expect(result.index).toBe(1)\n    const imports = result.sourceFile.getImportDeclarations()\n    expect(imports).toHaveLength(1)\n    expect(imports[0].getModuleSpecifierValue()).toBe('payload')\n  })\n})\n\ndescribe('isNamedImportUsed', () => {\n  it('detects used import in code', () => {\n    const project = new Project({ useInMemoryFileSystem: true })\n    const sourceFile = project.createSourceFile(\n      'test.ts',\n      `import { mongooseAdapter } from '@payloadcms/db-mongodb'\n\nexport default buildConfig({\n  db: mongooseAdapter({ url: '' })\n})`,\n    )\n\n    const isUsed = isNamedImportUsed(sourceFile, 'mongooseAdapter')\n\n    expect(isUsed).toBe(true)\n  })\n\n  it('detects unused import', () => {\n    const project = new Project({ useInMemoryFileSystem: true })\n    const sourceFile = project.createSourceFile(\n      'test.ts',\n      `import { mongooseAdapter } from '@payloadcms/db-mongodb'\nimport { postgresAdapter } from '@payloadcms/db-postgres'\n\nexport default buildConfig({\n  db: postgresAdapter({ url: '' })\n})`,\n    )\n\n    const isUsed = isNamedImportUsed(sourceFile, 'mongooseAdapter')\n\n    expect(isUsed).toBe(false)\n  })\n})\n\ndescribe('cleanupOrphanedImports', () => {\n  it('removes unused imports', () => {\n    const project = new Project({ useInMemoryFileSystem: true })\n    const sourceFile = project.createSourceFile(\n      'test.ts',\n      `import { mongooseAdapter } from '@payloadcms/db-mongodb'\nimport { postgresAdapter } from '@payloadcms/db-postgres'\n\nexport default buildConfig({\n  db: postgresAdapter({ url: '' })\n})`,\n    )\n\n    const result = cleanupOrphanedImports({\n      sourceFile,\n      moduleSpecifier: '@payloadcms/db-mongodb',\n      importNames: ['mongooseAdapter'],\n    })\n\n    expect(result.removed).toEqual(['mongooseAdapter'])\n    expect(result.kept).toEqual([])\n    const imports = result.sourceFile.getImportDeclarations()\n    expect(imports).toHaveLength(1)\n    expect(imports[0].getModuleSpecifierValue()).toBe('@payloadcms/db-postgres')\n  })\n\n  it('keeps used imports', () => {\n    const project = new Project({ useInMemoryFileSystem: true })\n    const sourceFile = project.createSourceFile(\n      'test.ts',\n      `import { mongooseAdapter } from '@payloadcms/db-mongodb'\n\nexport default buildConfig({\n  db: mongooseAdapter({ url: '' })\n})`,\n    )\n\n    const result = cleanupOrphanedImports({\n      sourceFile,\n      moduleSpecifier: '@payloadcms/db-mongodb',\n      importNames: ['mongooseAdapter'],\n    })\n\n    expect(result.removed).toEqual([])\n    expect(result.kept).toEqual(['mongooseAdapter'])\n    const imports = result.sourceFile.getImportDeclarations()\n    expect(imports).toHaveLength(1)\n  })\n})\n"],"names":["describe","it","expect","Project","addImportDeclaration","cleanupOrphanedImports","findImportDeclaration","isNamedImportUsed","removeImportDeclaration","removeNamedImports","project","useInMemoryFileSystem","sourceFile","createSourceFile","result","moduleSpecifier","toBeDefined","getModuleSpecifierValue","toBe","namedImports","imports","getImportDeclarations","toHaveLength","getNamedImports","getName","map","ni","toContain","removedIndex","toBeUndefined","importDecl","importDeclaration","namedImportsToRemove","fullyRemoved","toEqual","index","isUsed","importNames","removed","kept"],"mappings":"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"}