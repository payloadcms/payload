{"version":3,"sources":["../../src/lib/create-project.ts"],"sourcesContent":["import * as p from '@clack/prompts'\nimport chalk from 'chalk'\nimport execa from 'execa'\nimport fse from 'fs-extra'\nimport { fileURLToPath } from 'node:url'\nimport path from 'path'\n\nimport type {\n  CliArgs,\n  DbDetails,\n  PackageManager,\n  ProjectExample,\n  ProjectTemplate,\n} from '../types.js'\n\nimport { tryInitRepoAndCommit } from '../utils/git.js'\nimport { debug, error, info, warning } from '../utils/log.js'\nimport { configurePayloadConfig } from './configure-payload-config.js'\nimport { configurePluginProject } from './configure-plugin-project.js'\nimport { downloadExample } from './download-example.js'\nimport { downloadTemplate } from './download-template.js'\nimport { generateSecret } from './generate-secret.js'\nimport { manageEnvFiles } from './manage-env-files.js'\n\nconst filename = fileURLToPath(import.meta.url)\nconst dirname = path.dirname(filename)\n\nasync function createOrFindProjectDir(projectDir: string): Promise<void> {\n  const pathExists = await fse.pathExists(projectDir)\n  if (!pathExists) {\n    await fse.mkdir(projectDir)\n  }\n}\n\nasync function installDeps(args: {\n  cliArgs: CliArgs\n  packageManager: PackageManager\n  projectDir: string\n}): Promise<boolean> {\n  const { cliArgs, packageManager, projectDir } = args\n  if (cliArgs['--no-deps']) {\n    return true\n  }\n  let installCmd = 'npm install --legacy-peer-deps'\n\n  if (packageManager === 'yarn') {\n    installCmd = 'yarn'\n  } else if (packageManager === 'pnpm') {\n    installCmd = 'pnpm install'\n  } else if (packageManager === 'bun') {\n    installCmd = 'bun install'\n  }\n\n  try {\n    await execa.command(installCmd, {\n      cwd: path.resolve(projectDir),\n    })\n    return true\n  } catch (err: unknown) {\n    error(`Error installing dependencies${err instanceof Error ? `: ${err.message}` : ''}.`)\n    return false\n  }\n}\n\ntype TemplateOrExample =\n  | {\n      example: ProjectExample\n    }\n  | {\n      template: ProjectTemplate\n    }\n\nexport async function createProject(\n  args: {\n    cliArgs: CliArgs\n    dbDetails?: DbDetails\n    packageManager: PackageManager\n    projectDir: string\n    projectName: string\n  } & TemplateOrExample,\n): Promise<void> {\n  const { cliArgs, dbDetails, packageManager, projectDir, projectName } = args\n\n  if (cliArgs['--dry-run']) {\n    debug(`Dry run: Creating project in ${chalk.green(projectDir)}`)\n    return\n  }\n\n  await createOrFindProjectDir(projectDir)\n\n  if (cliArgs['--local-example']) {\n    // Copy example from local path. For development purposes.\n    const localExample = path.resolve(dirname, '../../../../examples/', cliArgs['--local-example'])\n    await fse.copy(localExample, projectDir)\n  }\n\n  if (cliArgs['--local-template']) {\n    // Copy template from local path. For development purposes.\n    const localTemplate = path.resolve(\n      dirname,\n      '../../../../templates/',\n      cliArgs['--local-template'],\n    )\n    await fse.copy(localTemplate, projectDir)\n  } else if ('template' in args && 'url' in args.template) {\n    const { template } = args\n    if (cliArgs['--branch']) {\n      template.url = `${template.url.split('#')?.[0]}#${cliArgs['--branch']}`\n    }\n\n    await downloadTemplate({\n      debug: cliArgs['--debug'],\n      projectDir,\n      template,\n    })\n  } else if ('example' in args && 'url' in args.example) {\n    const { example } = args\n    if (cliArgs['--branch']) {\n      example.url = `${example.url.split('#')?.[0]}#${cliArgs['--branch']}`\n    }\n\n    await downloadExample({\n      debug: cliArgs['--debug'],\n      example,\n      projectDir,\n    })\n  }\n\n  const spinner = p.spinner()\n  spinner.start('Checking latest Payload version...')\n\n  // Allows overriding the installed Payload version instead of installing the latest\n  const versionFromCli = cliArgs['--version']\n\n  let payloadVersion: string\n\n  if (versionFromCli) {\n    await verifyVersionForPackage({ version: versionFromCli })\n\n    payloadVersion = versionFromCli\n\n    spinner.stop(`Using provided version of Payload ${payloadVersion}`)\n  } else {\n    payloadVersion = await getLatestPackageVersion({ packageName: 'payload' })\n\n    spinner.stop(`Found latest version of Payload ${payloadVersion}`)\n  }\n\n  await updatePackageJSON({ latestVersion: payloadVersion, projectDir, projectName })\n\n  if ('template' in args) {\n    if (args.template.type === 'plugin') {\n      spinner.message('Configuring Plugin...')\n      configurePluginProject({ projectDirPath: projectDir, projectName })\n    } else {\n      spinner.message('Configuring Payload...')\n      await configurePayloadConfig({\n        dbType: dbDetails?.type,\n        projectDirOrConfigPath: { projectDir },\n      })\n    }\n  }\n\n  await manageEnvFiles({\n    cliArgs,\n    databaseType: dbDetails?.type,\n    databaseUri: dbDetails?.dbUri,\n    payloadSecret: generateSecret(),\n    projectDir,\n    template: 'template' in args ? args.template : undefined,\n  })\n\n  // Remove yarn.lock file. This is only desired in Payload Cloud.\n  const lockPath = path.resolve(projectDir, 'pnpm-lock.yaml')\n  if (fse.existsSync(lockPath)) {\n    await fse.remove(lockPath)\n  }\n\n  if (!cliArgs['--no-deps']) {\n    info(`Using ${packageManager}.\\n`)\n    spinner.message('Installing dependencies...')\n    const result = await installDeps({ cliArgs, packageManager, projectDir })\n    if (result) {\n      spinner.stop('Successfully installed Payload and dependencies')\n    } else {\n      spinner.stop('Error installing dependencies', 1)\n    }\n  } else {\n    spinner.stop('Dependency installation skipped')\n  }\n\n  if (!cliArgs['--no-git']) {\n    tryInitRepoAndCommit({ cwd: projectDir })\n  }\n}\n\n/**\n * Reads the package.json file into an object and then does the following:\n * - Sets the `name` property to the provided `projectName`.\n * - Bumps the payload packages from workspace:* to the latest version.\n * - Writes the updated object back to the package.json file.\n */\nexport async function updatePackageJSON(args: {\n  /**\n   * The latest version of Payload to use in the package.json.\n   */\n  latestVersion: string\n  projectDir: string\n  /**\n   * The name of the project to set in package.json.\n   */\n  projectName: string\n}): Promise<void> {\n  const { latestVersion, projectDir, projectName } = args\n  const packageJsonPath = path.resolve(projectDir, 'package.json')\n  try {\n    const packageObj = await fse.readJson(packageJsonPath)\n    packageObj.name = projectName\n\n    updatePackageJSONDependencies({\n      latestVersion,\n      packageJson: packageObj,\n    })\n\n    await fse.writeJson(packageJsonPath, packageObj, { spaces: 2 })\n  } catch (err: unknown) {\n    warning(`Unable to update name in package.json. ${err instanceof Error ? err.message : ''}`)\n  }\n}\n\n/**\n * Recursively updates a JSON object to replace all instances of `workspace:` with the latest version pinned.\n *\n * Does not return and instead modifies the `packageJson` object in place.\n */\nexport function updatePackageJSONDependencies(args: {\n  latestVersion: string\n  packageJson: Record<string, unknown>\n}): void {\n  const { latestVersion, packageJson } = args\n\n  const updatedDependencies = Object.entries(packageJson.dependencies || {}).reduce(\n    (acc, [key, value]) => {\n      if (typeof value === 'string' && value.startsWith('workspace:')) {\n        acc[key] = `${latestVersion}`\n      } else if (key === 'payload' || key.startsWith('@payloadcms')) {\n        acc[key] = `${latestVersion}`\n      } else {\n        acc[key] = value\n      }\n      return acc\n    },\n    {} as Record<string, string>,\n  )\n  packageJson.dependencies = updatedDependencies\n}\n\n/**\n * Fetches the latest version of a package from the NPM registry.\n *\n * Used in determining the latest version of Payload to use in the generated templates.\n */\nasync function getLatestPackageVersion({\n  packageName = 'payload',\n}: {\n  /**\n   * Package name to fetch the latest version for based on the NPM registry URL\n   *\n   * Eg. for `'payload'`, it will fetch the version from `https://registry.npmjs.org/payload`\n   *\n   * @default 'payload'\n   */\n  packageName?: string\n}): Promise<string> {\n  try {\n    const response = await fetch(`https://registry.npmjs.org/-/package/${packageName}/dist-tags`)\n    const data = await response.json()\n\n    // Monster chaining for type safety just checking for data.latest\n    const latestVersion =\n      data &&\n      typeof data === 'object' &&\n      'latest' in data &&\n      data.latest &&\n      typeof data.latest === 'string'\n        ? data.latest\n        : null\n\n    if (!latestVersion) {\n      throw new Error(`No latest version found for package: ${packageName}`)\n    }\n\n    return latestVersion\n  } catch (error) {\n    console.error('Error fetching Payload version:', error)\n    throw error\n  }\n}\n\n/**\n * Verifies that the specified version of a package exists on the NPM registry.\n *\n * Throws an error if the version does not exist.\n */\nasync function verifyVersionForPackage({\n  packageName = 'payload',\n  version,\n}: {\n  /**\n   * Package name to fetch the latest version for based on the NPM registry URL\n   *\n   * Eg. for `'payload'`, it will fetch the version from `https://registry.npmjs.org/payload`\n   *\n   * @default 'payload'\n   */\n  packageName?: string\n  version: string\n}): Promise<void> {\n  try {\n    const response = await fetch(`https://registry.npmjs.org/${packageName}/${version}`)\n\n    if (response.status !== 200) {\n      throw new Error(`No ${version} version found for package: ${packageName}`)\n    }\n  } catch (error) {\n    console.error('Error verifying Payload version:', error)\n    throw error\n  }\n}\n"],"names":["p","chalk","execa","fse","fileURLToPath","path","tryInitRepoAndCommit","debug","error","info","warning","configurePayloadConfig","configurePluginProject","downloadExample","downloadTemplate","generateSecret","manageEnvFiles","filename","url","dirname","createOrFindProjectDir","projectDir","pathExists","mkdir","installDeps","args","cliArgs","packageManager","installCmd","command","cwd","resolve","err","Error","message","createProject","dbDetails","projectName","green","localExample","copy","localTemplate","template","split","example","spinner","start","versionFromCli","payloadVersion","verifyVersionForPackage","version","stop","getLatestPackageVersion","packageName","updatePackageJSON","latestVersion","type","projectDirPath","dbType","projectDirOrConfigPath","databaseType","databaseUri","dbUri","payloadSecret","undefined","lockPath","existsSync","remove","result","packageJsonPath","packageObj","readJson","name","updatePackageJSONDependencies","packageJson","writeJson","spaces","updatedDependencies","Object","entries","dependencies","reduce","acc","key","value","startsWith","response","fetch","data","json","latest","console","status"],"mappings":"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"}