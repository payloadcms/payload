{"version":3,"sources":["../../src/lib/wrap-next-config.spec.ts"],"sourcesContent":["import * as p from '@clack/prompts'\nimport { describe, it, expect, vitest } from 'vitest'\n\nimport { parseAndModifyConfigContent, withPayloadStatement } from './wrap-next-config.js'\n\nconst tsConfigs = {\n  defaultNextConfig: `import type { NextConfig } from \"next\";\n\nconst nextConfig: NextConfig = {};\nexport default nextConfig;`,\n\n  nextConfigExportNamedDefault: `import type { NextConfig } from \"next\";\nconst nextConfig: NextConfig = {};\nconst wrapped = someFunc(asdf);\nexport { wrapped as default };\n`,\n  nextConfigWithFunc: `import type { NextConfig } from \"next\";\nconst nextConfig: NextConfig = {};\nexport default someFunc(nextConfig);\n`,\n  nextConfigWithFuncMultiline: `import type { NextConfig } from \"next\";\nconst nextConfig: NextConfig = {};\nexport default someFunc(\n  nextConfig\n);\n`,\n  nextConfigWithSpread: `import type { NextConfig } from \"next\";\nconst nextConfig: NextConfig = {\n  ...someConfig,\n};\nexport default nextConfig;\n`,\n}\n\nconst esmConfigs = {\n  defaultNextConfig: `/** @type {import('next').NextConfig} */\nconst nextConfig = {};\nexport default nextConfig;\n`,\n  nextConfigExportNamedDefault: `const nextConfig = {};\nconst wrapped = someFunc(asdf);\nexport { wrapped as default };\n`,\n  nextConfigWithFunc: `const nextConfig = {};\nexport default someFunc(nextConfig);\n`,\n  nextConfigWithFuncMultiline: `const nextConfig = {};;\nexport default someFunc(\n  nextConfig\n);\n`,\n  nextConfigWithSpread: `const nextConfig = {\n  ...someConfig,\n};\nexport default nextConfig;\n`,\n}\n\nconst cjsConfigs = {\n  anonConfig: `module.exports = {};`,\n  defaultNextConfig: `\n  /** @type {import('next').NextConfig} */\nconst nextConfig = {};\nmodule.exports = nextConfig;\n`,\n  nextConfigExportNamedDefault: `const nextConfig = {};\nconst wrapped = someFunc(asdf);\nmodule.exports = wrapped;\n`,\n  nextConfigWithFunc: `const nextConfig = {};\nmodule.exports = someFunc(nextConfig);\n`,\n  nextConfigWithFuncMultiline: `const nextConfig = {};\nmodule.exports = someFunc(\n  nextConfig\n);\n`,\n  nextConfigWithSpread: `const nextConfig = { ...someConfig };\nmodule.exports = nextConfig;\n`,\n}\n\ndescribe('parseAndInsertWithPayload', () => {\n  describe('ts', () => {\n    const configType = 'ts'\n    const importStatement = withPayloadStatement[configType]\n\n    it('should parse the default next config', async () => {\n      const { modifiedConfigContent } = await parseAndModifyConfigContent(\n        tsConfigs.defaultNextConfig,\n        configType,\n      )\n      expect(modifiedConfigContent).toContain(importStatement)\n      expect(modifiedConfigContent).toContain('withPayload(nextConfig)')\n    })\n\n    it('should parse the config with a function', async () => {\n      const { modifiedConfigContent: modifiedConfigContent2 } = await parseAndModifyConfigContent(\n        tsConfigs.nextConfigWithFunc,\n        configType,\n      )\n      expect(modifiedConfigContent2).toContain('withPayload(someFunc(nextConfig))')\n    })\n\n    it('should parse the config with a multi-lined function', async () => {\n      const { modifiedConfigContent } = await parseAndModifyConfigContent(\n        tsConfigs.nextConfigWithFuncMultiline,\n        configType,\n      )\n      expect(modifiedConfigContent).toContain(importStatement)\n      expect(modifiedConfigContent).toMatch(/withPayload\\(someFunc\\(\\n {2}nextConfig\\n\\)\\)/)\n    })\n\n    it('should parse the config with a spread', async () => {\n      const { modifiedConfigContent } = await parseAndModifyConfigContent(\n        tsConfigs.nextConfigWithSpread,\n        configType,\n      )\n      expect(modifiedConfigContent).toContain(importStatement)\n      expect(modifiedConfigContent).toContain('withPayload(nextConfig)')\n    })\n  })\n  describe('esm', () => {\n    const configType = 'esm'\n    const importStatement = withPayloadStatement[configType]\n    it('should parse the default next config', async () => {\n      const { modifiedConfigContent } = await parseAndModifyConfigContent(\n        esmConfigs.defaultNextConfig,\n        configType,\n      )\n      expect(modifiedConfigContent).toContain(importStatement)\n      expect(modifiedConfigContent).toContain('withPayload(nextConfig)')\n    })\n    it('should parse the config with a function', async () => {\n      const { modifiedConfigContent } = await parseAndModifyConfigContent(\n        esmConfigs.nextConfigWithFunc,\n        configType,\n      )\n      expect(modifiedConfigContent).toContain('withPayload(someFunc(nextConfig))')\n    })\n\n    it('should parse the config with a multi-lined function', async () => {\n      const { modifiedConfigContent } = await parseAndModifyConfigContent(\n        esmConfigs.nextConfigWithFuncMultiline,\n        configType,\n      )\n      expect(modifiedConfigContent).toContain(importStatement)\n      expect(modifiedConfigContent).toMatch(/withPayload\\(someFunc\\(\\n {2}nextConfig\\n\\)\\)/)\n    })\n\n    it('should parse the config with a spread', async () => {\n      const { modifiedConfigContent } = await parseAndModifyConfigContent(\n        esmConfigs.nextConfigWithSpread,\n        configType,\n      )\n      expect(modifiedConfigContent).toContain(importStatement)\n      expect(modifiedConfigContent).toContain('withPayload(nextConfig)')\n    })\n\n    // Unsupported: export { wrapped as default }\n    it('should give warning with a named export as default', async () => {\n      const warnLogSpy = vitest.spyOn(p.log, 'warn').mockImplementation(() => {})\n\n      const { modifiedConfigContent, success } = await parseAndModifyConfigContent(\n        esmConfigs.nextConfigExportNamedDefault,\n        configType,\n      )\n      expect(modifiedConfigContent).toContain(importStatement)\n      expect(success).toBe(false)\n\n      expect(warnLogSpy).toHaveBeenCalledWith(\n        expect.stringContaining('Could not automatically wrap'),\n      )\n    })\n  })\n\n  describe('cjs', () => {\n    const configType = 'cjs'\n    const requireStatement = withPayloadStatement[configType]\n    it('should parse the default next config', async () => {\n      const { modifiedConfigContent } = await parseAndModifyConfigContent(\n        cjsConfigs.defaultNextConfig,\n        configType,\n      )\n      expect(modifiedConfigContent).toContain(requireStatement)\n      expect(modifiedConfigContent).toContain('withPayload(nextConfig)')\n    })\n    it('should parse anonymous default config', async () => {\n      const { modifiedConfigContent } = await parseAndModifyConfigContent(\n        cjsConfigs.anonConfig,\n        configType,\n      )\n      expect(modifiedConfigContent).toContain(requireStatement)\n      expect(modifiedConfigContent).toContain('withPayload({})')\n    })\n    it('should parse the config with a function', async () => {\n      const { modifiedConfigContent } = await parseAndModifyConfigContent(\n        cjsConfigs.nextConfigWithFunc,\n        configType,\n      )\n      expect(modifiedConfigContent).toContain('withPayload(someFunc(nextConfig))')\n    })\n    it('should parse the config with a multi-lined function', async () => {\n      const { modifiedConfigContent } = await parseAndModifyConfigContent(\n        cjsConfigs.nextConfigWithFuncMultiline,\n        configType,\n      )\n      expect(modifiedConfigContent).toContain(requireStatement)\n      expect(modifiedConfigContent).toMatch(/withPayload\\(someFunc\\(\\n {2}nextConfig\\n\\)\\)/)\n    })\n    it('should parse the config with a named export as default', async () => {\n      const { modifiedConfigContent } = await parseAndModifyConfigContent(\n        cjsConfigs.nextConfigExportNamedDefault,\n        configType,\n      )\n      expect(modifiedConfigContent).toContain(requireStatement)\n      expect(modifiedConfigContent).toContain('withPayload(wrapped)')\n    })\n\n    it('should parse the config with a spread', async () => {\n      const { modifiedConfigContent } = await parseAndModifyConfigContent(\n        cjsConfigs.nextConfigWithSpread,\n        configType,\n      )\n      expect(modifiedConfigContent).toContain(requireStatement)\n      expect(modifiedConfigContent).toContain('withPayload(nextConfig)')\n    })\n  })\n})\n"],"names":["p","describe","it","expect","vitest","parseAndModifyConfigContent","withPayloadStatement","tsConfigs","defaultNextConfig","nextConfigExportNamedDefault","nextConfigWithFunc","nextConfigWithFuncMultiline","nextConfigWithSpread","esmConfigs","cjsConfigs","anonConfig","configType","importStatement","modifiedConfigContent","toContain","modifiedConfigContent2","toMatch","warnLogSpy","spyOn","log","mockImplementation","success","toBe","toHaveBeenCalledWith","stringContaining","requireStatement"],"mappings":"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"}