{"version":3,"sources":["../../src/lib/manage-env-files.spec.ts"],"sourcesContent":["import fs from 'fs'\nimport fse from 'fs-extra'\nimport * as os from 'node:os'\nimport path from 'path'\nimport { afterEach, beforeAll, beforeEach, describe, expect, it, vitest } from 'vitest'\n\nimport type { CliArgs } from '../types.js'\n\nimport { manageEnvFiles } from './manage-env-files.js'\n\ndescribe('createProject', () => {\n  let projectDir: string\n  let envFilePath = ''\n  let envExampleFilePath = ''\n\n  beforeAll(() => {\n    // eslint-disable-next-line no-console\n    console.log = vitest.fn()\n  })\n\n  beforeEach(() => {\n    const tempDirectory = fs.realpathSync(os.tmpdir())\n    projectDir = `${tempDirectory}/${Math.random().toString(36).substring(7)}`\n\n    envFilePath = path.join(projectDir, '.env')\n    envExampleFilePath = path.join(projectDir, '.env.example')\n\n    if (fse.existsSync(envFilePath)) {\n      fse.removeSync(envFilePath)\n    }\n\n    fse.ensureDirSync(projectDir)\n  })\n\n  afterEach(() => {\n    if (fse.existsSync(projectDir)) {\n      fse.rmSync(projectDir, { recursive: true })\n    }\n  })\n\n  it('generates .env using defaults (not from .env.example)', async () => {\n    // ensure no .env.example exists so that the default values are used\n    // the `manageEnvFiles` function will look for .env.example in the file system\n    if (fse.existsSync(envExampleFilePath)) {\n      fse.removeSync(envExampleFilePath)\n    }\n\n    await manageEnvFiles({\n      cliArgs: {\n        '--debug': true,\n      } as CliArgs,\n      databaseUri: '', // omitting this will ensure the default vars are used\n      payloadSecret: '', // omitting this will ensure the default vars are used\n      projectDir,\n      template: undefined,\n    })\n\n    expect(fse.existsSync(envFilePath)).toBe(true)\n\n    const updatedEnvContent = fse.readFileSync(envFilePath, 'utf-8')\n\n    expect(updatedEnvContent).toBe(\n      `# Added by Payload\\nPAYLOAD_SECRET=YOUR_SECRET_HERE\\nDATABASE_URL=your-connection-string-here`,\n    )\n  })\n\n  it('generates .env from .env.example', async () => {\n    // create or override the .env.example file with a connection string that will NOT be overridden\n    fse.ensureFileSync(envExampleFilePath)\n    fse.writeFileSync(\n      envExampleFilePath,\n      `DATABASE_URL=example-connection-string\\nCUSTOM_VAR=custom-value\\n`,\n    )\n\n    await manageEnvFiles({\n      cliArgs: {\n        '--debug': true,\n      } as CliArgs,\n      databaseUri: '', // omitting this will ensure the `.env.example` vars are used\n      payloadSecret: '', // omitting this will ensure the `.env.example` vars are used\n      projectDir,\n      template: undefined,\n    })\n\n    expect(fse.existsSync(envFilePath)).toBe(true)\n\n    const updatedEnvContent = fse.readFileSync(envFilePath, 'utf-8')\n\n    expect(updatedEnvContent).toBe(\n      `DATABASE_URL=example-connection-string\\nCUSTOM_VAR=custom-value\\nPAYLOAD_SECRET=YOUR_SECRET_HERE\\n# Added by Payload`,\n    )\n  })\n\n  it('updates existing .env without overriding vars', async () => {\n    // create an existing .env file with some custom variables that should NOT be overridden\n    fse.ensureFileSync(envFilePath)\n    fse.writeFileSync(\n      envFilePath,\n      `CUSTOM_VAR=custom-value\\nDATABASE_URL=example-connection-string\\n`,\n    )\n\n    // create an .env.example file to ensure that its contents DO NOT override existing .env vars\n    fse.ensureFileSync(envExampleFilePath)\n    fse.writeFileSync(\n      envExampleFilePath,\n      `CUSTOM_VAR=custom-value-2\\nDATABASE_URL=example-connection-string-2\\n`,\n    )\n\n    await manageEnvFiles({\n      cliArgs: {\n        '--debug': true,\n      } as CliArgs,\n      databaseUri: '', // omitting this will ensure the `.env` vars are kept\n      payloadSecret: '', // omitting this will ensure the `.env` vars are kept\n      projectDir,\n      template: undefined,\n    })\n\n    expect(fse.existsSync(envFilePath)).toBe(true)\n\n    const updatedEnvContent = fse.readFileSync(envFilePath, 'utf-8')\n\n    expect(updatedEnvContent).toBe(\n      `# Added by Payload\\nPAYLOAD_SECRET=YOUR_SECRET_HERE\\nDATABASE_URL=example-connection-string\\nCUSTOM_VAR=custom-value`,\n    )\n  })\n\n  it('sanitizes .env based on selected database type', async () => {\n    await manageEnvFiles({\n      cliArgs: {\n        '--debug': true,\n      } as CliArgs,\n      databaseType: 'mongodb', // this mimics the CLI selection and will be used as the DATABASE_URL\n      databaseUri: 'mongodb://localhost:27017/test', // this mimics the CLI selection and will be used as the DATABASE_URL\n      payloadSecret: 'test-secret', // this mimics the CLI selection and will be used as the PAYLOAD_SECRET\n      projectDir,\n      template: undefined,\n    })\n\n    const updatedEnvContent = fse.readFileSync(envFilePath, 'utf-8')\n\n    expect(updatedEnvContent).toBe(\n      `# Added by Payload\\nPAYLOAD_SECRET=test-secret\\nDATABASE_URL=mongodb://localhost:27017/test`,\n    )\n\n    // delete the generated .env file and do it again, but this time, omit the databaseUri to ensure the default is generated\n    fse.removeSync(envFilePath)\n\n    await manageEnvFiles({\n      cliArgs: {\n        '--debug': true,\n      } as CliArgs,\n      databaseType: 'mongodb', // this mimics the CLI selection and will be used as the DATABASE_URL\n      databaseUri: '', // omit this to ensure the default is generated based on the selected database type\n      payloadSecret: 'test-secret',\n      projectDir,\n      template: undefined,\n    })\n\n    const updatedEnvContentWithDefault = fse.readFileSync(envFilePath, 'utf-8')\n    expect(updatedEnvContentWithDefault).toBe(\n      `# Added by Payload\\nPAYLOAD_SECRET=test-secret\\nDATABASE_URL=mongodb://127.0.0.1/your-database-name`,\n    )\n  })\n})\n"],"names":["fs","fse","os","path","afterEach","beforeAll","beforeEach","describe","expect","it","vitest","manageEnvFiles","projectDir","envFilePath","envExampleFilePath","console","log","fn","tempDirectory","realpathSync","tmpdir","Math","random","toString","substring","join","existsSync","removeSync","ensureDirSync","rmSync","recursive","cliArgs","databaseUri","payloadSecret","template","undefined","toBe","updatedEnvContent","readFileSync","ensureFileSync","writeFileSync","databaseType","updatedEnvContentWithDefault"],"mappings":"AAAA,OAAOA,QAAQ,KAAI;AACnB,OAAOC,SAAS,WAAU;AAC1B,YAAYC,QAAQ,UAAS;AAC7B,OAAOC,UAAU,OAAM;AACvB,SAASC,SAAS,EAAEC,SAAS,EAAEC,UAAU,EAAEC,QAAQ,EAAEC,MAAM,EAAEC,EAAE,EAAEC,MAAM,QAAQ,SAAQ;AAIvF,SAASC,cAAc,QAAQ,wBAAuB;AAEtDJ,SAAS,iBAAiB;IACxB,IAAIK;IACJ,IAAIC,cAAc;IAClB,IAAIC,qBAAqB;IAEzBT,UAAU;QACR,sCAAsC;QACtCU,QAAQC,GAAG,GAAGN,OAAOO,EAAE;IACzB;IAEAX,WAAW;QACT,MAAMY,gBAAgBlB,GAAGmB,YAAY,CAACjB,GAAGkB,MAAM;QAC/CR,aAAa,GAAGM,cAAc,CAAC,EAAEG,KAAKC,MAAM,GAAGC,QAAQ,CAAC,IAAIC,SAAS,CAAC,IAAI;QAE1EX,cAAcV,KAAKsB,IAAI,CAACb,YAAY;QACpCE,qBAAqBX,KAAKsB,IAAI,CAACb,YAAY;QAE3C,IAAIX,IAAIyB,UAAU,CAACb,cAAc;YAC/BZ,IAAI0B,UAAU,CAACd;QACjB;QAEAZ,IAAI2B,aAAa,CAAChB;IACpB;IAEAR,UAAU;QACR,IAAIH,IAAIyB,UAAU,CAACd,aAAa;YAC9BX,IAAI4B,MAAM,CAACjB,YAAY;gBAAEkB,WAAW;YAAK;QAC3C;IACF;IAEArB,GAAG,yDAAyD;QAC1D,oEAAoE;QACpE,8EAA8E;QAC9E,IAAIR,IAAIyB,UAAU,CAACZ,qBAAqB;YACtCb,IAAI0B,UAAU,CAACb;QACjB;QAEA,MAAMH,eAAe;YACnBoB,SAAS;gBACP,WAAW;YACb;YACAC,aAAa;YACbC,eAAe;YACfrB;YACAsB,UAAUC;QACZ;QAEA3B,OAAOP,IAAIyB,UAAU,CAACb,cAAcuB,IAAI,CAAC;QAEzC,MAAMC,oBAAoBpC,IAAIqC,YAAY,CAACzB,aAAa;QAExDL,OAAO6B,mBAAmBD,IAAI,CAC5B,CAAC,6FAA6F,CAAC;IAEnG;IAEA3B,GAAG,oCAAoC;QACrC,gGAAgG;QAChGR,IAAIsC,cAAc,CAACzB;QACnBb,IAAIuC,aAAa,CACf1B,oBACA,CAAC,iEAAiE,CAAC;QAGrE,MAAMH,eAAe;YACnBoB,SAAS;gBACP,WAAW;YACb;YACAC,aAAa;YACbC,eAAe;YACfrB;YACAsB,UAAUC;QACZ;QAEA3B,OAAOP,IAAIyB,UAAU,CAACb,cAAcuB,IAAI,CAAC;QAEzC,MAAMC,oBAAoBpC,IAAIqC,YAAY,CAACzB,aAAa;QAExDL,OAAO6B,mBAAmBD,IAAI,CAC5B,CAAC,oHAAoH,CAAC;IAE1H;IAEA3B,GAAG,iDAAiD;QAClD,wFAAwF;QACxFR,IAAIsC,cAAc,CAAC1B;QACnBZ,IAAIuC,aAAa,CACf3B,aACA,CAAC,iEAAiE,CAAC;QAGrE,6FAA6F;QAC7FZ,IAAIsC,cAAc,CAACzB;QACnBb,IAAIuC,aAAa,CACf1B,oBACA,CAAC,qEAAqE,CAAC;QAGzE,MAAMH,eAAe;YACnBoB,SAAS;gBACP,WAAW;YACb;YACAC,aAAa;YACbC,eAAe;YACfrB;YACAsB,UAAUC;QACZ;QAEA3B,OAAOP,IAAIyB,UAAU,CAACb,cAAcuB,IAAI,CAAC;QAEzC,MAAMC,oBAAoBpC,IAAIqC,YAAY,CAACzB,aAAa;QAExDL,OAAO6B,mBAAmBD,IAAI,CAC5B,CAAC,oHAAoH,CAAC;IAE1H;IAEA3B,GAAG,kDAAkD;QACnD,MAAME,eAAe;YACnBoB,SAAS;gBACP,WAAW;YACb;YACAU,cAAc;YACdT,aAAa;YACbC,eAAe;YACfrB;YACAsB,UAAUC;QACZ;QAEA,MAAME,oBAAoBpC,IAAIqC,YAAY,CAACzB,aAAa;QAExDL,OAAO6B,mBAAmBD,IAAI,CAC5B,CAAC,2FAA2F,CAAC;QAG/F,yHAAyH;QACzHnC,IAAI0B,UAAU,CAACd;QAEf,MAAMF,eAAe;YACnBoB,SAAS;gBACP,WAAW;YACb;YACAU,cAAc;YACdT,aAAa;YACbC,eAAe;YACfrB;YACAsB,UAAUC;QACZ;QAEA,MAAMO,+BAA+BzC,IAAIqC,YAAY,CAACzB,aAAa;QACnEL,OAAOkC,8BAA8BN,IAAI,CACvC,CAAC,mGAAmG,CAAC;IAEzG;AACF"}