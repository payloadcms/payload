{"version":3,"sources":["../../src/lib/configure-payload-config.ts"],"sourcesContent":["import fse from 'fs-extra'\nimport globby from 'globby'\nimport path from 'path'\n\nimport type { DbType, StorageAdapterType } from '../types.js'\n\nimport { warning } from '../utils/log.js'\nimport { updatePackageJson } from './ast/package-json.js'\nimport { configurePayloadConfig as configurePayloadConfigAST } from './ast/payload-config.js'\n\n/** Get default env var name for db type */\nfunction getEnvVarName(dbType: DbType, customEnvName?: string): string {\n  if (customEnvName) {\n    return customEnvName\n  }\n  // Default env var names per adapter type\n  if (dbType === 'vercel-postgres') {\n    return 'POSTGRES_URL'\n  }\n  return 'DATABASE_URL'\n}\n\n/** Update payload config with necessary imports and adapters */\nexport async function configurePayloadConfig(args: {\n  dbType?: DbType\n  envNames?: {\n    dbUri: string\n  }\n  packageJsonName?: string\n  projectDirOrConfigPath: { payloadConfigPath: string } | { projectDir: string }\n  sharp?: boolean\n  storageAdapter?: StorageAdapterType\n}): Promise<void> {\n  if (!args.dbType) {\n    return\n  }\n\n  // Update package.json\n  const packageJsonPath =\n    'projectDir' in args.projectDirOrConfigPath &&\n    path.resolve(args.projectDirOrConfigPath.projectDir, 'package.json')\n\n  if (packageJsonPath && fse.existsSync(packageJsonPath)) {\n    try {\n      updatePackageJson(packageJsonPath, {\n        databaseAdapter: args.dbType,\n        packageName: args.packageJsonName,\n        removeSharp: args.sharp === false,\n        storageAdapter: args.storageAdapter,\n      })\n    } catch (err: unknown) {\n      warning(`Unable to configure Payload in package.json`)\n      warning(err instanceof Error ? err.message : '')\n    }\n  }\n\n  // Update payload.config.ts\n  try {\n    let payloadConfigPath: string | undefined\n    if (!('payloadConfigPath' in args.projectDirOrConfigPath)) {\n      payloadConfigPath = (\n        await globby('**/payload.config.ts', {\n          absolute: true,\n          cwd: args.projectDirOrConfigPath.projectDir,\n        })\n      )?.[0]\n    } else {\n      payloadConfigPath = args.projectDirOrConfigPath.payloadConfigPath\n    }\n\n    if (!payloadConfigPath) {\n      warning('Unable to update payload.config.ts with plugins. Could not find payload.config.ts.')\n      return\n    }\n\n    const envVarName = getEnvVarName(args.dbType, args.envNames?.dbUri)\n\n    const result = await configurePayloadConfigAST(payloadConfigPath, {\n      db: {\n        type: args.dbType,\n        envVarName,\n      },\n      formatWithPrettier: true,\n      removeSharp: args.sharp === false,\n      storage: args.storageAdapter,\n      validateStructure: false,\n    })\n\n    if (!result.success && result.error) {\n      warning(`Unable to update payload.config.ts: ${result.error.userMessage}`)\n    }\n  } catch (err: unknown) {\n    warning(\n      `Unable to update payload.config.ts with plugins: ${err instanceof Error ? err.message : ''}`,\n    )\n  }\n}\n"],"names":["fse","globby","path","warning","updatePackageJson","configurePayloadConfig","configurePayloadConfigAST","getEnvVarName","dbType","customEnvName","args","packageJsonPath","projectDirOrConfigPath","resolve","projectDir","existsSync","databaseAdapter","packageName","packageJsonName","removeSharp","sharp","storageAdapter","err","Error","message","payloadConfigPath","absolute","cwd","envVarName","envNames","dbUri","result","db","type","formatWithPrettier","storage","validateStructure","success","error","userMessage"],"mappings":"AAAA,OAAOA,SAAS,WAAU;AAC1B,OAAOC,YAAY,SAAQ;AAC3B,OAAOC,UAAU,OAAM;AAIvB,SAASC,OAAO,QAAQ,kBAAiB;AACzC,SAASC,iBAAiB,QAAQ,wBAAuB;AACzD,SAASC,0BAA0BC,yBAAyB,QAAQ,0BAAyB;AAE7F,yCAAyC,GACzC,SAASC,cAAcC,MAAc,EAAEC,aAAsB;IAC3D,IAAIA,eAAe;QACjB,OAAOA;IACT;IACA,yCAAyC;IACzC,IAAID,WAAW,mBAAmB;QAChC,OAAO;IACT;IACA,OAAO;AACT;AAEA,8DAA8D,GAC9D,OAAO,eAAeH,uBAAuBK,IAS5C;IACC,IAAI,CAACA,KAAKF,MAAM,EAAE;QAChB;IACF;IAEA,sBAAsB;IACtB,MAAMG,kBACJ,gBAAgBD,KAAKE,sBAAsB,IAC3CV,KAAKW,OAAO,CAACH,KAAKE,sBAAsB,CAACE,UAAU,EAAE;IAEvD,IAAIH,mBAAmBX,IAAIe,UAAU,CAACJ,kBAAkB;QACtD,IAAI;YACFP,kBAAkBO,iBAAiB;gBACjCK,iBAAiBN,KAAKF,MAAM;gBAC5BS,aAAaP,KAAKQ,eAAe;gBACjCC,aAAaT,KAAKU,KAAK,KAAK;gBAC5BC,gBAAgBX,KAAKW,cAAc;YACrC;QACF,EAAE,OAAOC,KAAc;YACrBnB,QAAQ,CAAC,2CAA2C,CAAC;YACrDA,QAAQmB,eAAeC,QAAQD,IAAIE,OAAO,GAAG;QAC/C;IACF;IAEA,2BAA2B;IAC3B,IAAI;QACF,IAAIC;QACJ,IAAI,CAAE,CAAA,uBAAuBf,KAAKE,sBAAsB,AAAD,GAAI;YACzDa,oBACE,CAAA,MAAMxB,OAAO,wBAAwB;gBACnCyB,UAAU;gBACVC,KAAKjB,KAAKE,sBAAsB,CAACE,UAAU;YAC7C,EAAC,GACA,CAAC,EAAE;QACR,OAAO;YACLW,oBAAoBf,KAAKE,sBAAsB,CAACa,iBAAiB;QACnE;QAEA,IAAI,CAACA,mBAAmB;YACtBtB,QAAQ;YACR;QACF;QAEA,MAAMyB,aAAarB,cAAcG,KAAKF,MAAM,EAAEE,KAAKmB,QAAQ,EAAEC;QAE7D,MAAMC,SAAS,MAAMzB,0BAA0BmB,mBAAmB;YAChEO,IAAI;gBACFC,MAAMvB,KAAKF,MAAM;gBACjBoB;YACF;YACAM,oBAAoB;YACpBf,aAAaT,KAAKU,KAAK,KAAK;YAC5Be,SAASzB,KAAKW,cAAc;YAC5Be,mBAAmB;QACrB;QAEA,IAAI,CAACL,OAAOM,OAAO,IAAIN,OAAOO,KAAK,EAAE;YACnCnC,QAAQ,CAAC,oCAAoC,EAAE4B,OAAOO,KAAK,CAACC,WAAW,EAAE;QAC3E;IACF,EAAE,OAAOjB,KAAc;QACrBnB,QACE,CAAC,iDAAiD,EAAEmB,eAAeC,QAAQD,IAAIE,OAAO,GAAG,IAAI;IAEjG;AACF"}