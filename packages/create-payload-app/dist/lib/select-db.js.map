{"version":3,"sources":["../../src/lib/select-db.ts"],"sourcesContent":["import * as p from '@clack/prompts'\nimport slugify from '@sindresorhus/slugify'\n\nimport type { CliArgs, DbDetails, DbType, ProjectTemplate } from '../types.js'\n\ntype DbChoice = {\n  dbConnectionPrefix?: `${string}/`\n  dbConnectionSuffix?: string\n  title: string\n  value: DbType\n}\n\nexport const dbChoiceRecord: Record<DbType, DbChoice> = {\n  'd1-sqlite': {\n    title: 'Cloudflare D1 SQlite',\n    value: 'd1-sqlite',\n  },\n  mongodb: {\n    dbConnectionPrefix: 'mongodb://127.0.0.1/',\n    title: 'MongoDB',\n    value: 'mongodb',\n  },\n  postgres: {\n    dbConnectionPrefix: 'postgres://postgres:<password>@127.0.0.1:5432/',\n    title: 'PostgreSQL',\n    value: 'postgres',\n  },\n  sqlite: {\n    dbConnectionPrefix: 'file:./',\n    dbConnectionSuffix: '.db',\n    title: 'SQLite',\n    value: 'sqlite',\n  },\n  'vercel-postgres': {\n    dbConnectionPrefix: 'postgres://postgres:<password>@127.0.0.1:5432/',\n    title: 'Vercel Postgres',\n    value: 'vercel-postgres',\n  },\n}\n\nexport async function selectDb(\n  args: CliArgs,\n  projectName: string,\n  template?: ProjectTemplate,\n): Promise<DbDetails> {\n  let dbType: DbType | symbol | undefined = undefined\n  if (args['--db']) {\n    if (!Object.values(dbChoiceRecord).some((dbChoice) => dbChoice.value === args['--db'])) {\n      throw new Error(\n        `Invalid database type given. Valid types are: ${Object.values(dbChoiceRecord)\n          .map((dbChoice) => dbChoice.value)\n          .join(', ')}`,\n      )\n    }\n    dbType = args['--db'] as DbType\n  } else if (template?.dbType) {\n    // If the template has a pre-defined database type, use that\n    dbType = template.dbType\n  } else {\n    dbType = await p.select<{ label: string; value: DbType }[], DbType>({\n      initialValue: 'mongodb',\n      message: `Select a database`,\n      options: Object.values(dbChoiceRecord).map((dbChoice) => ({\n        label: dbChoice.title,\n        value: dbChoice.value,\n      })),\n    })\n    if (p.isCancel(dbType)) {\n      process.exit(0)\n    }\n  }\n\n  const dbChoice = dbChoiceRecord[dbType]\n\n  let dbUri: string | symbol | undefined = undefined\n  const initialDbUri = `${dbChoice.dbConnectionPrefix}${\n    projectName === '.' ? `payload-${getRandomDigitSuffix()}` : slugify(projectName)\n  }${dbChoice.dbConnectionSuffix || ''}`\n\n  if (args['--db-accept-recommended']) {\n    dbUri = initialDbUri\n  } else if (args['--db-connection-string']) {\n    dbUri = args['--db-connection-string']\n    // D1 Sqlite does not use a connection string so skip this prompt for this database\n  } else if (dbType !== 'd1-sqlite') {\n    dbUri = await p.text({\n      initialValue: initialDbUri,\n      message: `Enter ${dbChoice.title.split(' ')[0]} connection string`, // strip beta from title\n    })\n    if (p.isCancel(dbUri)) {\n      process.exit(0)\n    }\n  }\n\n  return {\n    type: dbChoice.value,\n    dbUri,\n  }\n}\n\nfunction getRandomDigitSuffix(): string {\n  return (Math.random() * Math.pow(10, 6)).toFixed(0)\n}\n"],"names":["p","slugify","dbChoiceRecord","title","value","mongodb","dbConnectionPrefix","postgres","sqlite","dbConnectionSuffix","selectDb","args","projectName","template","dbType","undefined","Object","values","some","dbChoice","Error","map","join","select","initialValue","message","options","label","isCancel","process","exit","dbUri","initialDbUri","getRandomDigitSuffix","text","split","type","Math","random","pow","toFixed"],"mappings":"AAAA,YAAYA,OAAO,iBAAgB;AACnC,OAAOC,aAAa,wBAAuB;AAW3C,OAAO,MAAMC,iBAA2C;IACtD,aAAa;QACXC,OAAO;QACPC,OAAO;IACT;IACAC,SAAS;QACPC,oBAAoB;QACpBH,OAAO;QACPC,OAAO;IACT;IACAG,UAAU;QACRD,oBAAoB;QACpBH,OAAO;QACPC,OAAO;IACT;IACAI,QAAQ;QACNF,oBAAoB;QACpBG,oBAAoB;QACpBN,OAAO;QACPC,OAAO;IACT;IACA,mBAAmB;QACjBE,oBAAoB;QACpBH,OAAO;QACPC,OAAO;IACT;AACF,EAAC;AAED,OAAO,eAAeM,SACpBC,IAAa,EACbC,WAAmB,EACnBC,QAA0B;IAE1B,IAAIC,SAAsCC;IAC1C,IAAIJ,IAAI,CAAC,OAAO,EAAE;QAChB,IAAI,CAACK,OAAOC,MAAM,CAACf,gBAAgBgB,IAAI,CAAC,CAACC,WAAaA,SAASf,KAAK,KAAKO,IAAI,CAAC,OAAO,GAAG;YACtF,MAAM,IAAIS,MACR,CAAC,8CAA8C,EAAEJ,OAAOC,MAAM,CAACf,gBAC5DmB,GAAG,CAAC,CAACF,WAAaA,SAASf,KAAK,EAChCkB,IAAI,CAAC,OAAO;QAEnB;QACAR,SAASH,IAAI,CAAC,OAAO;IACvB,OAAO,IAAIE,UAAUC,QAAQ;QAC3B,4DAA4D;QAC5DA,SAASD,SAASC,MAAM;IAC1B,OAAO;QACLA,SAAS,MAAMd,EAAEuB,MAAM,CAA6C;YAClEC,cAAc;YACdC,SAAS,CAAC,iBAAiB,CAAC;YAC5BC,SAASV,OAAOC,MAAM,CAACf,gBAAgBmB,GAAG,CAAC,CAACF,WAAc,CAAA;oBACxDQ,OAAOR,SAAShB,KAAK;oBACrBC,OAAOe,SAASf,KAAK;gBACvB,CAAA;QACF;QACA,IAAIJ,EAAE4B,QAAQ,CAACd,SAAS;YACtBe,QAAQC,IAAI,CAAC;QACf;IACF;IAEA,MAAMX,WAAWjB,cAAc,CAACY,OAAO;IAEvC,IAAIiB,QAAqChB;IACzC,MAAMiB,eAAe,GAAGb,SAASb,kBAAkB,GACjDM,gBAAgB,MAAM,CAAC,QAAQ,EAAEqB,wBAAwB,GAAGhC,QAAQW,eACnEO,SAASV,kBAAkB,IAAI,IAAI;IAEtC,IAAIE,IAAI,CAAC,0BAA0B,EAAE;QACnCoB,QAAQC;IACV,OAAO,IAAIrB,IAAI,CAAC,yBAAyB,EAAE;QACzCoB,QAAQpB,IAAI,CAAC,yBAAyB;IACtC,mFAAmF;IACrF,OAAO,IAAIG,WAAW,aAAa;QACjCiB,QAAQ,MAAM/B,EAAEkC,IAAI,CAAC;YACnBV,cAAcQ;YACdP,SAAS,CAAC,MAAM,EAAEN,SAAShB,KAAK,CAACgC,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,kBAAkB,CAAC;QACpE;QACA,IAAInC,EAAE4B,QAAQ,CAACG,QAAQ;YACrBF,QAAQC,IAAI,CAAC;QACf;IACF;IAEA,OAAO;QACLM,MAAMjB,SAASf,KAAK;QACpB2B;IACF;AACF;AAEA,SAASE;IACP,OAAO,AAACI,CAAAA,KAAKC,MAAM,KAAKD,KAAKE,GAAG,CAAC,IAAI,EAAC,EAAGC,OAAO,CAAC;AACnD"}