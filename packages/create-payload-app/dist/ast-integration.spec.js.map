{"version":3,"sources":["../src/ast-integration.spec.ts"],"sourcesContent":["import { describe, it, expect, beforeEach, afterEach } from 'vitest'\nimport * as fs from 'fs'\nimport * as fse from 'fs-extra'\nimport * as path from 'path'\nimport * as os from 'os'\nimport { configurePayloadConfig } from './lib/configure-payload-config'\nimport type { DbType, StorageAdapterType } from './types'\nimport { DB_ADAPTER_CONFIG, STORAGE_ADAPTER_CONFIG } from './lib/ast/adapter-config'\n\ninterface TestCase {\n  name: string\n  template: string\n  dbType: DbType\n  storageAdapter: StorageAdapterType\n}\n\nconst TEST_CASES: TestCase[] = [\n  {\n    name: 'blank + mongodb + localDisk',\n    template: 'blank',\n    dbType: 'mongodb',\n    storageAdapter: 'localDisk',\n  },\n  {\n    name: 'blank + postgres + vercelBlobStorage',\n    template: 'blank',\n    dbType: 'postgres',\n    storageAdapter: 'vercelBlobStorage',\n  },\n  {\n    name: 'website + mongodb + s3Storage',\n    template: 'website',\n    dbType: 'mongodb',\n    storageAdapter: 's3Storage',\n  },\n  {\n    name: 'website + postgres + localDisk',\n    template: 'website',\n    dbType: 'postgres',\n    storageAdapter: 'localDisk',\n  },\n  {\n    name: 'ecommerce + mongodb + localDisk',\n    template: 'ecommerce',\n    dbType: 'mongodb',\n    storageAdapter: 'localDisk',\n  },\n  {\n    name: 'ecommerce + postgres + r2Storage',\n    template: 'ecommerce',\n    dbType: 'postgres',\n    storageAdapter: 'r2Storage',\n  },\n]\n\ndescribe('AST Integration Tests', () => {\n  let tempDir: string\n  const templatesRoot = path.resolve(__dirname, '../../..', 'templates')\n\n  beforeEach(() => {\n    tempDir = fs.mkdtempSync(path.join(os.tmpdir(), 'payload-ast-integration-'))\n  })\n\n  afterEach(() => {\n    if (tempDir && fs.existsSync(tempDir)) {\n      fs.rmSync(tempDir, { recursive: true, force: true })\n    }\n  })\n\n  describe.each(TEST_CASES)('$name', ({ template, dbType, storageAdapter }) => {\n    it('successfully applies AST transformations', async () => {\n      // Setup: Copy template to temp directory\n      const templateDir = path.join(templatesRoot, template)\n      const testProjectDir = path.join(tempDir, template)\n\n      if (!fs.existsSync(templateDir)) {\n        throw new Error(`Template ${template} not found at ${templateDir}`)\n      }\n\n      fse.copySync(templateDir, testProjectDir)\n\n      const payloadConfigPath = path.join(testProjectDir, 'src', 'payload.config.ts')\n      const packageJsonPath = path.join(testProjectDir, 'package.json')\n\n      // Verify files exist before transformation\n      expect(fs.existsSync(payloadConfigPath)).toBe(true)\n      expect(fs.existsSync(packageJsonPath)).toBe(true)\n\n      // Apply transformations\n      await configurePayloadConfig({\n        dbType,\n        storageAdapter,\n        projectDirOrConfigPath: { projectDir: testProjectDir },\n      })\n\n      // Verify payload.config.ts transformations\n      const configContent = fs.readFileSync(payloadConfigPath, 'utf-8')\n\n      // Check database adapter import\n      const dbConfig = DB_ADAPTER_CONFIG[dbType]\n      expect(configContent).toContain(`from '${dbConfig.packageName}'`)\n      expect(configContent).toContain(`import { ${dbConfig.adapterName} }`)\n\n      // Check database adapter config\n      expect(configContent).toMatch(new RegExp(`db:\\\\s*${dbConfig.adapterName}\\\\(`))\n\n      // Check storage adapter if not localDisk\n      if (storageAdapter !== 'localDisk') {\n        const storageConfig = STORAGE_ADAPTER_CONFIG[storageAdapter]\n\n        if (storageConfig.packageName && storageConfig.adapterName) {\n          expect(configContent).toContain(`from '${storageConfig.packageName}'`)\n          expect(configContent).toContain(`import { ${storageConfig.adapterName} }`)\n          expect(configContent).toContain(`${storageConfig.adapterName}(`)\n        }\n      }\n\n      // Check that old mongodb adapter is removed if we switched to postgres\n      if (dbType === 'postgres') {\n        expect(configContent).not.toContain('@payloadcms/db-mongodb')\n        expect(configContent).not.toContain('mongooseAdapter')\n      }\n\n      // Check that plugins array exists if storage adapter was added\n      if (storageAdapter !== 'localDisk') {\n        expect(configContent).toContain('plugins:')\n      }\n\n      // Verify package.json transformations\n      const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf-8'))\n\n      // Check that correct db adapter package is in dependencies\n      expect(packageJson.dependencies[dbConfig.packageName]).toBeDefined()\n\n      // Check that old db adapters are removed\n      Object.entries(DB_ADAPTER_CONFIG).forEach(([key, config]) => {\n        if (key !== dbType && config.packageName !== dbConfig.packageName) {\n          expect(packageJson.dependencies[config.packageName]).toBeUndefined()\n        }\n      })\n\n      // Note: Storage adapter dependencies are NOT automatically added to package.json\n      // by configurePayloadConfig - only the payload.config.ts is updated.\n      // This is expected behavior as storage adapters are typically installed separately.\n\n      // Verify file is valid TypeScript (basic syntax check)\n      expect(configContent).toContain('buildConfig')\n      expect(configContent).toContain('export default')\n\n      // Verify no placeholder comments remain\n      expect(configContent).not.toContain('database-adapter-import')\n      expect(configContent).not.toContain('database-adapter-config-start')\n      expect(configContent).not.toContain('storage-adapter-placeholder')\n    })\n  })\n})\n"],"names":["describe","it","expect","beforeEach","afterEach","fs","fse","path","os","configurePayloadConfig","DB_ADAPTER_CONFIG","STORAGE_ADAPTER_CONFIG","TEST_CASES","name","template","dbType","storageAdapter","tempDir","templatesRoot","resolve","__dirname","mkdtempSync","join","tmpdir","existsSync","rmSync","recursive","force","each","templateDir","testProjectDir","Error","copySync","payloadConfigPath","packageJsonPath","toBe","projectDirOrConfigPath","projectDir","configContent","readFileSync","dbConfig","toContain","packageName","adapterName","toMatch","RegExp","storageConfig","not","packageJson","JSON","parse","dependencies","toBeDefined","Object","entries","forEach","key","config","toBeUndefined"],"mappings":"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"}