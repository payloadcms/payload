{"version":3,"sources":["../src/execute.ts"],"sourcesContent":["import type { Execute } from '@payloadcms/drizzle'\nimport type { SQLiteRaw } from 'drizzle-orm/sqlite-core/query-builders/raw'\n\nimport { sql } from 'drizzle-orm'\n\ninterface D1Meta {\n  changed_db: boolean\n  changes: number\n  duration: number\n  last_row_id: number\n  rows_read: number\n  rows_written: number\n  /**\n   * True if-and-only-if the database instance that executed the query was the primary.\n   */\n  served_by_primary?: boolean\n  /**\n   * The region of the database instance that executed the query.\n   */\n  served_by_region?: string\n  size_after: number\n  timings?: {\n    /**\n     * The duration of the SQL query execution by the database instance. It doesn't include any network time.\n     */\n    sql_duration_ms: number\n  }\n}\n\ninterface D1Response {\n  error?: never\n  meta: D1Meta & Record<string, unknown>\n  success: true\n}\n\ntype D1Result<T = unknown> = {\n  results: T[]\n} & D1Response\n\nexport const execute: Execute<any> = function execute({ db, drizzle, raw, sql: statement }) {\n  const executeFrom: any = (db ?? drizzle)!\n  const mapToLibSql = (query: SQLiteRaw<D1Result<unknown>>): any => {\n    const execute = query.execute\n    query.execute = async () => {\n      const result: D1Result = await execute()\n      const resultLibSQL = {\n        columns: undefined,\n        columnTypes: undefined,\n        lastInsertRowid: BigInt(result.meta.last_row_id),\n        rows: result.results as any[],\n        rowsAffected: result.meta.rows_written,\n      }\n\n      return Object.assign(result, resultLibSQL)\n    }\n\n    return query\n  }\n\n  if (raw) {\n    const result = mapToLibSql(executeFrom.run(sql.raw(raw)))\n    return result\n  } else {\n    const result = mapToLibSql(executeFrom.run(statement))\n    return result\n  }\n}\n"],"names":["sql","execute","db","drizzle","raw","statement","executeFrom","mapToLibSql","query","result","resultLibSQL","columns","undefined","columnTypes","lastInsertRowid","BigInt","meta","last_row_id","rows","results","rowsAffected","rows_written","Object","assign","run"],"mappings":"AAGA,SAASA,GAAG,QAAQ,cAAa;AAoCjC,OAAO,MAAMC,UAAwB,SAASA,QAAQ,EAAEC,EAAE,EAAEC,OAAO,EAAEC,GAAG,EAAEJ,KAAKK,SAAS,EAAE;IACxF,MAAMC,cAAoBJ,MAAMC;IAChC,MAAMI,cAAc,CAACC;QACnB,MAAMP,UAAUO,MAAMP,OAAO;QAC7BO,MAAMP,OAAO,GAAG;YACd,MAAMQ,SAAmB,MAAMR;YAC/B,MAAMS,eAAe;gBACnBC,SAASC;gBACTC,aAAaD;gBACbE,iBAAiBC,OAAON,OAAOO,IAAI,CAACC,WAAW;gBAC/CC,MAAMT,OAAOU,OAAO;gBACpBC,cAAcX,OAAOO,IAAI,CAACK,YAAY;YACxC;YAEA,OAAOC,OAAOC,MAAM,CAACd,QAAQC;QAC/B;QAEA,OAAOF;IACT;IAEA,IAAIJ,KAAK;QACP,MAAMK,SAASF,YAAYD,YAAYkB,GAAG,CAACxB,IAAII,GAAG,CAACA;QACnD,OAAOK;IACT,OAAO;QACL,MAAMA,SAASF,YAAYD,YAAYkB,GAAG,CAACnB;QAC3C,OAAOI;IACT;AACF,EAAC"}