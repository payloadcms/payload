{"version":3,"sources":["../src/connect.ts"],"sourcesContent":["import type { DrizzleAdapter } from '@payloadcms/drizzle'\nimport type { Connect, Migration } from 'payload'\n\nimport { pushDevSchema } from '@payloadcms/drizzle'\nimport { drizzle } from 'drizzle-orm/d1'\n\nimport type { SQLiteD1Adapter } from './types.js'\n\nexport const connect: Connect = async function connect(\n  this: SQLiteD1Adapter,\n  options = {\n    hotReload: false,\n  },\n) {\n  const { hotReload } = options\n\n  this.schema = {\n    ...this.tables,\n    ...this.relations,\n  }\n\n  try {\n    const logger = this.logger || false\n    const readReplicas = this.readReplicas\n\n    let binding = this.binding\n\n    if (readReplicas && readReplicas === 'first-primary') {\n      // @ts-expect-error - need to have types that support withSession binding from D1\n      binding = this.binding.withSession('first-primary')\n    }\n\n    this.drizzle = drizzle(binding, {\n      logger,\n      schema: this.schema,\n    })\n\n    this.client = this.drizzle.$client as any\n\n    if (!hotReload) {\n      if (process.env.PAYLOAD_DROP_DATABASE === 'true') {\n        this.payload.logger.info(`---- DROPPING TABLES ----`)\n        await this.dropDatabase({ adapter: this })\n        this.payload.logger.info('---- DROPPED TABLES ----')\n      }\n    }\n  } catch (err) {\n    const message = err instanceof Error ? err.message : String(err)\n    this.payload.logger.error({ err, msg: `Error: cannot connect to SQLite: ${message}` })\n    if (typeof this.rejectInitializing === 'function') {\n      this.rejectInitializing()\n    }\n    console.error(err)\n    throw new Error(`Error: cannot connect to SQLite: ${message}`)\n  }\n\n  // Only push schema if not in production\n  if (\n    process.env.NODE_ENV !== 'production' &&\n    process.env.PAYLOAD_MIGRATING !== 'true' &&\n    this.push !== false\n  ) {\n    await pushDevSchema(this as unknown as DrizzleAdapter)\n  }\n\n  if (typeof this.resolveInitializing === 'function') {\n    this.resolveInitializing()\n  }\n\n  if (process.env.NODE_ENV === 'production' && this.prodMigrations) {\n    await this.migrate({ migrations: this.prodMigrations as Migration[] })\n  }\n}\n"],"names":["pushDevSchema","drizzle","connect","options","hotReload","schema","tables","relations","logger","readReplicas","binding","withSession","client","$client","process","env","PAYLOAD_DROP_DATABASE","payload","info","dropDatabase","adapter","err","message","Error","String","error","msg","rejectInitializing","console","NODE_ENV","PAYLOAD_MIGRATING","push","resolveInitializing","prodMigrations","migrate","migrations"],"mappings":"AAGA,SAASA,aAAa,QAAQ,sBAAqB;AACnD,SAASC,OAAO,QAAQ,iBAAgB;AAIxC,OAAO,MAAMC,UAAmB,eAAeA,QAE7CC,UAAU;IACRC,WAAW;AACb,CAAC;IAED,MAAM,EAAEA,SAAS,EAAE,GAAGD;IAEtB,IAAI,CAACE,MAAM,GAAG;QACZ,GAAG,IAAI,CAACC,MAAM;QACd,GAAG,IAAI,CAACC,SAAS;IACnB;IAEA,IAAI;QACF,MAAMC,SAAS,IAAI,CAACA,MAAM,IAAI;QAC9B,MAAMC,eAAe,IAAI,CAACA,YAAY;QAEtC,IAAIC,UAAU,IAAI,CAACA,OAAO;QAE1B,IAAID,gBAAgBA,iBAAiB,iBAAiB;YACpD,iFAAiF;YACjFC,UAAU,IAAI,CAACA,OAAO,CAACC,WAAW,CAAC;QACrC;QAEA,IAAI,CAACV,OAAO,GAAGA,QAAQS,SAAS;YAC9BF;YACAH,QAAQ,IAAI,CAACA,MAAM;QACrB;QAEA,IAAI,CAACO,MAAM,GAAG,IAAI,CAACX,OAAO,CAACY,OAAO;QAElC,IAAI,CAACT,WAAW;YACd,IAAIU,QAAQC,GAAG,CAACC,qBAAqB,KAAK,QAAQ;gBAChD,IAAI,CAACC,OAAO,CAACT,MAAM,CAACU,IAAI,CAAC,CAAC,yBAAyB,CAAC;gBACpD,MAAM,IAAI,CAACC,YAAY,CAAC;oBAAEC,SAAS,IAAI;gBAAC;gBACxC,IAAI,CAACH,OAAO,CAACT,MAAM,CAACU,IAAI,CAAC;YAC3B;QACF;IACF,EAAE,OAAOG,KAAK;QACZ,MAAMC,UAAUD,eAAeE,QAAQF,IAAIC,OAAO,GAAGE,OAAOH;QAC5D,IAAI,CAACJ,OAAO,CAACT,MAAM,CAACiB,KAAK,CAAC;YAAEJ;YAAKK,KAAK,CAAC,iCAAiC,EAAEJ,SAAS;QAAC;QACpF,IAAI,OAAO,IAAI,CAACK,kBAAkB,KAAK,YAAY;YACjD,IAAI,CAACA,kBAAkB;QACzB;QACAC,QAAQH,KAAK,CAACJ;QACd,MAAM,IAAIE,MAAM,CAAC,iCAAiC,EAAED,SAAS;IAC/D;IAEA,wCAAwC;IACxC,IACER,QAAQC,GAAG,CAACc,QAAQ,KAAK,gBACzBf,QAAQC,GAAG,CAACe,iBAAiB,KAAK,UAClC,IAAI,CAACC,IAAI,KAAK,OACd;QACA,MAAM/B,cAAc,IAAI;IAC1B;IAEA,IAAI,OAAO,IAAI,CAACgC,mBAAmB,KAAK,YAAY;QAClD,IAAI,CAACA,mBAAmB;IAC1B;IAEA,IAAIlB,QAAQC,GAAG,CAACc,QAAQ,KAAK,gBAAgB,IAAI,CAACI,cAAc,EAAE;QAChE,MAAM,IAAI,CAACC,OAAO,CAAC;YAAEC,YAAY,IAAI,CAACF,cAAc;QAAgB;IACtE;AACF,EAAC"}