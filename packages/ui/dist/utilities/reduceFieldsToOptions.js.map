{"version":3,"file":"reduceFieldsToOptions.js","names":["getTranslation","fieldAffectsData","fieldIsHiddenOrDisabled","fieldIsID","tabHasName","fieldTypeConditions","getValidFieldOperators","createNestedClientFieldPath","combineFieldLabel","reduceFieldsToOptions","fieldPermissions","fields","i18n","labelPrefix","pathPrefix","pathPrefixFromArgs","reduce","reduced","field","virtual","shouldIgnoreFieldName","type","tabs","forEach","tab","label","localizedTabLabel","labelWithPrefix","tabPathPrefix","name","push","translatedLabel","pathWithPrefix","read","operatorKeys","Set","validOperators","operators","acc","operator","has","value","add","operatorKey","t","localizedLabel","formattedLabel","prefix","fieldPath","formattedField","plainTextLabel"],"sources":["../../src/utilities/reduceFieldsToOptions.tsx"],"sourcesContent":["'use client'\nimport type { ClientTranslationKeys, I18nClient } from '@payloadcms/translations'\nimport type { ClientField, SanitizedFieldPermissions, SanitizedFieldsPermissions } from 'payload'\n\nimport { getTranslation } from '@payloadcms/translations'\nimport { fieldAffectsData, fieldIsHiddenOrDisabled, fieldIsID, tabHasName } from 'payload/shared'\n\nimport type { ReducedField } from '../elements/WhereBuilder/types.js'\n\nimport {\n  fieldTypeConditions,\n  getValidFieldOperators,\n} from '../elements/WhereBuilder/field-types.js'\nimport { createNestedClientFieldPath } from '../forms/Form/createNestedClientFieldPath.js'\nimport { combineFieldLabel } from './combineFieldLabel.js'\n\ntype ReduceFieldOptionsArgs = {\n  fieldPermissions?: SanitizedFieldPermissions | SanitizedFieldsPermissions\n  fields: ClientField[]\n  i18n: I18nClient\n  labelPrefix?: string\n  pathPrefix?: string\n}\n\n/**\n * Transforms a fields schema into a flattened array of fields with labels and values.\n * Used in the `WhereBuilder` component to render the fields in the dropdown.\n */\nexport const reduceFieldsToOptions = ({\n  fieldPermissions,\n  fields,\n  i18n,\n  labelPrefix,\n  pathPrefix: pathPrefixFromArgs,\n}: ReduceFieldOptionsArgs): ReducedField[] => {\n  return fields.reduce((reduced, field) => {\n    let pathPrefix = pathPrefixFromArgs\n    // Do not filter out `field.admin.disableListFilter` fields here, as these should still render as disabled if they appear in the URL query\n    // Filter out `virtual: true` fields since they are regular virtuals and not backed by a DB field\n    if (\n      (fieldIsHiddenOrDisabled(field) && !fieldIsID(field)) ||\n      ('virtual' in field && field.virtual === true)\n    ) {\n      return reduced\n    }\n\n    // IMPORTANT: We DON'T mutate field.name here because the field object is shared across\n    // multiple components (WhereBuilder, GroupByBuilder, etc.). Mutating it would break\n    // permission checks and cause issues in other components that need the field name.\n    // Instead, we use a flag to determine whether to include the field name in the path.\n    let shouldIgnoreFieldName = false\n\n    // Handle virtual:string fields (virtual relationships, e.g. \"post.title\")\n    if ('virtual' in field && typeof field.virtual === 'string') {\n      pathPrefix = pathPrefix ? pathPrefix + '.' + field.virtual : field.virtual\n      if (fieldAffectsData(field)) {\n        // Mark that we should ignore the field name when constructing the field path\n        shouldIgnoreFieldName = true\n      }\n    }\n\n    if (field.type === 'tabs' && 'tabs' in field) {\n      const tabs = field.tabs\n\n      tabs.forEach((tab) => {\n        if (typeof tab.label !== 'boolean') {\n          const localizedTabLabel = getTranslation(tab.label, i18n)\n\n          const labelWithPrefix = labelPrefix\n            ? labelPrefix + ' > ' + localizedTabLabel\n            : localizedTabLabel\n\n          // Make sure we handle nested tabs\n          const tabPathPrefix =\n            tabHasName(tab) && tab.name\n              ? pathPrefix\n                ? pathPrefix + '.' + tab.name\n                : tab.name\n              : pathPrefix\n\n          if (typeof localizedTabLabel === 'string') {\n            reduced.push(\n              ...reduceFieldsToOptions({\n                fieldPermissions:\n                  typeof fieldPermissions === 'boolean'\n                    ? fieldPermissions\n                    : tabHasName(tab) && tab.name\n                      ? fieldPermissions?.[tab.name]?.fields || fieldPermissions?.[tab.name]\n                      : fieldPermissions,\n                fields: tab.fields,\n                i18n,\n                labelPrefix: labelWithPrefix,\n                pathPrefix: tabPathPrefix,\n              }),\n            )\n          }\n        }\n      })\n      return reduced\n    }\n\n    // Rows cant have labels, so we need to handle them differently\n    if (field.type === 'row' && 'fields' in field) {\n      reduced.push(\n        ...reduceFieldsToOptions({\n          fieldPermissions,\n          fields: field.fields,\n          i18n,\n          labelPrefix,\n          pathPrefix,\n        }),\n      )\n      return reduced\n    }\n\n    if (field.type === 'collapsible' && 'fields' in field) {\n      const localizedTabLabel = getTranslation(field.label || '', i18n)\n\n      const labelWithPrefix = labelPrefix\n        ? labelPrefix + ' > ' + localizedTabLabel\n        : localizedTabLabel\n\n      reduced.push(\n        ...reduceFieldsToOptions({\n          fieldPermissions,\n          fields: field.fields,\n          i18n,\n          labelPrefix: labelWithPrefix,\n          pathPrefix,\n        }),\n      )\n      return reduced\n    }\n\n    if (field.type === 'group' && 'fields' in field) {\n      const translatedLabel = getTranslation(field.label || '', i18n)\n\n      const labelWithPrefix = labelPrefix\n        ? translatedLabel\n          ? labelPrefix + ' > ' + translatedLabel\n          : labelPrefix\n        : translatedLabel\n\n      if (fieldAffectsData(field)) {\n        // Make sure we handle deeply nested groups\n        const pathWithPrefix = field.name\n          ? pathPrefix\n            ? pathPrefix + '.' + field.name\n            : field.name\n          : pathPrefix\n\n        reduced.push(\n          ...reduceFieldsToOptions({\n            fieldPermissions:\n              typeof fieldPermissions === 'boolean'\n                ? fieldPermissions\n                : fieldPermissions?.[field.name]?.fields || fieldPermissions?.[field.name],\n            fields: field.fields,\n            i18n,\n            labelPrefix: labelWithPrefix,\n            pathPrefix: pathWithPrefix,\n          }),\n        )\n      } else {\n        reduced.push(\n          ...reduceFieldsToOptions({\n            fieldPermissions,\n            fields: field.fields,\n            i18n,\n            labelPrefix: labelWithPrefix,\n            pathPrefix,\n          }),\n        )\n      }\n\n      return reduced\n    }\n\n    if (field.type === 'array' && 'fields' in field) {\n      const translatedLabel = getTranslation(field.label || '', i18n)\n\n      const labelWithPrefix = labelPrefix\n        ? translatedLabel\n          ? labelPrefix + ' > ' + translatedLabel\n          : labelPrefix\n        : translatedLabel\n\n      // Make sure we handle deeply nested groups\n      const pathWithPrefix = field.name\n        ? pathPrefix\n          ? pathPrefix + '.' + field.name\n          : field.name\n        : pathPrefix\n\n      reduced.push(\n        ...reduceFieldsToOptions({\n          fieldPermissions:\n            typeof fieldPermissions === 'boolean'\n              ? fieldPermissions\n              : fieldPermissions?.[field.name]?.fields || fieldPermissions?.[field.name],\n          fields: field.fields,\n          i18n,\n          labelPrefix: labelWithPrefix,\n          pathPrefix: pathWithPrefix,\n        }),\n      )\n\n      return reduced\n    }\n\n    if (typeof fieldTypeConditions[field.type] === 'object') {\n      if (\n        fieldIsID(field) ||\n        fieldPermissions === true ||\n        fieldPermissions?.[field.name] === true ||\n        fieldPermissions?.[field.name]?.read === true\n      ) {\n        const operatorKeys = new Set()\n\n        const { validOperators } = getValidFieldOperators({\n          field,\n        })\n\n        const operators = validOperators.reduce((acc, operator) => {\n          if (!operatorKeys.has(operator.value)) {\n            operatorKeys.add(operator.value)\n            const operatorKey = `operators:${operator.label}` as ClientTranslationKeys\n            acc.push({\n              ...operator,\n              label: i18n.t(operatorKey),\n            })\n          }\n\n          return acc\n        }, [])\n\n        const localizedLabel = getTranslation(field.label || '', i18n)\n\n        const formattedLabel = labelPrefix\n          ? combineFieldLabel({\n              field,\n              prefix: labelPrefix,\n            })\n          : localizedLabel\n\n        // For virtual fields, we use just the pathPrefix (the virtual path) without appending the field name\n        // For regular fields, we use createNestedClientFieldPath which appends the field name to the path\n        let fieldPath: string\n        if (shouldIgnoreFieldName) {\n          fieldPath = pathPrefix\n        } else if (pathPrefix) {\n          fieldPath = createNestedClientFieldPath(pathPrefix, field)\n        } else {\n          fieldPath = field.name\n        }\n\n        const formattedField: ReducedField = {\n          label: formattedLabel,\n          plainTextLabel: `${labelPrefix ? labelPrefix + ' > ' : ''}${localizedLabel}`,\n          value: fieldPath,\n          ...fieldTypeConditions[field.type],\n          field,\n          operators,\n        }\n\n        reduced.push(formattedField)\n        return reduced\n      }\n    }\n    return reduced\n  }, [])\n}\n"],"mappings":"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","ignoreList":[]}