{"version":3,"file":"traverseFields.js","names":["createClientFields","fieldAffectsData","getFieldPaths","tabHasName","traverseFields","clientSchemaMap","config","fields","i18n","parentIndexPath","parentSchemaPath","payload","schemaMap","index","field","entries","indexPath","schemaPath","set","type","blockReferences","blocks","map","_block","block","blocksMap","find","slug","blockSchemaPath","richTextFieldSchemaMap","Map","path","subField","startsWith","isFieldsOnly","Object","keys","length","clientFields","defaultIDType","db","disableAddingID","importMap","isNamedTab","tabs","tab"],"sources":["../../../src/utilities/buildClientFieldSchemaMap/traverseFields.ts"],"sourcesContent":["import type { I18n } from '@payloadcms/translations'\nimport type {\n  ClientConfig,\n  ClientField,\n  ClientFieldSchemaMap,\n  Field,\n  FieldSchemaMap,\n  Payload,\n  TabAsFieldClient,\n} from 'payload'\n\nimport { createClientFields } from 'payload'\nimport { fieldAffectsData, getFieldPaths, tabHasName } from 'payload/shared'\n\ntype Args = {\n  clientSchemaMap: ClientFieldSchemaMap\n  config: ClientConfig\n  fields: (ClientField | TabAsFieldClient)[]\n  i18n: I18n<any, any>\n  parentIndexPath: string\n  parentSchemaPath: string\n  payload: Payload\n  schemaMap: FieldSchemaMap\n}\n\nexport const traverseFields = ({\n  clientSchemaMap,\n  config,\n  fields,\n  i18n,\n  parentIndexPath,\n  parentSchemaPath,\n  payload,\n  schemaMap,\n}: Args) => {\n  for (const [index, field] of fields.entries()) {\n    const { indexPath, schemaPath } = getFieldPaths({\n      field,\n      index,\n      parentIndexPath,\n      parentSchemaPath,\n    })\n\n    clientSchemaMap.set(schemaPath, field)\n\n    switch (field.type) {\n      case 'array': {\n        traverseFields({\n          clientSchemaMap,\n          config,\n          fields: field.fields,\n          i18n,\n          parentIndexPath: '',\n          parentSchemaPath: schemaPath,\n          payload,\n          schemaMap,\n        })\n\n        break\n      }\n\n      case 'blocks':\n        ;(field.blockReferences ?? field.blocks).map((_block) => {\n          const block =\n            typeof _block === 'string'\n              ? config.blocksMap\n                ? config.blocksMap[_block]\n                : config.blocks.find((block) => typeof block !== 'string' && block.slug === _block)\n              : _block\n\n          const blockSchemaPath = `${schemaPath}.${block.slug}`\n\n          clientSchemaMap.set(blockSchemaPath, block)\n          traverseFields({\n            clientSchemaMap,\n            config,\n            fields: block.fields,\n            i18n,\n            parentIndexPath: '',\n            parentSchemaPath: schemaPath + '.' + block.slug,\n            payload,\n            schemaMap,\n          })\n        })\n\n        break\n\n      case 'collapsible':\n      case 'row': {\n        traverseFields({\n          clientSchemaMap,\n          config,\n          fields: field.fields,\n          i18n,\n          parentIndexPath: indexPath,\n          parentSchemaPath: schemaPath,\n          payload,\n          schemaMap,\n        })\n        break\n      }\n\n      case 'group': {\n        if (fieldAffectsData(field)) {\n          traverseFields({\n            clientSchemaMap,\n            config,\n            fields: field.fields,\n            i18n,\n            parentIndexPath: '',\n            parentSchemaPath: schemaPath,\n            payload,\n            schemaMap,\n          })\n        } else {\n          traverseFields({\n            clientSchemaMap,\n            config,\n            fields: field.fields,\n            i18n,\n            parentIndexPath: indexPath,\n            parentSchemaPath: schemaPath,\n            payload,\n            schemaMap,\n          })\n        }\n        break\n      }\n\n      case 'richText': {\n        // richText sub-fields are not part of the ClientConfig or the Config.\n        // They only exist in the field schema map.\n        // Thus, we need to\n        // 1. get them from the field schema map\n        // 2. convert them to client fields\n        // 3. add them to the client schema map\n\n        // So these would basically be all fields that are not part of the client config already\n        const richTextFieldSchemaMap: FieldSchemaMap = new Map()\n        for (const [path, subField] of schemaMap.entries()) {\n          if (path.startsWith(`${schemaPath}.`)) {\n            richTextFieldSchemaMap.set(path, subField)\n          }\n        }\n\n        // Now loop through them, convert each entry to a client field and add it to the client schema map\n        for (const [path, subField] of richTextFieldSchemaMap.entries()) {\n          // check if fields is the only key in the subField object\n          const isFieldsOnly = Object.keys(subField).length === 1 && 'fields' in subField\n\n          const clientFields = createClientFields({\n            defaultIDType: payload.config.db.defaultIDType,\n            disableAddingID: true,\n            fields: isFieldsOnly ? subField.fields : [subField as Field],\n            i18n,\n            importMap: payload.importMap,\n          })\n\n          clientSchemaMap.set(\n            path,\n            isFieldsOnly\n              ? {\n                  fields: clientFields,\n                }\n              : clientFields[0],\n          )\n        }\n        break\n      }\n\n      case 'tab': {\n        const isNamedTab = tabHasName(field)\n\n        traverseFields({\n          clientSchemaMap,\n          config,\n          fields: field.fields,\n          i18n,\n          parentIndexPath: isNamedTab ? '' : indexPath,\n          parentSchemaPath: schemaPath,\n          payload,\n          schemaMap,\n        })\n\n        break\n      }\n\n      case 'tabs': {\n        traverseFields({\n          clientSchemaMap,\n          config,\n          fields: field.tabs.map((tab) => ({ ...tab, type: 'tab' })),\n          i18n,\n          parentIndexPath: indexPath,\n          parentSchemaPath: schemaPath,\n          payload,\n          schemaMap,\n        })\n\n        break\n      }\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}