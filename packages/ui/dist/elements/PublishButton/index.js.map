{"version":3,"file":"index.js","names":["useModal","getTranslation","formatAdminURL","hasAutosaveEnabled","hasScheduledPublishEnabled","qs","React","useCallback","useEffect","useState","useForm","useFormModified","FormSubmit","useHotkey","useConfig","useDocumentInfo","useEditDepth","useLocale","useOperation","useTranslation","traverseForLocalizedFields","PopupList","ScheduleDrawer","PublishButton","label","labelProp","id","collectionSlug","globalSlug","hasPublishedDoc","hasPublishPermission","setHasPublishedDoc","setMostRecentVersionIsAutosaved","setUnpublishedVersionCount","unpublishedVersionCount","uploadStatus","config","getEntityConfig","submit","modified","editDepth","code","localeCode","isModalOpen","toggleModal","drawerSlug","localization","routes","api","serverURL","i18n","t","entityConfig","useMemo","hasNewerVersions","canPublish","scheduledPublishEnabled","hasAutosave","canSchedulePublish","Boolean","hasLocalizedFields","setHasLocalizedFields","hasLocalizedField","fields","isSpecificLocalePublishEnabled","operation","disabled","saveDraft","search","action","method","apiRoute","path","overrides","_status","skipValidation","cmdCtrlKey","keyCodes","e","preventDefault","stopPropagation","publish","result","publishSpecificLocale","locale","params","stringify","depth","pathSegment","isDefaultPublishAll","defaultLocalePublishOption","activeLocale","locales","find","activeLocaleLabel","_jsxs","Fragment","_jsx","buttonId","enableSubMenu","onClick","size","SubMenuPopupContent","close","ButtonGroup","Button","undefined","type","defaultType","schedulePublishConfig","versions","drafts","schedulePublish","slug"],"sources":["../../../src/elements/PublishButton/index.tsx"],"sourcesContent":["'use client'\n\nimport type { PublishButtonClientProps } from 'payload'\n\nimport { useModal } from '@faceless-ui/modal'\nimport { getTranslation } from '@payloadcms/translations'\nimport { formatAdminURL, hasAutosaveEnabled, hasScheduledPublishEnabled } from 'payload/shared'\nimport * as qs from 'qs-esm'\nimport React, { useCallback, useEffect, useState } from 'react'\n\nimport { useForm, useFormModified } from '../../forms/Form/context.js'\nimport { FormSubmit } from '../../forms/Submit/index.js'\nimport { useHotkey } from '../../hooks/useHotkey.js'\nimport { useConfig } from '../../providers/Config/index.js'\nimport { useDocumentInfo } from '../../providers/DocumentInfo/index.js'\nimport { useEditDepth } from '../../providers/EditDepth/index.js'\nimport { useLocale } from '../../providers/Locale/index.js'\nimport { useOperation } from '../../providers/Operation/index.js'\nimport { useTranslation } from '../../providers/Translation/index.js'\nimport { traverseForLocalizedFields } from '../../utilities/traverseForLocalizedFields.js'\nimport { PopupList } from '../Popup/index.js'\nimport { ScheduleDrawer } from './ScheduleDrawer/index.js'\n\nexport function PublishButton({ label: labelProp }: PublishButtonClientProps) {\n  const {\n    id,\n    collectionSlug,\n    globalSlug,\n    hasPublishedDoc,\n    hasPublishPermission,\n    setHasPublishedDoc,\n    setMostRecentVersionIsAutosaved,\n    setUnpublishedVersionCount,\n    unpublishedVersionCount,\n    uploadStatus,\n  } = useDocumentInfo()\n\n  const { config, getEntityConfig } = useConfig()\n  const { submit } = useForm()\n  const modified = useFormModified()\n  const editDepth = useEditDepth()\n  const { code: localeCode } = useLocale()\n  const { isModalOpen, toggleModal } = useModal()\n\n  const drawerSlug = `schedule-publish-${id}`\n\n  const {\n    localization,\n    routes: { api },\n    serverURL,\n  } = config\n\n  const { i18n, t } = useTranslation()\n  const label = labelProp || t('version:publishChanges')\n\n  const entityConfig = React.useMemo(() => {\n    if (collectionSlug) {\n      return getEntityConfig({ collectionSlug })\n    }\n\n    if (globalSlug) {\n      return getEntityConfig({ globalSlug })\n    }\n  }, [collectionSlug, globalSlug, getEntityConfig])\n\n  const hasNewerVersions = unpublishedVersionCount > 0\n\n  const canPublish =\n    hasPublishPermission &&\n    (modified || hasNewerVersions || !hasPublishedDoc) &&\n    uploadStatus !== 'uploading'\n\n  const scheduledPublishEnabled = hasScheduledPublishEnabled(entityConfig)\n\n  // If autosave is enabled the modified will always be true so only conditionally check on modified state\n  const hasAutosave = hasAutosaveEnabled(entityConfig)\n\n  const canSchedulePublish = Boolean(\n    scheduledPublishEnabled &&\n      hasPublishPermission &&\n      (globalSlug || (collectionSlug && id)) &&\n      (hasAutosave || !modified),\n  )\n\n  const [hasLocalizedFields, setHasLocalizedFields] = useState(false)\n\n  useEffect(() => {\n    const hasLocalizedField = traverseForLocalizedFields(entityConfig?.fields)\n    setHasLocalizedFields(hasLocalizedField)\n  }, [entityConfig?.fields])\n\n  const isSpecificLocalePublishEnabled = localization && hasLocalizedFields && hasPublishPermission\n\n  const operation = useOperation()\n\n  const disabled = operation === 'update' && !modified\n\n  const saveDraft = useCallback(async () => {\n    if (disabled) {\n      return\n    }\n\n    const search = `?locale=${localeCode}&depth=0&fallback-locale=null&draft=true`\n    let action\n    let method = 'POST'\n\n    if (collectionSlug) {\n      action = formatAdminURL({\n        apiRoute: api,\n        path: `/${collectionSlug}${id ? `/${id}` : ''}${search}`,\n      })\n      if (id) {\n        method = 'PATCH'\n      }\n    }\n\n    if (globalSlug) {\n      action = formatAdminURL({\n        apiRoute: api,\n        path: `/globals/${globalSlug}${search}`,\n      })\n    }\n\n    await submit({\n      action,\n      method,\n      overrides: {\n        _status: 'draft',\n      },\n      skipValidation: true,\n    })\n  }, [submit, collectionSlug, globalSlug, serverURL, api, localeCode, id, disabled])\n\n  useHotkey({ cmdCtrlKey: true, editDepth, keyCodes: ['s'] }, (e) => {\n    e.preventDefault()\n    e.stopPropagation()\n\n    if (saveDraft && hasAutosave) {\n      void saveDraft()\n    }\n  })\n\n  const publish = useCallback(async () => {\n    if (uploadStatus === 'uploading') {\n      return\n    }\n\n    const result = await submit({\n      overrides: {\n        _status: 'published',\n      },\n    })\n\n    if (result) {\n      setUnpublishedVersionCount(0)\n      setMostRecentVersionIsAutosaved(false)\n      setHasPublishedDoc(true)\n    }\n  }, [\n    setHasPublishedDoc,\n    submit,\n    setUnpublishedVersionCount,\n    uploadStatus,\n    setMostRecentVersionIsAutosaved,\n  ])\n\n  const publishSpecificLocale = useCallback(\n    async (locale) => {\n      if (uploadStatus === 'uploading') {\n        return\n      }\n\n      const params = qs.stringify({\n        depth: 0,\n        publishSpecificLocale: locale,\n      })\n\n      const pathSegment = globalSlug\n        ? `/globals/${globalSlug}`\n        : `/${collectionSlug}${id ? `/${id}` : ''}`\n      const action = formatAdminURL({\n        apiRoute: api,\n        path: `${pathSegment}${params ? '?' + params : ''}` as `/${string}`,\n      })\n\n      const result = await submit({\n        action,\n        overrides: {\n          _status: 'published',\n        },\n      })\n\n      if (result) {\n        setHasPublishedDoc(true)\n      }\n    },\n    [api, collectionSlug, globalSlug, id, serverURL, setHasPublishedDoc, submit, uploadStatus],\n  )\n\n  // Publish to all locales unless there are localized fields AND defaultLocalePublishOption is 'active'\n  const isDefaultPublishAll =\n    !isSpecificLocalePublishEnabled ||\n    (localization && localization?.defaultLocalePublishOption !== 'active')\n\n  const activeLocale =\n    localization &&\n    localization?.locales.find((locale) =>\n      typeof locale === 'string' ? locale === localeCode : locale.code === localeCode,\n    )\n\n  const activeLocaleLabel = activeLocale && getTranslation(activeLocale.label, i18n)\n\n  if (!hasPublishPermission) {\n    return null\n  }\n\n  return (\n    <React.Fragment>\n      <FormSubmit\n        buttonId=\"action-save\"\n        disabled={!canPublish}\n        enableSubMenu={canSchedulePublish}\n        onClick={isDefaultPublishAll ? publish : () => publishSpecificLocale(activeLocale.code)}\n        size=\"medium\"\n        SubMenuPopupContent={\n          isSpecificLocalePublishEnabled || canSchedulePublish\n            ? ({ close }) => {\n                return (\n                  <React.Fragment>\n                    {canSchedulePublish && (\n                      <PopupList.ButtonGroup key=\"schedule-publish\">\n                        <PopupList.Button\n                          id=\"schedule-publish\"\n                          onClick={() => [toggleModal(drawerSlug), close()]}\n                        >\n                          {t('version:schedulePublish')}\n                        </PopupList.Button>\n                      </PopupList.ButtonGroup>\n                    )}\n                    {isSpecificLocalePublishEnabled && (\n                      <PopupList.ButtonGroup>\n                        <PopupList.Button\n                          id=\"publish-locale\"\n                          onClick={\n                            isDefaultPublishAll\n                              ? () => publishSpecificLocale(activeLocale.code)\n                              : publish\n                          }\n                        >\n                          {isDefaultPublishAll\n                            ? t('version:publishIn', { locale: activeLocaleLabel })\n                            : t('version:publishAllLocales')}\n                        </PopupList.Button>\n                      </PopupList.ButtonGroup>\n                    )}\n                  </React.Fragment>\n                )\n              }\n            : undefined\n        }\n        type=\"button\"\n      >\n        {!isDefaultPublishAll ? t('version:publishIn', { locale: activeLocaleLabel }) : label}\n      </FormSubmit>\n      {canSchedulePublish && isModalOpen(drawerSlug) && (\n        <ScheduleDrawer\n          defaultType={!hasNewerVersions ? 'unpublish' : 'publish'}\n          schedulePublishConfig={\n            scheduledPublishEnabled &&\n            typeof entityConfig.versions.drafts.schedulePublish === 'object'\n              ? entityConfig.versions.drafts.schedulePublish\n              : undefined\n          }\n          slug={drawerSlug}\n        />\n      )}\n    </React.Fragment>\n  )\n}\n"],"mappings":"AAAA;;;AAIA,SAASA,QAAQ,QAAQ;AACzB,SAASC,cAAc,QAAQ;AAC/B,SAASC,cAAc,EAAEC,kBAAkB,EAAEC,0BAA0B,QAAQ;AAC/E,YAAYC,EAAA,MAAQ;AACpB,OAAOC,KAAA,IAASC,WAAW,EAAEC,SAAS,EAAEC,QAAQ,QAAQ;AAExD,SAASC,OAAO,EAAEC,eAAe,QAAQ;AACzC,SAASC,UAAU,QAAQ;AAC3B,SAASC,SAAS,QAAQ;AAC1B,SAASC,SAAS,QAAQ;AAC1B,SAASC,eAAe,QAAQ;AAChC,SAASC,YAAY,QAAQ;AAC7B,SAASC,SAAS,QAAQ;AAC1B,SAASC,YAAY,QAAQ;AAC7B,SAASC,cAAc,QAAQ;AAC/B,SAASC,0BAA0B,QAAQ;AAC3C,SAASC,SAAS,QAAQ;AAC1B,SAASC,cAAc,QAAQ;AAE/B,OAAO,SAASC,cAAc;EAAEC,KAAA,EAAOC;AAAS,CAA4B;EAC1E,MAAM;IACJC,EAAE;IACFC,cAAc;IACdC,UAAU;IACVC,eAAe;IACfC,oBAAoB;IACpBC,kBAAkB;IAClBC,+BAA+B;IAC/BC,0BAA0B;IAC1BC,uBAAuB;IACvBC;EAAY,CACb,GAAGpB,eAAA;EAEJ,MAAM;IAAEqB,MAAM;IAAEC;EAAe,CAAE,GAAGvB,SAAA;EACpC,MAAM;IAAEwB;EAAM,CAAE,GAAG5B,OAAA;EACnB,MAAM6B,QAAA,GAAW5B,eAAA;EACjB,MAAM6B,SAAA,GAAYxB,YAAA;EAClB,MAAM;IAAEyB,IAAA,EAAMC;EAAU,CAAE,GAAGzB,SAAA;EAC7B,MAAM;IAAE0B,WAAW;IAAEC;EAAW,CAAE,GAAG5C,QAAA;EAErC,MAAM6C,UAAA,GAAa,oBAAoBnB,EAAA,EAAI;EAE3C,MAAM;IACJoB,YAAY;IACZC,MAAA,EAAQ;MAAEC;IAAG,CAAE;IACfC;EAAS,CACV,GAAGb,MAAA;EAEJ,MAAM;IAAEc,IAAI;IAAEC;EAAC,CAAE,GAAGhC,cAAA;EACpB,MAAMK,KAAA,GAAQC,SAAA,IAAa0B,CAAA,CAAE;EAE7B,MAAMC,YAAA,GAAe9C,KAAA,CAAM+C,OAAO,CAAC;IACjC,IAAI1B,cAAA,EAAgB;MAClB,OAAOU,eAAA,CAAgB;QAAEV;MAAe;IAC1C;IAEA,IAAIC,UAAA,EAAY;MACd,OAAOS,eAAA,CAAgB;QAAET;MAAW;IACtC;EACF,GAAG,CAACD,cAAA,EAAgBC,UAAA,EAAYS,eAAA,CAAgB;EAEhD,MAAMiB,gBAAA,GAAmBpB,uBAAA,GAA0B;EAEnD,MAAMqB,UAAA,GACJzB,oBAAA,KACCS,QAAA,IAAYe,gBAAA,IAAoB,CAACzB,eAAc,KAChDM,YAAA,KAAiB;EAEnB,MAAMqB,uBAAA,GAA0BpD,0BAAA,CAA2BgD,YAAA;EAE3D;EACA,MAAMK,WAAA,GAActD,kBAAA,CAAmBiD,YAAA;EAEvC,MAAMM,kBAAA,GAAqBC,OAAA,CACzBH,uBAAA,IACE1B,oBAAA,KACCF,UAAA,IAAeD,cAAA,IAAkBD,EAAE,MACnC+B,WAAA,IAAe,CAAClB,QAAO;EAG5B,MAAM,CAACqB,kBAAA,EAAoBC,qBAAA,CAAsB,GAAGpD,QAAA,CAAS;EAE7DD,SAAA,CAAU;IACR,MAAMsD,iBAAA,GAAoB1C,0BAAA,CAA2BgC,YAAA,EAAcW,MAAA;IACnEF,qBAAA,CAAsBC,iBAAA;EACxB,GAAG,CAACV,YAAA,EAAcW,MAAA,CAAO;EAEzB,MAAMC,8BAAA,GAAiClB,YAAA,IAAgBc,kBAAA,IAAsB9B,oBAAA;EAE7E,MAAMmC,SAAA,GAAY/C,YAAA;EAElB,MAAMgD,QAAA,GAAWD,SAAA,KAAc,YAAY,CAAC1B,QAAA;EAE5C,MAAM4B,SAAA,GAAY5D,WAAA,CAAY;IAC5B,IAAI2D,QAAA,EAAU;MACZ;IACF;IAEA,MAAME,MAAA,GAAS,WAAW1B,UAAA,0CAAoD;IAC9E,IAAI2B,MAAA;IACJ,IAAIC,MAAA,GAAS;IAEb,IAAI3C,cAAA,EAAgB;MAClB0C,MAAA,GAASnE,cAAA,CAAe;QACtBqE,QAAA,EAAUvB,GAAA;QACVwB,IAAA,EAAM,IAAI7C,cAAA,GAAiBD,EAAA,GAAK,IAAIA,EAAA,EAAI,GAAG,KAAK0C,MAAA;MAClD;MACA,IAAI1C,EAAA,EAAI;QACN4C,MAAA,GAAS;MACX;IACF;IAEA,IAAI1C,UAAA,EAAY;MACdyC,MAAA,GAASnE,cAAA,CAAe;QACtBqE,QAAA,EAAUvB,GAAA;QACVwB,IAAA,EAAM,YAAY5C,UAAA,GAAawC,MAAA;MACjC;IACF;IAEA,MAAM9B,MAAA,CAAO;MACX+B,MAAA;MACAC,MAAA;MACAG,SAAA,EAAW;QACTC,OAAA,EAAS;MACX;MACAC,cAAA,EAAgB;IAClB;EACF,GAAG,CAACrC,MAAA,EAAQX,cAAA,EAAgBC,UAAA,EAAYqB,SAAA,EAAWD,GAAA,EAAKN,UAAA,EAAYhB,EAAA,EAAIwC,QAAA,CAAS;EAEjFrD,SAAA,CAAU;IAAE+D,UAAA,EAAY;IAAMpC,SAAA;IAAWqC,QAAA,EAAU,CAAC;EAAK,GAAIC,CAAA;IAC3DA,CAAA,CAAEC,cAAc;IAChBD,CAAA,CAAEE,eAAe;IAEjB,IAAIb,SAAA,IAAaV,WAAA,EAAa;MAC5B,KAAKU,SAAA;IACP;EACF;EAEA,MAAMc,OAAA,GAAU1E,WAAA,CAAY;IAC1B,IAAI4B,YAAA,KAAiB,aAAa;MAChC;IACF;IAEA,MAAM+C,MAAA,GAAS,MAAM5C,MAAA,CAAO;MAC1BmC,SAAA,EAAW;QACTC,OAAA,EAAS;MACX;IACF;IAEA,IAAIQ,MAAA,EAAQ;MACVjD,0BAAA,CAA2B;MAC3BD,+BAAA,CAAgC;MAChCD,kBAAA,CAAmB;IACrB;EACF,GAAG,CACDA,kBAAA,EACAO,MAAA,EACAL,0BAAA,EACAE,YAAA,EACAH,+BAAA,CACD;EAED,MAAMmD,qBAAA,GAAwB5E,WAAA,CAC5B,MAAO6E,MAAA;IACL,IAAIjD,YAAA,KAAiB,aAAa;MAChC;IACF;IAEA,MAAMkD,MAAA,GAAShF,EAAA,CAAGiF,SAAS,CAAC;MAC1BC,KAAA,EAAO;MACPJ,qBAAA,EAAuBC;IACzB;IAEA,MAAMI,WAAA,GAAc5D,UAAA,GAChB,YAAYA,UAAA,EAAY,GACxB,IAAID,cAAA,GAAiBD,EAAA,GAAK,IAAIA,EAAA,EAAI,GAAG,IAAI;IAC7C,MAAM2C,QAAA,GAASnE,cAAA,CAAe;MAC5BqE,QAAA,EAAUvB,GAAA;MACVwB,IAAA,EAAM,GAAGgB,WAAA,GAAcH,MAAA,GAAS,MAAMA,MAAA,GAAS;IACjD;IAEA,MAAMH,QAAA,GAAS,MAAM5C,MAAA,CAAO;MAC1B+B,MAAA,EAAAA,QAAA;MACAI,SAAA,EAAW;QACTC,OAAA,EAAS;MACX;IACF;IAEA,IAAIQ,QAAA,EAAQ;MACVnD,kBAAA,CAAmB;IACrB;EACF,GACA,CAACiB,GAAA,EAAKrB,cAAA,EAAgBC,UAAA,EAAYF,EAAA,EAAIuB,SAAA,EAAWlB,kBAAA,EAAoBO,MAAA,EAAQH,YAAA,CAAa;EAG5F;EACA,MAAMsD,mBAAA,GACJ,CAACzB,8BAAA,IACAlB,YAAA,IAAgBA,YAAA,EAAc4C,0BAAA,KAA+B;EAEhE,MAAMC,YAAA,GACJ7C,YAAA,IACAA,YAAA,EAAc8C,OAAA,CAAQC,IAAA,CAAMT,QAAA,IAC1B,OAAOA,QAAA,KAAW,WAAWA,QAAA,KAAW1C,UAAA,GAAa0C,QAAA,CAAO3C,IAAI,KAAKC,UAAA;EAGzE,MAAMoD,iBAAA,GAAoBH,YAAA,IAAgB1F,cAAA,CAAe0F,YAAA,CAAanE,KAAK,EAAE0B,IAAA;EAE7E,IAAI,CAACpB,oBAAA,EAAsB;IACzB,OAAO;EACT;EAEA,oBACEiE,KAAA,CAACzF,KAAA,CAAM0F,QAAQ;4BACbC,IAAA,CAACrF,UAAA;MACCsF,QAAA,EAAS;MACThC,QAAA,EAAU,CAACX,UAAA;MACX4C,aAAA,EAAezC,kBAAA;MACf0C,OAAA,EAASX,mBAAA,GAAsBR,OAAA,GAAU,MAAME,qBAAA,CAAsBQ,YAAA,CAAalD,IAAI;MACtF4D,IAAA,EAAK;MACLC,mBAAA,EACEtC,8BAAA,IAAkCN,kBAAA,GAC9B,CAAC;QAAE6C;MAAK,CAAE;QACR,oBACER,KAAA,CAACzF,KAAA,CAAM0F,QAAQ;qBACZtC,kBAAA,iBACCuC,IAAA,CAAC5E,SAAA,CAAUmF,WAAW;sBACpB,aAAAP,IAAA,CAAC5E,SAAA,CAAUoF,MAAM;cACf/E,EAAA,EAAG;cACH0E,OAAA,EAASA,CAAA,KAAM,CAACxD,WAAA,CAAYC,UAAA,GAAa0D,KAAA,GAAQ;wBAEhDpD,CAAA,CAAE;;aALoB,qBAS5Ba,8BAAA,iBACCiC,IAAA,CAAC5E,SAAA,CAAUmF,WAAW;sBACpB,aAAAP,IAAA,CAAC5E,SAAA,CAAUoF,MAAM;cACf/E,EAAA,EAAG;cACH0E,OAAA,EACEX,mBAAA,GACI,MAAMN,qBAAA,CAAsBQ,YAAA,CAAalD,IAAI,IAC7CwC,OAAA;wBAGLQ,mBAAA,GACGtC,CAAA,CAAE,qBAAqB;gBAAEiC,MAAA,EAAQU;cAAkB,KACnD3C,CAAA,CAAE;;;;MAMlB,IACAuD,SAAA;MAENC,IAAA,EAAK;gBAEJ,CAAClB,mBAAA,GAAsBtC,CAAA,CAAE,qBAAqB;QAAEiC,MAAA,EAAQU;MAAkB,KAAKtE;QAEjFkC,kBAAA,IAAsBf,WAAA,CAAYE,UAAA,kBACjCoD,IAAA,CAAC3E,cAAA;MACCsF,WAAA,EAAa,CAACtD,gBAAA,GAAmB,cAAc;MAC/CuD,qBAAA,EACErD,uBAAA,IACA,OAAOJ,YAAA,CAAa0D,QAAQ,CAACC,MAAM,CAACC,eAAe,KAAK,WACpD5D,YAAA,CAAa0D,QAAQ,CAACC,MAAM,CAACC,eAAe,GAC5CN,SAAA;MAENO,IAAA,EAAMpE;;;AAKhB","ignoreList":[]}