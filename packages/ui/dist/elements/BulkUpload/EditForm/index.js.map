{"version":3,"file":"index.js","names":["c","_c","React","useCallback","useEffect","useMemo","Form","useForm","WatchChildErrors","useConfig","useDocumentEvents","useDocumentInfo","OperationProvider","useServerFunctions","abortAndIgnore","handleAbortRef","useDocumentDrawerContext","DocumentFields","MoveDocToFolder","Upload_v4","useFormsManager","baseClass","EditForm","resetUploadEdits","submitted","updateUploadEdits","uploadEdits","action","collectionSlug","docSlug","docPermissions","getDocPreferences","hasSavePermission","initialState","isInitializing","Upload","CustomUpload","drawerSlug","onSave","onSaveFromContext","getFormState","config","folders","getEntityConfig","abortOnChangeRef","useRef","collectionConfig","reportUpdate","slug","schemaPath","useState","json","doc","result","entitySlug","operation","updatedAt","Date","toISOString","onChange","formState","prevFormState","controller","docPreferences","state","newFormState","signal","skipValidation","current","abortOnChange","_jsx","_jsxs","className","disabled","undefined","method","onSuccess","BeforeFields","Fragment","customActions","buttonProps","buttonStyle","size","folderCollectionSlug","folderFieldName","fieldName","filter","Boolean","uploadConfig","upload","fields","schemaPathSegments","ReportAllErrors","GetFieldProxy","$","getField","getFields","getFormDataRef","t0","t1","docConfig","activeIndex","forms","setFormTotalErrorCount","errorCountRef","fileIsValid","currentForm","file","valid","reportFormErrorCount","fieldErrorCount","newErrorCount","errorCount","index","path","setErrorCount"],"sources":["../../../../src/elements/BulkUpload/EditForm/index.tsx"],"sourcesContent":["'use client'\n\nimport React, { useCallback, useEffect, useMemo } from 'react'\n\nimport type { EditFormProps } from './types.js'\n\nimport { Form, useForm } from '../../../forms/Form/index.js'\nimport { type FormProps } from '../../../forms/Form/types.js'\nimport { WatchChildErrors } from '../../../forms/WatchChildErrors/index.js'\nimport { useConfig } from '../../../providers/Config/index.js'\nimport { useDocumentEvents } from '../../../providers/DocumentEvents/index.js'\nimport { useDocumentInfo } from '../../../providers/DocumentInfo/index.js'\nimport { OperationProvider } from '../../../providers/Operation/index.js'\nimport { useServerFunctions } from '../../../providers/ServerFunctions/index.js'\nimport { abortAndIgnore, handleAbortRef } from '../../../utilities/abortAndIgnore.js'\nimport { useDocumentDrawerContext } from '../../DocumentDrawer/Provider.js'\nimport { DocumentFields } from '../../DocumentFields/index.js'\nimport { MoveDocToFolder } from '../../FolderView/MoveDocToFolder/index.js'\nimport { Upload_v4 } from '../../Upload/index.js'\nimport { useFormsManager } from '../FormsManager/index.js'\nimport './index.scss'\n\nconst baseClass = 'collection-edit'\n\n// This component receives props only on _pages_\n// When rendered within a drawer, props are empty\n// This is solely to support custom edit views which get server-rendered\n\nexport function EditForm({\n  resetUploadEdits,\n  submitted,\n  updateUploadEdits,\n  uploadEdits,\n}: EditFormProps) {\n  const {\n    action,\n    collectionSlug: docSlug,\n    docPermissions,\n    getDocPreferences,\n    hasSavePermission,\n    initialState,\n    isInitializing,\n    Upload: CustomUpload,\n  } = useDocumentInfo()\n\n  const { drawerSlug, onSave: onSaveFromContext } = useDocumentDrawerContext()\n\n  const { getFormState } = useServerFunctions()\n\n  const {\n    config: { folders },\n    getEntityConfig,\n  } = useConfig()\n\n  const abortOnChangeRef = React.useRef<AbortController>(null)\n\n  const collectionConfig = getEntityConfig({ collectionSlug: docSlug })\n  const { reportUpdate } = useDocumentEvents()\n\n  const collectionSlug = collectionConfig.slug\n\n  const [schemaPath] = React.useState(collectionSlug)\n\n  const onSave = useCallback(\n    (json) => {\n      reportUpdate({\n        doc: json?.doc || json?.result,\n        drawerSlug,\n        entitySlug: collectionSlug,\n        operation: 'create',\n        updatedAt: json?.result?.updatedAt || new Date().toISOString(),\n      })\n\n      if (typeof onSaveFromContext === 'function') {\n        void onSaveFromContext({\n          ...json,\n          operation: 'create',\n        })\n      }\n      resetUploadEdits()\n    },\n    [collectionSlug, onSaveFromContext, reportUpdate, resetUploadEdits, drawerSlug],\n  )\n\n  const onChange: NonNullable<FormProps['onChange']>[0] = useCallback(\n    async ({ formState: prevFormState, submitted }) => {\n      const controller = handleAbortRef(abortOnChangeRef)\n\n      const docPreferences = await getDocPreferences()\n\n      const { state: newFormState } = await getFormState({\n        collectionSlug,\n        docPermissions,\n        docPreferences,\n        formState: prevFormState,\n        operation: 'create',\n        schemaPath,\n        signal: controller.signal,\n        skipValidation: !submitted,\n      })\n\n      abortOnChangeRef.current = null\n\n      return newFormState\n    },\n    [collectionSlug, schemaPath, getDocPreferences, getFormState, docPermissions],\n  )\n\n  useEffect(() => {\n    const abortOnChange = abortOnChangeRef.current\n\n    return () => {\n      abortAndIgnore(abortOnChange)\n    }\n  }, [])\n\n  return (\n    <OperationProvider operation=\"create\">\n      <Form\n        action={action}\n        className={`${baseClass}__form`}\n        disabled={isInitializing || !hasSavePermission}\n        initialState={isInitializing ? undefined : initialState}\n        isInitializing={isInitializing}\n        method=\"POST\"\n        onChange={[onChange]}\n        onSuccess={onSave}\n        submitted={submitted}\n      >\n        <DocumentFields\n          BeforeFields={\n            <React.Fragment>\n              {CustomUpload || (\n                <Upload_v4\n                  collectionSlug={collectionConfig.slug}\n                  customActions={[\n                    folders && collectionConfig.folders && (\n                      <MoveDocToFolder\n                        buttonProps={{\n                          buttonStyle: 'pill',\n                          size: 'small',\n                        }}\n                        folderCollectionSlug={folders.slug}\n                        folderFieldName={folders.fieldName}\n                        key=\"move-doc-to-folder\"\n                      />\n                    ),\n                  ].filter(Boolean)}\n                  initialState={initialState}\n                  resetUploadEdits={resetUploadEdits}\n                  updateUploadEdits={updateUploadEdits}\n                  uploadConfig={collectionConfig.upload}\n                  uploadEdits={uploadEdits}\n                />\n              )}\n            </React.Fragment>\n          }\n          docPermissions={docPermissions}\n          fields={collectionConfig.fields}\n          schemaPathSegments={[collectionConfig.slug]}\n        />\n        <ReportAllErrors />\n        <GetFieldProxy />\n      </Form>\n    </OperationProvider>\n  )\n}\n\nfunction GetFieldProxy() {\n  const { getField, getFields } = useForm()\n  const { getFormDataRef } = useFormsManager()\n\n  useEffect(() => {\n    // eslint-disable-next-line react-compiler/react-compiler -- TODO: fix\n    getFormDataRef.current = getFields\n  }, [getFields, getField, getFormDataRef])\n\n  return null\n}\n\nfunction ReportAllErrors() {\n  const { docConfig } = useDocumentInfo()\n  const { activeIndex, forms, setFormTotalErrorCount } = useFormsManager()\n  const errorCountRef = React.useRef(0)\n\n  const fileIsValid = useMemo(() => {\n    const currentForm = forms[activeIndex]\n    return currentForm?.formState?.file?.valid ?? true\n  }, [activeIndex, forms])\n\n  const reportFormErrorCount = React.useCallback(\n    (fieldErrorCount: number) => {\n      let newErrorCount = fieldErrorCount\n      // If the file is invalid, count that as an error\n      if (!fileIsValid) {\n        newErrorCount += 1\n      }\n      if (newErrorCount === errorCountRef.current) {\n        return\n      }\n      setFormTotalErrorCount({ errorCount: newErrorCount, index: activeIndex })\n      errorCountRef.current = newErrorCount\n    },\n    [activeIndex, setFormTotalErrorCount, fileIsValid],\n  )\n\n  if (!docConfig) {\n    return null\n  }\n\n  return (\n    <WatchChildErrors fields={docConfig.fields} path={[]} setErrorCount={reportFormErrorCount} />\n  )\n}\n"],"mappings":"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","ignoreList":[]}