{"version":3,"file":"reducer.js","names":["v4","uuidv4","formsManagementReducer","state","action","type","newForms","i","forms","length","errorCount","formID","crypto","randomUUID","formState","initialState","file","initialValue","valid","value","uploadEdits","activeIndex","remainingFormStates","removedForm","splice","index","affectedByShift","nextIndex","boundedActiveIndex","Math","min","totalErrorCount","count","reduce","acc","form","updatedForms"],"sources":["../../../../src/elements/BulkUpload/FormsManager/reducer.ts"],"sourcesContent":["import type { FormState, UploadEdits } from 'payload'\n\nimport { v4 as uuidv4 } from 'uuid'\n\nimport type { InitialForms } from './index.js'\n\nexport type State = {\n  activeIndex: number\n  forms: {\n    errorCount: number\n    formID: string\n    formState: FormState\n    uploadEdits?: UploadEdits\n  }[]\n  totalErrorCount: number\n}\n\ntype Action =\n  | {\n      count: number\n      index: number\n      type: 'UPDATE_ERROR_COUNT'\n    }\n  | {\n      errorCount: number\n      formState: FormState\n      index: number\n      type: 'UPDATE_FORM'\n      updatedFields?: Record<string, unknown>\n      uploadEdits?: UploadEdits\n    }\n  | {\n      forms: InitialForms\n      type: 'ADD_FORMS'\n    }\n  | {\n      index: number\n      type: 'REMOVE_FORM'\n    }\n  | {\n      index: number\n      type: 'SET_ACTIVE_INDEX'\n    }\n  | {\n      state: Partial<State>\n      type: 'REPLACE'\n    }\n\nexport function formsManagementReducer(state: State, action: Action): State {\n  switch (action.type) {\n    case 'ADD_FORMS': {\n      const newForms: State['forms'] = []\n      for (let i = 0; i < action.forms.length; i++) {\n        newForms[i] = {\n          errorCount: 0,\n          formID: action.forms[i].formID ?? (crypto.randomUUID ? crypto.randomUUID() : uuidv4()),\n          formState: {\n            ...(action.forms[i].initialState || {}),\n            file: {\n              initialValue: action.forms[i].file,\n              valid: true,\n              value: action.forms[i].file,\n            },\n          },\n          uploadEdits: {},\n        }\n      }\n\n      return {\n        ...state,\n        activeIndex: 0,\n        forms: [...newForms, ...state.forms],\n      }\n    }\n    case 'REMOVE_FORM': {\n      const remainingFormStates = [...state.forms]\n      const [removedForm] = remainingFormStates.splice(action.index, 1)\n\n      const affectedByShift = state.activeIndex >= action.index\n      const nextIndex =\n        state.activeIndex === action.index\n          ? action.index\n          : affectedByShift\n            ? state.activeIndex - 1\n            : state.activeIndex\n      const boundedActiveIndex = Math.min(remainingFormStates.length - 1, nextIndex)\n\n      return {\n        ...state,\n        activeIndex: affectedByShift ? boundedActiveIndex : state.activeIndex,\n        forms: remainingFormStates,\n        totalErrorCount: state.totalErrorCount - removedForm.errorCount,\n      }\n    }\n    case 'REPLACE': {\n      return {\n        ...state,\n        ...action.state,\n      }\n    }\n    case 'SET_ACTIVE_INDEX': {\n      return {\n        ...state,\n        activeIndex: action.index,\n      }\n    }\n    case 'UPDATE_ERROR_COUNT': {\n      const forms = [...state.forms]\n      forms[action.index].errorCount = action.count\n\n      return {\n        ...state,\n        forms,\n        totalErrorCount: forms.reduce((acc, form) => acc + form.errorCount, 0),\n      }\n    }\n    case 'UPDATE_FORM': {\n      const updatedForms = [...state.forms]\n      updatedForms[action.index].errorCount = action.errorCount\n\n      // Merge the existing formState with the new formState\n      updatedForms[action.index] = {\n        ...updatedForms[action.index],\n        formState: {\n          ...updatedForms[action.index].formState,\n          ...action.formState,\n        },\n        uploadEdits: {\n          ...updatedForms[action.index].uploadEdits,\n          ...action.uploadEdits,\n        },\n      }\n\n      return {\n        ...state,\n        forms: updatedForms,\n        totalErrorCount: updatedForms.reduce((acc, form) => acc + form.errorCount, 0),\n      }\n    }\n    default: {\n      return state\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}