{"version":3,"file":"index.js","names":["useModal","formatAdminURL","React","useCallback","toast","useForm","useConfig","useDocumentInfo","useLocale","useTranslation","requests","Button","ConfirmationModal","baseClass","Status","id","collectionSlug","docPermissions","globalSlug","hasPublishedDoc","incrementVersionCount","isTrashed","setHasPublishedDoc","setMostRecentVersionIsAutosaved","setUnpublishedVersionCount","unpublishedVersionCount","toggleModal","config","routes","api","reset","resetForm","code","locale","i18n","t","unPublishModalSlug","revertModalSlug","statusToRender","displayStatusKey","performAction","action","url","method","body","_status","apiRoute","path","publishedDoc","get","headers","language","then","res","json","JSON","stringify","status","data","result","doc","success","message","errors","error","err","canUpdate","update","_jsx","className","title","_jsxs","Fragment","buttonStyle","onClick","confirmingLabel","heading","modalSlug","onConfirm"],"sources":["../../../src/elements/Status/index.tsx"],"sourcesContent":["'use client'\nimport { useModal } from '@faceless-ui/modal'\nimport { formatAdminURL } from 'payload/shared'\nimport React, { useCallback } from 'react'\nimport { toast } from 'sonner'\n\nimport { useForm } from '../../forms/Form/context.js'\nimport { useConfig } from '../../providers/Config/index.js'\nimport { useDocumentInfo } from '../../providers/DocumentInfo/index.js'\nimport { useLocale } from '../../providers/Locale/index.js'\nimport { useTranslation } from '../../providers/Translation/index.js'\nimport { requests } from '../../utilities/api.js'\nimport { Button } from '../Button/index.js'\nimport { ConfirmationModal } from '../ConfirmationModal/index.js'\nimport './index.scss'\n\nconst baseClass = 'status'\n\nexport const Status: React.FC = () => {\n  const {\n    id,\n    collectionSlug,\n    docPermissions,\n    globalSlug,\n    hasPublishedDoc,\n    incrementVersionCount,\n    isTrashed,\n    setHasPublishedDoc,\n    setMostRecentVersionIsAutosaved,\n    setUnpublishedVersionCount,\n    unpublishedVersionCount,\n  } = useDocumentInfo()\n\n  const { toggleModal } = useModal()\n\n  const {\n    config: {\n      routes: { api },\n    },\n  } = useConfig()\n\n  const { reset: resetForm } = useForm()\n  const { code: locale } = useLocale()\n  const { i18n, t } = useTranslation()\n\n  const unPublishModalSlug = `confirm-un-publish-${id}`\n  const revertModalSlug = `confirm-revert-${id}`\n\n  let statusToRender: 'changed' | 'draft' | 'published'\n\n  if (unpublishedVersionCount > 0 && hasPublishedDoc) {\n    statusToRender = 'changed'\n  } else if (!hasPublishedDoc) {\n    statusToRender = 'draft'\n  } else if (hasPublishedDoc && unpublishedVersionCount <= 0) {\n    statusToRender = 'published'\n  }\n\n  const displayStatusKey = isTrashed\n    ? hasPublishedDoc\n      ? 'previouslyPublished'\n      : 'previouslyDraft'\n    : statusToRender\n\n  const performAction = useCallback(\n    async (action: 'revert' | 'unpublish') => {\n      let url\n      let method\n      let body\n\n      if (action === 'unpublish') {\n        body = {\n          _status: 'draft',\n        }\n      }\n\n      if (collectionSlug) {\n        url = formatAdminURL({\n          apiRoute: api,\n          path: `/${collectionSlug}/${id}?locale=${locale}&fallback-locale=null&depth=0`,\n        })\n        method = 'patch'\n      }\n\n      if (globalSlug) {\n        url = formatAdminURL({\n          apiRoute: api,\n          path: `/globals/${globalSlug}?locale=${locale}&fallback-locale=null&depth=0`,\n        })\n        method = 'post'\n      }\n\n      if (action === 'revert') {\n        const publishedDoc = await requests\n          .get(url, {\n            headers: {\n              'Accept-Language': i18n.language,\n              'Content-Type': 'application/json',\n            },\n          })\n          .then((res) => res.json())\n\n        body = publishedDoc\n      }\n\n      const res = await requests[method](url, {\n        body: JSON.stringify(body),\n        headers: {\n          'Accept-Language': i18n.language,\n          'Content-Type': 'application/json',\n        },\n      })\n\n      if (res.status === 200) {\n        let data\n        const json = await res.json()\n\n        if (globalSlug) {\n          data = json.result\n        } else if (collectionSlug) {\n          data = json.doc\n        }\n\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises\n        resetForm(data)\n        toast.success(json.message)\n        incrementVersionCount()\n        setMostRecentVersionIsAutosaved(false)\n\n        if (action === 'unpublish') {\n          setHasPublishedDoc(false)\n        } else if (action === 'revert') {\n          setUnpublishedVersionCount(0)\n        }\n      } else {\n        try {\n          const json = await res.json()\n          if (json.errors?.[0]?.message) {\n            toast.error(json.errors[0].message)\n          } else if (json.error) {\n            toast.error(json.error)\n          } else {\n            toast.error(t('error:unPublishingDocument'))\n          }\n          // eslint-disable-next-line @typescript-eslint/no-unused-vars\n        } catch (err) {\n          toast.error(t('error:unPublishingDocument'))\n        }\n      }\n    },\n    [\n      api,\n      collectionSlug,\n      globalSlug,\n      id,\n      i18n.language,\n      incrementVersionCount,\n      locale,\n      resetForm,\n      setUnpublishedVersionCount,\n      setMostRecentVersionIsAutosaved,\n      t,\n      setHasPublishedDoc,\n    ],\n  )\n\n  const canUpdate = docPermissions?.update\n\n  if (statusToRender) {\n    return (\n      <div\n        className={baseClass}\n        title={`${t('version:status')}: ${t(`version:${displayStatusKey}`)}`}\n      >\n        <div className={`${baseClass}__value-wrap`}>\n          <span className={`${baseClass}__label`}>{t('version:status')}:&nbsp;</span>\n          <span className={`${baseClass}__value`}>{t(`version:${displayStatusKey}`)}</span>\n          {!isTrashed && canUpdate && statusToRender === 'published' && (\n            <React.Fragment>\n              &nbsp;&mdash;&nbsp;\n              <Button\n                buttonStyle=\"none\"\n                className={`${baseClass}__action`}\n                id={`action-unpublish`}\n                onClick={() => toggleModal(unPublishModalSlug)}\n              >\n                {t('version:unpublish')}\n              </Button>\n              <ConfirmationModal\n                body={t('version:aboutToUnpublish')}\n                confirmingLabel={t('version:unpublishing')}\n                heading={t('version:confirmUnpublish')}\n                modalSlug={unPublishModalSlug}\n                onConfirm={() => performAction('unpublish')}\n              />\n            </React.Fragment>\n          )}\n          {!isTrashed && canUpdate && hasPublishedDoc && statusToRender === 'changed' && (\n            <React.Fragment>\n              &nbsp;&mdash;&nbsp;\n              <Button\n                buttonStyle=\"none\"\n                className={`${baseClass}__action`}\n                id=\"action-revert-to-published\"\n                onClick={() => toggleModal(revertModalSlug)}\n              >\n                {t('version:revertToPublished')}\n              </Button>\n              <ConfirmationModal\n                body={t('version:aboutToRevertToPublished')}\n                confirmingLabel={t('version:reverting')}\n                heading={t('version:confirmRevertToSaved')}\n                modalSlug={revertModalSlug}\n                onConfirm={() => performAction('revert')}\n              />\n            </React.Fragment>\n          )}\n        </div>\n      </div>\n    )\n  }\n\n  return null\n}\n"],"mappings":"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","ignoreList":[]}