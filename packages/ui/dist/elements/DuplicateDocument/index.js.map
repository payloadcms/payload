{"version":3,"file":"index.js","names":["useModal","getTranslation","useRouter","formatAdminURL","hasDraftsEnabled","qs","React","useCallback","useMemo","toast","useForm","useFormModified","useConfig","useLocale","useRouteTransition","useTranslation","requests","traverseForLocalizedFields","ConfirmationModal","PopupList","SelectLocalesDrawer","DuplicateDocument","id","slug","onDuplicate","redirectAfterDuplicate","selectLocales","singularLabel","router","modified","openModal","code","localeCode","setModified","startRouteTransition","config","localization","routes","admin","adminRoute","api","apiRoute","getEntityConfig","collectionConfig","collectionSlug","i18n","t","modalSlug","drawerSlug","isDuplicateByLocaleEnabled","fields","handleDuplicate","args","selectedLocales","hasSelectedLocales","length","queryParams","locale","headers","language","credentials","res","post","path","stringify","addQueryPrefix","body","JSON","_status","doc","errors","message","json","status","success","label","push","error","_error","handleConfirmWithoutSaving","buttonLabel","_jsxs","Fragment","_jsx","Button","onClick","confirmLabel","heading","onConfirm"],"sources":["../../../src/elements/DuplicateDocument/index.tsx"],"sourcesContent":["'use client'\n\nimport type { SanitizedCollectionConfig } from 'payload'\n\nimport { useModal } from '@faceless-ui/modal'\nimport { getTranslation } from '@payloadcms/translations'\nimport { useRouter } from 'next/navigation.js'\nimport { formatAdminURL, hasDraftsEnabled } from 'payload/shared'\nimport * as qs from 'qs-esm'\nimport React, { useCallback, useMemo } from 'react'\nimport { toast } from 'sonner'\n\nimport type { DocumentDrawerContextType } from '../DocumentDrawer/Provider.js'\n\nimport { useForm, useFormModified } from '../../forms/Form/context.js'\nimport { useConfig } from '../../providers/Config/index.js'\nimport { useLocale } from '../../providers/Locale/index.js'\nimport { useRouteTransition } from '../../providers/RouteTransition/index.js'\nimport { useTranslation } from '../../providers/Translation/index.js'\nimport { requests } from '../../utilities/api.js'\nimport { traverseForLocalizedFields } from '../../utilities/traverseForLocalizedFields.js'\nimport { ConfirmationModal } from '../ConfirmationModal/index.js'\nimport { PopupList } from '../Popup/index.js'\nimport { SelectLocalesDrawer } from './SelectLocalesDrawer/index.js'\n\nexport type Props = {\n  readonly id: number | string\n  readonly onDuplicate?: DocumentDrawerContextType['onDuplicate']\n  readonly redirectAfterDuplicate?: boolean\n  readonly selectLocales?: boolean\n  readonly singularLabel: SanitizedCollectionConfig['labels']['singular']\n  readonly slug: string\n}\n\nexport const DuplicateDocument: React.FC<Props> = ({\n  id,\n  slug,\n  onDuplicate,\n  redirectAfterDuplicate = true,\n  selectLocales,\n  singularLabel,\n}) => {\n  const router = useRouter()\n  const modified = useFormModified()\n  const { openModal } = useModal()\n  const { code: localeCode } = useLocale()\n  const { setModified } = useForm()\n  const { startRouteTransition } = useRouteTransition()\n\n  const {\n    config: {\n      localization,\n      routes: { admin: adminRoute, api: apiRoute },\n    },\n    getEntityConfig,\n  } = useConfig()\n\n  const collectionConfig = getEntityConfig({ collectionSlug: slug })\n\n  const { i18n, t } = useTranslation()\n\n  const modalSlug = `duplicate-${id}`\n  const drawerSlug = `duplicate-locales-${id}`\n\n  const isDuplicateByLocaleEnabled = useMemo(() => {\n    if (selectLocales && collectionConfig) {\n      return traverseForLocalizedFields(collectionConfig.fields)\n    }\n    return false\n  }, [collectionConfig, selectLocales])\n\n  const handleDuplicate = useCallback(\n    async (args?: { selectedLocales?: string[] }) => {\n      const { selectedLocales } = args || {}\n      const hasSelectedLocales = selectedLocales && selectedLocales.length > 0\n\n      const queryParams: Record<string, string | string[]> = {}\n      if (localeCode) {\n        queryParams.locale = localeCode\n      }\n      if (hasSelectedLocales) {\n        queryParams.selectedLocales = selectedLocales\n      }\n\n      const headers = {\n        'Accept-Language': i18n.language,\n        'Content-Type': 'application/json',\n        credentials: 'include',\n      }\n\n      try {\n        const res = await requests.post(\n          formatAdminURL({\n            apiRoute,\n            path: `/${slug}/${id}/duplicate${qs.stringify(queryParams, {\n              addQueryPrefix: true,\n            })}`,\n          }),\n          {\n            body: JSON.stringify(hasDraftsEnabled(collectionConfig) ? { _status: 'draft' } : {}),\n            headers,\n          },\n        )\n\n        const { doc, errors, message } = await res.json()\n\n        if (res.status < 400) {\n          toast.success(\n            message ||\n              t('general:successfullyDuplicated', { label: getTranslation(singularLabel, i18n) }),\n          )\n\n          setModified(false)\n\n          if (redirectAfterDuplicate) {\n            return startRouteTransition(() =>\n              router.push(\n                formatAdminURL({\n                  adminRoute,\n                  path: `/collections/${slug}/${doc.id}${localeCode ? `?locale=${localeCode}` : ''}`,\n                }),\n              ),\n            )\n          }\n\n          if (typeof onDuplicate === 'function') {\n            void onDuplicate({ collectionConfig, doc })\n          }\n        } else {\n          toast.error(\n            errors?.[0].message ||\n              message ||\n              t('error:unspecific', { label: getTranslation(singularLabel, i18n) }),\n          )\n        }\n      } catch (_error) {\n        toast.error(t('error:unspecific', { label: getTranslation(singularLabel, i18n) }))\n      }\n    },\n    [\n      adminRoute,\n      apiRoute,\n      collectionConfig,\n      i18n,\n      id,\n      localeCode,\n      onDuplicate,\n      redirectAfterDuplicate,\n      router,\n      setModified,\n      singularLabel,\n      slug,\n      startRouteTransition,\n      t,\n    ],\n  )\n\n  const handleConfirmWithoutSaving = useCallback(async () => {\n    if (selectLocales) {\n      openModal(drawerSlug)\n    } else {\n      await handleDuplicate()\n    }\n  }, [handleDuplicate, drawerSlug, selectLocales, openModal])\n\n  const buttonLabel = selectLocales\n    ? `${t('general:duplicate')} ${t('localization:selectedLocales')}`\n    : t('general:duplicate')\n\n  if (!selectLocales || isDuplicateByLocaleEnabled) {\n    return (\n      <React.Fragment>\n        <PopupList.Button\n          id={`action-duplicate${isDuplicateByLocaleEnabled ? `-locales` : ''}`}\n          onClick={() => {\n            if (modified) {\n              openModal(modalSlug)\n            } else if (selectLocales) {\n              openModal(drawerSlug)\n            } else {\n              void handleDuplicate()\n            }\n          }}\n        >\n          {buttonLabel}\n        </PopupList.Button>\n        <ConfirmationModal\n          body={t('general:unsavedChangesDuplicate')}\n          confirmLabel={t('general:duplicateWithoutSaving')}\n          heading={t('general:unsavedChanges')}\n          modalSlug={modalSlug}\n          onConfirm={handleConfirmWithoutSaving}\n        />\n        {selectLocales && localization && (\n          <SelectLocalesDrawer\n            localization={localization}\n            onConfirm={handleDuplicate}\n            slug={drawerSlug}\n          />\n        )}\n      </React.Fragment>\n    )\n  }\n\n  return null\n}\n"],"mappings":"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","ignoreList":[]}