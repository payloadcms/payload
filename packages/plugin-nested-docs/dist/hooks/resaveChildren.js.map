{"version":3,"sources":["../../src/hooks/resaveChildren.ts"],"sourcesContent":["import type { CollectionAfterChangeHook, JsonObject, ValidationError } from 'payload'\n\nimport { APIError, ValidationErrorName } from 'payload'\n\nimport type { NestedDocsPluginConfig } from '../types.js'\n\nimport { populateBreadcrumbs } from '../utilities/populateBreadcrumbs.js'\n\nexport const resaveChildren =\n  (pluginConfig: NestedDocsPluginConfig): CollectionAfterChangeHook =>\n  async ({ collection, doc, req }) => {\n    if (collection?.versions?.drafts && doc._status !== 'published') {\n      // If the parent is a draft, don't resave children\n      return\n    }\n\n    const parentSlug = pluginConfig?.parentFieldSlug || 'parent'\n\n    const initialDraftChildren = await req.payload.find({\n      collection: collection.slug,\n      depth: 0,\n      draft: true,\n      limit: 0,\n      locale: req.locale,\n      req,\n      where: {\n        [parentSlug]: {\n          equals: doc.id,\n        },\n      },\n    })\n\n    const draftChildren = initialDraftChildren.docs.filter((child) => child._status === 'draft')\n\n    const publishedChildren = await req.payload.find({\n      collection: collection.slug,\n      depth: 0,\n      draft: false,\n      limit: 0,\n      locale: req.locale,\n      req,\n      where: {\n        [parentSlug]: {\n          equals: doc.id,\n        },\n      },\n    })\n\n    const childrenById = [...draftChildren, ...publishedChildren.docs].reduce<\n      Record<string, JsonObject[]>\n    >((acc, child) => {\n      acc[child.id] = acc[child.id] || []\n      acc[child.id]!.push(child)\n      return acc\n    }, {})\n\n    const sortedChildren = Object.values(childrenById).flatMap((group: JsonObject[]) => {\n      return group.sort((a, b) => {\n        if (a.updatedAt !== b.updatedAt) {\n          return a.updatedAt > b.updatedAt ? 1 : -1\n        }\n        return a._status === 'published' ? 1 : -1\n      })\n    })\n\n    if (sortedChildren.length) {\n      try {\n        for (const child of sortedChildren) {\n          const isDraft = child._status !== 'published'\n\n          await req.payload.update({\n            id: child.id,\n            collection: collection.slug,\n            data: populateBreadcrumbs({\n              collection,\n              data: child,\n              generateLabel: pluginConfig.generateLabel,\n              generateURL: pluginConfig.generateURL,\n              parentFieldName: pluginConfig.parentFieldSlug,\n              req,\n            }),\n            depth: 0,\n            draft: isDraft,\n            locale: req.locale,\n            req,\n          })\n        }\n      } catch (err: unknown) {\n        req.payload.logger.error(\n          `Nested Docs plugin encountered an error while re-saving a child document.`,\n        )\n        req.payload.logger.error(err)\n\n        if (\n          (err as ValidationError)?.name === ValidationErrorName &&\n          (err as ValidationError)?.data?.errors?.length\n        ) {\n          throw new APIError(\n            'Could not publish or save changes: One or more children are invalid.',\n            400,\n          )\n        }\n      }\n    }\n\n    return undefined\n  }\n"],"names":["APIError","ValidationErrorName","populateBreadcrumbs","resaveChildren","pluginConfig","collection","doc","req","versions","drafts","_status","parentSlug","parentFieldSlug","initialDraftChildren","payload","find","slug","depth","draft","limit","locale","where","equals","id","draftChildren","docs","filter","child","publishedChildren","childrenById","reduce","acc","push","sortedChildren","Object","values","flatMap","group","sort","a","b","updatedAt","length","isDraft","update","data","generateLabel","generateURL","parentFieldName","err","logger","error","name","errors","undefined"],"mappings":"AAEA,SAASA,QAAQ,EAAEC,mBAAmB,QAAQ,UAAS;AAIvD,SAASC,mBAAmB,QAAQ,sCAAqC;AAEzE,OAAO,MAAMC,iBACX,CAACC,eACD,OAAO,EAAEC,UAAU,EAAEC,GAAG,EAAEC,GAAG,EAAE;QAC7B,IAAIF,YAAYG,UAAUC,UAAUH,IAAII,OAAO,KAAK,aAAa;YAC/D,kDAAkD;YAClD;QACF;QAEA,MAAMC,aAAaP,cAAcQ,mBAAmB;QAEpD,MAAMC,uBAAuB,MAAMN,IAAIO,OAAO,CAACC,IAAI,CAAC;YAClDV,YAAYA,WAAWW,IAAI;YAC3BC,OAAO;YACPC,OAAO;YACPC,OAAO;YACPC,QAAQb,IAAIa,MAAM;YAClBb;YACAc,OAAO;gBACL,CAACV,WAAW,EAAE;oBACZW,QAAQhB,IAAIiB,EAAE;gBAChB;YACF;QACF;QAEA,MAAMC,gBAAgBX,qBAAqBY,IAAI,CAACC,MAAM,CAAC,CAACC,QAAUA,MAAMjB,OAAO,KAAK;QAEpF,MAAMkB,oBAAoB,MAAMrB,IAAIO,OAAO,CAACC,IAAI,CAAC;YAC/CV,YAAYA,WAAWW,IAAI;YAC3BC,OAAO;YACPC,OAAO;YACPC,OAAO;YACPC,QAAQb,IAAIa,MAAM;YAClBb;YACAc,OAAO;gBACL,CAACV,WAAW,EAAE;oBACZW,QAAQhB,IAAIiB,EAAE;gBAChB;YACF;QACF;QAEA,MAAMM,eAAe;eAAIL;eAAkBI,kBAAkBH,IAAI;SAAC,CAACK,MAAM,CAEvE,CAACC,KAAKJ;YACNI,GAAG,CAACJ,MAAMJ,EAAE,CAAC,GAAGQ,GAAG,CAACJ,MAAMJ,EAAE,CAAC,IAAI,EAAE;YACnCQ,GAAG,CAACJ,MAAMJ,EAAE,CAAC,CAAES,IAAI,CAACL;YACpB,OAAOI;QACT,GAAG,CAAC;QAEJ,MAAME,iBAAiBC,OAAOC,MAAM,CAACN,cAAcO,OAAO,CAAC,CAACC;YAC1D,OAAOA,MAAMC,IAAI,CAAC,CAACC,GAAGC;gBACpB,IAAID,EAAEE,SAAS,KAAKD,EAAEC,SAAS,EAAE;oBAC/B,OAAOF,EAAEE,SAAS,GAAGD,EAAEC,SAAS,GAAG,IAAI,CAAC;gBAC1C;gBACA,OAAOF,EAAE7B,OAAO,KAAK,cAAc,IAAI,CAAC;YAC1C;QACF;QAEA,IAAIuB,eAAeS,MAAM,EAAE;YACzB,IAAI;gBACF,KAAK,MAAMf,SAASM,eAAgB;oBAClC,MAAMU,UAAUhB,MAAMjB,OAAO,KAAK;oBAElC,MAAMH,IAAIO,OAAO,CAAC8B,MAAM,CAAC;wBACvBrB,IAAII,MAAMJ,EAAE;wBACZlB,YAAYA,WAAWW,IAAI;wBAC3B6B,MAAM3C,oBAAoB;4BACxBG;4BACAwC,MAAMlB;4BACNmB,eAAe1C,aAAa0C,aAAa;4BACzCC,aAAa3C,aAAa2C,WAAW;4BACrCC,iBAAiB5C,aAAaQ,eAAe;4BAC7CL;wBACF;wBACAU,OAAO;wBACPC,OAAOyB;wBACPvB,QAAQb,IAAIa,MAAM;wBAClBb;oBACF;gBACF;YACF,EAAE,OAAO0C,KAAc;gBACrB1C,IAAIO,OAAO,CAACoC,MAAM,CAACC,KAAK,CACtB,CAAC,yEAAyE,CAAC;gBAE7E5C,IAAIO,OAAO,CAACoC,MAAM,CAACC,KAAK,CAACF;gBAEzB,IACE,AAACA,KAAyBG,SAASnD,uBAClCgD,KAAyBJ,MAAMQ,QAAQX,QACxC;oBACA,MAAM,IAAI1C,SACR,wEACA;gBAEJ;YACF;QACF;QAEA,OAAOsD;IACT,EAAC"}