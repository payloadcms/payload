{"version":3,"sources":["../../src/hooks/resaveSelfAfterCreate.ts"],"sourcesContent":["import type { CollectionAfterChangeHook } from 'payload'\n\nimport type { Breadcrumb, NestedDocsPluginConfig } from '../types.js'\n\n// This hook automatically re-saves a document after it is created\n// so that we can build its breadcrumbs with the newly created document's ID.\n\nexport const resaveSelfAfterCreate =\n  (pluginConfig: NestedDocsPluginConfig): CollectionAfterChangeHook =>\n  async ({ collection, doc, operation, req }) => {\n    if (operation !== 'create') {\n      return undefined\n    }\n\n    const { locale, payload } = req\n    const breadcrumbSlug = pluginConfig.breadcrumbsFieldSlug || 'breadcrumbs'\n    const breadcrumbs = doc[breadcrumbSlug] as unknown as Breadcrumb[]\n\n    try {\n      await payload.update({\n        id: doc.id,\n        collection: collection.slug,\n        data: {\n          [breadcrumbSlug]:\n            breadcrumbs?.map((crumb, i) => ({\n              ...crumb,\n              doc: breadcrumbs.length === i + 1 ? doc.id : crumb.doc,\n            })) || [],\n        },\n        depth: 0,\n        draft: collection?.versions?.drafts && doc._status !== 'published',\n        locale,\n        req,\n      })\n    } catch (err: unknown) {\n      payload.logger.error(\n        `Nested Docs plugin has had an error while adding breadcrumbs during document creation.`,\n      )\n      payload.logger.error(err)\n    }\n  }\n"],"names":["resaveSelfAfterCreate","pluginConfig","collection","doc","operation","req","undefined","locale","payload","breadcrumbSlug","breadcrumbsFieldSlug","breadcrumbs","update","id","slug","data","map","crumb","i","length","depth","draft","versions","drafts","_status","err","logger","error"],"mappings":"AAIA,kEAAkE;AAClE,6EAA6E;AAE7E,OAAO,MAAMA,wBACX,CAACC,eACD,OAAO,EAAEC,UAAU,EAAEC,GAAG,EAAEC,SAAS,EAAEC,GAAG,EAAE;QACxC,IAAID,cAAc,UAAU;YAC1B,OAAOE;QACT;QAEA,MAAM,EAAEC,MAAM,EAAEC,OAAO,EAAE,GAAGH;QAC5B,MAAMI,iBAAiBR,aAAaS,oBAAoB,IAAI;QAC5D,MAAMC,cAAcR,GAAG,CAACM,eAAe;QAEvC,IAAI;YACF,MAAMD,QAAQI,MAAM,CAAC;gBACnBC,IAAIV,IAAIU,EAAE;gBACVX,YAAYA,WAAWY,IAAI;gBAC3BC,MAAM;oBACJ,CAACN,eAAe,EACdE,aAAaK,IAAI,CAACC,OAAOC,IAAO,CAAA;4BAC9B,GAAGD,KAAK;4BACRd,KAAKQ,YAAYQ,MAAM,KAAKD,IAAI,IAAIf,IAAIU,EAAE,GAAGI,MAAMd,GAAG;wBACxD,CAAA,MAAO,EAAE;gBACb;gBACAiB,OAAO;gBACPC,OAAOnB,YAAYoB,UAAUC,UAAUpB,IAAIqB,OAAO,KAAK;gBACvDjB;gBACAF;YACF;QACF,EAAE,OAAOoB,KAAc;YACrBjB,QAAQkB,MAAM,CAACC,KAAK,CAClB,CAAC,sFAAsF,CAAC;YAE1FnB,QAAQkB,MAAM,CAACC,KAAK,CAACF;QACvB;IACF,EAAC"}