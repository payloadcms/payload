{"version":3,"sources":["../src/index.tsx"],"sourcesContent":["import type { Config, Field, GroupField, TabsField } from 'payload'\n\nimport { deepMergeSimple } from 'payload/shared'\n\nimport type {\n  GenerateDescription,\n  GenerateImage,\n  GenerateTitle,\n  GenerateURL,\n  SEOPluginConfig,\n} from './types.js'\n\nimport { MetaDescriptionField } from './fields/MetaDescription/index.js'\nimport { MetaImageField } from './fields/MetaImage/index.js'\nimport { MetaTitleField } from './fields/MetaTitle/index.js'\nimport { OverviewField } from './fields/Overview/index.js'\nimport { PreviewField } from './fields/Preview/index.js'\nimport { translations } from './translations/index.js'\n\nexport const seoPlugin =\n  (pluginConfig: SEOPluginConfig) =>\n  (config: Config): Config => {\n    const defaultFields: Field[] = [\n      OverviewField({}),\n      MetaTitleField({\n        hasGenerateFn: typeof pluginConfig?.generateTitle === 'function',\n      }),\n      MetaDescriptionField({\n        hasGenerateFn: typeof pluginConfig?.generateDescription === 'function',\n      }),\n      ...(pluginConfig?.uploadsCollection\n        ? [\n            MetaImageField({\n              hasGenerateFn: typeof pluginConfig?.generateImage === 'function',\n              relationTo: pluginConfig.uploadsCollection as string,\n            }),\n          ]\n        : []),\n      PreviewField({\n        hasGenerateFn: typeof pluginConfig?.generateURL === 'function',\n      }),\n    ]\n\n    const seoFields: GroupField[] = [\n      {\n        name: 'meta',\n        type: 'group',\n        fields: [\n          ...(pluginConfig?.fields && typeof pluginConfig.fields === 'function'\n            ? pluginConfig.fields({ defaultFields })\n            : defaultFields),\n        ],\n        interfaceName: pluginConfig.interfaceName,\n        label: 'SEO',\n      },\n    ]\n\n    return {\n      ...config,\n      collections:\n        config.collections?.map((collection) => {\n          const { slug } = collection\n          const isEnabled = pluginConfig?.collections?.includes(slug)\n\n          if (isEnabled) {\n            if (pluginConfig?.tabbedUI) {\n              // prevent issues with auth enabled collections having an email field that shouldn't be moved to the SEO tab\n              const emailField =\n                collection.auth &&\n                !(typeof collection.auth === 'object' && collection.auth.disableLocalStrategy) &&\n                collection.fields?.find((field) => 'name' in field && field.name === 'email')\n              const hasOnlyEmailField = collection.fields?.length === 1 && emailField\n\n              const seoTabs: TabsField[] = hasOnlyEmailField\n                ? [\n                    {\n                      type: 'tabs',\n                      tabs: [\n                        {\n                          fields: seoFields,\n                          label: 'SEO',\n                        },\n                      ],\n                    },\n                  ]\n                : [\n                    {\n                      type: 'tabs',\n                      tabs: [\n                        // append a new tab onto the end of the tabs array, if there is one at the first index\n                        // if needed, create a new `Content` tab in the first index for this collection's base fields\n                        ...(collection?.fields?.[0]?.type === 'tabs' &&\n                        collection?.fields?.[0]?.tabs\n                          ? collection.fields[0].tabs\n                          : [\n                              {\n                                fields: [\n                                  ...(emailField\n                                    ? collection.fields.filter(\n                                        (field) => 'name' in field && field.name !== 'email',\n                                      )\n                                    : collection.fields),\n                                ],\n                                label: collection?.labels?.singular || 'Content',\n                              },\n                            ]),\n                        {\n                          fields: seoFields,\n                          label: 'SEO',\n                        },\n                      ],\n                    },\n                  ]\n\n              return {\n                ...collection,\n                fields: [\n                  ...(emailField ? [emailField] : []),\n                  ...seoTabs,\n                  ...(collection?.fields?.[0]?.type === 'tabs' ? collection.fields.slice(1) : []),\n                ],\n              }\n            }\n\n            return {\n              ...collection,\n              fields: [...(collection?.fields || []), ...seoFields],\n            }\n          }\n\n          return collection\n        }) || [],\n      endpoints: [\n        ...(config.endpoints ?? []),\n        {\n          handler: async (req) => {\n            const data: Omit<\n              Parameters<GenerateTitle>[0],\n              'collectionConfig' | 'globalConfig' | 'req'\n            > = await req.json?.()\n\n            const reqData = data ?? req.data\n\n            const result = pluginConfig.generateTitle\n              ? await pluginConfig.generateTitle({\n                  ...data,\n                  collectionConfig: config.collections?.find(\n                    (c) => c.slug === reqData.collectionSlug,\n                  ),\n                  globalConfig: config.globals?.find((g) => g.slug === reqData.globalSlug),\n                  req,\n                } satisfies Parameters<GenerateTitle>[0])\n              : ''\n            return new Response(JSON.stringify({ result }), { status: 200 })\n          },\n          method: 'post',\n          path: '/plugin-seo/generate-title',\n        },\n        {\n          handler: async (req) => {\n            const data: Omit<\n              Parameters<GenerateTitle>[0],\n              'collectionConfig' | 'globalConfig' | 'req'\n            > = await req.json?.()\n\n            const reqData = data ?? req.data\n\n            const result = pluginConfig.generateDescription\n              ? await pluginConfig.generateDescription({\n                  ...data,\n                  collectionConfig: config.collections?.find(\n                    (c) => c.slug === reqData.collectionSlug,\n                  ),\n                  globalConfig: config.globals?.find((g) => g.slug === reqData.globalSlug),\n                  req,\n                } satisfies Parameters<GenerateDescription>[0])\n              : ''\n            return new Response(JSON.stringify({ result }), { status: 200 })\n          },\n          method: 'post',\n          path: '/plugin-seo/generate-description',\n        },\n        {\n          handler: async (req) => {\n            const data: Omit<\n              Parameters<GenerateTitle>[0],\n              'collectionConfig' | 'globalConfig' | 'req'\n            > = await req.json?.()\n\n            const reqData = data ?? req.data\n\n            const result = pluginConfig.generateURL\n              ? await pluginConfig.generateURL({\n                  ...data,\n                  collectionConfig: config.collections?.find(\n                    (c) => c.slug === reqData.collectionSlug,\n                  ),\n                  globalConfig: config.globals?.find((g) => g.slug === reqData.globalSlug),\n                  req,\n                } satisfies Parameters<GenerateURL>[0])\n              : ''\n            return new Response(JSON.stringify({ result }), { status: 200 })\n          },\n          method: 'post',\n          path: '/plugin-seo/generate-url',\n        },\n        {\n          handler: async (req) => {\n            const data: Omit<\n              Parameters<GenerateTitle>[0],\n              'collectionConfig' | 'globalConfig' | 'req'\n            > = await req.json?.()\n\n            const reqData = data ?? req.data\n\n            const result = pluginConfig.generateImage\n              ? await pluginConfig.generateImage({\n                  ...data,\n                  collectionConfig: config.collections?.find(\n                    (c) => c.slug === reqData.collectionSlug,\n                  ),\n                  globalConfig: config.globals?.find((g) => g.slug === reqData.globalSlug),\n                  req,\n                } satisfies Parameters<GenerateImage>[0])\n              : ''\n            return new Response(JSON.stringify({ result }), { status: 200 })\n          },\n          method: 'post',\n          path: '/plugin-seo/generate-image',\n        },\n      ],\n      globals:\n        config.globals?.map((global) => {\n          const { slug } = global\n          const isEnabled = pluginConfig?.globals?.includes(slug)\n\n          if (isEnabled) {\n            if (pluginConfig?.tabbedUI) {\n              const seoTabs: TabsField[] = [\n                {\n                  type: 'tabs',\n                  tabs: [\n                    // append a new tab onto the end of the tabs array, if there is one at the first index\n                    // if needed, create a new `Content` tab in the first index for this global's base fields\n                    ...(global?.fields?.[0]?.type === 'tabs' && global?.fields?.[0].tabs\n                      ? global.fields[0].tabs\n                      : [\n                          {\n                            fields: [...(global?.fields || [])],\n                            label: global?.label || 'Content',\n                          },\n                        ]),\n                    {\n                      fields: seoFields,\n                      label: 'SEO',\n                    },\n                  ],\n                },\n              ]\n\n              return {\n                ...global,\n                fields: [\n                  ...seoTabs,\n                  ...(global?.fields?.[0]?.type === 'tabs' ? global.fields.slice(1) : []),\n                ],\n              }\n            }\n\n            return {\n              ...global,\n              fields: [...(global?.fields || []), ...seoFields],\n            }\n          }\n\n          return global\n        }) || [],\n      i18n: {\n        ...config.i18n,\n        translations: deepMergeSimple(translations, config.i18n?.translations ?? {}),\n      },\n    }\n  }\n"],"names":["deepMergeSimple","MetaDescriptionField","MetaImageField","MetaTitleField","OverviewField","PreviewField","translations","seoPlugin","pluginConfig","config","defaultFields","hasGenerateFn","generateTitle","generateDescription","uploadsCollection","generateImage","relationTo","generateURL","seoFields","name","type","fields","interfaceName","label","collections","map","collection","slug","isEnabled","includes","tabbedUI","emailField","auth","disableLocalStrategy","find","field","hasOnlyEmailField","length","seoTabs","tabs","filter","labels","singular","slice","endpoints","handler","req","data","json","reqData","result","collectionConfig","c","collectionSlug","globalConfig","globals","g","globalSlug","Response","JSON","stringify","status","method","path","global","i18n"],"mappings":"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"}