{"version":3,"sources":["../../../src/fields/MetaImage/MetaImageComponent.tsx"],"sourcesContent":["'use client'\n\nimport type { FieldType } from '@payloadcms/ui'\nimport type { UploadFieldClientProps } from 'payload'\n\nimport {\n  FieldLabel,\n  RenderCustomComponent,\n  UploadInput,\n  useConfig,\n  useDocumentInfo,\n  useDocumentTitle,\n  useField,\n  useForm,\n  useLocale,\n  useTranslation,\n} from '@payloadcms/ui'\nimport { reduceToSerializableFields } from '@payloadcms/ui/shared'\nimport { formatAdminURL } from 'payload/shared'\nimport React, { useCallback } from 'react'\n\nimport type { PluginSEOTranslationKeys, PluginSEOTranslations } from '../../translations/index.js'\nimport type { GenerateImage } from '../../types.js'\n\nimport { Pill } from '../../ui/Pill.js'\n\ntype MetaImageProps = {\n  readonly hasGenerateImageFn: boolean\n} & UploadFieldClientProps\n\nexport const MetaImageComponent: React.FC<MetaImageProps> = (props) => {\n  const {\n    field: { admin: { allowCreate } = {}, label, localized, relationTo, required },\n    hasGenerateImageFn,\n    readOnly,\n  } = props\n\n  const {\n    config: {\n      routes: { api },\n      serverURL,\n    },\n    getEntityConfig,\n  } = useConfig()\n\n  const {\n    customComponents: { Error, Label } = {},\n    filterOptions,\n    path,\n    setValue,\n    showError,\n    value,\n  }: FieldType<number | string> = useField()\n\n  const { t } = useTranslation<PluginSEOTranslations, PluginSEOTranslationKeys>()\n\n  const locale = useLocale()\n  const { getData } = useForm()\n  const docInfo = useDocumentInfo()\n\n  const { title } = useDocumentTitle()\n\n  const regenerateImage = useCallback(async () => {\n    if (!hasGenerateImageFn) {\n      return\n    }\n\n    const endpoint = formatAdminURL({\n      apiRoute: api,\n      path: '/plugin-seo/generate-image',\n    })\n\n    const genImageResponse = await fetch(endpoint, {\n      body: JSON.stringify({\n        id: docInfo.id,\n        collectionSlug: docInfo.collectionSlug,\n        doc: getData(),\n        docPermissions: docInfo.docPermissions,\n        globalSlug: docInfo.globalSlug,\n        hasPublishPermission: docInfo.hasPublishPermission,\n        hasSavePermission: docInfo.hasSavePermission,\n        initialData: docInfo.initialData,\n        initialState: reduceToSerializableFields(docInfo.initialState ?? {}),\n        locale: typeof locale === 'object' ? locale?.code : locale,\n        title,\n      } satisfies Omit<\n        Parameters<GenerateImage>[0],\n        'collectionConfig' | 'globalConfig' | 'hasPublishedDoc' | 'req' | 'versionCount'\n      >),\n      credentials: 'include',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      method: 'POST',\n    })\n\n    const { result: generatedImage } = await genImageResponse.json()\n\n    // string ids, number ids or nullish values\n    let newValue: null | number | string | undefined = generatedImage\n    // non-nullish resolved relations\n    if (typeof generatedImage === 'object' && generatedImage && 'id' in generatedImage) {\n      newValue = generatedImage.id\n    }\n\n    // coerce to an empty string for falsy (=empty) values\n    setValue(newValue || '')\n  }, [\n    hasGenerateImageFn,\n    api,\n    docInfo.id,\n    docInfo.collectionSlug,\n    docInfo.docPermissions,\n    docInfo.globalSlug,\n    docInfo.hasPublishPermission,\n    docInfo.hasSavePermission,\n    docInfo.initialData,\n    docInfo.initialState,\n    getData,\n    locale,\n    setValue,\n    title,\n  ])\n\n  const hasImage = Boolean(value)\n\n  const collection = getEntityConfig({ collectionSlug: relationTo })\n\n  return (\n    <div\n      style={{\n        marginBottom: '20px',\n      }}\n    >\n      <div\n        style={{\n          marginBottom: '5px',\n          position: 'relative',\n        }}\n      >\n        <div className=\"plugin-seo__field\">\n          <RenderCustomComponent\n            CustomComponent={Label}\n            Fallback={\n              <FieldLabel label={label} localized={localized} path={path} required={required} />\n            }\n          />\n          {hasGenerateImageFn && (\n            <React.Fragment>\n              &nbsp; &mdash; &nbsp;\n              <button\n                disabled={readOnly}\n                onClick={() => {\n                  void regenerateImage()\n                }}\n                style={{\n                  background: 'none',\n                  backgroundColor: 'transparent',\n                  border: 'none',\n                  color: 'currentcolor',\n                  cursor: 'pointer',\n                  padding: 0,\n                  textDecoration: 'underline',\n                }}\n                type=\"button\"\n              >\n                {t('plugin-seo:autoGenerate')}\n              </button>\n            </React.Fragment>\n          )}\n        </div>\n        {hasGenerateImageFn && (\n          <div\n            style={{\n              color: '#9A9A9A',\n            }}\n          >\n            {t('plugin-seo:imageAutoGenerationTip')}\n          </div>\n        )}\n      </div>\n      <div\n        style={{\n          marginBottom: '10px',\n          position: 'relative',\n        }}\n      >\n        <UploadInput\n          allowCreate={allowCreate !== false}\n          api={api}\n          collection={collection}\n          Error={Error}\n          filterOptions={filterOptions}\n          onChange={(incomingImage) => {\n            if (incomingImage !== null) {\n              if (typeof incomingImage === 'object') {\n                const { id: incomingID } = incomingImage\n                setValue(incomingID)\n              } else {\n                setValue(incomingImage)\n              }\n            } else {\n              setValue(null)\n            }\n          }}\n          path={path}\n          readOnly={readOnly}\n          relationTo={relationTo}\n          required={required}\n          serverURL={serverURL}\n          showError={showError}\n          style={{\n            marginBottom: 0,\n          }}\n          value={value}\n        />\n      </div>\n      <div\n        style={{\n          alignItems: 'center',\n          display: 'flex',\n          width: '100%',\n        }}\n      >\n        <Pill\n          backgroundColor={hasImage ? 'green' : 'red'}\n          color=\"white\"\n          label={hasImage ? t('plugin-seo:good') : t('plugin-seo:noImage')}\n        />\n      </div>\n    </div>\n  )\n}\n"],"names":["FieldLabel","RenderCustomComponent","UploadInput","useConfig","useDocumentInfo","useDocumentTitle","useField","useForm","useLocale","useTranslation","reduceToSerializableFields","formatAdminURL","React","useCallback","Pill","MetaImageComponent","props","field","admin","allowCreate","label","localized","relationTo","required","hasGenerateImageFn","readOnly","config","routes","api","serverURL","getEntityConfig","customComponents","Error","Label","filterOptions","path","setValue","showError","value","t","locale","getData","docInfo","title","regenerateImage","endpoint","apiRoute","genImageResponse","fetch","body","JSON","stringify","id","collectionSlug","doc","docPermissions","globalSlug","hasPublishPermission","hasSavePermission","initialData","initialState","code","credentials","headers","method","result","generatedImage","json","newValue","hasImage","Boolean","collection","div","style","marginBottom","position","className","CustomComponent","Fallback","Fragment","button","disabled","onClick","background","backgroundColor","border","color","cursor","padding","textDecoration","type","onChange","incomingImage","incomingID","alignItems","display","width"],"mappings":"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"}