{"version":3,"sources":["../../src/utilities/generateReindexHandler.ts"],"sourcesContent":["import type { PayloadHandler, Where } from 'payload'\n\nimport {\n  addLocalesToRequestFromData,\n  commitTransaction,\n  getAccessResults,\n  headersWithCors,\n  initTransaction,\n  killTransaction,\n} from 'payload'\n\nimport type { SanitizedSearchPluginConfig } from '../types.js'\n\nimport { syncDocAsSearchIndex } from './syncDocAsSearchIndex.js'\n\ntype ValidationResult = {\n  isValid: boolean\n  message?: string\n}\n\nexport const generateReindexHandler =\n  (pluginConfig: SanitizedSearchPluginConfig): PayloadHandler =>\n  async (req) => {\n    addLocalesToRequestFromData(req)\n    if (!req.json) {\n      return new Response('Req.json is undefined', { status: 400 })\n    }\n    const { collections = [] } = (await req.json()) as { collections: string[] }\n    const t = req.t\n\n    const searchSlug = pluginConfig?.searchOverrides?.slug || 'search'\n    const searchCollections = pluginConfig?.collections || []\n\n    async function validatePermissions(): Promise<ValidationResult> {\n      const accessResults = await getAccessResults({ req })\n      const searchAccessResults = accessResults.collections?.[searchSlug]\n      if (!searchAccessResults) {\n        return { isValid: false, message: t('error:notAllowedToPerformAction') }\n      }\n\n      const permissions = [searchAccessResults.delete, searchAccessResults.update]\n      // plugin doesn't allow create by default:\n      // if user provided, then add it to check\n      if (pluginConfig.searchOverrides?.access?.create) {\n        permissions.push(searchAccessResults.create)\n      }\n      // plugin allows reads by anyone by default:\n      // so if user provided, then add to check\n      if (pluginConfig.searchOverrides?.access?.read) {\n        permissions.push(searchAccessResults.read)\n      }\n      return permissions.every(Boolean)\n        ? { isValid: true }\n        : { isValid: false, message: t('error:notAllowedToPerformAction') }\n    }\n\n    function validateCollections(): ValidationResult {\n      const collectionsAreValid = collections.every((col) => searchCollections.includes(col))\n      return collections.length && collectionsAreValid\n        ? { isValid: true }\n        : { isValid: false, message: t('error:invalidRequestArgs', { args: `'collections'` }) }\n    }\n\n    const headers = headersWithCors({\n      headers: new Headers(),\n      req,\n    })\n\n    const { isValid: hasPermissions, message: permissionError } = await validatePermissions()\n    if (!hasPermissions) {\n      return Response.json({ message: permissionError }, { headers, status: 401 })\n    }\n\n    const { isValid: validCollections, message: collectionError } = validateCollections()\n    if (!validCollections) {\n      return Response.json({ message: collectionError }, { headers, status: 400 })\n    }\n\n    const payload = req.payload\n    const { reindexBatchSize: batchSize, syncDrafts } = pluginConfig\n\n    const defaultLocalApiProps = {\n      overrideAccess: false,\n      req,\n      user: req.user,\n    }\n    const whereStatusPublished: Where = {\n      _status: {\n        equals: 'published',\n      },\n    }\n    let aggregateDocsWithDrafts = 0\n    let aggregateErrors = 0\n    let aggregateDocs = 0\n\n    async function countDocuments(collection: string, drafts?: boolean): Promise<number> {\n      const { totalDocs } = await payload.count({\n        collection,\n        ...defaultLocalApiProps,\n        req: undefined,\n        where: drafts ? undefined : whereStatusPublished,\n      })\n      return totalDocs\n    }\n\n    async function deleteIndexes(collection: string) {\n      await payload.delete({\n        collection: searchSlug,\n        depth: 0,\n        select: { id: true },\n        where: { 'doc.relationTo': { equals: collection } },\n        ...defaultLocalApiProps,\n      })\n    }\n\n    async function reindexCollection(collection: string) {\n      const draftsEnabled = Boolean(payload.collections[collection]?.config.versions?.drafts)\n\n      const totalDocsWithDrafts = await countDocuments(collection, true)\n      const totalDocs =\n        syncDrafts || !draftsEnabled\n          ? totalDocsWithDrafts\n          : await countDocuments(collection, !draftsEnabled)\n      const totalBatches = Math.ceil(totalDocs / batchSize)\n\n      aggregateDocsWithDrafts += totalDocsWithDrafts\n      aggregateDocs += totalDocs\n\n      // Loop through batches, then documents, then locales per document\n      for (let i = 0; i < totalBatches; i++) {\n        const defaultLocale = req.payload.config.localization\n          ? req.payload.config.localization.defaultLocale\n          : req.locale\n\n        const { docs } = await payload.find({\n          collection,\n          depth: 0,\n          limit: batchSize,\n          locale: defaultLocale,\n          page: i + 1,\n          where: syncDrafts || !draftsEnabled ? undefined : whereStatusPublished,\n          ...defaultLocalApiProps,\n        })\n\n        for (const doc of docs) {\n          // Get all configured locales\n          // If no localization, use [undefined] to sync once without a locale\n          const allLocales = req.payload.config.localization\n            ? req.payload.config.localization.localeCodes\n            : [undefined]\n\n          // Loop through all locales and check each one\n          let firstAllowedLocale = true\n          for (const localeToSync of allLocales) {\n            // Check if we should skip this locale for this document\n            let shouldSkip = false\n            if (typeof pluginConfig.skipSync === 'function') {\n              try {\n                shouldSkip = await pluginConfig.skipSync({\n                  collectionSlug: collection,\n                  doc,\n                  locale: localeToSync,\n                  req,\n                })\n              } catch (err) {\n                req.payload.logger.error({\n                  err,\n                  msg: 'Search plugin: Error executing skipSync. Proceeding with sync.',\n                })\n              }\n            }\n\n            if (shouldSkip) {\n              continue // Skip this locale\n            }\n\n            // Sync this locale (create first index, then update with other locales accordingly)\n            const operation = firstAllowedLocale ? 'create' : 'update'\n            firstAllowedLocale = false\n\n            await syncDocAsSearchIndex({\n              collection,\n              data: doc,\n              doc,\n              locale: localeToSync,\n              onSyncError: () => operation === 'create' && aggregateErrors++,\n              operation,\n              pluginConfig,\n              req,\n            })\n          }\n        }\n      }\n    }\n\n    const shouldCommit = await initTransaction(req)\n\n    try {\n      const promises = collections.map(async (collection) => {\n        try {\n          await deleteIndexes(collection)\n          await reindexCollection(collection)\n        } catch (err) {\n          const message = t('error:unableToReindexCollection', { collection })\n          payload.logger.error({ err, msg: message })\n        }\n      })\n\n      await Promise.all(promises)\n    } catch (err: any) {\n      if (shouldCommit) {\n        await killTransaction(req)\n      }\n      return Response.json({ message: err.message }, { headers, status: 500 })\n    }\n\n    const message = t('general:successfullyReindexed', {\n      collections: collections.join(', '),\n      count: aggregateDocs - aggregateErrors,\n      skips: syncDrafts ? 0 : aggregateDocsWithDrafts - aggregateDocs,\n      total: aggregateDocsWithDrafts,\n    })\n\n    if (shouldCommit) {\n      await commitTransaction(req)\n    }\n\n    return Response.json({ message }, { headers, status: 200 })\n  }\n"],"names":["addLocalesToRequestFromData","commitTransaction","getAccessResults","headersWithCors","initTransaction","killTransaction","syncDocAsSearchIndex","generateReindexHandler","pluginConfig","req","json","Response","status","collections","t","searchSlug","searchOverrides","slug","searchCollections","validatePermissions","accessResults","searchAccessResults","isValid","message","permissions","delete","update","access","create","push","read","every","Boolean","validateCollections","collectionsAreValid","col","includes","length","args","headers","Headers","hasPermissions","permissionError","validCollections","collectionError","payload","reindexBatchSize","batchSize","syncDrafts","defaultLocalApiProps","overrideAccess","user","whereStatusPublished","_status","equals","aggregateDocsWithDrafts","aggregateErrors","aggregateDocs","countDocuments","collection","drafts","totalDocs","count","undefined","where","deleteIndexes","depth","select","id","reindexCollection","draftsEnabled","config","versions","totalDocsWithDrafts","totalBatches","Math","ceil","i","defaultLocale","localization","locale","docs","find","limit","page","doc","allLocales","localeCodes","firstAllowedLocale","localeToSync","shouldSkip","skipSync","collectionSlug","err","logger","error","msg","operation","data","onSyncError","shouldCommit","promises","map","Promise","all","join","skips","total"],"mappings":"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"}