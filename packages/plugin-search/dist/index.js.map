{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import type { CollectionAfterChangeHook, Config } from 'payload'\n\nimport type { SanitizedSearchPluginConfig, SearchPluginConfig } from './types.js'\n\nimport { deleteFromSearch } from './Search/hooks/deleteFromSearch.js'\nimport { syncWithSearch } from './Search/hooks/syncWithSearch.js'\nimport { generateSearchCollection } from './Search/index.js'\n\ntype CollectionAfterChangeHookArgs = Parameters<CollectionAfterChangeHook>[0]\n\nexport const searchPlugin =\n  <ConfigTypes = unknown>(incomingPluginConfig: SearchPluginConfig<ConfigTypes>) =>\n  (config: Config): Config => {\n    const { collections } = config\n\n    // If the user defines `localize` to either true or false, use that\n    // Otherwise, set it based on if their config has localization enabled or disabled\n    const shouldLocalize =\n      typeof incomingPluginConfig.localize === 'boolean'\n        ? incomingPluginConfig.localize\n        : Boolean(config.localization)\n    incomingPluginConfig.localize = shouldLocalize\n\n    if (collections) {\n      const labels = Object.fromEntries(\n        collections\n          .filter(({ slug }) => incomingPluginConfig.collections?.includes(slug))\n          .map((collection) => [collection.slug, collection.labels]),\n      )\n\n      const pluginConfig: SanitizedSearchPluginConfig<ConfigTypes> = {\n        // write any config defaults here\n        deleteDrafts: true,\n        labels,\n        reindexBatchSize: incomingPluginConfig?.reindexBatchSize || 50,\n        syncDrafts: false,\n        ...incomingPluginConfig,\n      }\n\n      // add afterChange and afterDelete hooks to every search-enabled collection\n      const collectionsWithSearchHooks = config?.collections\n        ?.map((collection) => {\n          const { hooks: existingHooks } = collection\n\n          const enabledCollections = pluginConfig.collections || []\n          const isEnabled = enabledCollections.indexOf(collection.slug) > -1\n          if (isEnabled) {\n            return {\n              ...collection,\n              hooks: {\n                ...collection.hooks,\n                afterChange: [\n                  ...(existingHooks?.afterChange || []),\n                  async (args: CollectionAfterChangeHookArgs) => {\n                    await syncWithSearch({\n                      ...args,\n                      collection: collection.slug,\n                      pluginConfig,\n                    })\n                  },\n                ],\n                beforeDelete: [\n                  ...(existingHooks?.beforeDelete || []),\n                  deleteFromSearch(pluginConfig),\n                ],\n              },\n            }\n          }\n\n          return collection\n        })\n        .filter(Boolean)\n\n      return {\n        ...config,\n        collections: [\n          ...(collectionsWithSearchHooks || []),\n          generateSearchCollection(pluginConfig),\n        ],\n      }\n    }\n\n    return config\n  }\n"],"names":["deleteFromSearch","syncWithSearch","generateSearchCollection","searchPlugin","incomingPluginConfig","config","collections","shouldLocalize","localize","Boolean","localization","labels","Object","fromEntries","filter","slug","includes","map","collection","pluginConfig","deleteDrafts","reindexBatchSize","syncDrafts","collectionsWithSearchHooks","hooks","existingHooks","enabledCollections","isEnabled","indexOf","afterChange","args","beforeDelete"],"mappings":"AAIA,SAASA,gBAAgB,QAAQ,qCAAoC;AACrE,SAASC,cAAc,QAAQ,mCAAkC;AACjE,SAASC,wBAAwB,QAAQ,oBAAmB;AAI5D,OAAO,MAAMC,eACX,CAAwBC,uBACxB,CAACC;QACC,MAAM,EAAEC,WAAW,EAAE,GAAGD;QAExB,mEAAmE;QACnE,kFAAkF;QAClF,MAAME,iBACJ,OAAOH,qBAAqBI,QAAQ,KAAK,YACrCJ,qBAAqBI,QAAQ,GAC7BC,QAAQJ,OAAOK,YAAY;QACjCN,qBAAqBI,QAAQ,GAAGD;QAEhC,IAAID,aAAa;YACf,MAAMK,SAASC,OAAOC,WAAW,CAC/BP,YACGQ,MAAM,CAAC,CAAC,EAAEC,IAAI,EAAE,GAAKX,qBAAqBE,WAAW,EAAEU,SAASD,OAChEE,GAAG,CAAC,CAACC,aAAe;oBAACA,WAAWH,IAAI;oBAAEG,WAAWP,MAAM;iBAAC;YAG7D,MAAMQ,eAAyD;gBAC7D,iCAAiC;gBACjCC,cAAc;gBACdT;gBACAU,kBAAkBjB,sBAAsBiB,oBAAoB;gBAC5DC,YAAY;gBACZ,GAAGlB,oBAAoB;YACzB;YAEA,2EAA2E;YAC3E,MAAMmB,6BAA6BlB,QAAQC,aACvCW,IAAI,CAACC;gBACL,MAAM,EAAEM,OAAOC,aAAa,EAAE,GAAGP;gBAEjC,MAAMQ,qBAAqBP,aAAab,WAAW,IAAI,EAAE;gBACzD,MAAMqB,YAAYD,mBAAmBE,OAAO,CAACV,WAAWH,IAAI,IAAI,CAAC;gBACjE,IAAIY,WAAW;oBACb,OAAO;wBACL,GAAGT,UAAU;wBACbM,OAAO;4BACL,GAAGN,WAAWM,KAAK;4BACnBK,aAAa;mCACPJ,eAAeI,eAAe,EAAE;gCACpC,OAAOC;oCACL,MAAM7B,eAAe;wCACnB,GAAG6B,IAAI;wCACPZ,YAAYA,WAAWH,IAAI;wCAC3BI;oCACF;gCACF;6BACD;4BACDY,cAAc;mCACRN,eAAeM,gBAAgB,EAAE;gCACrC/B,iBAAiBmB;6BAClB;wBACH;oBACF;gBACF;gBAEA,OAAOD;YACT,GACCJ,OAAOL;YAEV,OAAO;gBACL,GAAGJ,MAAM;gBACTC,aAAa;uBACPiB,8BAA8B,EAAE;oBACpCrB,yBAAyBiB;iBAC1B;YACH;QACF;QAEA,OAAOd;IACT,EAAC"}