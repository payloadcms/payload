{"version":3,"file":"index.js","names":["useLexicalComposerContext","useLexicalEditable","getTranslation","Button","Drawer","EditDepthProvider","Form","formatDrawerSlug","FormSubmit","RenderFields","ShimmerEffect","useConfig","useDocumentForm","useDocumentInfo","useEditDepth","useServerFunctions","useTranslation","abortAndIgnore","$getNodeByKey","deepCopyObjectSimpleWithoutReactComponents","reduceFieldsToValues","React","createContext","useCallback","useEffect","useMemo","useRef","v4","uuid","useEditorConfigContext","useLexicalDrawer","$isInlineBlockNode","InlineBlockComponentContext","initialState","useInlineBlockComponentContext","use","InlineBlockComponent","props","cacheBuster","className","baseClass","formData","nodeKey","editor","isEditable","i18n","t","createdInlineBlock","fieldProps","featureClientSchemaMap","initialLexicalFormState","schemaPath","setCreatedInlineBlock","uuidFromContext","fields","parentDocumentFields","getFormState","editDepth","firstTimeDrawer","setInitialState","useState","cachedFormState","id","formState","Object","fromEntries","entries","map","fieldName","fieldState","initialValue","value","hasMounted","prevCacheBuster","current","CustomLabel","setCustomLabel","customComponents","BlockLabel","CustomBlock","setCustomBlock","Block","drawerSlug","slug","depth","toggleDrawer","inlineBlockElemElemRef","collectionSlug","getDocPreferences","globalSlug","config","componentMapRenderedBlockPath","blockType","clientSchemaMap","blocksField","clientBlock","blockReferences","blocksMap","blocks","clientBlockFields","getKey","length","undefined","removeInlineBlock","update","remove","blockDisplayName","labels","singular","onChangeAbortControllerRef","AbortController","schemaFieldsPath","abortController","awaitInitialState","state","data","docPermissions","docPreferences","documentFormState","excludeFiles","initialBlockData","initialBlockFormState","operation","readOnly","renderAllFields","signal","newFormStateData","node","newData","setFields","onChange","prevFormState","submit","controller","isStateOutOfSync","keys","some","key","onFormSubmit","RemoveButton","_jsx","buttonStyle","disabled","icon","onClick","e","preventDefault","round","size","tooltip","label","EditButton","el","InlineBlockContainer","children","filter","Boolean","join","ref","Label","_jsxs","beforeSubmit","disableValidationOnSubmit","onSubmit","title","_Fragment","forceRender","parentIndexPath","parentPath","parentSchemaPath","permissions","programmaticSubmit","height","width"],"sources":["../../../../../src/features/blocks/client/componentInline/index.tsx"],"sourcesContent":["'use client'\n\nimport type { BlocksFieldClient, ClientBlock, Data, FormState } from 'payload'\n\nimport { useLexicalComposerContext } from '@lexical/react/LexicalComposerContext'\nimport { useLexicalEditable } from '@lexical/react/useLexicalEditable'\nimport { getTranslation } from '@payloadcms/translations'\nimport {\n  Button,\n  Drawer,\n  EditDepthProvider,\n  Form,\n  formatDrawerSlug,\n  FormSubmit,\n  RenderFields,\n  ShimmerEffect,\n  useConfig,\n  useDocumentForm,\n  useDocumentInfo,\n  useEditDepth,\n  useServerFunctions,\n  useTranslation,\n} from '@payloadcms/ui'\nimport { abortAndIgnore } from '@payloadcms/ui/shared'\nimport { $getNodeByKey } from 'lexical'\n\nimport './index.scss'\n\nimport { deepCopyObjectSimpleWithoutReactComponents, reduceFieldsToValues } from 'payload/shared'\nimport React, { createContext, useCallback, useEffect, useMemo, useRef } from 'react'\nimport { v4 as uuid } from 'uuid'\n\nimport type { InlineBlockFields } from '../../server/nodes/InlineBlocksNode.js'\n\nimport { useEditorConfigContext } from '../../../../lexical/config/client/EditorConfigProvider.js'\nimport { useLexicalDrawer } from '../../../../utilities/fieldsDrawer/useLexicalDrawer.js'\nimport { $isInlineBlockNode } from '../nodes/InlineBlocksNode.js'\n\ntype Props = {\n  /**\n   * Can be modified by the node in order to trigger the re-fetch of the initial state based on the\n   * formData. This is useful when node.setFields() is explicitly called from outside of the form - in\n   * this case, the new field state is likely not reflected in the form state, so we need to re-fetch\n   */\n  readonly cacheBuster: number\n  readonly className: string\n  readonly formData: InlineBlockFields\n  readonly nodeKey: string\n}\n\ntype InlineBlockComponentContextType = {\n  EditButton?: React.FC\n  initialState: false | FormState | undefined\n  InlineBlockContainer?: React.FC<{ children: React.ReactNode }>\n  Label?: React.FC\n  nodeKey?: string\n  RemoveButton?: React.FC\n}\n\nconst InlineBlockComponentContext = createContext<InlineBlockComponentContextType>({\n  initialState: false,\n})\n\nexport const useInlineBlockComponentContext = () => React.use(InlineBlockComponentContext)\n\nexport const InlineBlockComponent: React.FC<Props> = (props) => {\n  const { cacheBuster, className: baseClass, formData, nodeKey } = props\n\n  const [editor] = useLexicalComposerContext()\n  const isEditable = useLexicalEditable()\n  const { i18n, t } = useTranslation<object, string>()\n  const {\n    createdInlineBlock,\n    fieldProps: { featureClientSchemaMap, initialLexicalFormState, schemaPath },\n    setCreatedInlineBlock,\n    uuid: uuidFromContext,\n  } = useEditorConfigContext()\n  const { fields: parentDocumentFields } = useDocumentForm()\n\n  const { getFormState } = useServerFunctions()\n  const editDepth = useEditDepth()\n  const firstTimeDrawer = useRef(false)\n\n  const [initialState, setInitialState] = React.useState<false | FormState | undefined>(() => {\n    // Initial form state that was calculated server-side. May have stale values\n    const cachedFormState = initialLexicalFormState?.[formData.id]?.formState\n    if (!cachedFormState) {\n      return false\n    }\n\n    // Merge current formData values into the cached form state\n    // This ensures that when the component remounts (e.g., due to view changes), we don't lose user edits\n    return Object.fromEntries(\n      Object.entries(cachedFormState).map(([fieldName, fieldState]) => [\n        fieldName,\n        fieldName in formData\n          ? {\n              ...fieldState,\n              initialValue: formData[fieldName],\n              value: formData[fieldName],\n            }\n          : fieldState,\n      ]),\n    )\n  })\n\n  const hasMounted = useRef(false)\n  const prevCacheBuster = useRef(cacheBuster)\n  useEffect(() => {\n    if (hasMounted.current) {\n      if (prevCacheBuster.current !== cacheBuster) {\n        setInitialState(false)\n      }\n      prevCacheBuster.current = cacheBuster\n    } else {\n      hasMounted.current = true\n    }\n  }, [cacheBuster])\n\n  const [CustomLabel, setCustomLabel] = React.useState<React.ReactNode | undefined>(\n    // @ts-expect-error - vestiges of when tsconfig was not strict. Feel free to improve\n    initialState?.['_components']?.customComponents?.BlockLabel,\n  )\n\n  const [CustomBlock, setCustomBlock] = React.useState<React.ReactNode | undefined>(\n    // @ts-expect-error - vestiges of when tsconfig was not strict. Feel free to improve\n    initialState?.['_components']?.customComponents?.Block,\n  )\n\n  const drawerSlug = formatDrawerSlug({\n    slug: `lexical-inlineBlocks-create-${uuidFromContext}-${formData.id}`,\n    depth: editDepth,\n  })\n  const { toggleDrawer } = useLexicalDrawer(drawerSlug, true)\n\n  const inlineBlockElemElemRef = useRef<HTMLDivElement | null>(null)\n  const { id, collectionSlug, getDocPreferences, globalSlug } = useDocumentInfo()\n  const { config } = useConfig()\n\n  const componentMapRenderedBlockPath = `${schemaPath}.lexical_internal_feature.blocks.lexical_inline_blocks.${formData.blockType}`\n\n  const clientSchemaMap = featureClientSchemaMap['blocks']\n\n  const blocksField: BlocksFieldClient = clientSchemaMap?.[\n    componentMapRenderedBlockPath\n  ]?.[0] as BlocksFieldClient\n\n  const clientBlock: ClientBlock | undefined = blocksField.blockReferences\n    ? typeof blocksField?.blockReferences?.[0] === 'string'\n      ? config.blocksMap[blocksField?.blockReferences?.[0]]\n      : blocksField?.blockReferences?.[0]\n    : blocksField?.blocks?.[0]\n\n  const clientBlockFields = clientBlock?.fields ?? []\n\n  // Open drawer on \"mount\"\n  useEffect(() => {\n    if (!firstTimeDrawer.current && createdInlineBlock?.getKey() === nodeKey) {\n      // > 2 because they always have \"id\" and \"blockName\" fields\n      if (clientBlockFields.length > 2) {\n        toggleDrawer()\n      }\n      setCreatedInlineBlock?.(undefined)\n      firstTimeDrawer.current = true\n    }\n  }, [clientBlockFields.length, createdInlineBlock, nodeKey, setCreatedInlineBlock, toggleDrawer])\n\n  const removeInlineBlock = useCallback(() => {\n    editor.update(() => {\n      $getNodeByKey(nodeKey)?.remove()\n    })\n  }, [editor, nodeKey])\n\n  const blockDisplayName = clientBlock?.labels?.singular\n    ? getTranslation(clientBlock?.labels.singular, i18n)\n    : clientBlock?.slug\n\n  const onChangeAbortControllerRef = useRef(new AbortController())\n  const schemaFieldsPath = `${schemaPath}.lexical_internal_feature.blocks.lexical_inline_blocks.${clientBlock?.slug}.fields`\n\n  // Initial state for newly created blocks\n  useEffect(() => {\n    const abortController = new AbortController()\n\n    const awaitInitialState = async () => {\n      /*\n       * This will only run if a new block is created. For all existing blocks that are loaded when the document is loaded, or when the form is saved,\n       * this is not run, as the lexical field RSC will fetch the state server-side and pass it to the client. That way, we avoid unnecessary client-side\n       * requests. Though for newly created blocks, we need to fetch the state client-side, as the server doesn't know about the block yet.\n       */\n      const { state } = await getFormState({\n        id,\n        collectionSlug,\n        data: formData,\n        docPermissions: { fields: true },\n        docPreferences: await getDocPreferences(),\n        documentFormState: deepCopyObjectSimpleWithoutReactComponents(parentDocumentFields, {\n          excludeFiles: true,\n        }),\n        globalSlug,\n        initialBlockData: formData,\n        initialBlockFormState: formData,\n        operation: 'update',\n        readOnly: !isEditable,\n        renderAllFields: true,\n        schemaPath: schemaFieldsPath,\n        signal: abortController.signal,\n      })\n\n      if (state) {\n        const newFormStateData: InlineBlockFields = reduceFieldsToValues(\n          deepCopyObjectSimpleWithoutReactComponents(state, { excludeFiles: true }),\n          true,\n        ) as InlineBlockFields\n\n        // Things like default values may come back from the server => update the node with the new data\n        editor.update(() => {\n          const node = $getNodeByKey(nodeKey)\n          if (node && $isInlineBlockNode(node)) {\n            const newData = newFormStateData\n            newData.blockType = formData.blockType\n\n            node.setFields(newData, true)\n          }\n        })\n\n        setInitialState(state)\n        setCustomLabel(state['_components']?.customComponents?.BlockLabel)\n        setCustomBlock(state['_components']?.customComponents?.Block)\n      }\n    }\n\n    if (formData && !initialState) {\n      void awaitInitialState()\n    }\n\n    return () => {\n      abortAndIgnore(abortController)\n    }\n  }, [\n    getFormState,\n    editor,\n    nodeKey,\n    isEditable,\n    schemaFieldsPath,\n    id,\n    formData,\n    initialState,\n    collectionSlug,\n    globalSlug,\n    getDocPreferences,\n    parentDocumentFields,\n  ])\n\n  /**\n   * HANDLE ONCHANGE\n   */\n  const onChange = useCallback(\n    async ({ formState: prevFormState, submit }: { formState: FormState; submit?: boolean }) => {\n      abortAndIgnore(onChangeAbortControllerRef.current)\n\n      const controller = new AbortController()\n      onChangeAbortControllerRef.current = controller\n\n      const { state } = await getFormState({\n        id,\n        collectionSlug,\n        docPermissions: {\n          fields: true,\n        },\n        docPreferences: await getDocPreferences(),\n        documentFormState: deepCopyObjectSimpleWithoutReactComponents(parentDocumentFields, {\n          excludeFiles: true,\n        }),\n        formState: prevFormState,\n        globalSlug,\n        initialBlockFormState: prevFormState,\n        operation: 'update',\n        readOnly: !isEditable,\n        renderAllFields: submit ? true : false,\n        schemaPath: schemaFieldsPath,\n        signal: controller.signal,\n      })\n\n      if (!state) {\n        return prevFormState\n      }\n\n      if (submit) {\n        setCustomLabel(state['_components']?.customComponents?.BlockLabel)\n        setCustomBlock(state['_components']?.customComponents?.Block)\n      }\n\n      return state\n    },\n    [\n      getFormState,\n      id,\n      collectionSlug,\n      getDocPreferences,\n      parentDocumentFields,\n      globalSlug,\n      isEditable,\n      schemaFieldsPath,\n    ],\n  )\n  // cleanup effect\n  useEffect(() => {\n    const isStateOutOfSync = (formData: InlineBlockFields, initialState: FormState) => {\n      return Object.keys(initialState).some(\n        (key) => initialState[key] && formData[key] !== initialState[key].value,\n      )\n    }\n\n    return () => {\n      // If the component is unmounted (either via removeInlineBlock or via lexical itself) and the form state got changed before,\n      // we need to reset the initial state to force a re-fetch of the initial state when it gets mounted again (e.g. via lexical history undo).\n      // Otherwise it would use an outdated initial state.\n      if (initialState && isStateOutOfSync(formData, initialState)) {\n        setInitialState(false)\n      }\n      abortAndIgnore(onChangeAbortControllerRef.current)\n    }\n  }, [formData, initialState])\n\n  /**\n   * HANDLE FORM SUBMIT\n   */\n  const onFormSubmit = useCallback(\n    (formState: FormState, newData: Data) => {\n      newData.blockType = formData.blockType\n\n      editor.update(() => {\n        const node = $getNodeByKey(nodeKey)\n        if (node && $isInlineBlockNode(node)) {\n          node.setFields(newData as InlineBlockFields, true)\n        }\n      })\n    },\n    [editor, nodeKey, formData],\n  )\n\n  const RemoveButton = useMemo(\n    () => () => (\n      <Button\n        buttonStyle=\"icon-label\"\n        className={`${baseClass}__removeButton`}\n        disabled={!isEditable}\n        icon=\"x\"\n        onClick={(e) => {\n          e.preventDefault()\n          removeInlineBlock()\n        }}\n        round\n        size=\"small\"\n        tooltip={t('lexical:blocks:inlineBlocks:remove', { label: blockDisplayName })}\n      />\n    ),\n    [baseClass, blockDisplayName, isEditable, removeInlineBlock, t],\n  )\n\n  const EditButton = useMemo(\n    () => () => (\n      <Button\n        buttonStyle=\"icon-label\"\n        className={`${baseClass}__editButton`}\n        disabled={!isEditable}\n        el=\"button\"\n        icon=\"edit\"\n        onClick={() => {\n          toggleDrawer()\n        }}\n        round\n        size=\"small\"\n        tooltip={t('lexical:blocks:inlineBlocks:edit', { label: blockDisplayName })}\n      />\n    ),\n    [baseClass, blockDisplayName, isEditable, t, toggleDrawer],\n  )\n\n  const InlineBlockContainer = useMemo(\n    () =>\n      ({ children, className }: { children: React.ReactNode; className?: string }) => (\n        <div\n          className={[`${baseClass}__container`, baseClass + '-' + formData.blockType, className]\n            .filter(Boolean)\n            .join(' ')}\n          ref={inlineBlockElemElemRef}\n        >\n          {children}\n        </div>\n      ),\n    [baseClass, formData.blockType],\n  )\n\n  const Label = useMemo(() => {\n    if (CustomLabel) {\n      return () => CustomLabel\n    } else {\n      return () => (\n        <div>{clientBlock?.labels ? getTranslation(clientBlock?.labels.singular, i18n) : ''}</div>\n      )\n    }\n  }, [CustomLabel, clientBlock?.labels, i18n])\n\n  if (!clientBlock) {\n    return (\n      <InlineBlockContainer className={`${baseClass}-not-found`}>\n        <span>Error: Block '{formData.blockType}' not found</span>\n        {isEditable ? (\n          <div className={`${baseClass}__actions`}>\n            <RemoveButton />\n          </div>\n        ) : null}\n      </InlineBlockContainer>\n    )\n  }\n\n  return (\n    <Form\n      beforeSubmit={[\n        async ({ formState }) => {\n          // This is only called when form is submitted from drawer\n          return await onChange({ formState, submit: true })\n        },\n      ]}\n      disableValidationOnSubmit\n      el=\"div\"\n      fields={clientBlock?.fields}\n      initialState={initialState || {}}\n      onChange={[onChange]}\n      onSubmit={(formState, data) => {\n        onFormSubmit(formState, data)\n        toggleDrawer()\n      }}\n      uuid={uuid()}\n    >\n      <EditDepthProvider>\n        <Drawer\n          className={''}\n          slug={drawerSlug}\n          title={t(`lexical:blocks:inlineBlocks:${formData?.id ? 'edit' : 'create'}`, {\n            label: blockDisplayName ?? t('lexical:blocks:inlineBlocks:label'),\n          })}\n        >\n          {initialState ? (\n            <>\n              <RenderFields\n                fields={clientBlock?.fields}\n                forceRender\n                parentIndexPath=\"\"\n                parentPath=\"\" // See Blocks feature path for details as for why this is empty\n                parentSchemaPath={schemaFieldsPath}\n                permissions={true}\n                readOnly={!isEditable}\n              />\n              <FormSubmit programmaticSubmit={true}>{t('fields:saveChanges')}</FormSubmit>\n            </>\n          ) : null}\n        </Drawer>\n      </EditDepthProvider>\n      {CustomBlock ? (\n        <InlineBlockComponentContext\n          value={{\n            EditButton,\n            initialState,\n            InlineBlockContainer,\n            Label,\n            nodeKey,\n            RemoveButton,\n          }}\n        >\n          {CustomBlock}\n        </InlineBlockComponentContext>\n      ) : (\n        <InlineBlockContainer>\n          {initialState ? <Label /> : <ShimmerEffect height=\"15px\" width=\"40px\" />}\n          {isEditable ? (\n            <div className={`${baseClass}__actions`}>\n              <EditButton />\n              <RemoveButton />\n            </div>\n          ) : null}\n        </InlineBlockContainer>\n      )}\n    </Form>\n  )\n}\n"],"mappings":"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","ignoreList":[]}