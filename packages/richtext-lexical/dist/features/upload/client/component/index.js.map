{"version":3,"file":"index.js","names":["useLexicalComposerContext","useLexicalEditable","getTranslation","Button","formatDrawerSlug","Thumbnail","useConfig","useEditDepth","usePayloadAPI","useTranslation","$getNodeByKey","formatAdminURL","isImage","React","useCallback","useId","useReducer","useRef","useState","useEditorConfigContext","FieldsDrawer","useLexicalDocumentDrawer","useLexicalDrawer","INSERT_UPLOAD_WITH_DRAWER_COMMAND","initialParams","depth","UploadComponent","props","className","baseClass","data","fields","relationTo","value","format","nodeKey","Error","config","routes","api","serverURL","getEntityConfig","uploadRef","uuid","editDepth","editor","editorConfig","fieldProps","schemaPath","isEditable","i18n","t","cacheBust","dispatchCacheBust","state","relatedCollection","collectionSlug","componentID","extraFieldsDrawerSlug","slug","toggleDrawer","closeDocumentDrawer","DocumentDrawer","DocumentDrawerToggler","id","setParams","apiRoute","path","thumbnailSRC","thumbnailURL","url","removeUpload","update","remove","updateUpload","_data","hasExtraFields","resolvedFeatureMap","get","sanitizedClientFeatureProps","collections","onExtraFieldsDrawerSubmit","_","uploadNode","newData","getData","setData","aspectRatio","width","height","_jsxs","undefined","filename","ref","_jsx","fileSrc","mimeType","size","role","buttonStyle","disabled","el","icon","onClick","round","tooltip","dispatchCommand","replace","e","preventDefault","labels","singular","onSave","drawerSlug","drawerTitle","label","featureKey","handleDrawerSubmit","schemaPathSuffix"],"sources":["../../../../../src/features/upload/client/component/index.tsx"],"sourcesContent":["'use client'\nimport type { ClientCollectionConfig, Data, FormState, JsonObject } from 'payload'\n\nimport { useLexicalComposerContext } from '@lexical/react/LexicalComposerContext.js'\nimport { useLexicalEditable } from '@lexical/react/useLexicalEditable'\nimport { getTranslation } from '@payloadcms/translations'\nimport {\n  Button,\n  formatDrawerSlug,\n  Thumbnail,\n  useConfig,\n  useEditDepth,\n  usePayloadAPI,\n  useTranslation,\n} from '@payloadcms/ui'\nimport { $getNodeByKey, type ElementFormatType } from 'lexical'\nimport { formatAdminURL, isImage } from 'payload/shared'\nimport React, { useCallback, useId, useReducer, useRef, useState } from 'react'\n\nimport type { BaseClientFeatureProps } from '../../../typesClient.js'\nimport type { UploadData } from '../../server/nodes/UploadNode.js'\nimport type { UploadFeaturePropsClient } from '../index.js'\nimport type { UploadNode } from '../nodes/UploadNode.js'\n\nimport { useEditorConfigContext } from '../../../../lexical/config/client/EditorConfigProvider.js'\nimport { FieldsDrawer } from '../../../../utilities/fieldsDrawer/Drawer.js'\nimport { useLexicalDocumentDrawer } from '../../../../utilities/fieldsDrawer/useLexicalDocumentDrawer.js'\nimport { useLexicalDrawer } from '../../../../utilities/fieldsDrawer/useLexicalDrawer.js'\nimport { INSERT_UPLOAD_WITH_DRAWER_COMMAND } from '../drawer/commands.js'\nimport './index.scss'\n\nconst initialParams = {\n  depth: 0,\n}\n\nexport type ElementProps = {\n  className: string\n  data: UploadData\n  format?: ElementFormatType\n  nodeKey: string\n}\n\nexport const UploadComponent: React.FC<ElementProps> = (props) => {\n  const {\n    className: baseClass,\n    data: { fields, relationTo, value },\n    format,\n    nodeKey,\n  } = props\n\n  if (typeof value === 'object') {\n    throw new Error(\n      'Upload value should be a string or number. The Lexical Upload component should not receive the populated value object.',\n    )\n  }\n\n  const {\n    config: {\n      routes: { api },\n      serverURL,\n    },\n    getEntityConfig,\n  } = useConfig()\n  const uploadRef = useRef<HTMLDivElement | null>(null)\n  const { uuid } = useEditorConfigContext()\n  const editDepth = useEditDepth()\n  const [editor] = useLexicalComposerContext()\n\n  const {\n    editorConfig,\n    fieldProps: { schemaPath },\n  } = useEditorConfigContext()\n  const isEditable = useLexicalEditable()\n  const { i18n, t } = useTranslation()\n  const [cacheBust, dispatchCacheBust] = useReducer((state) => state + 1, 0)\n  const [relatedCollection] = useState<ClientCollectionConfig>(() =>\n    getEntityConfig({ collectionSlug: relationTo }),\n  )\n\n  const componentID = useId()\n\n  const extraFieldsDrawerSlug = formatDrawerSlug({\n    slug: `lexical-upload-drawer-` + uuid + componentID, // There can be multiple upload components, each with their own drawer, in one single editor => separate them by componentID\n    depth: editDepth,\n  })\n\n  // Need to use hook to initialize useEffect that restores cursor position\n  const { toggleDrawer } = useLexicalDrawer(extraFieldsDrawerSlug, true)\n\n  const { closeDocumentDrawer, DocumentDrawer, DocumentDrawerToggler } = useLexicalDocumentDrawer({\n    id: value,\n    collectionSlug: relatedCollection.slug,\n  })\n\n  // Get the referenced document\n  const [{ data }, { setParams }] = usePayloadAPI(\n    formatAdminURL({ apiRoute: api, path: `/${relatedCollection.slug}/${value}`, serverURL }),\n    { initialParams },\n  )\n\n  const thumbnailSRC = data?.thumbnailURL || data?.url\n\n  const removeUpload = useCallback(() => {\n    editor.update(() => {\n      $getNodeByKey(nodeKey)?.remove()\n    })\n  }, [editor, nodeKey])\n\n  const updateUpload = useCallback(\n    (_data: Data) => {\n      setParams({\n        ...initialParams,\n        cacheBust, // do this to get the usePayloadAPI to re-fetch the data even though the URL string hasn't changed\n      })\n\n      dispatchCacheBust()\n      closeDocumentDrawer()\n    },\n    [setParams, cacheBust, closeDocumentDrawer],\n  )\n\n  const hasExtraFields = (\n    editorConfig?.resolvedFeatureMap?.get('upload')\n      ?.sanitizedClientFeatureProps as BaseClientFeatureProps<UploadFeaturePropsClient>\n  ).collections?.[relatedCollection.slug]?.hasExtraFields\n\n  const onExtraFieldsDrawerSubmit = useCallback(\n    (_: FormState, data: JsonObject) => {\n      // Update lexical node (with key nodeKey) with new data\n      editor.update(() => {\n        const uploadNode: null | UploadNode = $getNodeByKey(nodeKey)\n        if (uploadNode) {\n          const newData: UploadData = {\n            ...uploadNode.getData(),\n            fields: data,\n          }\n          uploadNode.setData(newData)\n        }\n      })\n    },\n    [editor, nodeKey],\n  )\n\n  const aspectRatio =\n    thumbnailSRC && data?.width && data?.height\n      ? data.width > data.height\n        ? 'landscape'\n        : 'portrait'\n      : 'landscape'\n\n  return (\n    <div\n      className={`${baseClass}__contents ${baseClass}__contents--${aspectRatio}`}\n      data-align={format || undefined}\n      data-filename={data?.filename}\n      ref={uploadRef}\n    >\n      <div className={`${baseClass}__card`}>\n        <div className={`${baseClass}__media`}>\n          <Thumbnail\n            collectionSlug={relationTo}\n            fileSrc={isImage(data?.mimeType) ? thumbnailSRC : null}\n            height={data?.height}\n            size=\"none\"\n            width={data?.width}\n          />\n\n          {isEditable && (\n            <div className={`${baseClass}__overlay ${baseClass}__floater`}>\n              <div className={`${baseClass}__actions`} role=\"toolbar\">\n                {hasExtraFields ? (\n                  <Button\n                    buttonStyle=\"icon-label\"\n                    className={`${baseClass}__upload-drawer-toggler`}\n                    disabled={!isEditable}\n                    el=\"button\"\n                    icon=\"edit\"\n                    onClick={toggleDrawer}\n                    round\n                    size=\"medium\"\n                    tooltip={t('fields:editRelationship')}\n                  />\n                ) : null}\n\n                <Button\n                  buttonStyle=\"icon-label\"\n                  className={`${baseClass}__swap-drawer-toggler`}\n                  disabled={!isEditable}\n                  el=\"button\"\n                  icon=\"swap\"\n                  onClick={() => {\n                    editor.dispatchCommand(INSERT_UPLOAD_WITH_DRAWER_COMMAND, {\n                      replace: { nodeKey },\n                    })\n                  }}\n                  round\n                  size=\"medium\"\n                  tooltip={t('fields:swapUpload')}\n                />\n\n                <Button\n                  buttonStyle=\"icon-label\"\n                  className={`${baseClass}__removeButton`}\n                  disabled={!isEditable}\n                  icon=\"x\"\n                  onClick={(e) => {\n                    e.preventDefault()\n                    removeUpload()\n                  }}\n                  round\n                  size=\"medium\"\n                  tooltip={t('fields:removeUpload')}\n                />\n              </div>\n            </div>\n          )}\n        </div>\n\n        <div className={`${baseClass}__metaOverlay ${baseClass}__floater`}>\n          <DocumentDrawerToggler className={`${baseClass}__doc-drawer-toggler`}>\n            <strong className={`${baseClass}__filename`}>\n              {data?.filename || t('general:untitled')}\n            </strong>\n          </DocumentDrawerToggler>\n          <div className={`${baseClass}__collectionLabel`}>\n            {getTranslation(relatedCollection.labels.singular, i18n)}\n          </div>\n        </div>\n      </div>\n\n      {value ? <DocumentDrawer onSave={updateUpload} /> : null}\n      {hasExtraFields ? (\n        <FieldsDrawer\n          data={fields}\n          drawerSlug={extraFieldsDrawerSlug}\n          drawerTitle={t('general:editLabel', {\n            label: getTranslation(relatedCollection.labels.singular, i18n),\n          })}\n          featureKey=\"upload\"\n          handleDrawerSubmit={onExtraFieldsDrawerSubmit}\n          schemaPath={schemaPath}\n          schemaPathSuffix={relatedCollection.slug}\n        />\n      ) : null}\n    </div>\n  )\n}\n"],"mappings":"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","ignoreList":[]}