import{a as ie}from"./chunk-INBEEENE.js";import{b as se}from"./chunk-BZZVLW4U.js";import{jsx as s,jsxs as b,Fragment as ve}from"react/jsx-runtime";import{useLexicalComposerContext as Oe}from"@lexical/react/LexicalComposerContext";import{useLexicalEditable as $e}from"@lexical/react/useLexicalEditable";import{getTranslation as ce}from"@payloadcms/translations";import{Button as ae,Drawer as Te,EditDepthProvider as Ee,Form as Re,formatDrawerSlug as Pe,FormSubmit as Le,RenderFields as je,ShimmerEffect as Me,useConfig as Ae,useDocumentForm as Je,useDocumentInfo as Ke,useEditDepth as ze,useServerFunctions as Ve,useTranslation as He}from"@payloadcms/ui";import{abortAndIgnore as A}from"@payloadcms/ui/shared";import{$getNodeByKey as J}from"lexical";import{deepCopyObjectSimpleWithoutReactComponents as K,reduceFieldsToValues as We}from"payload/shared";import O,{createContext as qe,useCallback as z,useEffect as N,useMemo as v,useRef as _}from"react";import{v4 as Ge}from"uuid";import{jsx as ye}from"react/jsx-runtime";import Fe from"bson-objectid";import{$applyNodeReplacement as De}from"lexical";import we from"react";import{addClassNamesToElement as ge}from"@lexical/utils";import xe from"bson-objectid";import{$applyNodeReplacement as _e,DecoratorNode as Ce}from"lexical";var x=class extends Ce{__cacheBuster;__fields;constructor({cacheBuster:e,fields:n,key:t}){super(t),this.__fields=n,this.__cacheBuster=e||0}static clone(e){return new this({cacheBuster:e.__cacheBuster,fields:e.__fields,key:e.__key})}static getType(){return"inlineBlock"}static importDOM(){return{}}static importJSON(e){return Se(e.fields)}static isInline(){return!1}canIndent(){return!0}createDOM(e){let n=document.createElement("span");return ge(n,e?.theme?.inlineBlock),n}decorate(e,n){return null}exportDOM(){let e=document.createElement("span");e.classList.add("inline-block-container");let n=document.createTextNode(this.getTextContent());return e.append(n),{element:e}}exportJSON(){return{type:"inlineBlock",fields:this.getFields(),version:1}}getCacheBuster(){return this.getLatest().__cacheBuster}getFields(){return this.getLatest().__fields}getTextContent(){return"Block Field"}isInline(){return!0}setFields(e,n){let t=this.getWritable();t.__fields=e,n||t.__cacheBuster++}updateDOM(){return!1}};function Se(i){return _e(new x({fields:{...i,id:i?.id||new xe.default().toHexString()}}))}var Ie=we.lazy(()=>import("./componentInline-NL25DNZ5.js").then(i=>({default:i.InlineBlockComponent}))),I=class extends x{static clone(e){return super.clone(e)}static getType(){return super.getType()}static importJSON(e){return Ne(e.fields)}decorate(e,n){return ye(Ie,{cacheBuster:this.getCacheBuster(),className:n.theme.inlineBlock??"LexicalEditorTheme__inlineBlock",formData:this.getFields(),nodeKey:this.getKey()})}exportJSON(){return super.exportJSON()}};function Ne(i){return De(new I({fields:{...i,id:i?.id||new Fe.default().toHexString()}}))}function M(i){return i instanceof I}var ue=qe({initialState:!1}),gt=()=>O.use(ue),xt=i=>{let{cacheBuster:e,className:n,formData:t,nodeKey:d}=i,[f]=Oe(),c=$e(),{i18n:$,t:p}=He(),{createdInlineBlock:V,fieldProps:{featureClientSchemaMap:me,initialLexicalFormState:de,schemaPath:H},setCreatedInlineBlock:W,uuid:pe}=se(),{fields:C}=Je(),{getFormState:S}=Ve(),fe=ze(),q=_(!1),[a,T]=O.useState(()=>{let o=de?.[t.id]?.formState;return o?Object.fromEntries(Object.entries(o).map(([l,r])=>[l,l in t?{...r,initialValue:t[l],value:t[l]}:r])):!1}),G=_(!1),Q=_(e);N(()=>{G.current?(Q.current!==e&&T(!1),Q.current=e):G.current=!0},[e]);let[E,U]=O.useState(a?._components?.customComponents?.BlockLabel),[X,Y]=O.useState(a?._components?.customComponents?.Block),Z=Pe({slug:`lexical-inlineBlocks-create-${pe}-${t.id}`,depth:fe}),{toggleDrawer:h}=ie(Z,!0),be=_(null),{id:y,collectionSlug:F,getDocPreferences:D,globalSlug:w}=Ke(),{config:he}=Ae(),ke=`${H}.lexical_internal_feature.blocks.lexical_inline_blocks.${t.blockType}`,k=me.blocks?.[ke]?.[0],u=k.blockReferences?typeof k?.blockReferences?.[0]=="string"?he.blocksMap[k?.blockReferences?.[0]]:k?.blockReferences?.[0]:k?.blocks?.[0],ee=u?.fields??[];N(()=>{!q.current&&V?.getKey()===d&&(ee.length>2&&h(),W?.(void 0),q.current=!0)},[ee.length,V,d,W,h]);let te=z(()=>{f.update(()=>{J(d)?.remove()})},[f,d]),B=u?.labels?.singular?ce(u?.labels.singular,$):u?.slug,R=_(new AbortController),g=`${H}.lexical_internal_feature.blocks.lexical_inline_blocks.${u?.slug}.fields`;N(()=>{let o=new AbortController;return t&&!a&&(async()=>{let{state:r}=await S({id:y,collectionSlug:F,data:t,docPermissions:{fields:!0},docPreferences:await D(),documentFormState:K(C,{excludeFiles:!0}),globalSlug:w,initialBlockData:t,initialBlockFormState:t,operation:"update",readOnly:!c,renderAllFields:!0,schemaPath:g,signal:o.signal});if(r){let m=We(K(r,{excludeFiles:!0}),!0);f.update(()=>{let j=J(d);if(j&&M(j)){let le=m;le.blockType=t.blockType,j.setFields(le,!0)}}),T(r),U(r._components?.customComponents?.BlockLabel),Y(r._components?.customComponents?.Block)}})(),()=>{A(o)}},[S,f,d,c,g,y,t,a,F,w,D,C]);let ne=z(async({formState:o,submit:l})=>{A(R.current);let r=new AbortController;R.current=r;let{state:m}=await S({id:y,collectionSlug:F,docPermissions:{fields:!0},docPreferences:await D(),documentFormState:K(C,{excludeFiles:!0}),formState:o,globalSlug:w,initialBlockFormState:o,operation:"update",readOnly:!c,renderAllFields:!!l,schemaPath:g,signal:r.signal});return m?(l&&(U(m._components?.customComponents?.BlockLabel),Y(m._components?.customComponents?.Block)),m):o},[S,y,F,D,C,w,c,g]);N(()=>{let o=(l,r)=>Object.keys(r).some(m=>r[m]&&l[m]!==r[m].value);return()=>{a&&o(t,a)&&T(!1),A(R.current)}},[t,a]);let Be=z((o,l)=>{l.blockType=t.blockType,f.update(()=>{let r=J(d);r&&M(r)&&r.setFields(l,!0)})},[f,d,t]),P=v(()=>()=>s(ae,{buttonStyle:"icon-label",className:`${n}__removeButton`,disabled:!c,icon:"x",onClick:o=>{o.preventDefault(),te()},round:!0,size:"small",tooltip:p("lexical:blocks:inlineBlocks:remove",{label:B})}),[n,B,c,te,p]),oe=v(()=>()=>s(ae,{buttonStyle:"icon-label",className:`${n}__editButton`,disabled:!c,el:"button",icon:"edit",onClick:()=>{h()},round:!0,size:"small",tooltip:p("lexical:blocks:inlineBlocks:edit",{label:B})}),[n,B,c,p,h]),L=v(()=>({children:o,className:l})=>s("div",{className:[`${n}__container`,n+"-"+t.blockType,l].filter(Boolean).join(" "),ref:be,children:o}),[n,t.blockType]),re=v(()=>E?()=>E:()=>s("div",{children:u?.labels?ce(u?.labels.singular,$):""}),[E,u?.labels,$]);return u?b(Re,{beforeSubmit:[async({formState:o})=>await ne({formState:o,submit:!0})],disableValidationOnSubmit:!0,el:"div",fields:u?.fields,initialState:a||{},onChange:[ne],onSubmit:(o,l)=>{Be(o,l),h()},uuid:Ge(),children:[s(Ee,{children:s(Te,{className:"",slug:Z,title:p(`lexical:blocks:inlineBlocks:${t?.id?"edit":"create"}`,{label:B??p("lexical:blocks:inlineBlocks:label")}),children:a?b(ve,{children:[s(je,{fields:u?.fields,forceRender:!0,parentIndexPath:"",parentPath:"",parentSchemaPath:g,permissions:!0,readOnly:!c}),s(Le,{programmaticSubmit:!0,children:p("fields:saveChanges")})]}):null})}),X?s(ue,{value:{EditButton:oe,initialState:a,InlineBlockContainer:L,Label:re,nodeKey:d,RemoveButton:P},children:X}):b(L,{children:[a?s(re,{}):s(Me,{height:"15px",width:"40px"}),c?b("div",{className:`${n}__actions`,children:[s(oe,{}),s(P,{})]}):null]})]}):b(L,{className:`${n}-not-found`,children:[b("span",{children:["Error: Block '",t.blockType,"' not found"]}),c?s("div",{className:`${n}__actions`,children:s(P,{})}):null]})};export{gt as a,xt as b,I as c,Ne as d,M as e};
//# sourceMappingURL=chunk-2S5Q7QYO.js.map
