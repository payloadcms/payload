# Content API & DB Adapter - TODO Tracker

âœ… **CRITICAL ISSUE RESOLVED:** Drizzle ORM JSONB reference bug fixed - see [Issue #0](#-0-resolved---drizzle-orm-jsonb-reference-bug)

**Locations:**

- Content API: `/Users/gjablonski/figma/figma/payload/content-api/`
- DB Adapter: `/Users/gjablonski/Documents/GitHub/enterprise-plugins/packages/db-content-api/`
- Tests: `/Users/gjablonski/Documents/GitHub/payload/test/`

---

## âœ… Executive Summary for Content API Team

**CRITICAL BUG RESOLVED:** Drizzle ORM JSONB reference issue

**Root Cause:** Drizzle ORM was reusing the same object reference for JSONB `data` fields across all documents in a query result, causing all documents to appear to have identical data.

**The Fix:** Added deep cloning of `data` field in `findDocuments` service:

```typescript
// src/services/documents/findDocuments.ts
for (const doc of docs) {
  doc.data = JSON.parse(JSON.stringify(doc.data))
}
```

**Status:** âœ… Fixed in Content API codebase. Restart server to apply.

**Action Required:** Restart Content API server on `localhost:8080`:

```bash
cd /Users/gjablonski/figma/figma/payload/content-api
npm run dev
```

**Testing:** After restart, run:

```bash
cd /Users/gjablonski/Documents/GitHub/payload
pnpm test:int hooks --testNamePattern="should call afterLogin hook"
# Should now pass âœ…
```

See [Issue #0](#-0-resolved---drizzle-orm-jsonb-reference-bug) for full investigation details.

## Development Guidelines

### Priority Framework

1. **ğŸ”§ Adapter-fixable issues FIRST** - Logic errors, mapping bugs, edge cases
2. **ğŸš§ Content API limitations** - Document blockers, wait for upstream fixes
3. **ğŸ“‹ Nice-to-haves** - Optimizations, better error messages

### Workflow

1. Run `pnpm run test:int:summary` to see all test results
2. Pick a failing suite with high adapter-fix potential
3. Run specific suite: `pnpm test:int <suite-name>`
4. Debug by comparing with `db-mongodb` or `db-postgres` implementations
5. Fix in adapter (`db-content-api/src/index.ts`)
6. Test fix, update this document
7. Repeat

### When to Fix in Adapter vs Content API

**Fix in Adapter if:**

- Query conversion is wrong (WHERE, sort, pagination)
- Response mapping is incorrect (field names, types)
- Missing null/undefined handling
- UUID vs string type mismatches

**Fix in Content API if:**

- Missing fundamental feature (joins, select, locale)
- SQL query generation issue
- Database schema problem

## ğŸ§ª Testing

**Test Runner Script:** `pnpm run test:int:summary`

A custom script (`test/runTestsWithSummary.ts`) runs all integration tests suite-by-suite and displays:

- Pass/fail counts per suite
- Duration per suite
- Color-coded status (âœ… all pass, âš ï¸ partial pass, âŒ all fail)
- Overall summary

**To exclude suites:** Comment them out in the `TEST_SUITES` array in `runTestsWithSummary.ts`

**Excluded from testing:**

- `create-payload-app` - CLI tool, doesn't use db-adapter
- `joins` - Not supported yet in Content API
- `localization` - Not planned for EOY support
- `select` - Not planned for EOY support

## âš ï¸ Known Content API Limitations

**Source:** Anthony Salani (Dec 2024)

### Not Currently Supported

**Documents:**

- âŒ `join` clause - **Will be supported** (Q1 2025 or post-break)
- âŒ `returning` clause - Not planned for EOY
- âŒ `select` clause - Not planned for EOY
- âŒ `locale` clause - Not planned for EOY

**Document Versions:**

- âŒ No WHERE clauses supported yet

**Query Operators:**

- âŒ `near` - Not planned for EOY
- âŒ `within` - Not planned for EOY
- âŒ `intersects` - Not planned for EOY
- âŒ `all` - Not planned for EOY

### Impact on Test Suites

**Excluded from testing (in `TEST_SUITES`):**

- `joins` - Join clause not supported yet
- `localization` - Locale clause not planned for EOY
- `select` - Select clause not planned for EOY
- `create-payload-app` - CLI tool, doesn't use db-adapter

**Expected failures in active suites:**

- Version-related WHERE queries will fail (no version support)
- Operators: `near`, `within`, `intersects`, `all` will fail
- Any tests using `returning` or `select` clauses

**Don't debug these** - they're Content API limitations, not adapter bugs.

## ğŸ“š Adapter Implementation Details

### Document ID Mapping

Content API uses two ID fields:

- **`id`** (UUID, auto-generated by DB, private/internal use only)
- **`key`** (text, public document identifier, maps to Payload's `id`)

**In the adapter (`db-content-api/src/index.ts`):**

1. **ID Generation** (`create()` function):

   - If Payload provides `data.id`, use it as the `key`
   - Otherwise, generate a UUID using the `uuid` package (same as `db-postgres`, `db-drizzle`)
   - Content API's `id` is never touched by the adapter

2. **Query Mapping** (`convertPayloadWhereToContentAPI()`):

   - Payload's `id` field â†’ Content API's `key` field
   - Example: `{ id: { equals: "..." } }` â†’ `{ path: "key", operator: "equals", ... }`

3. **Response Mapping** (`unwrapDocument()`):
   - Content API's `key` â†’ Payload's `id`
   - Example: `doc.key` â†’ `id: doc.key`

**Future Rename:** Content API will rename these fields to `internal_id` and `external_id` (or similar) to clarify their purpose.

### Limit and Pagination Handling

**Consistent semantics across Payload, DB Adapters, and Content API:**

| Value       | Meaning          | SQL Result |
| ----------- | ---------------- | ---------- |
| `undefined` | Use default (10) | `LIMIT 10` |
| `0`         | Unlimited        | No LIMIT   |
| `> 0`       | Specific limit   | `LIMIT n`  |

**Implementation:**

- **Payload**: `limit ?? (usePagination ? 10 : 0)` â†’ default 10 with pagination, 0 without
- **DB Adapters**: `if (limit === 0) { limit = undefined }` â†’ omit LIMIT in SQL when 0
- **Content API**: `limit ?? 10` â†’ default 10, then `if (limit > 0) { query.limit(limit) }`
- **Adapter**: Passes `limit` directly (no transformation needed)

## ğŸ“Š Current Status

âœ… **BLOCKER RESOLVED:** Drizzle ORM JSONB reference bug fixed

**Full Test Run:** 330/1512 tests passing (22% overall) - **Expected to improve significantly after applying fix**
**Root Cause:** Drizzle ORM was reusing the same object reference for JSONB `data` fields across all query results
**Fix:** Deep clone added to `findDocuments` service in Content API

**Investigation Summary:**

1. âœ… Verified adapter's `create()` sends correct data
2. âœ… Verified adapter's `convertPayloadWhereToContentAPI()` - Works correctly
3. âœ… Verified adapter's `unwrapDocument()` - Works correctly
4. âœ… Verified `onInit` and seeding - Users created successfully with correct data
5. âœ… Traced full login flow - Found issue was in Content API's data retrieval
6. âœ… Isolated issue to Content API via HTTP endpoint
7. âœ… Created isolated Content API tests - all passed (direct service calls worked)
8. ğŸ¯ **FOUND:** Drizzle ORM reusing JSONB object references across query results
9. âœ… **FIXED:** Added deep clone to `findDocuments` service

**Next Steps:**

1. Restart Content API server to apply fix
2. Re-run test suite to verify improvements
3. Continue with adapter development

**Commands:**

- Full summary: `pnpm run test:int:summary`
- Single suite: `pnpm test:int <suite-name>` (e.g., `pnpm test:int hooks`)
- Test the fix: `pnpm test:int hooks --testNamePattern="should call afterLogin hook"`

---

## ğŸ”´ Active Issues

**Priority:** Focus on adapter-fixable issues first (marked with ğŸ”§)

---

### âœ… #0: RESOLVED - Drizzle ORM JSONB Reference Bug

**Impact:** CRITICAL - **Drizzle ORM bug in Content API, NOT adapter**
**Affects:** ALL multi-document collections, ANY find() operation
**Status:** âœ… FIXED - Deep clone added to `findDocuments` service

**Problem:**
Drizzle ORM was reusing the same object reference for JSONB `data` fields across all documents in a query result, causing all documents to appear to have identical data.

**Evidence:**

```javascript
// Step 1: Create 3 users with different emails
POST /api/v0/documents:create
  { key: "user-1", data: { email: "dev@payloadcms.com" } }
  â†’ Response: âœ… { key: "user-1", data: { email: "dev@payloadcms.com" } }

POST /api/v0/documents:create
  { key: "user-2", data: { email: "user@payloadcms.com" } }
  â†’ Response: âœ… { key: "user-2", data: { email: "user@payloadcms.com" } }

POST /api/v0/documents:create
  { key: "user-3", data: { email: "dontrefresh@payloadcms.com" } }
  â†’ Response: âœ… { key: "user-3", data: { email: "dontrefresh@payloadcms.com" } }

// Step 2: Query ALL documents
POST /api/v0/documents:find
  { where: { and: [] } }
  â†’ Response: âŒ ALL 3 DOCUMENTS HAVE THE SAME EMAIL:
  [
    { key: "user-1", data: { email: "dontrefresh@payloadcms.com" } }, âŒ CORRUPTED
    { key: "user-2", data: { email: "dontrefresh@payloadcms.com" } }, âŒ CORRUPTED
    { key: "user-3", data: { email: "dontrefresh@payloadcms.com" } }  âœ… CORRECT
  ]
```

**Root Cause:**
Drizzle ORM was reusing the same object reference for JSONB `data` fields when returning multiple documents from a query. This caused all documents in the result array to share the same `data` object in memory, so they all appeared to have identical data (from the last document processed).

**Diagnosis Process:**

1. Initially suspected Content API `/api/v0/documents:create` was corrupting existing documents
2. Created isolated tests within Content API that **all passed** âœ…
3. Confirmed `create()` operations stored data correctly
4. Found that `findDocuments()` service returned correct data when called directly
5. Discovered Drizzle ORM was reusing object references for JSONB fields across query results

**The Fix:**

Added a deep clone of the `data` field in `findDocuments` service after Drizzle returns results:

```typescript
// src/services/documents/findDocuments.ts
if (databaseResult.isOk()) {
  const docs = databaseResult.value

  // Clone each document's data field to avoid shared references
  for (const doc of docs) {
    doc.data = JSON.parse(JSON.stringify(doc.data))
  }
}
```

**Impact:**

- âœ… All documents now have unique data
- âœ… Login works correctly
- âœ… WHERE queries filter correctly
- âœ… **BLOCKER RESOLVED** - Adapter development can continue

**To Apply Fix:**

Restart the Content API server on `localhost:8080`:

```bash
cd /Users/gjablonski/figma/figma/payload/content-api
# Stop the current server (Ctrl+C if running in terminal)
npm run dev
```

Then re-run Payload tests:

```bash
cd /Users/gjablonski/Documents/GitHub/payload
pnpm test:int hooks --testNamePattern="should call afterLogin hook"
```

---

### ğŸ”§ #1: Hooks Suite - Nested Relations (1 test failing, 96% passing)

**Suite:** `hooks` (24/25 tests passing after fix #0)
**Impact:** MEDIUM - One remaining failure
**Fixable in:** DB Adapter

#### Test 0.1: "should populate related docs within nested field structures"

**Error:**

```
Content API HTTP 500: {"message":"An unknown error occurred"}
```

**What it does:**

- Creates a relation document
- Creates a document with nested fields (group â†’ array â†’ relation, group â†’ subGroup â†’ relation)
- Tries to populate the relations via `findByID`

**Problem:** Content API returns HTTP 500 when querying with population in nested field structures.

**Likely cause:**

- Adapter bug in query conversion when handling `depth`/`populate` for nested fields
- DataLoader batch function might be sending malformed request to Content API

**TODO:**

- [ ] Check adapter's handling of populate/depth in nested structures
- [ ] Compare with how `db-mongodb` handles nested relation population
- [ ] Look at DataLoader batch function and the query it generates

---

#### Test 0.2: "should call afterLogin hook" âœ… FIXED

**Previous Error:**

```
AuthenticationError: The email or password provided is incorrect.
```

**Root Cause:** âœ… RESOLVED - Was caused by issue #0 (Drizzle ORM JSONB reference bug)

**Status:** âœ… FIXED - Should pass after restarting Content API server with fix #0

---

### ğŸ”§ #1: Hidden Field WHERE Clauses (2 tests failing)

**Impact:** HIGH - **Likely fixable in adapter**
**Fixable in:** DB Adapter
**Tests failing:**

- Querying > should respect query constraint using hidden field
- Querying > should respect query constraint using hidden field on count

**Problem:** WHERE clauses on fields with `admin.hidden: true` return 0 results.

**TODO:**

- [ ] Check if adapter is filtering out hidden fields from WHERE conversion
- [ ] Verify Content API receives hidden field queries correctly
- [ ] Compare with how `db-mongodb`/`db-postgres` handle hidden fields in WHERE
- [ ] Hidden fields should still be queryable, just not returned in responses

**Note:** The third test (versions) is a Content API limitation (see #3).

---

### ğŸš§ #2: Version Query Returns Empty (2 tests failing)

**Impact:** MEDIUM - **Content API limitation**
**Fixable in:** Content API
**Tests failing:**

- Querying > should respect query constraint using hidden field on versions
- Querying > should ignore false access in versions on query constraint added by top collection level access control

**Problem:** WHERE clauses on document versions return 0 results.

**Root Cause:** Content API doesn't support WHERE clauses on document versions yet (per Anthony's comment).

**Status:** ğŸš§ BLOCKED - Waiting for Content API version query support (Q1 2025)

---

### ğŸ”§ Priority Test Suites (Full Run Results)

**Full test suite completed:** 330/1512 tests passing (22%)

**Quick Win Targets (>50% passing, few tests failing):**

- âœ… **hooks** - 23/25 (92%) - 2 bugs identified above
- âœ… **graphql** - 3/4 (75%) - Investigate 1 failing test
- âœ… **plugin-form-builder** - 11/12 (92%) - Investigate 1 failing test
- âœ… **plugin-redirects** - 2/3 (67%) - Investigate 1 failing test
- âš ï¸ **loader** - 2/4 (50%) - Investigate 2 failing tests
- âš ï¸ **kv** - 1/3 (33%) - Investigate 2 failing tests
- âš ï¸ **auth** - 33/59 (56%) - Medium effort, high value

**Avoid (Content API Limitations):**

- âŒ **joins** - 0/59 (0%) - Join clause not supported
- âŒ **localization** - 0/98 (0%) - Locale clause not supported
- âŒ **select** - 15/111 (14%) - Select clause not supported
- âŒ **collections-graphql** - 0/47 (0%) - Likely needs Content API features

**Investigate Later (complex/time-consuming):**

- âŒ **fields** - 0/119 (0%, 4m 44s) - Could be critical blocker or feature gap
- âš ï¸ **database** - 43/144 (30%) - Many tests but complex
- âš ï¸ **versions** - 2/80 (3%) - Version queries not supported yet

---

## âœ… Completed

### Adapter Fixes

- âœ… **#1: update() with overrideAccess** - Fixed `limit: 0` handling (4 tests)
- âœ… **#3: Sort direction typo** - Changed `'dsc'` â†’ `'desc'` (1 test)
- âœ… WHERE clause support merged - went from 0/32 to 22/32 passing
- âœ… `returning: {}` fix - fixed 1 relationship test (23/32 now)
- âœ… Invalid UUID fix, findOne returning null, REST API update endpoint

### Test Infrastructure

- âœ… **Test Summary Script** - Created `test/runTestsWithSummary.ts`
  - Runs all integration tests suite-by-suite
  - Shows pass/fail counts and duration per suite
  - Color-coded status indicators (âœ… âš ï¸ âŒ)
  - Hardcoded suite list - easily exclude tests by commenting out
  - Command: `pnpm run test:int:summary`

---

## ğŸ”— References

**Potentially relevant PR:** https://github.com/figma/figma/pull/625457

- Files: https://github.com/figma/figma/pull/625457/files
- Status: Unknown if merged
- May contain fixes for some issues

---

## ğŸ“ Notes

### Test Configuration

- Tests run with `PAYLOAD_DROP_DATABASE=true` and `--runInBand` (sequential)
- Content system ID: `00000000-0000-4000-8000-000000000001`
- JWT authentication used (not API key)
- Database adapter: `db-content-api` (set in `test/jest.setup.js`)

### Test Summary Script Features

Located at `test/runTestsWithSummary.ts`, provides:

**Output:**

```
ğŸ§ª Running integration tests suite by suite...

[1/54] Running _community... âœ… 2/2 (3.2s)
[2/54] Running access-control... âš ï¸ 18/32 (4.5s)
[3/54] Running admin-root... âœ… 2/2 (3.3s)
...

ğŸ“Š TEST SUMMARY
âœ… _community      2/2    3.2s
âš ï¸ access-control  18/32  4.5s
âœ… admin-root      2/2    3.3s

ğŸ“ˆ Overall Results:
   Suites: 52/54 passed
   Tests:  450/500 passed
   Time:   15m 23s
```

**Status Indicators:**

- âœ… All tests passed (100%)
- âš ï¸ Partial pass (some tests failed)
- âŒ Complete failure (0% passed)

**Customization:**
Edit `TEST_SUITES` array to exclude specific suites by commenting them out.
