# Content API & DB Adapter - TODO Tracker

**Locations:**

- Content API: `/Users/gjablonski/figma/figma/payload/content-api/`
- DB Adapter: `/Users/gjablonski/figma/figma/payload/db-content-api/`
- Tests: `/Users/gjablonski/Documents/GitHub/payload/test/`

## Development Guidelines

### Priority Framework

1. **ğŸ”§ Adapter-fixable issues FIRST** - Logic errors, mapping bugs, edge cases
2. **ğŸš§ Content API limitations** - Document blockers, wait for upstream fixes
3. **ğŸ“‹ Nice-to-haves** - Optimizations, better error messages

### Workflow

1. Run `pnpm run test:int:summary` to see all test results
2. Pick a failing suite with high adapter-fix potential
3. Run specific suite: `pnpm test:int <suite-name>`
4. Debug by comparing with `db-mongodb` or `db-postgres` implementations
5. Fix in adapter (`db-content-api/src/index.ts`)
6. Test fix, update this document
7. Repeat

### When to Fix in Adapter vs Content API

**Fix in Adapter if:**

- Query conversion is wrong (WHERE, sort, pagination)
- Response mapping is incorrect (field names, types)
- Missing null/undefined handling
- UUID vs string type mismatches

**Fix in Content API if:**

- Missing fundamental feature (joins, select, locale)
- SQL query generation issue
- Database schema problem

## ğŸ§ª Testing

**Test Runner Script:** `pnpm run test:int:summary`

A custom script (`test/runTestsWithSummary.ts`) runs all integration tests suite-by-suite and displays:

- Pass/fail counts per suite
- Duration per suite
- Color-coded status (âœ… all pass, âš ï¸ partial pass, âŒ all fail)
- Overall summary

**To exclude suites:** Comment them out in the `TEST_SUITES` array in `runTestsWithSummary.ts`

**Excluded from testing:**

- `create-payload-app` - CLI tool, doesn't use db-adapter
- `joins` - Not supported yet in Content API
- `localization` - Not planned for EOY support
- `select` - Not planned for EOY support

## âš ï¸ Known Content API Limitations

**Source:** Anthony Salani (Dec 2024)

### Not Currently Supported

**Documents:**

- âŒ `join` clause - **Will be supported** (Q1 2025 or post-break)
- âŒ `returning` clause - Not planned for EOY
- âŒ `select` clause - Not planned for EOY
- âŒ `locale` clause - Not planned for EOY

**Document Versions:**

- âŒ No WHERE clauses supported yet

**Query Operators:**

- âŒ `near` - Not planned for EOY
- âŒ `within` - Not planned for EOY
- âŒ `intersects` - Not planned for EOY
- âŒ `all` - Not planned for EOY

### Impact on Test Suites

**Excluded from testing (in `TEST_SUITES`):**

- `joins` - Join clause not supported yet
- `localization` - Locale clause not planned for EOY
- `select` - Select clause not planned for EOY
- `create-payload-app` - CLI tool, doesn't use db-adapter

**Expected failures in active suites:**

- Version-related WHERE queries will fail (no version support)
- Operators: `near`, `within`, `intersects`, `all` will fail
- Any tests using `returning` or `select` clauses

**Don't debug these** - they're Content API limitations, not adapter bugs.

## ğŸ“š Adapter Implementation Details

### Document ID Mapping

Content API uses two ID fields:

- **`id`** (UUID, auto-generated by DB, private/internal use only)
- **`key`** (text, public document identifier, maps to Payload's `id`)

**In the adapter (`db-content-api/src/index.ts`):**

1. **ID Generation** (`create()` function):

   - If Payload provides `data.id`, use it as the `key`
   - Otherwise, generate a UUID using the `uuid` package (same as `db-postgres`, `db-drizzle`)
   - Content API's `id` is never touched by the adapter

2. **Query Mapping** (`convertPayloadWhereToContentAPI()`):

   - Payload's `id` field â†’ Content API's `key` field
   - Example: `{ id: { equals: "..." } }` â†’ `{ path: "key", operator: "equals", ... }`

3. **Response Mapping** (`unwrapDocument()`):
   - Content API's `key` â†’ Payload's `id`
   - Example: `doc.key` â†’ `id: doc.key`

**Future Rename:** Content API will rename these fields to `internal_id` and `external_id` (or similar) to clarify their purpose.

### Limit and Pagination Handling

**Consistent semantics across Payload, DB Adapters, and Content API:**

| Value       | Meaning          | SQL Result |
| ----------- | ---------------- | ---------- |
| `undefined` | Use default (10) | `LIMIT 10` |
| `0`         | Unlimited        | No LIMIT   |
| `> 0`       | Specific limit   | `LIMIT n`  |

**Implementation:**

- **Payload**: `limit ?? (usePagination ? 10 : 0)` â†’ default 10 with pagination, 0 without
- **DB Adapters**: `if (limit === 0) { limit = undefined }` â†’ omit LIMIT in SQL when 0
- **Content API**: `limit ?? 10` â†’ default 10, then `if (limit > 0) { query.limit(limit) }`
- **Adapter**: Passes `limit` directly (no transformation needed)

## ğŸ“Š Current Status

**Last Tested Suite:** `access-control`
**Result:** 18/32 PASS, 14/32 FAIL (56% passing)
**Recent Fixes:** Issues #1 (limit: 0) and #3 (sort typo) fixed - expecting improvement after rebuild

**Next Steps:**

1. Run full test suite: `pnpm run test:int:summary`
2. Identify adapter-fixable issues (ğŸ”§) vs Content API limitations (ğŸš§)
3. Focus on fixing adapter bugs first
4. Document Content API blockers for future work

**Commands:**

- Full summary: `pnpm run test:int:summary`
- Single suite: `pnpm test:int <suite-name>` (e.g., `pnpm test:int access-control`)

---

## ğŸ”´ Active Issues

**Priority:** Focus on adapter-fixable issues first (marked with ğŸ”§)

---

### ğŸ”§ #1: Hidden Field WHERE Clauses (2 tests failing)

**Impact:** HIGH - **Likely fixable in adapter**
**Fixable in:** DB Adapter
**Tests failing:**

- Querying > should respect query constraint using hidden field
- Querying > should respect query constraint using hidden field on count

**Problem:** WHERE clauses on fields with `admin.hidden: true` return 0 results.

**TODO:**

- [ ] Check if adapter is filtering out hidden fields from WHERE conversion
- [ ] Verify Content API receives hidden field queries correctly
- [ ] Compare with how `db-mongodb`/`db-postgres` handle hidden fields in WHERE
- [ ] Hidden fields should still be queryable, just not returned in responses

**Note:** The third test (versions) is a Content API limitation (see #3).

---

### ğŸš§ #2: Version Query Returns Empty (2 tests failing)

**Impact:** MEDIUM - **Content API limitation**
**Fixable in:** Content API
**Tests failing:**

- Querying > should respect query constraint using hidden field on versions
- Querying > should ignore false access in versions on query constraint added by top collection level access control

**Problem:** WHERE clauses on document versions return 0 results.

**Root Cause:** Content API doesn't support WHERE clauses on document versions yet (per Anthony's comment).

**Status:** ğŸš§ BLOCKED - Waiting for Content API version query support (Q1 2025)

---

### ğŸ”§ Potential Additional Issues (To Investigate)

**Priority:** Run full test suite with `pnpm run test:int:summary` to identify:

1. **Adapter bugs** - Logic errors in query conversion, response mapping, etc.
2. **Edge cases** - Null handling, empty arrays, special characters, etc.
3. **Type mismatches** - UUID vs string, number formatting, date handling

**Focus areas:**

- `fields` suite - Complex field types and nested structures
- `relationships` suite - Relation handling and depth queries
- `hooks` suite - Lifecycle hooks and data transformations
- `database` suite - Core CRUD operations and transactions

---

## âœ… Completed

### Adapter Fixes

- âœ… **#1: update() with overrideAccess** - Fixed `limit: 0` handling (4 tests)
- âœ… **#3: Sort direction typo** - Changed `'dsc'` â†’ `'desc'` (1 test)
- âœ… WHERE clause support merged - went from 0/32 to 22/32 passing
- âœ… `returning: {}` fix - fixed 1 relationship test (23/32 now)
- âœ… Invalid UUID fix, findOne returning null, REST API update endpoint

### Test Infrastructure

- âœ… **Test Summary Script** - Created `test/runTestsWithSummary.ts`
  - Runs all integration tests suite-by-suite
  - Shows pass/fail counts and duration per suite
  - Color-coded status indicators (âœ… âš ï¸ âŒ)
  - Hardcoded suite list - easily exclude tests by commenting out
  - Command: `pnpm run test:int:summary`

---

## ğŸ”— References

**Potentially relevant PR:** https://github.com/figma/figma/pull/625457

- Files: https://github.com/figma/figma/pull/625457/files
- Status: Unknown if merged
- May contain fixes for some issues

---

## ğŸ“ Notes

### Test Configuration

- Tests run with `PAYLOAD_DROP_DATABASE=true` and `--runInBand` (sequential)
- Content system ID: `00000000-0000-4000-8000-000000000001`
- JWT authentication used (not API key)
- Database adapter: `db-content-api` (set in `test/jest.setup.js`)

### Test Summary Script Features

Located at `test/runTestsWithSummary.ts`, provides:

**Output:**

```
ğŸ§ª Running integration tests suite by suite...

[1/54] Running _community... âœ… 2/2 (3.2s)
[2/54] Running access-control... âš ï¸ 18/32 (4.5s)
[3/54] Running admin-root... âœ… 2/2 (3.3s)
...

ğŸ“Š TEST SUMMARY
âœ… _community      2/2    3.2s
âš ï¸ access-control  18/32  4.5s
âœ… admin-root      2/2    3.3s

ğŸ“ˆ Overall Results:
   Suites: 52/54 passed
   Tests:  450/500 passed
   Time:   15m 23s
```

**Status Indicators:**

- âœ… All tests passed (100%)
- âš ï¸ Partial pass (some tests failed)
- âŒ Complete failure (0% passed)

**Customization:**
Edit `TEST_SUITES` array to exclude specific suites by commenting them out.
