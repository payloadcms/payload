# Content API & DB Adapter - TODO Tracker

**Locations:**

- Content API: `/Users/gjablonski/figma/figma/payload/content-api/`
- DB Adapter: `/Users/gjablonski/figma/figma/payload/db-content-api/`
- Tests: `/Users/gjablonski/Documents/GitHub/payload/test/`

## Development Guidelines

1. **Prefer adapter-side fixes**: If something can be fixed in the `db-content-api` adapter, do it there instead of modifying Content API
2. For inspiration, you can look at the other database adapters in the `payload` repository, such as `db-mongodb` or `db-postgres`.

## ðŸ“š Adapter Implementation Details

### Document ID Mapping

Content API uses two ID fields:

- **`id`** (UUID, auto-generated by DB, private/internal use only)
- **`key`** (text, public document identifier, maps to Payload's `id`)

**In the adapter (`db-content-api/src/index.ts`):**

1. **ID Generation** (`create()` function):

   - If Payload provides `data.id`, use it as the `key`
   - Otherwise, generate a UUID using the `uuid` package (same as `db-postgres`, `db-drizzle`)
   - Content API's `id` is never touched by the adapter

2. **Query Mapping** (`convertPayloadWhereToContentAPI()`):

   - Payload's `id` field â†’ Content API's `key` field
   - Example: `{ id: { equals: "..." } }` â†’ `{ path: "key", operator: "equals", ... }`

3. **Response Mapping** (`unwrapDocument()`):
   - Content API's `key` â†’ Payload's `id`
   - Example: `doc.key` â†’ `id: doc.key`

**Future Rename:** Content API will rename these fields to `internal_id` and `external_id` (or similar) to clarify their purpose.

### Limit and Pagination Handling

**Consistent semantics across Payload, DB Adapters, and Content API:**

| Value       | Meaning          | SQL Result |
| ----------- | ---------------- | ---------- |
| `undefined` | Use default (10) | `LIMIT 10` |
| `0`         | Unlimited        | No LIMIT   |
| `> 0`       | Specific limit   | `LIMIT n`  |

**Implementation:**

- **Payload**: `limit ?? (usePagination ? 10 : 0)` â†’ default 10 with pagination, 0 without
- **DB Adapters**: `if (limit === 0) { limit = undefined }` â†’ omit LIMIT in SQL when 0
- **Content API**: `limit ?? 10` â†’ default 10, then `if (limit > 0) { query.limit(limit) }`
- **Adapter**: Passes `limit` directly (no transformation needed)

## ðŸ“Š Current Status

**Test Suite:** `access-control`
**Result:** 27/32 PASS, 5/32 FAIL (84.4% passing)
**Latest:** Issue #1 (limit: 0) and Issue #3 (sort typo) fixed - expecting 28/32 after rebuild

**Command:** `pnpm test:int access-control`

---

## ðŸ”´ Active Issues

### #1: update() with overrideAccess Returns Empty (4 tests failing)

**Impact:** CRITICAL - blocks access control tests
**Tests failing:**

- Override Access > Fields > should allow overrideAccess: true - update many
- Override Access > Fields > should allow overrideAccess by default - update many
- Override Access > Collections > should allow overrideAccess: true - update many
- Override Access > Collections > should allow overrideAccess by default - update many

**Problem:** `payload.update({ overrideAccess: true, where: {...} })` returns empty `docs` array.

**Important Discovery:**

- âœ… Adapters (mongodb, postgres, sqlite) DON'T handle `overrideAccess` - verified
- âœ… Payload handles it BEFORE calling adapter (in `update.ts` lines 132-148)
- âœ… If `overrideAccess: true` â†’ Payload doesn't add access control restrictions to WHERE
- âœ… If `overrideAccess: false` â†’ Payload combines WHERE with access restrictions

**Root Cause Found:**

âœ… Payload's `update()` calls `find()` with `limit: 0` and `pagination: false` to get all matching docs
âœ… Adapter was passing `limit: 0` directly to Content API
âœ… Content API SQL query used `LIMIT 0`, returning 0 documents
âœ… **Fixed** by converting `limit: 0` â†’ `undefined` when `pagination: false`

**Status:** âœ… FIXED - Adapter now handles `limit: 0` correctly

---

### #2: Hidden Field WHERE Clauses (3 tests failing)

**Impact:** HIGH
**Tests failing:**

- Querying > should respect query constraint using hidden field
- Querying > should respect query constraint using hidden field on count
- Querying > should respect query constraint using hidden field on versions

**Problem:** WHERE clauses on fields with `admin.hidden: true` return 0 results.

**Note:** User mentioned: "we don't have support for where queries on doc versions yet" - this might explain the versions tests.

**TODO:**

- [ ] Verify if Content API filters out hidden fields from WHERE processing
- [ ] Check if hidden field values are stored/indexed correctly
- [ ] Investigate the first test (non-versions) separately

---

### #3: Sort Direction Typo (1 test failing)

**Impact:** MEDIUM
**Test failing:**

- Querying > should ignore false access on query constraint added by top collection level access control

**Error:**

```
ZodError: invalid_value
Expected: ["asc", "desc"]
```

**Root Cause Found:**

âœ… Adapter's `convertPayloadSortToContentAPI()` was using `'dsc'` instead of `'desc'`
âœ… Fixed in lines 339, 346, and 351 of `db-content-api/src/index.ts`

**Status:** âœ… FIXED - Changed `'asc' | 'dsc'` â†’ `'asc' | 'desc'`

---

### #4: Version Query Returns Empty (1 test failing)

**Impact:** MEDIUM
**Test failing:**

- Querying > should ignore false access in versions on query constraint added by top collection level access control

**Problem:** Similar to #2 but for version documents.

**Note:** Might be related to "no support for where queries on doc versions yet" mentioned by user.

---

## âœ… Completed

- âœ… WHERE clause support merged - went from 0/32 to 22/32 passing
- âœ… `returning: {}` fix - fixed 1 relationship test (23/32 now)
- âœ… Invalid UUID fix, findOne returning null, REST API update endpoint

---

## ðŸ”— References

**Potentially relevant PR:** https://github.com/figma/figma/pull/625457

- Files: https://github.com/figma/figma/pull/625457/files
- Status: Unknown if merged
- May contain fixes for some issues

---

## Notes

- Tests run with `PAYLOAD_DROP_DATABASE=true` and `--runInBand` (sequential)
- Content system ID: `00000000-0000-4000-8000-000000000001`
- JWT authentication used (not API key)
