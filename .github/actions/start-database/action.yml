name: Start Database
description: Starts the required database for tests

inputs:
  database:
    description: 'Database type: mongodb , mongodb-atlas , cosmosdb , documentdb , firestore , postgres , postgres-custom-schema , postgres-uuid , postgres-read-replica , vercel-postgres-read-replica , sqlite , sqlite-uuid , supabase , d1'
    required: true

outputs:
  POSTGRES_URL:
    description: PostgreSQL connection URL
    value: ${{ steps.postgres.outputs.url }}
  MONGODB_URL:
    description: MongoDB connection URL
    value: ${{ steps.mongodb.outputs.url }}
  MONGODB_ATLAS_URL:
    description: MongoDB Atlas connection URL
    value: ${{ steps.mongodb-atlas.outputs.url }}

runs:
  using: composite
  steps:
    # Cache invalidates when any db docker-compose file changes (e.g., image version bump)
    # Skip for supabase - too many images, exceeds disk space
    - name: Cache Docker images
      if: inputs.database != 'supabase'
      uses: ScribeMD/docker-cache@0.5.0
      with:
        key: docker-${{ runner.os }}-${{ inputs.database }}-${{ hashFiles('test/helpers/db/**/docker-compose.yml') }}

    - name: Start MongoDB
      id: mongodb
      if: contains(fromJSON('["mongodb", "cosmosdb", "documentdb", "firestore"]'), inputs.database)
      shell: bash
      run: |
        docker compose -f test/helpers/db/mongodb/docker-compose.yml up -d --wait
        echo "url=mongodb://payload:payload@localhost:27017/payload?authSource=admin&directConnection=true&replicaSet=rs0" >> $GITHUB_OUTPUT

    - name: Start MongoDB Atlas Local
      id: mongodb-atlas
      if: inputs.database == 'mongodb-atlas'
      shell: bash
      run: |
        docker compose -f test/helpers/db/mongodb-atlas/docker-compose.yml up -d --wait
        echo "url=mongodb://localhost:27018/payload?directConnection=true&replicaSet=rs-localdev" >> $GITHUB_OUTPUT

    - name: Start PostgreSQL
      id: postgres
      if: startsWith(inputs.database, 'postgres')
      shell: bash
      run: |
        docker compose -f test/helpers/db/postgres/docker-compose.yml up -d --wait
        echo "url=postgresql://payload:payload@localhost:5433/payload" >> $GITHUB_OUTPUT

    - name: Configure PostgreSQL custom schema
      if: inputs.database == 'postgres-custom-schema'
      shell: bash
      run: |
        docker exec postgres-payload-test psql -U payload -d payload -c "CREATE SCHEMA custom;"

    - name: Start Supabase
      id: supabase
      if: inputs.database == 'supabase'
      uses: supabase/setup-cli@v1
      with:
        version: latest

    - name: Initialize Supabase
      if: inputs.database == 'supabase'
      shell: bash
      run: |
        supabase init
        supabase start
